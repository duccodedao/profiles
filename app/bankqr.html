<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BmassHD - Cổng Thanh Toán & QR</title>
    
    <!-- Thư viện CSS & Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://duccodedao.github.io/Images/avt.png">
    
    <style>
        /* --- CẤU HÌNH GIAO DIỆN CHUNG --- */
        :root { --primary-color: #4e73df; --secondary-color: #858796; --success-color: #1cc88a; --danger-color: #e74a3b; --warning-color: #f6c23e; --bg-color: #f3f4f6; --card-bg: #ffffff; --text-color: #2d3748; --border-radius: 12px; --shadow: 0 10px 25px rgba(0,0,0,0.05); --transition: all 0.3s ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        
        .container { width: 100%; max-width: 1200px; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-wrap: wrap; margin-bottom: 30px; position: relative;}
        
        /* HEADER */
        .header { width: 100%; padding: 20px; background: linear-gradient(135deg, var(--primary-color), #224abe); color: white; text-align: center; position: relative; }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        
        /* NAVIGATION TABS (NEW) */
        .nav-tabs { width: 100%; display: flex; background: #f8f9fc; border-bottom: 1px solid #eee; }
        .nav-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; color: #888; transition: var(--transition); border-bottom: 3px solid transparent; }
        .nav-tab:hover { background: #eee; }
        .nav-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: #fff; }

        /* SECTIONS */
        .section-content { width: 100%; display: none; }
        .section-content.active { display: flex; flex-wrap: wrap; }

        /* LAYOUT 2 CỘT */
        .col-left, .col-right { padding: 30px; }
        .col-left { flex: 1; min-width: 350px; border-right: 1px solid #eee; }
        .col-right { flex: 1; min-width: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f8f9fc; }
        
        /* GRID DANH SÁCH NGÂN HÀNG */
        .bank-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px; max-height: 200px; overflow-y: auto; }
        .bank-item { 
            border: 2px solid transparent; border-radius: 10px; padding: 5px; cursor: pointer; transition: var(--transition); 
            background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; position: relative; height: 60px; 
            display: flex; align-items: center; justify-content: center;
        }
        .bank-item img { max-width: 100%; max-height: 100%; object-fit: contain; filter: grayscale(100%); transition: var(--transition); }
        .bank-item:hover { transform: translateY(-3px); }
        .bank-item.active { border-color: var(--primary-color); background: #f0f4ff; }
        .bank-item.active img { filter: grayscale(0%); }
        .bank-status { position: absolute; top: -5px; right: -5px; font-size: 0.6rem; padding: 1px 5px; border-radius: 8px; color: white; font-weight: bold; z-index: 5; }
        .status-on { background-color: var(--success-color); }
        .status-off { background-color: var(--danger-color); }
        .bank-item.disabled { opacity: 0.6; cursor: not-allowed; background-color: #eee; }

        /* FORM INPUTS */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #555; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; transition: var(--transition); outline: none; }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1); }
        .input-group { display: flex; gap: 10px; }
        .btn-copy { background: var(--secondary-color); color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; transition: var(--transition); }
        .suggestions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .tag { background: #eef2ff; color: var(--primary-color); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; transition: var(--transition); }
        
        /* QR FRAME */
        .qr-frame { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; min-height: 380px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; border: 1px solid #eee; width: 100%; flex-direction: column;}
        .qr-frame img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-action { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: var(--transition); width: 100%; margin-bottom: 10px; }
        .btn-action:hover { background: #2e59d9; transform: translateY(-2px); }
        
        /* HISTORY TABLE */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .history-table th { background: #f8f9fc; color: #555; }
        .history-table tr:hover { background: #f1f1f1; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: white; }
        .badge-info { background: #36b9cc; }
        
        /* BUYER VIEW & DEEPLINKS */
        #buyerView { display: none; width: 100%; flex-direction: column; align-items: center; padding: 40px 20px; background: white; }
        .deeplink-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; max-width: 400px; margin-top: 20px; }
        .btn-app { display: flex; align-items: center; justify-content: center; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: white; cursor: pointer; text-decoration: none; color: #333; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
        .btn-app:hover { border-color: var(--primary-color); background: #f0f4ff; color: var(--primary-color); }
        .btn-app img { width: 24px; height: 24px; margin-right: 8px; object-fit: contain; }

        /* ADMIN PANEL */
        .admin-login-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        #adminPanel { width: 100%; max-width: 1200px; background: #fff; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid var(--primary-color); display: none; }
        
        /* LOADING */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .col-left { border-right: none; border-bottom: 1px solid #eee; }
            .deeplink-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="initialLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 15px;">Đang tải dữ liệu...</p>
</div>

<!-- GIAO DIỆN CHÍNH (SELLER/ADMIN) -->
<div class="container" id="mainContainer">
    <div class="header">
        <h1><i class="fas fa-qrcode"></i> BmassHD Pay</h1>
        <p>Tạo mã QR & Link thanh toán tự động</p>
        <button id="btnLogin" class="admin-login-btn" onclick="handleLogin()"><i class="fas fa-user-shield"></i> Admin</button>
        <button id="btnLogout" class="admin-login-btn" onclick="handleLogout()" style="display: none;"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <!-- TABS -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('tab-create')">Tạo Mã Nhanh</div>
        <div class="nav-tab" onclick="switchTab('tab-order')">Tạo Đơn Hàng (Link)</div>
        <div class="nav-tab" onclick="switchTab('tab-history')">Lịch Sử Đơn</div>
    </div>

    <!-- TAB 1: TẠO MÃ NHANH (GIỮ NGUYÊN CODE CŨ) -->
    <div id="tab-create" class="section-content active">
        <div class="col-left">
            <div class="form-group">
                <label class="form-label">Ngân Hàng Thụ Hưởng</label>
                <div class="bank-grid" id="bankGrid"></div>
                <div style="font-size: 0.9rem; margin-top: 5px;">Đang chọn: <strong id="selectedBankName" style="color: var(--primary-color);">...</strong></div>
            </div>
            <div class="form-group">
                <div class="input-group">
                    <input type="text" id="accountNumber" class="form-control" readonly placeholder="Số tài khoản">
                </div>
                <input type="text" id="fullName" class="form-control" readonly style="margin-top: 5px; background: #f8f9fc;" placeholder="Tên chủ tài khoản">
            </div>
            <div class="form-group">
                <label class="form-label">Số tiền & Nội dung</label>
                <input type="text" id="amount" class="form-control" placeholder="Nhập số tiền" oninput="formatCurrency(this)">
                <div class="suggestions">
                    <span class="tag" onclick="setAmount(10000)">10k</span>
                    <span class="tag" onclick="setAmount(50000)">50k</span>
                    <span class="tag" onclick="setAmount(100000)">100k</span>
                    <span class="tag" onclick="setAmount(500000)">500k</span>
                </div>
                <textarea id="transferContent" class="form-control" style="margin-top: 10px;" rows="2" placeholder="Nội dung">Chuyen khoan</textarea>
            </div>
            <button class="btn-action" onclick="generateQuickQR()"><i class="fas fa-magic"></i> TẠO MÃ QR</button>
        </div>
        <div class="col-right">
            <div class="qr-frame" id="qrContainer">
                <img id="qrImage" src="" alt="QR Code" style="display: none;">
                <div id="placeholderText" style="color: #aaa;"><i class="fas fa-qrcode" style="font-size: 3rem;"></i><br>Nhập tiền để tạo</div>
            </div>
        </div>
    </div>

    <!-- TAB 2: TẠO ĐƠN HÀNG (MỚI) -->
    <div id="tab-order" class="section-content">
        <div class="col-left">
            <h3><i class="fas fa-file-invoice-dollar"></i> Tạo Link Thanh Toán</h3>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666;">Tạo một đường link duy nhất để gửi cho khách hàng. Khách hàng mở link sẽ thấy QR và nút chuyển app.</p>
            
            <div class="form-group">
                <label class="form-label">Số tiền cần thu</label>
                <input type="text" id="orderAmount" class="form-control" placeholder="VD: 150,000" oninput="formatCurrency(this)">
            </div>
            <div class="form-group">
                <label class="form-label">Nội dung đơn hàng</label>
                <textarea id="orderContent" class="form-control" rows="3" placeholder="VD: Thanh toan don hang #DH001"></textarea>
            </div>
            
            <button class="btn-action" style="background: var(--success-color);" onclick="createOrderLink()">
                <i class="fas fa-link"></i> TẠO LINK THANH TOÁN
            </button>
        </div>
        <div class="col-right" style="justify-content: flex-start;">
            <div id="orderResult" style="display:none; width: 100%; text-align: center;">
                <div style="background: #eef2ff; padding: 20px; border-radius: 10px; border: 1px dashed var(--primary-color);">
                    <i class="fas fa-check-circle" style="color: var(--success-color); font-size: 2rem; margin-bottom: 10px;"></i>
                    <h4>Đã tạo Link thành công!</h4>
                    <p style="font-size: 0.9rem; margin-bottom: 15px;">Gửi link này cho khách hàng:</p>
                    
                    <div class="input-group">
                        <input type="text" id="generatedLink" class="form-control" readonly value="">
                        <button class="btn-copy" onclick="copyToClipboard('generatedLink')"><i class="fas fa-copy"></i></button>
                    </div>
                    
                    <button class="btn-action" style="margin-top: 15px; width: auto; font-size: 0.9rem;" onclick="window.open(document.getElementById('generatedLink').value, '_blank')">
                        <i class="fas fa-external-link-alt"></i> Mở thử Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: LỊCH SỬ ĐƠN HÀNG (MỚI) -->
    <div id="tab-history" class="section-content">
        <div style="padding: 20px; width: 100%;">
            <h3>Lịch sử đơn hàng</h3>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead><tr><th>Ngày tạo</th><th>Nội dung</th><th>Số tiền</th><th>Link</th></tr></thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="4" text-align="center">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- GIAO DIỆN NGƯỜI THANH TOÁN (BUYER VIEW) -->
<div class="container" id="buyerView">
    <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="color: var(--primary-color);">Thanh Toán Đơn Hàng</h2>
        <p id="buyerDesc" style="font-weight: bold; font-size: 1.1rem; color: #555;">...</p>
        <p id="buyerAmount" style="color: var(--danger-color); font-size: 1.5rem; font-weight: 700;">...</p>
    </div>

    <div class="qr-frame" style="max-width: 350px;">
        <img id="buyerQR" src="" alt="QR Payment">
        <p style="margin-top: 10px; font-size: 0.8rem; color: #888;">Quét mã bằng ứng dụng ngân hàng</p>
    </div>

    <div style="width: 100%; max-width: 400px; text-align: center;">
        <label class="form-label">Hoặc chọn ứng dụng để mở (Deeplink)</label>
        <div class="deeplink-grid" id="appLinks">
            <!-- Nút bấm sẽ được render tại đây -->
        </div>
    </div>
</div>

<!-- ADMIN PANEL (Giữ nguyên logic cũ nhưng ẩn đi khi ở chế độ Buyer) -->
<div id="adminPanel">
    <h2><i class="fas fa-cogs"></i> Quản Trị Ngân Hàng</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <select id="admBankSelect" class="form-control" style="grid-column: span 2;"></select>
        <input type="text" id="admAccNum" class="form-control" placeholder="Số tài khoản">
        <input type="text" id="admFullName" class="form-control" placeholder="Chủ tài khoản">
        <select id="admStatus" class="form-control" style="grid-column: span 2;">
            <option value="active">Active</option>
            <option value="maintenance">Bảo trì</option>
        </select>
    </div>
    <button class="btn-action" onclick="saveBankToFirebase()">Lưu Ngân Hàng</button>
</div>

<!-- JS LIBS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
    /* --- 1. FIREBASE CONFIG --- */
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();
    const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

    let USER_BANKS = [];
    let API_BANKS_LIST = [];
    let currentBank = null;

    /* --- 2. KHỞI TẠO --- */
    document.addEventListener('DOMContentLoaded', async () => {
        // Kiểm tra URL xem có phải đang xem đơn hàng không?
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order');

        if (orderId) {
            // MODE: NGƯỜI MUA (BUYER)
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('buyerView').style.display = 'flex';
            loadOrderData(orderId);
        } else {
            // MODE: NGƯỜI BÁN (SELLER)
            await fetchVietQRBanks();
            listenFirebaseBanks();
            listenOrderHistory();
        }
    });

    /* --- 3. LOGIC ORDER & BUYER VIEW --- */
    
    // TẠO ĐƠN HÀNG MỚI
    async function createOrderLink() {
        if (!currentBank) return Swal.fire("Lỗi", "Vui lòng chọn ngân hàng trước ở tab Tạo Mã", "error");
        
        const rawAmt = document.getElementById('orderAmount').value.replace(/,/g, '');
        const amount = parseInt(rawAmt);
        const content = document.getElementById('orderContent').value;

        if (!amount || amount < 1000) return Swal.fire("Lỗi", "Số tiền tối thiểu 1,000đ", "warning");
        if (!content) return Swal.fire("Lỗi", "Vui lòng nhập nội dung", "warning");

        const btn = document.querySelector('#tab-order .btn-action');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';

        try {
            // Lưu vào Firebase
            const docRef = await db.collection("orders").add({
                amount: amount,
                content: content,
                bankInfo: {
                    bin: currentBank.bin,
                    acc: currentBank.acc,
                    name: currentBank.shortName,
                    fullName: currentBank.fullName
                },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            });

            // Tạo Link
            const link = `${window.location.origin}${window.location.pathname}?order=${docRef.id}`;
            document.getElementById('generatedLink').value = link;
            document.getElementById('orderResult').style.display = 'block';
            
            btn.innerHTML = '<i class="fas fa-link"></i> TẠO LINK THANH TOÁN';
            Swal.fire("Thành công", "Đã tạo link thanh toán!", "success");

        } catch (e) {
            console.error(e);
            Swal.fire("Lỗi", "Không thể tạo đơn hàng: " + e.message, "error");
            btn.innerHTML = '<i class="fas fa-link"></i> TẠO LINK THANH TOÁN';
        }
    }

    // LOAD DỮ LIỆU ĐƠN HÀNG (CHO NGƯỜI MUA)
    async function loadOrderData(orderId) {
        try {
            const doc = await db.collection("orders").doc(orderId).get();
            if (!doc.exists) {
                document.getElementById('initialLoading').innerHTML = '<p style="color:red">Đơn hàng không tồn tại!</p>';
                return;
            }

            const data = doc.data();
            document.getElementById('buyerDesc').innerText = data.content;
            document.getElementById('buyerAmount').innerText = data.amount.toLocaleString('en-US') + " VNĐ";

            // Gọi API VietQR để lấy QR String (Cho Deeplink)
            const apiPayload = {
                accountNo: data.bankInfo.acc,
                accountName: data.bankInfo.fullName,
                acqId: data.bankInfo.bin,
                amount: data.amount,
                addInfo: data.content,
                format: "text",
                template: "compact2"
            };

            const response = await fetch('https://api.vietqr.io/v2/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(apiPayload)
            });
            
            const resData = await response.json();
            
            if (resData.code === "00") {
                // Hiển thị ảnh QR
                document.getElementById('buyerQR').src = resData.data.qrDataURL; // Base64 Image
                
                // Tạo Deeplink Buttons từ qrCode String
                generateDeeplinks(resData.data.qrCode, data.bankInfo);
                
                document.getElementById('initialLoading').style.display = 'none';
            } else {
                alert("Lỗi tạo QR từ VietQR");
            }

        } catch (e) {
            console.error(e);
            alert("Lỗi tải đơn hàng");
        }
    }

    // TẠO NÚT DEEPLINK (Cố gắng mở App)
    function generateDeeplinks(qrString, bankInfo) {
        const container = document.getElementById('appLinks');
        const encodedQR = encodeURIComponent(qrString);

        // Danh sách các App phổ biến và Scheme
        // Lưu ý: Android Intent và iOS Scheme khác nhau. Đây là danh sách nỗ lực tốt nhất cho Web.
        const apps = [
            { name: "MB Bank", logo: "https://img.vietqr.io/image/MB-logo.png", scheme: `mbmobile://` }, // MB thường auto detect qua QR Image
            { name: "Vietcombank", logo: "https://img.vietqr.io/image/VCB-logo.png", scheme: `vcbdigibank://` },
            { name: "Techcombank", logo: "https://img.vietqr.io/image/TCB-logo.png", scheme: `tcb://` },
            { name: "ACB", logo: "https://img.vietqr.io/image/ACB-logo.png", scheme: `acbapp://` },
            { name: "VPBank", logo: "https://img.vietqr.io/image/VPB-logo.png", scheme: `vpbankneo://` },
            { name: "TPBank", logo: "https://img.vietqr.io/image/TPB-logo.png", scheme: `tpbankmobile://` },
            { name: "MoMo", logo: "https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png", scheme: `momo://` },
            { name: "ZaloPay", logo: "https://cdn.haitrieu.com/wp-content/uploads/2022/10/Logo-ZaloPay-Square.png", scheme: `zalopay://` }
        ];

        // Vì Web không thể gọi trực tiếp "Chuyển tiền + Điền số" chính xác cho mọi app nếu không có Universal Link chuẩn.
        // Giải pháp tốt nhất: Một số ngân hàng hỗ trợ link intent, số khác chỉ mở App.
        // Nút này sẽ mở App. Người dùng dùng tính năng "Quét QR" trong App để quét ảnh trên (nếu dùng 2 thiết bị) hoặc "Tải ảnh lên" (nếu 1 thiết bị).
        
        apps.forEach(app => {
            const a = document.createElement('a');
            a.className = 'btn-app';
            // Logic Deeplink đơn giản: Mở App
            a.href = app.scheme; 
            a.innerHTML = `<img src="${app.logo}" alt="${app.name}"> Mở ${app.name}`;
            container.appendChild(a);
        });

        // Nút sao chép nội dung QR (để paste vào app nếu cần)
        const copyBtn = document.createElement('div');
        copyBtn.className = 'btn-app';
        copyBtn.style.border = '1px dashed var(--primary-color)';
        copyBtn.innerHTML = '<i class="fas fa-copy" style="margin-right:8px"></i> Sao chép mã chuỗi QR';
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(qrString);
            Swal.fire({toast:true, icon:'success', title:'Đã sao chép raw string', position:'top'});
        };
        container.appendChild(copyBtn);
    }

    // TẢI LỊCH SỬ ĐƠN
    function listenOrderHistory() {
        db.collection("orders").orderBy("createdAt", "desc").limit(20).onSnapshot(snapshot => {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            if(snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Chưa có đơn hàng nào</td></tr>';
                return;
            }
            
            snapshot.forEach(doc => {
                const d = doc.data();
                const date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A';
                const link = `${window.location.origin}${window.location.pathname}?order=${doc.id}`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${d.content.substring(0, 20)}...</td>
                        <td style="font-weight:bold">${d.amount.toLocaleString()}đ</td>
                        <td><button class="btn-copy" onclick="copyText('${link}')"><i class="fas fa-copy"></i> Copy Link</button></td>
                    </tr>
                `;
            });
        });
    }

    /* --- 4. CÁC HÀM TIỆN ÍCH CŨ (GIỮ NGUYÊN HOẶC CHỈNH SỬA NHỎ) --- */
    
    // Auth & Banks Fetching
    async function fetchVietQRBanks() {
        try {
            const res = await fetch('https://api.vietqr.io/v2/banks');
            const data = await res.json();
            if(data.code === "00") {
                API_BANKS_LIST = data.data;
                populateAdminDropdown();
            }
        } catch(e) { console.error(e); }
    }

    function populateAdminDropdown() {
        const select = document.getElementById('admBankSelect');
        select.innerHTML = '<option value="">-- Chọn Ngân hàng --</option>';
        API_BANKS_LIST.sort((a,b) => a.shortName.localeCompare(b.shortName));
        API_BANKS_LIST.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.id; opt.text = `${b.shortName} - ${b.name}`;
            select.appendChild(opt);
        });
    }

    function listenFirebaseBanks() {
        db.collection("banks").orderBy("createdAt", "desc").onSnapshot(snapshot => {
            USER_BANKS = [];
            snapshot.forEach(doc => USER_BANKS.push({id: doc.id, ...doc.data()}));
            document.getElementById('initialLoading').style.display = 'none';
            renderBankGrid();
            
            // Auto select active bank
            if(!currentBank && USER_BANKS.length > 0) {
                const active = USER_BANKS.find(b => b.status === 'active');
                if(active) selectBank(active.id);
            }
        });
    }

    function renderBankGrid() {
        const grid = document.getElementById('bankGrid');
        grid.innerHTML = '';
        USER_BANKS.sort((a,b) => (a.status==='active' && b.status!=='active') ? -1 : 1).forEach(bank => {
            const div = document.createElement('div');
            div.className = `bank-item ${currentBank?.id === bank.id ? 'active' : ''} ${bank.status==='maintenance'?'disabled':''}`;
            if(bank.status !== 'maintenance') div.onclick = () => selectBank(bank.id);
            div.innerHTML = `
                <div class="bank-status ${bank.status==='active'?'status-on':'status-off'}">${bank.status==='active'?'ON':'OFF'}</div>
                <img src="${bank.logo}">
            `;
            grid.appendChild(div);
        });
    }

    function selectBank(id) {
        currentBank = USER_BANKS.find(b => b.id === id);
        renderBankGrid();
        if(currentBank) {
            document.getElementById('selectedBankName').innerText = currentBank.shortName;
            document.getElementById('accountNumber').value = currentBank.acc;
            document.getElementById('fullName').value = currentBank.fullName;
            if(document.getElementById('amount').value) generateQuickQR();
        }
    }

    function generateQuickQR() {
        if(!currentBank) return;
        const amt = parseInt(document.getElementById('amount').value.replace(/,/g,''));
        const content = document.getElementById('transferContent').value;
        if(!amt) return;
        
        const qrImg = document.getElementById('qrImage');
        // Sử dụng Quick Link API
        qrImg.src = `https://img.vietqr.io/image/${currentBank.code}-${currentBank.acc}-compact2.jpg?amount=${amt}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(currentBank.fullName)}`;
        qrImg.style.display = 'block';
        document.getElementById('placeholderText').style.display = 'none';
    }

    // Admin Logic
    auth.onAuthStateChanged(user => {
        if(user && user.uid === ADMIN_UID) {
            document.getElementById('btnLogin').style.display = 'none';
            document.getElementById('btnLogout').style.display = 'inline-block';
            document.getElementById('adminPanel').style.display = 'block';
        } else {
            document.getElementById('btnLogin').style.display = 'inline-block';
            document.getElementById('btnLogout').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
        }
    });

    function handleLogin() { auth.signInWithPopup(provider); }
    function handleLogout() { auth.signOut(); }

    function saveBankToFirebase() {
        const bid = document.getElementById('admBankSelect').value;
        const acc = document.getElementById('admAccNum').value;
        const name = document.getElementById('admFullName').value;
        const status = document.getElementById('admStatus').value;
        
        const apiBank = API_BANKS_LIST.find(b => b.id == bid);
        if(!apiBank || !acc) return;

        db.collection("banks").add({
            code: apiBank.code, bin: apiBank.bin, shortName: apiBank.shortName, name: apiBank.name, logo: apiBank.logo,
            acc: acc, fullName: name.toUpperCase(), status: status, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => Swal.fire("Success", "Đã thêm ngân hàng", "success"));
    }

    // UI Utilities
    function switchTab(tabId) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    function formatCurrency(el) {
        let val = el.value.replace(/\D/g, '');
        el.value = val ? parseInt(val).toLocaleString('en-US') : '';
    }
    
    function setAmount(v) { 
        document.getElementById('amount').value = v.toLocaleString('en-US'); 
        generateQuickQR(); 
    }
    
    function copyToClipboard(id) {
        const el = document.getElementById(id);
        el.select();
        navigator.clipboard.writeText(el.value);
        Swal.fire({toast:true, icon:'success', title:'Đã copy', position:'top-end', timer:1500, showConfirmButton:false});
    }

    function copyText(txt) {
        navigator.clipboard.writeText(txt);
        Swal.fire({toast:true, icon:'success', title:'Đã copy link', position:'top-end', timer:1500, showConfirmButton:false});
    }

</script>
</body>
</html>
