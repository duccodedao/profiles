

<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu app - Vĩnh Trạch Đông</title>
    <link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">
    
    <!-- SEO & PWA Meta Tags -->
    <meta name="description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">
    <link rel="apple-touch-icon" href="https://bmass.vercel.app/img/bmasslogo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hub Vĩnh Trạch Đông">
    <link rel="manifest" href="/js/applinkicon.jsonn">
    <meta name="theme-color" content="#4f46e5">

    <!-- Social Media Meta -->
    <meta property="og:title" content="Hub Portal - Vĩnh Trạch Đông">
    <meta property="og:description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <meta property="og:image" content="https://bmass.vercel.app/img/bmasslogo.png">
    <meta property="og:type" content="website">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Excel Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4f46e5', secondary: '#f43f5e', dark: '#020617' } } }
        }
    </script>
    <style>
        /* ADDED: Styles for Sidebar */
        .admin-sidebar { 
            width: 0; 
            transition: width 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .admin-sidebar.open {
            width: 28rem; /* Equivalent to max-w-xl in Tailwind, adjust as needed */
            min-width: 320px; /* Ensures a minimum size on small screens */
        }
        @media (max-width: 768px) {
            .admin-sidebar.open { width: 100%; }
        }
        /* END ADDED */
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; padding-bottom: 100px; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .app-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drag-ghost { opacity: 0.3; background: #4f46e5 !important; border-radius: 1rem; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .dark .tab-active { color: #818cf8; border-bottom: 2px solid #818cf8; }
        .is-favorite .star-icon { fill: #facc15; }
        .app-item.selected-for-delete { box-shadow: 0 0 0 3px #f43f5e; border-radius: 1rem; }
        /* Thêm padding top khi có thông báo để không che header */
        #announcement-bar:not(.hidden) ~ header { top: 32px; }
        /* Custom Marquee */
        .marquee { overflow: hidden; white-space: nowrap; box-sizing: border-box; }
        .marquee > div { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- NEW: Announcement Bar -->
    <div id="announcement-bar" class="fixed top-0 left-0 w-full z-[101] bg-secondary text-white text-xs font-bold py-2 shadow-md hidden">
        <div class="marquee">
            <div id="announcement-text"></div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="sticky top-0 z-[100] glass px-6 py-3 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg">
                <i data-lucide="database" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xs font-black tracking-tighter uppercase leading-none">Hub Portal</h1>
                <span id="role-status" class="text-[9px] font-bold text-slate-400">GUEST</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Nút Mở Sidebar Admin (NEW) -->
            <button onclick="window.toggleAdminSidebar()" id="admin-sidebar-toggle" class="p-2 rounded-xl text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition hidden"><i data-lucide="settings-2" class="w-5 h-5"></i></button>

            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                <button onclick="window.setView('grid')" id="view-grid-btn" class="p-1.5 rounded-md transition-all shadow-sm bg-white dark:bg-slate-700"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                <button onclick="window.setView('list')" id="view-list-btn" class="p-1.5 rounded-md transition-all"><i data-lucide="list" class="w-4 h-4"></i></button>
            </div>
            <button onclick="window.toggleTheme()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden text-slate-600"></i>
            </button>
            <div id="auth-section"></div>
        </div>
    </header>

    <!-- Main Content and Admin Sidebar Wrapper -->
    <div class="flex max-w-7xl mx-auto">
        <!-- Main Content -->
        <main class="flex-1 p-6 space-y-8 min-w-0">
            <!-- Search -->
            <div class="relative max-w-2xl mx-auto">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="search-input" placeholder="Tìm ứng dụng hoặc danh bạ..." 
                    class="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-2xl focus:ring-4 ring-primary/10 outline-none shadow-sm">
            </div>

            <!-- Visit Stats Container -->
            <div id="visit-stats-container" class="max-w-4xl mx-auto p-4 rounded-3xl bg-slate-100 dark:bg-slate-900/50">
                <div class="flex items-center justify-center h-20 text-slate-400">Đang tải thống kê...</div>
            </div>

            <!-- Nút Mua App (NEW) -->
            <div id="buy-app-section" class="max-w-4xl mx-auto p-4 flex justify-center">
                <button onclick="window.openRequestModal()" class="flex items-center gap-2 px-8 py-4 bg-secondary text-white rounded-2xl font-bold text-sm uppercase shadow-xl hover:bg-secondary/90 transition">
                    <i data-lucide="rocket" class="w-5 h-5"></i> MUA BẢN SAO APP CỦA TÔI (100K VNĐ)
                </button>
            </div>

            <!-- Admin Request Form (NEW) -->
            <div id="request-admin-section" class="max-w-4xl mx-auto hidden p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-3xl border border-yellow-200 dark:border-yellow-700 space-y-4">
                <h3 class="text-xl font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="key" class="w-6 h-6"></i> Xin Cấp Quyền Quản Trị</h3>
                <p id="request-admin-status" class="text-sm font-medium text-yellow-700 dark:text-yellow-300">
                    Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu để Admin chính duyệt.
                </p>
                <form id="request-admin-form" class="flex gap-4">
                    <input type="text" id="request-admin-reason" placeholder="Lý do xin cấp quyền..." required class="flex-1 px-5 py-3 bg-white dark:bg-slate-800 rounded-xl outline-none focus:ring-2 ring-yellow-500 text-sm">
                    <button type="submit" class="bg-yellow-500 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-yellow-600 transition">GỬI YÊU CẦU</button>
                </form>
            </div>
            
            <!-- Categories -->
            <div id="category-bar" class="flex flex-wrap gap-2"></div>
            
            <!-- App Loading State -->
            <div id="app-loading" class="text-center p-16 text-slate-400 text-sm font-medium hidden">
                <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                Đang tải ứng dụng...
            </div>

            <!-- Main Content App -->
            <div id="app-container"></div>
            
            <!-- Bulk Delete Floating Dock -->
            <div id="bulk-delete-dock" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 z-[110]">
                <div class="bg-red-600 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-4">
                    <span id="selected-count">0</span> mục đã chọn
                    <button onclick="window.executeBulkDelete()" class="flex items-center gap-2 px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold shadow-lg uppercase">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> XÓA
                    </button>
                </div>
            </div>
        </main>

        <!-- Admin Sidebar (NEW) -->
        <div id="admin-sidebar" class="admin-sidebar fixed right-0 top-0 bottom-0 bg-white dark:bg-slate-900 border-l dark:border-white/10 shadow-2xl z-[150] flex flex-col pt-16">
            <!-- Sidebar Header / Controls -->
            <div id="sidebar-controls" class="p-6 border-b dark:border-white/5 flex flex-col gap-3">
                 <div class="flex items-center justify-between">
                    <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">QUẢN TRỊ VIÊN</h3>
                    <button onclick="window.toggleAdminSidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
                 <div class="flex items-center gap-3">
                    <button onclick="window.openAppModal()" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary text-white rounded-xl text-xs font-bold shadow-lg">
                        <i data-lucide="plus" class="w-4 h-4"></i> THÊM ỨNG DỤNG
                    </button>
                    <button onclick="window.toggleBulkDelete()" id="bulk-delete-sidebar-toggle" class="p-3 rounded-xl text-red-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition flex items-center justify-center"><i data-lucide="scissors" class="w-5 h-5"></i></button>
                 </div>
            </div>

            <!-- Sidebar Tabs -->
            <div class="p-6 border-b dark:border-white/5">
                <div class="flex flex-wrap gap-2 text-[10px] font-black tracking-widest text-slate-400">
                    <button onclick="window.switchTab('tab-cat')" id="btn-tab-cat" class="text-primary border-b-2 border-primary pb-1">DANH MỤC</button>
                    <button onclick="window.switchTab('tab-announcement')" id="btn-tab-announcement" class="pb-1 uppercase">THÔNG BÁO</button>
                    <button onclick="window.switchTab('tab-deputy')" id="btn-tab-deputy" class="pb-1 uppercase">PHÓ ADMIN</button>
                    <button onclick="window.switchTab('tab-request')" id="btn-tab-request" class="pb-1 uppercase flex items-center gap-1">YÊU CẦU ADM <span id="request-count" class="text-red-500">(0)</span></button>
                    <button onclick="window.switchTab('tab-subdomain-request')" id="btn-tab-subdomain-request" class="pb-1 uppercase flex items-center gap-1">YÊU CẦU APP <span id="subdomain-request-count" class="text-red-500">(0)</span></button>
                    <button onclick="window.switchTab('tab-data')" id="btn-tab-data" class="pb-1 uppercase">DỮ LIỆU</button>
                </div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <!-- Tab Categories -->
                <div id="tab-cat" class="space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Quản lý Danh mục</h4>
                    <div class="flex flex-col gap-2">
                        <input type="text" id="new-cat-name" placeholder="Tên danh mục..." class="px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                        <div class="flex gap-2">
                             <input type="text" id="new-cat-icon" placeholder="Link Icon..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                             <button onclick="window.addCategory()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">Thêm</button>
                        </div>
                    </div>
                    <ul id="cat-list-admin" class="space-y-2"></ul>
                </div>
                
                <!-- Tab Announcement -->
                <div id="tab-announcement" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Thông báo Chạy chữ (Marquee)</h4>
                    <textarea id="announcement-content" placeholder="Nội dung thông báo (ngắn gọn, lặp lại)" rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                    
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5">
                        <label class="text-sm font-bold opacity-60">Kích hoạt Thông báo Chạy chữ</label>
                        <button id="toggle-announcement-btn" onclick="window.toggleAnnouncementStatus()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all">Tắt / Bật</button>
                    </div>
                    
                    <button onclick="window.saveAnnouncementContent()" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs">LƯU NỘI DUNG</button>
                </div>
                <!-- End Tab Announcement -->

                <!-- Tab Deputy -->
                <div id="tab-deputy" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Cấp/Thu hồi quyền Phó Admin</h4>
                    <div id="deputy-guard" class="hidden p-4 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-xl text-xs font-bold uppercase">Chỉ Super Admin mới quản lý được mục này.</div>
                    <div id="deputy-ui" class="space-y-4">
                        <div class="flex gap-2">
                            <input type="email" id="new-deputy-email" placeholder="Gmail phó admin..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                            <button onclick="window.addDeputy()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">CẤP QUYỀN</button>
                        </div>
                        <div id="deputy-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tab Admin Requests (NEW) -->
                <div id="tab-request" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Yêu Cầu Cấp Quyền</h4>
                    <div id="requests-list" class="space-y-2">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Không có yêu cầu mới.</div>
                    </div>
                </div>
                <!-- End Tab Admin Requests -->

                <!-- Tab Subdomain Requests (NEW) -->
                <div id="tab-subdomain-request" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Yêu Cầu Mua Ứng Dụng</h4>
                    <div id="subdomain-requests-list" class="space-y-2">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Không có yêu cầu mua app mới.</div>
                    </div>
                </div>
                <!-- End Tab Subdomain Requests -->


                <!-- Tab Data Export/Import -->
                <div id="tab-data" class="hidden space-y-8">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Xuất/Nhập Dữ Liệu</h4>
                    <div class="grid gap-6">
                        <!-- Export -->
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-primary">Xuất dữ liệu</h4>
                            <div class="flex flex-col gap-2">
                                <button onclick="window.handleExport('json')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm">
                                    <span class="text-sm font-bold">Xuất file JSON</span>
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.handleExport('excel')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm">
                                    <span class="text-sm font-bold">Xuất file EXCEL</span>
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Import -->
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-secondary">Nhập dữ liệu</h4>
                            <div class="relative">
                                <input type="file" id="import-file" accept=".json, .xlsx" onchange="window.handleImport(event)" class="hidden">
                                <label for="import-file" class="flex items-center justify-center gap-3 w-full px-5 py-4 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-xl cursor-pointer hover:opacity-90 transition font-bold text-xs uppercase">
                                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                                    Chọn file để khôi phục
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="fixed bottom-0 w-full z-50 bg-white dark:bg-slate-900 border-t dark:border-white/10 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="max-w-7xl mx-auto px-6 py-3 flex justify-between items-center text-sm">
            <div class="text-slate-500 dark:text-slate-400">
                © 2024 Vĩnh Trạch Đông. All rights reserved.
            </div>
            <div class="flex items-center gap-4">
                <a href="#" class="text-xs font-bold text-slate-500 hover:text-primary transition">Privacy Policy</a>
                <a href="chat.html" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-secondary text-white rounded-lg font-bold text-xs uppercase shadow-lg hover:opacity-90 transition">
                    <i data-lucide="life-buoy" class="w-4 h-4"></i> TRỢ GIÚP
                </a>
            </div>
        </div>
    </footer>


    <!-- App Modal (No Changes) -->
    <div id="modal-app" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="app-modal-title" class="font-bold uppercase text-sm tracking-widest">Cấu hình</h3>
                <button onclick="window.closeModal('modal-app')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="app-form" class="p-8 space-y-4">
                <input type="hidden" id="edit-id">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh mục</label>
                    <select id="app-category" onchange="window.toggleFormFields()" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select>
                </div>
                <div class="space-y-1">
                    <label id="label-name" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tên hiển thị</label>
                    <input type="text" id="app-name" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div id="field-position" class="space-y-1 hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Chức vụ</label>
                    <input type="text" id="app-position" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label id="label-link" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Link URL</label>
                    <input type="text" id="app-link" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Icon URL</label>
                    <input type="text" id="app-icon" placeholder="Để trống để tự lấy" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="flex items-center gap-3 p-2">
                    <input type="checkbox" id="app-visible" checked class="w-5 h-5 accent-primary">
                    <label class="text-xs font-bold opacity-60">Hiển thị công khai</label>
                </div>
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 uppercase text-xs">Lưu ứng dụng</button>
            </form>
        </div>
    </div>

    <!-- Subdomain Request Modal (NEW) -->
    <div id="modal-subdomain-request" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">YÊU CẦU MUA APP</h3>
                <button onclick="window.closeModal('modal-subdomain-request')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="subdomain-request-form" class="p-8 space-y-6">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Subdomain mong muốn (ví dụ: <span class="text-secondary font-mono">my-site</span>.vtd.vercel.app)</label>
                    <div class="flex items-center">
                        <input type="text" id="subdomain-input" placeholder="ten-app-cua-toi" required pattern="[a-z0-9-]+" title="Chỉ chữ thường, số, và dấu gạch ngang" 
                            class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-l-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                        <span class="px-5 py-3 bg-slate-200 dark:bg-slate-700 rounded-r-xl text-slate-500 dark:text-slate-400 text-sm font-mono tracking-tight">.vtd.vercel.app</span>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-1">Lưu ý: Subdomain này sẽ là đường dẫn ứng dụng riêng của bạn. Không thể thay đổi sau khi duyệt.</p>
                </div>

                <div id="payment-step" class="space-y-4 p-4 border border-yellow-200 dark:border-yellow-700 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl hidden">
                    <h4 class="text-md font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="scan" class="w-5 h-5"></i> THANH TOÁN (100.000 VNĐ)</h4>
                    <div class="flex flex-col items-center">
                        <img id="vietqr-image" src="" alt="Mã QR Vietcombank" class="w-64 h-64 object-contain rounded-lg border p-1 bg-white">
                        <p class="text-xs font-bold text-center mt-2 text-slate-600 dark:text-slate-300">NỘI DUNG CHUYỂN KHOẢN: <span id="payment-content" class="text-secondary"></span></p>
                    </div>
                    <div class="text-xs text-center font-medium space-y-1">
                        <p>NGÂN HÀNG: Vietcombank (VCB) | SỐ TÀI KHOẢN: 0891000650891</p>
                        <p class="text-red-500 font-bold">Vui lòng chuyển khoản đúng NỘI DUNG để được xác nhận nhanh nhất!</p>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="button" id="next-to-payment-btn" onclick="window.nextToPayment()" class="flex-1 py-4 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs">TIẾP TỤC & XEM QR</button>
                    <button type="submit" id="submit-request-btn" class="flex-1 py-4 bg-green-500 text-white rounded-xl font-bold shadow-lg uppercase text-xs hidden">ĐÃ CHUYỂN KHOẢN & GỬI YÊU CẦU</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Admin Nhập Config Firebase (NEW - Chỉ Admin Mẹ dùng) -->
    <div id="modal-approve-config" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-secondary">NHẬP CẤU HÌNH FIREBASE</h3>
                <button onclick="window.closeModal('modal-approve-config')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="approve-config-form" class="p-8 space-y-4">
                <input type="hidden" id="target-subdomain-uid">
                <h4 id="config-subdomain-name" class="text-xl font-black text-primary"></h4>
                <p class="text-sm text-red-500 font-medium">Lưu ý: Super Admin phải tự tạo Firebase Project mới cho app này và paste config JSON dưới đây. Sau khi duyệt, ứng dụng sẽ hoạt động trên Subdomain.</p>
                <textarea id="firebase-config-json" placeholder="Paste Firebase Config JSON ở đây..." rows="8" required 
                    class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-mono"></textarea>
                <button type="submit" class="w-full py-4 bg-secondary text-white rounded-xl font-bold shadow-lg uppercase text-xs">LƯU CONFIG & DUYỆT CUỐI CÙNG</button>
            </form>
        </div>
    </div>

    <!-- Notification Toast (No Changes) -->
    <div id="toast" class="fixed bottom-10 right-10 z-[300] transform translate-y-20 opacity-0 transition-all duration-500">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border dark:border-white/10">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg" class="text-sm font-bold tracking-tight">Thành công!</span>
        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch, increment, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- HẰNG SỐ CẤU HÌNH ---
        const VIETCOMBANK_ACCOUNT = "0891000650891";
        const VIETCOMBANK_TEMPLATE = "VCB"; 
        const PAYMENT_AMOUNT = "100000"; // 100,000 VND
        const MOTHER_DOMAIN = "vtd.vercel.app"; // Cần thay thế bằng domain thật của bạn (ví dụ: hub.vn)

        // Firebase Config CỦA SITE MẸ (Bắt buộc)
        const MOTHER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const SUPER_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1"; // UID của bạn (Super Admin)

        let currentSubdomain = ''; 
        let isMotherSite = true; 
        let childFirebaseConfig = null; 

        // BIẾN FIREBASE CHUNG
        let auth, db, provider; // Firebase Mẹ
        let childAuth, childDb; // Firebase Con (nếu là site con)
        let currentDb, currentAuth; // Biến tiện ích

        let currentUser = null, isAdmin = false, isSuper = false, apps = [], categories = [], deputies = [], currentFilter = 'all', searchQuery = '', viewMode = 'grid', visitStats = {};
        let userFavorites = []; 
        let appsLoaded = false; 
        let bulkDeleteMode = false; 
        let selectedAppsForDelete = new Set(); 
        let currentAnnouncement = {}; 
        let adminRequests = []; 
        let subdomainRequests = []; 

        // --- CORE INITIALIZATION ---
        const hostnameParts = window.location.hostname.split('.');
        if (hostnameParts.length > 2 && hostnameParts[0] !== 'www' && hostnameParts.slice(1).join('.') === MOTHER_DOMAIN) {
            currentSubdomain = hostnameParts[0];
            isMotherSite = false;
        }
        
        if (!isMotherSite) {
            document.getElementById('buy-app-section').classList.add('hidden');
        }

        async function initializeAppWithConfig(config, appName = "default") {
            try {
                const app = initializeApp(config, appName);
                const a = getAuth(app);
                const d = getFirestore(app);
                const p = new GoogleAuthProvider();

                if (isMotherSite) {
                    auth = a; db = d; provider = p;
                    currentDb = db; currentAuth = auth;
                } else {
                    childAuth = a; childDb = d;
                    currentDb = childDb; currentAuth = childAuth;
                }
                
                onAuthStateChanged(currentAuth, handleAuthStateChange);

            } catch (error) {
                 console.error("Firebase initialization failed:", error);
                 if (!isMotherSite) {
                     document.getElementById('app-loading').classList.add('hidden');
                     document.getElementById('app-container').innerHTML = `<div class="p-16 text-center text-red-500 font-bold">LỖI: Ứng dụng con (${currentSubdomain}) chưa được kích hoạt hoặc cấu hình Firebase không hợp lệ. Vui lòng liên hệ Admin.</div>`;
                 }
            }
        }
        
        async function fetchChildConfigAndInitialize() {
            try {
                // Kết nối tạm thời với Mother DB để lấy config
                const motherApp = initializeApp(MOTHER_FIREBASE_CONFIG, "motherApp");
                const motherDb = getFirestore(motherApp);
                
                const configDoc = await getDoc(doc(motherDb, "tenants_config", currentSubdomain));
                
                if (configDoc.exists()) {
                    childFirebaseConfig = configDoc.data().config;
                    await initializeAppWithConfig(childFirebaseConfig, "childApp");
                } else {
                    throw new Error("Config not found");
                }
            } catch (e) {
                console.error("Error fetching child config:", e);
                document.getElementById('app-loading').classList.add('hidden');
                document.getElementById('app-container').innerHTML = `<div class="p-16 text-center text-red-500 font-bold">LỖI: Ứng dụng con (${currentSubdomain}) chưa được kích hoạt hoặc cấu hình Firebase không hợp lệ. Vui lòng liên hệ Admin.</div>`;
            }
        }

        if (isMotherSite) {
            initializeAppWithConfig(MOTHER_FIREBASE_CONFIG);
        } else {
            fetchChildConfigAndInitialize();
        }
        
        // --- AUTH & INITIAL ---
        async function handleAuthStateChange(user) {
            if (!currentDb) return;

            currentUser = user;
            const requestSection = document.getElementById('request-admin-section');
            const requestStatus = document.getElementById('request-admin-status');
            const requestForm = document.getElementById('request-admin-form');
            
            if (user) {
                isSuper = user.uid === SUPER_UID && isMotherSite;
                
                const adminSnap = await getDoc(doc(currentDb, "settings", "admins"));
                deputies = adminSnap.exists() ? adminSnap.data().deputy_emails || [] : [];
                
                isAdmin = isSuper || deputies.includes(user.email);
                
                const userDoc = await getDoc(doc(currentDb, "users", user.uid));
                userFavorites = userDoc.exists() ? userDoc.data().favorites || [] : [];
                
                renderAuthUI();
                
                onSnapshot(doc(currentDb, "users", user.uid), (snap) => {
                    userFavorites = snap.data()?.favorites || [];
                    if (currentFilter === 'favorites') renderApps();
                });
                
                requestSection.classList.toggle('hidden', isAdmin || !isMotherSite);

                if (!isAdmin && isMotherSite) {
                    const reqSnap = await getDoc(doc(db, "adminRequests", user.uid));
                    if (reqSnap.exists()) {
                         requestStatus.innerText = "Yêu cầu của bạn đang chờ Admin chính duyệt.";
                         requestForm.classList.add('hidden');
                    } else {
                         requestStatus.innerText = "Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu để Admin chính duyệt.";
                         requestForm.classList.remove('hidden');
                    }
                }

            } else {
                isAdmin = isSuper = false;
                userFavorites = [];
                document.getElementById('auth-section').innerHTML = `<button onclick="window.login()" class="bg-primary text-white px-5 py-2 rounded-lg text-xs font-bold uppercase tracking-widest">Login</button>`;
                if (currentFilter === 'favorites') window.setFilter('all'); 
                requestSection.classList.add('hidden'); 
            }
            document.getElementById('role-status').innerText = isSuper ? 'SUPER' : (isAdmin ? 'DEPUTY' : 'GUEST');
            document.getElementById('admin-sidebar-toggle').classList.toggle('hidden', !isAdmin); 
            
            setupDataListeners();
            renderApps();
            if (isMotherSite) trackVisit();
        }
        
        window.openRequestModal = () => {
             if (!currentUser) { showToast("Vui lòng đăng nhập để gửi yêu cầu mua app!", true); return; }
             // Reset UI
             document.getElementById('subdomain-input').readOnly = false;
             document.getElementById('subdomain-input').value = '';
             document.getElementById('next-to-payment-btn').classList.remove('hidden');
             document.getElementById('submit-request-btn').classList.add('hidden');
             document.getElementById('payment-step').classList.add('hidden');
             window.openModal('modal-subdomain-request');
        };

        window.login = () => signInWithPopup(currentAuth, provider);
        window.logout = () => signOut(currentAuth).then(() => location.reload());

        function renderAuthUI() {
            document.getElementById('auth-section').innerHTML = `<div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 pr-3 rounded-lg border dark:border-white/10"><img src="${currentUser.photoURL}" class="w-7 h-7 rounded-md"><button onclick="window.logout()" class="text-[9px] font-black uppercase text-red-500">Exit</button></div>`;
        }
        
        window.toggleAdminSidebar = () => {
             document.getElementById('admin-sidebar').classList.toggle('open');
        };

        // --- DATA REALTIME (Sử dụng currentDb) ---
        function setupDataListeners() {
            if (!currentDb) return;
            
            onSnapshot(query(collection(currentDb, "categories"), orderBy("order", "asc")), (snap) => {
                categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderCategories();
            });

            onSnapshot(query(collection(currentDb, "apps"), orderBy("order", "asc")), (snap) => {
                apps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                appsLoaded = true; 
                renderApps();
            });
            
            if (isMotherSite) {
                onSnapshot(doc(currentDb, "settings", "visits_stats"), (snap) => {
                    visitStats = snap.data() || {};
                    renderStats();
                });
                if (isAdmin) {
                     onSnapshot(collection(currentDb, "adminRequests"), (snap) => {
                        adminRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderAdminRequests();
                    });
                     onSnapshot(collection(currentDb, "subdomainRequests"), (snap) => {
                        subdomainRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderSubdomainRequests();
                    });
                }
            }

            onSnapshot(doc(currentDb, "settings", "announcement"), (snap) => {
                currentAnnouncement = snap.data() || { content: '', active: false };
                renderAnnouncementBar();
                renderAnnouncementControls();
            });
        }
        
        // --- ANNOUNCEMENT LOGIC (Sử dụng currentDb) ---
        function renderAnnouncementBar() {
            const bar = document.getElementById('announcement-bar');
            const textDiv = document.getElementById('announcement-text');
            
            if (currentAnnouncement.active && currentAnnouncement.content && currentAnnouncement.content.trim() !== '') {
                textDiv.innerText = currentAnnouncement.content.trim().toUpperCase() + " • "; 
                bar.classList.remove('hidden');
                const contentLen = currentAnnouncement.content.length;
                const speed = Math.max(10, Math.min(30, contentLen * 0.2)); 
                bar.querySelector('.marquee > div').style.animationDuration = `${speed}s`;

            } else {
                bar.classList.add('hidden');
            }
        }
        
        function renderAnnouncementControls() {
            if (!isAdmin) return;
            const btn = document.getElementById('toggle-announcement-btn');
            
            if (currentAnnouncement.active) {
                btn.innerText = 'TẮT THÔNG BÁO';
                btn.classList.remove('bg-slate-500');
                btn.classList.add('bg-red-500');
            } else {
                btn.innerText = 'BẬT THÔNG BÁO';
                btn.classList.remove('bg-red-500');
                btn.classList.add('bg-slate-500');
            }
        }
        
        window.saveAnnouncementContent = async () => {
            if (!isAdmin || !currentDb) return;
            const content = document.getElementById('announcement-content').value.trim();
            if (content.length < 5) { showToast("Nội dung thông báo phải dài hơn 5 ký tự!"); return; }
            try {
                await setDoc(doc(currentDb, "settings", "announcement"), { content: content }, { merge: true });
                showToast("Đã lưu nội dung thông báo!");
            } catch (e) { showToast("Lỗi khi lưu nội dung thông báo!", true); }
        };
        
        window.toggleAnnouncementStatus = async () => {
            if (!isAdmin || !currentDb) return;
            const newState = !currentAnnouncement.active;
            if (newState && (!currentAnnouncement.content || currentAnnouncement.content.trim() === '')) { showToast("Vui lòng nhập nội dung trước khi bật!"); return; }
            try {
                await setDoc(doc(currentDb, "settings", "announcement"), { active: newState }, { merge: true });
                showToast(newState ? "Đã BẬT thông báo!" : "Đã TẮT thông báo!");
            } catch (e) { showToast("Lỗi khi thay đổi trạng thái thông báo!", true); }
        };

        // --- ADMIN REQUEST LOGIC (Sử dụng db/currentDb) ---
        function renderAdminRequests() {
            if (!isSuper || !isMotherSite) return; 
            const list = document.getElementById('requests-list');
            document.getElementById('request-count').innerText = `(${adminRequests.length})`;
            
            if (adminRequests.length === 0) {
                 list.innerHTML = `<div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Không có yêu cầu mới.</div>`;
                 return;
            }

            list.innerHTML = adminRequests.map(req => `
                <div class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5 space-y-2">
                    <p class="text-sm font-bold">${req.name} <span class="text-xs text-slate-500">(${req.email})</span></p>
                    <p class="text-xs italic text-slate-600 dark:text-slate-400">Lý do: ${req.reason}</p>
                    <div class="flex gap-2 pt-2 border-t dark:border-white/5 mt-2">
                        <button onclick="window.approveAdminRequest('${req.uid}', '${req.email}')" class="flex-1 bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase">DUYỆT</button>
                        <button onclick="window.rejectAdminRequest('${req.uid}')" class="flex-1 bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase">TỪ CHỐI</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.approveAdminRequest = async (uid, email) => {
            if (!isSuper || !isMotherSite || !confirm(`Duyệt yêu cầu của ${email} và cấp quyền Phó Admin?`)) return;
            
            try {
                await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
                await deleteDoc(doc(db, "adminRequests", uid));
                
                showToast(`Đã duyệt yêu cầu và cấp quyền cho ${email}! Đang tải lại...`);
                setTimeout(() => location.reload(), 500);
            } catch (e) {
                 console.error("Error approving request:", e);
                 showToast("Lỗi khi duyệt yêu cầu!", true);
            }
        };

        window.rejectAdminRequest = async (uid) => {
            if (!isSuper || !isMotherSite || !confirm("Bạn có chắc chắn muốn từ chối yêu cầu này?")) return;
            
            try {
                await deleteDoc(doc(db, "adminRequests", uid));
                showToast("Đã từ chối yêu cầu!");
            } catch (e) {
                 console.error("Error rejecting request:", e);
                 showToast("Lỗi khi từ chối yêu cầu!", true);
            }
        };

        // NEW: Handle Admin Request Submission (Chỉ Site Mẹ)
        document.getElementById('request-admin-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser || !isMotherSite) return;
            const reason = document.getElementById('request-admin-reason').value.trim();
            if (reason.length < 5) { showToast("Lý do phải dài hơn 5 ký tự!"); return; }
            
            try {
                await setDoc(doc(db, "adminRequests", currentUser.uid), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: currentUser.displayName,
                    reason: reason,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('request-admin-status').innerText = "Yêu cầu của bạn đang chờ Admin chính duyệt.";
                document.getElementById('request-admin-form').classList.add('hidden');
                showToast("Đã gửi yêu cầu thành công!");
            } catch (e) {
                console.error("Error submitting request:", e);
                showToast("Lỗi khi gửi yêu cầu!", true);
            }
        };

        // --- SUBDOMAIN REQUEST LOGIC (CHỈ SITE MẸ) ---
        function generateVietQRLink(paymentContent) {
            const baseURL = "https://api.vietqr.io/v2/generate";
            const data = {
                accountNo: VIETCOMBANK_ACCOUNT,
                acqId: VIETCOMBANK_TEMPLATE,
                amount: PAYMENT_AMOUNT,
                addInfo: paymentContent.toUpperCase().replace(/\s/g, '-'),
                template: "compact2" 
            };
            const params = new URLSearchParams(data).toString();
            return `${baseURL}?${params}`;
        }
        
        window.nextToPayment = () => {
             const subdomainInput = document.getElementById('subdomain-input');
             const subdomain = subdomainInput.value.trim().toLowerCase();
             
             if (!/^[a-z0-9-]+$/.test(subdomain) || subdomain.length < 3) {
                 showToast("Subdomain không hợp lệ! (chỉ chữ thường, số, gạch ngang, tối thiểu 3 ký tự)", true);
                 return;
             }
             
             // TODO: Kiểm tra Subdomain đã tồn tại (nếu cần)

             const paymentContent = `MUAAPP-${subdomain.toUpperCase()}`;
             
             document.getElementById('payment-content').innerText = paymentContent;
             document.getElementById('vietqr-image').src = generateVietQRLink(paymentContent);
             
             document.getElementById('next-to-payment-btn').classList.add('hidden');
             document.getElementById('submit-request-btn').classList.remove('hidden');
             document.getElementById('payment-step').classList.remove('hidden');
             subdomainInput.readOnly = true; 
        };

        document.getElementById('subdomain-request-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser || !isMotherSite) return;
            
            const subdomain = document.getElementById('subdomain-input').value.trim().toLowerCase();
            const paymentContent = `MUAAPP-${subdomain.toUpperCase()}`;

            try {
                await setDoc(doc(db, "subdomainRequests", currentUser.uid), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: currentUser.displayName,
                    subdomain: subdomain,
                    paymentContent: paymentContent,
                    amount: PAYMENT_AMOUNT,
                    status: 'PENDING_PAYMENT_CONFIRM', 
                    timestamp: new Date().toISOString()
                });
                
                showToast("Yêu cầu đã được gửi! Admin sẽ xác nhận thanh toán thủ công.");
                window.closeModal('modal-subdomain-request');
            } catch (error) {
                console.error("Error submitting subdomain request:", error);
                showToast("Lỗi khi gửi yêu cầu mua app!", true);
            }
        };

        function renderSubdomainRequests() {
            if (!isMotherSite || !isAdmin) return; 
            const list = document.getElementById('subdomain-requests-list');
            document.getElementById('subdomain-request-count').innerText = `(${subdomainRequests.length})`;
            
            if (subdomainRequests.length === 0) {
                 list.innerHTML = `<div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Không có yêu cầu mua app mới.</div>`;
                 return;
            }

            list.innerHTML = subdomainRequests.map(req => `
                <div class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5 space-y-2">
                    <p class="text-sm font-bold">${req.name} <span class="text-xs text-slate-500">(${req.email})</span></p>
                    <p class="text-xs italic text-slate-600 dark:text-slate-400">Subdomain: <span class="text-primary font-bold">${req.subdomain}</span></p>
                    <p class="text-xs italic text-slate-600 dark:text-slate-400">Nội dung CK: <span class="text-secondary font-bold">${req.paymentContent}</span></p>
                    <div class="flex gap-2 pt-2 border-t dark:border-white/5 mt-2">
                        <button onclick="window.openApproveConfigModal('${req.uid}', '${req.subdomain}', '${req.email}')" class="flex-1 bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase">XÁC NHẬN & NHẬP CONFIG</button>
                        <button onclick="window.rejectSubdomainRequest('${req.uid}')" class="flex-1 bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase">TỪ CHỐI</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.openApproveConfigModal = (uid, subdomain, email) => {
            if (!isSuper) { showToast("Chỉ Super Admin mới có quyền này!", true); return; }
            document.getElementById('target-subdomain-uid').value = uid;
            document.getElementById('config-subdomain-name').innerText = `Cấu hình cho: ${subdomain}`;
            document.getElementById('firebase-config-json').value = ''; 
            window.openModal('modal-approve-config');
        };

        document.getElementById('approve-config-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!isSuper || !isMotherSite) return;
            
            const uid = document.getElementById('target-subdomain-uid').value;
            const configJson = document.getElementById('firebase-config-json').value.trim();
            const req = subdomainRequests.find(r => r.uid === uid);
            if (!req) { showToast("Yêu cầu không tìm thấy!", true); return; }

            try {
                const config = JSON.parse(configJson);
                
                await setDoc(doc(db, "tenants_config", req.subdomain), {
                    subdomain: req.subdomain,
                    uid: uid,
                    email: req.email,
                    config: config,
                    timestamp: new Date().toISOString()
                });
                
                await deleteDoc(doc(db, "subdomainRequests", uid));
                
                showToast(`Đã cấp app con cho ${req.subdomain}! Yêu cầu Admin: Cấu hình DNS trỏ ${req.subdomain}.${MOTHER_DOMAIN} về site này.`);
                window.closeModal('modal-approve-config');
                location.reload(); 

            } catch (e) {
                 console.error("Error saving tenant config:", e);
                 showToast("Lỗi: JSON Config không hợp lệ hoặc lỗi DB!", true);
            }
        };

        window.rejectSubdomainRequest = async (uid) => {
            if (!isAdmin || !isMotherSite || !confirm("Bạn có chắc chắn muốn từ chối yêu cầu mua app này?")) return;
            
            try {
                await deleteDoc(doc(db, "subdomainRequests", uid));
                showToast("Đã từ chối yêu cầu mua app!");
            } catch (e) {
                 console.error("Error rejecting subdomain request:", e);
                 showToast("Lỗi khi từ chối yêu cầu!", true);
            }
        };


        // --- FAVORITES LOGIC (Sử dụng currentDb) ---
        window.toggleFavorite = (appId, event) => {
            event.stopPropagation();
            if (!currentUser || !currentDb) { showToast("Vui lòng đăng nhập để lưu mục yêu thích!"); return; }

            const isFavorite = userFavorites.includes(appId);
            const userDocRef = doc(currentDb, "users", currentUser.uid);
            
            updateDoc(userDocRef, {
                favorites: isFavorite ? arrayRemove(appId) : arrayUnion(appId)
            }).then(() => {
                showToast(isFavorite ? "Đã gỡ khỏi mục yêu thích" : "Đã thêm vào mục yêu thích!");
            }).catch(error => {
                console.error("Error toggling favorite: ", error);
                showToast("Lỗi khi cập nhật mục yêu thích!", true);
            });
        };

        // --- BULK DELETE LOGIC (Sử dụng currentDb) ---
        window.toggleBulkDelete = () => { /* ... (Không đổi) ... */ };
        window.toggleAppSelection = (appId, event) => { /* ... (Không đổi) ... */ };
        function updateBulkDeleteCount() { /* ... (Không đổi) ... */ };
        window.executeBulkDelete = async () => {
            if (!isAdmin || selectedAppsForDelete.size === 0 || !currentDb) return;
            
            if (!confirm(`Bạn có chắc chắn muốn xóa ${selectedAppsForDelete.size} mục đã chọn? Hành động này không thể hoàn tác.`)) return;

            const batch = writeBatch(currentDb);
            selectedAppsForDelete.forEach(appId => {
                batch.delete(doc(currentDb, "apps", appId));
            });

            try {
                await batch.commit();
                showToast(`Đã xóa thành công ${selectedAppsForDelete.size} mục!`);
                window.toggleBulkDelete(); 
            } catch (error) {
                console.error("Error batch deleting apps: ", error);
                showToast("Lỗi: Không thể xóa hàng loạt.", true);
            }
        };

        // --- VISIT STATS LOGIC (Chỉ Site Mẹ) ---
        function getDateString(date = new Date()) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return { day: `${y}-${m}-${d}`, month: `${y}-${m}`, year: `${y}` };
        }
        async function trackVisit() {
            if (!isMotherSite || !db) return; // Chỉ track trên Site Mẹ
            const now = getDateString();
            
            try {
                await runTransaction(db, async (transaction) => {
                    const statsDocRef = doc(db, "settings", "visits_stats");
                    const statsSnap = await transaction.get(statsDocRef);
                    const statsData = statsSnap.data() || {};

                    let updates = {
                        totalVisits: increment(1)
                    };
                    
                    if (statsData.lastDailyUpdate !== now.day) {
                        updates.dailyVisits = 1;
                        updates.lastDailyUpdate = now.day;
                    } else {
                        updates.dailyVisits = (statsData.dailyVisits || 0) + 1;
                    }

                    if (statsData.lastMonthlyUpdate !== now.month) {
                        updates.monthlyVisits = 1;
                        updates.lastMonthlyUpdate = now.month;
                    } else {
                        updates.monthlyVisits = (statsData.monthlyVisits || 0) + 1;
                    }

                    if (statsData.lastYearlyUpdate !== now.year) {
                        updates.yearlyVisits = 1;
                        updates.lastYearlyUpdate = now.year;
                    } else {
                        updates.yearlyVisits = (statsData.yearlyVisits || 0) + 1;
                    }

                    transaction.set(statsDocRef, updates, { merge: true });
                });

            } catch (e) {
                console.error("Transaction failed while tracking visit: ", e);
            }
        }
        function renderStats() {
            const container = document.getElementById('visit-stats-container');
            if (!container) return; 
            
            const { dailyVisits = 0, monthlyVisits = 0, yearlyVisits = 0, totalVisits = 0 } = visitStats;
            
            container.innerHTML = `
                <div class="flex items-center gap-3 text-xs font-black tracking-widest text-primary dark:text-white mb-4">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span>THỐNG KÊ LƯỢT TRUY CẬP</span>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Hôm nay</p>
                        <span class="text-lg font-black text-primary">${dailyVisits.toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Tháng này</p>
                        <span class="text-lg font-black text-primary">${monthlyVisits.toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Năm nay</p>
                        <span class="text-lg font-black text-primary">${yearlyVisits.toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Tổng cộng</p>
                        <span class="text-lg font-black text-primary">${totalVisits.toLocaleString('vi-VN')}</span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- RENDERING APP (Không đổi) ---
        window.renderApps = () => { /* ... (Không đổi, đã dùng apps, categories global) ... */ };

        // --- IMPORT / EXPORT LOGIC (Sử dụng currentDb) ---
        window.handleExport = (type) => { /* ... (Không đổi) ... */ };
        window.handleImport = async (event) => {
            if (!currentDb) return;
            // ... (Logic cũ) ...
            try {
                // ... (Logic phân tích file) ...
                
                // Cần đảm bảo các addDoc dùng currentDb
                for (const cat of importedData.categories) {
                    const existing = categories.find(c => c.name === cat.name);
                    if (existing) {
                        categoryIdMap[cat.name] = existing.id;
                    } else {
                        const docRef = await addDoc(collection(currentDb, "categories"), cat);
                        categoryIdMap[cat.name] = docRef.id;
                    }
                }

                for (const appData of importedData.apps) {
                    const { categoryName, ...rest } = appData;
                    const finalAppData = { ...rest, categoryId: categoryIdMap[categoryName] || '' };
                    await addDoc(collection(currentDb, "apps"), finalAppData);
                }
                // ... (Logic cuối) ...
            } catch (error) { /* ... */ }
        };

        // --- ADMIN UTILS (Sử dụng currentDb) ---
        window.updateCatField = (id, field, val) => updateDoc(doc(currentDb, "categories", id), { [field]: val })
            .then(() => showToast("Đã cập nhật danh mục!"))
            .catch(e => showToast("Lỗi khi cập nhật danh mục!", true));
            
        window.deleteCat = (id) => {
            if (confirm("Xóa danh mục này?")) {
                deleteDoc(doc(currentDb, "categories", id))
                    .then(() => showToast("Đã xóa danh mục!"))
                    .catch(e => showToast("Lỗi khi xóa danh mục!", true));
            }
        };
        
        window.addCategory = async () => {
            const name = document.getElementById('new-cat-name').value.trim();
            const icon = document.getElementById('new-cat-icon').value.trim();
            if(!name) { showToast("Tên danh mục không được trống!"); return; }
            await addDoc(collection(currentDb, "categories"), { name, icon, order: categories.length })
                .then(() => {
                    document.getElementById('new-cat-name').value = '';
                    document.getElementById('new-cat-icon').value = '';
                    showToast("Đã thêm danh mục mới!");
                })
                .catch(e => showToast("Lỗi khi thêm danh mục.", true));
        };

        window.renderDeputyList = () => {
            const list = document.getElementById('deputy-list');
            list.innerHTML = deputies.map(email => `<div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5"><span class="text-sm font-bold">${email}</span>${isSuper ? `<button onclick="window.removeDeputy('${email}')" class="text-red-500 p-2"><i data-lucide="user-minus" class="w-4 h-4"></i></button>` : ''}</div>`).join('');
            
            document.getElementById('deputy-guard').classList.toggle('hidden', isSuper);
            document.getElementById('deputy-ui').classList.toggle('hidden', !isSuper);
            
            lucide.createIcons();
        };

        window.addDeputy = async () => {
            const email = document.getElementById('new-deputy-email').value.trim().toLowerCase();
            if(!email || !isSuper) return;
            if (!email.includes('@')) { showToast("Vui lòng nhập email hợp lệ!"); return; }
            try {
                await setDoc(doc(currentDb, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
                document.getElementById('new-deputy-email').value = '';
                showToast(`Đã cấp quyền cho ${email}. Đang tải lại...`);
                setTimeout(() => location.reload(), 500);
            } catch (e) { showToast("Lỗi khi cấp quyền Phó Admin.", true); }
        };

        window.removeDeputy = async (email) => {
            if(!confirm(`Xóa quyền Phó Admin cho ${email}?`) || !isSuper) return;
            try {
                await setDoc(doc(currentDb, "settings", "admins"), { deputy_emails: arrayRemove(email) }, { merge: true });
                showToast(`Đã xóa quyền của ${email}. Đang tải lại...`);
                setTimeout(() => location.reload(), 500);
            } catch (e) { showToast("Lỗi khi xóa quyền Phó Admin.", true); }
        };

        window.toggleFormFields = () => { /* ... (Không đổi) ... */ };
        window.openAppModal = () => { document.getElementById('app-form').reset(); document.getElementById('edit-id').value = ''; window.toggleFormFields(); window.openModal('modal-app'); };
        window.editApp = (id) => {
            const a = apps.find(x => x.id === id);
            document.getElementById('edit-id').value = a.id;
            document.getElementById('app-name').value = a.name;
            document.getElementById('app-position').value = a.position || '';
            document.getElementById('app-link').value = a.url;
            document.getElementById('app-icon').value = a.iconUrl || '';
            document.getElementById('app-category').value = a.categoryId || '';
            document.getElementById('app-visible').checked = a.visible;
            window.toggleFormFields();
            window.openModal('modal-app');
        };

        document.getElementById('app-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = { name: document.getElementById('app-name').value, position: document.getElementById('app-position').value, url: document.getElementById('app-link').value, iconUrl: document.getElementById('app-icon').value, categoryId: document.getElementById('app-category').value, visible: document.getElementById('app-visible').checked, order: id ? apps.find(x => x.id === id).order : apps.length };
            
            try {
                id ? await updateDoc(doc(currentDb, "apps", id), data) : await addDoc(collection(currentDb, "apps"), data);
                window.closeModal('modal-app');
                showToast(id ? "Đã cập nhật ứng dụng!" : "Đã thêm ứng dụng mới!");
            } catch (e) {
                console.error("Error saving app:", e);
                showToast("Lỗi khi lưu ứng dụng!", true);
            }
        };

        window.deleteApp = (id) => {
            if (confirm("Xóa mục này?")) {
                deleteDoc(doc(currentDb, "apps", id))
                    .then(() => showToast("Đã xóa ứng dụng!"))
                    .catch(e => showToast("Lỗi khi xóa ứng dụng!", true));
            }
        };

        window.toggleAppVisibility = (id) => {
            if (!isAdmin) return;
            const app = apps.find(a => a.id === id);
            if (!app) return;
            updateDoc(doc(currentDb, "apps", id), { visible: !app.visible })
                .then(() => showToast(`Đã ${!app.visible ? 'BẬT' : 'TẮT'} hiển thị.`))
                .catch(e => showToast("Lỗi cập nhật hiển thị!", true));
        };

        window.renderCategories = renderCategories; 
        function renderCategories() {
            const bar = document.getElementById('category-bar');
            let html = `<button onclick="window.setFilter('all')" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest transition-all ${currentFilter === 'all' ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-500'}">TẤT CẢ</button>`;
            
            if (currentUser) {
                html += `<button onclick="window.setFilter('favorites')" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest transition-all flex items-center gap-2 ${currentFilter === 'favorites' ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-500'}">
                    <i data-lucide="star" class="w-3 h-3 ${currentFilter === 'favorites' ? 'fill-white' : ''}"></i> ƯA THÍCH
                </button>`;
            }
            
            categories.forEach(c => {
                html += `<button onclick="window.setFilter('${c.id}')" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest transition-all flex items-center gap-2 ${currentFilter === c.id ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-500'}">
                    ${c.icon ? `<img src="${c.icon}" class="w-3 h-3 object-contain">` : ''} ${c.name.toUpperCase()}
                </button>`;
            });
            bar.innerHTML = html;

            const list = document.getElementById('cat-list-admin');
            list.innerHTML = categories.map(c => `<li class="flex flex-col gap-2 p-4 bg-slate-50 dark:bg-white/5 rounded-2xl border dark:border-white/5" data-id="${c.id}"><div class="flex items-center gap-3"><i data-lucide="grip-vertical" class="text-slate-300 cursor-move"></i><input type="text" value="${c.name}" onblur="window.updateCatField('${c.id}', 'name', this.value)" class="flex-1 bg-transparent border-none font-bold text-sm outline-none"><button onclick="window.deleteCat('${c.id}')" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><input type="text" value="${c.icon || ''}" onblur="window.updateCatField('${c.id}', 'icon', this.value)" placeholder="Icon URL" class="text-[10px] bg-white dark:bg-black/20 px-4 py-2 rounded-lg outline-none w-full border-none shadow-inner"></li>`).join('');
            lucide.createIcons();
            if(isAdmin && currentDb) new Sortable(list, { animation: 150, handle: '.cursor-move', onEnd: () => { Array.from(list.children).forEach((el, i) => updateDoc(doc(currentDb, "categories", el.dataset.id), { order: i })); }});
            document.getElementById('app-category').innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        window.setFilter = (id) => { 
            if (id === 'favorites' && !currentUser) {
                 showToast("Vui lòng đăng nhập để xem mục yêu thích!");
                 return;
            }
            currentFilter = id; 
            renderCategories(); 
            renderApps(); 
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.switchTab = (tabId) => {
            const tabs = ['tab-cat', 'tab-announcement', 'tab-deputy', 'tab-request', 'tab-data', 'tab-subdomain-request']; 
            const buttons = ['btn-tab-cat', 'btn-tab-announcement', 'btn-tab-deputy', 'btn-tab-request', 'btn-tab-data', 'btn-tab-subdomain-request']; 

            tabs.forEach(id => document.getElementById(id).classList.add('hidden'));
            buttons.forEach(id => document.getElementById(id).classList.remove('text-primary', 'border-b-2', 'border-primary'));
            
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('text-primary', 'border-b-2', 'border-primary');
            
            if (tabId === 'tab-announcement' && isAdmin) {
                 document.getElementById('announcement-content').value = currentAnnouncement.content || '';
                 renderAnnouncementControls();
            }
            
            if (tabId === 'tab-deputy' && isAdmin) {
                 renderDeputyList();
            }
            
            if (tabId === 'tab-request' && isAdmin && isMotherSite) {
                 renderAdminRequests();
            }
            if (tabId === 'tab-subdomain-request' && isAdmin && isMotherSite) {
                 renderSubdomainRequests();
            }
        };
        
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; };
        document.getElementById('search-input').oninput = (e) => { searchQuery = e.target.value; renderApps(); };
        window.setView = (mode) => { viewMode = mode; renderApps(); };
        
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            
            const isErrorMessage = msg.toLowerCase().includes('lỗi') || isError; 
            const icon = t.querySelector('i');
            
            if (isErrorMessage) {
                 icon.setAttribute('data-lucide', 'alert-triangle');
                 icon.classList.remove('text-green-500');
                 icon.classList.add('text-red-500');
            } else {
                 icon.setAttribute('data-lucide', 'check-circle');
                 icon.classList.remove('text-red-500');
                 icon.classList.add('text-green-500');
            }
            lucide.createIcons();
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-20'), 3000);
        }

        if(localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        lucide.createIcons();
        window.setView('grid');
    </script>
</body>
</html>
