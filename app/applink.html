<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Hub Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', secondary: '#06b6d4', dark: '#0f172a' },
                    borderRadius: { 'app': '1.25rem' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; transition: all 0.3s ease; }
        .dark body { background-color: #020617; color: #f1f5f9; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Thu nhỏ card app */
        .app-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .app-card:hover { transform: translateY(-5px); }
        .app-card:active { transform: scale(0.92); }
        .app-icon-wrapper { aspect-ratio: 1; width: 100%; max-width: 64px; margin: 0 auto; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .dark .tab-active { color: #818cf8; border-bottom: 2px solid #818cf8; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- Header -->
    <header class="sticky top-0 z-[60] glass border-b px-4 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-sm font-extrabold tracking-tight uppercase leading-none">Hub Portal</h1>
                <span id="role-tag" class="text-[9px] font-bold text-slate-400">GUEST VIEW</span>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="toggleTheme()" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                <i data-lucide="sun" class="w-4 h-4 hidden dark:block text-amber-400"></i>
                <i data-lucide="moon" class="w-4 h-4 dark:hidden text-slate-600"></i>
            </button>
            <div id="auth-section">
                <button id="btn-login" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md hover:bg-indigo-700 transition">LOGIN</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-10">
        <!-- Search -->
        <div class="relative max-w-xl mx-auto">
            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
            <input type="text" id="search-input" placeholder="Tìm nhanh ứng dụng..." 
                class="w-full pl-11 pr-4 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl focus:ring-2 ring-indigo-500/20 outline-none transition text-sm">
        </div>

        <!-- Categories Wrap -->
        <div class="space-y-4">
            <div class="flex items-center gap-2 text-slate-400">
                <i data-lucide="filter" class="w-3 h-3"></i>
                <span class="text-[10px] font-bold uppercase tracking-widest">Danh mục</span>
            </div>
            <div id="category-bar" class="flex flex-wrap gap-2">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Grid Apps (Thu nhỏ kích thước) -->
        <div id="app-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-x-4 gap-y-8">
            <!-- Loading Skeletons -->
            <div class="animate-pulse bg-slate-200 dark:bg-slate-800 aspect-square rounded-2xl"></div>
            <div class="animate-pulse bg-slate-200 dark:bg-slate-800 aspect-square rounded-2xl"></div>
        </div>
    </main>

    <!-- Admin Dock -->
    <div id="admin-controls" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[100]">
        <div class="glass px-2 py-2 rounded-2xl shadow-2xl flex items-center gap-1 border border-white/50">
            <button onclick="openModal('modal-main')" class="p-3 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-xl transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
            <div class="w-px h-6 bg-slate-200 dark:bg-slate-800 mx-1"></div>
            <button onclick="openAppModal()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/30">
                <i data-lucide="plus" class="w-4 h-4"></i> APP MỚI
            </button>
        </div>
    </div>

    <!-- Main Admin Modal (Tabs) -->
    <div id="modal-main" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl border dark:border-white/5">
            <div class="px-8 py-4 border-b dark:border-white/5 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 class="font-extrabold text-lg uppercase tracking-tight">Hệ thống quản trị</h3>
                <button onclick="closeModal('modal-main')" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex border-b dark:border-white/5 px-8 gap-6 text-sm font-bold text-slate-400">
                <button onclick="switchTab('tab-cat')" id="btn-tab-cat" class="py-4 tab-active transition">DANH MỤC</button>
                <button onclick="switchTab('tab-deputy')" id="btn-tab-deputy" class="py-4 transition">PHÓ ADMIN</button>
            </div>

            <div class="flex-1 overflow-y-auto p-8">
                <!-- Tab Categories -->
                <div id="tab-cat" class="space-y-6">
                    <div class="flex gap-2">
                        <input type="text" id="new-cat-name" placeholder="Tên danh mục mới..." class="flex-1 px-4 py-3 bg-slate-100 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-indigo-500 text-sm">
                        <button onclick="addCategory()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold text-xs shadow-lg">THÊM</button>
                    </div>
                    <ul id="cat-list-admin" class="space-y-2">
                        <!-- Category list -->
                    </ul>
                </div>

                <!-- Tab Deputy (Only Super Admin) -->
                <div id="tab-deputy" class="hidden space-y-6">
                    <div id="deputy-guard" class="hidden bg-amber-50 dark:bg-amber-900/20 text-amber-600 p-4 rounded-xl text-xs font-bold border border-amber-200 dark:border-amber-900/50">
                        Chỉ Super Admin mới có quyền bổ nhiệm Phó Admin.
                    </div>
                    <div id="deputy-ui" class="space-y-4">
                        <div class="flex gap-2">
                            <input type="email" id="new-deputy-email" placeholder="Nhập Email phó admin (Gmail)..." class="flex-1 px-4 py-3 bg-slate-100 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-indigo-500 text-sm">
                            <button onclick="addDeputy()" class="bg-indigo-600 text-white px-6 rounded-xl font-bold text-xs shadow-lg">BỔ NHIỆM</button>
                        </div>
                        <div class="space-y-2" id="deputy-list">
                            <!-- Deputy list -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal App Create/Edit -->
    <div id="modal-app" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl border dark:border-white/5">
            <div class="p-8 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="app-modal-title" class="font-extrabold text-lg uppercase tracking-tight">Cài đặt App</h3>
                <button onclick="closeModal('modal-app')" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="app-form" class="p-8 space-y-4">
                <input type="hidden" id="edit-id">
                <input type="text" id="app-name" placeholder="Tên ứng dụng" required class="w-full px-5 py-3 bg-slate-100 dark:bg-white/5 rounded-xl outline-none border-none focus:ring-2 ring-indigo-500 text-sm">
                <input type="url" id="app-link" placeholder="Đường dẫn URL" required class="w-full px-5 py-3 bg-slate-100 dark:bg-white/5 rounded-xl outline-none border-none focus:ring-2 ring-indigo-500 text-sm">
                <input type="text" id="app-icon" placeholder="URL Icon (Thủ công)" class="w-full px-5 py-3 bg-slate-100 dark:bg-white/5 rounded-xl outline-none border-none focus:ring-2 ring-indigo-500 text-sm">
                <select id="app-category" class="w-full px-5 py-3 bg-slate-100 dark:bg-white/5 rounded-xl outline-none border-none focus:ring-2 ring-indigo-500 text-sm"></select>
                <div class="flex items-center gap-2 p-2">
                    <input type="checkbox" id="app-visible" checked class="w-5 h-5 accent-indigo-600">
                    <label class="text-xs font-bold text-slate-500">Hiển thị công khai</label>
                </div>
                <button type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 text-sm">LƯU ỨNG DỤNG</button>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, getDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const SUPER_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let user = null, isAdmin = false, isSuper = false, deputies = [], apps = [], categories = [], currentFilter = 'all', searchQuery = '';

        // --- AUTH & RBAC ---
        onAuthStateChanged(auth, async (u) => {
            user = u;
            if (u) {
                isSuper = u.uid === SUPER_UID;
                // Fetch deputies from Firestore
                const settings = await getDoc(doc(db, "settings", "admins"));
                deputies = settings.exists() ? settings.data().deputy_emails || [] : [];
                isAdmin = isSuper || deputies.includes(u.email);
                
                renderAuthUI();
                renderDeputyList();
            } else {
                isAdmin = false;
                isSuper = false;
                document.getElementById('auth-section').innerHTML = `<button onclick="window.login()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold">LOGIN</button>`;
            }
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('role-tag').innerText = isSuper ? 'SUPER ADMIN' : (isAdmin ? 'DEPUTY ADMIN' : 'GUEST VIEW');
            renderApps();
        });

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        function renderAuthUI() {
            document.getElementById('auth-section').innerHTML = `
                <div class="flex items-center gap-2 bg-white dark:bg-slate-800 p-1 pr-3 rounded-lg border dark:border-white/10">
                    <img src="${user.photoURL}" class="w-7 h-7 rounded-md">
                    <button onclick="window.logout()" class="text-[10px] font-bold text-red-500 uppercase tracking-tighter">Exit</button>
                </div>`;
        }

        // --- DATA SYNC ---
        onSnapshot(query(collection(db, "categories"), orderBy("order", "asc")), (snap) => {
            categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCategories();
            updateAppCategorySelect();
        });

        onSnapshot(query(collection(db, "apps"), orderBy("order", "asc")), (snap) => {
            apps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderApps();
        });

        // --- RENDER APP GRID ---
        window.renderApps = () => {
            const grid = document.getElementById('app-grid');
            const filtered = apps.filter(a => {
                const matchSearch = a.name.toLowerCase().includes(searchQuery.toLowerCase());
                const matchCat = currentFilter === 'all' || a.categoryId === currentFilter;
                return matchSearch && matchCat && (isAdmin || a.visible);
            });

            grid.innerHTML = filtered.map(a => {
                const domain = new URL(a.url).hostname;
                const cat = categories.find(c => c.id === a.categoryId);
                const finalIcon = a.iconUrl || cat?.icon || `https://unavatar.io/${domain}?fallback=https://www.google.com/s2/favicons?domain=${domain}&sz=128`;

                return `
                <div class="app-card animate-in flex flex-col items-center group relative" data-id="${a.id}">
                    <a href="${a.url}" target="_blank" class="app-icon-wrapper bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-white/5 flex items-center justify-center p-3 mb-2 overflow-hidden">
                        <img src="${finalIcon}" class="w-full h-full object-contain" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1243/1243966.png'">
                    </a>
                    <span class="text-[10px] font-bold text-slate-500 dark:text-slate-400 text-center truncate w-full uppercase tracking-tighter">${a.name}</span>
                    ${isAdmin ? `
                        <div class="absolute -top-1 -right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-all scale-75">
                            <button onclick="window.editApp('${a.id}')" class="bg-indigo-500 text-white p-1.5 rounded-full shadow-md hover:bg-indigo-600"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="window.deleteApp('${a.id}')" class="bg-rose-500 text-white p-1.5 rounded-full shadow-md hover:bg-rose-600"><i data-lucide="trash" class="w-3 h-3"></i></button>
                        </div>
                    ` : ''}
                </div>`;
            }).join('');
            lucide.createIcons();
            if(isAdmin && filtered.length > 1) new Sortable(grid, { animation: 150, onEnd: () => {
                Array.from(grid.children).forEach((el, i) => { if(el.dataset.id) updateDoc(doc(db, "apps", el.dataset.id), { order: i }); });
            }});
        }

        // --- CATEGORY ACTIONS ---
        function renderCategories() {
            const bar = document.getElementById('category-bar');
            let html = `<button onclick="window.setFilter('all')" class="px-4 py-2 rounded-xl text-[10px] font-black tracking-widest transition ${currentFilter === 'all' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-400'}">TẤT CẢ</button>`;
            categories.forEach(c => {
                html += `<button onclick="window.setFilter('${c.id}')" class="px-4 py-2 rounded-xl text-[10px] font-black tracking-widest transition flex items-center gap-2 ${currentFilter === c.id ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-400'}">
                    ${c.icon ? `<img src="${c.icon}" class="w-3 h-3 object-contain">` : ''} ${c.name.toUpperCase()}
                </button>`;
            });
            bar.innerHTML = html;

            const adminList = document.getElementById('cat-list-admin');
            adminList.innerHTML = categories.map(c => `
                <li class="flex flex-col gap-2 p-4 bg-slate-50 dark:bg-white/5 rounded-2xl border dark:border-white/5" data-id="${c.id}">
                    <div class="flex items-center gap-3">
                        <i data-lucide="grip-vertical" class="text-slate-300 cursor-move"></i>
                        <input type="text" value="${c.name}" onchange="window.updateCat('${c.id}', 'name', this.value)" class="flex-1 bg-transparent border-none font-bold text-sm outline-none focus:text-indigo-500">
                        <button onclick="window.deleteCat('${c.id}')" class="text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 p-2 rounded-lg transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <input type="text" value="${c.icon || ''}" placeholder="Link Logo/Icon (Dùng cho mọi app trong mục này nếu app đó không có icon)" onchange="window.updateCat('${c.id}', 'icon', this.value)" class="text-[10px] bg-white dark:bg-black/20 px-3 py-2 rounded-lg outline-none w-full border-none">
                </li>
            `).join('');
            lucide.createIcons();
            if(isAdmin) new Sortable(adminList, { animation: 150, handle: '.cursor-move', onEnd: () => {
                Array.from(adminList.children).forEach((el, i) => updateDoc(doc(db, "categories", el.dataset.id), { order: i }));
            }});
        }

        window.setFilter = (id) => { currentFilter = id; renderCategories(); renderApps(); };
        window.updateCat = (id, field, val) => updateDoc(doc(db, "categories", id), { [field]: val });
        window.deleteCat = (id) => confirm("Xóa danh mục này?") && deleteDoc(doc(db, "categories", id));
        window.addCategory = async () => {
            const name = document.getElementById('new-cat-name').value;
            if(!name) return;
            await addDoc(collection(db, "categories"), { name, order: categories.length });
            document.getElementById('new-cat-name').value = '';
        };

        // --- DEPUTY MANAGEMENT ---
        function renderDeputyList() {
            const guard = document.getElementById('deputy-guard');
            const ui = document.getElementById('deputy-ui');
            const list = document.getElementById('deputy-list');
            
            guard.classList.toggle('hidden', isSuper);
            ui.classList.toggle('hidden', !isSuper);

            list.innerHTML = deputies.map(email => `
                <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-2xl border dark:border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900/40 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400">
                            <i data-lucide="user-check" class="w-4 h-4"></i>
                        </div>
                        <span class="text-sm font-medium">${email}</span>
                    </div>
                    ${isSuper ? `<button onclick="window.removeDeputy('${email}')" class="text-rose-500 p-2"><i data-lucide="user-minus" class="w-4 h-4"></i></button>` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.addDeputy = async () => {
            const email = document.getElementById('new-deputy-email').value;
            if(!email || !isSuper) return;
            await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
            document.getElementById('new-deputy-email').value = '';
            location.reload(); // Refresh to update RBAC
        };

        window.removeDeputy = async (email) => {
            if(!confirm("Hủy quyền Phó Admin của email này?") || !isSuper) return;
            await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayRemove(email) }, { merge: true });
            location.reload();
        };

        // --- APP ACTIONS ---
        window.openAppModal = () => {
            document.getElementById('app-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('app-modal-title').innerText = "THÊM APP MỚI";
            openModal('modal-app');
        };

        window.editApp = (id) => {
            const a = apps.find(x => x.id === id);
            document.getElementById('edit-id').value = a.id;
            document.getElementById('app-name').value = a.name;
            document.getElementById('app-link').value = a.url;
            document.getElementById('app-icon').value = a.iconUrl || '';
            document.getElementById('app-category').value = a.categoryId || '';
            document.getElementById('app-visible').checked = a.visible;
            document.getElementById('app-modal-title').innerText = "CẬP NHẬT APP";
            openModal('modal-app');
        };

        document.getElementById('app-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = {
                name: document.getElementById('app-name').value,
                url: document.getElementById('app-link').value,
                iconUrl: document.getElementById('app-icon').value,
                categoryId: document.getElementById('app-category').value,
                visible: document.getElementById('app-visible').checked,
                order: id ? apps.find(x => x.id === id).order : apps.length
            };
            id ? await updateDoc(doc(db, "apps", id), data) : await addDoc(collection(db, "apps"), data);
            closeModal('modal-app');
        };

        window.deleteApp = (id) => confirm("Xóa app này?") && deleteDoc(doc(db, "apps", id));

        // --- UTILS ---
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.switchTab = (tabId) => {
            document.getElementById('tab-cat').classList.add('hidden');
            document.getElementById('tab-deputy').classList.add('hidden');
            document.getElementById('btn-tab-cat').classList.remove('tab-active');
            document.getElementById('btn-tab-deputy').classList.remove('tab-active');
            
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('tab-active');
        };

        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        };

        document.getElementById('search-input').oninput = (e) => { searchQuery = e.target.value; renderApps(); };
        function updateAppCategorySelect() {
            const s = document.getElementById('app-category');
            s.innerHTML = `<option value="">Danh mục (Không có)</option>` + categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        if(localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        lucide.createIcons();
    </script>
</body>
</html>
