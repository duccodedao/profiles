<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu app - Vĩnh Trạch Đông</title>
    <link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">
    
    <!-- SEO & PWA Meta Tags -->
    <meta name="description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">
    <link rel="apple-touch-icon" href="https://bmass.vercel.app/img/bmasslogo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hub Vĩnh Trạch Đông">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#4f46e5">

    <!-- Social Media Meta -->
    <meta property="og:title" content="Hub Portal - Vĩnh Trạch Đông">
    <meta property="og:description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <meta property="og:image" content="https://bmass.vercel.app/img/bmasslogo.png">
    <meta property="og:type" content="website">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Excel Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4f46e5', secondary: '#f43f5e', dark: '#020617' } } }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; padding-bottom: 100px; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .app-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drag-ghost { opacity: 0.3; background: #4f46e5 !important; border-radius: 1rem; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .dark .tab-active { color: #818cf8; border-bottom: 2px solid #818cf8; }
        .is-favorite .star-icon { fill: #facc15; }
        .app-item.selected-for-delete { box-shadow: 0 0 0 3px #f43f5e; border-radius: 1rem; }
        /* Thêm padding top khi có thông báo để không che header */
        #announcement-bar:not(.hidden) ~ header { top: 32px; }
        /* Custom Marquee */
        .marquee { overflow: hidden; white-space: nowrap; box-sizing: border-box; }
        .marquee > div { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        
        /* ADMIN SIDEBAR STYLE */
        #admin-sidebar { transition: transform 0.3s ease-out; width: 320px; }
        #admin-sidebar.open { transform: translateX(0); }
        #admin-sidebar.closed { transform: translateX(-320px); }
        .sidebar-item-active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- NEW: Admin Sidebar Backdrop -->
    <div id="admin-backdrop" onclick="window.toggleAdminSidebar()" class="fixed inset-0 bg-black/50 z-[150] hidden"></div>
    
    <!-- NEW: Admin Sidebar -->
    <div id="admin-sidebar" class="fixed top-0 left-0 h-full bg-white dark:bg-slate-900 z-[200] closed shadow-2xl flex flex-col">
        <!-- Sidebar Header -->
        <div class="p-4 border-b dark:border-white/5 flex items-center justify-between">
            <h2 class="text-xl font-black uppercase tracking-tight text-primary">Admin Control</h2>
            <button onclick="window.toggleAdminSidebar()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-white/5"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        
        <!-- Sidebar Navigation -->
        <div class="p-4 space-y-2 flex-shrink-0">
            <button onclick="window.switchAdminTab('announcement')" id="btn-sidebar-announcement" class="w-full text-left flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition sidebar-item-active"><i data-lucide="megaphone" class="w-5 h-5"></i> THÔNG BÁO</button>
            <button onclick="window.switchAdminTab('access')" id="btn-sidebar-access" class="w-full text-left flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i data-lucide="shield-check" class="w-5 h-5"></i> QUYỀN TRUY CẬP</button>
            <button onclick="window.switchAdminTab('data')" id="btn-sidebar-data" class="w-full text-left flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i data-lucide="box" class="w-5 h-5"></i> DỮ LIỆU APP & DM</button>
        </div>
        
        <!-- Sidebar Content Area -->
        <div id="sidebar-content-area" class="flex-1 overflow-y-auto p-4 border-t dark:border-white/5">
            <!-- Tab Announcement (FROM MODAL) -->
            <div id="tab-announcement-sidebar" class="space-y-6">
                <h4 class="text-sm font-bold tracking-widest text-primary uppercase">Thông báo Chạy chữ (Marquee)</h4>
                <textarea id="announcement-content" placeholder="Nội dung thông báo (ngắn gọn, lặp lại)" rows="3" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                
                <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5">
                    <label class="text-sm font-bold opacity-60">Kích hoạt Thông báo</label>
                    <button id="toggle-announcement-btn" onclick="window.toggleAnnouncementStatus()" class="px-4 py-1.5 rounded-lg font-bold text-xs uppercase transition-all">Tắt / Bật</button>
                </div>
                
                <button onclick="window.saveAnnouncementContent()" class="w-full py-3 bg-primary text-white rounded-xl font-bold shadow-md uppercase text-xs">LƯU NỘI DUNG</button>
            </div>

            <!-- Tab Access (NEW: Requests and Admin List) -->
            <div id="tab-access-sidebar" class="hidden space-y-6">
                 <h4 class="text-sm font-bold tracking-widest text-primary uppercase">QUẢN LÝ QUYỀN TRUY CẬP</h4>
                 <div id="access-management-ui" class="space-y-6">
                     <h5 class="text-xs font-bold text-slate-500 uppercase mt-4">DANH SÁCH ADMIN & PHÓ ADMIN</h5>
                     <ul id="deputy-list" class="space-y-2"></ul>
                 </div>
                 <div id="access-guard" class="hidden p-4 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-xl text-xs font-bold uppercase">Chỉ Super Admin mới quản lý được mục này.</div>
                 
                 <h5 class="text-xs font-bold text-slate-500 uppercase mt-6">YÊU CẦU CẤP QUYỀN (Pending)</h5>
                 <ul id="request-list" class="space-y-2"></ul>
            </div>
            
            <!-- Tab Data (NEW: Apps and Categories Management) -->
            <div id="tab-data-sidebar" class="hidden space-y-6">
                <h4 class="text-sm font-bold tracking-widest text-primary uppercase">QUẢN LÝ APP & DANH MỤC</h4>
                
                <h5 class="text-xs font-bold text-slate-500 uppercase mt-4">DANH MỤC</h5>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-cat-name" placeholder="Tên danh mục..." class="flex-1 px-3 py-2 bg-slate-50 dark:bg-white/5 rounded-lg outline-none focus:ring-2 ring-primary text-sm">
                    <button onclick="window.addCategory()" class="bg-primary text-white px-4 rounded-lg font-bold text-xs uppercase">Thêm</button>
                </div>
                <ul id="cat-list-admin" class="space-y-2"></ul>
                
                <h5 class="text-xs font-bold text-slate-500 uppercase mt-8">XUẤT NHẬP DỮ LIỆU</h5>
                 <div class="space-y-2">
                    <button onclick="window.handleExport('json')" class="flex items-center justify-between w-full px-3 py-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-sm font-bold hover:bg-slate-100 dark:hover:bg-slate-700 transition">Xuất file JSON <i data-lucide="download" class="w-4 h-4"></i></button>
                    <button onclick="window.openModal('modal-import')" class="flex items-center justify-between w-full px-3 py-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-sm font-bold hover:bg-slate-100 dark:hover:bg-slate-700 transition">Nhập dữ liệu <i data-lucide="upload-cloud" class="w-4 h-4"></i></button>
                 </div>
            </div>
        </div>
    </div>

    <!-- NEW: Announcement Bar -->
    <div id="announcement-bar" class="fixed top-0 left-0 w-full z-[101] bg-secondary text-white text-xs font-bold py-2 shadow-md hidden">
        <div class="marquee">
            <div id="announcement-text"></div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="sticky top-0 z-[100] glass px-6 py-3 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg">
                <i data-lucide="database" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xs font-black tracking-tighter uppercase leading-none">Hub Portal</h1>
                <span id="role-status" class="text-[9px] font-bold text-slate-400">GUEST</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Nút Bulk Delete (Admin) -->
            <button onclick="window.toggleBulkDelete()" id="bulk-delete-toggle" class="p-2 rounded-xl text-red-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition hidden"><i data-lucide="scissors" class="w-5 h-5"></i></button>

            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                <button onclick="window.setView('grid')" id="view-grid-btn" class="p-1.5 rounded-md transition-all shadow-sm bg-white dark:bg-slate-700"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                <button onclick="window.setView('list')" id="view-list-btn" class="p-1.5 rounded-md transition-all"><i data-lucide="list" class="w-4 h-4"></i></button>
            </div>
            <button onclick="window.toggleTheme()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden text-slate-600"></i>
            </button>
            <div id="auth-section"></div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 space-y-8">
        <!-- Search -->
        <div class="relative max-w-2xl mx-auto">
            <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
            <input type="text" id="search-input" placeholder="Tìm ứng dụng hoặc danh bạ..." 
                class="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-2xl focus:ring-4 ring-primary/10 outline-none shadow-sm">
        </div>

        <!-- Visit Stats Container -->
        <div id="visit-stats-container" class="max-w-4xl mx-auto p-4 rounded-3xl bg-slate-100 dark:bg-slate-900/50">
            <div class="flex items-center justify-center h-20 text-slate-400">Đang tải thống kê...</div>
        </div>

        <!-- Categories -->
        <div id="category-bar" class="flex flex-wrap gap-2"></div>
        
        <!-- App Loading State -->
        <div id="app-loading" class="text-center p-16 text-slate-400 text-sm font-medium hidden">
            <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
            Đang tải ứng dụng...
        </div>

        <!-- Main Content App -->
        <div id="app-container"></div>
        
        <!-- Bulk Delete Floating Dock -->
        <div id="bulk-delete-dock" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 z-[110]">
            <div class="bg-red-600 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-4">
                <span id="selected-count">0</span> mục đã chọn
                <button onclick="window.executeBulkDelete()" class="flex items-center gap-2 px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold shadow-lg uppercase">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> XÓA
                </button>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="fixed bottom-0 w-full z-50 bg-white dark:bg-slate-900 border-t dark:border-white/10 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="max-w-7xl mx-auto px-6 py-3 flex justify-between items-center text-sm">
            <div class="text-slate-500 dark:text-slate-400">
                © 2024 Vĩnh Trạch Đông. All rights reserved.
            </div>
            <div class="flex items-center gap-4">
                <a href="#" class="text-xs font-bold text-slate-500 hover:text-primary transition">Privacy Policy</a>
                <a href="chat.html" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-secondary text-white rounded-lg font-bold text-xs uppercase shadow-lg hover:opacity-90 transition">
                    <i data-lucide="life-buoy" class="w-4 h-4"></i> TRỢ GIÚP
                </a>
            </div>
        </div>
    </footer>


    <!-- Admin Dock (OPEN SIDEBAR) -->
    <div id="admin-controls" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[110]">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-3 py-2 rounded-2xl shadow-2xl flex items-center gap-2">
            <button onclick="window.toggleAdminSidebar(); window.switchAdminTab('announcement')" class="p-3 hover:bg-white/10 dark:hover:bg-black/5 rounded-xl transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
            <div class="w-px h-6 bg-white/20 dark:bg-black/10"></div>
            <button onclick="window.openAppModal()" class="flex items-center gap-2 px-5 py-2.5 bg-primary text-white rounded-xl text-xs font-bold shadow-lg">
                <i data-lucide="plus" class="w-4 h-4"></i> THÊM MỚI
            </button>
        </div>
    </div>
    
    <!-- NEW: Modal Request Admin Access -->
    <div id="modal-request-admin" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[250] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">YÊU CẦU CẤP QUYỀN</h3>
                <button onclick="window.closeModal('modal-request-admin')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="request-form" class="p-8 space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Gmail của bạn</label>
                    <input type="email" id="request-email" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium" disabled>
                </div>
                 <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Lý do</label>
                    <textarea id="request-reason" rows="3" placeholder="Ví dụ: Cần cập nhật danh bạ liên hệ" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium" required></textarea>
                </div>
                <button type="submit" class="w-full py-4 bg-secondary text-white rounded-xl font-bold shadow-lg shadow-red-500/30 uppercase text-xs">GỬI YÊU CẦU</button>
            </form>
        </div>
    </div>

    <!-- Modal for Admin to set permissions -->
    <div id="modal-set-permissions" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[250] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">PHÂN QUYỀN TRUY CẬP</h3>
                <button onclick="window.closeModal('modal-set-permissions')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="permission-form" class="p-8 space-y-6">
                <input type="hidden" id="perm-user-email">
                <p class="text-sm font-bold" id="perm-user-title">Cấp quyền cho: Loading...</p>
                
                <div class="space-y-3">
                    <label class="text-xs font-bold text-slate-400 uppercase">Quyền quản lý</label>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="perm-apps" class="w-5 h-5 accent-primary">
                        <label for="perm-apps" class="text-sm font-medium">Quản lý Ứng dụng/Danh mục (Thêm, Sửa, Xóa)</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="perm-data" class="w-5 h-5 accent-primary">
                        <label for="perm-data" class="text-sm font-medium">Quản lý Dữ liệu (Import/Export)</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="perm-announcement" class="w-5 h-5 accent-primary">
                        <label for="perm-announcement" class="text-sm font-medium">Quản lý Thông báo</label>
                    </div>
                </div>

                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs">CẤP VÀ LƯU QUYỀN</button>
            </form>
        </div>
    </div>


    <!-- App Modal (Dùng chung cho Add/Edit App) -->
    <div id="modal-app" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="app-modal-title" class="font-bold uppercase text-sm tracking-widest">Cấu hình</h3>
                <button onclick="window.closeModal('modal-app')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="app-form" class="p-8 space-y-4">
                <input type="hidden" id="edit-id">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh mục</label>
                    <select id="app-category" onchange="window.toggleFormFields()" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select>
                </div>
                <div class="space-y-1">
                    <label id="label-name" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tên hiển thị</label>
                    <input type="text" id="app-name" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div id="field-position" class="space-y-1 hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Chức vụ</label>
                    <input type="text" id="app-position" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label id="label-link" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Link URL</label>
                    <input type="text" id="app-link" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Icon URL</label>
                    <input type="text" id="app-icon" placeholder="Để trống để tự lấy" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="flex items-center gap-3 p-2">
                    <input type="checkbox" id="app-visible" checked class="w-5 h-5 accent-primary">
                    <label class="text-xs font-bold opacity-60">Hiển thị công khai</label>
                </div>
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 uppercase text-xs">Lưu ứng dụng</button>
            </form>
        </div>
    </div>
    
    <!-- Modal for Import (From Data tab) -->
    <div id="modal-import" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[250] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">NHẬP DỮ LIỆU</h3>
                <button onclick="window.closeModal('modal-import')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-4">
                <p class="text-xs text-slate-500 font-medium">Khôi phục dữ liệu từ file JSON hoặc Excel đã lưu trước đó. <br><b>Lưu ý:</b> Dữ liệu mới sẽ được thêm vào.</p>
                <div class="relative">
                    <input type="file" id="import-file-modal" accept=".json, .xlsx" onchange="window.handleImport(event)" class="hidden">
                    <label for="import-file-modal" class="flex items-center justify-center gap-3 w-full px-5 py-4 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-xl cursor-pointer hover:opacity-90 transition font-bold text-xs uppercase">
                        <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                        Chọn file để khôi phục
                    </label>
                </div>
            </div>
        </div>
    </div>


    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-10 right-10 z-[300] transform translate-y-20 opacity-0 transition-all duration-500">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border dark:border-white/10">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg" class="text-sm font-bold tracking-tight">Thành công!</span>
        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch, increment, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const SUPER_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        let currentUser = null, isAdmin = false, isSuper = false, apps = [], categories = [], deputies = [], currentFilter = 'all', searchQuery = '', viewMode = 'grid', visitStats = {};
        let userFavorites = []; 
        let appsLoaded = false; 
        let bulkDeleteMode = false; 
        let selectedAppsForDelete = new Set(); 
        let currentAnnouncement = {}; 
        let accessRequests = []; // NEW: Array to store admin access requests
        let adminPermissions = {}; // NEW: Map to store detailed admin permissions

        // --- AUTH & INITIAL ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                isSuper = user.uid === SUPER_UID;
                
                // 1. Get Admin List (emails)
                const snap = await getDoc(doc(db, "settings", "admins"));
                deputies = snap.exists() ? snap.data().deputy_emails || [] : [];
                isAdmin = isSuper || deputies.includes(user.email);
                
                // 2. Get Admin Permissions (NEW)
                const permSnap = await getDoc(doc(db, "settings", "permissions"));
                adminPermissions = permSnap.data() || {};
                
                // 3. Get User Favorites
                const userDoc = await getDoc(doc(db, "users", user.uid));
                userFavorites = userDoc.exists() ? userDoc.data().favorites || [] : [];
                
                renderAuthUI();
                
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userFavorites = snap.data()?.favorites || [];
                    if (currentFilter === 'favorites') renderApps();
                });
                
                // Set Request Modal Email
                if (document.getElementById('request-email')) {
                    document.getElementById('request-email').value = user.email || '';
                }
                
                // NEW: Load announcement content for Admin only
                if (isAdmin) {
                    document.getElementById('announcement-content').value = currentAnnouncement.content || '';
                }

            } else {
                isAdmin = isSuper = false;
                userFavorites = [];
                document.getElementById('auth-section').innerHTML = `<button onclick="window.login()" class="bg-primary text-white px-5 py-2 rounded-lg text-xs font-bold uppercase tracking-widest">Login</button><button onclick="window.openRequestModal()" class="ml-2 bg-slate-100 dark:bg-slate-800 text-xs font-bold px-3 py-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition">REQUEST</button>`;
                if (currentFilter === 'favorites') window.setFilter('all'); 
            }
            document.getElementById('role-status').innerText = isSuper ? 'SUPER' : (isAdmin ? 'DEPUTY' : 'GUEST');
            document.getElementById('admin-controls').classList.toggle('hidden', !isAdmin);
            document.getElementById('bulk-delete-toggle').classList.toggle('hidden', !isAdmin);
            
            renderApps();
            renderDeputyList();
            renderAnnouncementControls(); 
            lucide.createIcons();
        });

        // --- DATA REALTIME LISTENERS ---
        onSnapshot(query(collection(db, "categories"), orderBy("order", "asc")), (snap) => {
            categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCategories();
        });

        onSnapshot(query(collection(db, "apps"), orderBy("order", "asc")), (snap) => {
            apps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            appsLoaded = true; 
            renderApps();
        });
        
        onSnapshot(doc(db, "settings", "visits_stats"), (snap) => {
            visitStats = snap.data() || {};
            renderStats();
        });
        
        onSnapshot(doc(db, "settings", "announcement"), (snap) => {
            currentAnnouncement = snap.data() || { content: '', active: false };
            renderAnnouncementBar();
            renderAnnouncementControls();
        });
        
        // NEW: Realtime listener for Access Requests
        onSnapshot(query(collection(db, "adminRequests"), where("status", "==", "pending"), orderBy("timestamp", "desc")), (snap) => {
            accessRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (isAdmin) renderRequestList();
        });
        
        // NEW: Realtime listener for Admin Permissions
        onSnapshot(doc(db, "settings", "permissions"), (snap) => {
            adminPermissions = snap.data() || {};
            if (isAdmin) renderDeputyList();
        });

        // --- GENERAL UTILS ---
        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            const icon = t.querySelector('i');
            if (msg.toLowerCase().includes('lỗi')) {
                 icon.setAttribute('data-lucide', 'alert-triangle');
                 icon.classList.remove('text-green-500');
                 icon.classList.add('text-red-500');
            } else {
                 icon.setAttribute('data-lucide', 'check-circle');
                 icon.classList.remove('text-red-500');
                 icon.classList.add('text-green-500');
            }
            lucide.createIcons(); 
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-20'), 3000);
        }
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
        };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; };
        // ... (KEEEP other unchanged functions) ...


        // --- ADMIN SIDEBAR LOGIC (NEW) ---
        window.toggleAdminSidebar = () => {
            const sidebar = document.getElementById('admin-sidebar');
            const backdrop = document.getElementById('admin-backdrop');
            const isOpen = sidebar.classList.toggle('open');
            sidebar.classList.toggle('closed', !isOpen);
            backdrop.classList.toggle('hidden', !isOpen);
        };
        
        window.switchAdminTab = (tabName) => {
            const tabs = ['announcement', 'access', 'data'];
            tabs.forEach(name => {
                document.getElementById(`tab-${name}-sidebar`).classList.toggle('hidden', name !== tabName);
                document.getElementById(`btn-sidebar-${name}`).classList.toggle('sidebar-item-active', name === tabName);
            });
            lucide.createIcons();
        };

        // --- REQUEST ACCESS LOGIC (NEW) ---
        window.openRequestModal = () => {
            if (!currentUser) {
                 showToast("Vui lòng đăng nhập bằng Google trước.");
                 return;
            }
            window.openModal('modal-request-admin');
        };
        
        document.getElementById('request-form').onsubmit = async (e) => {
             e.preventDefault();
             if (!currentUser) return;

             const reason = document.getElementById('request-reason').value.trim();
             const email = document.getElementById('request-email').value.trim();
             
             // Check for existing pending request
             const existingRequest = accessRequests.find(r => r.email === email);
             if (existingRequest) {
                  showToast("Yêu cầu của bạn đang được xem xét. Vui lòng chờ.");
                  return;
             }

             try {
                 await addDoc(collection(db, "adminRequests"), {
                      uid: currentUser.uid,
                      email: email,
                      name: currentUser.displayName,
                      reason: reason,
                      status: 'pending',
                      timestamp: new Date().toISOString()
                 });
                 window.closeModal('modal-request-admin');
                 showToast("Yêu cầu cấp quyền đã được gửi thành công!");
             } catch (e) {
                 console.error("Error sending request:", e);
                 showToast("Lỗi khi gửi yêu cầu.");
             }
        };

        function renderRequestList() {
            const list = document.getElementById('request-list');
            if (!list) return;

            if (accessRequests.length === 0) {
                 list.innerHTML = `<li class="p-3 text-sm text-slate-400">Không có yêu cầu mới.</li>`;
                 return;
            }

            list.innerHTML = accessRequests.map(req => `
                <li class="p-3 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5 space-y-2">
                    <p class="text-sm font-bold">${req.email}</p>
                    <p class="text-xs text-slate-500 italic">Lý do: ${req.reason}</p>
                    <div class="flex gap-2 pt-2">
                        <button onclick="window.openPermissionModal('${req.email}', '${req.id}')" class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-bold">CẤP QUYỀN</button>
                        <button onclick="window.rejectRequest('${req.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold">TỪ CHỐI</button>
                    </div>
                </li>
            `).join('');
        }

        window.rejectRequest = async (requestId) => {
            if (!isSuper || !confirm("Bạn có chắc chắn muốn từ chối yêu cầu này?")) return;
            try {
                await updateDoc(doc(db, "adminRequests", requestId), { status: 'rejected' });
                showToast("Đã từ chối yêu cầu.");
            } catch (e) {
                showToast("Lỗi từ chối yêu cầu.");
            }
        };

        window.openPermissionModal = (email, requestId) => {
            if (!isSuper) return;
            document.getElementById('perm-user-email').value = email;
            document.getElementById('perm-user-title').innerText = `Cấp quyền cho: ${email}`;
            document.getElementById('permission-form').setAttribute('data-request-id', requestId || '');
            
            // Load existing permissions
            const currentPerms = adminPermissions[email] || {};
            document.getElementById('perm-apps').checked = currentPerms.canManageApps || false;
            document.getElementById('perm-data').checked = currentPerms.canManageData || false;
            document.getElementById('perm-announcement').checked = currentPerms.canManageAnnouncement || false;

            window.openModal('modal-set-permissions');
        };

        document.getElementById('permission-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!isSuper) return;

            const email = document.getElementById('perm-user-email').value;
            const requestId = document.getElementById('permission-form').getAttribute('data-request-id');
            const canManageApps = document.getElementById('perm-apps').checked;
            const canManageData = document.getElementById('perm-data').checked;
            const canManageAnnouncement = document.getElementById('perm-announcement').checked;

            try {
                // 1. Update Permissions
                await setDoc(doc(db, "settings", "permissions"), {
                    [email]: {
                        canManageApps,
                        canManageData,
                        canManageAnnouncement
                    }
                }, { merge: true });
                
                // 2. Add to Deputy list (if not exists)
                await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
                
                // 3. Mark request as approved (if exists)
                if (requestId) {
                    await updateDoc(doc(db, "adminRequests", requestId), { status: 'approved' });
                }

                window.closeModal('modal-set-permissions');
                showToast(`Đã cấp quyền Phó Admin cho ${email}. Đang tải lại...`);
                setTimeout(() => location.reload(), 500);

            } catch (e) {
                console.error("Error setting permissions:", e);
                showToast("Lỗi khi cấp quyền và lưu trữ.");
            }
        };

        // --- DEPUTY LIST (UPDATED with Permissions) ---
        window.renderDeputyList = () => {
            const list = document.getElementById('deputy-list');
            if (!list) return;

            document.getElementById('access-guard').classList.toggle('hidden', isSuper);

            const allAdmins = Array.from(new Set([SUPER_UID, ...deputies]));
            
            list.innerHTML = allAdmins.map(emailOrUid => {
                let email = emailOrUid;
                let role = "Deputy";

                if (emailOrUid === SUPER_UID) {
                     email = currentUser.email || 'Super Admin';
                     role = "SUPER ADMIN";
                     // For SUPER ADMIN, show simple list entry
                     return `<li class="flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-xl border border-yellow-200 dark:border-yellow-700">
                                <span class="text-sm font-bold text-yellow-800 dark:text-yellow-300">${email}</span>
                                <span class="text-[9px] font-black text-yellow-600 uppercase">Super Admin</span>
                             </li>`;
                }
                
                const perms = adminPermissions[email] || {};
                const permStatus = [
                    perms.canManageApps ? 'APP' : '',
                    perms.canManageData ? 'DATA' : '',
                    perms.canManageAnnouncement ? 'ANNOUNCEMENT' : ''
                ].filter(p => p).join(', ') || 'Chỉ xem';

                return `<li class="flex items-center justify-between p-3 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold">${email}</span>
                                <span class="text-[10px] text-slate-500">${permStatus}</span>
                            </div>
                            <div class="flex gap-2">
                                ${isSuper ? `<button onclick="window.openPermissionModal('${email}', '')" class="text-primary p-1 rounded-lg hover:bg-slate-100"><i data-lucide="edit" class="w-4 h-4"></i></button>` : ''}
                                ${isSuper ? `<button onclick="window.removeDeputy('${email}')" class="text-red-500 p-1 rounded-lg hover:bg-slate-100"><i data-lucide="user-minus" class="w-4 h-4"></i></button>` : ''}
                            </div>
                        </li>`;
            }).join('');
            lucide.createIcons();
        };
        
        // --- ADMIN UTILS (FIXED TOASTS & RELOAD) ---
        window.updateCatField = (id, field, val) => updateDoc(doc(db, "categories", id), { [field]: val })
            .then(() => showToast("Đã cập nhật danh mục!"))
            .catch(e => showToast("Lỗi khi cập nhật danh mục!"));
            
        window.deleteCat = (id) => {
            if (confirm("Xóa danh mục này?")) {
                deleteDoc(doc(db, "categories", id))
                    .then(() => showToast("Đã xóa danh mục!"))
                    .catch(e => showToast("Lỗi khi xóa danh mục!"));
            }
        };
        
        window.addCategory = async () => {
            const name = document.getElementById('new-cat-name').value.trim();
            const icon = document.getElementById('new-cat-icon').value.trim();
            if(!name) { showToast("Tên danh mục không được trống!"); return; }
            await addDoc(collection(db, "categories"), { name, icon, order: categories.length })
                .then(() => {
                    document.getElementById('new-cat-name').value = '';
                    document.getElementById('new-cat-icon').value = '';
                    showToast("Đã thêm danh mục mới!");
                })
                .catch(e => showToast("Lỗi khi thêm danh mục."));
        };

        window.removeDeputy = async (email) => {
            if(!confirm(`Xóa quyền Phó Admin cho ${email}? (Việc này không xóa quyền chi tiết, nhưng sẽ loại người này khỏi danh sách Admin chính)`) || !isSuper) return;
            try {
                // Remove from admins list
                await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayRemove(email) }, { merge: true });
                // Optional: Remove from permissions map (clean up)
                await updateDoc(doc(db, "settings", "permissions"), { [email]: FieldValue.delete() });
                
                showToast(`Đã xóa quyền của ${email}. Đang tải lại...`);
                setTimeout(() => location.reload(), 500);
            } catch (e) { showToast("Lỗi khi xóa quyền Phó Admin."); }
        };
        
        // ... (other functions: toggleFormFields, openAppModal, editApp, app-form.onsubmit, deleteApp, toggleAppVisibility, setFilter, renderApps, handleExport, handleImport, renderStats)
        
        // Final Setup
        if(localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        lucide.createIcons();
        window.setView('grid');
        window.switchAdminTab('announcement'); // Set default tab for sidebar
        trackVisit();
    </script>
</body>
</html>
