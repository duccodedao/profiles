<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Elite Academy & Profile</title>
    
    <!-- 1. TH∆Ø VI·ªÜN UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- 2. CONFIG TAILWIND & CUSTOM CSS -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#050505', card: 'rgba(20, 20, 30, 0.6)' },
                        brand: { primary: '#6366f1', secondary: '#ec4899', accent: '#14b8a6', gold: '#fbbf24' }
                    },
                    animation: { 'blob': 'blob 7s infinite', 'spin-slow': 'spin 12s linear infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #ffffff; overflow-x: hidden; }
        .bg-mesh {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 25%),
                        radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 25%);
        }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); border-color: rgba(99, 102, 241, 0.3); }
        
        /* Custom Scrollbar for Horizontal Courses */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #6366f1; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div class="bg-mesh"></div>
    <!-- Moving Blobs -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-0 -left-4 w-72 h-72 bg-brand-primary rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-72 h-72 bg-brand-secondary rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
    </div>

    <!-- === HEADER === -->
    <nav class="fixed top-0 w-full z-50 transition-all duration-300 backdrop-blur-md border-b border-white/5">
        <div class="max-w-6xl mx-auto px-4 md:px-6 h-20 flex items-center justify-between">
            <a href="#" class="font-display font-bold text-xl md:text-2xl flex items-center gap-2">
                <i class="fa-brands fa-bitcoin text-brand-gold text-2xl md:text-3xl"></i>
                <span class="text-white">CRYPTO<span class="text-brand-primary">HUB</span></span>
            </a>

            <div class="flex items-center gap-3">
                <div id="userSection" class="hidden flex items-center gap-3 bg-white/5 px-2 py-1.5 md:px-3 rounded-full border border-white/10">
                    <img id="imgUser" src="" class="w-7 h-7 md:w-8 md:h-8 rounded-full object-cover">
                    <button onclick="openMyOrders()" class="text-xs md:text-sm font-medium hover:text-brand-primary transition px-1">Kho√° h·ªçc c·ªßa t√¥i</button>
                    <button id="btnLogout" class="text-xs md:text-sm text-red-400 hover:text-white px-1"><i class="fa-solid fa-power-off"></i></button>
                </div>
                
                <button id="btnLogin" class="hidden px-5 py-2 font-bold text-sm text-white bg-white/5 border border-white/10 rounded-full hover:bg-brand-primary transition">
                    ƒêƒÉng nh·∫≠p
                </button>
            </div>
        </div>
    </nav>

    <!-- === MAIN CONTENT === -->
    <main class="relative z-10 pt-32 pb-20 px-4 max-w-5xl mx-auto space-y-20">

        <!-- PROFILE SECTION -->
        <section id="profileSection" class="text-center" data-aos="fade-up">
            <div id="profileLoader" class="loader mt-10"></div>
            <div id="profileContent" class="hidden">
                <div class="relative w-32 h-32 md:w-40 md:h-40 mx-auto mb-6">
                    <img id="pAvatar" src="" class="w-full h-full rounded-full object-cover border-4 border-dark-bg">
                    <!-- Updated Verify Icon -->
                    <i id="pVerified" class="hidden fa-solid fa-circle-check text-blue-500 text-2xl absolute bottom-2 right-2 bg-white rounded-full border-2 border-dark-bg z-20"></i>
                </div>
                <h1 class="font-display text-4xl md:text-6xl font-bold mb-4"><span id="pName" class="text-white"></span></h1>
                <p id="pBio" class="text-gray-400 text-lg md:text-xl max-w-2xl mx-auto font-light"></p>
            </div>
        </section>

        <!-- SOCIAL LINKS -->
        <section id="socialSection" class="flex flex-wrap justify-center gap-4" data-aos="fade-up" data-aos-delay="100"></section>

        <!-- COURSES (HORIZONTAL SCROLL) -->
        <section class="relative">
            <div class="flex items-center gap-4 mb-8">
                <h2 class="font-display text-2xl md:text-3xl font-bold text-white">üî• KH√ìA H·ªåC PREMIUM</h2>
                <div class="h-px bg-white/10 flex-1"></div>
            </div>
            
            <!-- Horizontal Scroll Container -->
            <div id="coursesList" class="flex overflow-x-auto gap-6 pb-8 hide-scrollbar snap-x snap-mandatory">
                <!-- Courses injected via JS -->
            </div>
        </section>

        <!-- PARTNERS -->
        <section>
            <div class="text-center mb-10">
                <h2 class="font-display text-2xl font-bold text-brand-accent">ƒê·ªêI T√ÅC S√ÄN GIAO D·ªäCH</h2>
            </div>
            <div id="exchangeList" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
        </section>

    </main>

    <!-- === FOOTER === -->
    <footer class="border-t border-white/5 py-10 bg-black/50 text-center">
        <p class="font-display font-bold text-xl text-white">CRYPTO HUB</p>
        <p class="text-gray-600 text-sm">¬© 2024 Elite Academy</p>
    </footer>

    <!-- === MODALS === -->

    <!-- 1. CHECKOUT MODAL (Thanh to√°n) -->
    <div id="checkoutModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-2xl rounded-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] overflow-y-auto">
            <!-- Left: Info -->
            <div class="p-6 md:w-1/2 bg-white/5 border-r border-white/5">
                <h3 class="text-xl font-bold text-white mb-4">Th√¥ng tin ƒëƒÉng k√Ω</h3>
                <div class="space-y-4 text-sm">
                    <div><span class="text-gray-400">H·ªçc vi√™n:</span> <span id="chkUser" class="text-white font-bold block"></span></div>
                    <div><span class="text-gray-400">Email:</span> <span id="chkEmail" class="text-white block"></span></div>
                    <div><span class="text-gray-400">Kh√≥a h·ªçc:</span> <span id="chkCourse" class="text-brand-primary font-bold block"></span></div>
                    <div><span class="text-gray-400">Gi√° tr·ªã:</span> <span id="chkPrice" class="text-brand-gold font-bold text-xl block"></span></div>
                </div>
                <hr class="border-white/10 my-6">
                <p class="text-gray-400 text-xs mb-2">Ph∆∞∆°ng th·ª©c thanh to√°n:</p>
                <div class="flex gap-2">
                    <button onclick="selectPayment('BANK')" id="btnMethodBank" class="flex-1 py-2 rounded border border-brand-primary bg-brand-primary/20 text-white font-bold text-xs">Ng√¢n h√†ng (QR)</button>
                    <button onclick="selectPayment('CRYPTO')" id="btnMethodCrypto" class="flex-1 py-2 rounded border border-white/10 hover:bg-white/5 text-gray-400 font-bold text-xs">V√≠ Crypto</button>
                </div>
            </div>
            
            <!-- Right: Payment Action -->
            <div class="p-6 md:w-1/2 flex flex-col relative">
                <button onclick="closeCheckout()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
                
                <!-- BANK VIEW -->
                <div id="payViewBank" class="space-y-4 text-center">
                    <p class="text-sm text-gray-300">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n:</p>
                    <div class="bg-white p-2 rounded-xl inline-block mx-auto">
                        <img id="qrImage" src="" class="w-40 h-40 object-contain">
                    </div>
                    <div class="text-xs text-gray-400">H·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅn n·ªôi dung.<br>Vui l√≤ng kh√¥ng s·ª≠a n·ªôi dung chuy·ªÉn kho·∫£n.</div>
                </div>

                <!-- CRYPTO VIEW -->
                <div id="payViewCrypto" class="hidden space-y-4">
                    <p class="text-sm text-gray-300">Chuy·ªÉn USDT (BEP20) v√†o v√≠:</p>
                    <div class="bg-black/50 p-3 rounded border border-white/10 flex items-center justify-between cursor-pointer" onclick="copyToClipboard('walletAddress')">
                        <div class="truncate text-xs font-mono text-brand-gold w-full mr-2" id="walletAddress">...</div>
                        <i class="fa-regular fa-copy"></i>
                    </div>
                    <p class="text-xs text-red-400">*Vui l√≤ng ki·ªÉm tra k·ªπ m·∫°ng BEP20 (BSC)</p>
                </div>

                <!-- UPLOAD BILL -->
                <div class="mt-auto pt-6 border-t border-white/10">
                    <label class="block text-sm font-bold text-white mb-2">X√°c th·ª±c thanh to√°n</label>
                    <div class="relative">
                        <input type="file" id="billFile" accept="image/*" class="hidden" onchange="previewBill()">
                        <label for="billFile" class="flex items-center justify-center w-full h-12 border border-dashed border-gray-500 rounded-lg cursor-pointer hover:border-brand-primary hover:text-brand-primary transition text-gray-400 text-sm">
                            <i class="fa-solid fa-cloud-arrow-up mr-2"></i> <span id="fileName">T·∫£i ·∫£nh bill chuy·ªÉn kho·∫£n</span>
                        </label>
                    </div>
                    <button id="btnConfirmOrder" onclick="submitOrder()" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        X√°c nh·∫≠n ƒë√£ chuy·ªÉn
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MY COURSES MODAL -->
    <div id="myOrdersModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-3xl rounded-2xl p-6 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Kh√≥a h·ªçc c·ªßa t√¥i</h3>
                <button onclick="document.getElementById('myOrdersModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>
            <div id="myOrdersList" class="flex-1 overflow-y-auto space-y-3 pr-2">
                <!-- Orders injected here -->
            </div>
        </div>
    </div>

    <!-- 3. ADMIN PANEL -->
    <button id="btnOpenAdmin" class="hidden fixed bottom-6 right-6 w-12 h-12 bg-red-600 text-white rounded-full shadow-lg z-40 hover:scale-110 transition flex items-center justify-center">
        <i class="fa-solid fa-gear animate-spin-slow"></i>
    </button>

    <div id="adminPanel" class="fixed inset-0 z-[70] hidden bg-black/95 backdrop-blur-xl transition-all duration-300 overflow-y-auto">
        <div class="max-w-7xl mx-auto p-4 md:p-8 min-h-screen">
            <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
                <h2 class="text-2xl font-display font-bold text-white">Admin Dashboard</h2>
                <button onclick="toggleAdminPanel()" class="text-gray-400 hover:text-white">Tho√°t</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-1">
                    <button onclick="switchTab('tab-orders')" class="adm-btn w-full text-left px-4 py-3 rounded bg-brand-primary text-white font-bold"><i class="fa-solid fa-cart-shopping mr-2"></i> ƒê∆°n h√†ng</button>
                    <button onclick="switchTab('tab-courses')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5"><i class="fa-solid fa-graduation-cap mr-2"></i> Kh√≥a h·ªçc</button>
                    <button onclick="switchTab('tab-exchanges')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5"><i class="fa-solid fa-coins mr-2"></i> ƒê·ªëi t√°c</button>
                    <button onclick="switchTab('tab-profile')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5"><i class="fa-solid fa-user mr-2"></i> Profile</button>
                    <button onclick="switchTab('tab-config')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5"><i class="fa-solid fa-sliders mr-2"></i> C·∫•u h√¨nh</button>
                </div>

                <!-- Content -->
                <div class="lg:col-span-4 glass-panel rounded-xl p-6">
                    
                    <!-- ORDER TAB -->
                    <div id="tab-orders" class="adm-sec">
                        <h3 class="text-xl font-bold mb-4 text-green-400">Qu·∫£n l√Ω ƒê∆°n h√†ng</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-white/5 text-white uppercase text-xs">
                                    <tr>
                                        <th class="p-3">Ng√†y</th>
                                        <th class="p-3">Email</th>
                                        <th class="p-3">Kh√≥a h·ªçc</th>
                                        <th class="p-3">Bill</th>
                                        <th class="p-3">Tr·∫°ng th√°i</th>
                                        <th class="p-3">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="admOrderList" class="divide-y divide-gray-800"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- COURSES TAB -->
                    <div id="tab-courses" class="adm-sec hidden">
                        <h3 class="text-xl font-bold mb-4">Qu·∫£n l√Ω Kh√≥a h·ªçc</h3>
                        <form id="formCourse" class="grid grid-cols-2 gap-4 mb-6 bg-white/5 p-4 rounded">
                            <input type="hidden" id="cId">
                            <input id="cName" placeholder="T√™n kh√≥a" class="bg-black border border-gray-700 p-2 rounded text-white col-span-2">
                            <input id="cPrice" placeholder="Gi√° (500.000ƒë)" class="bg-black border border-gray-700 p-2 rounded text-white">
                            <input id="cGroupLink" placeholder="Link nh√≥m Telegram/Zalo" class="bg-black border border-gray-700 p-2 rounded text-white">
                            <textarea id="cBenefits" placeholder="Quy·ªÅn l·ª£i (c√°ch nhau d·∫•u ph·∫©y)" class="bg-black border border-gray-700 p-2 rounded text-white col-span-2"></textarea>
                            <button type="submit" class="bg-green-600 text-white p-2 rounded font-bold col-span-2">L∆∞u Kh√≥a H·ªçc</button>
                        </form>
                        <div id="admCourseList" class="space-y-2"></div>
                    </div>

                    <!-- CONFIG TAB -->
                    <div id="tab-config" class="adm-sec hidden">
                        <h3 class="text-xl font-bold mb-4 text-brand-gold">C·∫•u h√¨nh H·ªá th·ªëng</h3>
                        
                        <div class="mb-6">
                            <h4 class="text-white font-bold mb-2 border-b border-gray-700 pb-1">1. GitHub Image Upload (API Kay)</h4>
                            <p class="text-xs text-gray-500 mb-2">D√πng ƒë·ªÉ l∆∞u ·∫£nh bill kh√°ch h√†ng t·∫£i l√™n.</p>
                            <div class="grid md:grid-cols-2 gap-4">
                                <input id="cfgGhToken" type="password" placeholder="GitHub Personal Access Token (Starts with ghp_)" class="bg-black border border-gray-700 p-2 rounded text-white w-full">
                                <input id="cfgGhUser" placeholder="GitHub Username (Owner)" class="bg-black border border-gray-700 p-2 rounded text-white w-full">
                                <input id="cfgGhRepo" placeholder="Repository Name" class="bg-black border border-gray-700 p-2 rounded text-white w-full">
                                <input id="cfgGhPath" placeholder="Path (vd: bills)" class="bg-black border border-gray-700 p-2 rounded text-white w-full">
                            </div>
                        </div>

                        <div class="mb-6">
                            <h4 class="text-white font-bold mb-2 border-b border-gray-700 pb-1">2. Ng√¢n h√†ng & VietQR</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <input id="cfgBankCode" placeholder="M√£ Ng√¢n h√†ng (VD: MB, VCB)" class="bg-black border border-gray-700 p-2 rounded text-white">
                                <input id="cfgBankNum" placeholder="S·ªë t√†i kho·∫£n" class="bg-black border border-gray-700 p-2 rounded text-white">
                                <input id="cfgBankName" placeholder="T√™n ch·ªß t√†i kho·∫£n" class="bg-black border border-gray-700 p-2 rounded text-white">
                                <input id="cfgBankTemplate" placeholder="Template QR (vd: compact2)" class="bg-black border border-gray-700 p-2 rounded text-white">
                            </div>
                        </div>

                        <div class="mb-6">
                            <h4 class="text-white font-bold mb-2 border-b border-gray-700 pb-1">3. V√≠ Crypto</h4>
                            <input id="cfgWallet" placeholder="ƒê·ªãa ch·ªâ v√≠ USDT (BEP20)" class="bg-black border border-gray-700 p-2 rounded text-white w-full font-mono">
                        </div>

                        <div class="mb-6">
                            <h4 class="text-white font-bold mb-2 border-b border-gray-700 pb-1">4. Qu·∫£n tr·ªã vi√™n</h4>
                            <textarea id="cfgAdmins" placeholder="Danh s√°ch email admin (c√°ch nhau d·∫•u ph·∫©y)" class="bg-black border border-gray-700 p-2 rounded text-white w-full h-20"></textarea>
                        </div>

                        <button onclick="saveConfig()" class="w-full bg-brand-primary hover:bg-indigo-600 text-white py-3 rounded font-bold shadow-lg">L∆∞u To√†n B·ªô C·∫•u H√¨nh</button>
                    </div>

                    <!-- OTHER TABS (Placeholder) -->
                    <div id="tab-exchanges" class="adm-sec hidden"><div id="admExchList"></div> <!-- Logic t∆∞∆°ng t·ª± courses --></div>
                    <div id="tab-profile" class="adm-sec hidden">
                        <form id="formProfileAdm" class="space-y-4">
                            <input id="admPName" class="w-full bg-black border border-gray-700 p-2 text-white rounded" placeholder="T√™n hi·ªÉn th·ªã">
                            <textarea id="admPBio" class="w-full bg-black border border-gray-700 p-2 text-white rounded" placeholder="Ti·ªÉu s·ª≠"></textarea>
                            <input id="admPAvatar" class="w-full bg-black border border-gray-700 p-2 text-white rounded" placeholder="Link Avatar">
                            <button onclick="saveProfile()" type="button" class="bg-blue-600 text-white px-4 py-2 rounded">C·∫≠p nh·∫≠t Profile</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let globalConfig = {}; // Stores bank info, github tokens etc.

        // --- UTILS ---
        const toast = (msg, type = "success") => Toastify({ text: msg, duration: 3000, style: { background: type === "success" ? "#10B981" : "#EF4444" } }).showToast();
        const el = (id) => document.getElementById(id);

        // --- AUTH & LOAD ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                el('btnLogin').classList.add('hidden');
                el('userSection').classList.remove('hidden');
                el('userSection').classList.add('flex');
                el('imgUser').src = user.photoURL;
                
                // Check Admin Access from DB
                await checkAdmin(user.email);
            } else {
                el('btnLogin').classList.remove('hidden');
                el('userSection').classList.add('hidden');
                el('btnOpenAdmin').classList.add('hidden');
            }
        });

        el('btnLogin').onclick = () => signInWithPopup(auth, provider).catch(e => toast(e.message, "error"));
        el('btnLogout').onclick = () => signOut(auth);

        async function loadSite() {
            // Load Config First
            const cfgSnap = await getDoc(doc(db, "settings", "config"));
            if (cfgSnap.exists()) globalConfig = cfgSnap.data();

            // Load Profile
            const pSnap = await getDoc(doc(db, "site_content", "profile"));
            el('profileLoader').classList.add('hidden');
            el('profileContent').classList.remove('hidden');
            if (pSnap.exists()) {
                const d = pSnap.data();
                el('pName').innerText = d.name;
                el('pBio').innerHTML = d.bio.replace(/\n/g, "<br>");
                el('pAvatar').src = d.avatar;
                if(d.verified) el('pVerified').classList.remove('hidden');
                
                // Fill Admin Profile Form
                el('admPName').value = d.name;
                el('admPBio').value = d.bio;
                el('admPAvatar').value = d.avatar;
            }

            // Load Courses
            const cSnap = await getDocs(collection(db, "courses"));
            el('coursesList').innerHTML = '';
            cSnap.forEach(doc => {
                const c = doc.data();
                const isVip = c.price.includes('tri·ªáu') || c.price.includes('$');
                el('coursesList').innerHTML += `
                    <div class="glass-card min-w-[300px] md:min-w-[350px] rounded-3xl p-6 md:p-8 snap-center flex flex-col justify-between border ${isVip ? 'border-brand-primary/30' : 'border-white/10'}">
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-white/10 text-xs font-bold px-3 py-1 rounded-full text-white">${c.name}</span>
                                ${isVip ? '<i class="fa-solid fa-crown text-brand-gold text-xl"></i>' : ''}
                            </div>
                            <div class="text-3xl font-display font-bold text-white mb-4">${c.price}</div>
                            <ul class="space-y-2 mb-6 text-sm text-gray-400">
                                ${(c.benefits || '').split(',').map(b => `<li><i class="fa-solid fa-check text-green-500 mr-2"></i>${b}</li>`).join('')}
                            </ul>
                        </div>
                        <button onclick="initCheckout('${doc.id}', '${c.name}', '${c.price}')" class="w-full py-3 rounded-xl bg-gradient-to-r from-brand-primary to-blue-600 text-white font-bold hover:shadow-lg hover:shadow-blue-500/30 transition">ƒêƒÉng K√Ω Ngay</button>
                    </div>
                `;
            });

            // Load Socials (Mockup for simplicity, can be fetched)
            // ... (Code Socials t∆∞∆°ng t·ª± version tr∆∞·ªõc) ...

            // Load Exchange (Partner)
             const exSnap = await getDocs(collection(db, "exchanges"));
             el('exchangeList').innerHTML = '';
             exSnap.forEach(doc => {
                 const e = doc.data();
                 el('exchangeList').innerHTML += `
                    <a href="${e.link}" target="_blank" class="glass-panel p-4 rounded-xl flex items-center gap-3 hover:bg-white/10 transition">
                        <img src="${e.img || 'https://via.placeholder.com/40'}" class="w-10 h-10 object-contain bg-white rounded-lg p-1">
                        <div>
                            <div class="font-bold text-sm text-white">${e.name}</div>
                            <div class="text-xs text-brand-accent">Ho√†n ph√≠ ${e.rate}</div>
                        </div>
                    </a>
                 `;
             });
        }

        // --- CHECKOUT & ORDERS ---
        let currentOrder = {};

        window.initCheckout = (id, name, price) => {
            if (!currentUser) return toast("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng k√Ω!", "error");
            currentOrder = { id, name, price, method: 'BANK' };
            
            el('chkUser').innerText = currentUser.displayName;
            el('chkEmail').innerText = currentUser.email;
            el('chkCourse').innerText = name;
            el('chkPrice').innerText = price;
            
            el('checkoutModal').classList.remove('hidden');
            selectPayment('BANK');
        };

        window.selectPayment = (method) => {
            currentOrder.method = method;
            const btnBank = el('btnMethodBank');
            const btnCrypto = el('btnMethodCrypto');
            const viewBank = el('payViewBank');
            const viewCrypto = el('payViewCrypto');

            if (method === 'BANK') {
                btnBank.classList.replace('border-white/10', 'border-brand-primary');
                btnBank.classList.replace('text-gray-400', 'text-white');
                btnBank.classList.add('bg-brand-primary/20');
                btnCrypto.classList.remove('border-brand-primary', 'text-white', 'bg-brand-primary/20');
                btnCrypto.classList.add('border-white/10', 'text-gray-400');
                
                viewBank.classList.remove('hidden');
                viewCrypto.classList.add('hidden');

                // Generate VietQR
                // Clean price string to number for VietQR (if needed, but text is okay for addInfo)
                const amountClean = currentOrder.price.replace(/\D/g, ''); 
                // Note: VietQR api usually takes amount as number. If price is text like "500 USD", we might need fixed amount or manual input. 
                // Assuming price is VND number for QR, if USD maybe set amount=0 for manual entry.
                const amountVal = amountClean.length > 3 ? amountClean : 0; 
                
                const content = `${currentUser.email.split('@')[0]} ${currentOrder.name.substring(0,10)}`;
                const qrUrl = `https://img.vietqr.io/image/${globalConfig.bankCode}-${globalConfig.bankNum}-${globalConfig.bankTemplate || 'compact'}.jpg?amount=${amountVal}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(globalConfig.bankName)}`;
                el('qrImage').src = qrUrl;

            } else {
                btnCrypto.classList.replace('border-white/10', 'border-brand-primary');
                btnCrypto.classList.replace('text-gray-400', 'text-white');
                btnCrypto.classList.add('bg-brand-primary/20');
                btnBank.classList.remove('border-brand-primary', 'text-white', 'bg-brand-primary/20');
                btnBank.classList.add('border-white/10', 'text-gray-400');

                viewBank.classList.add('hidden');
                viewCrypto.classList.remove('hidden');
                el('walletAddress').innerText = globalConfig.wallet || "Ch∆∞a c·∫•u h√¨nh v√≠";
            }
        };

        window.closeCheckout = () => el('checkoutModal').classList.add('hidden');

        // GITHUB IMAGE UPLOAD
        window.previewBill = () => {
            const file = el('billFile').files[0];
            if(file) el('fileName').innerText = file.name;
        }

        window.submitOrder = async () => {
            const file = el('billFile').files[0];
            if (!file) return toast("Vui l√≤ng t·∫£i ·∫£nh bill l√™n!", "error");

            const btn = el('btnConfirmOrder');
            btn.disabled = true;
            btn.innerText = "ƒêang x·ª≠ l√Ω...";

            try {
                // 1. Upload to GitHub
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64Content = reader.result.split(',')[1];
                    const fileName = `${Date.now()}_${currentUser.uid.substring(0,5)}.jpg`;
                    const path = globalConfig.ghPath ? `${globalConfig.ghPath}/${fileName}` : fileName;
                    
                    const ghRes = await fetch(`https://api.github.com/repos/${globalConfig.ghUser}/${globalConfig.ghRepo}/contents/${path}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${globalConfig.ghToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Bill upload for ${currentUser.email}`,
                            content: base64Content
                        })
                    });

                    if (!ghRes.ok) throw new Error("L·ªói upload ·∫£nh (Ki·ªÉm tra Config GitHub)");
                    const ghData = await ghRes.json();
                    const billUrl = ghData.content.download_url; // Direct link

                    // 2. Save Order to Firebase
                    await addDoc(collection(db, "orders"), {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        courseName: currentOrder.name,
                        courseId: currentOrder.id,
                        price: currentOrder.price,
                        billUrl: billUrl,
                        paymentMethod: currentOrder.method,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });

                    toast("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ch·ªù duy·ªát.");
                    closeCheckout();
                    btn.disabled = false;
                    btn.innerText = "X√°c nh·∫≠n ƒë√£ chuy·ªÉn";
                }
            } catch (error) {
                console.error(error);
                toast("L·ªói: " + error.message, "error");
                btn.disabled = false;
                btn.innerText = "X√°c nh·∫≠n ƒë√£ chuy·ªÉn";
            }
        };

        // USER ORDERS
        window.openMyOrders = async () => {
            if(!currentUser) return;
            el('myOrdersModal').classList.remove('hidden');
            const q = query(collection(db, "orders"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            const list = el('myOrdersList');
            list.innerHTML = '';
            
            if(snap.empty) {
                list.innerHTML = '<p class="text-gray-400 text-center mt-10">B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o.</p>';
                return;
            }

            snap.forEach(d => {
                const o = d.data();
                let statusBadge = '';
                let actionBtn = '';

                if(o.status === 'pending') {
                    statusBadge = '<span class="text-yellow-400 bg-yellow-400/10 px-2 py-1 rounded text-xs">ƒêang ch·ªù duy·ªát</span>';
                    actionBtn = '<button disabled class="text-gray-500 text-sm cursor-not-allowed">ƒêang x·ª≠ l√Ω...</button>';
                } else if (o.status === 'approved') {
                    statusBadge = '<span class="text-green-400 bg-green-400/10 px-2 py-1 rounded text-xs">ƒê√£ x√°c th·ª±c</span>';
                    // Fetch link group from course details if needed, or store in order when approved
                    actionBtn = `<a href="${o.groupLink || '#'}" target="_blank" class="bg-brand-primary hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/30">V√†o Nh√≥m Ngay</a>`;
                }

                list.innerHTML += `
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-white text-lg">${o.courseName}</div>
                            <div class="text-sm text-gray-400 mt-1">${o.price} ‚Ä¢ ${new Date(o.createdAt).toLocaleDateString()}</div>
                            <div class="mt-2">${statusBadge}</div>
                        </div>
                        <div>${actionBtn}</div>
                    </div>
                `;
            });
        };

        // --- ADMIN LOGIC ---
        async function checkAdmin(email) {
            // Check against Global Config loaded from Firestore
            if (!globalConfig.admins) {
                // First run fallback or wait for config load
                const cfg = await getDoc(doc(db, "settings", "config"));
                if(cfg.exists()) globalConfig = cfg.data();
            }
            
            const adminList = globalConfig.admins ? globalConfig.admins.split(',').map(e => e.trim()) : [];
            if (adminList.includes(email)) {
                el('btnOpenAdmin').classList.remove('hidden');
            }
        }

        window.toggleAdminPanel = () => {
            const p = el('adminPanel');
            if (p.classList.contains('hidden')) {
                p.classList.remove('hidden');
                loadAdminData();
            } else {
                p.classList.add('hidden');
            }
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.adm-sec').forEach(d => d.classList.add('hidden'));
            el(tabId).classList.remove('hidden');
            
            document.querySelectorAll('.adm-btn').forEach(b => {
                b.classList.remove('bg-brand-primary', 'text-white', 'font-bold');
                b.classList.add('text-gray-400');
            });
            event.currentTarget.classList.remove('text-gray-400');
            event.currentTarget.classList.add('bg-brand-primary', 'text-white', 'font-bold');
        };

        async function loadAdminData() {
            // Load Orders
            const oSnap = await getDocs(query(collection(db, "orders"), orderBy("createdAt", "desc")));
            const oList = el('admOrderList');
            oList.innerHTML = '';
            oSnap.forEach(d => {
                const o = d.data();
                oList.innerHTML += `
                    <tr class="hover:bg-white/5 transition border-b border-gray-800">
                        <td class="p-3 text-xs">${new Date(o.createdAt).toLocaleDateString()}</td>
                        <td class="p-3 font-bold text-white">${o.email}</td>
                        <td class="p-3 text-brand-primary">${o.courseName}</td>
                        <td class="p-3"><a href="${o.billUrl}" target="_blank" class="text-blue-400 hover:underline text-xs">Xem Bill</a></td>
                        <td class="p-3">
                            <span class="${o.status === 'approved' ? 'text-green-500' : 'text-yellow-500'} font-bold text-xs uppercase">${o.status}</span>
                        </td>
                        <td class="p-3">
                            ${o.status === 'pending' ? `<button onclick="approveOrder('${d.id}')" class="bg-green-600 hover:bg-green-500 text-white px-2 py-1 rounded text-xs">Duy·ªát</button>` : '<i class="fa-solid fa-check text-green-500"></i>'}
                        </td>
                    </tr>
                `;
            });

            // Load Config to Inputs
            if(globalConfig) {
                el('cfgGhToken').value = globalConfig.ghToken || '';
                el('cfgGhUser').value = globalConfig.ghUser || '';
                el('cfgGhRepo').value = globalConfig.ghRepo || '';
                el('cfgGhPath').value = globalConfig.ghPath || '';
                el('cfgBankCode').value = globalConfig.bankCode || '';
                el('cfgBankNum').value = globalConfig.bankNum || '';
                el('cfgBankName').value = globalConfig.bankName || '';
                el('cfgBankTemplate').value = globalConfig.bankTemplate || '';
                el('cfgWallet').value = globalConfig.wallet || '';
                el('cfgAdmins').value = globalConfig.admins || '';
            }
            
            // Render Courses List (Simplified)
            const cSnap = await getDocs(collection(db, "courses"));
            el('admCourseList').innerHTML = '';
            cSnap.forEach(d => {
                el('admCourseList').innerHTML += `<div class="bg-white/5 p-2 rounded flex justify-between border border-white/10"><span class="text-white">${d.data().name}</span> <button onclick="deleteDocItem('courses','${d.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`;
            });
        }

        window.approveOrder = async (orderId) => {
            // Prompt for group link or get from course settings (here prompting for simplicity)
            // Or better: fetch the course document to get the group link
            const orderRef = doc(db, "orders", orderId);
            const orderSnap = await getDoc(orderRef);
            const orderData = orderSnap.data();
            
            // Get Course Link
            const courseRef = doc(db, "courses", orderData.courseId);
            const courseSnap = await getDoc(courseRef);
            const groupLink = courseSnap.exists() ? courseSnap.data().groupLink : "#";

            await updateDoc(orderRef, { status: 'approved', groupLink: groupLink });
            toast("ƒê√£ duy·ªát ƒë∆°n h√†ng!");
            loadAdminData();
        };

        window.saveConfig = async () => {
            const cfg = {
                ghToken: el('cfgGhToken').value,
                ghUser: el('cfgGhUser').value,
                ghRepo: el('cfgGhRepo').value,
                ghPath: el('cfgGhPath').value,
                bankCode: el('cfgBankCode').value,
                bankNum: el('cfgBankNum').value,
                bankName: el('cfgBankName').value,
                bankTemplate: el('cfgBankTemplate').value,
                wallet: el('cfgWallet').value,
                admins: el('cfgAdmins').value
            };
            await setDoc(doc(db, "settings", "config"), cfg);
            globalConfig = cfg;
            toast("C·∫•u h√¨nh ƒë√£ l∆∞u! Reload ƒë·ªÉ c·∫≠p nh·∫≠t.");
            setTimeout(() => location.reload(), 1500);
        };
        
        window.saveProfile = async () => {
            await setDoc(doc(db, "site_content", "profile"), {
                name: el('admPName').value,
                bio: el('admPBio').value,
                avatar: el('admPAvatar').value,
                verified: true
            });
            toast("ƒê√£ c·∫≠p nh·∫≠t Profile");
        }

        // COURSES CRUD
        el('formCourse').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: el('cName').value,
                price: el('cPrice').value,
                groupLink: el('cGroupLink').value,
                benefits: el('cBenefits').value
            };
            await addDoc(collection(db, "courses"), data);
            toast("Th√™m kh√≥a h·ªçc th√†nh c√¥ng");
            el('formCourse').reset();
            loadAdminData();
        });
        
        window.deleteDocItem = async (col, id) => {
            if(confirm("X√≥a m·ª•c n√†y?")) {
                await deleteDoc(doc(db, col, id));
                loadAdminData();
            }
        }

        // INIT
        AOS.init();
        loadSite();
        
        // Expose copy function
        window.copyToClipboard = (id) => {
            navigator.clipboard.writeText(el(id).innerText);
            toast("ƒê√£ copy!");
        }

    </script>
</body>
</html>
