<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Elite Academy - Premium</title>
    
    <!-- 1. THƯ VIỆN UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- 2. CONFIG TAILWIND & CUSTOM CSS -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        brand: { primary: '#6366f1', secondary: '#ec4899', accent: '#14b8a6', gold: '#fbbf24' }
                    },
                    animation: { 'blob': 'blob 7s infinite', 'spin-slow': 'spin 12s linear infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #ffffff; overflow-x: hidden; }
        .bg-mesh {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 25%),
                        radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 25%);
        }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Horizontal Scroll for Courses */
        .scrolling-wrapper {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
            gap: 20px;
        }
        .scrolling-wrapper::-webkit-scrollbar { height: 8px; }
        .scrolling-wrapper::-webkit-scrollbar-track { background: #050505; }
        .scrolling-wrapper::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .card-item { flex: 0 0 85%; max-width: 400px; } 
        @media (min-width: 768px) { .card-item { flex: 0 0 45%; } }
        
        /* Loading Spinner */
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #6366f1; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .verified-badge { color: #3b82f6; background: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; }
    </style>
</head>
<body class="antialiased">

    <div class="bg-mesh"></div>
    <!-- Moving Blobs -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-0 -left-4 w-72 h-72 bg-brand-primary rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute bottom-0 -right-4 w-72 h-72 bg-brand-secondary rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
    </div>

    <!-- === HEADER === -->
    <nav class="fixed top-0 w-full z-50 backdrop-blur-md border-b border-white/5 bg-black/50">
        <div class="max-w-6xl mx-auto px-6 h-20 flex items-center justify-between">
            <a href="#" class="font-display font-bold text-2xl flex items-center gap-2">
                <i class="fa-brands fa-bitcoin text-brand-gold text-3xl"></i>
                <span class="text-white hidden sm:block">CRYPTO<span class="text-brand-primary">HUB</span></span>
            </a>

            <div class="flex items-center gap-4">
                <div id="userSection" class="hidden flex items-center gap-3 bg-white/5 px-3 py-1.5 rounded-full border border-white/10 cursor-pointer" onclick="openMyCourses()">
                    <img id="imgUser" src="" class="w-8 h-8 rounded-full object-cover">
                    <span id="userNameDisplay" class="text-sm font-medium hidden sm:block"></span>
                    <span class="text-xs bg-brand-primary px-2 py-0.5 rounded text-white ml-1">My Courses</span>
                </div>
                
                <button id="btnLogin" class="px-5 py-2 text-sm font-bold text-white bg-white/10 border border-white/10 rounded-full hover:bg-brand-primary transition">
                    <i class="fa-solid fa-wallet mr-2"></i> <span id="authText">Login</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- === MAIN CONTENT === -->
    <main class="relative z-10 pt-32 pb-20 px-4 max-w-6xl mx-auto space-y-24">

        <!-- 1. PROFILE -->
        <section id="profileSection" class="text-center relative" data-aos="fade-up">
            <div id="profileLoader" class="loader mt-10 mx-auto"></div>
            <div id="profileContent" class="hidden">
                <div class="relative w-32 h-32 md:w-40 md:h-40 mx-auto mb-6">
                    <img id="pAvatar" src="" class="w-full h-full rounded-full object-cover border-4 border-dark-bg p-1 bg-gradient-to-tr from-brand-primary to-brand-secondary">
                    <div id="pVerified" class="absolute bottom-2 right-2 bg-white text-blue-600 rounded-full w-8 h-8 flex items-center justify-center border-4 border-[#050505] hidden">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>
                <h1 class="font-display text-4xl md:text-5xl font-bold mb-4"><span id="pName" class="text-white"></span></h1>
                <p id="pBio" class="text-gray-400 text-lg max-w-2xl mx-auto font-light"></p>
            </div>
        </section>

        <!-- 2. SOCIALS -->
        <section id="socialSection" class="flex flex-wrap justify-center gap-4" data-aos="fade-up"></section>

        <!-- 3. COURSES (Horizontal Scroll) -->
        <section>
            <div class="flex items-center gap-4 mb-8" data-aos="fade-right">
                <div class="h-8 w-1 bg-brand-primary rounded-full"></div>
                <h2 class="font-display text-2xl md:text-3xl font-bold text-white">KHÓA HỌC CHUYÊN SÂU</h2>
            </div>

            <!-- Scroll Container -->
            <div id="coursesList" class="scrolling-wrapper pb-10">
                <!-- Courses injected via JS -->
            </div>
        </section>

        <!-- 4. PARTNERS -->
        <section>
            <div class="text-center mb-10" data-aos="fade-up">
                <h2 class="font-display text-2xl font-bold text-brand-accent">ĐỐI TÁC SÀN GIAO DỊCH</h2>
                <p class="text-gray-500 text-sm mt-2">Đăng ký qua link để nhận hoàn phí giao dịch trọn đời</p>
            </div>
            <div id="exchangeList" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </section>

    </main>

    <!-- === FOOTER === -->
    <footer class="border-t border-white/5 py-10 bg-black/50 backdrop-blur-lg text-center text-gray-500 text-sm">
        <p>&copy; 2026 Crypto Elite Academy. All rights reserved.</p>
    </footer>

    <!-- === MODALS === -->

    <!-- 1. BUY MODAL (Registration Flow) -->
    <div id="buyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm transition-opacity">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-0 overflow-hidden relative transform transition-all scale-100">
            <!-- Header -->
            <div class="p-5 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="font-display text-lg font-bold text-white">Xác nhận đăng ký</h3>
                <button onclick="closeModal('buyModal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>
            
            <div class="p-6 max-h-[80vh] overflow-y-auto" id="buyModalContent">
                <!-- Step 1: Info -->
                <div class="mb-6">
                    <p class="text-gray-400 text-sm">Khóa học:</p>
                    <h4 id="buyCourseName" class="text-xl font-bold text-brand-primary"></h4>
                    <p id="buyCoursePrice" class="text-white font-bold text-lg mt-1"></p>
                </div>

                <!-- Step 2: Payment Method -->
                <div class="space-y-4 mb-6">
                    <label class="text-sm text-gray-400 uppercase font-bold">Phương thức thanh toán</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectPayment('bank')" id="btnPayBank" class="p-3 rounded-xl border border-white/10 bg-white/5 hover:border-brand-primary transition text-left">
                            <i class="fa-solid fa-building-columns text-green-400 mb-2"></i>
                            <div class="font-bold text-sm">Ngân hàng</div>
                            <div class="text-xs text-gray-500">Quét mã QR</div>
                        </button>
                        <button onclick="selectPayment('crypto')" id="btnPayCrypto" class="p-3 rounded-xl border border-white/10 bg-white/5 hover:border-brand-primary transition text-left">
                            <i class="fa-brands fa-bitcoin text-brand-gold mb-2"></i>
                            <div class="font-bold text-sm">Tiền điện tử</div>
                            <div class="text-xs text-gray-500">USDT (BEP20)</div>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Dynamic Content (QR or Wallet) -->
                <div id="paymentDetails" class="hidden mb-6 bg-black/40 p-4 rounded-xl border border-white/10">
                    <!-- Bank QR -->
                    <div id="bankInfoArea" class="hidden text-center">
                        <p class="text-sm text-yellow-400 mb-2 font-bold"><i class="fa-solid fa-triangle-exclamation"></i> Vui lòng chuyển khoản đúng nội dung bên dưới</p>
                        <img id="vietQrImg" src="" class="w-48 mx-auto rounded-lg mb-3 border-4 border-white">
                        <div class="text-left bg-white/5 p-3 rounded text-sm space-y-2">
                            <div class="flex justify-between"><span>Ngân hàng:</span> <span id="dispBankName" class="font-bold"></span></div>
                            <div class="flex justify-between"><span>Số TK:</span> <span id="dispBankNum" class="font-mono"></span></div>
                            <div class="flex justify-between"><span>Chủ TK:</span> <span id="dispBankOwner" class="font-bold"></span></div>
                            <div class="flex justify-between items-center pt-2 border-t border-white/10">
                                <span>Nội dung CK:</span> 
                                <span id="dispContent" class="font-mono text-brand-primary font-bold"></span>
                                <i class="fa-regular fa-copy cursor-pointer ml-2" onclick="copyText('dispContent')"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Crypto Wallet -->
                    <div id="cryptoInfoArea" class="hidden">
                        <div class="mb-3">
                            <label class="text-xs text-gray-400">Địa chỉ ví (USDT BEP20)</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input id="dispWallet" readonly class="w-full bg-black border border-gray-700 p-2 rounded text-xs text-white font-mono">
                                <button onclick="copyText('dispWallet')" class="bg-gray-700 p-2 rounded text-white"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>
                        <p class="text-xs text-red-400">*Vui lòng chuyển đúng mạng BEP20 (BNB Smart Chain)</p>
                    </div>
                </div>

                <!-- Step 4: Verification -->
                <div id="verifyStep" class="hidden space-y-4 border-t border-white/10 pt-4">
                    <label class="text-sm font-bold text-white">Xác thực thanh toán (Bắt buộc)</label>
                    <p class="text-xs text-gray-400">Tải lên ảnh chụp màn hình giao dịch thành công.</p>
                    
                    <input type="file" id="billFile" accept="image/*" class="hidden" onchange="previewBill()">
                    <label for="billFile" class="block w-full h-32 border-2 border-dashed border-gray-600 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-brand-primary transition bg-white/5">
                        <i class="fa-solid fa-cloud-arrow-up text-2xl mb-2 text-gray-400"></i>
                        <span class="text-xs text-gray-400">Nhấn để chọn ảnh</span>
                        <img id="billPreview" class="hidden h-full w-full object-contain rounded-xl absolute inset-0 bg-black">
                    </label>

                    <button onclick="submitOrder()" id="btnSubmitOrder" class="w-full bg-brand-primary hover:bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-500/30 transition flex justify-center items-center gap-2">
                        <span>Hoàn tất đăng ký</span> <i class="fa-solid fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MY COURSES MODAL -->
    <div id="myCoursesModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-2xl rounded-2xl p-6 relative h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-display text-2xl font-bold text-white">Khóa học của tôi</h3>
                <button onclick="closeModal('myCoursesModal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="myCoursesList" class="flex-1 overflow-y-auto space-y-4">
                <!-- Orders injected here -->
                <p class="text-gray-500 text-center mt-10">Đang tải dữ liệu...</p>
            </div>
        </div>
    </div>

    <!-- 3. ADMIN PANEL -->
    <button id="btnOpenAdmin" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-red-600 text-white rounded-full shadow-lg z-40 hover:scale-110 transition flex items-center justify-center">
        <i class="fa-solid fa-shield-halved fa-xl"></i>
    </button>

    <div id="adminPanel" class="fixed inset-0 z-[70] hidden bg-[#0a0a0a] overflow-y-auto transition-transform duration-300 translate-y-full">
        <div class="max-w-7xl mx-auto p-4 md:p-8">
            <!-- Admin Header -->
            <div class="flex justify-between items-center mb-8 sticky top-0 bg-[#0a0a0a] py-4 z-10 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i class="fa-solid fa-user-secret text-red-500"></i> Admin Panel</h2>
                <div class="flex gap-3">
                     <button onclick="saveGithubConfig()" class="text-xs bg-gray-800 px-3 py-2 rounded text-blue-400 border border-blue-900">Config Github</button>
                    <button onclick="toggleAdmin()" class="bg-gray-800 text-white px-4 py-2 rounded border border-gray-700">Close</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-2">
                    <button onclick="showTab('adminOrders')" class="w-full text-left p-3 rounded-lg bg-white/5 text-white border border-brand-primary hover:bg-white/10">Đơn hàng <span id="badgeOrders" class="ml-2 bg-red-500 text-xs px-1.5 rounded-full">0</span></button>
                    <button onclick="showTab('adminCourses')" class="w-full text-left p-3 rounded-lg text-gray-400 hover:bg-white/5">Khóa học</button>
                    <button onclick="showTab('adminConfig')" class="w-full text-left p-3 rounded-lg text-gray-400 hover:bg-white/5">Cấu hình Website</button>
                </div>

                <!-- Content -->
                <div class="lg:col-span-4 glass-panel rounded-xl p-6 min-h-[60vh]">
                    
                    <!-- TAB: ORDERS -->
                    <div id="adminOrders" class="admin-tab">
                        <h3 class="text-xl font-bold mb-4">Quản lý Đơn hàng</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-400">
                                <thead class="text-xs uppercase bg-white/5 text-gray-200">
                                    <tr>
                                        <th class="px-4 py-3">Time</th>
                                        <th class="px-4 py-3">User</th>
                                        <th class="px-4 py-3">Khóa học</th>
                                        <th class="px-4 py-3">Bill</th>
                                        <th class="px-4 py-3">Status</th>
                                        <th class="px-4 py-3">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="orderTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB: COURSES -->
                    <div id="adminCourses" class="admin-tab hidden">
                        <h3 class="text-xl font-bold mb-4">Danh sách Khóa học</h3>
                        <form id="courseForm" class="grid gap-4 md:grid-cols-2 mb-6 bg-white/5 p-4 rounded-lg">
                            <input type="hidden" id="cId">
                            <input id="cName" placeholder="Tên khóa" class="bg-black border border-gray-700 p-2 rounded text-white">
                            <input id="cPrice" placeholder="Giá (VND/USD)" class="bg-black border border-gray-700 p-2 rounded text-white">
                            <input id="cPriceVal" type="number" placeholder="Giá trị số (để tính QR)" class="bg-black border border-gray-700 p-2 rounded text-white">
                            <input id="cGroupLink" placeholder="Link nhóm Telegram/Zalo" class="bg-black border border-gray-700 p-2 rounded text-white">
                            <textarea id="cDesc" placeholder="Mô tả" class="bg-black border border-gray-700 p-2 rounded text-white col-span-2"></textarea>
                            <button type="submit" class="col-span-2 bg-green-600 p-2 rounded text-white font-bold">Lưu Khóa Học</button>
                        </form>
                        <div id="adminCourseList" class="space-y-2"></div>
                    </div>

                    <!-- TAB: CONFIG -->
                    <div id="adminConfig" class="admin-tab hidden space-y-6">
                        <!-- Github Config -->
                        <div class="bg-white/5 p-4 rounded-lg border border-red-900/30">
                            <h4 class="font-bold text-red-400 mb-2"><i class="fa-brands fa-github"></i> GitHub API (Upload ảnh)</h4>
                            <p class="text-xs text-gray-500 mb-2">Lưu ý: Token sẽ được sử dụng trực tiếp ở frontend. Hãy giới hạn quyền token.</p>
                            <div class="grid gap-3">
                                <input id="ghToken" type="password" placeholder="GitHub Token (ghp_...)" class="bg-black border border-gray-700 p-2 rounded text-white">
                                <input id="ghOwner" placeholder="GitHub Username" class="bg-black border border-gray-700 p-2 rounded text-white">
                                <input id="ghRepo" placeholder="Repository Name" class="bg-black border border-gray-700 p-2 rounded text-white">
                            </div>
                        </div>

                        <!-- Bank Config -->
                        <div class="bg-white/5 p-4 rounded-lg">
                            <h4 class="font-bold text-green-400 mb-2">Tài khoản Ngân hàng (VietQR)</h4>
                            <div class="grid gap-3">
                                <select id="cfgBankCode" class="bg-black border border-gray-700 p-2 rounded text-white">
                                    <option value="MB">MB Bank</option>
                                    <option value="VCB">Vietcombank</option>
                                    <option value="TCB">Techcombank</option>
                                    <option value="ICB">Vietinbank</option>
                                    <option value="ACB">ACB</option>
                                </select>
                                <input id="cfgBankNum" placeholder="Số tài khoản" class="bg-black border border-gray-700 p-2 rounded text-white">
                                <input id="cfgBankOwner" placeholder="Tên chủ tài khoản (Viết hoa không dấu)" class="bg-black border border-gray-700 p-2 rounded text-white">
                            </div>
                        </div>

                        <!-- Wallet Config -->
                        <div class="bg-white/5 p-4 rounded-lg">
                            <h4 class="font-bold text-yellow-400 mb-2">Ví Crypto (USDT)</h4>
                            <input id="cfgWallet" placeholder="Địa chỉ ví BEP20" class="w-full bg-black border border-gray-700 p-2 rounded text-white font-mono">
                        </div>

                        <!-- Profile Info -->
                        <div class="bg-white/5 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-400 mb-2">Thông tin cá nhân</h4>
                            <input id="cfgName" placeholder="Tên hiển thị" class="w-full bg-black border border-gray-700 p-2 rounded text-white mb-2">
                            <textarea id="cfgBio" placeholder="Tiểu sử" class="w-full bg-black border border-gray-700 p-2 rounded text-white mb-2"></textarea>
                            <div class="flex gap-2">
                                <label class="text-white text-sm">Avatar:</label>
                                <input type="file" id="cfgAvatarFile" class="text-xs text-gray-400">
                            </div>
                        </div>

                        <button onclick="saveAllConfig()" class="w-full bg-brand-primary py-3 rounded font-bold text-white">Lưu Tất Cả Cấu Hình</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- 3. JAVASCRIPT LOGIC -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- FIREBASE CONFIG (Thay config của bạn vào đây) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", // Dùng key cũ trong file mẫu hoặc thay mới
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;
        let globalConfig = {}; // Chứa thông tin config (Github, Bank...)

        // --- HELPER UI ---
        const toast = (msg, type="success") => {
            Toastify({
                text: msg, duration: 3000, gravity: "top", position: "right",
                style: { background: type === "success" ? "#10b981" : "#ef4444" }
            }).showToast();
        };

        window.copyText = (id) => {
            const text = document.getElementById(id).innerText || document.getElementById(id).value;
            navigator.clipboard.writeText(text);
            toast("Đã copy!");
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleAdmin = () => {
            const el = document.getElementById('adminPanel');
            el.classList.toggle('hidden');
            setTimeout(() => el.classList.toggle('translate-y-full'), 10);
            if(!el.classList.contains('hidden')) loadAdminData();
        };
        window.showTab = (id) => {
            document.querySelectorAll('.admin-tab').forEach(e => e.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        // --- GITHUB UPLOAD SERVICE ---
        async function uploadToGithub(file, folder = 'uploads') {
            if (!globalConfig.ghToken) {
                toast("Chưa cấu hình Github Token!", "error");
                return null;
            }
            const fileName = `${folder}/${Date.now()}_${file.name.replace(/\s/g, '_')}`;
            const reader = new FileReader();
            
            return new Promise((resolve, reject) => {
                reader.onload = async () => {
                    const content = reader.result.split(',')[1]; // Base64
                    try {
                        const res = await fetch(`https://api.github.com/repos/${globalConfig.ghOwner}/${globalConfig.ghRepo}/contents/${fileName}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${globalConfig.ghToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ message: `Upload ${fileName}`, content: content })
                        });
                        const data = await res.json();
                        if(data.content && data.content.download_url) {
                            // Github raw url might be cached, use jsdelivr for CDN if repo is public, or raw.githubusercontent
                            resolve(data.content.download_url); 
                        } else {
                            reject("Upload failed");
                        }
                    } catch (e) { console.error(e); reject(e); }
                };
                reader.readAsDataURL(file);
            });
        }

        // --- MAIN LOGIC ---

        // 1. Auth & Initial Load
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('authText').innerText = "Logout";
                document.getElementById('imgUser').src = user.photoURL;
                document.getElementById('userNameDisplay').innerText = user.displayName;
                document.getElementById('userSection').classList.remove('hidden');
                document.getElementById('userSection').classList.add('flex');
                
                // Check Admin Role from Firestore
                const roleSnap = await getDoc(doc(db, "roles", "admin_list"));
                if(roleSnap.exists() && roleSnap.data().emails.includes(user.email)) {
                    isAdmin = true;
                    document.getElementById('btnOpenAdmin').classList.remove('hidden');
                }
            } else {
                document.getElementById('authText').innerText = "Login";
                document.getElementById('userSection').classList.add('hidden');
                document.getElementById('btnOpenAdmin').classList.add('hidden');
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            if (currentUser) signOut(auth);
            else signInWithPopup(auth, provider).catch(e => toast(e.message, "error"));
        });
        document.getElementById('btnOpenAdmin').addEventListener('click', window.toggleAdmin);

        // 2. Load Public Data
        async function initData() {
            // Load Config (Public + Private merged logic needed, but for SPA we load necessary parts)
            const configSnap = await getDoc(doc(db, "settings", "config"));
            if(configSnap.exists()) globalConfig = configSnap.data();

            // Profile
            const pSnap = await getDoc(doc(db, "settings", "profile"));
            if(pSnap.exists()) {
                const d = pSnap.data();
                document.getElementById('pName').innerText = d.name || 'Crypto Master';
                document.getElementById('pBio').innerText = d.bio || '';
                document.getElementById('pAvatar').src = d.avatar || 'https://via.placeholder.com/150';
                if(d.verified) document.getElementById('pVerified').classList.remove('hidden');
            }
            document.getElementById('profileLoader').classList.add('hidden');
            document.getElementById('profileContent').classList.remove('hidden');
            document.getElementById('profileContent').classList.add('animate-fade-in');

            // Courses
            const cSnap = await getDocs(query(collection(db, "courses"), orderBy("priceVal", "asc")));
            const cList = document.getElementById('coursesList');
            cList.innerHTML = '';
            cSnap.forEach(docSnap => {
                const c = docSnap.data();
                cList.innerHTML += `
                    <div class="card-item glass-panel rounded-2xl p-6 flex flex-col justify-between h-full relative group hover:border-brand-primary/50 transition duration-300">
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-brand-primary/20 text-brand-primary text-xs font-bold px-3 py-1 rounded-full uppercase">Course</span>
                                ${c.priceVal > 1000000 ? '<i class="fa-solid fa-crown text-brand-gold text-xl"></i>' : ''}
                            </div>
                            <h3 class="text-2xl font-display font-bold text-white mb-2 line-clamp-2">${c.name}</h3>
                            <div class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 mb-4">${c.price}</div>
                            <p class="text-gray-400 text-sm line-clamp-3 mb-6">${c.desc}</p>
                        </div>
                        <button onclick="openBuyModal('${docSnap.id}')" class="w-full py-3 rounded-xl bg-white text-black font-bold hover:bg-brand-primary hover:text-white transition shadow-lg">
                            Đăng ký ngay
                        </button>
                    </div>
                `;
            });
            
            // Partners
            const exSnap = await getDocs(collection(db, "exchanges"));
            const exDiv = document.getElementById('exchangeList');
            exDiv.innerHTML = '';
            exSnap.forEach(d => {
                const e = d.data();
                exDiv.innerHTML += `
                    <a href="${e.link}" target="_blank" class="block p-4 rounded-xl glass-panel text-center hover:bg-white/5 transition border border-white/5">
                        <div class="font-bold text-lg text-white mb-1">${e.name}</div>
                        <div class="text-xs text-green-400">Ref: ${e.rate || 'VIP'}</div>
                    </a>
                `;
            });
        }

        // 3. BUY & ORDER LOGIC
        let selectedCourse = null;
        let selectedMethod = 'bank';

        window.openBuyModal = async (courseId) => {
            if(!currentUser) { toast("Vui lòng đăng nhập trước!", "error"); return; }
            const cDoc = await getDoc(doc(db, "courses", courseId));
            selectedCourse = { id: courseId, ...cDoc.data() };

            document.getElementById('buyCourseName').innerText = selectedCourse.name;
            document.getElementById('buyCoursePrice').innerText = selectedCourse.price;
            
            // Reset UI
            document.getElementById('paymentDetails').classList.add('hidden');
            document.getElementById('verifyStep').classList.add('hidden');
            document.getElementById('buyModal').classList.remove('hidden');
        };

        window.selectPayment = (method) => {
            selectedMethod = method;
            const details = document.getElementById('paymentDetails');
            details.classList.remove('hidden');
            document.getElementById('verifyStep').classList.remove('hidden');

            const content = `${currentUser.email.split('@')[0]} ${selectedCourse.name.substring(0, 10)}`; // Short content
            
            if(method === 'bank') {
                document.getElementById('btnPayBank').classList.add('border-brand-primary');
                document.getElementById('btnPayCrypto').classList.remove('border-brand-primary');
                document.getElementById('bankInfoArea').classList.remove('hidden');
                document.getElementById('cryptoInfoArea').classList.add('hidden');

                // Set Bank Info
                document.getElementById('dispBankName').innerText = globalConfig.bankCode || 'MB';
                document.getElementById('dispBankNum').innerText = globalConfig.bankNum || '';
                document.getElementById('dispBankOwner').innerText = globalConfig.bankOwner || '';
                document.getElementById('dispContent').innerText = content;

                // VIETQR API
                const qrUrl = `https://img.vietqr.io/image/${globalConfig.bankCode}-${globalConfig.bankNum}-compact.jpg?amount=${selectedCourse.priceVal}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(globalConfig.bankOwner)}`;
                document.getElementById('vietQrImg').src = qrUrl;

            } else {
                document.getElementById('btnPayCrypto').classList.add('border-brand-primary');
                document.getElementById('btnPayBank').classList.remove('border-brand-primary');
                document.getElementById('bankInfoArea').classList.add('hidden');
                document.getElementById('cryptoInfoArea').classList.remove('hidden');
                document.getElementById('dispWallet').value = globalConfig.wallet || '';
            }
        };

        window.previewBill = () => {
            const file = document.getElementById('billFile').files[0];
            if(file) {
                document.getElementById('billPreview').src = URL.createObjectURL(file);
                document.getElementById('billPreview').classList.remove('hidden');
            }
        };

        window.submitOrder = async () => {
            const btn = document.getElementById('btnSubmitOrder');
            const file = document.getElementById('billFile').files[0];
            
            if(!file) { toast("Vui lòng tải ảnh bill!", "error"); return; }
            
            btn.innerText = "Đang xử lý...";
            btn.disabled = true;

            try {
                // Upload Bill to GitHub
                const billUrl = await uploadToGithub(file, 'bills');
                
                // Create Order
                await addDoc(collection(db, "orders"), {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName,
                    courseId: selectedCourse.id,
                    courseName: selectedCourse.name,
                    amount: selectedCourse.price,
                    method: selectedMethod,
                    billUrl: billUrl,
                    status: 'pending', // pending, approved
                    createdAt: serverTimestamp()
                });

                toast("Đăng ký thành công! Đang chờ duyệt.");
                closeModal('buyModal');
            } catch (e) {
                console.error(e);
                toast("Lỗi: " + e.message, "error");
            } finally {
                btn.innerText = "Hoàn tất đăng ký";
                btn.disabled = false;
            }
        };

        // 4. USER MY COURSES
        window.openMyCourses = async () => {
            if(!currentUser) return;
            document.getElementById('myCoursesModal').classList.remove('hidden');
            const q = query(collection(db, "orders"), where("userEmail", "==", currentUser.email), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            const list = document.getElementById('myCoursesList');
            list.innerHTML = '';
            
            if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-500">Chưa có khóa học nào.</p>'; return; }

            for (const d of snap.docs) {
                const o = d.data();
                // Get course link if approved
                let actionBtn = `<span class="text-yellow-500 text-sm"><i class="fa-regular fa-clock"></i> Đang chờ duyệt</span>`;
                if(o.status === 'approved') {
                    // Fetch course link
                    const cDoc = await getDoc(doc(db, "courses", o.courseId));
                    const link = cDoc.exists() ? cDoc.data().groupLink : '#';
                    actionBtn = `<a href="${link}" target="_blank" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm">Vào Nhóm Kín <i class="fa-solid fa-arrow-right"></i></a>`;
                }

                list.innerHTML += `
                    <div class="glass-panel p-4 rounded-xl flex justify-between items-center mb-3">
                        <div>
                            <h4 class="font-bold text-white">${o.courseName}</h4>
                            <div class="text-xs text-gray-400">${new Date(o.createdAt?.toDate()).toLocaleString()} | ${o.amount}</div>
                        </div>
                        <div>${actionBtn}</div>
                    </div>
                `;
            }
        };

        // 5. ADMIN LOGIC
        window.loadAdminData = async () => {
            if(!isAdmin) return;

            // Load Config Form
            document.getElementById('ghToken').value = globalConfig.ghToken || '';
            document.getElementById('ghOwner').value = globalConfig.ghOwner || '';
            document.getElementById('ghRepo').value = globalConfig.ghRepo || '';
            document.getElementById('cfgBankCode').value = globalConfig.bankCode || 'MB';
            document.getElementById('cfgBankNum').value = globalConfig.bankNum || '';
            document.getElementById('cfgBankOwner').value = globalConfig.bankOwner || '';
            document.getElementById('cfgWallet').value = globalConfig.wallet || '';
            
            // Load Profile Form
            const pSnap = await getDoc(doc(db, "settings", "profile"));
            if(pSnap.exists()){
                document.getElementById('cfgName').value = pSnap.data().name;
                document.getElementById('cfgBio').value = pSnap.data().bio;
            }

            // Load Orders
            const oSnap = await getDocs(query(collection(db, "orders"), orderBy("createdAt", "desc")));
            const tb = document.getElementById('orderTableBody');
            tb.innerHTML = '';
            let pendingCount = 0;

            oSnap.forEach(d => {
                const o = d.data();
                if(o.status === 'pending') pendingCount++;
                const statusHtml = o.status === 'approved' 
                    ? `<span class="text-green-400 font-bold">Đã duyệt</span>` 
                    : `<button onclick="approveOrder('${d.id}')" class="bg-blue-600 px-3 py-1 rounded text-white text-xs hover:bg-blue-500">Duyệt ngay</button>`;
                
                tb.innerHTML += `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="px-4 py-3">${new Date(o.createdAt?.toDate()).toLocaleDateString()}</td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-white">${o.userName}</div>
                            <div class="text-xs text-gray-500">${o.userEmail}</div>
                        </td>
                        <td class="px-4 py-3 text-brand-primary">${o.courseName}</td>
                        <td class="px-4 py-3"><a href="${o.billUrl}" target="_blank" class="text-blue-400 underline">Xem Bill</a></td>
                        <td class="px-4 py-3">${statusHtml}</td>
                        <td class="px-4 py-3"><i class="fa-solid fa-trash text-red-500 cursor-pointer" onclick="deleteOrder('${d.id}')"></i></td>
                    </tr>
                `;
            });
            document.getElementById('badgeOrders').innerText = pendingCount;
            
            // Load Courses List for Admin
            renderAdminCourses();
        }

        async function renderAdminCourses() {
            const list = document.getElementById('adminCourseList');
            const snap = await getDocs(collection(db, "courses"));
            list.innerHTML = '';
            snap.forEach(d => {
                const c = d.data();
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white/5 p-3 rounded">
                        <span class="text-white">${c.name}</span>
                        <div class="space-x-2">
                             <button onclick="editCourse('${d.id}')" class="text-blue-400"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="deleteDoc(doc(db, 'courses', '${d.id}')).then(()=>loadAdminData())" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        window.approveOrder = async (id) => {
            if(confirm("Xác nhận duyệt đơn hàng và cho phép user vào nhóm?")) {
                await updateDoc(doc(db, "orders", id), { status: 'approved' });
                toast("Đã duyệt đơn hàng!");
                loadAdminData();
            }
        };
        
        window.deleteOrder = async (id) => {
             if(confirm("Xóa lịch sử đơn hàng này?")) {
                await deleteDoc(doc(db, "orders", id));
                loadAdminData();
            }
        };

        // Save Config
        window.saveAllConfig = async () => {
            const data = {
                ghToken: document.getElementById('ghToken').value,
                ghOwner: document.getElementById('ghOwner').value,
                ghRepo: document.getElementById('ghRepo').value,
                bankCode: document.getElementById('cfgBankCode').value,
                bankNum: document.getElementById('cfgBankNum').value,
                bankOwner: document.getElementById('cfgBankOwner').value,
                wallet: document.getElementById('cfgWallet').value,
            };
            await setDoc(doc(db, "settings", "config"), data);

            // Upload Avatar logic (nếu có file)
            const avaFile = document.getElementById('cfgAvatarFile').files[0];
            let avaUrl = document.getElementById('pAvatar').src;
            if(avaFile) {
                try {
                    avaUrl = await uploadToGithub(avaFile, 'avatars');
                } catch(e) { toast("Lỗi upload avatar", "error"); }
            }

            await setDoc(doc(db, "settings", "profile"), {
                name: document.getElementById('cfgName').value,
                bio: document.getElementById('cfgBio').value,
                avatar: avaUrl,
                verified: true
            });

            toast("Cấu hình đã lưu! Reload trang để áp dụng.");
            setTimeout(() => location.reload(), 1500);
        };

        // Course CRUD
        document.getElementById('courseForm').addEventListener('submit', async(e) => {
            e.preventDefault();
            const id = document.getElementById('cId').value;
            const data = {
                name: document.getElementById('cName').value,
                price: document.getElementById('cPrice').value,
                priceVal: Number(document.getElementById('cPriceVal').value),
                groupLink: document.getElementById('cGroupLink').value,
                desc: document.getElementById('cDesc').value
            };
            if(id) await updateDoc(doc(db, "courses", id), data);
            else await addDoc(collection(db, "courses"), data);
            
            document.getElementById('courseForm').reset();
            document.getElementById('cId').value = '';
            toast("Đã lưu khóa học");
            loadAdminData();
        });

        window.editCourse = async (id) => {
            const d = (await getDoc(doc(db, "courses", id))).data();
            document.getElementById('cId').value = id;
            document.getElementById('cName').value = d.name;
            document.getElementById('cPrice').value = d.price;
            document.getElementById('cPriceVal').value = d.priceVal;
            document.getElementById('cGroupLink').value = d.groupLink;
            document.getElementById('cDesc').value = d.desc;
        };

        // Init App
        AOS.init();
        initData();
    </script>
</body>
</html>
