<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Elite Academy & Profile</title>
    
    <!-- 1. TH∆Ø VI·ªÜN UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- 2. CONFIG TAILWIND -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        dark: { bg: '#050505', card: 'rgba(20, 20, 30, 0.6)' },
                        brand: { primary: '#6366f1', secondary: '#ec4899', accent: '#14b8a6', gold: '#fbbf24' }
                    },
                    animation: { 'spin-slow': 'spin 12s linear infinite' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #ffffff; overflow-x: hidden; }
        .bg-mesh {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 25%),
                        radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 25%);
        }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); border-color: rgba(99, 102, 241, 0.3); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: #6366f1; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div class="bg-mesh"></div>

    <!-- === HEADER === -->
    <nav class="fixed top-0 w-full z-50 backdrop-blur-md border-b border-white/5">
        <div class="max-w-6xl mx-auto px-4 h-20 flex items-center justify-between">
            <a href="#" class="font-display font-bold text-xl md:text-2xl flex items-center gap-2">
                <i class="fa-brands fa-bitcoin text-brand-gold text-2xl"></i>
                <span class="text-white">CRYPTO<span class="text-brand-primary">HUB</span></span>
            </a>

            <div class="flex items-center gap-3">
                <div id="userSection" class="hidden flex items-center gap-3 bg-white/5 px-3 py-1.5 rounded-full border border-white/10">
                    <img id="imgUser" src="" class="w-8 h-8 rounded-full object-cover">
                    <button onclick="openMyOrders()" class="hidden md:block text-sm font-medium hover:text-brand-primary transition px-1">C√° nh√¢n</button>
                    <button id="btnLogout" class="text-sm text-red-400 hover:text-white px-2"><i class="fa-solid fa-power-off"></i></button>
                </div>
                <button id="btnLogin" class="hidden px-5 py-2 font-bold text-sm text-white bg-white/5 border border-white/10 rounded-full hover:bg-brand-primary transition">ƒêƒÉng nh·∫≠p</button>
            </div>
        </div>
    </nav>

    <!-- === MAIN CONTENT === -->
    <main class="relative z-10 pt-32 pb-20 px-4 max-w-6xl mx-auto space-y-20">

        <!-- PROFILE -->
        <section id="profileSection" class="text-center" data-aos="fade-up">
            <div id="profileLoader" class="loader mt-10"></div>
            <div id="profileContent" class="hidden">
                <div class="relative w-32 h-32 md:w-40 md:h-40 mx-auto mb-6">
                    <img id="pAvatar" src="" class="w-full h-full rounded-full object-cover border-4 border-dark-bg">
                    <i id="pVerified" class="hidden fa-solid fa-circle-check text-blue-500 text-2xl absolute bottom-2 right-2 bg-white rounded-full border-2 border-dark-bg z-20"></i>
                </div>
                <h1 class="font-display text-4xl md:text-6xl font-bold mb-4"><span id="pName" class="text-white"></span></h1>
                <p id="pBio" class="text-gray-400 text-lg md:text-xl max-w-2xl mx-auto font-light leading-relaxed"></p>
            </div>
        </section>

        <!-- SOCIAL LINKS -->
        <section id="socialSection" class="flex flex-wrap justify-center gap-4" data-aos="fade-up"></section>

        <!-- COURSES -->
        <section class="relative group">
            <div class="flex items-center justify-between mb-8 px-2">
                <h2 class="font-display text-2xl md:text-3xl font-bold text-white">üî• KH√ìA H·ªåC PREMIUM</h2>
                <div class="flex gap-2">
                    <button onclick="scrollCourses('left')" class="w-10 h-10 rounded-full bg-white/10 hover:bg-brand-primary text-white flex items-center justify-center transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <button onclick="scrollCourses('right')" class="w-10 h-10 rounded-full bg-white/10 hover:bg-brand-primary text-white flex items-center justify-center transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>
            <div id="coursesList" class="flex overflow-x-auto gap-6 pb-8 hide-scrollbar snap-x snap-mandatory scroll-smooth px-2"></div>
        </section>

        <!-- PARTNERS & REF (S√ÄN GIAO D·ªäCH) -->
        <section>
            <div class="text-center mb-10">
                <h2 class="font-display text-2xl font-bold text-brand-accent">ƒê·ªêI T√ÅC HO√ÄN PH√ç GIAO D·ªäCH</h2>
                <p class="text-gray-500 text-sm mt-2">ƒêƒÉng k√Ω qua link ref v√† nh·∫≠p UID ƒë·ªÉ ƒë∆∞·ª£c ho√†n ph√≠ tr·ªçn ƒë·ªùi</p>
            </div>
            <div id="exchangeList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-5">
                <!-- Exchanges injected via JS -->
            </div>
        </section>

    </main>

    <!-- === MODALS === -->

    <!-- 1. CHECKOUT MODAL -->
    <div id="checkoutModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-2xl rounded-2xl overflow-hidden flex flex-col md:flex-row max-h-[90vh] overflow-y-auto">
            <div class="p-6 md:w-1/2 bg-white/5 border-r border-white/5">
                <h3 class="text-xl font-bold text-white mb-4">Thanh to√°n kh√≥a h·ªçc</h3>
                <div class="space-y-4 text-sm">
                    <div><span class="text-gray-400">Kh√≥a h·ªçc:</span> <span id="chkCourse" class="text-brand-primary font-bold block"></span></div>
                    <div><span class="text-gray-400">H·ªçc ph√≠:</span> <span id="chkPrice" class="text-brand-gold font-bold text-xl block"></span></div>
                </div>
                <hr class="border-white/10 my-6">
                <div class="flex gap-2">
                    <button onclick="selectPayment('BANK')" id="btnMethodBank" class="flex-1 py-2 rounded border border-brand-primary bg-brand-primary/20 text-white font-bold text-xs">Chuy·ªÉn kho·∫£n</button>
                    <button onclick="selectPayment('CRYPTO')" id="btnMethodCrypto" class="flex-1 py-2 rounded border border-white/10 hover:bg-white/5 text-gray-400 font-bold text-xs">USDT</button>
                </div>
            </div>
            <div class="p-6 md:w-1/2 flex flex-col relative">
                <button onclick="closeCheckout()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
                <div id="payViewBank" class="space-y-4 text-center">
                    <div class="bg-white p-2 rounded-xl inline-block mx-auto shadow-lg"><img id="qrImage" src="" class="w-40 h-40 object-contain"></div>
                    <div class="text-xs text-gray-400 italic">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n t·ª± ƒë·ªông</div>
                </div>
                <div id="payViewCrypto" class="hidden space-y-4">
                    <div class="bg-black/50 p-3 rounded border border-white/10 flex items-center justify-between cursor-pointer group" onclick="copyToClipboard('walletAddress')">
                        <div class="truncate text-xs font-mono text-brand-gold w-full mr-2" id="walletAddress">...</div>
                        <i class="fa-regular fa-copy text-gray-500 group-hover:text-white"></i>
                    </div>
                </div>
                <div class="mt-auto pt-6 border-t border-white/10">
                    <label for="billFile" class="flex items-center justify-center w-full h-12 border border-dashed border-gray-500 rounded-lg cursor-pointer hover:border-brand-primary text-gray-400 text-sm">
                        <i class="fa-solid fa-cloud-arrow-up mr-2"></i> <span id="fileName">T·∫£i ·∫£nh bill l√™n</span>
                    </label>
                    <input type="file" id="billFile" accept="image/*" class="hidden" onchange="previewBill()">
                    <button id="btnConfirmOrder" onclick="submitOrder()" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg">X√°c nh·∫≠n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. UID SUBMIT MODAL (REF) -->
    <div id="uidModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md rounded-2xl p-6 relative">
            <button onclick="el('uidModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            <h3 class="text-xl font-bold text-white mb-2">B√°o danh UID</h3>
            <p class="text-sm text-gray-400 mb-6">Nh·∫≠p UID s√†n <span id="modalExchName" class="text-brand-primary font-bold"></span> c·ªßa b·∫°n ƒë·ªÉ admin k√≠ch ho·∫°t ho√†n ph√≠.</p>
            
            <input type="hidden" id="modalExchId">
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase">UID C·ªßa b·∫°n</label>
                    <input type="text" id="inputUid" class="w-full bg-black/50 border border-gray-700 p-3 rounded-lg text-white focus:border-brand-primary outline-none" placeholder="VD: 12345678">
                </div>
                <button onclick="submitUidRef()" class="w-full bg-brand-primary hover:bg-indigo-600 text-white font-bold py-3 rounded-lg">G·ª≠i Y√™u C·∫ßu</button>
            </div>
        </div>
    </div>

    <!-- 3. MY DASHBOARD MODAL -->
    <div id="myOrdersModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-3xl rounded-2xl p-6 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Ho·∫°t ƒë·ªông c·ªßa t√¥i</h3>
                <button onclick="el('myOrdersModal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>
            
            <div class="flex gap-4 mb-4 border-b border-white/10 pb-2">
                <button onclick="switchUserTab('uTab-courses')" class="text-white font-bold border-b-2 border-brand-primary pb-2">Kh√≥a h·ªçc</button>
                <button onclick="switchUserTab('uTab-refunds')" class="text-gray-400 hover:text-white pb-2">Y√™u c·∫ßu ho√†n ph√≠</button>
            </div>

            <div id="uTab-courses" class="flex-1 overflow-y-auto space-y-3">
                <div id="myOrdersList"></div>
            </div>
            <div id="uTab-refunds" class="hidden flex-1 overflow-y-auto space-y-3">
                <div id="myRefundsList"></div>
            </div>
        </div>
    </div>

    <!-- ADMIN BUTTON -->
    <button id="btnOpenAdmin" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-red-600 text-white rounded-full shadow-[0_0_20px_rgba(220,38,38,0.5)] z-40 hover:scale-110 transition flex items-center justify-center">
        <i class="fa-solid fa-gear fa-xl animate-spin-slow"></i>
    </button>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="fixed inset-0 z-[70] hidden bg-black/95 backdrop-blur-xl transition-all duration-300 overflow-y-auto">
        <div class="max-w-7xl mx-auto p-4 md:p-8 min-h-screen">
            <div class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
                <h2 class="text-2xl font-display font-bold text-white">Admin Dashboard</h2>
                <button onclick="toggleAdminPanel()" class="bg-white/10 px-4 py-2 rounded hover:bg-white/20">Tho√°t</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Sidebar -->
                <div class="lg:col-span-1 space-y-2">
                    <div class="text-xs text-gray-500 font-bold uppercase mt-2 mb-1">Qu·∫£n l√Ω</div>
                    <button onclick="switchTab('tab-orders')" class="adm-btn w-full text-left px-4 py-3 rounded bg-brand-primary text-white font-bold"><i class="fa-solid fa-graduation-cap mr-2"></i> ƒê∆°n Kh√≥a H·ªçc</button>
                    <button onclick="switchTab('tab-refunds')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5"><i class="fa-solid fa-money-bill-transfer mr-2"></i> Y√™u c·∫ßu Ho√†n Ph√≠</button>
                    
                    <div class="text-xs text-gray-500 font-bold uppercase mt-6 mb-1">H·ªá th·ªëng</div>
                    <button onclick="switchTab('tab-courses')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5">Kh√≥a h·ªçc</button>
                    <button onclick="switchTab('tab-exchanges')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5">ƒê·ªëi t√°c (S√†n)</button>
                    <button onclick="switchTab('tab-socials')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5">M·∫°ng x√£ h·ªôi</button>
                    <button onclick="switchTab('tab-profile')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5">Profile</button>
                    <button onclick="switchTab('tab-config')" class="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5">C·∫•u h√¨nh chung</button>
                </div>

                <!-- Content -->
                <div class="lg:col-span-4 glass-panel rounded-xl p-6 min-h-[500px]">
                    
                    <!-- 1. QU·∫¢N L√ù ƒê∆†N KH√ìA H·ªåC -->
                    <div id="tab-orders" class="adm-sec">
                        <h3 class="text-white font-bold text-xl mb-4 border-b border-gray-700 pb-2">Danh s√°ch ƒëƒÉng k√Ω kh√≥a h·ªçc</h3>
                        <div class="overflow-x-auto"><table class="w-full text-left text-sm text-gray-400"><thead class="bg-white/5 text-white uppercase text-xs"><tr><th class="p-3">Ng√†y</th><th class="p-3">Email</th><th class="p-3">Kh√≥a h·ªçc</th><th class="p-3">Gi√°</th><th class="p-3">Bill</th><th class="p-3">Tr·∫°ng th√°i</th><th class="p-3">H√†nh ƒë·ªông</th></tr></thead><tbody id="admOrderList" class="divide-y divide-gray-800"></tbody></table></div>
                    </div>

                    <!-- 2. QU·∫¢N L√ù HO√ÄN PH√ç REF -->
                    <div id="tab-refunds" class="adm-sec hidden">
                        <h3 class="text-white font-bold text-xl mb-4 border-b border-gray-700 pb-2">Danh s√°ch b√°o danh UID (Ref)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-white/5 text-white uppercase text-xs">
                                    <tr>
                                        <th class="p-3">Ng√†y g·ª≠i</th>
                                        <th class="p-3">Email User</th>
                                        <th class="p-3">S√†n</th>
                                        <th class="p-3 text-white">UID B√°o danh</th>
                                        <th class="p-3">Tr·∫°ng th√°i</th>
                                        <th class="p-3">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="admRefundList" class="divide-y divide-gray-800"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 3. QU·∫¢N L√ù KH√ìA H·ªåC -->
                    <div id="tab-courses" class="adm-sec hidden">
                        <form id="formCourse" class="grid grid-cols-2 gap-4 mb-6 bg-white/5 p-4 rounded border border-white/10">
                            <input id="cName" placeholder="T√™n kh√≥a h·ªçc" class="bg-black border border-gray-700 p-2 rounded text-white col-span-2">
                            <!-- INPUT PRICE AUTO FORMAT -->
                            <input id="cPrice" placeholder="Gi√° ti·ªÅn (nh·∫≠p s·ªë: 500000)" class="bg-black border border-gray-700 p-2 rounded text-white font-bold text-brand-gold">
                            <input id="cGroupLink" placeholder="Link nh√≥m Telegram" class="bg-black border border-gray-700 p-2 rounded text-white">
                            <textarea id="cDesc" placeholder="M√¥ t·∫£ ng·∫Øn" class="bg-black border border-gray-700 p-2 rounded text-white col-span-2"></textarea>
                            <textarea id="cBenefits" placeholder="Quy·ªÅn l·ª£i (c√°ch nhau d·∫•u ph·∫©y)" class="bg-black border border-gray-700 p-2 rounded text-white col-span-2"></textarea>
                            <button type="submit" class="bg-green-600 hover:bg-green-500 text-white p-2 rounded font-bold col-span-2">L∆∞u Kh√≥a H·ªçc</button>
                        </form>
                        <div id="admCourseList" class="space-y-2"></div>
                    </div>

                    <!-- 4. QU·∫¢N L√ù S√ÄN (EXCHANGES) -->
                    <div id="tab-exchanges" class="adm-sec hidden">
                         <form id="formExchange" class="flex flex-wrap gap-2 mb-4 bg-white/5 p-4 rounded">
                             <input id="exName" placeholder="T√™n s√†n (Binance, Bybit)" class="flex-1 bg-black border border-gray-700 p-2 rounded text-white">
                             <input id="exLink" placeholder="Link Ref" class="flex-1 bg-black border border-gray-700 p-2 rounded text-white">
                             <input id="exRate" placeholder="Rate (30%)" class="w-24 bg-black border border-gray-700 p-2 rounded text-white">
                             <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Th√™m S√†n</button>
                        </form>
                        <div id="admExchList" class="grid grid-cols-2 gap-2"></div>
                    </div>

                    <!-- OTHER TABS -->
                    <div id="tab-socials" class="adm-sec hidden">
                        <div class="space-y-4 max-w-lg">
                            <input id="socFb" placeholder="Facebook Link" class="w-full bg-black border border-gray-700 p-3 rounded text-white">
                            <input id="socTele" placeholder="Telegram Link" class="w-full bg-black border border-gray-700 p-3 rounded text-white">
                            <input id="socTiktok" placeholder="Tiktok Link" class="w-full bg-black border border-gray-700 p-3 rounded text-white">
                            <input id="socYt" placeholder="Youtube Link" class="w-full bg-black border border-gray-700 p-3 rounded text-white">
                            <button onclick="saveSocials()" class="bg-brand-primary text-white px-6 py-2 rounded font-bold">L∆∞u Socials</button>
                        </div>
                    </div>

                    <div id="tab-config" class="adm-sec hidden">
                        <div class="mb-6"><h4 class="text-white font-bold mb-2">GitHub (L∆∞u ·∫£nh)</h4><input id="cfgGhToken" type="password" placeholder="GitHub Token" class="bg-black border border-gray-700 p-2 rounded text-white w-full mb-2"><div class="grid grid-cols-3 gap-2"><input id="cfgGhUser" placeholder="Username" class="bg-black border border-gray-700 p-2 rounded text-white"><input id="cfgGhRepo" placeholder="Repo" class="bg-black border border-gray-700 p-2 rounded text-white"><input id="cfgGhPath" placeholder="Path" class="bg-black border border-gray-700 p-2 rounded text-white"></div></div>
                        <div class="mb-6"><h4 class="text-white font-bold mb-2">Thanh to√°n</h4><div class="grid md:grid-cols-2 gap-4"><input id="cfgBankCode" placeholder="M√£ NH (MB, VCB)" class="bg-black border border-gray-700 p-2 rounded text-white"><input id="cfgBankNum" placeholder="STK" class="bg-black border border-gray-700 p-2 rounded text-white"><input id="cfgBankName" placeholder="T√™n ch·ªß TK" class="bg-black border border-gray-700 p-2 rounded text-white"><input id="cfgWallet" placeholder="V√≠ USDT" class="bg-black border border-gray-700 p-2 rounded text-white"></div></div>
                        <button onclick="saveConfig()" class="w-full bg-brand-primary py-3 rounded font-bold text-white">L∆∞u C·∫•u H√¨nh</button>
                    </div>

                    <div id="tab-profile" class="adm-sec hidden">
                        <input id="admPName" class="w-full mb-2 bg-black border border-gray-700 p-2 text-white rounded" placeholder="T√™n hi·ªÉn th·ªã">
                        <textarea id="admPBio" class="w-full mb-2 bg-black border border-gray-700 p-2 text-white rounded" placeholder="Ti·ªÉu s·ª≠"></textarea>
                        <input id="admPAvatar" class="w-full mb-2 bg-black border border-gray-700 p-2 text-white rounded" placeholder="Link Avatar">
                        <button onclick="saveProfile()" class="bg-blue-600 text-white px-4 py-2 rounded">C·∫≠p nh·∫≠t</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script type="module">
        // --- C·∫§U H√åNH ---
        const YOUR_EMAIL = "your-email@gmail.com"; // <-- THAY EMAIL ADMIN C·ª¶A B·∫†N V√ÄO ƒê√ÇY

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let globalConfig = {};

        // --- HELPER FORMAT TI·ªÄN T·ªÜ (VND) ---
        const formatVND = (str) => {
            if(!str) return '';
            // X√≥a h·∫øt k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            const num = str.toString().replace(/\D/g, '');
            if(!num) return '';
            // Format s·ªë sang d·∫°ng 500.000 ƒë
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
        };
        
        // Helper ƒë·ªÉ l·∫•y gi√° tr·ªã s·ªë nguy√™n t·ª´ chu·ªói ƒë√£ format (ƒë·ªÉ t√≠nh to√°n QR)
        const getRawMoney = (str) => str.toString().replace(/\D/g, '');

        // H√†m Toast
        const toast = (msg, type="success") => Toastify({ text: msg, duration: 3000, style: { background: type==="success"?"#10B981":"#EF4444" } }).showToast();
        const el = (id) => document.getElementById(id);
        const nl2br = (str) => str ? str.replace(/\n/g, "<br>") : "";

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                el('btnLogin').classList.add('hidden');
                el('userSection').classList.remove('hidden');
                el('userSection').classList.add('flex');
                el('imgUser').src = user.photoURL;
                if (user.email === YOUR_EMAIL || (globalConfig.admins && globalConfig.admins.includes(user.email))) {
                    el('btnOpenAdmin').classList.remove('hidden');
                }
            } else {
                el('btnLogin').classList.remove('hidden');
                el('userSection').classList.add('hidden');
                el('btnOpenAdmin').classList.add('hidden');
            }
        });
        el('btnLogin').onclick = () => signInWithPopup(auth, provider).catch(e=>toast(e.message,"error"));
        el('btnLogout').onclick = () => signOut(auth);

        // --- LOAD DATA ---
        async function loadSite() {
            // Config
            const cfg = await getDoc(doc(db, "settings", "config"));
            if(cfg.exists()) globalConfig = cfg.data();

            // Profile
            const p = await getDoc(doc(db, "site_content", "profile"));
            el('profileLoader').classList.add('hidden');
            el('profileContent').classList.remove('hidden');
            if(p.exists()) {
                const d = p.data();
                el('pName').innerText = d.name;
                el('pBio').innerHTML = nl2br(d.bio);
                el('pAvatar').src = d.avatar;
                if(d.verified) el('pVerified').classList.remove('hidden');
                el('admPName').value = d.name||''; el('admPBio').value = d.bio||''; el('admPAvatar').value = d.avatar||'';
            }

            // Socials
            const s = await getDoc(doc(db, "site_content", "socials"));
            if(s.exists()){
                const d=s.data();
                const map = [{k:'fb',i:'fa-facebook-f',c:'hover:bg-[#1877F2]'},{k:'tele',i:'fa-telegram',c:'hover:bg-[#0088cc]'},{k:'tiktok',i:'fa-tiktok',c:'hover:bg-[#ff0050]'},{k:'yt',i:'fa-youtube',c:'hover:bg-[#FF0000]'}];
                el('socialSection').innerHTML = map.map(m=>d[m.k]?`<a href="${d[m.k]}" target="_blank" class="w-12 h-12 rounded-xl glass-panel flex items-center justify-center text-xl text-white transition hover:scale-110 ${m.c} border border-white/10"><i class="fa-brands ${m.i}"></i></a>`:'').join('');
                el('socFb').value = d.fb||''; el('socTele').value = d.tele||''; el('socTiktok').value = d.tiktok||''; el('socYt').value = d.yt||'';
            }

            // Courses
            const cSnap = await getDocs(collection(db, "courses"));
            el('coursesList').innerHTML = '';
            cSnap.forEach(doc => {
                const c = doc.data();
                const isVip = getRawMoney(c.price) > 1000000; // Logic VIP ƒë∆°n gi·∫£n
                el('coursesList').innerHTML += `
                    <div class="glass-card min-w-[300px] md:min-w-[360px] rounded-3xl p-6 snap-center flex flex-col justify-between border ${isVip ? 'border-brand-primary/40 shadow-lg shadow-brand-primary/10' : 'border-white/10'}">
                        <div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold tracking-widest text-brand-primary uppercase">PREMIUM</span>
                                ${isVip ? '<i class="fa-solid fa-crown text-brand-gold text-lg"></i>' : ''}
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-2">${c.name}</h3>
                            <div class="text-3xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 mb-4">${c.price}</div>
                            <p class="text-gray-400 text-sm mb-6 line-clamp-3">${c.desc||''}</p>
                            <ul class="space-y-2 mb-8 text-sm text-gray-300">
                                ${(c.benefits||'').split(',').map(b=>`<li class="flex gap-2"><i class="fa-solid fa-check text-brand-accent mt-1"></i> ${b}</li>`).join('')}
                            </ul>
                        </div>
                        <button onclick="initCheckout('${doc.id}', '${c.name}', '${c.price}')" class="w-full py-3 rounded-xl bg-gradient-to-r from-brand-primary to-blue-600 text-white font-bold hover:shadow-lg hover:shadow-blue-500/30 transition">ƒêƒÉng K√Ω Ngay</button>
                    </div>
                `;
            });

            // Exchanges (S√ÄN) - NEW UI
            const eSnap = await getDocs(collection(db, "exchanges"));
            el('exchangeList').innerHTML = '';
            eSnap.forEach(doc => {
                 const e = doc.data();
                 el('exchangeList').innerHTML += `
                    <div class="glass-panel p-5 rounded-2xl border border-white/10 flex flex-col items-center text-center hover:bg-white/5 transition group">
                        <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center font-bold text-black text-lg mb-3 shadow-lg shadow-white/20">${e.name.substring(0,2)}</div>
                        <h4 class="font-bold text-white text-lg">${e.name}</h4>
                        <div class="text-xs font-bold bg-green-900/40 text-green-400 px-2 py-1 rounded mt-1 mb-4">Ho√†n ph√≠: ${e.rate}</div>
                        
                        <div class="grid grid-cols-2 gap-2 w-full mt-auto">
                            <a href="${e.link}" target="_blank" class="bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg text-xs font-bold border border-white/10 transition">ƒêƒÉng k√Ω</a>
                            <button onclick="openUidModal('${doc.id}', '${e.name}')" class="bg-brand-primary hover:bg-brand-primary/80 text-white py-2 rounded-lg text-xs font-bold transition shadow-lg shadow-brand-primary/20">B√°o UID</button>
                        </div>
                    </div>
                 `;
            });
        }
        window.scrollCourses = (d) => { el('coursesList').scrollLeft += (d==='left'?-350:350); }

        // --- CHECKOUT LOGIC (COURSES) ---
        let currentOrder = {};
        window.initCheckout = (id,name,price) => {
            if(!currentUser) return toast("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p!","error");
            currentOrder = { id, name, price, method:'BANK' };
            el('chkCourse').innerText = name; el('chkPrice').innerText = price;
            el('checkoutModal').classList.remove('hidden'); selectPayment('BANK');
        }
        window.selectPayment = (m) => {
            currentOrder.method = m;
            const bB=el('btnMethodBank'), bC=el('btnMethodCrypto'), vB=el('payViewBank'), vC=el('payViewCrypto');
            if(m==='BANK'){
                bB.className="flex-1 py-2 rounded border border-brand-primary bg-brand-primary/20 text-white font-bold text-xs";
                bC.className="flex-1 py-2 rounded border border-white/10 hover:bg-white/5 text-gray-400 font-bold text-xs";
                vB.classList.remove('hidden'); vC.classList.add('hidden');
                const amt = getRawMoney(currentOrder.price); // L·∫•y s·ªë ti·ªÅn s·∫°ch ƒë·ªÉ t·∫°o QR
                const content = `${currentUser.email.split('@')[0]} ${currentOrder.name.substring(0,5)}`;
                el('qrImage').src = `https://img.vietqr.io/image/${globalConfig.bankCode}-${globalConfig.bankNum}-compact.jpg?amount=${amt}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(globalConfig.bankName)}`;
            } else {
                bC.className="flex-1 py-2 rounded border border-brand-primary bg-brand-primary/20 text-white font-bold text-xs";
                bB.className="flex-1 py-2 rounded border border-white/10 hover:bg-white/5 text-gray-400 font-bold text-xs";
                vB.classList.add('hidden'); vC.classList.remove('hidden');
                el('walletAddress').innerText = globalConfig.wallet || 'Ch∆∞a c·∫•u h√¨nh v√≠';
            }
        }
        window.submitOrder = async() => {
            const f = el('billFile').files[0]; if(!f) return toast("Thi·∫øu ·∫£nh bill!","error");
            const btn=el('btnConfirmOrder'); btn.disabled=true; btn.innerText="ƒêang x·ª≠ l√Ω...";
            try {
                const reader=new FileReader(); reader.readAsDataURL(f);
                reader.onload=async()=>{
                    const base64=reader.result.split(',')[1];
                    const name = `bill_${Date.now()}_${currentUser.uid.substring(0,4)}.jpg`;
                    // Upload GitHub
                    const res = await fetch(`https://api.github.com/repos/${globalConfig.ghUser}/${globalConfig.ghRepo}/contents/${globalConfig.ghPath}/${name}`,{
                        method:'PUT', headers:{'Authorization':`Bearer ${globalConfig.ghToken}`,'Content-Type':'application/json'},
                        body:JSON.stringify({message:'Bill',content:base64})
                    });
                    const d=await res.json();
                    await addDoc(collection(db,"orders"), {
                        uid:currentUser.uid, email:currentUser.email, courseName:currentOrder.name, courseId:currentOrder.id,
                        price:currentOrder.price, billUrl:d.content.download_url, status:'pending', createdAt:new Date().toISOString()
                    });
                    toast("Th√†nh c√¥ng! Ch·ªù duy·ªát."); el('checkoutModal').classList.add('hidden');
                    btn.disabled=false; btn.innerText="X√°c nh·∫≠n";
                }
            } catch(e){ toast("L·ªói: "+e.message,"error"); btn.disabled=false; }
        }

        // --- UID REF LOGIC (S√ÄN) ---
        window.openUidModal = (exId, exName) => {
            if(!currentUser) return toast("Vui l√≤ng ƒëƒÉng nh·∫≠p!","error");
            el('modalExchName').innerText = exName;
            el('modalExchId').value = exId;
            el('inputUid').value = '';
            el('uidModal').classList.remove('hidden');
        }
        window.submitUidRef = async () => {
            const uid = el('inputUid').value;
            const exId = el('modalExchId').value;
            const exName = el('modalExchName').innerText;
            if(!uid) return toast("Vui l√≤ng nh·∫≠p UID!","error");

            await addDoc(collection(db, "refund_requests"), {
                uid: currentUser.uid,
                email: currentUser.email,
                exchangeId: exId,
                exchangeName: exName,
                partnerUid: uid,
                status: 'pending',
                createdAt: new Date().toISOString()
            });
            toast("ƒê√£ g·ª≠i y√™u c·∫ßu ho√†n ph√≠!");
            el('uidModal').classList.add('hidden');
        }

        // --- MY DASHBOARD ---
        window.openMyOrders = async () => {
            if(!currentUser) return;
            el('myOrdersModal').classList.remove('hidden');
            switchUserTab('uTab-courses'); // Default load courses
        }
        window.switchUserTab = async (tabId) => {
            document.getElementById('uTab-courses').classList.add('hidden');
            document.getElementById('uTab-refunds').classList.add('hidden');
            document.getElementById(tabId).classList.remove('hidden');

            if(tabId === 'uTab-courses') {
                const snap = await getDocs(query(collection(db,"orders"), where("uid","==",currentUser.uid), orderBy("createdAt","desc")));
                const l = el('myOrdersList'); l.innerHTML = '';
                if(snap.empty) l.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ kh√≥a h·ªçc.</p>';
                snap.forEach(d=>{
                    const o=d.data();
                    l.innerHTML+=`<div class="bg-white/5 p-3 rounded border border-white/10 mb-2"><div class="font-bold text-white">${o.courseName}</div><div class="text-xs text-gray-400">${o.price} - ${new Date(o.createdAt).toLocaleDateString()}</div><div class="text-xs mt-1 ${o.status==='approved'?'text-green-400':'text-yellow-400'}">${o.status==='approved'?'ƒê√£ duy·ªát (V√†o nh√≥m)':'ƒêang ch·ªù duy·ªát'}</div>${o.status==='approved'?`<a href="${o.groupLink||'#'}" target="_blank" class="block mt-2 text-center bg-brand-primary text-white text-xs py-1 rounded">V√†o Nh√≥m</a>`:''}</div>`;
                });
            } else {
                const snap = await getDocs(query(collection(db,"refund_requests"), where("uid","==",currentUser.uid), orderBy("createdAt","desc")));
                const l = el('myRefundsList'); l.innerHTML = '';
                if(snap.empty) l.innerHTML = '<p class="text-gray-500 text-center">Ch∆∞a c√≥ y√™u c·∫ßu ho√†n ph√≠.</p>';
                snap.forEach(d=>{
                    const o=d.data();
                    l.innerHTML+=`<div class="bg-white/5 p-3 rounded border border-white/10 mb-2 flex justify-between items-center"><div><div class="font-bold text-white">${o.exchangeName}</div><div class="text-xs text-gray-400">UID: ${o.partnerUid}</div></div><div class="text-xs font-bold ${o.status==='approved'?'text-green-400':'text-yellow-400'}">${o.status==='approved'?'ƒê√£ Duy·ªát':'Ch·ªù duy·ªát'}</div></div>`;
                });
            }
        }
        
        // --- ADMIN PANEL ---
        window.toggleAdminPanel = () => { const p=el('adminPanel'); if(p.classList.contains('hidden')){p.classList.remove('hidden'); loadAdminData();}else p.classList.add('hidden'); }
        window.switchTab = (id) => {
            document.querySelectorAll('.adm-sec').forEach(e=>e.classList.add('hidden')); el(id).classList.remove('hidden');
            document.querySelectorAll('.adm-btn').forEach(b=>{b.className="adm-btn w-full text-left px-4 py-3 rounded text-gray-400 hover:bg-white/5"});
            event.currentTarget.className="adm-btn w-full text-left px-4 py-3 rounded bg-brand-primary text-white font-bold";
        }

        async function loadAdminData() {
            // 1. ORDERS
            const oSnap = await getDocs(query(collection(db,"orders"), orderBy("createdAt","desc")));
            el('admOrderList').innerHTML = oSnap.docs.map(d=>{const o=d.data(); return `<tr><td class="p-3 text-xs">${new Date(o.createdAt).toLocaleDateString()}</td><td class="p-3 font-bold text-white">${o.email}</td><td class="p-3">${o.courseName}</td><td class="p-3 text-brand-gold font-mono">${o.price}</td><td class="p-3"><a href="${o.billUrl}" target="_blank" class="text-blue-400 text-xs">Xem Bill</a></td><td class="p-3 text-xs uppercase ${o.status==='approved'?'text-green-500':'text-yellow-500'}">${o.status}</td><td class="p-3">${o.status==='pending'?`<button onclick="approveOrder('${d.id}','${o.courseId}')" class="bg-green-600 px-2 py-1 rounded text-xs text-white">Duy·ªát</button>`:'-'}</td></tr>`}).join('');
            
            // 2. REFUNDS (NEW)
            const rSnap = await getDocs(query(collection(db,"refund_requests"), orderBy("createdAt","desc")));
            el('admRefundList').innerHTML = rSnap.docs.map(d=>{const o=d.data(); return `<tr><td class="p-3 text-xs">${new Date(o.createdAt).toLocaleDateString()}</td><td class="p-3 text-white">${o.email}</td><td class="p-3 font-bold text-brand-primary">${o.exchangeName}</td><td class="p-3 font-mono text-white">${o.partnerUid}</td><td class="p-3 text-xs uppercase ${o.status==='approved'?'text-green-500':'text-yellow-500'}">${o.status}</td><td class="p-3">${o.status==='pending'?`<button onclick="approveRefund('${d.id}')" class="bg-green-600 px-2 py-1 rounded text-xs text-white">X√°c minh</button>`:'-'}</td></tr>`}).join('');

            // 3. COURSES & EXCHANGES & CONFIG
            const cSnap = await getDocs(collection(db,"courses"));
            el('admCourseList').innerHTML=cSnap.docs.map(d=>`<div class="flex justify-between p-2 bg-white/5 border border-white/10 rounded"><span>${d.data().name} (${d.data().price})</span><button onclick="delDoc('courses','${d.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`).join('');
            
            const eSnap = await getDocs(collection(db,"exchanges"));
            el('admExchList').innerHTML=eSnap.docs.map(d=>`<div class="p-3 bg-white/5 border border-white/10 rounded flex justify-between items-center"><span class="font-bold text-white">${d.data().name}</span><button onclick="delDoc('exchanges','${d.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div>`).join('');
            
            if(globalConfig){
                el('cfgGhToken').value=globalConfig.ghToken||''; el('cfgGhUser').value=globalConfig.ghUser||''; el('cfgGhRepo').value=globalConfig.ghRepo||''; el('cfgGhPath').value=globalConfig.ghPath||'';
                el('cfgBankCode').value=globalConfig.bankCode||''; el('cfgBankNum').value=globalConfig.bankNum||''; el('cfgBankName').value=globalConfig.bankName||''; el('cfgWallet').value=globalConfig.wallet||'';
            }
        }

        // --- ADMIN ACTIONS ---
        window.approveOrder = async(oid, cid) => {
            const c = await getDoc(doc(db,"courses",cid));
            await updateDoc(doc(db,"orders",oid), {status:'approved', groupLink: c.exists()?c.data().groupLink:'#'});
            toast("ƒê√£ duy·ªát ƒë∆°n h√†ng!"); loadAdminData();
        }
        window.approveRefund = async(rid) => {
            await updateDoc(doc(db,"refund_requests",rid), {status:'approved'});
            toast("ƒê√£ x√°c minh UID!"); loadAdminData();
        }
        
        // --- INPUT AUTO FORMAT (ADMIN COURSE PRICE) ---
        el('cPrice').addEventListener('input', function(e) {
            // L·∫•y gi√° tr·ªã hi·ªán t·∫°i, b·ªè h·∫øt k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
            let rawValue = this.value.replace(/\D/g, '');
            if (rawValue) {
                // Format l·∫°i th√†nh ti·ªÅn t·ªá v√† g√°n l·∫°i v√†o √¥ input
                this.value = formatVND(rawValue);
            }
        });

        // --- SAVE FUNCTIONS ---
        el('formCourse').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await addDoc(collection(db,"courses"), {
                name: el('cName').value, price: el('cPrice').value, desc: el('cDesc').value, groupLink: el('cGroupLink').value, benefits: el('cBenefits').value
            }); toast("ƒê√£ th√™m kh√≥a!"); el('formCourse').reset(); loadAdminData(); loadSite();
        });
        el('formExchange').addEventListener('submit', async(e)=>{
            e.preventDefault();
            await addDoc(collection(db,"exchanges"),{name:el('exName').value, link:el('exLink').value, rate:el('exRate').value});
            toast("ƒê√£ th√™m s√†n!"); el('formExchange').reset(); loadAdminData(); loadSite();
        });
        window.saveConfig = async()=>{
            await setDoc(doc(db,"settings","config"),{
                ghToken:el('cfgGhToken').value, ghUser:el('cfgGhUser').value, ghRepo:el('cfgGhRepo').value, ghPath:el('cfgGhPath').value,
                bankCode:el('cfgBankCode').value, bankNum:el('cfgBankNum').value, bankName:el('cfgBankName').value, wallet:el('cfgWallet').value
            }); toast("ƒê√£ l∆∞u config!");
        }
        window.saveSocials = async()=>{
            await setDoc(doc(db,"site_content","socials"),{fb:el('socFb').value, tele:el('socTele').value, tiktok:el('socTiktok').value, yt:el('socYt').value}); toast("Saved!"); loadSite();
        }
        window.saveProfile = async()=>{
            await setDoc(doc(db,"site_content","profile"),{name:el('admPName').value, bio:el('admPBio').value, avatar:el('admPAvatar').value, verified:true}); toast("Saved!"); loadSite();
        }
        window.delDoc = async(c,id)=>{ if(confirm("X√≥a?")){await deleteDoc(doc(db,c,id)); loadAdminData(); loadSite();} }
        window.closeCheckout = ()=>el('checkoutModal').classList.add('hidden');
        window.previewBill = ()=>{if(el('billFile').files[0]) el('fileName').innerText=el('billFile').files[0].name;}
        window.copyToClipboard = (id)=>{navigator.clipboard.writeText(el(id).innerText); toast("Copied!");}

        AOS.init(); loadSite();
    </script>
</body>
</html>
