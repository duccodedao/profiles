
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng T·∫£i l√™n & Qu·∫£n tr·ªã</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .hidden { display: none; }
        .btn { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px 0; }
        .btn-logout { background: #dc3545; }
        #admin-panel { background: #f8f9fa; border: 2px solid #333; padding: 15px; margin-top: 20px; }
        .data-item { border-bottom: 1px solid #ccc; padding: 10px; }
        img { max-width: 100px; display: block; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>H·ªá th·ªëng D·ªØ li·ªáu</h1>

    <!-- M√†n h√¨nh ƒêƒÉng nh·∫≠p -->
    <div id="login-screen">
        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</p>
        <button class="btn" onclick="loginGoogle()">ƒêƒÉng nh·∫≠p b·∫±ng Google</button>
    </div>

    <!-- M√†n h√¨nh Ch√≠nh (User) -->
    <div id="user-screen" class="hidden">
        <p>Xin ch√†o, <span id="username"></span>!</p>
        
        <h3>1. G·ª≠i ·∫¢nh</h3>
        <input type="file" id="file-input" multiple>
        <button class="btn" onclick="uploadFiles()">T·∫£i ·∫£nh l√™n Server</button>

        <h3>2. G·ª≠i Danh b·∫° (ƒê√£ ch·ªçn)</h3>
        <button class="btn" onclick="shareContacts()">Ch·ªçn & G·ª≠i Danh B·∫°</button>
        
        <br><br>
        <button class="btn btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>

    <!-- M√†n h√¨nh Admin (Ch·ªâ hi·ªán n·∫øu ƒë√∫ng UID) -->
    <div id="admin-panel" class="hidden">
        <h2>üëë ADMIN PANEL</h2>
        <p>Danh s√°ch d·ªØ li·ªáu t·ª´ t·∫•t c·∫£ ng∆∞·ªùi d√πng:</p>
        <div id="admin-data-list">Loading...</div>
        <button class="btn" onclick="loadAdminData()">L√†m m·ªõi d·ªØ li·ªáu</button>
    </div>

    <!-- T√≠ch h·ª£p Firebase (S·ª≠ d·ª•ng phi√™n b·∫£n CDN module) -->
    <script type="module">
        // --- C·∫§U H√åNH FIREBASE (THAY TH·∫æ B·∫∞NG C·ª¶A B·∫†N) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };

        // Kh·ªüi t·∫°o
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

        // --- X·ª¨ L√ù AUTH ---
        window.loginGoogle = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => alert(err.message));
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('user-screen').classList.remove('hidden');
                document.getElementById('username').innerText = user.displayName;

                // Ki·ªÉm tra n·∫øu l√† Admin
                if (user.uid === ADMIN_UID) {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    loadAdminData();
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('user-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        });

        // --- CH·ª®C NƒÇNG USER: T·∫¢I ·∫¢NH ---
        window.uploadFiles = async () => {
            const files = document.getElementById('file-input').files;
            if (files.length === 0) return alert("Ch∆∞a ch·ªçn file!");

            const user = auth.currentUser;
            for (let file of files) {
                try {
                    // Upload l√™n Storage
                    const storageRef = ref(storage, `uploads/${user.uid}/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);

                    // L∆∞u link v√†o Firestore
                    await addDoc(collection(db, "uploads"), {
                        type: "image",
                        url: url,
                        userEmail: user.email,
                        userName: user.displayName,
                        timestamp: Date.now()
                    });
                } catch (e) { console.error(e); }
            }
            alert("ƒê√£ g·ª≠i ·∫£nh th√†nh c√¥ng!");
        };

        // --- CH·ª®C NƒÇNG USER: G·ª¨I DANH B·∫† ---
        window.shareContacts = async () => {
            if (!('contacts' in navigator && 'ContactsManager' in window)) {
                return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ l·∫•y danh b·∫°.");
            }
            try {
                const contacts = await navigator.contacts.select(['name', 'tel'], { multiple: true });
                const user = auth.currentUser;
                
                // L∆∞u danh b·∫° v√†o Firestore
                await addDoc(collection(db, "uploads"), {
                    type: "contact",
                    data: contacts,
                    userEmail: user.email,
                    timestamp: Date.now()
                });
                alert("ƒê√£ g·ª≠i danh b·∫° th√†nh c√¥ng!");
            } catch (err) {
                console.error(err);
            }
        };

        // --- CH·ª®C NƒÇNG ADMIN: XEM D·ªÆ LI·ªÜU ---
        window.loadAdminData = async () => {
            const listDiv = document.getElementById('admin-data-list');
            listDiv.innerHTML = "ƒêang t·∫£i...";
            
            try {
                const q = query(collection(db, "uploads"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                listDiv.innerHTML = "";
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let contentHtml = "";

                    if (data.type === 'image') {
                        contentHtml = `<img src="${data.url}" alt="User Image">`;
                    } else if (data.type === 'contact') {
                        contentHtml = `<pre>${JSON.stringify(data.data, null, 2)}</pre>`;
                    }

                    const date = new Date(data.timestamp).toLocaleString();
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    item.innerHTML = `
                        <strong>User:</strong> ${data.userEmail} <br>
                        <small>${date}</small> <br>
                        ${contentHtml}
                    `;
                    listDiv.appendChild(item);
                });
            } catch (e) {
                listDiv.innerHTML = "L·ªói t·∫£i d·ªØ li·ªáu (C√≥ th·ªÉ b·∫°n kh√¥ng ph·∫£i Admin ho·∫∑c ch∆∞a setup Rules): " + e.message;
            }
        };
    </script>
</body>
</html>
