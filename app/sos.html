
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá th·ªëng C·ª©u H·ªô & C·∫£nh B√°o 2025 (Plus)</title>

    <!-- 1. TH∆Ø VI·ªÜN (LIBRARIES) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- FIREBASE (V9 Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- LEAFLET MAP -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Map Marker & Pulse */
        .avatar-marker {
            width: 48px; height: 48px; border-radius: 50%; border: 3px solid white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); overflow: hidden; background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .avatar-marker:hover { transform: scale(1.2) translateY(-5px); z-index: 999; border-color: #3b82f6; }
        
        .sos-pulse { animation: pulse-red 2s infinite; border-color: #ef4444; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 25px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Animations */
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col md:flex-row text-slate-800">

    <!-- === 0. GLOBAL COMPONENTS === -->
    <div id="loading" class="fixed inset-0 bg-white/80 z-[9000] flex flex-col items-center justify-center hidden backdrop-blur-sm fade-in">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center font-bold text-blue-600 text-xs">LOADING</div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-[9999] space-y-3 pointer-events-none transition-all duration-300"></div>

    <!-- Custom Dialog -->
    <div id="custom-dialog" class="fixed inset-0 bg-slate-900/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4" id="dialog-icon-bg">
                <i class="fas fa-info-circle text-blue-600 text-xl" id="dialog-icon"></i>
            </div>
            <h3 class="text-lg font-bold text-center text-slate-900 mb-2" id="dialog-title">Th√¥ng b√°o</h3>
            <p class="text-sm text-gray-500 text-center mb-6" id="dialog-msg">N·ªôi dung</p>
            <div class="flex gap-3" id="dialog-actions"></div>
        </div>
    </div>

    <!-- === 1. LOGIN SCREEN === -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[8000] flex items-center justify-center p-6 bg-[url('https://images.unsplash.com/photo-1454789476662-53eb23ba5907?q=80&w=1952')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
        <div class="relative bg-white/95 backdrop-blur-xl rounded-3xl p-8 w-full max-w-md shadow-2xl text-center border border-white/20">
            <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/40 -rotate-6">
                <i class="fas fa-shield-heart text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-black text-slate-800 mb-1">C·ª®U H·ªò 2025</h1>
            <p class="text-slate-500 mb-8 text-sm font-medium">K·∫øt n·ªëi c·ªông ƒë·ªìng - ·ª®ng c·ª©u kh·∫©n c·∫•p</p>
            <button onclick="loginWithGoogle()" class="w-full bg-white hover:bg-slate-50 text-slate-700 font-bold py-4 rounded-xl flex items-center justify-center gap-3 shadow-md border border-slate-200 transition transform hover:scale-[1.02]">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6"> Ti·∫øp t·ª•c v·ªõi Google
            </button>
        </div>
    </div>

    <!-- === 2. SIDEBAR === -->
    <div class="w-full md:w-[450px] bg-white flex flex-col shadow-2xl z-[1000] order-2 md:order-1 h-[60vh] md:h-full relative border-r border-slate-200">
        <!-- Header -->
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500 rounded-full blur-[60px] opacity-20 pointer-events-none"></div>
            <div class="flex items-center gap-3 relative z-10 cursor-pointer" onclick="openProfileModal()">
                <div class="relative">
                    <img id="user-avatar" src="" class="w-11 h-11 rounded-full border-2 border-slate-700 bg-slate-600 object-cover">
                    <div id="verified-badge-mini" class="absolute -bottom-1 -right-1 bg-green-500 text-white rounded-full p-1 border-2 border-slate-900 text-[8px] hidden"><i class="fas fa-check"></i></div>
                </div>
                <div>
                    <h2 id="user-name" class="font-bold text-sm truncate max-w-[140px] text-white">Loading...</h2>
                    <span class="text-[10px] text-slate-400 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online</span>
                </div>
            </div>
            <div class="flex gap-2 relative z-10">
                <button onclick="openProfileModal()" class="w-9 h-9 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 transition flex items-center justify-center"><i class="fas fa-user-cog"></i></button>
                <button onclick="logout()" class="w-9 h-9 rounded-full bg-slate-800 hover:bg-rose-600 text-slate-300 hover:text-white transition flex items-center justify-center"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex bg-white shrink-0 shadow-sm z-10 border-b border-slate-100">
            <button onclick="switchTab('warning')" id="tab-warning" class="flex-1 py-4 text-[11px] font-bold uppercase border-b-[3px]">C·∫£nh B√°o <span id="cnt-warning" class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded text-[9px]">0</span></button>
            <button onclick="switchTab('sos')" id="tab-sos" class="flex-1 py-4 text-[11px] font-bold uppercase border-b-[3px]">SOS <span id="cnt-sos" class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded text-[9px]">0</span></button>
            <button onclick="switchTab('units')" id="tab-units" class="flex-1 py-4 text-[11px] font-bold uppercase border-b-[3px]">ƒê∆°n v·ªã <span id="cnt-units" class="ml-1 bg-slate-100 px-1.5 py-0.5 rounded text-[9px]">0</span></button>
            <button onclick="switchTab('my')" id="tab-my" class="flex-1 py-4 text-[11px] font-bold uppercase border-b-[3px] text-slate-500 hover:text-blue-600"><i class="fas fa-folder-open mr-1"></i> Qu·∫£n l√Ω</button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-3 bg-slate-50 relative custom-scrollbar">
            <!-- Search & Filter -->
            <div id="search-container" class="sticky top-0 bg-slate-50/95 backdrop-blur py-2 z-10">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                    <input type="text" id="main-search" onkeyup="renderCurrentTab()" placeholder="T√¨m theo t√™n, ƒë·ªãa danh..." class="w-full text-sm border border-slate-200 rounded-xl pl-9 pr-4 py-2.5 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                </div>
                <!-- Excel Import (Only visible on Units tab) -->
                <div id="excel-tools" class="hidden flex gap-2 mt-2">
                    <button onclick="downloadExcelTemplate()" class="flex-1 text-[10px] bg-white border border-slate-200 text-slate-600 py-2 rounded-lg font-bold hover:bg-slate-50 shadow-sm"><i class="fas fa-download mr-1"></i> T·∫£i m·∫´u</button>
                    <button onclick="document.getElementById('excel-input').click()" class="flex-1 text-[10px] bg-emerald-50 border border-emerald-200 text-emerald-700 py-2 rounded-lg font-bold hover:bg-emerald-100 shadow-sm"><i class="fas fa-file-excel mr-1"></i> Import Excel</button>
                    <input type="file" id="excel-input" accept=".xlsx" class="hidden" onchange="importExcel(event)">
                </div>
            </div>

            <div id="list-warning" class="space-y-3 mt-2 pb-24"></div>
            <div id="list-sos" class="hidden space-y-3 mt-2 pb-24"></div>
            <div id="list-units" class="hidden space-y-3 mt-2 pb-24"></div>
            <div id="list-my" class="hidden space-y-4 mt-2 pb-24"></div>
        </div>

        <!-- FAB -->
        <button onclick="openCreateModal()" id="fab" class="absolute bottom-6 right-6 w-14 h-14 bg-gradient-to-tr from-yellow-400 to-orange-500 text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition z-[1001] border-4 border-white">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- === 3. MAP === -->
    <div class="flex-1 relative order-1 md:order-2 h-[45vh] md:h-full border-l border-slate-200 bg-slate-100">
        <div id="map" class="w-full h-full z-0 outline-none"></div>
        <button onclick="locateUser()" class="absolute bottom-6 right-6 bg-white text-slate-700 w-12 h-12 rounded-xl shadow-lg hover:text-blue-600 z-[900] transition flex items-center justify-center hover:scale-105 active:scale-95"><i class="fas fa-crosshairs text-xl"></i></button>
        <div id="map-picker-hint" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl z-[9999] hidden flex items-center gap-4 animate-bounce cursor-pointer" onclick="cancelPick()">
            <i class="fas fa-map-marker-alt text-yellow-400"></i> <span class="text-sm font-bold">Ch·∫°m b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠</span> <span class="text-xs bg-white/20 px-2 py-0.5 rounded hover:bg-red-500 transition">H·ªßy</span>
        </div>
    </div>

    <!-- === 4. DETAIL MODAL === -->
    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] slide-up">
            <div class="h-32 bg-slate-800 relative shrink-0">
                <div id="detail-map-bg" class="absolute inset-0 bg-cover bg-center opacity-40"></div>
                <button onclick="closeDetail()" class="absolute top-3 right-3 w-8 h-8 bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur hover:bg-black/60">&times;</button>
                <div class="absolute bottom-3 left-4"><div id="detail-badge" class="px-3 py-1 rounded-lg text-[10px] font-bold uppercase bg-white/20 text-white backdrop-blur border border-white/30">LO·∫†I TIN</div></div>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <h2 id="detail-title" class="text-xl font-black text-slate-800 mb-1">Ti√™u ƒë·ªÅ</h2>
                <div class="flex items-center gap-3 text-xs text-slate-500 mb-4">
                    <span id="detail-time"></span> ‚Ä¢ <span id="detail-dist" class="text-blue-600 font-bold"></span>
                </div>
                
                <!-- Status & Address -->
                <div class="space-y-3">
                    <div id="verification-status" class="hidden p-3 rounded-xl border flex items-center gap-3"></div>
                    
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex gap-2 items-start">
                        <i class="fas fa-map-marker-alt text-red-500 mt-1"></i>
                        <div>
                            <div class="text-[10px] font-bold text-slate-400 uppercase">Khu v·ª±c / ƒê·ªãa ch·ªâ</div>
                            <div id="detail-address" class="text-sm font-medium text-slate-800"></div>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 uppercase mb-2">M√¥ t·∫£ chi ti·∫øt</div>
                        <p id="detail-desc" class="text-sm text-slate-700 whitespace-pre-wrap"></p>
                    </div>

                    <!-- Contact List -->
                    <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                        <div class="text-[10px] font-bold text-blue-400 uppercase mb-3">Th√¥ng tin li√™n h·ªá</div>
                        <div class="flex items-center gap-2 mb-3">
                            <img id="detail-avatar" class="w-8 h-8 rounded-full">
                            <span id="detail-author" class="text-sm font-bold text-blue-900"></span>
                        </div>
                        <div id="contact-list" class="space-y-2">
                            <!-- JS injected phones -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-white flex gap-3 shrink-0">
                <button id="btn-nav" class="flex-1 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2"><i class="fas fa-directions text-blue-500"></i> D·∫´n ƒë∆∞·ªùng</button>
                <div id="owner-actions" class="flex items-center gap-3 hidden">
                    <button onclick="editCurrentItem()" class="bg-blue-100 text-blue-600 p-3 rounded-xl hover:bg-blue-200"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteCurrentItem()" class="bg-rose-100 text-rose-600 p-3 rounded-xl hover:bg-rose-200"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- === 5. PROFILE MODAL === -->
    <div id="profile-modal" class="fixed inset-0 bg-slate-900/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">H·ªì S∆°</h3>
                <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200">&times;</button>
            </div>
            <div class="text-center mb-4">
                <img id="profile-img" class="w-20 h-20 rounded-full mx-auto mb-2 border-4 border-slate-50">
                <div id="profile-email" class="text-xs text-slate-400"></div>
                <div id="verification-badge-profile" class="mt-1 text-[10px] inline-block font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-500">Checking...</div>
            </div>
            <div class="space-y-3">
                <input type="text" id="profile-name" class="w-full border border-slate-200 rounded-xl px-4 py-2 text-sm focus:border-blue-500 outline-none" placeholder="T√™n hi·ªÉn th·ªã">
                <input type="tel" id="profile-phone" class="w-full border border-slate-200 rounded-xl px-4 py-2 text-sm focus:border-blue-500 outline-none" placeholder="S·ªë ƒëi·ªán tho·∫°i ch√≠nh">
                <div id="email-verify-box" class="hidden bg-orange-50 p-2 rounded-lg border border-orange-100 flex justify-between items-center">
                    <span class="text-[10px] text-orange-800">Email ch∆∞a x√°c th·ª±c</span>
                    <button onclick="sendVerificationEmail()" class="text-[10px] bg-orange-500 text-white px-2 py-1 rounded font-bold">G·ª≠i mail</button>
                </div>
                <button onclick="saveProfile()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800">L∆∞u Thay ƒê·ªïi</button>
            </div>
        </div>
    </div>

    <!-- === 6. CREATE / EDIT MODAL (UPDATED) === -->
    <div id="create-modal" class="fixed inset-0 bg-slate-900/60 z-[9999] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-lg h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-3xl sm:rounded-2xl flex flex-col shadow-2xl overflow-hidden slide-up">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <h2 id="modal-title" class="font-black text-lg text-slate-800">ƒêƒÇNG TIN</h2>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600">&times;</button>
            </div>
            
            <div class="p-5 overflow-y-auto space-y-5 custom-scrollbar bg-white">
                <!-- Location Picker -->
                <div class="bg-blue-50 border border-blue-200 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-blue-100 transition" onclick="startPickLocation()">
                    <div>
                        <div class="text-[10px] font-bold text-blue-500 uppercase">V·ªã tr√≠ b·∫£n ƒë·ªì (GPS)</div>
                        <div id="loc-text" class="text-sm font-bold text-slate-700 mt-0.5"><i class="fas fa-crosshairs"></i> V·ªã tr√≠ hi·ªán t·∫°i</div>
                    </div>
                    <div class="w-8 h-8 bg-white text-blue-600 rounded-full flex items-center justify-center shadow-sm"><i class="fas fa-map-marked-alt"></i></div>
                </div>

                <!-- NEW: Admin Units Selectors -->
                <div class="space-y-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Khu v·ª±c h√†nh ch√≠nh (B·∫Øt bu·ªôc)</div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="sel-province" onchange="loadDistricts()" class="w-full border border-slate-200 rounded-lg p-2 text-xs bg-white outline-none"><option value="">-- T·ªânh / Th√†nh --</option></select>
                        <select id="sel-district" onchange="loadWards()" class="w-full border border-slate-200 rounded-lg p-2 text-xs bg-white outline-none" disabled><option value="">-- Qu·∫≠n / Huy·ªán --</option></select>
                    </div>
                    <select id="sel-ward" class="w-full border border-slate-200 rounded-lg p-2 text-xs bg-white outline-none" disabled><option value="">-- Ph∆∞·ªùng / X√£ --</option></select>
                </div>

                <!-- Dynamic Forms -->
                <div id="form-container"></div>

                <!-- NEW: Dynamic Phones -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-[11px] font-bold text-slate-400 uppercase">S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá</label>
                        <button onclick="addPhoneInput()" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 font-bold hover:bg-blue-100">+ Th√™m s·ªë</button>
                    </div>
                    <div id="phones-container" class="space-y-2">
                        <!-- Default Input -->
                        <div class="phone-entry flex gap-2">
                            <input type="tel" class="phone-val w-full border border-slate-200 rounded-xl px-3 py-2.5 text-sm font-bold outline-none focus:border-blue-500" placeholder="S·ªë ch√≠nh (vd: 0912...)">
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label class="text-[11px] font-bold text-slate-400 uppercase block mb-1">M√¥ t·∫£ chi ti·∫øt</label>
                    <textarea id="inp-desc" rows="3" class="w-full border border-slate-200 rounded-xl p-3 text-sm outline-none focus:border-blue-500" placeholder="M√¥ t·∫£ s·ª± vi·ªác, s·ªë nh√†, ng√µ ng√°ch..."></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-white shrink-0">
                <button onclick="submitData()" id="btn-submit" class="w-full py-3.5 rounded-xl text-white font-bold shadow-lg bg-blue-600 hover:bg-blue-700 transition uppercase tracking-wide">G·ª≠i Ngay</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // CONFIG
     const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };
        const ADMIN_API = "https://provinces.open-api.vn/api/";

        // STATE
        let auth, db, map, markersGroup, currentUser, userMarker, tempMarker;
        let currentLocation = { lat: 21.0285, lng: 105.8542 };
        let pickedLocation = null;
        let isPickingMode = false, isEditMode = false, editingItem = null;
        let currentTab = 'warning';
        let allData = { warnings: [], sos: [], units: [] };
        
        // ADMIN UNITS DATA
        let provinces = [], districts = [], wards = [];

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            if(firebaseConfig.apiKey.includes("xxxx")) alert("VUI L√íNG ƒêI·ªÄN API KEY FIREBASE V√ÄO CODE!");
            else {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                checkAuth();
                fetchProvinces(); // Load Admin Units
            }
        });

        // --- LOCATION API HELPER ---
        async function fetchProvinces() {
            try {
                const r = await fetch(ADMIN_API + "?depth=1");
                provinces = await r.json();
                renderSelect('sel-province', provinces);
            } catch(e) { console.error("API Error", e); }
        }
        async function loadDistricts() {
            const pCode = document.getElementById('sel-province').value;
            const dSel = document.getElementById('sel-district');
            const wSel = document.getElementById('sel-ward');
            dSel.innerHTML = '<option value="">ƒêang t·∫£i...</option>'; dSel.disabled = true;
            wSel.innerHTML = '<option value="">-- Ph∆∞·ªùng / X√£ --</option>'; wSel.disabled = true;
            
            if(!pCode) { dSel.innerHTML = '<option value="">-- Qu·∫≠n / Huy·ªán --</option>'; return; }
            
            try {
                const r = await fetch(`${ADMIN_API}p/${pCode}?depth=2`);
                const data = await r.json();
                districts = data.districts;
                renderSelect('sel-district', districts);
                dSel.disabled = false;
            } catch(e) {}
        }
        async function loadWards() {
            const dCode = document.getElementById('sel-district').value;
            const wSel = document.getElementById('sel-ward');
            wSel.innerHTML = '<option value="">ƒêang t·∫£i...</option>'; wSel.disabled = true;
            
            if(!dCode) { wSel.innerHTML = '<option value="">-- Ph∆∞·ªùng / X√£ --</option>'; return; }

            try {
                const r = await fetch(`${ADMIN_API}d/${dCode}?depth=2`);
                const data = await r.json();
                wards = data.wards;
                renderSelect('sel-ward', wards);
                wSel.disabled = false;
            } catch(e) {}
        }
        function renderSelect(id, data) {
            const el = document.getElementById(id);
            const defaultTxt = id.includes('province')?'T·ªânh / Th√†nh':(id.includes('district')?'Qu·∫≠n / Huy·ªán':'Ph∆∞·ªùng / X√£');
            el.innerHTML = `<option value="">-- ${defaultTxt} --</option>` + data.map(i => `<option value="${i.code}">${i.name}</option>`).join('');
        }
        function getNameFromCode(arr, code) { const f = arr.find(i=>i.code == code); return f ? f.name : ''; }

        // --- UI HELPERS ---
        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const el = document.createElement('div');
            const color = type==='error'?'bg-rose-500':(type==='success'?'bg-emerald-500':'bg-slate-800');
            el.className = `${color} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 text-xs font-bold fade-in`;
            el.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
            c.appendChild(el);
            setTimeout(()=>el.remove(), 3000);
        }
        function customDialog(t, m, type, cb) {
            const d = document.getElementById('custom-dialog');
            document.getElementById('dialog-title').innerText=t; document.getElementById('dialog-msg').innerText=m;
            document.getElementById('dialog-actions').innerHTML = type==='confirm' ? 
                `<button onclick="document.getElementById('custom-dialog').classList.add('hidden')" class="flex-1 py-2 border rounded-xl font-bold text-slate-500">H·ªßy</button>
                 <button id="dia-ok" class="flex-1 py-2 bg-blue-600 text-white rounded-xl font-bold">OK</button>` :
                `<button onclick="document.getElementById('custom-dialog').classList.add('hidden')" class="w-full py-2 bg-slate-800 text-white rounded-xl font-bold">ƒê√≥ng</button>`;
            if(type==='confirm') document.getElementById('dia-ok').onclick = () => { cb(); document.getElementById('custom-dialog').classList.add('hidden'); };
            d.classList.remove('hidden');
        }

        // --- AUTH & PROFILE ---
        function checkAuth() {
            auth.onAuthStateChanged(async (u) => {
                if (u) {
                    currentUser = u;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('user-avatar').src = u.photoURL;
                    
                    const doc = await db.collection('users').doc(u.uid).get();
                    if(doc.exists) {
                        const d = doc.data();
                        currentUser.phone = d.phone; currentUser.customName = d.name;
                        document.getElementById('user-name').innerText = d.name || u.displayName;
                    } else document.getElementById('user-name').innerText = u.displayName;
                    
                    updateVerifyBadge();
                    if(!currentUser.phone) openProfileModal();
                    initMap();
                } else document.getElementById('login-screen').classList.remove('hidden');
            });
        }
        function updateVerifyBadge() {
            const v = currentUser.emailVerified || (currentUser.phone && currentUser.phone.length > 9);
            document.getElementById('verified-badge-mini').classList.toggle('hidden', !v);
        }
        function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>showToast(e.message,'error')); }
        function logout() { customDialog("ƒêƒÉng xu·∫•t?", "B·∫°n ch·∫Øc ch·ª©?", "confirm", ()=>auth.signOut()); }
        function openProfileModal() {
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-name').value = currentUser.customName || currentUser.displayName;
            document.getElementById('profile-phone').value = currentUser.phone || "";
            document.getElementById('profile-email').innerText = currentUser.email;
            document.getElementById('profile-img').src = currentUser.photoURL;
            
            const isV = currentUser.emailVerified;
            const b = document.getElementById('verification-badge-profile');
            b.className = isV ? "mt-1 text-[10px] inline-block font-bold px-2 py-0.5 rounded bg-emerald-100 text-emerald-600" : "mt-1 text-[10px] inline-block font-bold px-2 py-0.5 rounded bg-orange-100 text-orange-600";
            b.innerText = isV ? "ƒê√£ x√°c minh Email" : "Ch∆∞a x√°c minh Email";
            document.getElementById('email-verify-box').classList.toggle('hidden', isV);
        }
        async function saveProfile() {
            try {
                const n = document.getElementById('profile-name').value;
                const p = document.getElementById('profile-phone').value;
                await db.collection('users').doc(currentUser.uid).set({name:n, phone:p, email:currentUser.email, photo:currentUser.photoURL},{merge:true});
                currentUser.customName = n; currentUser.phone = p;
                document.getElementById('user-name').innerText = n;
                updateVerifyBadge();
                document.getElementById('profile-modal').classList.add('hidden');
                showToast("ƒê√£ l∆∞u h·ªì s∆°", "success");
            } catch(e){ showToast(e.message,'error'); }
        }
        function sendVerificationEmail() { currentUser.sendEmailVerification().then(()=>showToast("ƒê√£ g·ª≠i email, h√£y check inbox!", "success")).catch(e=>showToast(e.message,'error')); }

        // --- MAP & DATA ---
        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl:false}).setView([currentLocation.lat, currentLocation.lng], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            markersGroup = L.layerGroup().addTo(map);
            
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    currentLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
                    if(userMarker) map.removeLayer(userMarker);
                    userMarker = L.marker(currentLocation, {icon: L.divIcon({html:`<div class="w-4 h-4 bg-blue-600 border-2 border-white rounded-full shadow-lg shadow-blue-500/50 animate-pulse"></div>`, className:''})}).addTo(map);
                }, null, {enableHighAccuracy:true});
            }

            map.on('click', (e) => {
                if(isPickingMode) {
                    pickedLocation = e.latlng;
                    if(tempMarker) map.removeLayer(tempMarker);
                    tempMarker = L.marker(pickedLocation).addTo(map);
                    isPickingMode = false;
                    document.getElementById('map-picker-hint').classList.add('hidden');
                    document.getElementById('create-modal').classList.remove('hidden');
                    document.getElementById('loc-text').innerHTML = `<span class="text-blue-600 font-bold">${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}</span>`;
                }
            });

            ['warnings','sos','units'].forEach(c => listenData(c));
        }

        function listenData(col) {
            db.collection(col).orderBy('timestamp', 'desc').onSnapshot(snap => {
                allData[col] = snap.docs.map(d => ({id:d.id, col:col, ...d.data()}));
                document.getElementById('cnt-'+(col==='warnings'?'warning':col)).innerText = allData[col].length;
                renderCurrentTab();
                updateMarkers();
            });
        }

        // --- UI RENDER ---
        function switchTab(t) {
            currentTab = t;
            ['warning','sos','units','my'].forEach(k => {
                const btn = document.getElementById('tab-'+k);
                const div = document.getElementById('list-'+(k==='warning'?'warning':k)); // Fix ID mapping logic
                // Reset styling
                btn.className = "flex-1 py-4 text-[11px] font-bold uppercase border-b-[3px] border-transparent text-slate-400";
                
                if(k === t) {
                    btn.className = `flex-1 py-4 text-[11px] font-bold uppercase border-b-[3px] ${t==='sos'?'border-rose-500 text-rose-600':(t==='units'?'border-blue-500 text-blue-600':(t==='my'?'border-slate-800 text-slate-800':'border-yellow-500 text-yellow-700'))}`;
                }
            });
            
            // Show/Hide Containers
            document.getElementById('list-warning').classList.toggle('hidden', t!=='warning');
            document.getElementById('list-sos').classList.toggle('hidden', t!=='sos');
            document.getElementById('list-units').classList.toggle('hidden', t!=='units');
            document.getElementById('list-my').classList.toggle('hidden', t!=='my');
            
            // Special UI for Units tab
            document.getElementById('excel-tools').classList.toggle('hidden', t!=='units');
            document.getElementById('fab').classList.toggle('hidden', t==='my');
            
            renderCurrentTab();
        }

        function renderCurrentTab() {
            const key = document.getElementById('main-search').value.toLowerCase();
            if(currentTab === 'my') { renderMyItems(); return; }
            
            const arr = currentTab==='warning'?allData.warnings:(currentTab==='sos'?allData.sos:allData.units);
            const filtered = arr.filter(i => {
                // Search in: Type, Name, Desc, Address fields
                const txt = `${i.type} ${i.name} ${i.desc} ${i.addrStr||''}`.toLowerCase();
                return txt.includes(key);
            }).sort((a,b) => {
                if(currentTab==='sos') return (b.urgency||0)-(a.urgency||0);
                return getDist(a.lat,a.lng) - getDist(b.lat,b.lng);
            });

            const divId = currentTab==='warning'?'list-warning':(currentTab==='sos'?'list-sos':'list-units');
            document.getElementById(divId).innerHTML = filtered.map(createCard).join('') || `<div class="text-center py-10 text-slate-300 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</div>`;
        }

        function createCard(i) {
            const dist = getDist(i.lat, i.lng);
            const color = i.col==='sos'?'border-rose-500':(i.col==='warnings'?'border-yellow-500':'border-blue-500');
            const isVerified = (i.phone && i.phone.length > 9); // Simple check
            const addrDisplay = i.addrStr ? `<div class="text-[10px] text-slate-400 mt-1 truncate"><i class="fas fa-map-marker-alt text-xs mr-1"></i>${i.addrStr}</div>` : '';
            
            return `
            <div onclick="focusItem(${i.lat}, ${i.lng}, '${i.col}', '${i.id}')" class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${color} hover:shadow-lg transition cursor-pointer mb-3">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <img src="${i.userPhoto||'https://ui-avatars.com/api/?name='+i.creatorName}" class="w-8 h-8 rounded-full border">
                        <div>
                            <div class="text-xs font-bold text-slate-800">${i.creatorName} ${isVerified?'<i class="fas fa-check-circle text-emerald-500 text-[10px]"></i>':''}</div>
                            <div class="text-[9px] text-slate-400">${timeAgo(i.timestamp)}</div>
                        </div>
                    </div>
                    <span class="text-[10px] font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-600">${dist} km</span>
                </div>
                <h4 class="font-bold text-sm text-slate-800 ${i.col==='sos'?'text-rose-600 uppercase':''}">${i.type||i.name}</h4>
                ${addrDisplay}
                <p class="text-xs text-slate-500 line-clamp-2 mt-1">${i.desc}</p>
            </div>`;
        }
        
        function renderMyItems() {
            const gen = (arr) => arr.filter(i=>i.uid===currentUser.uid).map(i => `
                <div class="bg-white p-3 rounded-xl border border-slate-200 flex justify-between items-center" onclick="focusItem(${i.lat}, ${i.lng}, '${i.col}', '${i.id}')">
                    <div class="flex items-center gap-3">
                        <div class="w-1 h-8 rounded-full ${i.col==='sos'?'bg-rose-500':(i.col==='warnings'?'bg-yellow-500':'bg-blue-500')}"></div>
                        <div>
                            <div class="font-bold text-xs text-slate-800">${i.type||i.name}</div>
                            <div class="text-[10px] text-slate-400">${timeAgo(i.timestamp)}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="event.stopPropagation(); editItem('${i.col}','${i.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded"><i class="fas fa-edit"></i></button>
                        <button onclick="event.stopPropagation(); deleteItem('${i.col}','${i.id}')" class="p-2 text-rose-500 hover:bg-rose-50 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
            
            document.getElementById('list-my').innerHTML = `
                ${allData.warnings.some(i=>i.uid==currentUser.uid) ? `<h5 class="text-xs font-bold text-yellow-600">C·∫¢NH B√ÅO</h5>`+gen(allData.warnings) : ''}
                ${allData.sos.some(i=>i.uid==currentUser.uid) ? `<h5 class="text-xs font-bold text-rose-600 mt-2">SOS</h5>`+gen(allData.sos) : ''}
                ${allData.units.some(i=>i.uid==currentUser.uid) ? `<h5 class="text-xs font-bold text-blue-600 mt-2">ƒê∆†N V·ªä</h5>`+gen(allData.units) : ''}
            `;
        }

        function updateMarkers() {
            if(!map) return;
            markersGroup.clearLayers();
            const add = (arr, color, z) => arr.forEach(i => {
                const icon = L.divIcon({className:'', html:`<div class="avatar-marker ${i.col==='sos'?'sos-pulse':''}" style="border-color:${color}"><img src="${i.userPhoto}" class="w-full h-full object-cover"></div>`, iconSize:[48,48], iconAnchor:[24,48]});
                L.marker([i.lat,i.lng], {icon, zIndexOffset:z}).addTo(markersGroup).on('click', ()=>{
                    map.flyTo([i.lat,i.lng], 16); openDetail(i.col, i.id);
                });
            });
            add(allData.warnings, '#eab308', 100); add(allData.sos, '#ef4444', 1000); add(allData.units, '#3b82f6', 50);
        }

        // --- DETAIL & ACTION ---
        function focusItem(lat, lng, col, id) {
            map.flyTo([lat, lng], 16);
            setTimeout(()=>openDetail(col,id), 800);
        }
        function openDetail(col, id) {
            const item = allData[col].find(i=>i.id===id);
            if(!item) return;

            document.getElementById('detail-modal').classList.remove('hidden');
            const color = item.col==='sos'?'bg-rose-600':(item.col==='warnings'?'bg-yellow-500':'bg-blue-600');
            const badge = document.getElementById('detail-badge');
            badge.className = `px-3 py-1 rounded-lg text-[10px] font-bold uppercase text-white backdrop-blur border border-white/30 ${color}`;
            badge.innerText = item.col==='warnings'?'C·∫¢NH B√ÅO':(item.col==='sos'?'SOS KH·∫®N C·∫§P':'ƒê∆†N V·ªä H·ªñ TR·ª¢');
            
            document.getElementById('detail-title').innerText = item.type || item.name;
            document.getElementById('detail-desc').innerText = item.desc || "Kh√¥ng c√≥ m√¥ t·∫£";
            document.getElementById('detail-time').innerText = timeAgo(item.timestamp);
            document.getElementById('detail-dist').innerText = getDist(item.lat, item.lng) + ' km';
            document.getElementById('detail-author').innerText = item.creatorName;
            document.getElementById('detail-avatar').src = item.userPhoto;
            
            // Address Render
            document.getElementById('detail-address').innerText = item.addrStr || `GPS: ${item.lat.toFixed(5)}, ${item.lng.toFixed(5)}`;
            
            // Render Phones (Primary + Extras)
            const cList = document.getElementById('contact-list');
            cList.innerHTML = '';
            
            const allPhones = [item.phone, ...(item.extraPhones || [])].filter(p => p);
            
            if(allPhones.length > 0) {
                allPhones.forEach((p, idx) => {
                    const label = idx === 0 ? "SƒêT Ch√≠nh" : `SƒêT Ph·ª• ${idx}`;
                    cList.innerHTML += `
                        <a href="tel:${p}" class="block bg-white border border-slate-200 p-2.5 rounded-lg flex justify-between items-center hover:bg-emerald-50 hover:border-emerald-200 group transition">
                            <span class="text-xs font-bold text-slate-700">${label}: <span class="font-mono text-sm">${p}</span></span>
                            <span class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition"><i class="fas fa-phone"></i></span>
                        </a>`;
                });
                // document.getElementById('btn-call').href = `tel:${allPhones[0]}`; // Main CTA calls primary
            } else {
                cList.innerHTML = '<div class="text-xs text-slate-400 italic">Kh√¥ng c√≥ s·ªë ƒëi·ªán tho·∫°i</div>';
            }

            // Verification UI
            const isV = (item.phone && item.phone.length > 9);
            const vs = document.getElementById('verification-status');
            vs.classList.remove('hidden', 'bg-emerald-50', 'bg-orange-50');
            vs.className = `p-3 rounded-xl border flex items-center gap-3 ${isV?'bg-emerald-50 border-emerald-100':'bg-orange-50 border-orange-100'}`;
            vs.innerHTML = isV ? 
                `<div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600"><i class="fas fa-shield-alt"></i></div><div><div class="text-xs font-bold text-emerald-800">ƒê√£ x√°c minh</div><div class="text-[9px] text-emerald-600">Th√¥ng tin tin c·∫≠y</div></div>` : 
                `<div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i class="fas fa-exclamation-triangle"></i></div><div><div class="text-xs font-bold text-orange-800">Ch∆∞a ki·ªÉm ch·ª©ng</div><div class="text-[9px] text-orange-600">C·∫©n tr·ªçng l·ª´a ƒë·∫£o</div></div>`;

            // Owner Actions
            editingItem = item;
            const isOwner = currentUser && item.uid === currentUser.uid;
            document.getElementById('owner-actions').classList.toggle('hidden', !isOwner);
            document.getElementById('btn-nav').onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}`, '_blank');
        }

        function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); }
        function deleteCurrentItem() { deleteItem(editingItem.col, editingItem.id); closeDetail(); }
        function editCurrentItem() { editItem(editingItem.col, editingItem.id); }

        // --- CREATE / EDIT FORM ---
        function openCreateModal() {
            isEditMode = false; editingItem = null; pickedLocation = null;
            setupForm(currentTab==='my'?'warning':currentTab);
        }
        async function editItem(col, id) {
            closeDetail();
            isEditMode = true;
            const item = allData[col].find(i=>i.id===id);
            editingItem = { id, col, data: item };
            pickedLocation = { lat: item.lat, lng: item.lng };
            
            setupForm(col);
            document.getElementById('modal-title').innerText = "C·∫¨P NH·∫¨T TIN";
            document.getElementById('btn-submit').innerText = "L∆ØU THAY ƒê·ªîI";
            document.getElementById('inp-desc').value = item.desc;
            document.getElementById('loc-text').innerHTML = `<span class="text-blue-600 font-bold">${item.lat.toFixed(4)}, ${item.lng.toFixed(4)}</span>`;

            // Fill Specific Fields
            if(col==='warnings') {
                document.getElementById('w-type').value = item.type;
                const r = document.querySelector(`input[name="w-level"][value="${item.severity}"]`); if(r) r.checked=true;
            } else if(col==='sos') {
                document.getElementById('s-type').value = item.type;
                document.getElementById('s-count').value = item.victims;
                document.getElementById('s-urgency').value = item.urgency;
            } else {
                document.getElementById('u-name').value = item.name;
                document.getElementById('u-type').value = item.type;
            }

            // Fill Phones
            const pCont = document.getElementById('phones-container');
            pCont.innerHTML = ''; 
            // Add Primary
            addPhoneInput(item.phone); 
            // Add Extras
            if(item.extraPhones) item.extraPhones.forEach(p => addPhoneInput(p));

            // Fill Location Selects
            if(item.province) {
                document.getElementById('sel-province').value = item.province;
                await loadDistricts();
                if(item.district) {
                    document.getElementById('sel-district').value = item.district;
                    await loadWards();
                    if(item.ward) document.getElementById('sel-ward').value = item.ward;
                }
            }
        }

        function setupForm(type) {
            document.getElementById('create-modal').classList.remove('hidden');
            const cont = document.getElementById('form-container');
            
            // Reset common UI
            document.getElementById('phones-container').innerHTML = '';
            // Add at least one empty phone input if create mode
            if(!isEditMode) {
                addPhoneInput(currentUser.phone);
                document.getElementById('inp-desc').value = "";
                document.getElementById('loc-text').innerHTML = `<i class="fas fa-crosshairs"></i> V·ªã tr√≠ hi·ªán t·∫°i`;
                document.getElementById('modal-title').innerText = "ƒêƒÇNG TIN M·ªöI";
                document.getElementById('btn-submit').innerText = "G·ª¨I NGAY";
                // Reset selects
                document.getElementById('sel-province').value = "";
                document.getElementById('sel-district').innerHTML = "<option value=''>-- Qu·∫≠n / Huy·ªán --</option>";
                document.getElementById('sel-ward').innerHTML = "<option value=''>-- Ph∆∞·ªùng / X√£ --</option>";
            }

            // --- FIXED LOGIC HERE: Allow both 'warning' and 'warnings' ---
            if(type === 'warning' || type === 'warnings') {
                cont.innerHTML = `
                <label class="text-[11px] font-bold text-slate-400 uppercase">Lo·∫°i c·∫£nh b√°o</label>
                <select id="w-type" class="w-full border border-slate-200 p-3 rounded-xl mb-3 outline-none">
                    <option value="L≈© l·ª•t">üåä L≈© l·ª•t / N∆∞·ªõc d√¢ng</option><option value="S·∫°t l·ªü">üèîÔ∏è S·∫°t l·ªü ƒë·∫•t</option>
                    <option value="Tai n·∫°n">üöó Tai n·∫°n giao th√¥ng</option><option value="Ch√°y n·ªï">üî• Ch√°y n·ªï</option><option value="Kh√°c">‚úèÔ∏è Kh√°c</option>
                </select>
                <label class="text-[11px] font-bold text-slate-400 uppercase">M·ª©c ƒë·ªô</label>
                <div class="flex gap-2 mb-3">
                    <label class="flex-1"><input type="radio" name="w-level" value="1" checked class="peer hidden"><div class="border p-2 rounded-xl text-center text-xs font-bold peer-checked:bg-yellow-100 peer-checked:border-yellow-500 text-slate-500">Th·∫•p</div></label>
                    <label class="flex-1"><input type="radio" name="w-level" value="3" class="peer hidden"><div class="border p-2 rounded-xl text-center text-xs font-bold peer-checked:bg-orange-100 peer-checked:border-orange-500 text-slate-500">Cao</div></label>
                    <label class="flex-1"><input type="radio" name="w-level" value="5" class="peer hidden"><div class="border p-2 rounded-xl text-center text-xs font-bold peer-checked:bg-rose-600 peer-checked:border-rose-600 peer-checked:text-white text-slate-500">Nguy Hi·ªÉm</div></label>
                </div>`;
            } else if(type === 'sos') {
                const opts = ["C·∫•p c·ª©u y t·∫ø", "M·∫Øc k·∫πt", "S·∫≠p nh√†", "H·∫øt l∆∞∆°ng th·ª±c", "Kh√°c"].map(x=>`<option value="${x}">${x}</option>`).join('');
                cont.innerHTML = `
                <label class="text-[11px] font-bold text-slate-400 uppercase">Lo·∫°i s·ª± c·ªë</label>
                <select id="s-type" class="w-full border border-slate-200 p-3 rounded-xl mb-3 bg-red-50 outline-none">${opts}</select>
                <div class="flex gap-2 mb-3">
                    <div class="flex-1"><label class="text-[11px] font-bold text-slate-400">S·ªë ng∆∞·ªùi</label><input type="number" id="s-count" value="1" class="w-full border p-3 rounded-xl text-center font-bold"></div>
                    <div class="flex-1"><label class="text-[11px] font-bold text-slate-400">Kh·∫©n c·∫•p</label><select id="s-urgency" class="w-full border p-3 rounded-xl text-rose-600 font-bold"><option value="5">üî• Nguy k·ªãch</option><option value="3">‚ö†Ô∏è Kh·∫©n c·∫•p</option><option value="1">‚è≥ H·ªó tr·ª£</option></select></div>
                </div>`;
            } else {
                cont.innerHTML = `
                <label class="text-[11px] font-bold text-slate-400 uppercase">T√™n ƒë∆°n v·ªã</label>
                <input id="u-name" class="w-full border p-3 rounded-xl mb-3 outline-none" placeholder="VD: ƒê·ªôi Xu·ªìng 01...">
                <label class="text-[11px] font-bold text-slate-400 uppercase">Lo·∫°i h√¨nh</label>
                <select id="u-type" class="w-full border p-3 rounded-xl mb-3 outline-none">
                    <option value="Cano">üö§ Cano / Thuy·ªÅn</option><option value="Xe t·∫£i">üöõ Xe b√°n t·∫£i</option>
                    <option value="Y t·∫ø">‚öïÔ∏è Y t·∫ø / Thu·ªëc</option><option value="Nhu y·∫øu ph·∫©m">üì¶ Nhu y·∫øu ph·∫©m</option><option value="Kh√°c">‚úèÔ∏è Kh√°c</option>
                </select>`;
            }
        }

        // --- DYNAMIC PHONES LOGIC ---
        function addPhoneInput(val = '') {
            const container = document.getElementById('phones-container');
            const div = document.createElement('div');
            const isFirst = container.children.length === 0;
            div.className = "flex gap-2 animate-[fadeIn_0.3s_ease-out]";
            div.innerHTML = `
                <input type="tel" value="${val}" class="phone-val w-full border border-slate-200 rounded-xl px-3 py-2 text-sm font-bold outline-none focus:border-blue-500" placeholder="${isFirst?'S·ªë ch√≠nh':'S·ªë ph·ª•'}">
                ${!isFirst ? `<button onclick="this.parentElement.remove()" class="text-rose-500 px-2 hover:bg-rose-50 rounded"><i class="fas fa-times"></i></button>` : ''}
            `;
            container.appendChild(div);
        }

        async function submitData() {
            document.getElementById('loading').classList.remove('hidden');
            const desc = document.getElementById('inp-desc').value;
            const lat = pickedLocation ? pickedLocation.lat : currentLocation.lat;
            const lng = pickedLocation ? pickedLocation.lng : currentLocation.lng;
            
            // Get Admin Units
            const provEl = document.getElementById('sel-province');
            const distEl = document.getElementById('sel-district');
            const wardEl = document.getElementById('sel-ward');
            
            const provCode = provEl.value;
            const distCode = distEl.value;
            const wardCode = wardEl.value;
            
            // Build Address String
            let addrParts = [];
            if(wardCode) addrParts.push(wardEl.options[wardEl.selectedIndex].text);
            if(distCode) addrParts.push(distEl.options[distEl.selectedIndex].text);
            if(provCode) addrParts.push(provEl.options[provEl.selectedIndex].text);
            const addrStr = addrParts.join(', ');

            // Collect Phones
            const phoneInputs = Array.from(document.querySelectorAll('.phone-val')).map(i=>i.value.trim()).filter(x=>x);
            if(phoneInputs.length === 0) {
                 document.getElementById('loading').classList.add('hidden');
                 return alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 s·ªë ƒëi·ªán tho·∫°i!");
            }
            const primaryPhone = phoneInputs[0];
            const extraPhones = phoneInputs.slice(1);

            let data = {
                desc, lat, lng,
                province: provCode, district: distCode, ward: wardCode, addrStr: addrStr,
                phone: primaryPhone, extraPhones: extraPhones,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            const tab = currentTab === 'my' ? 'warning' : currentTab;
            const targetType = isEditMode ? editingItem.col : (tab==='warning'?'warnings':tab);
            let col = targetType;

            // Type specific
            if(targetType === 'warnings') {
                data.type = document.getElementById('w-type').value;
                data.severity = document.querySelector('input[name="w-level"]:checked').value;
                if(!isEditMode) data.status = 'new';
            } else if(targetType === 'sos') {
                data.type = document.getElementById('s-type').value;
                data.victims = document.getElementById('s-count').value;
                data.urgency = document.getElementById('s-urgency').value;
                if(!isEditMode) data.status = 'new';
            } else { // units
                data.name = document.getElementById('u-name').value;
                data.type = document.getElementById('u-type').value;
            }

            if(!isEditMode) {
                data.uid = currentUser.uid;
                data.creatorName = currentUser.customName || currentUser.displayName;
                data.userPhoto = currentUser.photoURL;
                data.timestamp = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if(isEditMode) await db.collection(col).doc(editingItem.id).update(data);
                else await db.collection(col).add(data);
                closeModal();
                showToast(isEditMode?"ƒê√£ c·∫≠p nh·∫≠t":"ƒê√£ ƒëƒÉng tin", "success");
            } catch(e) { showToast(e.message, 'error'); } 
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        // --- UTILS ---
        function closeModal() { document.getElementById('create-modal').classList.add('hidden'); }
        function deleteItem(c, i) { customDialog("X√≥a tin", "Kh√¥ng th·ªÉ ho√†n t√°c!", "confirm", ()=>db.collection(c).doc(i).delete()); }
        function locateUser() { map.flyTo([currentLocation.lat, currentLocation.lng], 16); }
        function startPickLocation() { isPickingMode = true; document.getElementById('create-modal').classList.add('hidden'); document.getElementById('map-picker-hint').classList.remove('hidden'); }
        function cancelPick() { isPickingMode = false; if(tempMarker) tempMarker.remove(); document.getElementById('map-picker-hint').classList.add('hidden'); document.getElementById('create-modal').classList.remove('hidden'); }
        
        // Math & Helpers
        function getDist(lat,lng) {
            const R=6371, dLat=(lat-currentLocation.lat)*Math.PI/180, dLon=(lng-currentLocation.lng)*Math.PI/180;
            const a=Math.sin(dLat/2)**2 + Math.cos(currentLocation.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin(dLon/2)**2;
            return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);
        }
        function timeAgo(ts) { 
            if(!ts) return ''; const s=(new Date()-ts.toDate())/1000;
            return s<60?'V·ª´a xong':(s<3600?Math.floor(s/60)+' ph√∫t tr∆∞·ªõc':(s<86400?Math.floor(s/3600)+' gi·ªù tr∆∞·ªõc':Math.floor(s/86400)+' ng√†y tr∆∞·ªõc'));
        }

        // Excel
        function downloadExcelTemplate() { XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.aoa_to_sheet([["Ten_Don_Vi","Loai_Hinh","SDT","Mo_Ta","Lat","Lng"]]), "Mau")), "Mau_Don_Vi.xlsx"); }
        function importExcel(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = evt => {
                const j = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(evt.target.result),{type:'array'}).Sheets[XLSX.read(new Uint8Array(evt.target.result),{type:'array'}).SheetNames[0]]);
                customDialog("Import", `Nh·∫≠p ${j.length} d√≤ng?`, "confirm", () => {
                    const b = db.batch();
                    j.forEach(r=>{ 
                        b.set(db.collection('units').doc(), { name:r['Ten_Don_Vi']||"ƒê∆°n v·ªã", type:r['Loai_Hinh']||"Kh√°c", phone:r['SDT']||currentUser.phone, lat: r['Lat']||map.getCenter().lat, lng: r['Lng']||map.getCenter().lng, desc: r['Mo_Ta']||"", uid:currentUser.uid, creatorName:currentUser.displayName, userPhoto:currentUser.photoURL, timestamp:firebase.firestore.FieldValue.serverTimestamp() }); 
                    });
                    b.commit().then(()=>showToast("Xong", "success"));
                });
            };
            r.readAsArrayBuffer(f);
        }
    </script>
</body>
</html>
