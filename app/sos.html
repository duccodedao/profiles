
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá th·ªëng C·∫£nh b√°o & C·ª©u h·ªô Thi√™n tai (Free Map)</title>

    <!-- 1. UI & ICONS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. EXCEL -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- 3. FIREBASE (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- 4. LEAFLET JS (FREE MAP) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* CSS T√πy ch·ªânh */
        body { touch-action: pan-y; }
        
        /* Map Container */
        #map {
            height: 40vh; /* Chi·ªÅu cao map tr√™n mobile */
            width: 100%;
            z-index: 0; /* ƒê·ªÉ map n·∫±m d∆∞·ªõi c√°c modal */
        }

        /* Marker Custom Styles (T·∫°o icon ƒë·∫πp b·∫±ng CSS) */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0px 3px 5px rgba(0,0,0,0.3);
        }
        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }
        .custom-div-icon i {
            position: absolute;
            width: 22px;
            font-size: 22px;
            left: 0;
            right: 0;
            margin: 10px auto;
            text-align: center;
            top: -10px; /* Ch·ªânh icon n·∫±m tr√™n pin */
            z-index: 10;
        }

        /* Animation Pulse cho SOS */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { transform: scale(1.5); opacity: 0; }
        }
        .pulse-marker::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background-color: rgba(239, 68, 68, 0.6);
            border-radius: 50%;
            z-index: -1;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        /* Scrollbar ·∫©n */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; pointer-events: none; }
        .toast { pointer-events: auto; background: rgba(0,0,0,0.8); color: #fff; padding: 12px 24px; border-radius: 8px; margin-bottom: 10px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased pb-24 relative h-screen flex flex-col overflow-hidden">

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container"></div>

    <!-- ALERT N·∫æU CH∆ØA CONFIG -->
    <div id="config-alert" class="fixed top-0 left-0 w-full bg-red-600 text-white p-3 z-[100] text-center text-sm hidden">
        <i class="fas fa-exclamation-triangle"></i> 
        <b>L∆ØU √ù:</b> B·∫°n ch∆∞a ƒëi·ªÅn Firebase Config trong code. Web s·∫Ω kh√¥ng ƒëƒÉng nh·∫≠p ƒë∆∞·ª£c.
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-95 z-[90] flex items-center justify-center hidden">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-500 font-medium" id="loading-text">ƒêang t·∫£i...</p>
        </div>
    </div>

    <!-- M√ÄN H√åNH LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6">
        <div class="mb-10 text-center">
            <div class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-bounce">
                <i class="fas fa-life-ring text-5xl text-white"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">C·ª®U H·ªò THI√äN TAI</h1>
            <p class="text-gray-500 mt-2 text-sm">H·ªá th·ªëng C·∫£nh b√°o & ƒê·ªãnh v·ªã Th·ªùi gian th·ª±c</p>
        </div>
        
        <button onclick="loginWithGoogle()" class="w-full max-w-xs bg-white border border-gray-300 text-gray-700 font-bold py-3 px-4 rounded-xl shadow-md hover:bg-gray-50 flex items-center justify-center gap-3 transition transform hover:scale-105">
            <i class="fab fa-google text-red-500 text-xl"></i>
            ƒêƒÉng nh·∫≠p b·∫±ng Google
        </button>
        <p class="mt-8 text-xs text-gray-400 text-center max-w-xs">
            H·ªá th·ªëng s·ª≠ d·ª•ng b·∫£n ƒë·ªì OpenStreetMap mi·ªÖn ph√≠.<br>Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.
        </p>
    </div>

    <!-- C·∫¨P NH·∫¨T S·ªê ƒêI·ªÜN THO·∫†I -->
    <div id="phone-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[60] flex items-center justify-center p-4 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div class="text-center mb-5">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                    <i class="fas fa-phone text-green-600 text-xl"></i>
                </div>
                <h2 class="text-lg font-bold">S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá</h2>
                <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ c·ª©u h·ªô c√≥ th·ªÉ g·ªçi cho b·∫°n khi kh·∫©n c·∫•p</p>
            </div>
            <input type="tel" id="user-phone-input" placeholder="09xxxxxxxxx" class="w-full border border-gray-300 bg-gray-50 p-3 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold text-lg tracking-widest">
            <button onclick="updatePhoneNumber()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg">X√ÅC NH·∫¨N</button>
        </div>
    </div>

    <!-- GIAO DI·ªÜN CH√çNH -->
    <div id="main-app" class="hidden flex flex-col h-full w-full">
        
        <!-- HEADER -->
        <header class="bg-white shadow z-30 shrink-0">
            <div class="flex justify-between items-center px-4 py-3 bg-gradient-to-r from-blue-700 to-blue-800 text-white">
                <div class="flex items-center gap-2">
                    <i class="fas fa-map-marked-alt"></i>
                    <span class="font-bold text-lg">C·ª©u H·ªô FreeMap</span>
                </div>
                <div class="flex items-center gap-3">
                    <span id="user-name-display" class="text-xs font-medium opacity-90 truncate max-w-[80px]">User</span>
                    <button onclick="logout()" class="text-white opacity-70 hover:opacity-100"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
            
            <!-- TABS -->
            <div class="flex bg-white shadow-sm border-b">
                <button onclick="switchTab('warning')" id="tab-warning" class="flex-1 py-3 text-xs sm:text-sm font-bold text-center border-b-4 border-yellow-500 text-yellow-700 bg-yellow-50 transition-colors">
                    <i class="fas fa-exclamation-triangle mb-1 block text-lg"></i> C·∫¢NH B√ÅO
                </button>
                <button onclick="switchTab('sos')" id="tab-sos" class="flex-1 py-3 text-xs sm:text-sm font-bold text-center border-b-4 border-transparent text-gray-400 hover:text-red-600 transition-colors">
                    <i class="fas fa-life-ring mb-1 block text-lg"></i> C·∫¶U C·ª®U
                </button>
                <button onclick="switchTab('units')" id="tab-units" class="flex-1 py-3 text-xs sm:text-sm font-bold text-center border-b-4 border-transparent text-gray-400 hover:text-blue-600 transition-colors">
                    <i class="fas fa-hands-helping mb-1 block text-lg"></i> ƒê∆†N V·ªä
                </button>
            </div>
        </header>

        <!-- MAP CONTAINER (Quan tr·ªçng) -->
        <div class="relative w-full bg-gray-200 shrink-0 border-b border-gray-300 shadow-inner">
            <div id="map"></div> <!-- Leaflet Map render ·ªü ƒë√¢y -->
            
            <!-- N√∫t ƒë·ªãnh v·ªã l·∫°i -->
            <button onclick="reCenterMap()" class="absolute bottom-4 right-4 bg-white p-3 rounded shadow-lg z-[400] text-blue-600 hover:bg-gray-100 active:scale-95 transition">
                <i class="fas fa-crosshairs"></i>
            </button>

            <!-- Status bar -->
            <div class="absolute top-2 left-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-medium shadow z-[400] flex items-center gap-1">
                <span id="location-dot" class="w-2 h-2 rounded-full bg-gray-400"></span>
                <span id="location-text">ƒêang t√¨m GPS...</span>
            </div>
        </div>

        <!-- CONTENT LISTS (Scrollable) -->
        <main class="flex-1 overflow-y-auto bg-gray-100 p-3 no-scrollbar">
            
            <!-- TAB 1: C·∫¢NH B√ÅO -->
            <div id="content-warning" class="space-y-4 pb-20">
                <div class="flex justify-between items-center px-1">
                    <h3 class="font-bold text-gray-600 text-sm uppercase">Tin c·∫£nh b√°o g·∫ßn ƒë√¢y</h3>
                    <select id="filter-warning" onchange="renderWarnings()" class="text-xs border rounded p-1 bg-white shadow-sm outline-none">
                        <option value="all">T·∫•t c·∫£</option>
                        <option value="Cao">Nguy hi·ªÉm</option>
                    </select>
                </div>
                <div id="list-warnings" class="space-y-3"></div>
            </div>

            <!-- TAB 2: C·∫¶U C·ª®U (SOS) -->
            <div id="content-sos" class="hidden space-y-4 pb-20">
                <div class="flex justify-between items-center px-1">
                    <h3 class="font-bold text-red-700 text-sm uppercase">Danh s√°ch SOS kh·∫©n c·∫•p</h3>
                    <span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold border border-red-200">LIVE</span>
                </div>
                <div id="list-sos" class="space-y-3"></div>
            </div>

            <!-- TAB 3: ƒê∆†N V·ªä C·ª®U H·ªò -->
            <div id="content-units" class="hidden space-y-4 pb-20">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-center">
                    <h4 class="font-bold text-blue-900 text-xs uppercase mb-2">S·ªë ƒëi·ªán tho·∫°i kh·∫©n c·∫•p (Nh√† n∆∞·ªõc)</h4>
                    <div class="flex justify-around">
                        <a href="tel:114" class="flex flex-col items-center p-2 bg-white rounded shadow hover:bg-red-50 w-20">
                            <span class="text-xl">üöí</span> <span class="text-xs font-bold text-red-600">114</span>
                        </a>
                        <a href="tel:115" class="flex flex-col items-center p-2 bg-white rounded shadow hover:bg-red-50 w-20">
                            <span class="text-xl">üöë</span> <span class="text-xs font-bold text-red-600">115</span>
                        </a>
                        <a href="tel:113" class="flex flex-col items-center p-2 bg-white rounded shadow hover:bg-red-50 w-20">
                            <span class="text-xl">üöì</span> <span class="text-xs font-bold text-red-600">113</span>
                        </a>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-2 px-1">
                    <h3 class="font-bold text-gray-600 text-sm">ƒê∆°n v·ªã h·ªó tr·ª£ kh√°c</h3>
                    <div class="relative">
                        <button onclick="document.getElementById('excel-input').click()" class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded hover:bg-green-200 font-bold border border-green-200 flex items-center gap-1">
                            <i class="fas fa-file-excel"></i> Import
                        </button>
                        <input type="file" id="excel-input" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(event)">
                    </div>
                </div>
                <div id="list-units" class="space-y-3"></div>
            </div>

        </main>

        <!-- FAB BUTTON -->
        <button onclick="openCreateModal()" id="fab-add" class="fixed bottom-6 right-5 w-14 h-14 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition z-50 ring-4 ring-blue-100 active:scale-95">
            <i class="fas fa-plus"></i>
        </button>

    </div>

    <!-- MODAL T·∫†O M·ªöI -->
    <div id="create-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[1000] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-lg sm:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-y-auto flex flex-col shadow-2xl animate-[slideUp_0.3s_ease-out]">
            
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10 rounded-t-2xl">
                <h2 class="text-lg font-bold" id="modal-title">Ti√™u ƒë·ªÅ</h2>
                <button onclick="closeCreateModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-bold hover:bg-gray-200">&times;</button>
            </div>
            
            <div class="p-5 space-y-4">
                <!-- FORM C·∫¢NH B√ÅO -->
                <div id="form-warning-fields" class="space-y-3 hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Lo·∫°i thi√™n tai</label>
                    <select id="w-type" class="w-full border p-3 rounded-lg bg-gray-50">
                        <option value="L≈© l·ª•t">L≈© l·ª•t / N∆∞·ªõc d√¢ng</option>
                        <option value="S·∫°t l·ªü">S·∫°t l·ªü ƒë·∫•t</option>
                        <option value="Ng·∫≠p √∫ng">Ng·∫≠p √∫ng</option>
                        <option value="Giao th√¥ng">T·∫Øc ƒë∆∞·ªùng / Nguy hi·ªÉm</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>

                    <label class="block text-xs font-bold text-gray-500 uppercase mt-2">M·ª©c ƒë·ªô</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="sev" value="1" class="peer hidden" checked>
                            <div class="border p-2 rounded text-center text-sm peer-checked:bg-yellow-100 peer-checked:border-yellow-500 peer-checked:text-yellow-800">Th·∫•p</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="sev" value="3" class="peer hidden">
                            <div class="border p-2 rounded text-center text-sm peer-checked:bg-orange-100 peer-checked:border-orange-500 peer-checked:text-orange-800">Cao</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="sev" value="4" class="peer hidden">
                            <div class="border p-2 rounded text-center text-sm peer-checked:bg-red-600 peer-checked:text-white peer-checked:font-bold">C·ª∞C K·ª≤</div>
                        </label>
                    </div>
                    <input type="hidden" id="w-severity" value="1">
                </div>

                <!-- FORM SOS -->
                <div id="form-sos-fields" class="space-y-3 hidden">
                    <div class="bg-red-50 text-red-800 p-3 rounded text-sm border border-red-100 flex gap-2 items-start">
                        <i class="fas fa-exclamation-circle mt-1"></i>
                        <span>Th√¥ng tin SOS s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn t·∫•t c·∫£ ƒë∆°n v·ªã c·ª©u h·ªô g·∫ßn nh·∫•t. Kh√¥ng spam.</span>
                    </div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">T√¨nh tr·∫°ng</label>
                    <select id="s-type" class="w-full border p-3 rounded-lg bg-white">
                        <option value="M·∫Øc k·∫πt">B·ªã c√¥ l·∫≠p / M·∫Øc k·∫πt</option>
                        <option value="Th∆∞∆°ng t√≠ch">Tai n·∫°n / Th∆∞∆°ng t√≠ch</option>
                        <option value="Y t·∫ø">C·∫ßn thu·ªëc / Y t·∫ø g·∫•p</option>
                        <option value="L∆∞∆°ng th·ª±c">H·∫øt th·ª©c ƒÉn / N∆∞·ªõc</option>
                    </select>
                    
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">S·ªë ng∆∞·ªùi</label>
                            <input type="number" id="s-victims" value="1" class="w-full border p-3 rounded-lg text-center font-bold">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ƒê·ªô kh·∫©n (1-5)</label>
                            <select id="s-urgency" class="w-full border p-3 rounded-lg text-red-600 font-bold">
                                <option value="5">5 - Nguy k·ªãch</option>
                                <option value="4">4 - R·∫•t g·∫•p</option>
                                <option value="3">3 - Kh·∫©n c·∫•p</option>
                                <option value="2">2 - H·ªó tr·ª£</option>
                                <option value="1">1 - Ch·ªù ƒë∆∞·ª£c</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- FORM UNITS -->
                <div id="form-unit-fields" class="space-y-3 hidden">
                    <input type="text" id="u-name" class="w-full border p-3 rounded-lg" placeholder="T√™n ƒë∆°n v·ªã / C√° nh√¢n">
                    <select id="u-type" class="w-full border p-3 rounded-lg">
                        <option value="Cano">Cano / Thuy·ªÅn</option>
                        <option value="Xe b√°n t·∫£i">Xe b√°n t·∫£i / G·∫ßm cao</option>
                        <option value="Th·ª±c ph·∫©m">Nhu y·∫øu ph·∫©m</option>
                        <option value="T√¨nh nguy·ªán">T√¨nh nguy·ªán vi√™n</option>
                    </select>
                </div>

                <!-- CHUNG -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">M√¥ t·∫£ & ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                    <textarea id="common-desc" rows="3" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="M√¥ t·∫£ chi ti·∫øt..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" id="common-phone" class="w-full border p-3 rounded-lg bg-gray-100 text-gray-600 font-bold" readonly>
                </div>
            </div>

            <div class="p-4 border-t bg-white sticky bottom-0">
                <button onclick="submitForm()" id="btn-submit" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90 transition uppercase tracking-wide">
                    G·ª≠i Th√¥ng Tin
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script>
        // ==========================================
        // 1. C·∫§U H√åNH FIREBASE (B·∫ÆT BU·ªòC ƒêI·ªÄN)
        // ==========================================
        // B·∫°n ph·∫£i l·∫•y c√°i n√†y t·ª´ Firebase Console: Settings -> General -> CDN
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };

        // ==========================================
        // 2. KH·ªûI T·∫†O & BI·∫æN TO√ÄN C·ª§C
        // ==========================================
        let auth, db;
        let currentUser = null;
        let currentPos = { lat: 16.0544, lng: 108.2022 }; // M·∫∑c ƒë·ªãnh ƒê√† N·∫µng
        let map, userMarkerLayer;
        let markersLayerGroup; // Layer Group ƒë·ªÉ qu·∫£n l√Ω marker d·ªÖ h∆°n
        let currentTab = 'warning';
        let allData = { warnings: [], sos: [], units: [] };

        // Ki·ªÉm tra config
        if (firebaseConfig.apiKey.includes("xxxx")) {
            document.getElementById('config-alert').classList.remove('hidden');
        } else {
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("L·ªói k·∫øt n·ªëi Firebase!");
            }
        }

        // ==========================================
        // 3. X·ª¨ L√ù AUTHENTICATION
        // ==========================================
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-name-display').textContent = user.displayName || 'User';
                    document.getElementById('login-screen').classList.add('hidden');
                    
                    // Check phone number
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (!userDoc.exists || !userDoc.data().phone) {
                            document.getElementById('phone-modal').classList.remove('hidden');
                        } else {
                            currentUser.phoneDB = userDoc.data().phone;
                            enterApp();
                        }
                    } catch (e) {
                        enterApp(); // Fallback
                    }
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('main-app').classList.add('hidden');
                }
            });
        }

        function loginWithGoogle() {
            if (!auth) return alert("Vui l√≤ng c·∫•u h√¨nh Firebase API Key trong code!");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert("L·ªói Login: " + e.message));
        }

        function logout() {
            if (confirm("ƒêƒÉng xu·∫•t?")) {
                auth.signOut();
                location.reload();
            }
        }

        async function updatePhoneNumber() {
            const phone = document.getElementById('user-phone-input').value;
            if (phone.length < 9) return alert("SƒêT kh√¥ng h·ª£p l·ªá");
            showLoading(true);
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    email: currentUser.email,
                    displayName: currentUser.displayName,
                    phone: phone,
                    lastLogin: new Date()
                }, { merge: true });
                currentUser.phoneDB = phone;
                document.getElementById('phone-modal').classList.add('hidden');
                enterApp();
            } catch (e) {
                alert("L·ªói: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        function enterApp() {
            document.getElementById('main-app').classList.remove('hidden');
            initLeafletMap(); // Kh·ªüi t·∫°o Map
            startTracking();  // B·∫Øt ƒë·∫ßu l·∫•y v·ªã tr√≠
            
            // Listen realtime
            listenData('warnings');
            listenData('sos');
            listenData('units');
        }

        // ==========================================
        // 4. LEAFLET MAP LOGIC (THAY TH·∫æ GOOGLE MAPS)
        // ==========================================
        function initLeafletMap() {
            if (map) return; // ƒê√£ init r·ªìi

            // T·∫°o map, set view m·∫∑c ƒë·ªãnh
            map = L.map('map', {
                zoomControl: false, // T·∫Øt zoom m·∫∑c ƒë·ªãnh ƒë·ªÉ t·ª± custom n·∫øu c·∫ßn (ho·∫∑c ƒë·ªÉ g·ªçn)
                attributionControl: false
            }).setView([currentPos.lat, currentPos.lng], 13);

            // Th√™m Tile Layer (OpenStreetMap - FREE)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // T·∫°o layer group ch·ª©a marker ƒë·ªÉ d·ªÖ clear
            markersLayerGroup = L.layerGroup().addTo(map);

            // Icon User
            const userIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div class='w-4 h-4 bg-blue-500 border-2 border-white rounded-full shadow-md animate-pulse'></div>",
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            userMarkerLayer = L.marker([currentPos.lat, currentPos.lng], {icon: userIcon}).addTo(map);
        }

        function startTracking() {
            if (!navigator.geolocation) return;
            navigator.geolocation.watchPosition(
                (pos) => {
                    currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    
                    // Update UI Status
                    document.getElementById('location-dot').classList.remove('bg-gray-400');
                    document.getElementById('location-dot').classList.add('bg-green-500');
                    document.getElementById('location-text').textContent = "GPS T·ªët";

                    // Update Map Marker
                    if (userMarkerLayer) {
                        userMarkerLayer.setLatLng([currentPos.lat, currentPos.lng]);
                    }

                    // Auto center l·∫ßn ƒë·∫ßu
                    if (!window.hasCentered) {
                        map.setView([currentPos.lat, currentPos.lng], 14);
                        window.hasCentered = true;
                    }

                    renderLists(); // T√≠nh l·∫°i kho·∫£ng c√°ch
                },
                (err) => {
                    document.getElementById('location-text').textContent = "M·∫•t GPS";
                    document.getElementById('location-dot').classList.add('bg-red-500');
                },
                { enableHighAccuracy: true }
            );
        }

        function reCenterMap() {
            if (map && currentPos) {
                map.flyTo([currentPos.lat, currentPos.lng], 15, { duration: 1.5 });
            }
        }

        // ==========================================
        // 5. DATA & RENDERING
        // ==========================================
        function listenData(col) {
            if (!db) return;
            db.collection(col).orderBy('timestamp', 'desc').limit(50)
                .onSnapshot(snap => {
                    allData[col] = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderLists();
                    updateMapMarkers();
                });
        }

        function calcDist(lat1, lon1, lat2, lon2) {
            if (!lat1 || !lat2) return 999;
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function formatTime(ts) {
            if (!ts) return '';
            const d = ts.toDate();
            return `${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')} ${d.getDate()}/${d.getMonth()+1}`;
        }

        function openGoogleMaps(lat, lng) {
            // M·ªü Google Maps th·∫≠t ƒë·ªÉ ch·ªâ ƒë∆∞·ªùng (t·ªët h∆°n Leaflet)
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        }

        function flyToItem(lat, lng) {
            map.flyTo([lat, lng], 16, { duration: 1.5 });
            // Scroll to top mobile
            document.querySelector('#main-app > div').scrollIntoView({behavior: 'smooth'});
        }

        function renderLists() {
            if (currentTab === 'warning') renderWarningList();
            if (currentTab === 'sos') renderSOSList();
            if (currentTab === 'units') renderUnitList();
        }

        function renderWarningList() {
            const list = document.getElementById('list-warnings');
            list.innerHTML = '';
            const filter = document.getElementById('filter-warning').value;
            
            let data = allData.warnings.map(i => ({...i, dist: calcDist(currentPos.lat, currentPos.lng, i.lat, i.lng)}))
                .sort((a,b) => a.dist - b.dist);

            if (filter === 'Cao') data = data.filter(i => parseInt(i.severity) >= 3);

            data.forEach(item => {
                const colors = {1:'bg-green-100 text-green-800', 3:'bg-orange-100 text-orange-800', 4:'bg-red-600 text-white'};
                const sevLabel = {1:'Th·∫•p', 3:'Cao', 4:'NGUY HI·ªÇM'};
                const sevClass = colors[item.severity] || colors[1];
                const isMine = item.uid === currentUser.uid;

                list.innerHTML += `
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 relative">
                        <div class="flex justify-between">
                            <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded ${sevClass}">${sevLabel[item.severity]||'TB'}</span>
                            <span class="text-xs text-gray-400">${formatTime(item.timestamp)}</span>
                        </div>
                        <h4 class="font-bold text-gray-800 mt-1">${item.type}</h4>
                        <p class="text-sm text-gray-600 line-clamp-2">${item.desc}</p>
                        <div class="flex justify-between items-center mt-3 pt-2 border-t border-dashed border-gray-200">
                            <span class="text-xs font-medium text-blue-600"><i class="fas fa-location-arrow"></i> ${item.dist.toFixed(1)} km</span>
                            <div class="flex gap-2">
                                <button onclick="flyToItem(${item.lat},${item.lng})" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600 font-bold">MAP</button>
                                <button onclick="openGoogleMaps(${item.lat},${item.lng})" class="text-xs bg-blue-100 px-2 py-1 rounded text-blue-600 font-bold">ƒêI T·ªöI</button>
                            </div>
                        </div>
                        ${isMine ? `<button onclick="deleteItem('warnings','${item.id}')" class="absolute top-2 right-2 text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
            });
        }

        function renderSOSList() {
            const list = document.getElementById('list-sos');
            list.innerHTML = '';
            let data = allData.sos.map(i => ({...i, dist: calcDist(currentPos.lat, currentPos.lng, i.lat, i.lng)}))
                .sort((a,b) => b.urgency - a.urgency || a.dist - b.dist);

            data.forEach(item => {
                const isCritical = parseInt(item.urgency) >= 4;
                const isMine = item.uid === currentUser.uid;
                
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-md border ${isCritical ? 'border-red-500 ring-2 ring-red-100' : 'border-red-100'} relative">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-2 h-2 bg-red-600 rounded-full animate-ping"></div>
                            <h4 class="font-bold text-red-700 uppercase">SOS: ${item.type}</h4>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 mb-2">
                            <span><i class="fas fa-user-injured w-4 text-center"></i> ${item.victims} ng∆∞·ªùi</span>
                            <span><i class="fas fa-exclamation-triangle w-4 text-center"></i> C·∫•p ${item.urgency}/5</span>
                        </div>
                        <p class="text-sm italic text-gray-600 bg-gray-50 p-2 rounded mb-3">"${item.desc}"</p>
                        <div class="flex gap-2">
                            <a href="tel:${item.phone}" class="flex-1 bg-green-500 text-white py-2 rounded font-bold text-center text-sm hover:bg-green-600"><i class="fas fa-phone-alt"></i> G·ªåI</a>
                            <button onclick="flyToItem(${item.lat},${item.lng})" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded font-bold text-center text-sm border border-blue-200">XEM MAP</button>
                        </div>
                        <div class="text-center mt-2">
                            <button onclick="openGoogleMaps(${item.lat},${item.lng})" class="text-xs text-blue-500 underline">M·ªü Google Maps ch·ªâ ƒë∆∞·ªùng</button>
                        </div>
                         ${isMine ? `<button onclick="deleteItem('sos','${item.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 text-xs">X√≥a</button>` : ''}
                    </div>
                `;
            });
        }

        function renderUnitList() {
            const list = document.getElementById('list-units');
            list.innerHTML = '';
            let data = allData.units.map(i => ({...i, dist: calcDist(currentPos.lat, currentPos.lng, i.lat, i.lng)})).sort((a,b) => a.dist - b.dist);

            data.forEach(item => {
                list.innerHTML += `
                    <div class="bg-white p-3 rounded-lg border border-blue-100 shadow-sm flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-blue-900 text-sm">${item.name}</h4>
                            <p class="text-xs text-gray-500 mt-1"><span class="bg-blue-100 text-blue-700 px-1 rounded">${item.type}</span> ‚Ä¢ ${item.dist.toFixed(1)} km</p>
                        </div>
                        <div class="flex gap-2">
                            <a href="tel:${item.phone}" class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center shadow"><i class="fas fa-phone"></i></a>
                            <button onclick="flyToItem(${item.lat},${item.lng})" class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center shadow"><i class="fas fa-map-marker-alt"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        // ==========================================
        // 6. UPDATE MARKERS ON LEAFLET
        // ==========================================
        function updateMapMarkers() {
            if (!map || !markersLayerGroup) return;
            markersLayerGroup.clearLayers(); // X√≥a marker c≈©

            // 1. Warnings (V√†ng)
            allData.warnings.forEach(item => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class='marker-pin bg-yellow-500'></div><i class='fas fa-exclamation text-white' style='top:-12px'></i>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });
                L.marker([item.lat, item.lng], {icon: icon})
                    .bindPopup(`<b>${item.type}</b><br>${item.desc}`)
                    .addTo(markersLayerGroup);
            });

            // 2. SOS (ƒê·ªè + Pulse)
            allData.sos.forEach(item => {
                const icon = L.divIcon({
                    className: 'custom-div-icon pulse-marker',
                    html: `<div class='marker-pin bg-red-600'></div><i class='fas fa-life-ring text-white' style='top:-12px'></i>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });
                L.marker([item.lat, item.lng], {icon: icon, zIndexOffset: 1000})
                    .bindPopup(`<b class="text-red-600">SOS: ${item.type}</b><br>N·∫°n nh√¢n: ${item.victims}<br>${item.desc}`)
                    .addTo(markersLayerGroup);
            });

            // 3. Units (Xanh)
            allData.units.forEach(item => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class='marker-pin bg-blue-600'></div><i class='fas fa-hands-helping text-white' style='top:-12px'></i>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                });
                L.marker([item.lat, item.lng], {icon: icon})
                    .bindPopup(`<b class="text-blue-600">${item.name}</b><br>${item.type}`)
                    .addTo(markersLayerGroup);
            });
        }

        // ==========================================
        // 7. UI INTERACTIONS
        // ==========================================
        function switchTab(tab) {
            currentTab = tab;
            // Update Tab UI
            ['warning','sos','units'].forEach(t => {
                const el = document.getElementById('tab-'+t);
                const content = document.getElementById('content-'+t);
                if (t === tab) {
                    content.classList.remove('hidden');
                    const color = t==='sos'?'border-red-600 text-red-600 bg-red-50' : (t==='units'?'border-blue-600 text-blue-600 bg-blue-50':'border-yellow-500 text-yellow-700 bg-yellow-50');
                    el.className = `flex-1 py-3 text-xs sm:text-sm font-bold text-center border-b-4 transition-colors ${color}`;
                    
                    // FAB Color
                    const fabColor = t==='sos'?'bg-red-600 ring-red-200' : (t==='units'?'bg-blue-600 ring-blue-200':'bg-gradient-to-r from-blue-600 to-blue-700 ring-blue-100');
                    document.getElementById('fab-add').className = `fixed bottom-6 right-5 w-14 h-14 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl hover:scale-110 transition z-50 ring-4 active:scale-95 ${fabColor}`;

                } else {
                    content.classList.add('hidden');
                    el.className = 'flex-1 py-3 text-xs sm:text-sm font-bold text-center border-b-4 border-transparent text-gray-400 hover:text-gray-600 transition-colors';
                }
            });
            renderLists();
            // Resize map ƒë·ªÉ tr√°nh l·ªói x√°m khi ·∫©n hi·ªán tab
            setTimeout(() => { if(map) map.invalidateSize(); }, 200);
        }

        function openCreateModal() {
            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('common-phone').value = currentUser.phoneDB || '';
            
            // Hide all
            ['warning','sos','unit'].forEach(k => document.getElementById(`form-${k}-fields`).classList.add('hidden'));
            const titleEl = document.getElementById('modal-title');
            const btn = document.getElementById('btn-submit');

            if(currentTab === 'warning') {
                titleEl.textContent = "T·∫†O C·∫¢NH B√ÅO";
                titleEl.className = "text-lg font-bold text-yellow-600";
                document.getElementById('form-warning-fields').classList.remove('hidden');
                btn.className = "w-full bg-yellow-500 text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90";
            } else if(currentTab === 'sos') {
                titleEl.textContent = "G·ª¨I Y√äU C·∫¶U SOS";
                titleEl.className = "text-lg font-bold text-red-600";
                document.getElementById('form-sos-fields').classList.remove('hidden');
                btn.className = "w-full bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90 animate-pulse";
            } else {
                titleEl.textContent = "TH√äM ƒê∆†N V·ªä";
                titleEl.className = "text-lg font-bold text-blue-600";
                document.getElementById('form-unit-fields').classList.remove('hidden');
                btn.className = "w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:opacity-90";
            }
        }

        function closeCreateModal() { document.getElementById('create-modal').classList.add('hidden'); }

        async function submitForm() {
            if(!db) return;
            const desc = document.getElementById('common-desc').value;
            if(!desc) return alert("Vui l√≤ng nh·∫≠p m√¥ t·∫£!");

            showLoading(true);
            const common = {
                uid: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                lat: currentPos.lat, 
                lng: currentPos.lng,
                phone: document.getElementById('common-phone').value,
                desc: desc
            };

            try {
                if(currentTab === 'warning') {
                    // X·ª≠ l√Ω radio
                    const sev = document.querySelector('input[name="sev"]:checked').value;
                    await db.collection('warnings').add({
                        ...common,
                        type: document.getElementById('w-type').value,
                        severity: sev
                    });
                } else if (currentTab === 'sos') {
                    await db.collection('sos').add({
                        ...common,
                        type: document.getElementById('s-type').value,
                        victims: document.getElementById('s-victims').value,
                        urgency: document.getElementById('s-urgency').value
                    });
                } else {
                    await db.collection('units').add({
                        ...common,
                        name: document.getElementById('u-name').value,
                        type: document.getElementById('u-type').value
                    });
                }
                closeCreateModal();
                showToast("ƒê√£ g·ª≠i th√†nh c√¥ng!");
                document.getElementById('common-desc').value = '';
            } catch (e) {
                alert("L·ªói: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        async function deleteItem(col, id) {
            if(confirm("X√≥a m·ª•c n√†y?")) {
                await db.collection(col).doc(id).delete();
                showToast("ƒê√£ x√≥a!");
            }
        }

        // --- EXCEL ---
        function handleExcelUpload(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = function(evt) {
                const data = new Uint8Array(evt.target.result);
                const wb = XLSX.read(data, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(confirm(`Import ${json.length} d√≤ng?`)) {
                    const batch = db.batch();
                    json.forEach(row => {
                        const ref = db.collection('units').doc();
                        batch.set(ref, {
                            name: row['Name']||row['T√™n']||'Unknown',
                            type: row['Type']||row['Lo·∫°i']||'Kh√°c',
                            phone: row['Phone']||row['SƒêT']||'',
                            lat: parseFloat(row['Lat']||row['Vƒ© ƒë·ªô']||0),
                            lng: parseFloat(row['Lng']||row['Kinh ƒë·ªô']||0),
                            uid: currentUser.uid,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    });
                    batch.commit().then(()=>showToast("Import xong!"));
                }
            };
            r.readAsArrayBuffer(f);
        }

        // --- UTILS ---
        function showLoading(show) {
            const el = document.getElementById('loading-overlay');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }
        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast'; t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3000);
        }
        
        // CSS Animation styles
        const s = document.createElement('style');
        s.innerHTML = `@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}`;
        document.head.appendChild(s);

    </script>
</body>
</html>
