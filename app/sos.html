<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá th·ªëng C·∫£nh b√°o & C·ª©u h·ªô Thi√™n tai</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        /* Map Container */
        #map { height: 60vh; width: 100%; border-radius: 0.5rem; }
        .hidden { display: none !important; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        /* Animation */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Pulse for Emergency */
        .pulse-red { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <header class="bg-white shadow-md z-20 px-4 py-3 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-tower-broadcast text-red-600 text-xl animate-pulse"></i>
            <h1 class="font-bold text-lg text-gray-800">C·ª©u H·ªô 24/7</h1>
        </div>
        <div id="user-area" class="flex items-center gap-3">
            <button id="btn-login" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
                ƒêƒÉng nh·∫≠p
            </button>
            <div id="user-info" class="hidden flex items-center gap-2">
                <span id="user-name" class="text-sm font-medium truncate max-w-[100px]">User</span>
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-gray-300">
                <button id="btn-logout" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>
    </header>

    <nav class="bg-white border-b border-gray-200 shrink-0 z-10">
        <div class="grid grid-cols-3 text-center">
            <button onclick="switchTab('warnings')" id="tab-warnings" class="tab-btn py-3 text-sm font-semibold border-b-2 border-orange-500 text-orange-600 bg-orange-50">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i> C·∫£nh B√°o
            </button>
            <button onclick="switchTab('rescue')" id="tab-rescue" class="tab-btn py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-red-600">
                <i class="fa-solid fa-life-ring mr-1"></i> C·ª©u H·ªô
            </button>
            <button onclick="switchTab('units')" id="tab-units" class="tab-btn py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                <i class="fa-solid fa-shield-halved mr-1"></i> ƒê∆°n V·ªã
            </button>
        </div>
    </nav>

    <main class="flex-1 overflow-y-auto p-4 relative" id="main-content">
        
        <div class="mb-4 shadow-lg border border-gray-200 rounded-lg overflow-hidden bg-gray-200 relative">
            <div id="map"></div>
            <div id="loc-permission-warning" class="absolute top-0 left-0 w-full h-full bg-gray-900 bg-opacity-80 flex items-center justify-center flex-col text-white p-6 text-center z-[5] hidden">
                <i class="fa-solid fa-location-slash text-4xl mb-3 text-red-500"></i>
                <h3 class="font-bold text-lg">Y√™u c·∫ßu v·ªã tr√≠</h3>
                <p class="text-sm text-gray-300 mt-2">B·∫°n ph·∫£i cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.</p>
                <button onclick="requestLocation()" class="mt-4 bg-blue-600 px-4 py-2 rounded text-sm">Th·ª≠ l·∫°i</button>
            </div>
        </div>

        <section id="content-warnings" class="fade-in space-y-4 pb-20">
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-gray-700">‚ö†Ô∏è Danh s√°ch c·∫£nh b√°o</h2>
                <select id="filter-warning" class="text-sm border rounded p-1 bg-white">
                    <option value="all">T·∫•t c·∫£ m·ª©c ƒë·ªô</option>
                    <option value="Cao">Cao</option>
                    <option value="C·ª±c k·ª≥ nguy hi·ªÉm">C·ª±c k·ª≥ nguy hi·ªÉm</option>
                </select>
            </div>
            <div id="list-warnings" class="space-y-3">
                <div class="text-center text-gray-400 py-4">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </section>

        <section id="content-rescue" class="hidden fade-in space-y-4 pb-20">
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-red-600">üÜò Y√™u c·∫ßu c·ª©u h·ªô kh·∫©n c·∫•p</h2>
                <button onclick="showMyRequests()" class="text-sm text-blue-600 underline">Y√™u c·∫ßu c·ªßa t√¥i</button>
            </div>
            <div id="list-rescue" class="space-y-3">
                </div>
        </section>

        <section id="content-units" class="hidden fade-in space-y-4 pb-20">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <h2 class="font-bold text-blue-700">üõ°Ô∏è ƒê∆°n v·ªã c·ª©u h·ªô</h2>
                <div class="flex gap-2">
                    <label for="excel-upload" class="cursor-pointer bg-green-600 text-white px-2 py-1 rounded text-xs flex items-center gap-1 hover:bg-green-700">
                        <i class="fa-solid fa-file-excel"></i> Import Excel
                    </label>
                    <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(this)">
                </div>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                <h3 class="font-bold text-sm text-blue-800 mb-2">üèõÔ∏è L·ª±c l∆∞·ª£ng ch·ª©c nƒÉng (M·∫∑c ƒë·ªãnh)</h3>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <a href="tel:114" class="bg-white p-2 rounded shadow-sm flex items-center gap-2 hover:bg-gray-50">
                        <i class="fa-solid fa-fire-extinguisher text-red-500"></i>
                        <div><div class="font-bold">114</div><div class="text-[10px] text-gray-500">C·ª©u h·ªèa/CNCH</div></div>
                    </a>
                    <a href="tel:115" class="bg-white p-2 rounded shadow-sm flex items-center gap-2 hover:bg-gray-50">
                        <i class="fa-solid fa-truck-medical text-red-500"></i>
                        <div><div class="font-bold">115</div><div class="text-[10px] text-gray-500">C·∫•p c·ª©u</div></div>
                    </a>
                </div>
            </div>

            <div id="list-units" class="space-y-3 mt-2">
                </div>
        </section>
    </main>

    <button id="fab-add" onclick="openCreateModal()" class="fixed bottom-6 right-6 bg-red-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-red-700 transition z-30 pulse-red">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div id="modal-login" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg w-full max-w-sm p-6 shadow-xl">
            <h3 class="text-xl font-bold mb-4 text-center">ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</h3>
            <p class="text-sm text-gray-500 mb-6 text-center">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i c·∫£nh b√°o ho·∫∑c y√™u c·∫ßu c·ª©u h·ªô.</p>
            
            <button onclick="authGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded mb-3 flex items-center justify-center gap-2 hover:bg-gray-50">
                <i class="fa-brands fa-google text-red-500"></i> Google
            </button>
            
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-300"></span></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Ho·∫∑c SƒêT</span></div>
            </div>

            <div id="phone-auth-container">
                <input type="tel" id="phone-number" placeholder="+84 912..." class="w-full border p-2 rounded mb-2">
                <div id="recaptcha-container" class="mb-2"></div>
                <button onclick="authPhone()" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded hover:bg-green-700">G·ª≠i OTP</button>
            </div>
            
            <div id="otp-container" class="hidden mt-3">
                <input type="text" id="otp-code" placeholder="Nh·∫≠p m√£ OTP" class="w-full border p-2 rounded mb-2 text-center tracking-widest">
                <button onclick="verifyOTP()" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded">X√°c th·ª±c</button>
            </div>

            <button onclick="closeModal('modal-login')" class="mt-4 w-full text-center text-sm text-gray-500 hover:underline">ƒê√≥ng</button>
        </div>
    </div>

    <div id="modal-create" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="bg-white rounded-t-xl sm:rounded-lg w-full max-w-lg p-6 shadow-xl h-[90vh] sm:h-auto overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold">T·∫°o m·ªõi</h3>
                <button onclick="closeModal('modal-create')" class="text-gray-500 text-xl"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <form id="form-create" onsubmit="handleSubmit(event)">
                <input type="hidden" id="entry-type" value="warning"> <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">Ti√™u ƒë·ªÅ / Lo·∫°i s·ª± c·ªë</label>
                    <select id="inp-category" class="w-full border p-2 rounded bg-gray-50" onchange="checkOtherOption(this)">
                        </select>
                    <input type="text" id="inp-category-other" placeholder="Nh·∫≠p c·ª• th·ªÉ..." class="w-full border p-2 rounded mt-2 hidden">
                </div>

                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">M·ª©c ƒë·ªô nghi√™m tr·ªçng</label>
                    <select id="inp-severity" class="w-full border p-2 rounded bg-gray-50">
                        <option value="Th·∫•p">Th·∫•p</option>
                        <option value="Trung b√¨nh">Trung b√¨nh</option>
                        <option value="Cao" class="text-orange-600 font-bold">Cao</option>
                        <option value="C·ª±c k·ª≥ nguy hi·ªÉm" class="text-red-600 font-bold">C·ª±c k·ª≥ nguy hi·ªÉm (SOS)</option>
                    </select>
                </div>

                <div id="fields-rescue" class="hidden space-y-3 mb-3 border-l-4 border-red-500 pl-3 bg-red-50 p-2 rounded">
                    <div>
                        <label class="block text-sm font-medium">S·ªë ng∆∞·ªùi g·∫∑p n·∫°n</label>
                        <input type="number" id="inp-people" class="w-full border p-2 rounded" placeholder="VD: 3">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">T√¨nh tr·∫°ng s·ª©c kh·ªèe</label>
                        <input type="text" id="inp-health" class="w-full border p-2 rounded" placeholder="VD: B·ªã th∆∞∆°ng ch√¢n...">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">M√¥ t·∫£ chi ti·∫øt (B·∫Øt bu·ªôc)</label>
                    <textarea id="inp-desc" rows="3" class="w-full border p-2 rounded" required placeholder="M√¥ t·∫£ hi·ªán tr∆∞·ªùng, ƒë·ªãa h√¨nh..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="block text-sm font-medium mb-1">S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá</label>
                    <input type="tel" id="inp-phone" class="w-full border p-2 rounded bg-gray-100" readonly>
                    <p class="text-xs text-gray-500 mt-1">*L·∫•y t·ª´ th√¥ng tin ƒëƒÉng nh·∫≠p</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">V·ªã tr√≠ hi·ªán t·∫°i (GPS)</label>
                    <div class="flex gap-2">
                        <input type="text" id="inp-location-text" class="w-full border p-2 rounded bg-gray-100 text-xs" readonly value="ƒêang l·∫•y v·ªã tr√≠...">
                        <input type="hidden" id="inp-lat">
                        <input type="hidden" id="inp-lng">
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700 transition">
                    G·ª¨I NGAY
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithPhoneNumber, RecaptchaVerifier, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- C·∫§U H√åNH FIREBASE (THAY TH·∫æ C·ª¶A B·∫†N V√ÄO ƒê√ÇY) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            window.db = db; // Export for global usage if needed
            window.auth = auth;
        } catch (e) {
            console.error("Firebase config missing or invalid.");
            alert("Vui l√≤ng c·∫•u h√¨nh Firebase Config trong code index.html!");
        }

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let currentLocation = null;
        let map = null;
        let markers = [];
        let currentTab = 'warnings';
        let userPhone = "";

        // --- AUTH LOGIC ---
        window.authGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                checkUserPhone(result.user);
            } catch (error) {
                showToast("L·ªói ƒëƒÉng nh·∫≠p: " + error.message, "error");
            }
        };

        // Phone Auth Setup
        window.setupRecaptcha = () => {
            if(!window.recaptchaVerifier) {
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'normal',
                    'callback': (response) => { /* reCAPTCHA solved */ }
                });
            }
        };

        window.authPhone = async () => {
            const phoneNumber = document.getElementById('phone-number').value;
            if(!phoneNumber) return showToast("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i", "error");
            
            setupRecaptcha();
            const appVerifier = window.recaptchaVerifier;
            
            try {
                window.confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                document.getElementById('phone-auth-container').classList.add('hidden');
                document.getElementById('otp-container').classList.remove('hidden');
                showToast("ƒê√£ g·ª≠i m√£ OTP", "info");
            } catch (error) {
                showToast("L·ªói g·ª≠i OTP: " + error.message, "error");
            }
        };

        window.verifyOTP = async () => {
            const code = document.getElementById('otp-code').value;
            try {
                const result = await window.confirmationResult.confirm(code);
                closeModal('modal-login');
                // Phone login automatically has phone number
            } catch (error) {
                showToast("M√£ OTP kh√¥ng ƒë√∫ng", "error");
            }
        };

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Update UI
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-name').innerText = user.displayName || user.phoneNumber || "Ng∆∞·ªùi d√πng";
                document.getElementById('user-avatar').src = user.photoURL || "https://ui-avatars.com/api/?name=" + (user.displayName || "U");
                closeModal('modal-login');
                
                // Check Phone requirement
                if(!user.phoneNumber && !userPhone) {
                    // In a real app, prompt to add phone number here
                    // For this demo, we'll simulate prompting
                    const phone = prompt("Vui l√≤ng c·∫≠p nh·∫≠t s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ li√™n h·ªá kh·∫©n c·∫•p:");
                    if(phone) userPhone = phone; 
                } else {
                    userPhone = user.phoneNumber;
                }
            } else {
                currentUser = null;
                document.getElementById('btn-login').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
            }
        });

        document.getElementById('btn-login').onclick = () => document.getElementById('modal-login').classList.remove('hidden');
        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // --- DATABASE LISTENERS ---
        // Listen to Warnings
        const qWarnings = query(collection(db, "warnings"), orderBy("timestamp", "desc"));
        onSnapshot(qWarnings, (snapshot) => {
            if(currentTab === 'warnings') renderList(snapshot.docs, 'warning');
            updateMapMarkers(snapshot.docs, 'warning');
        });

        // Listen to Rescue
        const qRescue = query(collection(db, "rescues"), orderBy("severityScore", "desc")); // Order by urgency
        onSnapshot(qRescue, (snapshot) => {
            if(currentTab === 'rescue') renderList(snapshot.docs, 'rescue');
            // Merge markers if needed, but usually we clear and redraw based on tab or show all
        });

        // Listen to Units
        const qUnits = query(collection(db, "units"));
        onSnapshot(qUnits, (snapshot) => {
            if(currentTab === 'units') renderList(snapshot.docs, 'unit');
        });

        // --- DOM & LOGIC FUNCTIONS ---
        
        window.switchTab = (tabName) => {
            currentTab = tabName;
            // Update UI Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-orange-500', 'text-orange-600', 'bg-orange-50');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-orange-500', 'text-orange-600', 'bg-orange-50');

            // Show Content
            ['warnings', 'rescue', 'units'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            // FAB Styling based on tab
            const fab = document.getElementById('fab-add');
            if(tabName === 'rescue') {
                fab.className = "fixed bottom-6 right-6 bg-red-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-red-700 transition z-30 pulse-red";
            } else if (tabName === 'units') {
                fab.className = "fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-blue-700 transition z-30";
            } else {
                fab.className = "fixed bottom-6 right-6 bg-orange-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-orange-600 transition z-30";
            }

            // Refresh List data
            refreshDataForTab(tabName);
        };

        function refreshDataForTab(tab) {
             // Logic triggers re-render via onSnapshot, but we might want to update Map bounds here
        }

        window.renderList = (docs, type) => {
            const container = document.getElementById(type === 'warning' ? 'list-warnings' : (type === 'rescue' ? 'list-rescue' : 'list-units'));
            container.innerHTML = "";

            if(docs.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-4">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>`;
                return;
            }

            docs.forEach(docSnap => {
                const data = docSnap.data();
                const id = docSnap.id;
                const isOwner = currentUser && data.uid === currentUser.uid;
                
                // Calculate distance
                let distStr = "";
                if(currentLocation && data.location) {
                    const d = getDistanceFromLatLonInKm(currentLocation.lat, currentLocation.lng, data.location.lat, data.location.lng);
                    distStr = `${d.toFixed(1)} km`;
                }

                let html = "";
                if(type === 'warning') {
                    html = `
                    <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${data.severity === 'C·ª±c k·ª≥ nguy hi·ªÉm' ? 'border-red-600' : 'border-orange-400'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-gray-800">${data.category}</h3>
                                <div class="text-xs text-gray-500 mb-1">${new Date(data.timestamp?.toDate()).toLocaleString('vi-VN')}</div>
                            </div>
                            <span class="text-xs font-bold ${data.severity === 'C·ª±c k·ª≥ nguy hi·ªÉm' ? 'text-red-600 bg-red-100' : 'text-orange-600 bg-orange-100'} px-2 py-1 rounded">${data.severity}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">${data.description}</p>
                        <div class="mt-3 flex justify-between items-center text-sm">
                            <span class="text-blue-600 font-medium"><i class="fa-solid fa-location-arrow"></i> ${distStr}</span>
                            <div class="flex gap-2">
                                <button onclick="focusMap(${data.location.lat}, ${data.location.lng})" class="text-gray-600 hover:text-blue-600"><i class="fa-solid fa-map"></i> B·∫£n ƒë·ªì</button>
                                ${isOwner ? `<button onclick="deleteItem('warnings', '${id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button>` : ''}
                            </div>
                        </div>
                    </div>`;
                } else if (type === 'rescue') {
                    html = `
                    <div class="bg-red-50 p-4 rounded-lg shadow-sm border border-red-200 relative overflow-hidden">
                        ${data.severityScore >= 4 ? '<div class="absolute top-0 right-0 bg-red-600 text-white text-[10px] px-2 py-1">SOS KH·∫®N C·∫§P</div>' : ''}
                        <h3 class="font-bold text-red-700 text-lg">${data.category}</h3>
                        <div class="text-sm mt-1"><strong>N·∫°n nh√¢n:</strong> ${data.peopleCount} ng∆∞·ªùi - ${data.health}</div>
                        <p class="text-sm text-gray-700 mt-2 italic">"${data.description}"</p>
                        <div class="mt-4 flex gap-2">
                            <a href="tel:${data.phone}" class="flex-1 bg-green-600 text-white text-center py-2 rounded text-sm font-bold hover:bg-green-700"><i class="fa-solid fa-phone"></i> G·ªçi ${data.phone}</a>
                            <button onclick="navigate(${data.location.lat}, ${data.location.lng})" class="flex-1 bg-blue-600 text-white text-center py-2 rounded text-sm font-bold hover:bg-blue-700"><i class="fa-solid fa-diamond-turn-right"></i> Ch·ªâ ƒë∆∞·ªùng</button>
                        </div>
                        ${isOwner ? `<button onclick="deleteItem('rescues', '${id}')" class="absolute bottom-2 right-2 text-gray-400 hover:text-red-500 text-xs">X√≥a</button>` : ''}
                    </div>`;
                } else if (type === 'unit') {
                    html = `
                    <div class="bg-white p-3 rounded shadow-sm border border-blue-100 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-blue-800">${data.name}</div>
                            <div class="text-xs text-gray-500">${data.type}</div>
                        </div>
                        <div class="flex gap-2">
                            <a href="tel:${data.phone}" class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i class="fa-solid fa-phone"></i></a>
                            <button onclick="navigate(${data.location.lat}, ${data.location.lng})" class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-diamond-turn-right"></i></button>
                        </div>
                    </div>`;
                }
                container.innerHTML += html;
            });
        };

        // --- MAP FUNCTIONS ---
        window.initMap = () => {
            // Default center (Vietnam)
            const defaultPos = { lat: 16.047079, lng: 108.206230 };
            
            // Check if Google Maps is loaded
            if (typeof google === 'undefined') {
                document.getElementById('map').innerHTML = '<div class="flex items-center justify-center h-full bg-gray-200">L·ªói: Ch∆∞a load ƒë∆∞·ª£c Google Maps API. Vui l√≤ng ki·ªÉm tra API Key.</div>';
                return;
            }

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 5,
                center: defaultPos,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            // Try to get user location immediately
            requestLocation();
        };

        window.requestLocation = () => {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    currentLocation = pos;
                    document.getElementById('loc-permission-warning').classList.add('hidden');
                    
                    // Update user marker
                    // (Implementation simplified for brevity: remove old marker, add new one)
                    new google.maps.Marker({
                        position: pos,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: "#4285F4",
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: "white",
                        },
                        title: "V·ªã tr√≠ c·ªßa b·∫°n"
                    });

                    // Only pan once initially
                    if(!window.initialPanDone) {
                        map.setCenter(pos);
                        map.setZoom(12);
                        window.initialPanDone = true;
                    }

                    // Update inputs in modal
                    document.getElementById('inp-lat').value = pos.lat;
                    document.getElementById('inp-lng').value = pos.lng;
                    // Reverse Geocode for address text
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: pos }, (results, status) => {
                        if (status === "OK" && results[0]) {
                            document.getElementById('inp-location-text').value = results[0].formatted_address;
                        }
                    });

                }, (error) => {
                    console.error("L·ªói v·ªã tr√≠:", error);
                    document.getElementById('loc-permission-warning').classList.remove('hidden');
                });
            } else {
                alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.");
            }
        };

        window.updateMapMarkers = (docs, type) => {
            if(!map) return;
            // Clear old markers (Not fully implemented in this snippet for brevity, assumes refresh)
            // In production: keep track of markers array and clear.
            
            docs.forEach(docSnap => {
                const data = docSnap.data();
                if(!data.location) return;

                let iconColor = type === 'warning' ? 'orange' : 'red';
                // Simple marker
                new google.maps.Marker({
                    position: data.location,
                    map: map,
                    title: data.category,
                    icon: {
                        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                        scale: 5,
                        fillColor: iconColor,
                        fillOpacity: 0.8,
                        strokeWeight: 1
                    }
                });
            });
        };

        window.focusMap = (lat, lng) => {
            map.setCenter({lat, lng});
            map.setZoom(15);
            document.getElementById('main-content').scrollTop = 0;
        };

        window.navigate = (lat, lng) => {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
        };

        // --- CRUD OPERATIONS ---
        window.openCreateModal = () => {
            if(!currentUser) {
                showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!", "error");
                document.getElementById('modal-login').classList.remove('hidden');
                return;
            }
            if(!currentLocation) {
                showToast("ƒêang l·∫•y v·ªã tr√≠, vui l√≤ng ƒë·ª£i...", "info");
                return;
            }

            const modal = document.getElementById('modal-create');
            const title = document.getElementById('modal-title');
            const entryType = document.getElementById('entry-type');
            const catSelect = document.getElementById('inp-category');
            const rescueFields = document.getElementById('fields-rescue');

            modal.classList.remove('hidden');
            document.getElementById('inp-phone').value = userPhone || "";

            // Setup based on Tab
            if(currentTab === 'warnings') {
                title.innerText = "T·∫°o C·∫£nh B√°o M·ªõi";
                entryType.value = "warning";
                rescueFields.classList.add('hidden');
                catSelect.innerHTML = `
                    <option value="S·∫°t l·ªü">S·∫°t l·ªü ƒë·∫•t</option>
                    <option value="L≈© l·ª•t">L≈© l·ª•t / N∆∞·ªõc d√¢ng</option>
                    <option value="Ch√°y r·ª´ng">Ch√°y r·ª´ng</option>
                    <option value="Tai n·∫°n">Tai n·∫°n giao th√¥ng</option>
                    <option value="Kh√°c">Kh√°c...</option>
                `;
            } else if (currentTab === 'rescue') {
                title.innerText = "Y√äU C·∫¶U C·ª®U H·ªò KH·∫®N C·∫§P";
                entryType.value = "rescue";
                rescueFields.classList.remove('hidden');
                catSelect.innerHTML = `
                    <option value="M·∫Øc k·∫πt do l≈©">M·∫Øc k·∫πt do l≈©</option>
                    <option value="B·ªã th∆∞∆°ng n·∫∑ng">B·ªã th∆∞∆°ng n·∫∑ng</option>
                    <option value="C√¥ l·∫≠p thi·∫øu l∆∞∆°ng th·ª±c">C√¥ l·∫≠p / Thi·∫øu l∆∞∆°ng th·ª±c</option>
                    <option value="Kh√°c">Kh√°c...</option>
                `;
            } else {
                // Add unit
                title.innerText = "Th√™m ƒê∆°n V·ªã C·ª©u H·ªô";
                entryType.value = "unit";
                rescueFields.classList.add('hidden');
                catSelect.innerHTML = `
                    <option value="T√¨nh nguy·ªán vi√™n">T√¨nh nguy·ªán vi√™n</option>
                    <option value="ƒê·ªôi xe 0 ƒë·ªìng">ƒê·ªôi xe 0 ƒë·ªìng</option>
                    <option value="Cano c·ª©u h·ªô">Cano c·ª©u h·ªô</option>
                `;
            }
        };

        window.handleSubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('entry-type').value;
            const category = document.getElementById('inp-category').value === 'Kh√°c' 
                ? document.getElementById('inp-category-other').value 
                : document.getElementById('inp-category').value;
            
            const baseData = {
                uid: currentUser.uid,
                createdBy: currentUser.displayName || "·∫®n danh",
                phone: document.getElementById('inp-phone').value,
                description: document.getElementById('inp-desc').value,
                location: {
                    lat: parseFloat(document.getElementById('inp-lat').value),
                    lng: parseFloat(document.getElementById('inp-lng').value)
                },
                timestamp: serverTimestamp()
            };

            try {
                if(type === 'warning') {
                    await addDoc(collection(db, "warnings"), {
                        ...baseData,
                        category: category,
                        severity: document.getElementById('inp-severity').value
                    });
                } else if (type === 'rescue') {
                    // Calculate severity score (1-5)
                    const severityMap = {"Th·∫•p": 1, "Trung b√¨nh": 3, "Cao": 4, "C·ª±c k·ª≥ nguy hi·ªÉm": 5};
                    const score = severityMap[document.getElementById('inp-severity').value] || 3;
                    
                    await addDoc(collection(db, "rescues"), {
                        ...baseData,
                        category: category,
                        peopleCount: document.getElementById('inp-people').value,
                        health: document.getElementById('inp-health').value,
                        severityScore: score
                    });
                } else if (type === 'unit') {
                    await addDoc(collection(db, "units"), {
                        name: category, // Using category as Name for simplicity in this form
                        type: document.getElementById('inp-category').value,
                        phone: baseData.phone,
                        location: baseData.location,
                        uid: baseData.uid
                    });
                }
                showToast("ƒê√£ g·ª≠i th√†nh c√¥ng!", "success");
                closeModal('modal-create');
                document.getElementById('form-create').reset();
            } catch (err) {
                console.error(err);
                showToast("L·ªói khi g·ª≠i d·ªØ li·ªáu.", "error");
            }
        };

        window.deleteItem = async (col, id) => {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y?")) {
                try {
                    await deleteDoc(doc(db, col, id));
                    showToast("ƒê√£ x√≥a.", "success");
                } catch (e) {
                    showToast("L·ªói x√≥a: " + e.message, "error");
                }
            }
        };

        // --- UTILS ---
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.checkOtherOption = (select) => {
            const otherInp = document.getElementById('inp-category-other');
            if(select.value === 'Kh√°c') otherInp.classList.remove('hidden');
            else otherInp.classList.add('hidden');
        };

        window.showToast = (msg, type) => {
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: type === "error" ? "#ef4444" : (type === "success" ? "#22c55e" : "#3b82f6"),
                }
            }).showToast();
        };

        // Haversine formula
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }
        function deg2rad(deg) { return deg * (Math.PI/180) }

        // Excel Import
        window.handleExcelUpload = (input) => {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);
                
                // Process JSON and upload to Firestore
                json.forEach(async (row) => {
                    // Mapping expected: Name, Phone, Lat, Lng, Type
                    if(row.Name && row.Lat && row.Lng) {
                        try {
                            await addDoc(collection(db, "units"), {
                                name: row.Name,
                                phone: row.Phone || "",
                                type: row.Type || "H·ªó tr·ª£",
                                location: { lat: row.Lat, lng: row.Lng },
                                imported: true
                            });
                        } catch(e) { console.error("Import error row", row); }
                    }
                });
                showToast(`ƒê√£ import ${json.length} d√≤ng!`, "success");
            };
            reader.readAsArrayBuffer(file);
        };

    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap">
    </script>
</body>
</html>
