
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá th·ªëng C·ª©u H·ªô Qu·ªëc Gia 2025 (Pro UI)</title>

    <!-- 1. CORE LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. UI & ALERTS (SweetAlert2 - ƒê·∫πp thay th·∫ø alert m·∫∑c ƒë·ªãnh) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- 3. EXCEL -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- 4. FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- 5. MAP -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background: #f0f2f5; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Markers & Avatar */
        .avatar-marker {
            width: 48px; height: 48px; border-radius: 50%; 
            border: 3px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            background: #fff; overflow: hidden; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .avatar-marker:hover { transform: scale(1.2) translateY(-5px); z-index: 9999 !important; }
        
        /* Verified Badge on Marker */
        .marker-badge {
            position: absolute; bottom: 0; right: 0; width: 16px; height: 16px;
            background: #22c55e; border: 2px solid white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;
        }

        /* Pulse Animation for SOS */
        .sos-pulse::after {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%; border: 2px solid #ef4444;
            animation: pulse-ring 1.5s infinite; z-index: -1;
        }
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .glass-dark { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); }

        /* Status Badges */
        .badge-verified { background: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .badge-risk { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }

        /* Popup Styling */
        .leaflet-popup-content-wrapper { border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row text-slate-800">

    <!-- LOADING OVERLAY -->
    <div id="loading" class="fixed inset-0 bg-white/80 z-[99999] flex flex-col items-center justify-center hidden backdrop-blur-md">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center font-bold text-blue-600 text-xs">VN</div>
        </div>
        <p class="mt-4 text-slate-600 font-semibold animate-pulse">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</p>
    </div>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-[9000] flex items-center justify-center p-4 bg-[url('https://images.unsplash.com/photo-1454789476662-53eb23ba5907?q=80&w=2552&auto=format&fit=crop')] bg-cover bg-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="relative bg-white/90 backdrop-blur-xl rounded-3xl p-8 w-full max-w-sm shadow-2xl border border-white/20 text-center animate__animated animate__zoomIn">
            <div class="w-20 h-20 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/30">
                <i class="fas fa-shield-alt text-4xl text-white"></i>
            </div>
            <h1 class="text-2xl font-black text-slate-800 mb-1">C·ª®U H·ªò QU·ªêC GIA</h1>
            <p class="text-slate-500 text-sm mb-8 font-medium">H·ªá th·ªëng ph·∫£n ·ª©ng nhanh 2025</p>
            
            <button onclick="loginWithGoogle()" class="w-full bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 rounded-xl flex items-center justify-center gap-3 shadow-md transition-all hover:scale-[1.02]">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6">
                <span>Ti·∫øp t·ª•c v·ªõi Google</span>
            </button>
        </div>
    </div>

    <!-- 2. LEFT PANEL (CONTROLS) -->
    <div class="w-full md:w-[460px] bg-white flex flex-col shadow-2xl z-[1000] order-2 md:order-1 h-[60vh] md:h-full relative border-r border-gray-200">
        
        <!-- User Header -->
        <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0 shadow-md">
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="openProfile()">
                <div class="relative">
                    <img id="header-avatar" src="" class="w-10 h-10 rounded-full border-2 border-slate-600 object-cover">
                    <div id="header-badge" class="absolute -bottom-1 -right-1 bg-green-500 text-[8px] w-4 h-4 flex items-center justify-center rounded-full border border-slate-800"><i class="fas fa-check"></i></div>
                </div>
                <div>
                    <h2 id="header-name" class="font-bold text-sm truncate max-w-[140px]">Kh√°ch</h2>
                    <span class="text-[10px] text-slate-400 block">Nh·∫•n ƒë·ªÉ xem h·ªì s∆°</span>
                </div>
            </div>
            <button onclick="logout()" class="w-9 h-9 rounded-full bg-white/10 hover:bg-red-500 hover:text-white transition flex items-center justify-center backdrop-blur"><i class="fas fa-power-off text-xs"></i></button>
        </div>

        <!-- Tabs -->
        <div class="flex border-b bg-white shrink-0 shadow-sm z-10">
            <button onclick="switchTab('warning')" id="tab-warning" class="flex-1 py-3.5 text-[10px] font-bold uppercase border-b-4 border-yellow-500 text-yellow-700 bg-yellow-50/50 transition">C·∫£nh B√°o <span id="cnt-warning" class="ml-1 bg-yellow-200 px-1.5 py-0.5 rounded-full text-[9px]">0</span></button>
            <button onclick="switchTab('sos')" id="tab-sos" class="flex-1 py-3.5 text-[10px] font-bold uppercase border-b-4 border-transparent text-gray-400 hover:text-red-600 transition">SOS <span id="cnt-sos" class="ml-1 bg-gray-100 px-1.5 py-0.5 rounded-full text-[9px]">0</span></button>
            <button onclick="switchTab('units')" id="tab-units" class="flex-1 py-3.5 text-[10px] font-bold uppercase border-b-4 border-transparent text-gray-400 hover:text-blue-600 transition">ƒê∆°n v·ªã <span id="cnt-units" class="ml-1 bg-gray-100 px-1.5 py-0.5 rounded-full text-[9px]">0</span></button>
            <button onclick="switchTab('my')" id="tab-my" class="flex-1 py-3.5 text-[10px] font-bold uppercase border-b-4 border-transparent text-blue-600 hover:bg-blue-50 transition"><i class="fas fa-user mr-1"></i>C·ªßa t√¥i</button>
        </div>

        <!-- Content Lists -->
        <div class="flex-1 overflow-y-auto p-3 bg-gray-50 relative scroll-smooth">
            
            <!-- WARNING -->
            <div id="content-warning" class="space-y-3 pb-24">
                <input type="text" id="search-warning" onkeyup="renderWarnings()" placeholder="üîç T√¨m ki·∫øm c·∫£nh b√°o..." class="w-full text-sm border-0 ring-1 ring-gray-200 rounded-xl px-4 py-3 shadow-sm focus:ring-2 focus:ring-yellow-500 outline-none mb-2">
                <div id="list-warning" class="space-y-3"></div>
            </div>

            <!-- SOS -->
            <div id="content-sos" class="hidden space-y-3 pb-24">
                <input type="text" id="search-sos" onkeyup="renderSOS()" placeholder="üîç T√¨m ki·∫øm n·∫°n nh√¢n, v·ªã tr√≠ SOS..." class="w-full text-sm border-0 ring-1 ring-gray-200 rounded-xl px-4 py-3 shadow-sm focus:ring-2 focus:ring-red-500 outline-none mb-2">
                <div id="list-sos" class="space-y-3"></div>
            </div>

            <!-- UNITS -->
            <div id="content-units" class="hidden space-y-3 pb-24">
                <input type="text" id="search-units" onkeyup="renderUnits()" placeholder="üîç T√¨m ƒë·ªôi c·ª©u h·ªô, xe, xu·ªìng..." class="w-full text-sm border-0 ring-1 ring-gray-200 rounded-xl px-4 py-3 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none mb-2">
                <div class="flex gap-2 mb-2">
                    <button onclick="downloadExcelTemplate()" class="flex-1 text-[11px] bg-white border border-gray-200 text-gray-600 py-2.5 rounded-xl font-bold hover:bg-gray-100 shadow-sm transition"><i class="fas fa-file-download mr-1"></i> M·∫´u Excel</button>
                    <button onclick="document.getElementById('excel-input').click()" class="flex-1 text-[11px] bg-green-50 border border-green-200 text-green-700 py-2.5 rounded-xl font-bold hover:bg-green-100 shadow-sm transition"><i class="fas fa-file-excel mr-1"></i> Import</button>
                    <input type="file" id="excel-input" accept=".xlsx" class="hidden" onchange="importExcel(event)">
                </div>
                <div id="list-units" class="space-y-3"></div>
            </div>

            <!-- MY ITEMS -->
            <div id="content-my" class="hidden space-y-4 pb-24">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-2xl border border-blue-100 flex gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-lg"><i class="fas fa-tasks"></i></div>
                    <div>
                        <h4 class="font-bold text-sm text-blue-900">Trung t√¢m qu·∫£n l√Ω</h4>
                        <p class="text-xs text-blue-600 mt-1">C·∫≠p nh·∫≠t tr·∫°ng th√°i ho·∫∑c x√≥a tin khi ƒë√£ x·ª≠ l√Ω xong.</p>
                    </div>
                </div>
                <div id="my-lists-container" class="space-y-4"></div>
            </div>
        </div>

        <!-- FAB BUTTON -->
        <button onclick="openCreateModal()" id="fab" class="absolute bottom-6 right-6 w-14 h-14 bg-gradient-to-tr from-indigo-600 to-blue-500 text-white rounded-full shadow-lg shadow-blue-500/40 flex items-center justify-center text-2xl hover:scale-110 active:scale-95 transition z-[1001] border-4 border-white">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- 3. RIGHT MAP -->
    <div class="flex-1 relative order-1 md:order-2 h-[45vh] md:h-full border-l border-gray-200 bg-gray-100">
        <div id="map" class="w-full h-full z-0 outline-none"></div>
        <div class="absolute bottom-6 right-6 flex flex-col gap-2 z-[900]">
             <button onclick="locateUser()" class="bg-white text-slate-700 w-12 h-12 rounded-2xl shadow-lg hover:text-blue-600 flex items-center justify-center transition"><i class="fas fa-crosshairs text-lg"></i></button>
        </div>
        
        <!-- Picker Hint -->
        <div id="map-picker-hint" class="absolute top-6 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl z-[9999] hidden flex items-center gap-3 animate-bounce cursor-pointer hover:bg-slate-700" onclick="cancelPick()">
            <i class="fas fa-map-pin text-yellow-400"></i>
            <span class="text-sm font-bold">Ch·∫°m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ghim v·ªã tr√≠</span>
            <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded ml-2 uppercase tracking-wide">H·ªßy</span>
        </div>
    </div>

    <!-- 4. PROFILE MODAL -->
    <div id="profile-modal" class="fixed inset-0 bg-black/50 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm animate__animated animate__fadeIn">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden relative">
            <button onclick="closeProfile()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
            
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 h-32 flex items-center justify-center relative">
                <div class="absolute -bottom-10">
                    <img id="prof-avatar" src="" class="w-24 h-24 rounded-full border-4 border-white shadow-md bg-gray-200 object-cover">
                    <div id="prof-badge-icon" class="absolute bottom-1 right-1 w-6 h-6 bg-gray-400 border-2 border-white rounded-full flex items-center justify-center text-white text-xs"><i class="fas fa-check"></i></div>
                </div>
            </div>
            
            <div class="pt-12 pb-6 px-6 text-center">
                <h3 id="prof-name" class="text-xl font-bold text-slate-800">User Name</h3>
                <div id="prof-status" class="inline-block mt-1 px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-500">Ch∆∞a x√°c minh</div>
                
                <div class="mt-6 space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase">T√™n hi·ªÉn th·ªã</label>
                        <input id="edit-name" type="text" class="w-full border-b border-gray-200 py-2 text-sm font-bold text-slate-700 focus:border-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase">S·ªë ƒëi·ªán tho·∫°i (2FA)</label>
                        <div class="flex gap-2">
                            <input id="edit-phone" type="tel" class="flex-1 border-b border-gray-200 py-2 text-sm font-bold text-slate-700 focus:border-blue-500 outline-none transition" placeholder="Ch∆∞a c·∫≠p nh·∫≠t">
                            <button onclick="verifyPhone()" class="text-xs text-blue-600 font-bold hover:underline">X√°c minh</button>
                        </div>
                    </div>
                    <div>
                         <label class="text-xs font-bold text-gray-400 uppercase">Email</label>
                         <div class="flex justify-between items-center py-2 border-b border-gray-200">
                             <span id="prof-email" class="text-sm font-medium text-slate-600">email@example.com</span>
                             <button onclick="sendVerifyEmail()" id="btn-verify-email" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded font-bold hover:bg-yellow-200">G·ª≠i Mail XM</button>
                         </div>
                    </div>
                </div>

                <button onclick="saveProfile()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition">L∆∞u Thay ƒê·ªïi</button>
            </div>
        </div>
    </div>

    <!-- 5. DETAIL MODAL -->
    <div id="detail-modal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center p-4 backdrop-blur-sm animate__animated animate__fadeIn">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] relative">
            <button onclick="closeDetail()" class="absolute top-4 right-4 z-10 w-8 h-8 bg-black/20 hover:bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur transition"><i class="fas fa-times"></i></button>
            
            <div id="detail-header-bg" class="h-32 bg-gray-200 relative">
                <div class="absolute bottom-0 left-0 w-full h-16 bg-gradient-to-t from-white to-transparent"></div>
                <div id="detail-badge" class="absolute bottom-4 left-6 px-3 py-1 rounded-lg text-[10px] font-black tracking-wider text-white shadow-sm uppercase">Lo·∫°i tin</div>
            </div>

            <div class="px-6 pb-6 overflow-y-auto custom-scrollbar">
                <h2 id="detail-title" class="text-2xl font-black text-slate-800 leading-tight mb-2">Ti√™u ƒë·ªÅ</h2>
                
                <!-- Metadata -->
                <div class="flex items-center gap-3 text-xs text-gray-500 mb-6">
                    <span class="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded"><i class="far fa-clock"></i> <span id="detail-time">--</span></span>
                    <span class="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded"><i class="fas fa-map-marker-alt"></i> <span id="detail-dist">--</span></span>
                </div>

                <!-- Author -->
                <div class="flex items-center gap-3 mb-6 p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <img id="detail-avatar" class="w-10 h-10 rounded-full border border-white shadow-sm">
                    <div>
                        <div class="flex items-center gap-1">
                            <span id="detail-author" class="font-bold text-sm text-slate-700">T√™n ng∆∞·ªùi ƒëƒÉng</span>
                            <span id="detail-verify-icon"></span>
                        </div>
                        <div id="detail-phone-display" class="text-xs text-slate-500 font-mono">09xx *** ***</div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">N·ªôi dung chi ti·∫øt</h4>
                    <p id="detail-desc" class="text-sm text-slate-700 leading-relaxed whitespace-pre-line bg-white border border-gray-100 p-3 rounded-xl shadow-sm">...</p>
                </div>

                <!-- History -->
                <div class="mb-4">
                     <div class="flex justify-between items-center cursor-pointer mb-2" onclick="document.getElementById('hist-log').classList.toggle('hidden')">
                         <span class="text-xs font-bold text-gray-400 uppercase">L·ªãch s·ª≠ ch·ªânh s·ª≠a</span>
                         <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                     </div>
                     <div id="hist-log" class="hidden text-[10px] text-gray-500 space-y-1 pl-3 border-l-2 border-gray-200 py-1"></div>
                </div>

                <!-- Owner Actions -->
                <div id="detail-owner-actions" class="hidden grid grid-cols-2 gap-3 mb-4">
                    <button onclick="editCurrentItem()" class="py-2 rounded-lg bg-blue-50 text-blue-600 font-bold text-xs hover:bg-blue-100">Ch·ªânh s·ª≠a</button>
                    <button onclick="deleteCurrentItem()" class="py-2 rounded-lg bg-red-50 text-red-600 font-bold text-xs hover:bg-red-100">X√≥a tin n√†y</button>
                </div>

                <!-- Public Actions -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button id="btn-nav" class="py-3.5 rounded-xl border border-gray-200 font-bold text-slate-600 hover:bg-gray-50 flex items-center justify-center gap-2 transition">
                        <i class="fas fa-directions text-blue-500"></i> D·∫´n ƒë∆∞·ªùng
                    </button>
                    <a id="btn-call" href="#" class="py-3.5 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 flex items-center justify-center gap-2 shadow-lg shadow-green-500/30 transition">
                        <i class="fas fa-phone animate-tada"></i> G·ªçi Ngay
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. CREATE FORM MODAL -->
    <div id="create-modal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm animate__animated animate__fadeInUp">
        <div class="bg-white w-full sm:max-w-lg h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-3xl sm:rounded-3xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-5 border-b flex justify-between items-center bg-white shrink-0">
                <h2 id="modal-title" class="font-black text-xl text-slate-800 uppercase">Ti√™u ƒë·ªÅ</h2>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-5">
                <!-- Location Picker -->
                <div onclick="startPickLocation()" class="group relative bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-4 rounded-2xl cursor-pointer hover:shadow-md transition">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1">V·ªã tr√≠ s·ª± c·ªë</div>
                            <div id="loc-text" class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                <i class="fas fa-satellite-dish text-blue-500 animate-pulse"></i> GPS Hi·ªán t·∫°i
                            </div>
                        </div>
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-blue-600 shadow-sm group-hover:scale-110 transition"><i class="fas fa-map-marked-alt"></i></div>
                    </div>
                </div>

                <!-- Dynamic Form -->
                <div id="form-container" class="space-y-4"></div>

                <!-- Common Desc -->
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">M√¥ t·∫£ chi ti·∫øt</label>
                    <textarea id="inp-desc" rows="3" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition" placeholder="M√¥ t·∫£ c·ª• th·ªÉ s·ª± vi·ªác, ƒë·ªãa ch·ªâ..."></textarea>
                </div>
            </div>

            <div class="p-5 border-t bg-white shrink-0">
                <button onclick="submitData()" id="btn-submit" class="w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl shadow-blue-500/20 transform active:scale-95 transition">G·ª¨I TIN</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };
        const SOS_CATS = ["C·∫•p c·ª©u y t·∫ø", "M·∫Øc k·∫πt l≈© l·ª•t", "S·∫≠p nh√†", "Ch√°y n·ªï", "Tai n·∫°n GT", "S·∫°t l·ªü ƒë·∫•t", "ƒêu·ªëi n∆∞·ªõc", "Thi·∫øu l∆∞∆°ng th·ª±c", "C·∫ßn thu·ªëc men", "M·∫•t li√™n l·∫°c", "Kh√°c"];

        // STATE
        let auth, db, map, markersGroup, currentUser, userMarker, tempMarker;
        let currentLocation = { lat: 21.0285, lng: 105.8542 };
        let pickedLocation = null, isPickingMode = false, isEditMode = false, editingItem = null;
        let currentTab = 'warning';
        let allData = { warnings: [], sos: [], units: [] };

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            if(firebaseConfig.apiKey.includes("xxxx")) Swal.fire('L·ªói Config', 'Ch∆∞a nh·∫≠p Firebase API Key!', 'error');
            else {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                checkAuth();
            }
        });

        // AUTH & PROFILE
        function checkAuth() {
            auth.onAuthStateChanged(async (u) => {
                if (u) {
                    currentUser = u;
                    const doc = await db.collection('users').doc(u.uid).get();
                    let userData = doc.exists ? doc.data() : {};
                    // Merge auth data
                    currentUser.dbPhone = userData.phone || "";
                    currentUser.displayName = userData.displayName || u.displayName;
                    
                    updateHeaderProfile();
                    document.getElementById('login-screen').classList.add('hidden');
                    initMap();
                } else document.getElementById('login-screen').classList.remove('hidden');
            });
        }

        function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => Swal.fire('L·ªói', e.message, 'error')); }
        function logout() { Swal.fire({title:'ƒêƒÉng xu·∫•t?', icon:'question', showCancelButton:true}).then(r=>{ if(r.isConfirmed) auth.signOut(); }); }

        function updateHeaderProfile() {
            const isVerified = currentUser.emailVerified || (currentUser.dbPhone && currentUser.dbPhone.length > 9);
            document.getElementById('header-name').innerText = currentUser.displayName;
            document.getElementById('header-avatar').src = currentUser.photoURL;
            document.getElementById('header-badge').className = `absolute -bottom-1 -right-1 w-4 h-4 flex items-center justify-center rounded-full border border-white text-[8px] text-white ${isVerified ? 'bg-green-500' : 'bg-orange-400'}`;
            document.getElementById('header-badge').innerHTML = `<i class="fas fa-${isVerified ? 'check' : 'exclamation'}"></i>`;
        }

        // PROFILE MODAL FUNCTIONS
        function openProfile() {
            const isVerified = currentUser.emailVerified || (currentUser.dbPhone && currentUser.dbPhone.length > 9);
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('prof-avatar').src = currentUser.photoURL;
            document.getElementById('prof-name').innerText = currentUser.displayName;
            document.getElementById('prof-email').innerText = currentUser.email;
            document.getElementById('edit-name').value = currentUser.displayName;
            document.getElementById('edit-phone').value = currentUser.dbPhone;
            
            // UI State
            const statusEl = document.getElementById('prof-status');
            const badgeIcon = document.getElementById('prof-badge-icon');
            
            if(isVerified) {
                statusEl.className = "inline-block mt-1 px-3 py-1 rounded-full text-xs font-bold badge-verified";
                statusEl.innerText = "ƒê√£ x√°c minh danh t√≠nh";
                badgeIcon.className = "absolute bottom-1 right-1 w-6 h-6 bg-green-500 border-2 border-white rounded-full flex items-center justify-center text-white text-xs";
            } else {
                statusEl.className = "inline-block mt-1 px-3 py-1 rounded-full text-xs font-bold badge-risk";
                statusEl.innerText = "Ch∆∞a ki·ªÉm ch·ª©ng";
                badgeIcon.className = "absolute bottom-1 right-1 w-6 h-6 bg-orange-400 border-2 border-white rounded-full flex items-center justify-center text-white text-xs";
            }

            // Button states
            document.getElementById('btn-verify-email').style.display = currentUser.emailVerified ? 'none' : 'block';
        }
        function closeProfile() { document.getElementById('profile-modal').classList.add('hidden'); }
        
        async function saveProfile() {
            const name = document.getElementById('edit-name').value;
            const phone = document.getElementById('edit-phone').value;
            try {
                await db.collection('users').doc(currentUser.uid).set({ displayName: name, phone: phone, email: currentUser.email }, { merge: true });
                await currentUser.updateProfile({ displayName: name });
                currentUser.displayName = name;
                currentUser.dbPhone = phone;
                updateHeaderProfile();
                closeProfile();
                Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t h·ªì s∆°!', 'success');
            } catch(e) { Swal.fire('L·ªói', e.message, 'error'); }
        }

        function verifyPhone() { Swal.fire('T√≠nh nƒÉng s·∫Øp ra m·∫Øt', 'H·ªá th·ªëng x√°c th·ª±c SMS ƒëang ƒë∆∞·ª£c b·∫£o tr√¨.', 'info'); }
        function sendVerifyEmail() { currentUser.sendEmailVerification().then(()=>Swal.fire('ƒê√£ g·ª≠i', 'Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ (c·∫£ m·ª•c Spam).', 'success')); }

        // MAP
        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl:false}).setView([currentLocation.lat, currentLocation.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markersGroup = L.layerGroup().addTo(map);
            if(navigator.geolocation) navigator.geolocation.watchPosition(p => {
                currentLocation = {lat: p.coords.latitude, lng: p.coords.longitude};
                if(userMarker) userMarker.setLatLng(currentLocation);
                else userMarker = L.marker(currentLocation, {icon:L.divIcon({className:'', html:`<div class="w-4 h-4 bg-blue-600 border-2 border-white rounded-full shadow animate-pulse"></div>`})}).addTo(map);
            });
            map.on('click', e => {
                if(isPickingMode) {
                    pickedLocation = e.latlng;
                    if(tempMarker) tempMarker.remove();
                    tempMarker = L.marker(pickedLocation).addTo(map);
                    isPickingMode = false;
                    document.getElementById('map-picker-hint').classList.add('hidden');
                    document.getElementById('create-modal').classList.remove('hidden');
                    document.getElementById('loc-text').innerHTML = `<span class="text-blue-600 font-bold">${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}</span>`;
                }
            });
            ['warnings','sos','units'].forEach(c => listenData(c));
        }

        function listenData(c) {
            db.collection(c).orderBy('timestamp','desc').onSnapshot(s => {
                allData[c] = s.docs.map(d => ({id:d.id, col:c, ...d.data()}));
                updateCounts(); renderCurrentTab(); updateMarkers();
            });
        }
        function updateCounts() { ['warning','sos','units'].forEach(k => document.getElementById('cnt-'+k).innerText = allData[k==='warning'?'warnings':(k==='sos'?'sos':'units')].length); }

        // RENDER LIST
        function switchTab(t) {
            currentTab = t;
            ['warning','sos','units','my'].forEach(k => {
                document.getElementById('content-'+k).classList.add('hidden');
                document.getElementById('tab-'+k).className = `flex-1 py-3.5 text-[10px] font-bold uppercase border-b-4 border-transparent text-gray-400 hover:text-gray-600 transition`;
            });
            document.getElementById('content-'+t).classList.remove('hidden');
            const activeClass = t==='sos'?'border-red-500 text-red-600 bg-red-50/50':(t==='units'?'border-blue-500 text-blue-600 bg-blue-50/50':(t==='my'?'border-blue-600 text-blue-600 bg-blue-50/50':'border-yellow-500 text-yellow-700 bg-yellow-50/50'));
            document.getElementById('tab-'+t).className = `flex-1 py-3.5 text-[10px] font-bold uppercase border-b-4 transition ${activeClass}`;
            document.getElementById('fab').classList.toggle('hidden', t==='my');
            renderCurrentTab();
        }

        function createCard(i) {
            const isVerified = i.userVerified; // From data
            const badge = isVerified ? '<i class="fas fa-check-circle text-green-500 ml-1"></i>' : '';
            const color = i.col==='sos'?'border-l-4 border-red-500':(i.col==='warning'?'border-l-4 border-yellow-500':'border-l-4 border-blue-500');
            
            return `<div onclick="flyAndShow('${i.col}','${i.id}', ${i.lat}, ${i.lng})" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer group ${color}">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <img src="${i.userPhoto}" class="w-8 h-8 rounded-full border border-gray-100">
                        <div class="leading-tight">
                            <div class="text-xs font-bold text-slate-700 flex items-center">${i.creatorName} ${badge}</div>
                            <div class="text-[10px] text-slate-400">${timeAgo(i.timestamp)}</div>
                        </div>
                    </div>
                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">${getDist(i.lat,i.lng)}km</span>
                </div>
                <h4 class="font-bold text-sm text-slate-800 group-hover:text-blue-600 transition ${i.col==='sos'?'text-red-600':''}">${i.type||i.name}</h4>
                <p class="text-xs text-slate-500 line-clamp-2 mt-1">${i.desc}</p>
            </div>`;
        }

        function renderCurrentTab() {
            if(currentTab==='my') {
                const row = i => `<div class="bg-white p-3 rounded-xl border border-slate-200 flex justify-between items-center mb-2">
                    <div onclick="openDetail('${i.col}','${i.id}')" class="cursor-pointer">
                        <div class="font-bold text-xs text-slate-700">${i.type||i.name}</div>
                        <div class="text-[10px] text-slate-400">${timeAgo(i.timestamp)}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editItem('${i.col}','${i.id}')" class="w-7 h-7 bg-blue-50 text-blue-600 rounded flex items-center justify-center hover:bg-blue-100"><i class="fas fa-edit text-xs"></i></button>
                        <button onclick="deleteItem('${i.col}','${i.id}')" class="w-7 h-7 bg-red-50 text-red-600 rounded flex items-center justify-center hover:bg-red-100"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>`;
                const my = (k) => allData[k].filter(i=>i.uid==currentUser.uid).map(row).join('');
                document.getElementById('my-lists-container').innerHTML = `
                    <div class="mb-4"><h5 class="text-xs font-bold text-yellow-600 uppercase mb-2">C·∫£nh b√°o</h5>${my('warnings')||'<span class="text-xs italic text-gray-400">Tr·ªëng</span>'}</div>
                    <div class="mb-4"><h5 class="text-xs font-bold text-red-600 uppercase mb-2">SOS</h5>${my('sos')||'<span class="text-xs italic text-gray-400">Tr·ªëng</span>'}</div>
                    <div><h5 class="text-xs font-bold text-blue-600 uppercase mb-2">ƒê∆°n v·ªã</h5>${my('units')||'<span class="text-xs italic text-gray-400">Tr·ªëng</span>'}</div>`;
            } else {
                let d = allData[currentTab==='warning'?'warnings':(currentTab==='sos'?'sos':'units')];
                const k = document.getElementById('search-'+currentTab).value.toLowerCase();
                d = d.filter(i=>(i.desc+i.type+i.name).toLowerCase().includes(k)).sort((a,b)=>getDistVal(a)-getDistVal(b));
                document.getElementById('list-'+currentTab).innerHTML = d.map(createCard).join('');
            }
        }

        // INTERACTION
        function flyAndShow(col, id, lat, lng) {
            map.flyTo([lat, lng], 16, {duration: 1.5});
            if(window.innerWidth < 768) document.getElementById('map').scrollIntoView({behavior:'smooth'});
            // Auto open popup via marker loop
            markersGroup.eachLayer(l => { 
                if(l.getLatLng().lat == lat && l.getLatLng().lng == lng) l.openPopup(); 
            });
        }

        function updateMarkers() {
            if(!map) return;
            markersGroup.clearLayers();
            const add = (i, col, color, z) => {
                const pulse = col==='sos'?'sos-pulse':'';
                const badge = i.userVerified ? `<div class="marker-badge"><i class="fas fa-check"></i></div>` : '';
                const icon = L.divIcon({className:'', html:`<div class="avatar-marker ${pulse}" style="border-color:${color}"><img src="${i.userPhoto}">${badge}</div>`, iconSize:[48,48], iconAnchor:[24,48]});
                
                // Popup Content
                const pop = `
                    <div class="p-3 font-sans">
                        <div class="flex gap-2 items-center mb-2">
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded text-white" style="background:${color}">${col.toUpperCase()}</span>
                            <span class="text-[10px] text-gray-400">${timeAgo(i.timestamp)}</span>
                        </div>
                        <h3 class="font-bold text-sm text-slate-800 mb-1 leading-tight">${i.type||i.name}</h3>
                        <p class="text-xs text-slate-500 line-clamp-2 mb-3">${i.desc}</p>
                        <button onclick="openDetail('${col}','${i.id}')" class="w-full bg-slate-800 text-white text-xs font-bold py-2 rounded-lg hover:bg-black transition">Xem Chi Ti·∫øt</button>
                    </div>`;
                
                L.marker([i.lat,i.lng], {icon, zIndexOffset:z}).addTo(markersGroup).bindPopup(pop);
            };
            allData.warnings.forEach(i=>add(i,'warning','#eab308',100));
            allData.sos.forEach(i=>add(i,'sos','#ef4444',1000));
            allData.units.forEach(i=>add(i,'units','#3b82f6',50));
        }

        // DETAIL MODAL
        function openDetail(col, id) {
            const i = allData[col==='warning'?'warnings':(col==='sos'?'sos':'units')].find(x=>x.id===id);
            if(!i) return;
            
            document.getElementById('detail-modal').classList.remove('hidden');
            const colors = {warning:'from-yellow-400 to-orange-500', sos:'from-red-500 to-pink-600', units:'from-blue-400 to-indigo-600'};
            
            document.getElementById('detail-header-bg').className = `h-32 relative bg-gradient-to-r ${colors[col]}`;
            document.getElementById('detail-badge').innerText = col.toUpperCase();
            document.getElementById('detail-title').innerText = i.type||i.name;
            document.getElementById('detail-desc').innerText = i.desc;
            document.getElementById('detail-time').innerText = timeAgo(i.timestamp);
            document.getElementById('detail-dist').innerText = getDist(i.lat,i.lng)+' km';
            document.getElementById('detail-author').innerText = i.creatorName;
            document.getElementById('detail-avatar').src = i.userPhoto;
            document.getElementById('detail-phone-display').innerText = i.phone || 'Kh√¥ng c√≥ SƒêT';
            document.getElementById('btn-call').href = `tel:${i.phone}`;
            document.getElementById('btn-nav').onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${i.lat},${i.lng}`, '_blank');

            // Verification Icon in Detail
            const vIcon = document.getElementById('detail-verify-icon');
            if(i.userVerified) vIcon.innerHTML = '<i class="fas fa-check-circle text-green-500 text-xs"></i>';
            else vIcon.innerHTML = '<span class="text-[10px] bg-orange-100 text-orange-600 px-1 rounded border border-orange-200">Ch∆∞a x√°c minh</span>';

            // Actions
            const isOwner = currentUser.uid === i.uid;
            document.getElementById('detail-owner-actions').classList.toggle('hidden', !isOwner);
            editingItem = {col, id, data:i}; // Store for owner actions

            // History
            const hist = document.getElementById('hist-log');
            hist.innerHTML = i.editHistory ? i.editHistory.map(h=>`<div>${new Date(h.time).toLocaleString('vi-VN')}: ${h.action}</div>`).join('') : 'Ch∆∞a c√≥ ch·ªânh s·ª≠a';
        }
        function closeDetail() { document.getElementById('detail-modal').classList.add('hidden'); }
        function editCurrentItem() { closeDetail(); editItem(editingItem.col, editingItem.id); }
        function deleteCurrentItem() { closeDetail(); deleteItem(editingItem.col, editingItem.id); }

        // CREATE / EDIT LOGIC
        function openCreateModal() {
            isEditMode=false; editingItem=null; pickedLocation=null;
            document.getElementById('modal-title').innerText = currentTab==='sos'?"G·ª¨I SOS":(currentTab==='units'?"ƒêƒÇNG K√ù ƒê∆†N V·ªä":"T·∫†O C·∫¢NH B√ÅO");
            document.getElementById('btn-submit').innerText = "ƒêƒÇNG TIN";
            document.getElementById('btn-submit').className = "w-full py-4 rounded-2xl text-white font-bold text-lg shadow-xl uppercase " + (currentTab==='sos'?'bg-red-600':(currentTab==='units'?'bg-blue-600':'bg-yellow-500'));
            
            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('inp-desc').value = "";
            document.getElementById('loc-text').innerHTML = `<i class="fas fa-satellite-dish text-blue-500 animate-pulse"></i> GPS Hi·ªán t·∫°i`;
            renderForm(currentTab);
        }

        function editItem(col, id) {
            isEditMode=true;
            const i = allData[col==='warning'?'warnings':(col==='sos'?'sos':'units')].find(x=>x.id===id);
            editingItem = {col, id, data:i};
            pickedLocation = {lat:i.lat, lng:i.lng};

            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "CH·ªàNH S·ª¨A";
            document.getElementById('btn-submit').innerText = "C·∫¨P NH·∫¨T";
            document.getElementById('inp-desc').value = i.desc;
            document.getElementById('loc-text').innerHTML = `${i.lat.toFixed(5)}, ${i.lng.toFixed(5)}`;
            
            renderForm(col); // Fill fields
            setTimeout(() => { // Populate values
                if(col==='warning') document.getElementById('w-type').value=i.type;
                if(col==='sos') document.getElementById('s-type').value=i.type;
                if(col==='units') { document.getElementById('u-name').value=i.name; document.getElementById('u-phone').value=i.phone; }
            }, 50);
        }

        function renderForm(type) {
            const c = document.getElementById('form-container');
            if(type==='warning' || type==='my') {
                c.innerHTML = `
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">Lo·∫°i c·∫£nh b√°o</label>
                <select id="w-type" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none">
                    <option value="L≈© l·ª•t">L≈© l·ª•t / Ng·∫≠p</option><option value="S·∫°t l·ªü">S·∫°t l·ªü ƒë·∫•t</option><option value="Tai n·∫°n">Tai n·∫°n giao th√¥ng</option><option value="Ch√°y">Ch√°y n·ªï</option><option value="Kh√°c">Kh√°c</option>
                </select>
                <div class="mt-3 text-xs font-bold text-slate-400 uppercase ml-1">M·ª©c ƒë·ªô</div>
                <div class="flex gap-2 mt-1"><label class="flex-1 cursor-pointer"><input type="radio" name="w-lvl" value="1" checked class="peer hidden"><div class="p-2 rounded-xl border text-center font-bold peer-checked:bg-yellow-200">Th·∫•p</div></label><label class="flex-1 cursor-pointer"><input type="radio" name="w-lvl" value="5" class="peer hidden"><div class="p-2 rounded-xl border text-center font-bold peer-checked:bg-red-500 peer-checked:text-white">NGUY HI·ªÇM</div></label></div>`;
            } else if(type==='sos') {
                c.innerHTML = `
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">S·ª± c·ªë</label>
                <select id="s-type" class="w-full mt-1 bg-red-50 border border-red-100 rounded-xl p-3 outline-none font-bold text-red-700">${SOS_CATS.map(x=>`<option value="${x}">${x}</option>`).join('')}</select>
                <div class="flex gap-3 mt-3"><div class="flex-1"><label class="text-xs font-bold text-slate-400">S·ªë ng∆∞·ªùi</label><input type="number" id="s-cnt" value="1" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl p-3 text-center font-bold"></div><div class="flex-1"><label class="text-xs font-bold text-slate-400">ƒê·ªô kh·∫©n</label><select id="s-urg" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl p-3 font-bold text-red-600"><option value="5">Nguy k·ªãch</option><option value="3">Kh·∫©n c·∫•p</option><option value="1">H·ªó tr·ª£</option></select></div></div>`;
            } else {
                c.innerHTML = `
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">T√™n ƒë∆°n v·ªã</label><input id="u-name" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" placeholder="VD: ƒê·ªôi Xu·ªìng 01">
                <label class="text-xs font-bold text-slate-400 uppercase ml-1 mt-3 block">SƒêT ƒê∆°n v·ªã</label><input id="u-phone" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none" placeholder="${currentUser.dbPhone}">
                <label class="text-xs font-bold text-slate-400 uppercase ml-1 mt-3 block">Lo·∫°i h√¨nh</label><select id="u-type" class="w-full mt-1 bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none"><option value="Cano">Cano/Thuy·ªÅn</option><option value="Xe t·∫£i">Xe b√°n t·∫£i</option><option value="Y t·∫ø">Y t·∫ø</option><option value="Nhu y·∫øu ph·∫©m">Nhu y·∫øu ph·∫©m</option><option value="Kh√°c">Kh√°c</option></select>`;
            }
        }

        async function submitData() {
            document.getElementById('loading').classList.remove('hidden');
            const desc = document.getElementById('inp-desc').value;
            const lat = pickedLocation?pickedLocation.lat:currentLocation.lat;
            const lng = pickedLocation?pickedLocation.lng:currentLocation.lng;
            
            let d = { desc, lat, lng, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() };
            let col = '';

            const tab = currentTab==='my'?'warning':currentTab;
            if((!isEditMode && tab==='warning') || (isEditMode && editingItem.col==='warning')) {
                col='warnings'; d.type=document.getElementById('w-type').value; d.severity=document.querySelector('input[name="w-lvl"]:checked').value;
            } else if((!isEditMode && tab==='sos') || (isEditMode && editingItem.col==='sos')) {
                col='sos'; d.type=document.getElementById('s-type').value; d.victims=document.getElementById('s-cnt').value; d.urgency=document.getElementById('s-urg').value;
            } else {
                col='units'; d.name=document.getElementById('u-name').value; d.type=document.getElementById('u-type').value; d.phone=document.getElementById('u-phone').value;
            }

            if(!isEditMode) {
                d.uid=currentUser.uid; d.creatorName=currentUser.displayName; d.userPhoto=currentUser.photoURL; 
                d.userVerified = !!(currentUser.emailVerified || (currentUser.dbPhone && currentUser.dbPhone.length > 9));
                d.timestamp=firebase.firestore.FieldValue.serverTimestamp(); 
                if(!d.phone) d.phone=currentUser.dbPhone; // Default phone for warning/sos
                d.editHistory=[];
            } else {
                d.editHistory = firebase.firestore.FieldValue.arrayUnion({action:'ƒê√£ ch·ªânh s·ª≠a', time:new Date().toISOString(), by:currentUser.displayName});
            }

            try {
                if(isEditMode) await db.collection(col).doc(editingItem.id).update(d);
                else await db.collection(col).add(d);
                closeModal();
                Swal.fire({title:'Th√†nh c√¥ng', icon:'success', timer:1500, showConfirmButton:false});
            } catch(e) { Swal.fire('L·ªói', e.message, 'error'); }
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        // MAP PICKER
        function startPickLocation() { isPickingMode=true; document.getElementById('create-modal').classList.add('hidden'); document.getElementById('map-picker-hint').classList.remove('hidden'); }
        function cancelPick() { isPickingMode=false; if(tempMarker) tempMarker.remove(); document.getElementById('map-picker-hint').classList.add('hidden'); document.getElementById('create-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('create-modal').classList.add('hidden'); }
        function deleteItem(c,i) { Swal.fire({title:'X√≥a tin n√†y?', showCancelButton:true, confirmButtonText:'X√≥a', confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed) db.collection(c).doc(i).delete();}); }

        // EXCEL
        function downloadExcelTemplate() { XLSX.writeFile(XLSX.utils.book_new(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.aoa_to_sheet([["Ten","Loai","SDT","MoTa","Lat","Lng"]]), "Mau")), "Mau_Don_Vi.xlsx"); }
        function importExcel(e) {
            const f=e.target.files[0]; if(!f) return;
            const r=new FileReader();
            r.onload=evt=>{
                const j=XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(evt.target.result),{type:'array'}).Sheets[XLSX.read(new Uint8Array(evt.target.result),{type:'array'}).SheetNames[0]]);
                Swal.fire({title:`Import ${j.length} d√≤ng?`, showCancelButton:true}).then(res=>{
                    if(res.isConfirmed) {
                        const b=db.batch();
                        j.forEach(r=>{
                            // N·∫øu kh√¥ng c√≥ Lat/Lng trong excel, d√πng v·ªã tr√≠ hi·ªán t·∫°i c·ªßa ng∆∞·ªùi import
                            const uLat = r['Lat'] || currentLocation.lat;
                            const uLng = r['Lng'] || currentLocation.lng;
                            const uDesc = r['MoTa'] + (r['Lat']?'':' (C·∫ßn c·∫≠p nh·∫≠t v·ªã tr√≠)'); // Ghi ch√∫ n·∫øu thi·∫øu

                            b.set(db.collection('units').doc(), {
                                name:r['Ten']||'NoName', type:r['Loai']||'Kh√°c', phone:r['SDT']||currentUser.dbPhone, 
                                lat:parseFloat(uLat), lng:parseFloat(uLng), desc:uDesc, 
                                uid:currentUser.uid, creatorName:currentUser.displayName, userPhoto:currentUser.photoURL,
                                userVerified: !!(currentUser.emailVerified || currentUser.dbPhone.length>9),
                                timestamp:firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                        b.commit().then(()=>Swal.fire('Xong!','Import th√†nh c√¥ng. Vui l√≤ng ki·ªÉm tra l·∫°i v·ªã tr√≠ c√°c ƒë∆°n v·ªã.','success'));
                    }
                });
            };
            r.readAsArrayBuffer(f);
        }

        // UTILS
        function getDist(lat,lng) { return (6371*2*Math.atan2(Math.sqrt(Math.sin((lat-currentLocation.lat)*Math.PI/180/2)**2 + Math.cos(currentLocation.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lng-currentLocation.lng)*Math.PI/180/2)**2), Math.sqrt(1-Math.sin((lat-currentLocation.lat)*Math.PI/180/2)**2 - Math.cos(currentLocation.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lng-currentLocation.lng)*Math.PI/180/2)**2))).toFixed(1); }
        function getDistVal(i) { return parseFloat(getDist(i.lat,i.lng)); }
        function timeAgo(ts) { if(!ts) return ''; const s=(new Date()-ts.toDate())/1000; return s<60?'V·ª´a xong':(s<3600?Math.floor(s/60)+'p tr∆∞·ªõc':Math.floor(s/3600)+'h tr∆∞·ªõc'); }
        function renderWarnings(){ renderCurrentTab(); } function renderSOS(){ renderCurrentTab(); } function renderUnits(){ renderCurrentTab(); }
    </script>
</body>
</html>
