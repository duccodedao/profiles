
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá th·ªëng C·ª©u H·ªô Qu·ªëc Gia 2025</title>

    <!-- 1. TH∆Ø VI·ªÜN UI & ICON -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. EXCEL LIBRARY -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <!-- 3. FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- 4. MAP -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Map Marker Custom Avatar */
        .avatar-marker {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            overflow: hidden;
            background: white;
            position: relative;
            transition: transform 0.2s;
        }
        .avatar-marker img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-marker:hover { transform: scale(1.1); z-index: 999; }
        
        /* Status Badge on Marker */
        .marker-status {
            position: absolute; bottom: 0; right: 0;
            width: 12px; height: 12px; border-radius: 50%;
            border: 2px solid white;
        }
        .status-new { background: #ef4444; } /* Red */
        .status-process { background: #eab308; } /* Yellow */
        .status-safe { background: #22c55e; } /* Green */

        /* Animation */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .sos-pulse { animation: pulse-ring 2s infinite; border-color: #ef4444; }

        /* Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden flex flex-col md:flex-row">

    <!-- ALERT CONFIG -->
    <div id="config-alert" class="fixed top-0 inset-x-0 bg-red-600 text-white text-center text-sm py-2 z-[9999] hidden">
        <b>C·∫¢NH B√ÅO:</b> Ch∆∞a nh·∫≠p Firebase Config. Vui l√≤ng m·ªü code v√† ƒëi·ªÅn API Key.
    </div>

    <!-- TOAST -->
    <div id="toast-container" class="fixed top-5 right-5 z-[9999] space-y-2 pointer-events-none"></div>

    <!-- LOADING -->
    <div id="loading" class="fixed inset-0 bg-white/90 z-[9000] flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
        <p class="text-blue-800 font-bold animate-pulse">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</p>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-slate-900 z-[8000] flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/50">
                <i class="fas fa-life-ring text-4xl text-white"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">H·ªÜ TH·ªêNG C·ª®U H·ªò QU·ªêC GIA</h1>
            <p class="text-gray-500 mb-8 text-sm">K·∫øt n·ªëi ngu·ªìn l·ª±c - ·ª®ng c·ª©u k·ªãp th·ªùi</p>
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-gray-300 py-3 rounded-xl font-bold text-gray-700 hover:bg-gray-50 flex items-center justify-center gap-3 shadow-sm transition">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6">
                ƒêƒÉng nh·∫≠p b·∫±ng Google
            </button>
            <p class="mt-6 text-xs text-gray-400">Vui l√≤ng b·∫≠t ƒë·ªãnh v·ªã (GPS) ƒë·ªÉ h·ªá th·ªëng ho·∫°t ƒë·ªông ch√≠nh x√°c.</p>
        </div>
    </div>

    <!-- PHONE UPDATE -->
    <div id="phone-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[7000] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-2 text-gray-800">C·∫≠p nh·∫≠t S·ªë ƒëi·ªán tho·∫°i</h3>
            <p class="text-sm text-gray-500 mb-4">ƒê·ªÉ ƒë·ªôi c·ª©u h·ªô li√™n l·∫°c khi kh·∫©n c·∫•p.</p>
            <input type="tel" id="phone-input" class="w-full border p-3 rounded-lg text-center font-bold text-lg mb-4 outline-none focus:ring-2 focus:ring-blue-500" placeholder="09xx xxx xxx">
            <button onclick="updatePhone()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">X√°c nh·∫≠n</button>
        </div>
    </div>

    <!-- === LEFT PANEL (LIST) === -->
    <div class="w-full md:w-[450px] bg-white flex flex-col shadow-2xl z-[1000] order-2 md:order-1 h-[60vh] md:h-full relative">
        <!-- Header -->
        <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3">
                <img id="user-avatar" src="" class="w-10 h-10 rounded-full border-2 border-white bg-gray-300 object-cover">
                <div>
                    <h2 id="user-name" class="font-bold text-sm">Kh√°ch</h2>
                    <span class="text-[10px] text-green-400 flex items-center gap-1"><i class="fas fa-circle text-[8px]"></i> Online</span>
                </div>
            </div>
            <button onclick="logout()" class="text-gray-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <!-- Navigation -->
        <div class="flex border-b text-xs font-bold uppercase bg-white shrink-0 overflow-x-auto no-scrollbar">
            <button onclick="switchTab('warning')" id="tab-warning" class="flex-1 py-3 px-2 border-b-2 border-yellow-500 text-yellow-600 bg-yellow-50 whitespace-nowrap">C·∫£nh b√°o</button>
            <button onclick="switchTab('sos')" id="tab-sos" class="flex-1 py-3 px-2 border-b-2 border-transparent text-gray-500 whitespace-nowrap">C·∫ßu c·ª©u (SOS)</button>
            <button onclick="switchTab('units')" id="tab-units" class="flex-1 py-3 px-2 border-b-2 border-transparent text-gray-500 whitespace-nowrap">ƒê∆°n v·ªã h·ªó tr·ª£</button>
            <button onclick="switchTab('my')" id="tab-my" class="flex-1 py-3 px-2 border-b-2 border-transparent text-blue-600 whitespace-nowrap"><i class="fas fa-user"></i> C·ªßa t√¥i</button>
        </div>

        <!-- Content Lists -->
        <div class="flex-1 overflow-y-auto p-3 bg-gray-50">
            
            <!-- WARNING TAB -->
            <div id="content-warning" class="space-y-3">
                <div class="flex justify-between items-center px-1">
                    <span class="text-xs font-bold text-gray-500">DANH S√ÅCH C·∫¢NH B√ÅO</span>
                    <select id="filter-warning" onchange="renderWarnings()" class="text-[10px] border rounded px-1 py-0.5"><option value="all">T·∫•t c·∫£</option><option value="high">Nguy hi·ªÉm</option></select>
                </div>
                <div id="list-warning" class="space-y-3 pb-20"></div>
            </div>

            <!-- SOS TAB -->
            <div id="content-sos" class="hidden space-y-3">
                <div id="list-sos" class="space-y-3 pb-20"></div>
            </div>

            <!-- UNITS TAB -->
            <div id="content-units" class="hidden space-y-3">
                <div class="bg-white p-3 rounded-lg border shadow-sm space-y-2">
                    <input type="text" id="unit-search" onkeyup="renderUnits()" placeholder="T√¨m ki·∫øm ƒë∆°n v·ªã..." class="w-full text-sm border rounded px-3 py-2 outline-none focus:border-blue-500">
                    <div class="flex gap-2">
                        <button onclick="downloadExcelTemplate()" class="flex-1 text-[10px] bg-gray-100 text-gray-700 py-2 rounded font-bold hover:bg-gray-200"><i class="fas fa-download"></i> T·∫£i m·∫´u Excel</button>
                        <button onclick="document.getElementById('excel-input').click()" class="flex-1 text-[10px] bg-green-100 text-green-700 py-2 rounded font-bold hover:bg-green-200"><i class="fas fa-file-excel"></i> Import Excel</button>
                        <input type="file" id="excel-input" accept=".xlsx" class="hidden" onchange="importExcel(event)">
                    </div>
                </div>
                <div id="list-units" class="space-y-3 pb-20"></div>
            </div>

            <!-- MY ITEMS TAB -->
            <div id="content-my" class="hidden space-y-3">
                <div class="bg-blue-50 p-3 rounded-lg text-blue-800 text-xs mb-2">
                    <i class="fas fa-info-circle"></i> Qu·∫£n l√Ω c√°c tin b·∫°n ƒë√£ ƒëƒÉng. H√£y c·∫≠p nh·∫≠t tr·∫°ng th√°i "ƒê√£ an to√†n" ho·∫∑c x√≥a khi s·ª± c·ªë k·∫øt th√∫c ƒë·ªÉ tr√°nh g√¢y nhi·ªÖu.
                </div>
                <div id="list-my" class="space-y-3 pb-20"></div>
            </div>
        </div>

        <!-- FAB Add Button -->
        <button onclick="openModal()" id="fab" class="absolute bottom-6 right-6 w-14 h-14 bg-yellow-500 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-105 active:scale-95 transition z-[1001]">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- === RIGHT PANEL (MAP) === -->
    <div class="flex-1 relative order-1 md:order-2 h-[40vh] md:h-full border-l border-gray-200">
        <div id="map" class="w-full h-full z-0"></div>
        <button onclick="locateUser()" class="absolute bottom-5 right-5 bg-white p-3 rounded-lg shadow-lg hover:text-blue-600 z-[900]"><i class="fas fa-crosshairs"></i></button>
    </div>

    <!-- === MODAL CREATE === -->
    <div id="create-modal" class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-lg h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-2xl sm:rounded-2xl flex flex-col shadow-2xl overflow-hidden animate-[slideUp_0.3s]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
                <h2 id="modal-title" class="font-bold text-lg">ƒêƒÉng Tin</h2>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-600">&times;</button>
            </div>
            
            <div class="p-5 overflow-y-auto space-y-4">
                <!-- Select Forms -->
                <div id="form-warning" class="hidden space-y-3">
                    <label class="text-xs font-bold text-gray-500 uppercase">Lo·∫°i c·∫£nh b√°o</label>
                    <select id="w-type" class="w-full border p-2 rounded bg-gray-50" onchange="checkOther('w-type','w-other')">
                        <option value="L≈© l·ª•t">üåä L≈© l·ª•t / N∆∞·ªõc d√¢ng</option>
                        <option value="S·∫°t l·ªü">üèîÔ∏è S·∫°t l·ªü ƒë·∫•t</option>
                        <option value="Tai n·∫°n">üöó Tai n·∫°n giao th√¥ng</option>
                        <option value="Kh√°c">‚úèÔ∏è Kh√°c</option>
                    </select>
                    <input id="w-other" class="hidden w-full border p-2 rounded mt-1 border-yellow-400" placeholder="Nh·∫≠p chi ti·∫øt...">
                    <label class="text-xs font-bold text-gray-500 uppercase mt-2 block">M·ª©c ƒë·ªô</label>
                    <div class="flex gap-2">
                        <label class="flex-1 cursor-pointer"><input type="radio" name="w-level" value="1" checked class="peer hidden"><div class="border p-2 rounded text-center text-xs peer-checked:bg-yellow-200">Th·∫•p</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="w-level" value="3" class="peer hidden"><div class="border p-2 rounded text-center text-xs peer-checked:bg-orange-200">Cao</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="w-level" value="5" class="peer hidden"><div class="border p-2 rounded text-center text-xs peer-checked:bg-red-600 peer-checked:text-white">NGUY HI·ªÇM</div></label>
                    </div>
                </div>

                <div id="form-sos" class="hidden space-y-3">
                    <label class="text-xs font-bold text-gray-500 uppercase">S·ª± c·ªë</label>
                    <select id="s-type" class="w-full border p-2 rounded bg-red-50" onchange="checkOther('s-type','s-other')">
                        <option value="M·∫Øc k·∫πt">üè† M·∫Øc k·∫πt / C√¥ l·∫≠p</option>
                        <option value="Th∆∞∆°ng t√≠ch">üöë Th∆∞∆°ng t√≠ch / Y t·∫ø</option>
                        <option value="Thi·∫øu l∆∞∆°ng th·ª±c">üç≤ Thi·∫øu l∆∞∆°ng th·ª±c</option>
                        <option value="Kh√°c">‚úèÔ∏è Kh√°c</option>
                    </select>
                    <input id="s-other" class="hidden w-full border p-2 rounded mt-1 border-red-400" placeholder="Chi ti·∫øt s·ª± c·ªë...">
                    <div class="flex gap-3">
                        <div class="flex-1"><label class="text-xs font-bold">S·ªë ng∆∞·ªùi</label><input type="number" id="s-count" value="1" class="w-full border p-2 rounded text-center"></div>
                        <div class="flex-1"><label class="text-xs font-bold">Kh·∫©n c·∫•p</label><select id="s-urgency" class="w-full border p-2 rounded text-red-600 font-bold"><option value="5">üî• Nguy k·ªãch</option><option value="3">‚ö†Ô∏è Kh·∫©n c·∫•p</option><option value="1">‚è≥ C·∫ßn h·ªó tr·ª£</option></select></div>
                    </div>
                </div>

                <div id="form-units" class="hidden space-y-3">
                    <label class="text-xs font-bold text-gray-500 uppercase">T√™n ƒë∆°n v·ªã</label>
                    <input id="u-name" class="w-full border p-2 rounded" placeholder="VD: ƒê·ªôi Xu·ªìng 01...">
                    <label class="text-xs font-bold text-gray-500 uppercase mt-2 block">Lo·∫°i h√¨nh</label>
                    <select id="u-type" class="w-full border p-2 rounded" onchange="checkOther('u-type','u-other')">
                        <option value="Cano">üö§ Cano / Thuy·ªÅn</option>
                        <option value="Xe t·∫£i">üöõ Xe t·∫£i / B√°n t·∫£i</option>
                        <option value="Y t·∫ø">‚öïÔ∏è Y t·∫ø / Thu·ªëc</option>
                        <option value="Nhu y·∫øu ph·∫©m">üì¶ Nhu y·∫øu ph·∫©m</option>
                        <option value="Kh√°c">‚úèÔ∏è Kh√°c</option>
                    </select>
                    <input id="u-other" class="hidden w-full border p-2 rounded mt-1 border-blue-400" placeholder="Chi ti·∫øt...">
                </div>

                <!-- ADDRESS (API 2025) -->
                <div class="bg-gray-50 p-3 rounded-lg border">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">ƒê·ªãa ch·ªâ H√†nh ch√≠nh (B·∫Øt bu·ªôc)</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                        <select id="addr-province" class="border p-2 rounded text-xs" onchange="loadDistricts()"><option value="">-- T·ªânh/TP --</option></select>
                        <select id="addr-district" class="border p-2 rounded text-xs" onchange="loadWards()" disabled><option value="">-- Qu·∫≠n/Huy·ªán --</option></select>
                        <select id="addr-ward" class="border p-2 rounded text-xs" disabled><option value="">-- Ph∆∞·ªùng/X√£ --</option></select>
                    </div>
                    <textarea id="desc" rows="2" class="w-full border p-2 rounded text-sm" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªã tr√≠, s·ªë nh√†..."></textarea>
                </div>

                <div class="text-xs text-gray-400 text-center"><i class="fas fa-map-marker-alt"></i> V·ªã tr√≠ GPS hi·ªán t·∫°i c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ƒë√≠nh k√®m.</div>
            </div>

            <div class="p-4 border-t bg-gray-50 shrink-0">
                <button onclick="submitData()" id="btn-submit" class="w-full py-3 rounded-xl text-white font-bold shadow-lg uppercase">G·ª≠i tin</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };

        // --- GLOBAL VARS ---
        let auth, db, map, markersGroup, currentUser, userMarker;
        let currentLocation = { lat: 21.0285, lng: 105.8542 };
        let currentTab = 'warning';
        let allData = { warnings: [], sos: [], units: [] };
        let provincesData = [];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            if(firebaseConfig.apiKey.includes("xxxx")) {
                document.getElementById('config-alert').classList.remove('hidden');
            } else {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                checkAuth();
                fetchProvinces(); // Load Admin Units
            }
        });

        // --- AUTH ---
        function checkAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-name').innerText = user.displayName;
                    document.getElementById('user-avatar').src = user.photoURL || 'https://ui-avatars.com/api/?name='+user.displayName;
                    document.getElementById('login-screen').classList.add('hidden');
                    
                    const doc = await db.collection('users').doc(user.uid).get();
                    if(!doc.exists || !doc.data().phone) document.getElementById('phone-modal').classList.remove('hidden');
                    else currentUser.phone = doc.data().phone;
                    
                    initMap();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                }
            });
        }
        function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(alert); }
        function logout() { if(confirm("ƒêƒÉng xu·∫•t?")) auth.signOut(); }
        async function updatePhone() {
            const p = document.getElementById('phone-input').value;
            if(p.length<9) return alert("SƒêT sai");
            await db.collection('users').doc(currentUser.uid).set({phone:p, name:currentUser.displayName, photo:currentUser.photoURL},{merge:true});
            currentUser.phone = p;
            document.getElementById('phone-modal').classList.add('hidden');
        }

        // --- MAP ---
        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl:false}).setView([currentLocation.lat, currentLocation.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markersGroup = L.layerGroup().addTo(map);
            
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    currentLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
                    if(userMarker) map.removeLayer(userMarker);
                    userMarker = L.marker([currentLocation.lat, currentLocation.lng], {
                        icon: L.divIcon({className:'', html:`<div class="w-4 h-4 bg-blue-600 border-2 border-white rounded-full shadow animate-pulse"></div>`})
                    }).addTo(map);
                    renderCurrentTab();
                }, null, {enableHighAccuracy:true});
            }

            // Load Data
            listenData('warnings'); listenData('sos'); listenData('units');
        }
        function locateUser() { map.flyTo([currentLocation.lat, currentLocation.lng], 15); }

        // --- DATA ---
        function listenData(col) {
            db.collection(col).orderBy('timestamp', 'desc').onSnapshot(snap => {
                allData[col] = snap.docs.map(d => ({id:d.id, ...d.data()}));
                renderCurrentTab();
                updateMarkers();
            });
        }

        // --- ADMIN UNITS (API) ---
        async function fetchProvinces() {
            try {
                const res = await fetch('https://provinces.open-api.vn/api/?depth=2');
                provincesData = await res.json();
                const sel = document.getElementById('addr-province');
                provincesData.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.code; opt.text = p.name;
                    sel.appendChild(opt);
                });
            } catch(e) { console.error("Error loading provinces"); }
        }
        function loadDistricts() {
            const pCode = document.getElementById('addr-province').value;
            const dSel = document.getElementById('addr-district');
            const wSel = document.getElementById('addr-ward');
            dSel.innerHTML = '<option value="">-- Qu·∫≠n/Huy·ªán --</option>'; dSel.disabled = !pCode;
            wSel.innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>'; wSel.disabled = true;
            
            if(pCode) {
                const p = provincesData.find(x => x.code == pCode);
                p.districts.forEach(d => {
                    const opt = document.createElement('option'); opt.value = d.code; opt.text = d.name;
                    dSel.appendChild(opt);
                });
            }
        }
        async function loadWards() {
            const dCode = document.getElementById('addr-district').value;
            const wSel = document.getElementById('addr-ward');
            wSel.innerHTML = '<option value="">-- Ph∆∞·ªùng/X√£ --</option>'; wSel.disabled = !dCode;
            
            if(dCode) {
                const res = await fetch(`https://provinces.open-api.vn/api/d/${dCode}?depth=2`);
                const d = await res.json();
                d.wards.forEach(w => {
                    const opt = document.createElement('option'); opt.value = w.name; opt.text = w.name;
                    wSel.appendChild(opt);
                });
            }
        }
        function getAddressString() {
            const p = document.getElementById('addr-province');
            const d = document.getElementById('addr-district');
            const w = document.getElementById('addr-ward');
            if(!p.value || !d.value || !w.value) return null;
            return `${w.value}, ${d.options[d.selectedIndex].text}, ${p.options[p.selectedIndex].text}`;
        }

        // --- RENDERING ---
        function switchTab(t) {
            currentTab = t;
            ['warning','sos','units','my'].forEach(k => {
                const btn = document.getElementById('tab-'+k);
                const div = document.getElementById('content-'+k);
                if(k===t) {
                    div.classList.remove('hidden');
                    btn.className = `flex-1 py-3 px-2 border-b-2 whitespace-nowrap ${t==='sos'?'border-red-500 text-red-600 bg-red-50':(t==='units'?'border-blue-500 text-blue-600 bg-blue-50':(t==='my'?'border-blue-800 text-blue-800 bg-blue-50':'border-yellow-500 text-yellow-600 bg-yellow-50'))}`;
                    // FAB Color
                    const fab = document.getElementById('fab');
                    if(t==='my') fab.classList.add('hidden');
                    else {
                        fab.classList.remove('hidden');
                        fab.className = `absolute bottom-6 right-6 w-14 h-14 text-white rounded-full shadow-xl flex items-center justify-center text-2xl hover:scale-105 active:scale-95 transition z-[1001] ${t==='sos'?'bg-red-600 animate-pulse':(t==='units'?'bg-blue-600':'bg-yellow-500')}`;
                    }
                } else {
                    div.classList.add('hidden');
                    btn.className = "flex-1 py-3 px-2 border-b-2 border-transparent text-gray-500 whitespace-nowrap";
                }
            });
            renderCurrentTab();
        }

        function renderCurrentTab() {
            if(currentTab === 'my') renderMyItems();
            else if(currentTab === 'warning') renderWarnings();
            else if(currentTab === 'sos') renderSOS();
            else renderUnits();
        }

        function renderCard(item, type) {
            const dist = getDist(item.lat, item.lng);
            const statusMap = {'new':'M·ªõi','process':'ƒêang x·ª≠ l√Ω','safe':'An to√†n/Xong'};
            const statusColor = {'new':'bg-red-100 text-red-800','process':'bg-yellow-100 text-yellow-800','safe':'bg-green-100 text-green-800'};
            const st = item.status || 'new';

            // User Info
            const avatar = item.userPhoto || 'https://ui-avatars.com/api/?name='+item.creatorName;
            
            return `
            <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer" onclick="flyTo(${item.lat},${item.lng})">
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-2 mb-2">
                        <img src="${avatar}" class="w-6 h-6 rounded-full border border-gray-200">
                        <div>
                            <span class="text-[10px] text-gray-500 block leading-tight">ƒêƒÉng b·ªüi ${item.creatorName}</span>
                            <span class="text-[10px] text-gray-400 block leading-tight">${timeAgo(item.timestamp)}</span>
                        </div>
                    </div>
                    <span class="text-[10px] px-2 py-0.5 rounded font-bold ${statusColor[st]}">${statusMap[st]}</span>
                </div>
                
                <h4 class="font-bold text-gray-800 text-sm ${type==='sos'?'text-red-700 uppercase':''}">${item.type || item.name}</h4>
                <p class="text-xs text-gray-600 line-clamp-2 mt-1"><i class="fas fa-map-marker-alt text-[10px] mr-1"></i> ${item.address || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}</p>
                <p class="text-xs text-gray-500 mt-1 italic">"${item.desc}"</p>
                
                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
                    <span class="text-xs font-bold text-blue-600">${dist} km</span>
                    ${type==='sos' || type==='units' ? `<a href="tel:${item.phone}" onclick="event.stopPropagation()" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-600"><i class="fas fa-phone"></i> G·ªçi</a>` : ''}
                </div>
            </div>`;
        }

        function renderWarnings() {
            const div = document.getElementById('list-warning'); div.innerHTML = '';
            const filter = document.getElementById('filter-warning').value;
            let data = allData.warnings.sort((a,b)=>getDistVal(a)-getDistVal(b));
            if(filter==='high') data = data.filter(i=>parseInt(i.severity)>=3);
            data.forEach(i => div.innerHTML += renderCard(i, 'warning'));
        }

        function renderSOS() {
            const div = document.getElementById('list-sos'); div.innerHTML = '';
            allData.sos.sort((a,b)=>b.urgency-a.urgency || getDistVal(a)-getDistVal(b))
                .forEach(i => div.innerHTML += renderCard(i, 'sos'));
        }

        function renderUnits() {
            const div = document.getElementById('list-units'); div.innerHTML = '';
            const key = document.getElementById('unit-search').value.toLowerCase();
            allData.units.filter(i=>i.name.toLowerCase().includes(key))
                .sort((a,b)=>getDistVal(a)-getDistVal(b))
                .forEach(i => div.innerHTML += renderCard(i, 'units'));
        }

        function renderMyItems() {
            const div = document.getElementById('list-my'); div.innerHTML = '';
            const myItems = [
                ...allData.warnings.map(i=>({...i, col:'warnings'})),
                ...allData.sos.map(i=>({...i, col:'sos'})),
                ...allData.units.map(i=>({...i, col:'units'}))
            ].filter(i => i.uid === currentUser.uid);

            if(myItems.length === 0) div.innerHTML = '<p class="text-center text-gray-400 text-xs py-5">B·∫°n ch∆∞a t·∫°o tin n√†o.</p>';

            myItems.forEach(i => {
                const st = i.status || 'new';
                div.innerHTML += `
                <div class="bg-white p-3 rounded-lg border-l-4 border-blue-500 shadow-sm relative">
                    <h4 class="font-bold text-sm text-gray-800">${i.type || i.name}</h4>
                    <p class="text-xs text-gray-500">${timeAgo(i.timestamp)}</p>
                    <div class="mt-2 flex gap-2">
                        <select onchange="updateStatus('${i.col}','${i.id}',this.value)" class="text-xs border p-1 rounded bg-gray-50">
                            <option value="new" ${st=='new'?'selected':''}>M·ªõi t·∫°o</option>
                            <option value="process" ${st=='process'?'selected':''}>ƒêang x·ª≠ l√Ω</option>
                            <option value="safe" ${st=='safe'?'selected':''}>ƒê√£ xong/An to√†n</option>
                        </select>
                        <button onclick="deleteItem('${i.col}','${i.id}')" class="text-xs text-red-500 font-bold ml-auto">X√ìA</button>
                    </div>
                </div>`;
            });
        }

        // --- MAP MARKERS ---
        function updateMarkers() {
            if(!map) return;
            markersGroup.clearLayers();
            
            const createMarker = (i, color, z) => {
                const avatar = i.userPhoto || 'https://ui-avatars.com/api/?name='+i.creatorName;
                const statusColor = i.status === 'safe' ? 'status-safe' : (i.status === 'process' ? 'status-process' : 'status-new');
                const pulseClass = (i.col === 'sos' && i.status !== 'safe') ? 'sos-pulse' : '';
                
                const icon = L.divIcon({
                    className: '',
                    html: `
                        <div class="avatar-marker ${pulseClass}" style="border-color:${color}">
                            <img src="${avatar}">
                            <div class="marker-status ${statusColor}"></div>
                        </div>`,
                    iconSize: [40, 40], iconAnchor: [20, 40]
                });
                L.marker([i.lat, i.lng], {icon, zIndexOffset:z}).addTo(markersGroup)
                 .bindPopup(`<b>${i.type||i.name}</b><br>${i.desc}<br><small>B·ªüi: ${i.creatorName}</small>`);
            };

            allData.warnings.forEach(i => createMarker({...i, col:'warning'}, '#eab308', 100));
            allData.sos.forEach(i => createMarker({...i, col:'sos'}, '#ef4444', 1000));
            allData.units.forEach(i => createMarker({...i, col:'units'}, '#3b82f6', 50));
        }

        // --- EXCEL ---
        function downloadExcelTemplate() {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["T√™n ƒê∆°n v·ªã", "Lo·∫°i h√¨nh (Cano/Xe t·∫£i/Y t·∫ø...)", "SƒêT", "Kinh ƒë·ªô", "Vƒ© ƒë·ªô", "M√¥ t·∫£"],
                ["ƒê·ªôi Xu·ªìng 01", "Cano", "0912345678", "105.85", "21.02", "C√≥ 2 xu·ªìng m√°y"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Mau_Don_Vi");
            XLSX.writeFile(wb, "Mau_Them_Don_Vi.xlsx");
        }

        function importExcel(e) {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = function(evt) {
                const d = new Uint8Array(evt.target.result);
                const wb = XLSX.read(d, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if(confirm(`Import ${json.length} d√≤ng?`)) {
                    const batch = db.batch();
                    json.forEach(row => {
                        const ref = db.collection('units').doc();
                        batch.set(ref, {
                            name: row['T√™n ƒê∆°n v·ªã']||'Noname', type: row['Lo·∫°i h√¨nh']||'Kh√°c', phone: row['SƒêT']||'',
                            lat: parseFloat(row['Vƒ© ƒë·ªô']||0), lng: parseFloat(row['Kinh ƒë·ªô']||0), desc: row['M√¥ t·∫£']||'',
                            uid: currentUser.uid, creatorName: currentUser.displayName, userPhoto: currentUser.photoURL,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(), status: 'new', address: 'Import t·ª´ Excel'
                        });
                    });
                    batch.commit().then(()=>alert("Th√†nh c√¥ng!"));
                }
            };
            r.readAsArrayBuffer(f);
        }

        // --- ACTIONS ---
        function openModal() {
            if(!currentUser) return;
            document.getElementById('create-modal').classList.remove('hidden');
            ['warning','sos','units'].forEach(k=>document.getElementById('form-'+k).classList.add('hidden'));
            
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('btn-submit');
            const formId = 'form-'+(currentTab==='my'?'warning':currentTab);
            document.getElementById(formId).classList.remove('hidden');
            
            const config = {
                warning: {t:'T·∫†O C·∫¢NH B√ÅO', c:'bg-yellow-500'},
                sos: {t:'Y√äU C·∫¶U C·ª®U H·ªò', c:'bg-red-600'},
                units: {t:'TH√äM ƒê∆†N V·ªä', c:'bg-blue-600'}
            };
            const cfg = config[currentTab==='my'?'warning':currentTab];
            title.innerText = cfg.t; btn.className = `w-full py-3 rounded-xl text-white font-bold shadow-lg uppercase ${cfg.c}`;
        }
        function closeModal() { document.getElementById('create-modal').classList.add('hidden'); }
        
        function checkOther(selId, inpId) {
            const v = document.getElementById(selId).value;
            const inp = document.getElementById(inpId);
            if(v==='Kh√°c') { inp.classList.remove('hidden'); inp.focus(); } else inp.classList.add('hidden');
        }

        async function submitData() {
            document.getElementById('loading').classList.remove('hidden');
            const addr = getAddressString();
            if(!addr) { alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß T·ªânh/Huy·ªán/X√£"); document.getElementById('loading').classList.add('hidden'); return; }
            
            const desc = document.getElementById('desc').value;
            const common = {
                uid: currentUser.uid, creatorName: currentUser.displayName, userPhoto: currentUser.photoURL,
                phone: currentUser.phone, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                lat: currentLocation.lat, lng: currentLocation.lng, address: addr, desc: desc, status: 'new'
            };

            const tab = currentTab === 'my' ? 'warning' : currentTab;
            try {
                if(tab==='warning') {
                    let type = document.getElementById('w-type').value; if(type==='Kh√°c') type = document.getElementById('w-other').value;
                    const sev = document.querySelector('input[name="w-level"]:checked').value;
                    await db.collection('warnings').add({...common, type, severity: sev});
                } else if(tab==='sos') {
                    let type = document.getElementById('s-type').value; if(type==='Kh√°c') type = document.getElementById('s-other').value;
                    await db.collection('sos').add({...common, type, victims: document.getElementById('s-count').value, urgency: document.getElementById('s-urgency').value});
                } else {
                    let type = document.getElementById('u-type').value; if(type==='Kh√°c') type = document.getElementById('u-other').value;
                    await db.collection('units').add({...common, name: document.getElementById('u-name').value, type});
                }
                closeModal();
                alert("ƒêƒÉng tin th√†nh c√¥ng!");
            } catch(e) { alert("L·ªói: "+e.message); }
            finally { document.getElementById('loading').classList.add('hidden'); }
        }

        async function updateStatus(col, id, val) { await db.collection(col).doc(id).update({status: val}); }
        async function deleteItem(col, id) { if(confirm("X√≥a tin n√†y?")) await db.collection(col).doc(id).delete(); }

        // --- UTILS ---
        function getDist(lat, lng) {
            const R = 6371; const dLat = (lat-currentLocation.lat)*Math.PI/180; const dLon = (lng-currentLocation.lng)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(currentLocation.lat*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
        }
        function getDistVal(i) { return parseFloat(getDist(i.lat, i.lng)); }
        function flyTo(lat, lng) { map.flyTo([lat, lng], 16); if(window.innerWidth<768) document.getElementById('map').scrollIntoView(); }
        function timeAgo(ts) { if(!ts) return ''; const s = (new Date()-ts.toDate())/1000; if(s<60) return 'V·ª´a xong'; if(s<3600) return Math.floor(s/60)+' ph√∫t tr∆∞·ªõc'; return Math.floor(s/3600)+' gi·ªù tr∆∞·ªõc'; }

        // CSS Animation
        const st = document.createElement('style');
        st.innerHTML = `@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}`;
        document.head.appendChild(st);
    </script>
</body>
</html>
