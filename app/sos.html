
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOS C·ª©u H·ªô Thi√™n Tai | H·ªá th·ªëng to√†n di·ªán</title>
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- LEAFLET MAP CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- SHEETJS (Excel Import) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #007AFF;
            --danger: #FF3B30;
            --warning: #FF9500;
            --success: #34C759;
            --dark: #1C1C1E;
            --light: #F2F2F7;
            --white: #FFFFFF;
            --gray: #8E8E93;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--light); color: var(--dark); overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-success { color: var(--success); }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .w-100 { width: 100%; }
        
        /* --- BUTTONS --- */
        .btn { padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; transition: 0.2s; }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: var(--dark); }
        .btn-sm { padding: 5px 10px; font-size: 12px; }

        /* --- LOGIN & MODALS --- */
        #login-screen, #phone-update-screen { position: fixed; inset: 0; background: var(--white); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--white); width: 100%; max-width: 600px; height: 90vh; border-radius: 20px 20px 0 0; padding: 20px; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        @media(min-width: 768px) { .modal { align-items: center; } .modal-content { height: auto; max-height: 90vh; border-radius: 12px; } }

        /* --- MAIN LAYOUT --- */
        #app-container { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .header { height: 50px; background: var(--white); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #ddd; z-index: 100; flex-shrink: 0; }
        .user-chip { background: #f0f0f0; padding: 4px 10px; border-radius: 20px; display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer; }
        .user-chip img { width: 24px; height: 24px; border-radius: 50%; }

        /* CONTENT TABS */
        .tab-content { display: none; flex: 1; overflow: hidden; position: relative; }
        .tab-content.active { display: block; }
        
        /* MAP TAB */
        #map-container { width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* LIST TABS */
        .list-container { padding: 15px; overflow-y: auto; height: 100%; background: #f8f9fa; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; border-left: 4px solid #ccc; }
        .card.alert-card { border-left-color: var(--warning); }
        .card.rescue-card { border-left-color: var(--danger); }
        .card.unit-card { border-left-color: var(--success); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-time { font-size: 12px; color: var(--gray); }
        .card-actions { margin-top: 10px; display: flex; gap: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        /* BOTTOM NAV */
        .bottom-nav { height: var(--nav-height); background: var(--white); border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 100; flex-shrink: 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--gray); background: none; border: none; cursor: pointer; gap: 4px; padding: 5px; width: 25%; }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* FAB BUTTONS ON MAP */
        .fab-container { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 999; }
        .fab { width: 50px; height: 50px; border-radius: 50%; border: none; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .fab.fab-alert { background: var(--warning); color: white; }
        .fab.fab-rescue { background: var(--danger); color: white; animation: pulse 2s infinite; }
        
        /* FORMS */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        textarea.form-control { resize: none; height: 80px; }

        /* TOAST */
        .toast { position: fixed; top: 70px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 12px 20px; border-radius: 8px; z-index: 3000; font-size: 14px; transform: translateX(120%); transition: 0.3s; }
        .toast.show { transform: translateX(0); }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <i class="fa-solid fa-hands-holding-circle" style="font-size: 60px; color: var(--primary); margin-bottom: 20px;"></i>
        <h2>H·ªá Th·ªëng C·ª©u H·ªô</h2>
        <p style="color: #666; margin-bottom: 30px;">K·∫øt n·ªëi & H·ªó tr·ª£ thi√™n tai th·ªùi gian th·ª±c</p>
        <button class="btn btn-outline" onclick="handleGoogleLogin()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="">
            ƒêƒÉng nh·∫≠p v·ªõi Google
        </button>
    </div>

    <!-- 2. FORCE PHONE UPDATE SCREEN -->
    <div id="phone-update-screen" class="hidden">
        <h3>C·∫≠p nh·∫≠t th√¥ng tin</h3>
        <p style="text-align: center; margin: 10px 0; color: #555;">ƒê·ªÉ ƒë·∫£m b·∫£o li√™n l·∫°c khi kh·∫©n c·∫•p, vui l√≤ng cung c·∫•p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n.</p>
        <div class="form-group w-100" style="max-width: 300px;">
            <input type="tel" id="force-phone" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n">
        </div>
        <button class="btn btn-primary" onclick="updateUserPhone()">L∆∞u & Ti·∫øp t·ª•c</button>
    </div>

    <!-- 3. MAIN APP -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="header">
            <div style="font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px;">
                <i class="fa-solid fa-shield-heart"></i> SOS VIETNAM
            </div>
            <div class="user-chip" onclick="handleLogout()">
                <img id="header-avatar" src="" alt="">
                <span id="header-name">User</span>
                <i class="fa-solid fa-power-off" style="font-size: 10px; margin-left: 5px;"></i>
            </div>
        </header>

        <!-- Tab 1: Map -->
        <div id="tab-map" class="tab-content active">
            <div id="map"></div>
            <div class="fab-container">
                <button class="fab fab-alert" onclick="checkLocationAndOpen('alert-modal')"><i class="fa-solid fa-bullhorn"></i></button>
                <button class="fab fab-rescue" onclick="checkLocationAndOpen('rescue-modal')"><i class="fa-solid fa-life-ring"></i></button>
                <button class="fab" onclick="centerMapToUser()"><i class="fa-solid fa-location-crosshairs"></i></button>
            </div>
        </div>

        <!-- Tab 2: Alerts List -->
        <div id="tab-alerts" class="tab-content">
            <div class="list-container" id="alerts-list">
                <!-- Javascript will populate this -->
            </div>
        </div>

        <!-- Tab 3: Rescues List -->
        <div id="tab-rescues" class="tab-content">
            <div class="list-container" id="rescues-list">
                <!-- Javascript will populate this -->
            </div>
        </div>

        <!-- Tab 4: Rescue Units -->
        <div id="tab-units" class="tab-content">
            <div style="background: white; padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; gap: 10px;">
                <button class="btn btn-sm btn-success" onclick="openModal('unit-modal')"><i class="fa-solid fa-plus"></i> Th√™m ƒê∆°n V·ªã</button>
                <button class="btn btn-sm btn-outline" onclick="openModal('import-modal')"><i class="fa-solid fa-file-excel"></i> Nh·∫≠p Excel</button>
            </div>
            <div class="list-container" id="units-list">
                <!-- Javascript will populate this -->
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('map')">
                <i class="fa-solid fa-map-location-dot"></i> B·∫£n ƒë·ªì
            </button>
            <button class="nav-item" onclick="switchTab('alerts')">
                <i class="fa-solid fa-triangle-exclamation"></i> C·∫£nh b√°o
            </button>
            <button class="nav-item" onclick="switchTab('rescues')">
                <i class="fa-solid fa-life-ring"></i> C·ª©u h·ªô
            </button>
            <button class="nav-item" onclick="switchTab('units')">
                <i class="fa-solid fa-kit-medical"></i> ƒê·ªôi c·ª©u h·ªô
            </button>
        </nav>
    </div>

    <!-- --- MODALS --- -->

    <!-- Modal Alert -->
    <div id="alert-modal" class="modal" onclick="clickOutside(event, this)">
        <div class="modal-content">
            <h3>‚ö†Ô∏è T·∫°o C·∫£nh B√°o</h3>
            <div class="form-group">
                <label class="form-label">Lo·∫°i thi√™n tai</label>
                <select id="alert-type" class="form-control" onchange="toggleOtherInput('alert-type', 'alert-other-div')">
                    <option value="L≈© l·ª•t">L≈© l·ª•t / Ng·∫≠p √∫ng</option>
                    <option value="S·∫°t l·ªü">S·∫°t l·ªü ƒë·∫•t</option>
                    <option value="B√£o">B√£o / Gi√≥ gi·∫≠t</option>
                    <option value="Ch√°y">Ch√°y n·ªï</option>
                    <option value="other">Kh√°c (Nh·∫≠p b√™n d∆∞·ªõi)</option>
                </select>
            </div>
            <div id="alert-other-div" class="form-group hidden">
                <input type="text" id="alert-other" class="form-control" placeholder="Nh·∫≠p lo·∫°i thi√™n tai...">
            </div>
            <div class="form-group">
                <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                <textarea id="alert-desc" class="form-control" placeholder="M√¥ t·∫£ t√¨nh h√¨nh hi·ªán t·∫°i..."></textarea>
            </div>
            <button class="btn btn-warning w-100" onclick="submitAlert()">ƒêƒÉng C·∫£nh B√°o</button>
            <button class="btn btn-outline w-100" style="margin-top: 10px;" onclick="closeModal('alert-modal')">H·ªßy</button>
        </div>
    </div>

    <!-- Modal Rescue -->
    <div id="rescue-modal" class="modal" onclick="clickOutside(event, this)">
        <div class="modal-content">
            <h3>üÜò Y√™u C·∫ßu C·ª©u H·ªô</h3>
            <div class="form-group">
                <label class="form-label">T√¨nh tr·∫°ng</label>
                <select id="rescue-status" class="form-control" onchange="toggleOtherInput('rescue-status', 'rescue-other-div')">
                    <option value="M·∫Øc k·∫πt">B·ªã m·∫Øc k·∫πt</option>
                    <option value="B·ªã th∆∞∆°ng">C√≥ ng∆∞·ªùi b·ªã th∆∞∆°ng</option>
                    <option value="Nguy hi·ªÉm">Nguy hi·ªÉm t√≠nh m·∫°ng</option>
                    <option value="Thi·∫øu l∆∞∆°ng th·ª±c">C·∫ßn l∆∞∆°ng th·ª±c/thu·ªëc</option>
                    <option value="other">Kh√°c (Nh·∫≠p b√™n d∆∞·ªõi)</option>
                </select>
            </div>
            <div id="rescue-other-div" class="form-group hidden">
                <input type="text" id="rescue-other" class="form-control" placeholder="Nh·∫≠p t√¨nh tr·∫°ng...">
            </div>
            <div class="form-group">
                <label class="form-label">Chi ti·∫øt / S·ªë l∆∞·ª£ng ng∆∞·ªùi</label>
                <textarea id="rescue-desc" class="form-control"></textarea>
            </div>
            <button class="btn btn-danger w-100" onclick="submitRescue()">G·ª≠i Y√™u C·∫ßu Ngay</button>
            <button class="btn btn-outline w-100" style="margin-top: 10px;" onclick="closeModal('rescue-modal')">H·ªßy</button>
        </div>
    </div>

    <!-- Modal Add Unit -->
    <div id="unit-modal" class="modal" onclick="clickOutside(event, this)">
        <div class="modal-content">
            <h3>üöë Th√™m ƒê∆°n V·ªã C·ª©u H·ªô</h3>
            <p style="font-size:12px; color: #666; margin-bottom: 10px;">V·ªã tr√≠ s·∫Ω ƒë∆∞·ª£c l·∫•y t·∫°i n∆°i b·∫°n ƒëang ghim tr√™n b·∫£n ƒë·ªì.</p>
            <div class="form-group">
                <label class="form-label">T√™n ƒë∆°n v·ªã / C√° nh√¢n</label>
                <input type="text" id="unit-name" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" id="unit-phone" class="form-control">
            </div>
            <div class="form-group">
                <button class="btn btn-outline w-100" onclick="startPickingLocation()">
                    <i class="fa-solid fa-map-pin"></i> Ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì
                </button>
                <input type="hidden" id="unit-lat"><input type="hidden" id="unit-lng">
                <div id="picked-loc-msg" style="font-size: 12px; color: green; margin-top: 5px; display: none;">ƒê√£ ch·ªçn v·ªã tr√≠!</div>
            </div>
            <button class="btn btn-success w-100" onclick="submitUnit()">L∆∞u ƒê∆°n V·ªã</button>
            <button class="btn btn-outline w-100" style="margin-top: 10px;" onclick="closeModal('unit-modal')">H·ªßy</button>
        </div>
    </div>

    <!-- Modal Import Excel -->
    <div id="import-modal" class="modal" onclick="clickOutside(event, this)">
        <div class="modal-content" style="max-height: 50vh;">
            <h3>üìÇ Nh·∫≠p t·ª´ Excel</h3>
            <p style="font-size: 13px; color: #555; margin-bottom: 15px;">T·∫£i l√™n danh s√°ch c√°c ƒë∆°n v·ªã c·ª©u h·ªô.</p>
            
            <button class="btn btn-outline w-100" style="margin-bottom: 15px;" onclick="downloadTemplate()">
                <i class="fa-solid fa-download"></i> T·∫£i file m·∫´u
            </button>

            <input type="file" id="excel-file" accept=".xlsx, .xls" class="form-control" style="margin-bottom: 15px;">
            
            <button class="btn btn-primary w-100" onclick="processImport()">Nh·∫≠p D·ªØ Li·ªáu</button>
        </div>
    </div>

    <!-- Modal Navigation Choice -->
    <div id="nav-modal" class="modal" onclick="clickOutside(event, this)">
        <div class="modal-content" style="max-height: 40vh;">
            <h3>üó∫Ô∏è Ch·ªçn b·∫£n ƒë·ªì d·∫´n ƒë∆∞·ªùng</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; width: 100%; margin-top: 20px;">
                <button class="btn btn-outline w-100" id="btn-google-maps">
                    <i class="fa-brands fa-google"></i> Google Maps
                </button>
                <button class="btn btn-outline w-100" id="btn-apple-maps">
                    <i class="fa-brands fa-apple"></i> Apple Maps
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Th√¥ng b√°o</div>

    <script>
        // --- C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD_API_KEY_CUA_BAN",
            authDomain: "project-id.firebaseapp.com",
            projectId: "project-id",
            storageBucket: "project-id.appspot.com",
            messagingSenderId: "xxxx",
            appId: "xxxx"
        };
        
        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error("Ch∆∞a config Firebase", e); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let map = null, userMarker = null;
        let currentPos = { lat: 0, lng: 0 };
        let markers = { alerts: [], rescues: [], units: [] };
        let tempMarker = null; // Marker t·∫°m khi ch·ªçn v·ªã tr√≠
        let isPickingLocation = false;

        // --- AUTH & USER ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Ki·ªÉm tra xem user c√≥ sƒët trong Firestore ch∆∞a (n·∫øu login google ch∆∞a c√≥ sƒët)
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists || !userDoc.data().phone) {
                    currentUser = user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('phone-update-screen').classList.remove('hidden');
                } else {
                    completeLogin(user, userDoc.data());
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        function handleGoogleLogin() {
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => showToast("L·ªói: " + err.message));
        }

        function handleLogout() { auth.signOut().then(() => window.location.reload()); }

        function updateUserPhone() {
            const phone = document.getElementById('force-phone').value;
            if (phone.length < 9) return alert("Vui l√≤ng nh·∫≠p SƒêT h·ª£p l·ªá");
            
            db.collection('users').doc(currentUser.uid).set({
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                phone: phone,
                photo: currentUser.photoURL
            }, { merge: true }).then(() => {
                document.getElementById('phone-update-screen').classList.add('hidden');
                completeLogin(currentUser, { phone: phone, name: currentUser.displayName, photo: currentUser.photoURL });
            });
        }

        function completeLogin(user, userData) {
            currentUser = { ...user, ...userData }; // Merge auth info & firestore info
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('header-name').innerText = userData.name || "User";
            document.getElementById('header-avatar').src = userData.photo || "https://ui-avatars.com/api/?name=User";
            
            initMap();
            listenRealtimeData();
        }

        // --- MAP LOGIC ---
        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([10.762, 106.660], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    if (!userMarker) {
                        const icon = L.divIcon({ className: 'my-loc', html: '<div style="width:16px;height:16px;background:blue;border:2px solid white;border-radius:50%;box-shadow:0 0 10px blue;"></div>' });
                        userMarker = L.marker([currentPos.lat, currentPos.lng], { icon: icon }).addTo(map);
                        map.setView([currentPos.lat, currentPos.lng], 15);
                    } else {
                        userMarker.setLatLng([currentPos.lat, currentPos.lng]);
                    }
                }, err => console.warn(err), { enableHighAccuracy: true });
            }

            // Click map to pick location (for Unit)
            map.on('click', (e) => {
                if (isPickingLocation) {
                    if (tempMarker) map.removeLayer(tempMarker);
                    tempMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
                    document.getElementById('unit-lat').value = e.latlng.lat;
                    document.getElementById('unit-lng').value = e.latlng.lng;
                    document.getElementById('picked-loc-msg').style.display = 'block';
                    
                    // Delay open modal back
                    setTimeout(() => {
                        isPickingLocation = false;
                        openModal('unit-modal');
                    }, 500);
                }
            });
        }

        function centerMapToUser() {
            if(map && currentPos.lat !== 0) map.setView([currentPos.lat, currentPos.lng], 16);
            else showToast("ƒêang l·∫•y v·ªã tr√≠...");
        }

        // --- TABS & NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelector(`.nav-item[onclick="switchTab('${tabId}')"]`).classList.add('active');

            if (tabId === 'map') setTimeout(() => map.invalidateSize(), 100);
        }

        // --- DATA HANDLERS (ALERTS, RESCUES, UNITS) ---
        function listenRealtimeData() {
            // Alerts
            db.collection('alerts').orderBy('timestamp', 'desc').onSnapshot(snap => {
                const list = document.getElementById('alerts-list');
                list.innerHTML = '';
                markers.alerts.forEach(m => map.removeLayer(m));
                markers.alerts = [];

                snap.forEach(doc => {
                    const data = doc.data();
                    renderItem('alert', doc.id, data, list);
                    addMapMarker('alert', doc.id, data);
                });
            });

            // Rescues
            db.collection('rescues').orderBy('timestamp', 'desc').onSnapshot(snap => {
                const list = document.getElementById('rescues-list');
                list.innerHTML = '';
                markers.rescues.forEach(m => map.removeLayer(m));
                markers.rescues = [];

                snap.forEach(doc => {
                    const data = doc.data();
                    renderItem('rescue', doc.id, data, list);
                    addMapMarker('rescue', doc.id, data);
                });
            });

            // Units
            db.collection('units').onSnapshot(snap => {
                const list = document.getElementById('units-list');
                // Keep the header buttons
                const header = list.parentNode.querySelector('div:first-child').outerHTML; 
                // Don't clear list completely, handled by separate container if needed, but for now simple innerHTML reset excluding buttons
                list.innerHTML = '';
                markers.units.forEach(m => map.removeLayer(m));
                markers.units = [];

                snap.forEach(doc => {
                    const data = doc.data();
                    renderItem('unit', doc.id, data, list);
                    addMapMarker('unit', doc.id, data);
                });
            });
        }

        function renderItem(type, id, data, container) {
            const isOwner = data.uid === currentUser.uid;
            const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : '';
            let icon, color, title, desc;

            if (type === 'alert') {
                icon = 'fa-triangle-exclamation'; color = 'var(--warning)'; 
                title = data.type; desc = data.desc;
            } else if (type === 'rescue') {
                icon = 'fa-life-ring'; color = 'var(--danger)'; 
                title = data.status; desc = data.desc;
            } else {
                icon = 'fa-kit-medical'; color = 'var(--success)'; 
                title = data.name; desc = data.phone;
            }

            const html = `
                <div class="card ${type}-card">
                    <div class="card-header">
                        <div style="font-weight:bold; display:flex; gap:8px; align-items:center;">
                            <i class="fa-solid ${icon}" style="color:${color}"></i> ${title}
                        </div>
                        ${isOwner ? `<button class="btn-sm btn-outline text-danger" onclick="deleteItem('${type}s', '${id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                    <div style="font-size:14px; margin-bottom:5px;">${desc}</div>
                    <div class="card-time"><i class="fa-regular fa-clock"></i> ${date} - B·ªüi: ${data.creatorName || '·∫®n danh'}</div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-outline" onclick="locateOnMap(${data.lat}, ${data.lng})">
                            <i class="fa-solid fa-location-dot"></i> V·ªã tr√≠
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="openNavModal(${data.lat}, ${data.lng})">
                            <i class="fa-solid fa-diamond-turn-right"></i> Ch·ªâ ƒë∆∞·ªùng
                        </button>
                        <a href="tel:${data.phone}" class="btn btn-sm btn-success">
                            <i class="fa-solid fa-phone"></i> G·ªçi: ${data.phone}
                        </a>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        }

        function addMapMarker(type, id, data) {
            let color = type === 'alert' ? 'orange' : (type === 'rescue' ? 'red' : 'green');
            let iconClass = type === 'rescue' ? 'fa-beat-fade' : '';
            
            const html = `<div style="background:${color};width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;border:2px solid white;box-shadow:0 3px 6px rgba(0,0,0,0.3);">
                <i class="fa-solid fa-${type === 'alert' ? 'triangle-exclamation' : (type === 'rescue' ? 'life-ring' : 'kit-medical')} ${iconClass}"></i>
            </div>`;
            
            const icon = L.divIcon({ html: html, className: '', iconSize: [30, 30] });
            const marker = L.marker([data.lat, data.lng], { icon: icon }).bindPopup(`
                <b>${data.type || data.status || data.name}</b><br>
                ${data.desc || data.phone}<br>
                <button onclick="openNavModal(${data.lat}, ${data.lng})" style="margin-top:5px; padding:5px; border:1px solid #ccc; background:#fff; cursor:pointer;">Ch·ªâ ƒë∆∞·ªùng</button>
            `);
            
            marker.addTo(map);
            if (type === 'alert') markers.alerts.push(marker);
            else if (type === 'rescue') markers.rescues.push(marker);
            else markers.units.push(marker);
        }

        // --- ACTIONS ---
        function checkLocationAndOpen(modalId) {
            if (currentPos.lat === 0) {
                alert("Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y!");
                return;
            }
            openModal(modalId);
        }

        function toggleOtherInput(selectId, divId) {
            const val = document.getElementById(selectId).value;
            if (val === 'other') document.getElementById(divId).classList.remove('hidden');
            else document.getElementById(divId).classList.add('hidden');
        }

        function getInputValue(selectId, inputId) {
            const val = document.getElementById(selectId).value;
            return val === 'other' ? document.getElementById(inputId).value : val;
        }

        // CREATE
        function submitAlert() {
            const type = getInputValue('alert-type', 'alert-other');
            const desc = document.getElementById('alert-desc').value;
            if(!type || !desc) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin");

            db.collection('alerts').add({
                uid: currentUser.uid,
                creatorName: currentUser.name,
                phone: currentUser.phone,
                type: type,
                desc: desc,
                lat: currentPos.lat,
                lng: currentPos.lng,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { closeModal('alert-modal'); showToast("ƒê√£ t·∫°o c·∫£nh b√°o!"); });
        }

        function submitRescue() {
            const status = getInputValue('rescue-status', 'rescue-other');
            const desc = document.getElementById('rescue-desc').value;
            if(!status) return alert("Vui l√≤ng ch·ªçn t√¨nh tr·∫°ng");

            db.collection('rescues').add({
                uid: currentUser.uid,
                creatorName: currentUser.name,
                phone: currentUser.phone,
                status: status,
                desc: desc,
                lat: currentPos.lat,
                lng: currentPos.lng,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { closeModal('rescue-modal'); showToast("ƒê√£ g·ª≠i y√™u c·∫ßu c·ª©u h·ªô!"); });
        }

        function startPickingLocation() {
            closeModal('unit-modal');
            isPickingLocation = true;
            showToast("Ch·∫°m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠");
        }

        function submitUnit() {
            const name = document.getElementById('unit-name').value;
            const phone = document.getElementById('unit-phone').value;
            const lat = parseFloat(document.getElementById('unit-lat').value);
            const lng = parseFloat(document.getElementById('unit-lng').value);

            if(!name || !phone || isNaN(lat)) return alert("Nh·∫≠p t√™n, SƒêT v√† ch·ªçn v·ªã tr√≠!");

            db.collection('units').add({
                uid: currentUser.uid, // Track creator
                name: name,
                phone: phone,
                lat: lat,
                lng: lng,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { 
                closeModal('unit-modal'); 
                if(tempMarker) map.removeLayer(tempMarker);
                showToast("ƒê√£ th√™m ƒë∆°n v·ªã c·ª©u h·ªô!"); 
            });
        }

        // DELETE
        function deleteItem(collection, id) {
            if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tin n√†y kh√¥ng?")) {
                db.collection(collection).doc(id).delete().then(() => showToast("ƒê√£ x√≥a!"));
            }
        }

        // NAVIGATE
        function locateOnMap(lat, lng) {
            switchTab('map');
            map.setView([lat, lng], 18);
        }

        function openNavModal(lat, lng) {
            openModal('nav-modal');
            document.getElementById('btn-google-maps').onclick = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
            document.getElementById('btn-apple-maps').onclick = () => window.open(`http://maps.apple.com/?daddr=${lat},${lng}`, '_blank');
        }

        // --- EXCEL IMPORT ---
        function downloadTemplate() {
            const ws = XLSX.utils.json_to_sheet([{ "T√™n ƒë∆°n v·ªã": "ƒê·ªôi SOS A", "S·ªë ƒëi·ªán tho·∫°i": "0909123456", "Vƒ© ƒë·ªô (Lat)": 10.762, "Kinh ƒë·ªô (Lng)": 106.660 }]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Mau_Don_Vi");
            XLSX.writeFile(wb, "Mau_Nhap_Don_Vi_Cuu_Ho.xlsx");
        }

        function processImport() {
            const file = document.getElementById('excel-file').files[0];
            if (!file) return alert("Vui l√≤ng ch·ªçn file!");

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                if (json.length === 0) return alert("File tr·ªëng!");

                let batch = db.batch();
                let count = 0;
                json.forEach(row => {
                    // Mapping columns (Adjust based on template)
                    const name = row['T√™n ƒë∆°n v·ªã'] || row['Ten don vi'] || row['name'];
                    const phone = row['S·ªë ƒëi·ªán tho·∫°i'] || row['So dien thoai'] || row['phone'];
                    const lat = row['Vƒ© ƒë·ªô (Lat)'] || row['lat'];
                    const lng = row['Kinh ƒë·ªô (Lng)'] || row['lng'];

                    if (name && lat && lng) {
                        const ref = db.collection('units').doc();
                        batch.set(ref, {
                            uid: currentUser.uid,
                            name: name,
                            phone: phone || '',
                            lat: parseFloat(lat),
                            lng: parseFloat(lng),
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        count++;
                    }
                });

                batch.commit().then(() => {
                    closeModal('import-modal');
                    showToast(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${count} ƒë∆°n v·ªã!`);
                }).catch(err => alert("L·ªói nh·∫≠p li·ªáu: " + err));
            };
            reader.readAsArrayBuffer(file);
        }

        // --- HELPER UI ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function clickOutside(e, el) { if (e.target === el) el.classList.remove('active'); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
