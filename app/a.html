<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaskMaster Pro</title>
    <meta name="theme-color" content="#4A90E2">
    <meta name="description" content="Qu·∫£n l√Ω c√¥ng vi·ªác hi·ªáu qu·∫£">
    
    <!-- PWA Capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TaskMaster">
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --primary: #4A90E2;
            --primary-dark: #357ABD;
            --accent: #FF5A5F;
            --success: #2ECC71;
            --warning: #F1C40F;
            --bg-body: #F4F6F8;
            --bg-card: #FFFFFF;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --border: #E1E8ED;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 16px;
            --nav-height: 70px;
            --font-main: 'Inter', sans-serif;
            --ease: cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1E1E1E;
            --text-main: #E0E0E0;
            --text-sub: #A0A0A0;
            --border: #333333;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }
        input, textarea { user-select: text; }

        /* --- LAYOUT --- */
        .app-container { height: 100%; display: flex; flex-direction: column; max-width: 500px; margin: 0 auto; background: var(--bg-body); position: relative; }
        
        /* HEADER */
        header { padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top)); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); z-index: 10; position: sticky; top: 0; }
        .app-title { font-weight: 800; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        .app-title i { color: var(--primary); background: rgba(74, 144, 226, 0.15); padding: 8px; border-radius: 10px; }
        
        .header-actions { display: flex; gap: 10px; }
        .icon-btn { background: var(--bg-body); border: none; width: 40px; height: 40px; border-radius: 50%; color: var(--text-main); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); }

        /* MAIN CONTENT */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; -webkit-overflow-scrolling: touch; }
        
        /* SEGMENTED CONTROL */
        .view-switcher { display: flex; background: rgba(127, 140, 141, 0.1); padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .view-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 10px; font-weight: 600; color: var(--text-sub); cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .view-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* TASK LIST */
        .task-list { display: flex; flex-direction: column; gap: 15px; }
        .task-card { background: var(--bg-card); padding: 16px; border-radius: var(--radius); box-shadow: var(--shadow); display: flex; align-items: flex-start; gap: 15px; transition: transform 0.2s; cursor: pointer; animation: slideUp 0.3s var(--ease); position: relative; overflow: hidden; }
        .task-card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: var(--border); }
        .task-card.priority-high::before { background: var(--accent); }
        .task-card.priority-medium::before { background: var(--warning); }
        .task-card.priority-low::before { background: var(--success); }
        
        .task-check { min-width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 50%; margin-top: 2px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; z-index: 2; }
        .task-card.completed .task-check { background: var(--success); border-color: var(--success); }
        .task-card.completed .task-check::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 12px; }
        .task-card.completed .task-content { text-decoration: line-through; opacity: 0.5; }

        .task-content { flex: 1; }
        .task-title { font-weight: 600; font-size: 1.05rem; margin-bottom: 5px; line-height: 1.4; }
        .task-meta { font-size: 0.8rem; color: var(--text-sub); display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        .badge { padding: 4px 8px; border-radius: 6px; background: var(--bg-body); font-size: 0.75rem; font-weight: 600; }
        
        /* CALENDAR */
        .calendar-view { display: none; }
        .calendar-view.active { display: block; animation: fadeIn 0.3s; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 700; font-size: 1.1rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .cal-day-head { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 10px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.95rem; cursor: pointer; position: relative; background: var(--bg-card); border: 1px solid transparent; }
        .cal-day.today { background: var(--primary); color: white; font-weight: 700; }
        .cal-day.has-task::after { content: ''; position: absolute; bottom: 6px; width: 5px; height: 5px; background: var(--accent); border-radius: 50%; }
        .cal-day:hover { border-color: var(--primary); }

        /* FAB */
        .fab { position: fixed; bottom: 100px; right: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.6rem; border: none; box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4); cursor: pointer; z-index: 90; transition: transform 0.2s; }
        .fab:hover { transform: scale(1.05); }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--bg-card); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 100; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -2px 10px rgba(0,0,0,0.02); }
        .nav-item { border: none; background: none; color: var(--text-sub); flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; cursor: pointer; position: relative; }
        .nav-item i { font-size: 1.3rem; transition: 0.2s; }
        .nav-item span { font-size: 0.7rem; font-weight: 600; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-2px); }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 25px; transform: translateY(100%); transition: transform 0.3s var(--ease); max-height: 85vh; overflow-y: auto; }
        .modal-overlay.open .modal { transform: translateY(0); }
        
        .form-label { display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: 14px; border: 2px solid var(--bg-body); border-radius: 12px; background: var(--bg-body); color: var(--text-main); font-family: var(--font-main); font-size: 1rem; outline: none; transition: 0.2s; }
        .form-control:focus { border-color: var(--primary); background: var(--bg-card); }
        
        .priority-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .p-btn { flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 12px; background: transparent; color: var(--text-sub); font-weight: 600; cursor: pointer; transition: 0.2s; }
        .p-btn[data-val="low"].selected { border-color: var(--success); background: rgba(46, 204, 113, 0.1); color: var(--success); }
        .p-btn[data-val="medium"].selected { border-color: var(--warning); background: rgba(241, 196, 15, 0.1); color: var(--warning); }
        .p-btn[data-val="high"].selected { border-color: var(--accent); background: rgba(255, 90, 95, 0.1); color: var(--accent); }

        .btn-primary { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3); }
        
        /* TOAST */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 12px 20px; border-radius: 30px; z-index: 2000; font-weight: 500; display: flex; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.4s var(--ease); opacity: 0; width: max-content; max-width: 90%; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* INSTALL PROMPT */
        .install-banner { position: fixed; bottom: 85px; left: 20px; right: 20px; background: var(--text-main); color: var(--bg-card); padding: 15px; border-radius: 16px; z-index: 999; display: none; align-items: center; justify-content: space-between; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideUp 0.4s; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* DESKTOP TWEAKS */
        @media (min-width: 768px) {
            .app-container { border-left: 1px solid var(--border); border-right: 1px solid var(--border); height: 95vh; margin-top: 2.5vh; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
            .modal { border-radius: 20px; margin-bottom: 20px; max-width: 460px; }
            .modal-overlay { align-items: center; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="app-title"><i class="fa-solid fa-check-double"></i> TaskMaster</div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle"><i class="fa-solid fa-moon"></i></button>
            <button class="icon-btn" id="notifToggle"><i class="fa-regular fa-bell"></i></button>
        </div>
    </header>

    <main>
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('list')">Danh s√°ch vi·ªác</button>
            <button class="view-btn" onclick="switchView('calendar')">L·ªãch bi·ªÉu</button>
        </div>

        <div id="loader" style="text-align: center; margin-top: 50px; display: none;">
            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
        </div>

        <!-- LIST VIEW -->
        <div id="listView" class="task-list">
            <!-- Dynamic Content -->
        </div>

        <!-- CALENDAR VIEW -->
        <div id="calendarView" class="calendar-view">
            <div class="cal-header">
                <button class="icon-btn" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="currentMonth"></span>
                <button class="icon-btn" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="cal-grid" id="calendarGrid"></div>
            <div id="selectedDateTasks" class="task-list" style="margin-top: 25px;"></div>
        </div>
    </main>

    <button class="fab" onclick="openModal()"><i class="fa-solid fa-plus"></i></button>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchView('list')">
            <i class="fa-solid fa-list-ul"></i><span>Tasks</span>
        </button>
        <button class="nav-item" onclick="switchView('calendar')">
            <i class="fa-regular fa-calendar-days"></i><span>L·ªãch</span>
        </button>
        <button class="nav-item" id="btnInstall" onclick="installApp()" style="display:none">
            <i class="fa-solid fa-download"></i><span>C√†i App</span>
        </button>
    </nav>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="taskModal" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center">
            <h2 style="font-size:1.3rem;">C√¥ng vi·ªác</h2>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem; color:var(--text-sub); cursor:pointer">&times;</button>
        </div>
        <form id="taskForm">
            <input type="hidden" id="taskId">
            <div style="margin-bottom:15px">
                <label class="form-label">T√™n c√¥ng vi·ªác</label>
                <input type="text" id="taskTitle" class="form-control" required placeholder="Nh·∫≠p ti√™u ƒë·ªÅ...">
            </div>
            <div style="margin-bottom:15px">
                <label class="form-label">Th·ªùi gian</label>
                <input type="datetime-local" id="taskDate" class="form-control" required>
            </div>
            <div style="margin-bottom:15px">
                <label class="form-label">M·ª©c ƒë·ªô ∆∞u ti√™n</label>
                <div class="priority-group">
                    <div class="p-btn selected" data-val="low" onclick="selectPriority('low')">Th·∫•p</div>
                    <div class="p-btn" data-val="medium" onclick="selectPriority('medium')">V·ª´a</div>
                    <div class="p-btn" data-val="high" onclick="selectPriority('high')">Cao</div>
                </div>
                <input type="hidden" id="taskPriority" value="low">
            </div>
            <div style="margin-bottom:20px">
                <label class="form-label">Ghi ch√∫</label>
                <textarea id="taskNote" class="form-control" rows="3" placeholder="Chi ti·∫øt..."></textarea>
            </div>
            <button type="submit" class="btn-primary">L∆∞u c√¥ng vi·ªác</button>
            <button type="button" id="btnDelete" onclick="deleteTask()" style="width:100%; padding:15px; margin-top:10px; background:transparent; color:var(--accent); border:none; font-weight:600; cursor:pointer; display:none">Xo√° c√¥ng vi·ªác n√†y</button>
        </form>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
    <i class="fa-solid fa-bell"></i> <span id="toastMsg"></span>
</div>

<!-- INSTALL BANNER -->
<div class="install-banner" id="pwaBanner">
    <div>
        <div style="font-weight:700">C√†i ƒë·∫∑t TaskMaster</div>
        <div style="font-size:0.8rem; opacity:0.8">Th√™m v√†o m√†n h√¨nh ch√≠nh ƒë·ªÉ nh·∫≠n th√¥ng b√°o</div>
    </div>
    <button onclick="installApp()" style="background:var(--bg-card); color:var(--text-main); border:none; padding:8px 15px; border-radius:8px; font-weight:700">C√†i ƒë·∫∑t</button>
</div>

<!-- JAVASCRIPT MODULE -->
<script type="module">
    // --- FIREBASE CONFIG ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tasksCol = collection(db, "tasks");

    // --- STATE ---
    let tasks = [];
    let currentView = 'list';
    let currentMonth = new Date();
    let deferredPrompt;
    
    // Simple User ID (Local Persistence)
    let userId = localStorage.getItem('tm_uid');
    if(!userId) {
        userId = 'u_' + Date.now() + Math.random().toString(36).slice(2);
        localStorage.setItem('tm_uid', userId);
    }

    // --- DOM HELPERS ---
    const $ = s => document.querySelector(s);
    const showToast = (msg, isError = false) => {
        const t = $('#toast');
        $('#toastMsg').innerText = msg;
        t.style.background = isError ? '#FF5A5F' : '#333';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3500);
    };

    // --- CORE LOGIC ---
    function init() {
        $('#loader').style.display = 'block';
        const q = query(tasksCol, orderBy("date", "asc"));
        
        onSnapshot(q, (snapshot) => {
            // Client-side filtering for user
            tasks = snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(t => t.userId === userId);
            render();
            $('#loader').style.display = 'none';
        }, (err) => {
            console.error(err);
            showToast('L·ªói k·∫øt n·ªëi m·∫°ng!', true);
        });

        setupNotifications();
    }

    function render() {
        if(currentView === 'list') renderList();
        else renderCalendar();
    }

    function renderList() {
        const list = $('#listView');
        list.innerHTML = '';
        
        const sorted = [...tasks].sort((a,b) => new Date(a.date) - new Date(b.date));
        
        if(sorted.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-sub)">
                <i class="fa-solid fa-clipboard-check" style="font-size:3rem; margin-bottom:15px; opacity:0.3"></i><br>
                S·∫°ch b√°ch! Kh√¥ng c√≥ vi·ªác g√¨.
            </div>`;
            return;
        }

        sorted.forEach(t => {
            const dateObj = new Date(t.date);
            const isOverdue = new Date() > dateObj && !t.completed;
            const timeStr = dateObj.toLocaleString('vi-VN', { hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' });
            
            const el = document.createElement('div');
            el.className = `task-card priority-${t.priority} ${t.completed ? 'completed' : ''}`;
            el.draggable = true;
            el.innerHTML = `
                <div class="task-check" onclick="window.toggleComplete('${t.id}', ${!t.completed}, event)"></div>
                <div class="task-content" onclick="window.editTask('${t.id}')">
                    <div class="task-title" style="${isOverdue ? 'color:var(--accent)' : ''}">${t.title}</div>
                    <div class="task-meta">
                        <span class="badge" style="background:${isOverdue ? 'rgba(255,90,95,0.1)' : 'var(--bg-body)'}; color:${isOverdue ? 'var(--accent)' : 'inherit'}">
                            <i class="fa-regular fa-clock"></i> ${timeStr}
                        </span>
                        ${t.note ? '<i class="fa-solid fa-align-left" style="opacity:0.5"></i>' : ''}
                    </div>
                </div>
            `;
            // Drag Logic
            el.addEventListener('dragstart', () => el.style.opacity = '0.5');
            el.addEventListener('dragend', () => el.style.opacity = '1');
            list.appendChild(el);
        });
    }

    function renderCalendar() {
        const grid = $('#calendarGrid');
        grid.innerHTML = '';
        
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        $('#currentMonth').innerText = `Th√°ng ${month + 1}, ${year}`;

        ['CN','T2','T3','T4','T5','T6','T7'].forEach(d => grid.innerHTML += `<div class="cal-day-head">${d}</div>`);

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const now = new Date();

        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

        for(let i=1; i<=daysInMonth; i++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const hasTask = tasks.some(t => t.date.startsWith(dateStr) && !t.completed);
            const isToday = now.getDate() === i && now.getMonth() === month && now.getFullYear() === year;
            
            const el = document.createElement('div');
            el.className = `cal-day ${isToday ? 'today' : ''} ${hasTask ? 'has-task' : ''}`;
            el.innerText = i;
            el.onclick = () => {
                document.querySelectorAll('.cal-day').forEach(d => d.style.borderColor = 'transparent');
                el.style.borderColor = 'var(--primary)';
                showTasksForDate(dateStr);
            };
            grid.appendChild(el);
        }
    }

    window.showTasksForDate = (dateStr) => {
        const container = $('#selectedDateTasks');
        const dayTasks = tasks.filter(t => t.date.startsWith(dateStr));
        
        container.innerHTML = `<h4 style="margin-bottom:10px; color:var(--text-sub)">Ng√†y ${dateStr}</h4>`;
        if(dayTasks.length === 0) container.innerHTML += '<div style="opacity:0.6">Kh√¥ng c√≥ l·ªãch.</div>';
        
        dayTasks.forEach(t => {
            const d = document.createElement('div');
            d.className = `task-card priority-${t.priority}`;
            d.style.padding = '12px';
            d.innerHTML = `<div class="task-title" style="font-size:0.95rem">${t.title}</div>`;
            d.onclick = () => window.editTask(t.id);
            container.appendChild(d);
        });
    };

    // --- ACTIONS ---
    window.switchView = (v) => {
        currentView = v;
        $('.view-switcher .active').classList.remove('active');
        $(`.view-switcher button[onclick="switchView('${v}')"]`).classList.add('active');
        $('.bottom-nav .active').classList.remove('active');
        $(`.bottom-nav button[onclick="switchView('${v}')"]`).classList.add('active');

        if(v === 'list') {
            $('#listView').style.display = 'flex';
            $('#calendarView').classList.remove('active');
        } else {
            $('#listView').style.display = 'none';
            $('#calendarView').classList.add('active');
            renderCalendar();
        }
    };

    window.changeMonth = (d) => {
        currentMonth.setMonth(currentMonth.getMonth() + d);
        renderCalendar();
    };

    window.openModal = () => {
        $('#taskForm').reset();
        $('#taskId').value = '';
        $('#btnDelete').style.display = 'none';
        window.selectPriority('low');
        
        // Default time: Now + 1 hour
        const now = new Date();
        now.setHours(now.getHours() + 1);
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        $('#taskDate').value = now.toISOString().slice(0,16);
        
        $('#taskModal').classList.add('open');
    };

    window.editTask = (id) => {
        const t = tasks.find(x => x.id === id);
        if(!t) return;
        $('#taskId').value = t.id;
        $('#taskTitle').value = t.title;
        $('#taskDate').value = t.date;
        $('#taskNote').value = t.note || '';
        window.selectPriority(t.priority);
        $('#btnDelete').style.display = 'block';
        $('#taskModal').classList.add('open');
    };

    window.closeModal = (e) => {
        if(!e || e.target.id === 'taskModal' || !e.target.closest('.modal')) {
            $('#taskModal').classList.remove('open');
        }
    };

    window.selectPriority = (val) => {
        $('#taskPriority').value = val;
        document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('selected'));
        $(`.p-btn[data-val="${val}"]`).classList.add('selected');
    };

    window.toggleComplete = async (id, status, e) => {
        e.stopPropagation();
        try {
            await updateDoc(doc(db, "tasks", id), { completed: status });
        } catch(e) { showToast('L·ªói c·∫≠p nh·∫≠t', true); }
    };

    window.deleteTask = async () => {
        if(!confirm('Xo√° c√¥ng vi·ªác n√†y?')) return;
        try {
            await deleteDoc(doc(db, "tasks", $('#taskId').value));
            showToast('ƒê√£ xo√°');
            window.closeModal();
        } catch(e) { showToast('L·ªói xo√°', true); }
    };

    $('#taskForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = $('#taskId').value;
        const data = {
            userId,
            title: $('#taskTitle').value,
            date: $('#taskDate').value,
            note: $('#taskNote').value,
            priority: $('#taskPriority').value,
            completed: false,
            notified: false // reset notification status
        };

        try {
            if(id) {
                delete data.userId;
                await updateDoc(doc(db, "tasks", id), data);
                showToast('ƒê√£ c·∫≠p nh·∫≠t!');
            } else {
                await addDoc(tasksCol, data);
                showToast('ƒê√£ th√™m m·ªõi!');
            }
            window.closeModal();
        } catch(err) { showToast('L·ªói l∆∞u d·ªØ li·ªáu', true); }
    };

    // --- NOTIFICATION SYSTEM (ENHANCED) ---
    function setupNotifications() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }
        
        $('#notifToggle').onclick = () => {
            Notification.requestPermission().then(p => {
                if(p === 'granted') showToast('ƒê√£ b·∫≠t th√¥ng b√°o');
                else showToast('Vui l√≤ng c·∫•p quy·ªÅn trong c√†i ƒë·∫∑t', true);
            });
        };

        // Check loop
        setInterval(() => {
            const now = new Date();
            const nowStr = now.toISOString().slice(0,16);

            tasks.forEach(t => {
                // If time matches AND not completed AND not yet notified
                if (t.date === nowStr && !t.completed && !t.notified) {
                    triggerNotification(t);
                    // Update Local State immediately to prevent double fire
                    t.notified = true; 
                    // Update Remote (optional, but good practice)
                    // updateDoc(doc(db, "tasks", t.id), { notified: true });
                }
            });
        }, 30000); // Check every 30s
    }

    function triggerNotification(task) {
        const title = `üîî ƒê·∫øn gi·ªù: ${task.title}`;
        const options = {
            body: task.note || "ƒê√£ ƒë·∫øn gi·ªù th·ª±c hi·ªán c√¥ng vi·ªác c·ªßa b·∫°n!",
            icon: "https://cdn-icons-png.flaticon.com/512/2693/2693507.png",
            badge: "https://cdn-icons-png.flaticon.com/512/2693/2693507.png",
            vibrate: [200, 100, 200, 100, 200], // Mobile vibration pattern
            tag: 'task-' + task.id, // Prevent duplicate stacking
            renotify: true, // Buzz again even if tag exists
            requireInteraction: true, // Keep on screen until user clicks
            actions: [
                {action: 'close', title: 'ƒê√≥ng'},
                {action: 'view', title: 'Xem'}
            ]
        };

        // Use Service Worker if available (Better for Android/Lock Screen)
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification(title, options);
            });
        } else {
            // Fallback
            new Notification(title, options);
        }
        
        // Also play sound if desired (Optional)
        // const audio = new Audio('notification.mp3'); audio.play();
    }

    // --- THEME & PWA ---
    const savedTheme = localStorage.getItem('tm_theme');
    if(savedTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
        $('#themeToggle i').className = 'fa-solid fa-sun';
    }

    $('#themeToggle').onclick = () => {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        localStorage.setItem('tm_theme', isDark ? 'light' : 'dark');
        $('#themeToggle i').className = isDark ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
    };

    // Install Logic
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        $('#pwaBanner').style.display = 'flex';
        $('#btnInstall').style.display = 'flex';
    });

    window.installApp = async () => {
        if(deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if(outcome === 'accepted') $('#pwaBanner').style.display = 'none';
            deferredPrompt = null;
        }
    };

    init();
</script>

<!-- DYNAMIC MANIFEST & SERVICE WORKER -->
<script>
    // 1. Manifest (Blob)
    const manifest = {
        name: "TaskMaster Pro",
        short_name: "TaskMaster",
        start_url: ".",
        display: "standalone",
        background_color: "#F4F6F8",
        theme_color: "#4A90E2",
        description: "Qu·∫£n l√Ω c√¥ng vi·ªác chuy√™n nghi·ªáp",
        icons: [
            {
                src: "https://cdn-icons-png.flaticon.com/512/2693/2693507.png",
                sizes: "192x192",
                type: "image/png",
                purpose: "any maskable"
            },
            {
                src: "https://cdn-icons-png.flaticon.com/512/2693/2693507.png",
                sizes: "512x512",
                type: "image/png",
                purpose: "any maskable"
            }
        ]
    };
    const manifestUrl = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
    document.head.insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`);

    // 2. Service Worker (Blob)
    if ('serviceWorker' in navigator) {
        const swCode = `
            self.addEventListener('install', e => self.skipWaiting());
            self.addEventListener('activate', e => self.clients.claim());
            
            self.addEventListener('fetch', e => {
                // Cache-first strategy for static assets could go here
                // For this single-file demo, we just pass through
            });

            self.addEventListener('notificationclick', function(event) {
                event.notification.close();
                event.waitUntil(
                    clients.matchAll({type: 'window'}).then( windowClients => {
                        // If window is open, focus it
                        for (var i = 0; i < windowClients.length; i++) {
                            var client = windowClients[i];
                            if (client.url === '/' && 'focus' in client) {
                                return client.focus();
                            }
                        }
                        // If not open, open it
                        if (clients.openWindow) {
                            return clients.openWindow('.');
                        }
                    })
                );
            });
        `;
        const swUrl = URL.createObjectURL(new Blob([swCode], {type: 'application/javascript'}));
        navigator.serviceWorker.register(swUrl)
            .then(reg => console.log('SW Ready'))
            .catch(err => console.log('SW Error', err));
    }
</script>
</body>
</html>
