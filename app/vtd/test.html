
<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu app - Vĩnh Trạch Đông</title>
    <link rel="icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    
    <!-- SEO & PWA Meta Tags -->
    <meta name="description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <link rel="icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    <link rel="apple-touch-icon" href="https://hdd.io.vn/img/bmassloadings.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hub Vĩnh Trạch Đông">
    <link rel="manifest" href="/js/applinkicon.jsonn">
    <meta name="theme-color" content="#4f46e5">

    <!-- Social Media Meta -->
    <meta property="og:title" content="Hub Portal - Vĩnh Trạch Đông">
    <meta property="og:description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <meta property="og:image" content="https://bmass.vercel.app/img/bmasslogo.png">
    <meta property="og:type" content="website">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Excel Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4f46e5', secondary: '#f43f5e', dark: '#020617' } } }
        }
    </script>
    <style>
        /* ADDED: Styles for Sidebar */
        .admin-sidebar { 
            width: 0; 
            transition: width 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .admin-sidebar.open {
            width: 28rem; /* Equivalent to max-w-xl in Tailwind, adjust as needed */
            min-width: 320px; /* Ensures a minimum size on small screens */
        }
        @media (max-width: 768px) {
            .admin-sidebar.open { width: 100%; }
        }
        
        /* NEW: Mobile Category Sidebar */
        .mobile-category-sidebar { 
            width: 0; 
            transition: width 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .mobile-category-sidebar.open {
            width: 75%;
            max-width: 300px;
        }
        /* END ADDED */
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; padding-bottom: 100px; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .app-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drag-ghost { opacity: 0.3; background: #4f46e5 !important; border-radius: 1rem; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .dark .tab-active { color: #818cf8; border-bottom: 2px solid #818cf8; }
        .app-item.selected-for-delete { box-shadow: 0 0 0 3px #f43f5e; border-radius: 1rem; }
        
        /* FIX: Header and Announcement Bar Position */
        header { 
            top: 0;
            transition: top 0.3s; /* Smooth transition for header position */
        }
        #announcement-bar:not(.hidden) ~ header { 
            top: 32px; 
        }
        
        /* Custom Marquee */
        .marquee { overflow: hidden; white-space: nowrap; box-sizing: border-box; }
        .marquee > div { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        
        /* Custom Logo Loader - Zoom In/Out */
        .logo-loader {
            width: 24px;
            height: 24px;
            animation: zoom-logo 1.5s ease-in-out infinite; /* Thay đổi animation */
        }

        @keyframes zoom-logo {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2); /* Phóng to */
            }
            100% {
                transform: scale(1); /* Thu nhỏ lại */
            }
        }
        
        /* NEW: Mobile Footer Height & Padding Correction */
        @media (max-width: 768px) {
            body { padding-bottom: 80px; } /* Footer height approx 60px + padding */
            #main-content-wrapper { padding-bottom: 10px; } /* Reduce padding at the bottom of main content */
            #category-bar { display: none !important; } /* Hide desktop category bar on mobile */
            header { padding-right: 0; } /* Remove right padding on mobile */
            /* Removed .mobile-hidden { display: none !important; } from here to allow view toggles */
        }
        
        /* NEW: Mobile-like Toast Styling & Transitions */
        #toast {
            bottom: 20px;
            right: 50%;
            left: 50%;
            transform: translate(-50%, 100%); /* Start position: bottom center, off-screen */
            opacity: 0;
            transition: all 0.4s ease-out; /* Smooth transition */
            max-width: 90%;
            width: auto;
            min-width: 250px;
            pointer-events: none; /* Allows clicks through when hidden */
        }
        
        #toast.visible {
            transform: translate(-50%, 0); /* End position: bottom center, on-screen */
            opacity: 1;
            pointer-events: auto; /* Enables interaction when visible */
        }
    </style>
</head>
<body class="min-h-screen pb-24">
    
    <!-- NEW: Global Loading Overlay -->
    <div id="global-loading-overlay" class="fixed inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm z-[900] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
        <img src="https://hdd.io.vn/img/bmassloadings.png" class="logo-loader w-12 h-12" alt="Loading Logo">
    </div>
    
    <!-- NEW: Maintenance Mode Overlay -->
    <div id="maintenance-overlay" class="fixed inset-0 bg-white dark:bg-slate-900 z-[500] flex flex-col items-center justify-center p-8 text-center hidden">
        <i data-lucide="wrench" class="w-16 h-16 text-primary mb-4"></i>
        <h2 class="text-3xl font-black text-primary dark:text-white mb-2">CHẾ ĐỘ BẢO TRÌ</h2>
        <p class="text-slate-500 dark:text-slate-400 max-w-md">
            Hệ thống đang được bảo trì và nâng cấp. Khách truy cập tạm thời không thể xem nội dung. Vui lòng quay lại sau.
        </p>
        <p id="maintenance-admin-info" class="text-sm font-bold mt-4 text-red-500 hidden">(Admin đang thao tác. Dữ liệu vẫn được truy cập qua chế độ quản trị.)</p>
    </div>
    
    <!-- NEW: Announcement Bar (Fixed to top) -->
    <div id="announcement-bar" class="fixed top-0 left-0 w-full z-[101] bg-secondary text-white text-xs font-bold py-2 shadow-md hidden">
        <div class="marquee">
            <div id="announcement-text"></div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="sticky top-0 z-[100] glass px-6 py-3 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <!-- NEW: Mobile Category Toggle (Only visible on mobile) -->
            <button onclick="window.toggleMobileCategorySidebar()" id="mobile-category-toggle" class="p-2 rounded-xl text-slate-600 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 transition md:hidden"><i data-lucide="menu" class="w-5 h-5"></i></button>

            <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg p-1">
                <img src="https://hdd.io.vn/img/bmassloadings.png" alt="Hub Logo" class="w-full h-full object-contain rounded-lg">
            </div>
            <div>
                <h1 class="text-xs font-black tracking-tighter uppercase leading-none">Hub Portal</h1>
                <span id="role-status" class="text-[9px] font-bold text-slate-400">GUEST</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Nút Mở Sidebar Admin (NEW) -->
            <button onclick="window.toggleAdminSidebar()" id="admin-sidebar-toggle" class="p-2 rounded-xl text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition hidden"><i data-lucide="settings-2" class="w-5 h-5"></i></button>

            <!-- View Mode Toggles (Now visible on mobile) -->
            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                <button onclick="window.setView('grid')" id="view-grid-btn" class="p-1.5 rounded-md transition-all shadow-sm bg-white dark:bg-slate-700"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                <button onclick="window.setView('list')" id="view-list-btn" class="p-1.5 rounded-md transition-all"><i data-lucide="list" class="w-4 h-4"></i></button>
            </div>
            
            <!-- Desktop Theme Toggle -->
            <button onclick="window.toggleTheme()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition mobile-hidden">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden text-slate-600"></i>
            </button>
            
            <div id="auth-section">
                <!-- Auth UI rendered by JS -->
            </div>
        </div>
    </header>

    <!-- NEW: Mobile Category Sidebar (Slide-in from left) -->
    <div id="mobile-category-sidebar" class="mobile-category-sidebar fixed top-0 left-0 bottom-0 bg-white dark:bg-slate-900 border-r dark:border-white/10 shadow-2xl z-[200] flex flex-col pt-0 md:hidden">
        <!-- Sidebar Header (Updated) -->
        <div class="p-6 border-b dark:border-white/5 flex flex-col items-start justify-between">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-8 h-8 flex items-center justify-center p-0.5">
                    <img src="https://hdd.io.vn/img/bmassloadings.png" alt="Hub Logo" class="w-full h-full object-contain rounded-lg">
                </div>
                <h3 class="text-sm font-black tracking-tighter uppercase leading-none">Hub Portal</h3>
            </div>
            <div class="flex items-center justify-between w-full">
                <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">DANH MỤC</h3>
                <button onclick="window.toggleMobileCategorySidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
        <!-- Sidebar Content -->
        <div id="category-bar-mobile" class="flex-1 overflow-y-auto p-6 space-y-2">
            <!-- Categories will be rendered here -->
        </div>
    </div>

    <!-- Main Content and Admin Sidebar Wrapper -->
    <div id="main-content-wrapper" class="flex max-w-7xl mx-auto">
        <!-- Main Content -->
        <main class="flex-1 p-6 space-y-8 min-w-0">
            <!-- Search -->
            <div id="search-container" class="relative max-w-2xl mx-auto">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="search-input" placeholder="Tìm ứng dụng hoặc danh bạ..." 
                    class="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-2xl focus:ring-4 ring-primary/10 outline-none shadow-sm">
            </div>

            <!-- Visit Stats Container -->
            <div id="visit-stats-container" class="max-w-4xl mx-auto p-4 rounded-3xl bg-slate-100 dark:bg-slate-900/50">
                <div class="flex items-center justify-center h-20 text-slate-400">Đang tải thống kê...</div>
            </div>

            <!-- Admin Request Form (NEW) -->
            <div id="request-admin-section" class="max-w-4xl mx-auto hidden p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-3xl border border-yellow-200 dark:border-yellow-700 space-y-4">
                <h3 class="text-xl font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="key" class="w-6 h-6"></i> Xin Cấp Quyền Quản Trị</h3>
                <p id="request-admin-status" class="text-sm font-medium text-yellow-700 dark:text-yellow-300">
                    Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu để Admin chính duyệt.
                </p>
                <form id="request-admin-form" class="flex gap-4">
                    <input type="text" id="request-admin-reason" placeholder="Lý do xin cấp quyền..." required class="flex-1 px-5 py-3 bg-white dark:bg-slate-800 rounded-xl outline-none focus:ring-2 ring-yellow-500 text-sm">
                    <button type="submit" class="bg-yellow-500 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-yellow-600 transition">GỬI YÊU CẦU</button>
                </form>
            </div>
            
            <!-- Categories (Desktop Only) -->
            <div id="category-bar" class="mobile-hidden flex flex-wrap gap-2"></div>
            
            <!-- Main Content Tabs -->
            <div id="main-tabs-content">
                <!-- Tab: App (Home) / Danh bạ (Contacts) Content -->
                <div id="tab-app-content">
                    <!-- App Loading State (UPDATED: Logo Loading) -->
                    <div id="app-loading" class="text-center p-16 text-slate-400 text-sm font-medium hidden">
                        <img src="/img/bmassloadings.png" class="logo-loader w-6 h-6 mx-auto mb-2" alt="Loading Logo">
                        Đang tải ứng dụng...
                    </div>

                    <!-- Main Content App -->
                    <div id="app-container"></div>
                </div>

                <!-- Tab: Notification Content (NEW) -->
                <div id="tab-notify-content" class="hidden max-w-4xl mx-auto">
                    <h3 class="text-xl font-black text-primary dark:text-white mb-6 border-b pb-2 px-2">THÔNG BÁO MỚI</h3>
                    <div id="notification-content-list" class="space-y-4">
                        <div class="p-16 text-center">
                            <i data-lucide="bell" class="w-12 h-12 text-primary mx-auto mb-4"></i>
                            <p class="text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                                Đang tải các thông báo...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Discover Content -->
                <div id="tab-discover-content" class="hidden max-w-4xl mx-auto">
                    <h3 class="text-xl font-black text-primary dark:text-white mb-6 border-b pb-2 px-2">KHÁM PHÁ</h3>
                    <div id="discover-content-list" class="space-y-4">
                        <div class="p-16 text-center">
                            <i data-lucide="compass" class="w-12 h-12 text-primary mx-auto mb-4"></i>
                            <p class="text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                                Đang tải các tiện ích khám phá...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Profile Content (Mobile Only View) -->
                <div id="tab-profile-content" class="hidden max-w-lg mx-auto p-4">
                    <h3 class="mobile-hidden text-xl font-black text-primary dark:text-white mb-6 border-b pb-2">THÔNG TIN CÁ NHÂN</h3>
                    <div id="profile-content-details" class="space-y-4">
                        <p class="text-slate-500 dark:text-slate-400">Vui lòng đăng nhập để xem thông tin cá nhân.</p>
                        <!-- Populated by JS on load/login -->
                    </div>
                    
                    <div id="profile-action-panel" class="space-y-4 mt-8">
                         <!-- Admin Panel Button (Conditionally Rendered) -->
                        <button id="profile-admin-panel-btn" onclick="window.toggleAdminSidebar()" class="hidden w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs flex items-center justify-center gap-2 hover:bg-indigo-600 transition">
                            <i data-lucide="settings" class="w-4 h-4"></i> ADMIN PANEL
                        </button>
                        
                        <div class="grid grid-cols-2 gap-4">
                             <a href="#" onclick="window.showToast('Bảo mật 2 yếu tố sắp ra mắt!', false)" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="shield-check" class="w-5 h-5 text-primary"></i>
                                <span class="text-xs font-bold">Tài khoản & Bảo mật (2FA Sắp ra mắt)</span>
                            </a>
                             <a href="#" target="_blank" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="lock" class="w-5 h-5 text-primary"></i>
                                <span class="text-xs font-bold">Quyền riêng tư</span>
                            </a>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Theme Toggle (Now with dynamic icon) -->
                            <button onclick="window.toggleTheme()" id="profile-theme-toggle" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="${document.documentElement.classList.contains('dark') ? 'sun' : 'moon'}" class="w-5 h-5 text-primary"></i>
                                <span class="text-xs font-bold">Chế độ Sáng/Tối</span>
                            </button>
                            <!-- Language Toggle -->
                            <button onclick="window.setLang(currentLang === 'vi' ? 'en' : 'vi')" id="profile-lang-toggle" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="globe" class="w-5 h-5 text-primary"></i>
                                <span id="current-lang-text" class="text-xs font-bold">Ngôn ngữ: VI</span>
                            </button>
                            <!-- Notification Permission Toggle (NEW) -->
                            <button onclick="window.requestNotificationPermission()" id="profile-notification-toggle" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="bell-ring" class="w-5 h-5 text-primary"></i>
                                <span class="text-xs font-bold">Bật Thông báo Trình duyệt</span>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <a href="#" onclick="window.logoutConfirm()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold text-xs uppercase shadow-lg hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-4 h-4"></i> ĐĂNG XUẤT
                            </a>
                            <a href="chat.html" target="_blank" class="w-full py-3 bg-secondary text-white rounded-xl font-bold text-xs uppercase shadow-lg hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i data-lucide="life-buoy" class="w-4 h-4"></i> TRỢ GIÚP & HỖ TRỢ
                            </a>
                        </div>
                    </div>

                </div>

            </div>
            
            <!-- Bulk Delete Floating Dock -->
            <div id="bulk-delete-dock" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 z-[110]">
                <div class="bg-red-600 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-4">
                    <span id="selected-count">0</span> mục đã chọn
                    <button onclick="window.executeBulkDelete()" class="flex items-center gap-2 px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold shadow-lg uppercase">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> CHUYỂN VÀO THÙNG RÁC
                    </button>
                </div>
            </div>
        </main>

        <!-- Admin Sidebar (NEW) -->
        <div id="admin-sidebar" class="admin-sidebar fixed right-0 top-0 bottom-0 bg-white dark:bg-slate-900 border-l dark:border-white/10 shadow-2xl z-[150] flex flex-col pt-16">
            <!-- Sidebar Header / Controls -->
            <div id="sidebar-controls" class="p-6 border-b dark:border-white/5 flex flex-col gap-3">
                 <div class="flex items-center justify-between">
                    <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">QUẢN TRỊ VIÊN</h3>
                    <button onclick="window.toggleAdminSidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
                 <div class="flex items-center gap-3">
                    <button onclick="window.openAppModal()" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary text-white rounded-xl text-xs font-bold shadow-lg">
                        <i data-lucide="plus" class="w-4 h-4"></i> THÊM ỨNG DỤNG
                    </button>
                    <button onclick="window.toggleBulkDelete()" id="bulk-delete-sidebar-toggle" class="p-3 rounded-xl text-red-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition flex items-center justify-center"><i data-lucide="scissors" class="w-5 h-5"></i></button>
                 </div>
            </div>

            <!-- Sidebar Tabs -->
            <div class="p-6 border-b dark:border-white/5">
                <div class="flex flex-wrap gap-2 text-[10px] font-black tracking-widest text-slate-400">
                    <button onclick="window.switchTab('tab-cat')" id="btn-tab-cat" class="text-primary border-b-2 border-primary pb-1">DANH MỤC</button>
                    <button onclick="window.switchTab('tab-trash')" id="btn-tab-trash" class="pb-1 uppercase">THÙNG RÁC</button>
                    <button onclick="window.switchTab('tab-announcement')" id="btn-tab-announcement" class="pb-1 uppercase">THÔNG BÁO</button>
                    <button onclick="window.switchTab('tab-deputy')" id="btn-tab-deputy" class="pb-1 uppercase">PHÓ ADMIN</button>
                    <button onclick="window.switchTab('tab-request')" id="btn-tab-request" class="pb-1 uppercase flex items-center gap-1">YÊU CẦU ADM <span id="request-count" class="text-red-500">(0)</span></button>
                    <button onclick="window.switchTab('tab-logs')" id="btn-tab-logs" class="pb-1 uppercase">NHẬT KÝ</button>
                    <button onclick="window.switchTab('tab-data')" id="btn-tab-data" class="pb-1 uppercase">DỮ LIỆU</button>
                </div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <!-- Tab Categories -->
                <div id="tab-cat" class="space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Quản lý Danh mục</h4>
                    <div class="flex flex-col gap-2">
                        <input type="text" id="new-cat-name" placeholder="Tên danh mục..." class="px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                        <div class="flex gap-2">
                             <input type="text" id="new-cat-icon" placeholder="Link Icon..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                             <button onclick="window.addCategory()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">Thêm</button>
                        </div>
                    </div>
                    <ul id="cat-list-admin" class="space-y-2"></ul>
                </div>
                
                <!-- Tab Soft Delete (NEW) -->
                <div id="tab-trash" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Thùng rác (Ứng dụng đã xóa)</h4>
                    <div id="trash-list" class="space-y-2">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Thùng rác trống.</div>
                    </div>
                    <button onclick="window.clearTrashConfirm(true)" id="clear-trash-btn" class="w-full py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg uppercase text-xs hidden">DỌN SẠCH VĨNH VIỄN</button>
                </div>
                <!-- End Tab Soft Delete -->
                
                <!-- Tab Announcement & Notification Feed Creator (UPDATED) -->
                <div id="tab-announcement" class="hidden space-y-8">
                    
                    <h4 class="text-sm font-black uppercase tracking-widest text-primary border-b pb-2">Thông báo Chạy chữ (Marquee)</h4>
                    <textarea id="announcement-content" placeholder="Nội dung thông báo (ngắn gọn, lặp lại)" rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                    
                    <!-- NEW: Schedule Inputs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Bắt đầu từ</label>
                            <input type="datetime-local" id="announcement-start" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Kết thúc vào</label>
                            <input type="datetime-local" id="announcement-end" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium">
                        </div>
                    </div>
                    <!-- End NEW -->
                    
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5">
                        <label class="text-sm font-bold opacity-60">Kích hoạt Thông báo Chạy chữ</label>
                        <div class="flex gap-2">
                           <button onclick="window.saveAnnouncementContent(true)" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all bg-primary text-white hover:bg-indigo-600">LƯU & BẬT</button>
                           <button id="toggle-announcement-btn" onclick="window.toggleAnnouncementStatus()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all">Tắt / Bật</button>
                        </div>
                    </div>
                    
                    <!-- New Section: Notification Feed Creator -->
                    <div class="space-y-4 pt-6 border-t dark:border-white/5">
                        <h4 class="text-sm font-black uppercase tracking-widest text-secondary border-b pb-2">Tạo Thông Báo Mới (Notification Feed)</h4>
                        <input type="text" id="notify-title" placeholder="Tiêu đề thông báo..." class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-bold">
                        <textarea id="notify-content" placeholder="Nội dung chi tiết..." rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                        <input type="text" id="notify-icon" placeholder="Icon URL (Để trống để dùng Icon mặc định)" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium">
                        <button onclick="window.publishNotification()" class="w-full py-4 bg-secondary text-white rounded-xl font-bold shadow-lg uppercase text-xs hover:bg-red-600 transition">ĐĂNG THÔNG BÁO</button>
                    </div>

                    <!-- New Section: List/Manage Notifications -->
                    <div class="space-y-4 pt-6 border-t dark:border-white/5">
                        <h4 class="text-sm font-black uppercase tracking-widest text-slate-500 border-b pb-2">Danh sách Thông báo đã đăng</h4>
                        <div id="admin-notify-list" class="space-y-2">
                             <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Đang tải danh sách...</div>
                        </div>
                    </div>
                    <!-- End List/Manage Notifications -->

                </div>
                <!-- End Tab Announcement -->

                <!-- Tab Deputy -->
                <div id="tab-deputy" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Cấp/Thu hồi quyền Phó Admin</h4>
                    <div id="deputy-guard" class="hidden p-4 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-xl text-xs font-bold uppercase">Chỉ Super Admin mới quản lý được mục này.</div>
                    <div id="deputy-ui" class="space-y-4">
                        <div class="flex gap-2">
                            <input type="email" id="new-deputy-email" placeholder="Gmail phó admin..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                            <button onclick="window.addDeputy()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">CẤP QUYỀN</button>
                        </div>
                        <div id="deputy-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tab Admin Requests (NEW) -->
                <div id="tab-request" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Yêu Cầu Cấp Quyền</h4>
                    <div id="requests-list" class="space-y-2">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Không có yêu cầu mới.</div>
                    </div>
                </div>
                <!-- End Tab Admin Requests -->

                <!-- Tab Activity Logs (NEW) -->
                <div id="tab-logs" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Nhật ký Hoạt động</h4>
                    <div id="logs-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Đang tải nhật ký...</div>
                    </div>
                </div>
                <!-- End Tab Activity Logs -->


                <!-- Tab Data Export/Import -->
                <div id="tab-data" class="hidden space-y-8">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Xuất/Nhập Dữ Liệu & Bảo Trì</h4>
                    <div class="grid gap-6">
                        
                        <!-- Maintenance Mode Toggle (NEW) -->
                        <div class="p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-[2rem] border border-yellow-200 dark:border-yellow-700 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-yellow-700 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="shield-alert" class="w-4 h-4"></i> CHẾ ĐỘ BẢO TRÌ</h4>
                            <p class="text-sm text-yellow-800 dark:text-yellow-300">
                                Bật chế độ này để ẩn toàn bộ nội dung với Khách (Guest). Chỉ Admin mới có thể truy cập.
                            </p>
                            <div class="flex items-center justify-between">
                                <span id="maintenance-status" class="text-sm font-bold">Trạng thái: Tắt</span>
                                <button onclick="window.toggleMaintenanceMode()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all bg-slate-500 text-white" id="maintenance-toggle-btn">BẬT CHẾ ĐỘ</button>
                            </div>
                        </div>

                        <!-- Export -->
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-primary">Xuất dữ liệu</h4>
                            <div class="flex flex-col gap-2">
                                <button onclick="window.handleExport('json')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm">
                                    <span class="text-sm font-bold">Xuất file JSON</span>
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.handleExport('excel')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm">
                                    <span class="text-sm font-bold">Xuất file EXCEL</span>
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Import -->
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-secondary">Nhập dữ liệu</h4>
                            <div class="relative">
                                <input type="file" id="import-file" accept=".json, .xlsx" onchange="window.handleImport(event)" class="hidden">
                                <label for="import-file" class="flex items-center justify-center gap-3 w-full px-5 py-4 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-xl cursor-pointer hover:opacity-90 transition font-bold text-xs uppercase">
                                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                                    Chọn file để khôi phục
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer (Desktop Only) - REMOVED -->
    

    <!-- NEW: Mobile Tab Bar (Fixed Bottom Navigation) (UPDATED) -->
    <nav id="mobile-nav-bar" class="fixed bottom-0 left-0 w-full z-100 bg-white dark:bg-slate-900 border-t dark:border-white/10 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] md:hidden">
        <div class="flex justify-around items-center h-16">
            <button onclick="window.switchMobileTab('app')" id="tab-app-btn" class="flex flex-col items-center justify-center w-full h-full text-primary">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span class="text-[9px] font-bold mt-1">Ứng Dụng</span>
            </button>
            <button onclick="window.switchMobileTab('contact')" id="tab-contact-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="text-[9px] font-bold mt-1">Danh Bạ</span>
            </button>
            <!-- UPDATED: Replaced Discover with Notify (Bell) -->
            <button onclick="window.switchMobileTab('notify')" id="tab-notify-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <div class="relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <!-- NEW: Unread Count Badge (FIXED position) -->
                    <span id="unread-count" class="absolute -top-1 -right-1 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-[8px] font-black px-1.5 rounded-full hidden">0</span>
                </div>
                <span class="text-[9px] font-bold mt-1">Thông Báo</span>
            </button>
            <button onclick="window.switchMobileTab('profile')" id="tab-profile-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <i data-lucide="user-circle" class="w-5 h-5"></i>
                <span class="text-[9px] font-bold mt-1">Cá Nhân</span>
            </button>
        </div>
    </nav>
    <!-- End Mobile Tab Bar -->


    <!-- App Modal (No Changes) -->
    <div id="modal-app" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="app-modal-title" class="font-bold uppercase text-sm tracking-widest">Cấu hình</h3>
                <button onclick="window.closeModal('modal-app')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="app-form" class="p-8 space-y-4">
                <input type="hidden" id="edit-id">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh mục</label>
                    <select id="app-category" onchange="window.toggleFormFields()" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select>
                </div>
                <div class="space-y-1">
                    <label id="label-name" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tên hiển thị</label>
                    <input type="text" id="app-name" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div id="field-position" class="space-y-1 hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Chức vụ</label>
                    <input type="text" id="app-position" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label id="label-link" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Link URL</label>
                    <input type="text" id="app-link" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Icon URL</label>
                    <input type="text" id="app-icon" placeholder="Để trống để tự lấy" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="flex items-center gap-3 p-2">
                    <input type="checkbox" id="app-visible" checked class="w-5 h-5 accent-primary">
                    <label class="text-xs font-bold opacity-60">Hiển thị công khai</label>
                </div>
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 uppercase text-xs">Lưu ứng dụng</button>
            </form>
        </div>
    </div>

    <!-- User Profile Modal (No Changes) -->
    <div id="modal-user-profile" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">Thông tin Tài khoản</h3>
                <button onclick="window.closeModal('modal-user-profile')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="flex flex-col items-center">
                    <img id="profile-photo" class="w-20 h-20 rounded-full mb-3 border-4 border-primary/20 p-0.5 shadow-md" alt="Avatar">
                    <span id="profile-role" class="text-[10px] font-black uppercase tracking-widest px-3 py-1 bg-primary/10 text-primary rounded-full"></span>
                </div>

                <div class="space-y-4">
                    <!-- Editable Field Example (Name) -->
                    <div class="space-y-1 group relative">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tên hiển thị</label>
                        <input type="text" id="profile-name" readonly class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium border-none pr-10">
                        <button onclick="alert('Tính năng chỉnh sửa thông tin Google được chuyển qua mục Nâng cao.')" class="absolute right-3 top-1/2 mt-2 p-1 text-slate-400 hover:text-primary opacity-0 group-hover:opacity-100 transition"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    </div>

                    <!-- Non-Editable Fields -->
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Email</label>
                        <input type="email" id="profile-email" readonly class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl text-slate-500 dark:text-slate-400 text-sm font-medium border-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">UID Firebase</label>
                        <p id="profile-uid" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl text-xs font-mono truncate"></p>
                    </div>
                </div>

                <a href="https://myaccount.google.com/?utm_source=hub-portal-vtd" target="_blank" class="w-full py-3 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded-xl font-bold shadow-sm uppercase text-xs flex items-center justify-center gap-2 hover:bg-slate-300 transition">
                    <i data-lucide="external-link" class="w-4 h-4"></i> Nâng cao: Quản lý tài khoản Google
                </a>
            </div>
        </div>
    </div>
    
    <!-- Modal for Category Delete/Migrate (NEW) -->
    <div id="modal-cat-migrate" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-red-500">Chuyển đổi Ứng dụng trước khi Xóa</h3>
                <button onclick="window.closeModal('modal-cat-migrate')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-4">
                <p id="cat-migrate-message" class="text-sm text-slate-700 dark:text-slate-300">
                    Danh mục này có <span id="cat-migrate-count" class="font-bold">0</span> ứng dụng. Vui lòng chọn danh mục mới để chuyển các ứng dụng này đến trước khi xóa.
                </p>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh mục mới</label>
                    <select id="cat-migrate-select" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select>
                </div>
                <button onclick="window.executeCatDeleteAndMigrate()" class="w-full py-4 bg-red-500 text-white rounded-xl font-bold shadow-lg uppercase text-xs hover:bg-red-600 transition">XÁC NHẬN XÓA & CHUYỂN ĐỔI</button>
            </div>
        </div>
    </div>
    <!-- End Modal for Category Delete/Migrate -->

    <!-- Notification Toast (MODIFIED: Mobile style & interaction) -->
    <div id="toast" class="fixed z-[300]" onclick="window.closeToast()" ontouchstart="window.handleToastTouchStart(event)" ontouchmove="window.handleToastTouchMove(event)" ontouchend="window.handleToastTouchEnd(event)">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border dark:border-white/10">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg" class="text-sm font-bold tracking-tight">Thành công!</span>
        </div>
    </div>
    <!-- End Notification Toast -->
    


    <!-- Custom Confirmation Modal (NEW) -->
<div id="modal-confirm" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[220] hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-sm shadow-2xl overflow-hidden">
        <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
            <h3 id="confirm-modal-title" class="font-bold uppercase text-sm tracking-widest text-red-500">Xác nhận Thao tác</h3>
            <button onclick="window.closeModal('modal-confirm')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-8 space-y-6">
            <p id="confirm-modal-message" class="text-sm text-slate-700 dark:text-slate-300">Bạn có chắc chắn muốn thực hiện thao tác này?</p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closeModal('modal-confirm')" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 transition">Hủy</button>
                <button id="confirm-modal-btn" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-red-500 text-white shadow-lg hover:bg-red-600 transition">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Modal for Long Loading Timeout (NEW) -->
<div id="modal-long-load" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[950] hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-sm shadow-2xl overflow-hidden">
        <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
            <h3 class="font-bold uppercase text-sm tracking-widest text-secondary">Tải Trang Quá Lâu</h3>
            <button onclick="window.closeModal('modal-long-load')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-8 space-y-6 text-center">
            <i data-lucide="loader-2" class="w-12 h-12 text-secondary mx-auto animate-spin"></i>
            <p class="text-sm text-slate-700 dark:text-slate-300">Quá trình tải dữ liệu đã kéo dài hơn 30 giây. Vui lòng chọn hành động tiếp theo:</p>
            <div class="flex justify-center gap-3">
                <button onclick="window.forceReload()" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-primary text-white shadow-lg hover:bg-indigo-600 transition">TẢI LẠI TOÀN BỘ TRANG</button>
                <button onclick="window.closeModal('modal-long-load')" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 transition">ĐỢI TIẾP</button>
            </div>
        </div>
    </div>
</div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // MODIFIED: Added arrayRemove and getDocs (for notification cleanup)
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch, increment, runTransaction, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const LOGS_COLLECTION = "activityLogs"; 
        const NOTIFY_COLLECTION = "notifications"; 

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        let currentUser = null, isAdmin = false, isSuper = false, apps = [], categories = [], deputies = [], currentFilter = 'all', searchQuery = '', viewMode = 'grid', visitStats = {};
        let appsLoaded = false; 
        let bulkDeleteMode = false; 
        let selectedAppsForDelete = new Set(); 
        let currentAnnouncement = {}; 
        let adminRequests = []; 
        let globalSettings = {}; 
        let activityLogs = []; 
        let discoverApps = []; 
        let notifications = []; 
        let unreadCount = 0; 
        let confirmActionCallback = () => {}; 
        let currentMobileTab = 'app'; 
        let currentLang = 'vi'; 
        let toastTimeout = null; // NEW: Toast timer
        let toastTouchStartY = 0; // NEW: Toast swipe detection
        let catToDeleteId = null; // NEW: For category migrate logic
        let loadingTimeoutTimer = null; // NEW: Timer for long load
        let currentGlobalLoading = false; // NEW: Status for long load


        // --- GLOBAL LOADING EFFECT (MODIFIED for Timeout) ---
        window.showGlobalLoading = () => {
             currentGlobalLoading = true;
             document.getElementById('global-loading-overlay').classList.remove('opacity-0', 'pointer-events-none');
             
             // NEW: Start 30 second timer
             clearTimeout(loadingTimeoutTimer);
             loadingTimeoutTimer = setTimeout(() => {
                 if (currentGlobalLoading) {
                     window.openModal('modal-long-load');
                 }
             }, 30000); // 30 seconds
        };
        window.hideGlobalLoading = () => {
             currentGlobalLoading = false;
             clearTimeout(loadingTimeoutTimer);
             document.getElementById('modal-long-load')?.classList.add('hidden'); // Close modal if open
             document.getElementById('global-loading-overlay').classList.add('opacity-0', 'pointer-events-none');
        };
        
        window.forceReload = () => { location.reload(); };
        
        // --- LANGUAGE LOGIC ---
        window.setLang = (lang, initial = false) => {
             currentLang = lang;
             localStorage.setItem('language', lang);
             const langText = lang === 'vi' ? 'VI' : 'EN';
             
             document.getElementById('current-lang-text').innerText = `Ngôn ngữ: ${langText}`;
             
             // Update theme toggle icon dynamically for consistency
             const isDark = document.documentElement.classList.contains('dark');
             const themeIconElement = document.getElementById('profile-theme-toggle')?.querySelector('i');
             if(themeIconElement) {
                themeIconElement.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
             }
             
             if (!initial) {
                showToast(`Đã chuyển sang ngôn ngữ: ${langText}`);
                lucide.createIcons();
             }
        };


        // --- CUSTOM CONFIRMATION MODAL LOGIC (NEW) ---
        /**
         * Shows a custom confirmation modal.
         * @param {string} title The modal title.
         * @param {string} message The confirmation message.
         * @param {function} callback The function to execute if confirmed.
         * @param {string} confirmText Text for the confirm button.
         */
        window.showConfirm = (title, message, callback, confirmText = 'XÁC NHẬN') => {
            if (currentUser === null && title !== 'Xác nhận Đăng xuất') return; // Allow guest for logout confirm
            document.getElementById('confirm-modal-title').innerText = title;
            document.getElementById('confirm-modal-message').innerText = message;
            document.getElementById('confirm-modal-btn').innerText = confirmText;
            confirmActionCallback = callback; 
            document.getElementById('confirm-modal-btn').onclick = () => {
                window.closeModal('modal-confirm');
                confirmActionCallback(); 
            };
            window.openModal('modal-confirm');
        };
        
        // --- MAINTENANCE MODE FIX (Hide Main Content) ---
        function checkMaintenanceMode() {
            const maintenanceActive = globalSettings.maintenanceMode;
            const overlay = document.getElementById('maintenance-overlay');
            const adminInfo = document.getElementById('maintenance-admin-info');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const mobileNavBar = document.getElementById('mobile-nav-bar');

            if (maintenanceActive && !isAdmin) {
                overlay.classList.remove('hidden');
                mainContentWrapper.classList.add('hidden'); 
                if (mobileNavBar) mobileNavBar.classList.add('hidden'); 
            } else {
                overlay.classList.add('hidden');
                mainContentWrapper.classList.remove('hidden'); 
                if (window.innerWidth <= 768 && mobileNavBar) mobileNavBar.classList.remove('hidden'); 
            }
            adminInfo.classList.toggle('hidden', !maintenanceActive || !isAdmin);
        }

        function renderMaintenanceControls() {
            if (!isAdmin) return;
            const statusSpan = document.getElementById('maintenance-status');
            const toggleBtn = document.getElementById('maintenance-toggle-btn');
            
            if (globalSettings.maintenanceMode) {
                statusSpan.innerText = "Trạng thái: Bật";
                toggleBtn.innerText = "TẮT CHẾ ĐỘ";
                toggleBtn.classList.remove('bg-slate-500');
                toggleBtn.classList.add('bg-red-500');
            } else {
                statusSpan.innerText = "Trạng thái: Tắt";
                toggleBtn.innerText = "BẬT CHẾ ĐỘ";
                toggleBtn.classList.remove('bg-red-500');
                toggleBtn.classList.add('bg-slate-500');
            }
        }


        // --- AUTH & INITIAL ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const requestSection = document.getElementById('request-admin-section');
            const requestStatus = document.getElementById('request-admin-status');
            const requestForm = document.getElementById('request-admin-form');
            window.showGlobalLoading(); // Start loading effect

            try { 
                if (user) {
                    const snap = await getDoc(doc(db, "settings", "admins"));
                    const adminData = snap.data() || {};
                    const superUidFromDB = adminData.super_uid; 
                    
                    isSuper = user.uid === superUidFromDB; 
                    deputies = adminData.deputy_emails || []; 
                    
                    isAdmin = isSuper || deputies.includes(user.email);
                    
                    renderAuthUI();
                    renderProfileContent(); 
                    document.getElementById('profile-admin-panel-btn')?.classList.toggle('hidden', !isAdmin);

                    requestSection.classList.toggle('hidden', isAdmin);

                    if (!isAdmin) {
                        const reqSnap = await getDoc(doc(db, "adminRequests", user.uid));
                        if (reqSnap.exists()) {
                            requestStatus.innerText = "Yêu cầu của bạn đang chờ Admin chính duyệt.";
                            requestForm.classList.add('hidden');
                        } else {
                            requestStatus.innerText = "Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu để Admin chính duyệt.";
                            requestForm.classList.remove('hidden');
                        }
                    }
                    
                    if (isAdmin) {
                        document.getElementById('announcement-content').value = currentAnnouncement.content || '';
                    }

                } else {
                    isAdmin = isSuper = false;
                    renderAuthUI(); // render Login button
                    requestSection.classList.add('hidden'); 
                    document.getElementById('profile-admin-panel-btn')?.classList.add('hidden');
                    renderProfileContent(); 
                }
                document.getElementById('role-status').innerText = isSuper ? 'SUPER' : (isAdmin ? 'DEPUTY' : 'GUEST');
                document.getElementById('admin-sidebar-toggle').classList.toggle('hidden', !isAdmin); 
                
                checkMaintenanceMode(); 
                
                // Initialize view mode based on screen size (default to grid, but set list for smaller screens)
                if (window.innerWidth <= 768) { 
                    viewMode = 'list';
                    window.switchMobileTab('app', false);
                } else {
                    viewMode = 'grid';
                    window.switchMobileTab('app', true);
                }
                window.setView(viewMode); // Apply view mode settings initially
                window.setLang(localStorage.getItem('language') || 'vi', true);

            } catch (error) {
                 console.error("Lỗi trong quá trình khởi tạo Auth:", error);
                 showToast("Lỗi tải dữ liệu người dùng!", true);
            } finally {
                window.hideGlobalLoading(); // Always hide loading
            }
        });
        
        // NEW: Function to open the full profile view on desktop (Fixes Issue #2)
        window.openDesktopProfileView = () => {
            window.closeUserMenu(); // Close the dropdown menu
            // Use the existing mobile switch logic but force it to behave like a desktop switch
            window.switchMobileTab('profile', true); 
            // Force-hide search/stats when showing profile on desktop
            document.getElementById('search-container').classList.add('hidden');
            document.getElementById('visit-stats-container').classList.add('hidden');
            // Force-hide view toggles on desktop when showing profile
            document.getElementById('view-grid-btn')?.parentElement.classList.add('hidden');
        };
        
        // NEW: Auth UI Render Fix (For desktop login/user dropdown) (MODIFIED: To call openDesktopProfileView)
        function renderAuthUI() {
            if (!currentUser) {
                document.getElementById('auth-section').innerHTML = `<button onclick="window.login()" class="bg-primary text-white px-5 py-2 rounded-lg text-xs font-bold uppercase tracking-widest">Login</button>`;
                return;
            }

            document.getElementById('auth-section').innerHTML = `
                <div class="relative">
                    <button onclick="window.toggleUserMenu(event)" id="user-avatar-btn" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 pr-3 rounded-lg border dark:border-white/10">
                        <img src="${currentUser.photoURL}" class="w-7 h-7 rounded-md">
                        <i data-lucide="chevron-down" class="w-3 h-3 text-slate-400"></i>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="user-menu" class="absolute right-0 top-full mt-3 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-2xl z-20 hidden ring-1 ring-black/5 dark:ring-white/10 p-2 transform origin-top-right">
                        <div class="px-3 py-2 text-sm font-bold truncate">${currentUser.displayName}</div>
                        <div class="px-3 py-1 text-xs text-slate-500 truncate">${currentUser.email}</div>
                        <div class="h-px bg-slate-100 dark:bg-slate-700 my-2"></div>
                        <!-- MODIFIED: Call openDesktopProfileView for full profile content -->
                        <button onclick="window.openDesktopProfileView()" class="flex items-center w-full px-3 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
                            <i data-lucide="user-circle" class="w-4 h-4 mr-2"></i> Tài khoản
                        </button>
                        <button onclick="window.logoutConfirm()" class="flex items-center w-full px-3 py-2 text-sm font-medium text-red-500 rounded-lg hover:bg-red-50 dark:hover:bg-slate-700/50">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Đăng xuất
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        
        // NEW: Render Profile Content for Mobile Tab (and to ensure ProfileModal works)
        function renderProfileContent() {
            const profileDetails = document.getElementById('profile-content-details');
            const profilePanel = document.getElementById('profile-action-panel');
            const isAdminLoggedIn = isSuper || isAdmin;
            
            if (!currentUser) {
                profileDetails.innerHTML = `<p class="text-slate-500 dark:text-slate-400">Vui lòng đăng nhập để xem thông tin cá nhân.</p>`;
                profilePanel.classList.add('hidden');
                return;
            }
            
            profilePanel.classList.remove('hidden');

            const role = isSuper ? 'SUPER ADMIN' : (isAdmin ? 'PHÓ ADMIN' : 'KHÁCH (GUEST)');
            
            // Render Profile Details (Main section, used by Mobile Tab and Modal)
            profileDetails.innerHTML = `
                <div class="flex flex-col items-center p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border dark:border-white/5">
                    <img src="${currentUser.photoURL}" class="w-16 h-16 rounded-full mb-3 border-4 border-primary/20 p-0.5 shadow-md" alt="Avatar">
                    <span class="text-lg font-black">${currentUser.displayName || 'Người dùng'}</span>
                    <span class="text-xs font-black tracking-widest px-3 py-1 bg-primary/10 text-primary rounded-full mt-1">${role}</span>
                </div>
                <div class="space-y-2 p-4">
                    <div class="text-sm">Email: <span class="font-bold text-primary dark:text-white">${currentUser.email}</span></div>
                    <div class="text-sm">UID: <span class="text-xs font-mono text-slate-500 truncate">${currentUser.uid}</span></div>
                </div>
                <p id="profile-admin-status" class="text-xs font-bold text-red-500 px-4">${isAdminLoggedIn ? '' : 'Bạn chưa có quyền quản trị.'}</p>
            `;
            
            // Update Toggle Button for Notification Permission
            const perm = Notification.permission;
            const btn = document.getElementById('profile-notification-toggle');
            if (btn) {
                 const icon = btn.querySelector('i');
                 const span = btn.querySelector('span');
                 if (perm === 'granted') {
                    icon.setAttribute('data-lucide', 'bell-ring');
                    icon.classList.remove('text-red-500');
                    span.innerText = 'Thông báo Trình duyệt: BẬT';
                 } else if (perm === 'denied') {
                    icon.setAttribute('data-lucide', 'bell-off');
                    icon.classList.add('text-red-500');
                    span.innerText = 'Thông báo Trình duyệt: TẮT';
                 } else { // default
                    icon.setAttribute('data-lucide', 'bell-ring');
                    icon.classList.remove('text-red-500');
                    span.innerText = 'Bật Thông báo Trình duyệt';
                 }
            }

            // Update Admin Panel button visibility
            document.getElementById('profile-admin-panel-btn')?.classList.toggle('hidden', !isAdminLoggedIn);
            
            lucide.createIcons();
        }

        window.toggleUserMenu = (event) => {
            event.stopPropagation();
            const menu = document.getElementById('user-menu');
            menu?.classList.toggle('hidden');
            lucide.createIcons();
        };
        
        window.closeUserMenu = () => {
             document.getElementById('user-menu')?.classList.add('hidden');
        };

        document.addEventListener('click', (e) => {
             const menu = document.getElementById('user-menu');
             const btn = document.getElementById('user-avatar-btn');
             if (menu && !menu.contains(e.target) && btn && !btn.contains(e.target)) {
                 window.closeUserMenu();
             }
        });
        
        window.openUserProfileModal = () => {
            if (!currentUser) return;
            window.closeUserMenu(); 
            const role = isSuper ? 'SUPER ADMIN' : (isAdmin ? 'PHÓ ADMIN' : 'KHÁCH (GUEST)');
            
            // Populating data for Modal
            document.getElementById('profile-name').value = currentUser.displayName || 'Chưa đặt tên';
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-uid').innerText = currentUser.uid;
            document.getElementById('profile-role').innerText = role;
            document.getElementById('profile-photo').src = currentUser.photoURL;

            window.openModal('modal-user-profile');
            lucide.createIcons();
        };

        
        // NEW: Handle Admin Request Submission (Unchanged)
        document.getElementById('request-admin-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const reason = document.getElementById('request-admin-reason').value.trim();
            if (reason.length < 5) { showToast("Lý do phải dài hơn 5 ký tự!", true); return; }
            
            window.showGlobalLoading();
            try {
                await setDoc(doc(db, "adminRequests", currentUser.uid), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: currentUser.displayName,
                    reason: reason,
                    timestamp: new Date().toISOString()
                });
                document.getElementById('request-admin-status').innerText = "Yêu cầu của bạn đang chờ Admin chính duyệt.";
                document.getElementById('request-admin-form').classList.add('hidden');
                showToast("Đã gửi yêu cầu thành công!");
            } catch (e) {
                console.error("Error submitting request:", e);
                showToast("Lỗi khi gửi yêu cầu!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };

        window.login = () => { window.showGlobalLoading(); signInWithPopup(auth, provider).catch(() => window.hideGlobalLoading()); };
        
        window.logoutConfirm = () => {
             window.closeUserMenu(); // Close desktop dropdown if open
             window.showConfirm(
                'Xác nhận Đăng xuất',
                'Bạn có chắc chắn muốn đăng xuất khỏi tài khoản này?',
                () => window.logout(),
                'ĐĂNG XUẤT'
             );
        };
        
        window.logout = () => { window.showGlobalLoading(); signOut(auth).then(() => location.reload()).catch(() => window.hideGlobalLoading()); };

        // NEW: Sidebar Toggle (FIXED: Close Category Sidebar on Mobile)
        window.toggleAdminSidebar = () => {
             document.getElementById('admin-sidebar').classList.toggle('open');
             if(window.innerWidth <= 768) {
                document.getElementById('mobile-category-sidebar').classList.remove('open'); // FIX: Close mobile category sidebar when opening admin
             }
        };
        
        // NEW: Mobile Category Sidebar Toggle (FIXED: Close Admin Sidebar)
        window.toggleMobileCategorySidebar = () => {
             document.getElementById('mobile-category-sidebar').classList.toggle('open');
             document.getElementById('admin-sidebar')?.classList.remove('open'); // FIX: Close admin sidebar when opening mobile category
        };

        // --- MOBILE TAB NAVIGATION LOGIC (FIXED: Search and Sidebar issue) ---
        window.switchMobileTab = (tabId, isDesktop = false) => {
            currentMobileTab = tabId;
            const tabContents = ['tab-app-content', 'tab-notify-content', 'tab-discover-content', 'tab-profile-content'];
            const tabButtons = ['tab-app-btn', 'tab-contact-btn', 'tab-notify-btn', 'tab-profile-btn'];
            const viewToggles = document.getElementById('view-grid-btn')?.parentElement;
            
            window.showGlobalLoading(); 

            // 1. Reset Mobile Tab Buttons (chỉ trên mobile)
            if (!isDesktop || window.innerWidth <= 768) {
                 tabButtons.forEach(btnId => {
                     const btn = document.getElementById(btnId);
                     if (btn) {
                         btn.classList.remove('text-primary');
                         btn.classList.add('text-slate-400');
                     }
                 });
            }

            // Close mobile sidebars to avoid overlay conflict
            document.getElementById('mobile-category-sidebar')?.classList.remove('open');
            document.getElementById('admin-sidebar')?.classList.remove('open');
            
            // 2. Hide all content tabs first
            tabContents.forEach(id => document.getElementById(id).classList.add('hidden'));

            // 3. Logic to manage filter and content visibility
            if (tabId === 'app' || tabId === 'contact') {
                document.getElementById('tab-app-content').classList.remove('hidden');
                
                // Show search/stats for App/Contact tabs
                document.getElementById('search-container').classList.remove('hidden');
                document.getElementById('visit-stats-container').classList.remove('hidden');

                if (tabId === 'app') {
                    // FIX: Prevent re-setting filter/re-rendering if already on app/all
                    if (currentFilter === 'contact_filter') {
                       window.setFilter('all', isDesktop, false); // Only set filter, do not auto-close sidebar, do not force app/contact switch
                    }
                    if (!isDesktop || window.innerWidth <= 768) {
                        document.getElementById('tab-app-btn').classList.remove('text-slate-400');
                        document.getElementById('tab-app-btn').classList.add('text-primary');
                    }
                    if(viewToggles) viewToggles.classList.remove('hidden'); // Show view toggles on App tab

                } else if (tabId === 'contact') {
                    window.setFilter('contact_filter', isDesktop, false); 
                     if (!isDesktop || window.innerWidth <= 768) {
                        document.getElementById('tab-contact-btn').classList.remove('text-slate-400');
                        document.getElementById('tab-contact-btn').classList.add('text-primary');
                     }
                    if(viewToggles) viewToggles.classList.add('hidden'); // HIDE view toggles on Contact tab
                }

            } else {
                // Hide search/stats for other tabs
                document.getElementById('search-container').classList.add('hidden');
                document.getElementById('visit-stats-container').classList.add('hidden');
                if(viewToggles) viewToggles.classList.add('hidden');

                const contentId = tabId === 'notify' ? 'tab-notify-content' : `tab-${tabId}-content`;

                document.getElementById(contentId).classList.remove('hidden');
                
                // Only change mobile buttons on mobile, not for desktop profile view
                if (!isDesktop || window.innerWidth <= 768) {
                    document.getElementById(`tab-${tabId}-btn`).classList.remove('text-slate-400');
                    document.getElementById(`tab-${tabId}-btn`).classList.add('text-primary');
                }
                
                
                if (tabId === 'profile') {
                    renderProfileContent(); // Re-render profile content
                } else if (tabId === 'notify') {
                    renderNotifications(); 
                } else if (tabId === 'discover') {
                    renderDiscoverContent();
                }
            }
            
            // Desktop Mode Adjustments (Chắc chắn ẩn mobile nav bar trên desktop)
            if (window.innerWidth > 768) {
                 document.getElementById('mobile-nav-bar')?.classList.add('hidden');
            } else {
                 document.getElementById('mobile-nav-bar')?.classList.remove('hidden');
            }
            
            lucide.createIcons();
            window.hideGlobalLoading(); 
        };


        // --- DATA REALTIME ---
        onSnapshot(query(collection(db, "categories"), orderBy("order", "asc")), (snap) => {
            categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCategories();
            // Update Select list for Cat Migrate Modal
            const migrateSelect = document.getElementById('cat-migrate-select');
            migrateSelect.innerHTML = categories.filter(c => c.id !== catToDeleteId).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        });

        onSnapshot(query(collection(db, "apps"), orderBy("order", "asc")), (snap) => {
            apps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            appsLoaded = true; 
            renderApps();
            renderTrash(); 
        });
        
        onSnapshot(doc(db, "settings", "visits_stats"), (snap) => {
            visitStats = snap.data() || {};
            renderStats();
        });
        
        // Realtime listener for Announcement 
        onSnapshot(doc(db, "settings", "announcement"), (snap) => {
            currentAnnouncement = snap.data() || { content: '', active: false, startTime: null, endTime: null }; 
            renderAnnouncementBar();
            renderAnnouncementControls();
        });
        
        // Realtime listener for Admin Requests 
        onSnapshot(collection(db, "adminRequests"), (snap) => {
            adminRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAdminRequests();
        });
        
        // Realtime listener for global settings 
        onSnapshot(doc(db, "settings", "global"), (snap) => {
            globalSettings = snap.data() || { maintenanceMode: false };
            checkMaintenanceMode();
            renderMaintenanceControls();
        });

        // Realtime listener for Discover Apps
        onSnapshot(doc(db, "settings", "discover"), (snap) => {
            discoverApps = snap.data()?.apps || [];
            if (document.getElementById('tab-discover-content') && document.getElementById('tab-discover-content').classList.contains('hidden') === false) {
                 renderDiscoverContent();
            }
        });
        
        // NEW: Realtime listener for Activity Logs
        onSnapshot(query(collection(db, LOGS_COLLECTION), orderBy("timestamp", "desc"), limit(100)), (snap) => {
            activityLogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (document.getElementById('tab-logs') && document.getElementById('tab-logs').classList.contains('hidden') === false) {
                 renderActivityLogs();
            }
        });

        // NEW: Realtime listener for Notifications (UPDATED: Added Admin List Render)
        onSnapshot(query(collection(db, NOTIFY_COLLECTION), orderBy("timestamp", "desc")), (snap) => {
            notifications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (document.getElementById('tab-notify-content') && document.getElementById('tab-notify-content').classList.contains('hidden') === false) {
                 renderNotifications();
            }
            if (document.getElementById('tab-announcement') && document.getElementById('tab-announcement').classList.contains('hidden') === false) {
                 renderAdminNotificationList(); // NEW: Render admin list when data changes
            }
            updateUnreadCount();
        });

        // NEW: Render Discover Content (Unchanged)
        function renderDiscoverContent() {
            const list = document.getElementById('discover-content-list');
            
            if (discoverApps.length === 0) {
                 list.innerHTML = `<div class="p-16 text-center">
                    <i data-lucide="compass" class="w-12 h-12 text-primary mx-auto mb-4"></i>
                    <p class="text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                        Chưa có tiện ích khám phá nào được thiết lập.
                    </p>
                    ${isAdmin ? `<p class="text-xs font-bold mt-4">Admin: Thêm mục tại settings/discover trong Firestore.</p>` : ''}
                 </div>`;
                 lucide.createIcons();
                 return;
            }

            list.innerHTML = discoverApps.map(app => `
                <a href="${app.url}" target="_blank" class="flex items-center gap-4 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5 group hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                    <img src="${app.iconUrl || 'https://hdd.io.vn/img/bmassloadings.png'}" class="w-10 h-10 rounded-lg object-contain">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-base font-bold truncate">${app.name}</h4>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${app.description || 'Tiện ích khám phá'}</p>
                    </div>
                    <i data-lucide="external-link" class="w-5 h-5 text-primary"></i>
                </a>
            `).join('');
            lucide.createIcons();
        }

        // --- NEW: NOTIFICATION FEED LOGIC ---
        
        // --- BROWSER NOTIFICATION LOGIC (NEW) ---
        async function requestNotificationPermission() {
            if (!("Notification" in window)) { 
                showToast("Trình duyệt không hỗ trợ thông báo!", true);
                return; 
            }
            window.showGlobalLoading();
            if (Notification.permission === "denied") {
                showToast("Vui lòng BẬT quyền thông báo trong cài đặt trình duyệt!", true);
                window.hideGlobalLoading();
                return;
            }
            
            if (Notification.permission === "granted") {
                 showToast("Thông báo đã được bật trước đó rồi.");
                 window.hideGlobalLoading();
                 return;
            }

            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                showToast("Thông báo trình duyệt đã được BẬT!");
            } else if (permission === "denied") {
                showToast("Đã từ chối cấp quyền thông báo!", true);
            }
            
            renderProfileContent(); // Update button state
            window.hideGlobalLoading();
        }

        function pushBrowserNotification(title, body) {
             if (Notification.permission === "granted") {
                new Notification(title, { 
                    body: body, 
                    icon: 'https://hdd.io.vn/img/bmassloadings.png', 
                    vibrate: [200, 100, 200]
                });
             }
        }
        
        window.requestNotificationPermission = requestNotificationPermission; 


        function updateUnreadCount() {
            if (!currentUser) {
                unreadCount = 0;
            } else {
                unreadCount = notifications.filter(n => !(n.readBy || []).includes(currentUser.uid)).length;
            }

            const countSpan = document.getElementById('unread-count');
            if (countSpan) {
                countSpan.innerText = unreadCount > 99 ? '99+' : unreadCount;
                countSpan.classList.toggle('hidden', unreadCount === 0);
            }
        }

        async function markAsRead(notificationId) {
            if (!currentUser) return;
            
            const notification = notifications.find(n => n.id === notificationId);
            if (notification && !(notification.readBy || []).includes(currentUser.uid)) {
                try {
                    await updateDoc(doc(db, NOTIFY_COLLECTION, notificationId), {
                        readBy: arrayUnion(currentUser.uid)
                    });
                    // FIX: Call updateUnreadCount manually since arrayUnion is asynchronous and might not trigger immediate snapshot update
                    // The snapshot listener will eventually call it, but this is for faster UX response.
                    updateUnreadCount();
                } catch (e) {
                    console.error("Error marking notification as read:", e);
                }
            }
        }

        window.renderNotifications = () => {
            const list = document.getElementById('notification-content-list');
            
            if (notifications.length === 0) {
                 list.innerHTML = `<div class="p-16 text-center">
                    <i data-lucide="bell-off" class="w-12 h-12 text-slate-400 mx-auto mb-4"></i>
                    <p class="text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                        Hiện chưa có thông báo nào.
                    </p>
                 </div>`;
                 lucide.createIcons();
                 return;
            }
            
            list.innerHTML = notifications.map(n => {
                const isRead = currentUser ? (n.readBy || []).includes(currentUser.uid) : false;
                const icon = n.iconUrl || 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png'; // Default announcement icon
                const timestamp = new Date(n.timestamp).toLocaleString('vi-VN');
                const readClass = isRead ? 'opacity-80 dark:bg-slate-800/80' : 'bg-white dark:bg-slate-900 border-l-4 border-primary shadow-lg';
                
                return `
                    <div class="notification-item flex items-start gap-4 p-4 rounded-xl shadow-sm border dark:border-white/5 ${readClass} cursor-pointer" onclick="window.markAndOpenNotification('${n.id}', '${n.title}', '${n.content}')">
                        <img src="${icon}" class="w-8 h-8 rounded-full object-contain mt-1">
                        <div class="flex-1 min-w-0 space-y-1">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-black truncate ${!isRead ? 'text-primary' : ''}">${n.title}</h4>
                                ${!isRead ? '<span class="w-2 h-2 bg-red-500 rounded-full flex-shrink-0 ml-2"></span>' : ''}
                            </div>
                            <p class="text-xs text-slate-700 dark:text-slate-300 whitespace-pre-wrap">${n.content.substring(0, 100)}...</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase pt-1 border-t dark:border-white/5">
                                ${n.senderName} • ${timestamp}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        };

        window.markAndOpenNotification = (id, title, content) => {
            if (currentUser) {
                 markAsRead(id);
            }
            // MODIFIED: Use toast for display
            showToast(`📣 **${title}**\n\n${content}`, false, true); // Added isLong=true for better display of multi-line content
        };

        window.publishNotification = async () => {
            if (!isAdmin || !currentUser) { showToast("Bạn không có quyền Admin!", true); return; }
            const title = document.getElementById('notify-title').value.trim();
            const content = document.getElementById('notify-content').value.trim();
            const iconUrl = document.getElementById('notify-icon').value.trim();

            if (title.length < 5 || content.length < 5) {
                showToast("Tiêu đề và Nội dung phải dài hơn 5 ký tự!", true);
                return;
            }
            
            window.showGlobalLoading();
            try {
                const docRef = await addDoc(collection(db, NOTIFY_COLLECTION), {
                    title: title,
                    content: content,
                    iconUrl: iconUrl,
                    timestamp: new Date().toISOString(),
                    senderName: currentUser.displayName,
                    senderEmail: currentUser.email,
                    readBy: []
                });
                
                document.getElementById('notify-title').value = '';
                document.getElementById('notify-content').value = '';
                document.getElementById('notify-icon').value = '';

                showToast("Đã đăng thông báo mới thành công!");
                logActivity('NOTIFICATION_PUBLISHED', docRef.id, title); 
            } catch (e) {
                console.error("Error publishing notification:", e);
                showToast("Lỗi khi đăng thông báo!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };

        // NEW: Render Admin Notification List
        function renderAdminNotificationList() {
             if (!isAdmin) return;
             const list = document.getElementById('admin-notify-list');

             if (notifications.length === 0) {
                  list.innerHTML = `<div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Chưa có thông báo nào được đăng.</div>`;
                  return;
             }

             list.innerHTML = notifications.map(n => {
                 const timestamp = new Date(n.timestamp).toLocaleString('vi-VN');
                 return `
                     <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5">
                         <div class="flex-1 min-w-0">
                             <h4 class="text-sm font-bold truncate">${n.title}</h4>
                             <p class="text-[10px] text-slate-500">Đăng bởi: ${n.senderName} • ${timestamp}</p>
                         </div>
                         <button onclick="window.deleteNotificationConfirm('${n.id}', '${n.title}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase hover:opacity-90 ml-2">XÓA</button>
                     </div>
                 `;
             }).join('');
        }

        // NEW: Delete Notification Confirm
        window.deleteNotificationConfirm = (id, title) => {
            window.showConfirm(
                'Xác nhận Xóa Thông báo',
                `Bạn có chắc chắn muốn xóa vĩnh viễn thông báo "${title}" không?`,
                () => window.deleteNotification(id, title),
                'XÓA VĨNH VIỄN'
            );
        };
        
        // NEW: Delete Notification
        window.deleteNotification = async (id, title) => {
            if (!isAdmin) return;
            window.showGlobalLoading();
            try {
                await deleteDoc(doc(db, NOTIFY_COLLECTION, id));
                showToast(`Đã xóa thông báo "${title}"!`);
                logActivity('NOTIFICATION_DELETED', id, title);
            } catch (e) {
                console.error("Error deleting notification:", e);
                showToast("Lỗi khi xóa thông báo!", true);
            } finally {
                window.hideGlobalLoading();
            }
        };


        // --- ANNOUNCEMENT LOGIC ---
        function renderAnnouncementBar() {
            const bar = document.getElementById('announcement-bar');
            const textDiv = document.getElementById('announcement-text');
            const now = new Date().getTime();
            const start = currentAnnouncement.startTime ? new Date(currentAnnouncement.startTime).getTime() : 0;
            const end = currentAnnouncement.endTime ? new Date(currentAnnouncement.endTime).getTime() : Infinity;
            
            const isScheduledActive = start <= now && now <= end; 
            
            if (currentAnnouncement.active && currentAnnouncement.content && currentAnnouncement.content.trim() !== '' && isScheduledActive) {
                textDiv.innerText = currentAnnouncement.content.trim().toUpperCase() + " • "; 
                bar.classList.remove('hidden');
                const contentLen = currentAnnouncement.content.length;
                const speed = Math.max(10, Math.min(30, contentLen * 0.2)); 
                bar.querySelector('.marquee > div').style.animationDuration = `${speed}s`;

            } else {
                bar.classList.add('hidden');
            }
        }
        
        function renderAnnouncementControls() {
            if (!isAdmin) return;
            const btn = document.getElementById('toggle-announcement-btn');
            
            if (currentAnnouncement.active) {
                btn.innerText = 'TẮT THÔNG BÁO';
                btn.classList.remove('bg-slate-500');
                btn.classList.add('bg-red-500');
            } else {
                btn.innerText = 'BẬT THÔNG BÁO';
                btn.classList.remove('bg-red-500');
                btn.classList.add('bg-slate-500');
            }
        }
        
        window.saveAnnouncementContent = async (andEnable = false) => {
            if (!isAdmin) return;
            const content = document.getElementById('announcement-content').value.trim();
            const startTime = document.getElementById('announcement-start').value || null; 
            const endTime = document.getElementById('announcement-end').value || null; 
            
            if (content.length < 5) {
                showToast("Nội dung thông báo phải dài hơn 5 ký tự!", true);
                return;
            }
            window.showGlobalLoading();
            try {
                const updateData = { 
                    content: content, 
                    startTime: startTime, 
                    endTime: endTime 
                };
                if (andEnable) {
                    updateData.active = true; // Automatically enable on save if triggered by 'Lưu & Bật'
                }
                
                await setDoc(doc(db, "settings", "announcement"), updateData, { merge: true });
                showToast("Đã lưu nội dung thông báo và hẹn giờ!");
                logActivity('ANNOUNCEMENT_UPDATED', 'system', 'Thông báo Marquee'); 
            } catch (e) {
                console.error("Error saving announcement:", e);
                showToast("Lỗi khi lưu nội dung thông báo!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        window.toggleAnnouncementStatus = async () => {
            if (!isAdmin) return;
            const newState = !currentAnnouncement.active;
            if (newState && (!currentAnnouncement.content || currentAnnouncement.content.trim() === '')) {
                showToast("Vui lòng nhập nội dung trước khi bật!", true);
                return;
            }
            window.showGlobalLoading();
            try {
                await setDoc(doc(db, "settings", "announcement"), { active: newState }, { merge: true });
                showToast(newState ? "Đã BẬT thông báo!" : "Đã TẮT thông báo!");
                logActivity(newState ? 'ANNOUNCEMENT_ENABLED' : 'ANNOUNCEMENT_DISABLED', 'system', 'Thông báo Marquee'); 
            } catch (e) {
                console.error("Error toggling announcement status:", e);
                showToast("Lỗi khi thay đổi trạng thái thông báo!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        // --- ADMIN REQUEST LOGIC (Unchanged) ---
        function renderAdminRequests() {
            if (!isSuper) return; 
            const list = document.getElementById('requests-list');
            document.getElementById('request-count').innerText = `(${adminRequests.length})`;
            
            if (adminRequests.length === 0) {
                 list.innerHTML = `<div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Không có yêu cầu mới.</div>`;
                 return;
            }

            list.innerHTML = adminRequests.map(req => `
                <div class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5 space-y-2">
                    <p class="text-sm font-bold">${req.name} <span class="text-xs text-slate-500">(${req.email})</span></p>
                    <p class="text-xs italic text-slate-600 dark:text-slate-400">Lý do: ${req.reason}</p>
                    <div class="flex gap-2 pt-2 border-t dark:border-white/5 mt-2">
                        <button onclick="window.requestApproveConfirm('${req.uid}', '${req.email}')" class="flex-1 bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase">DUYỆT</button>
                        <button onclick="window.requestRejectConfirm('${req.uid}')" class="flex-1 bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase">TỪ CHỐI</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        window.requestApproveConfirm = (uid, email) => {
            window.showConfirm(
                'Xác nhận Duyệt Yêu cầu',
                `Bạn có chắc chắn muốn duyệt yêu cầu của ${email} và cấp quyền Phó Admin không?`,
                () => window.approveAdminRequest(uid, email),
                'DUYỆT VÀ CẤP QUYỀN'
            );
        };
        
        window.requestRejectConfirm = (uid) => {
            window.showConfirm(
                'Xác nhận Từ chối',
                'Bạn có chắc chắn muốn từ chối yêu cầu này không?',
                () => window.rejectAdminRequest(uid),
                'TỪ CHỐI'
            );
        };
        

        window.approveAdminRequest = async (uid, email) => {
            if (!isSuper) return;
            window.showGlobalLoading();
            try {
                await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
                await deleteDoc(doc(db, "adminRequests", uid));
                
                showToast(`Đã duyệt yêu cầu và cấp quyền cho ${email}!`);
                logActivity('DEPUTY_ADDED', uid, email); 
                // Tải lại trang sau 500ms để cập nhật quyền ngay lập tức
                setTimeout(() => location.reload(), 500);
            } catch (e) {
                 console.error("Error approving request:", e);
                 showToast("Lỗi khi duyệt yêu cầu!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };

        window.rejectAdminRequest = async (uid) => {
            if (!isSuper) return;
            window.showGlobalLoading();
            try {
                await deleteDoc(doc(db, "adminRequests", uid));
                showToast("Đã từ chối yêu cầu!");
                logActivity('ADMIN_REQUEST_REJECTED', uid, 'Yêu cầu'); 
            } catch (e) {
                 console.error("Error rejecting request:", e);
                 showToast("Lỗi khi từ chối yêu cầu!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };

        // --- BULK DELETE (SOFT DELETE) LOGIC (Unchanged) ---
        window.executeBulkDelete = () => {
            if (!isAdmin || selectedAppsForDelete.size === 0) return;
            
            const count = selectedAppsForDelete.size;

            window.showConfirm(
                'Xác nhận Chuyển vào Thùng rác',
                `Bạn có chắc chắn muốn chuyển ${count} mục đã chọn vào Thùng rác? Bạn có thể khôi phục sau.`,
                async () => {
                    window.showGlobalLoading();
                    const batch = writeBatch(db);
                    selectedAppsForDelete.forEach(appId => {
                        batch.update(doc(db, "apps", appId), { isDeleted: true, deletedAt: new Date().toISOString() }); 
                    });
                    
                    logActivity('APP_SOFT_DELETED', 'bulk', `${count} mục`); 

                    try {
                        await batch.commit();
                        showToast(`Đã chuyển thành công ${count} mục vào Thùng rác!`);
                        window.toggleBulkDelete(); 
                    } catch (error) {
                        console.error("Error batch soft-deleting apps: ", error);
                        showToast("Lỗi: Không thể chuyển hàng loạt vào Thùng rác.", true); 
                    } finally {
                        window.hideGlobalLoading();
                    }
                },
                `CHUYỂN ${count} MỤC VÀO THÙNG RÁC`
            );
        };
        
        window.toggleBulkDelete = () => {
            if (!isAdmin) return;
            bulkDeleteMode = !bulkDeleteMode;
            selectedAppsForDelete.clear();
            
            document.getElementById('bulk-delete-sidebar-toggle').classList.toggle('text-red-500', !bulkDeleteMode);
            document.getElementById('bulk-delete-sidebar-toggle').classList.toggle('bg-red-500', bulkDeleteMode);
            document.getElementById('bulk-delete-sidebar-toggle').classList.toggle('text-white', bulkDeleteMode);
            
            document.getElementById('bulk-delete-dock').classList.toggle('hidden', !bulkDeleteMode);
            
            window.toggleAdminSidebar(); 

            document.querySelectorAll('.app-item').forEach(el => el.classList.remove('selected-for-delete'));
            updateBulkDeleteCount();
            renderApps(); 
        };

        window.toggleAppSelection = (appId, event) => {
            event.stopPropagation();
            if (!bulkDeleteMode) return;

            const appElement = document.querySelector(`.app-item[data-id="${appId}"]`);
            if (selectedAppsForDelete.has(appId)) {
                selectedAppsForDelete.delete(appId);
                appElement.classList.remove('selected-for-delete');
            } else {
                selectedAppsForDelete.add(appId);
                appElement.classList.add('selected-for-delete');
            }
            updateBulkDeleteCount();
        };

        function updateBulkDeleteCount() {
            const count = selectedAppsForDelete.size;
            document.getElementById('selected-count').innerText = count;
            document.getElementById('bulk-delete-dock').classList.toggle('hidden', !bulkDeleteMode || count === 0);
        }
        
        // --- VISIT STATS LOGIC (Unchanged) ---
        function getDateString(date = new Date()) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return { day: `${y}-${m}-${d}`, month: `${y}-${m}`, year: `${y}` };
        }

        async function trackVisit() {
            const now = getDateString();
            
            try {
                await runTransaction(db, async (transaction) => {
                    const statsDocRef = doc(db, "settings", "visits_stats");
                    const statsSnap = await transaction.get(statsDocRef);
                    const statsData = statsSnap.data() || {};

                    let updates = {
                        totalVisits: increment(1)
                    };
                    
                    if (statsData.lastDailyUpdate !== now.day) {
                        updates.dailyVisits = 1;
                        updates.lastDailyUpdate = now.day;
                    } else {
                        updates.dailyVisits = (statsData.dailyVisits || 0) + 1;
                    }

                    if (statsData.lastMonthlyUpdate !== now.month) {
                        updates.monthlyVisits = 1;
                        updates.lastMonthlyUpdate = now.month;
                    } else {
                        updates.monthlyVisits = (statsData.monthlyVisits || 0) + 1;
                    }

                    if (statsData.lastYearlyUpdate !== now.year) {
                        updates.yearlyVisits = 1;
                        updates.lastYearlyUpdate = now.year;
                    } else {
                        updates.yearlyVisits = (statsData.yearlyVisits || 0) + 1;
                    }

                    transaction.set(statsDocRef, updates, { merge: true });
                });

            } catch (e) {
                console.error("Transaction failed while tracking visit: ", e);
            }
        }

        function renderStats() {
            const container = document.getElementById('visit-stats-container');
            if (!container) return; 
            
            const { dailyVisits = 0, monthlyVisits = 0, yearlyVisits = 0, totalVisits = 0 } = visitStats;
            
            container.innerHTML = `
                <div class="flex items-center gap-3 text-xs font-black tracking-widest text-primary dark:text-white mb-4">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span>THỐNG KÊ LƯỢT TRUY CẬP</span>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Hôm nay</p>
                        <span class="text-lg font-black text-primary">${dailyVisits.toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Tháng này</p>
                        <span class="text-lg font-black text-primary">${monthlyVisits.toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Năm nay</p>
                        <span class="text-lg font-black text-primary">${yearlyVisits.toLocaleString('vi-VN')}</span>
                    </div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Tổng cộng</p>
                        <span class="text-lg font-black text-primary">${totalVisits.toLocaleString('vi-VN')}</span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- RENDERING APP (Modified for Mobile List View) (Unchanged) ---
        window.renderApps = () => {
            const container = document.getElementById('app-container');
            const loading = document.getElementById('app-loading');
            
            if (!appsLoaded) {
                loading.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }
            loading.classList.add('hidden');

            const effectiveViewMode = currentMobileTab === 'contact' ? 'list' : viewMode; // FIX: Only force list mode for contact tab
            const phoneCat = categories.find(c => c.name === "Số điện thoại");

            const filtered = apps.filter(a => {
                if (a.isDeleted) return false; 
                const cat = categories.find(c => c.id === a.categoryId);
                
                // Logic for Mobile Tab filtering:
                if (currentMobileTab === 'contact' && cat?.name !== "Số điện thoại") return false;
                
                // Filtering by category bar/sidebar
                if (currentFilter !== 'all' && currentFilter !== 'contact_filter' && a.categoryId !== currentFilter) return false;
                
                // Hide phone numbers on "all" filter (unless in mobile contact tab)
                if (currentFilter === 'all' && cat?.name === "Số điện thoại" && currentMobileTab !== 'contact') return false;
                
                const matchSearch = a.name.toLowerCase().includes(searchQuery.toLowerCase()) || (a.position && a.position.toLowerCase().includes(searchQuery.toLowerCase()));
                return matchSearch && (isAdmin || a.visible);
            });

            if (filtered.length === 0) {
                 container.className = "flex justify-center items-center h-40 text-slate-400";
                 container.innerHTML = `<i data-lucide="folder-search" class="w-6 h-6 mr-2"></i>Không tìm thấy ${currentMobileTab === 'contact' ? 'danh bạ' : 'ứng dụng'} nào.`;
                 lucide.createIcons();
                 return;
            }

            if (effectiveViewMode === 'grid') {
                container.className = "grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-x-4 gap-y-8";
                container.innerHTML = filtered.map(a => {
                    const isAppPhone = categories.find(c => c.id === a.categoryId)?.name === "Số điện thoại";
                    const domain = a.url.startsWith('http') ? new URL(a.url).hostname : '';
                    const icon = a.iconUrl || (isAppPhone ? 'https://cdn-icons-png.flaticon.com/512/3059/3059502.png' : `https://unavatar.io/${domain}?fallback=https://www.google.com/s2/favicons?domain=${domain}&sz=128`);
                    const isSelected = selectedAppsForDelete.has(a.id) ? 'selected-for-delete' : '';
                    const opacity = a.visible ? '' : 'opacity-40';
                    
                    if (bulkDeleteMode) {
                        return `
                        <div class="app-item group flex flex-col items-center relative cursor-pointer ${isSelected}" data-id="${a.id}" onclick="window.toggleAppSelection('${a.id}', event)">
                            <div class="w-full aspect-square bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-white/5 flex items-center justify-center p-3 mb-2 transition-all">
                                <img src="${icon}" class="w-full h-full object-contain rounded-lg ${opacity}">
                            </div>
                            <span class="text-[10px] font-bold text-slate-500 text-center truncate w-full uppercase tracking-tighter ${opacity}">${a.name}</span>
                            ${a.position ? `<span class="text-[8px] text-slate-400 font-bold truncate w-full text-center uppercase ${opacity}">${a.position}</span>` : ''}
                            <input type="checkbox" class="absolute top-1 right-1 w-5 h-5 accent-red-500 pointer-events-none" ${isSelected ? 'checked' : ''}>
                        </div>`;
                    }

                    return `
                    <div class="app-item group flex flex-col items-center relative" data-id="${a.id}">
                        <a href="${isAppPhone ? 'tel:' + a.url : a.url}" target="_blank" class="w-full aspect-square bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-white/5 flex items-center justify-center p-3 mb-2 hover:shadow-xl hover:-translate-y-1 transition-all">
                            <img src="${icon}" class="w-full h-full object-contain rounded-lg ${opacity}">
                        </a>
                        <span class="text-[10px] font-bold text-slate-500 text-center truncate w-full uppercase tracking-tighter ${opacity}">${a.name}</span>
                        ${a.position ? `<span class="text-[8px] text-slate-400 font-bold truncate w-full text-center uppercase ${opacity}">${a.position}</span>` : ''}
                        
                        <div class="absolute -top-1 -right-1 flex flex-col gap-1 transition-all scale-90 z-10 ${isAdmin ? 'opacity-0 group-hover:opacity-100' : 'hidden'}">
                            ${isAdmin ? `
                                <button onclick="window.toggleAppVisibility('${a.id}')" class="p-2 ${a.visible ? 'bg-green-500' : 'bg-slate-500'} text-white rounded-full shadow-lg">
                                    <i data-lucide="${a.visible ? 'eye' : 'eye-off'}" class="w-3 h-3"></i>
                                </button>
                                <button onclick="window.editApp('${a.id}')" class="bg-indigo-500 text-white p-2 rounded-full shadow-lg">
                                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                                </button>
                                <button onclick="window.deleteAppConfirm('${a.id}', '${a.name}')" class="bg-red-500 text-white p-2 rounded-full shadow-lg">
                                    <i data-lucide="trash" class="w-3 h-3"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>`;
                }).join('');
            } else { // List View (Vertical for mobile & desktop list mode)
                container.className = "flex flex-col max-w-4xl mx-auto space-y-1";
                container.innerHTML = filtered.map((a, idx) => {
                    const isAppPhone = categories.find(c => c.id === a.categoryId)?.name === "Số điện thoại";
                    const domain = a.url.startsWith('http') ? new URL(a.url).hostname : '';
                    const icon = a.iconUrl || (isAppPhone ? 'https://cdn-icons-png.flaticon.com/512/3059/3059502.png' : `https://unavatar.io/${domain}?fallback=https://www.google.com/s2/favicons?domain=${domain}&sz=128`);
                    const isSelected = selectedAppsForDelete.has(a.id) ? 'selected-for-delete' : '';
                    const opacity = a.visible ? '' : 'opacity-40';
                    const listIndex = a.order + 1;

                    const bulkSelectControl = bulkDeleteMode ? 
                        `<input type="checkbox" class="w-5 h-5 accent-red-500 pointer-events-none" ${isSelected ? 'checked' : ''}>` : '';

                    return `<div class="app-item flex items-center gap-4 bg-white dark:bg-slate-900 p-3 rounded-xl border dark:border-white/5 group shadow-sm ${isSelected} ${opacity}" data-id="${a.id}" onclick="${bulkDeleteMode ? `window.toggleAppSelection('${a.id}', event)` : ''}">
                        ${bulkSelectControl}
                        <span class="text-[9px] font-black text-slate-300 w-4">${listIndex}</span>
                        <img src="${icon}" class="w-8 h-8 rounded-lg object-contain">
                        <div class="flex-1 min-w-0"><h4 class="text-xs font-bold truncate">${a.name}</h4><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${a.position || (isAppPhone ? a.url : 'Web App')}</p></div>
                        <div class="flex items-center gap-2">
                            <a href="${isAppPhone ? 'tel:' + a.url : a.url}" target="_blank" class="p-2 text-primary hover:bg-primary hover:text-white rounded-lg transition"><i data-lucide="${isAppPhone ? 'phone' : 'external-link'}" class="w-4 h-4"></i></a>
                            ${isAdmin ? `
                                <button onclick="window.toggleAppVisibility('${a.id}')" class="p-2 ${a.visible ? 'text-green-500 hover:bg-green-100' : 'text-slate-500 hover:bg-slate-100'} rounded-lg"><i data-lucide="${a.visible ? 'eye' : 'eye-off'}" class="w-4 h-4"></i></button>
                                <button onclick="window.editApp('${a.id}')" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <i data-lucide="grip-vertical" class="w-4 h-4 text-slate-300 cursor-move"></i>
                            ` : ''}
                        </div></div>`;
                }).join('');
            }
            lucide.createIcons();
            // Only allow sorting on desktop in list view
            if(isAdmin && effectiveViewMode === 'list' && window.innerWidth > 768) new Sortable(container, { animation: 150, handle: '.cursor-move', onEnd: () => { Array.from(container.children).forEach((el, i) => { if(el.dataset.id) updateDoc(doc(db, "apps", el.dataset.id), { order: i }); logActivity('APP_ORDER_UPDATED', 'bulk', 'Sắp xếp ứng dụng'); }); }});
        }
        
        // --- DATA IMPORT/EXPORT LOGIC (IMPLEMENTED) ---
        
        window.handleExport = async (type) => {
             if (!isAdmin) return;
             window.showGlobalLoading();
             
             try {
                 // Fetch all necessary data
                 const appsSnapshot = await getDocs(collection(db, "apps"));
                 const categoriesSnapshot = await getDocs(collection(db, "categories"));
                 const notificationsSnapshot = await getDocs(collection(db, NOTIFY_COLLECTION));
                 const adminSettingsSnapshot = await getDoc(doc(db, "settings", "admins"));
                 const globalSettingsSnapshot = await getDoc(doc(db, "settings", "global"));
                 const announcementSettingsSnapshot = await getDoc(doc(db, "settings", "announcement"));
                 
                 const exportData = {
                     apps: appsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                     categories: categoriesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                     notifications: notificationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                     settings: {
                         admins: adminSettingsSnapshot.data() || {},
                         global: globalSettingsSnapshot.data() || {},
                         announcement: announcementSettingsSnapshot.data() || {},
                     },
                     // Add versioning and timestamp for future-proofing
                     version: '1.0', 
                     timestamp: new Date().toISOString()
                 };

                 const filename = `hub_portal_backup_${new Date().toISOString().substring(0, 10)}`;

                 if (type === 'json') {
                     const jsonString = JSON.stringify(exportData, null, 2);
                     const blob = new Blob([jsonString], { type: "application/json" });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = `${filename}.json`;
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                 } else if (type === 'excel') {
                     const ws = XLSX.utils.json_to_sheet(exportData.apps); // Only export main apps data to sheet
                     const wb = XLSX.utils.book_new();
                     XLSX.utils.book_append_sheet(wb, ws, "AppsData");
                     // Optionally add other collections as separate sheets
                     XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData.categories), "Categories");
                     XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData.notifications), "Notifications");

                     XLSX.writeFile(wb, `${filename}.xlsx`);
                 }

                 showToast("Đã xuất dữ liệu thành công!");
                 logActivity('DATA_EXPORTED', 'system', `Xuất file ${type.toUpperCase()}`);
                 
             } catch (e) {
                 console.error("Lỗi khi xuất dữ liệu:", e);
                 showToast("Lỗi khi xuất dữ liệu!", true);
             } finally {
                 window.hideGlobalLoading();
             }
         };
         
         window.handleImport = (event) => {
             if (!isAdmin) return;
             const file = event.target.files[0];
             if (!file) return;

             window.showConfirm(
                 'Xác nhận Khôi phục Dữ liệu',
                 'Thao tác này sẽ **GHI ĐÈ** dữ liệu hiện tại (Ứng dụng, Danh mục, Thông báo, Cài đặt Admin) bằng dữ liệu trong file. Bạn có chắc chắn muốn tiếp tục không? Hành động này không thể hoàn tác.',
                 () => executeImport(file),
                 'KHÔI PHỤC DỮ LIỆU'
             );
         };

         async function executeImport(file) {
             window.showGlobalLoading();
             try {
                 const fileExtension = file.name.split('.').pop().toLowerCase();
                 let importedData = {};

                 if (fileExtension === 'json') {
                     const text = await file.text();
                     importedData = JSON.parse(text);
                 } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                     // Read Excel file (only support importing Apps/Categories for simplicity)
                     const data = await file.arrayBuffer();
                     const workbook = XLSX.read(data, { type: 'array' });
                     
                     // Assuming 'AppsData' sheet for apps and 'Categories' for categories
                     if (workbook.SheetNames.includes('AppsData')) {
                         importedData.apps = XLSX.utils.sheet_to_json(workbook.Sheets['AppsData']);
                     }
                     if (workbook.SheetNames.includes('Categories')) {
                         importedData.categories = XLSX.utils.sheet_to_json(workbook.Sheets['Categories']);
                     }
                     
                     if (!importedData.apps && !importedData.categories) {
                        throw new Error("Tệp Excel không chứa các sheet 'AppsData' hoặc 'Categories' hợp lệ.");
                     }
                     showToast("Lưu ý: Chỉ hỗ trợ import Ứng dụng và Danh mục từ file Excel.", false, true);

                 } else {
                     throw new Error("Định dạng file không được hỗ trợ. Vui lòng chọn .json hoặc .xlsx.");
                 }
                 
                 const batch = writeBatch(db);
                 
                 // --- Apps Collection Handling ---
                 if (importedData.apps) {
                     // Delete all existing apps first (or soft delete them)
                     const existingApps = await getDocs(collection(db, "apps"));
                     existingApps.docs.forEach(d => batch.delete(d.ref));
                     
                     // Add imported apps
                     importedData.apps.forEach(app => {
                         const { id, ...data } = app;
                         // FIX: Check for valid ID and auto-generate if missing/empty
                         const docRef = (id && id.trim() !== '') 
                            ? doc(db, "apps", id) 
                            : doc(collection(db, "apps")); 
                         batch.set(docRef, data);
                     });
                 }

                 // --- Categories Collection Handling ---
                 if (importedData.categories) {
                     const existingCategories = await getDocs(collection(db, "categories"));
                     existingCategories.docs.forEach(d => batch.delete(d.ref));
                     
                     importedData.categories.forEach(cat => {
                         const { id, ...data } = cat;
                         // FIX: Check for valid ID and auto-generate if missing/empty
                         const docRef = (id && id.trim() !== '') 
                            ? doc(db, "categories", id) 
                            : doc(collection(db, "categories")); 
                         batch.set(docRef, data);
                     });
                 }
                 
                 // --- Settings Handling (Only from JSON) ---
                 if (fileExtension === 'json' && importedData.settings) {
                     const settings = importedData.settings;
                     if (settings.admins) batch.set(doc(db, "settings", "admins"), settings.admins);
                     if (settings.global) batch.set(doc(db, "settings", "global"), settings.global);
                     if (settings.announcement) batch.set(doc(db, "settings", "announcement"), settings.announcement);
                 }
                 
                 // --- Notifications Handling (Only from JSON) ---
                 if (fileExtension === 'json' && importedData.notifications) {
                     const existingNotifications = await getDocs(collection(db, NOTIFY_COLLECTION));
                     existingNotifications.docs.forEach(d => batch.delete(d.ref));
                     
                     importedData.notifications.forEach(notif => {
                         const { id, ...data } = notif;
                         batch.set(doc(db, NOTIFY_COLLECTION, id), data);
                     });
                 }

                 await batch.commit();

                 showToast("Khôi phục dữ liệu thành công! Đang tải lại trang...");
                 logActivity('DATA_IMPORTED', 'system', `Nhập file ${fileExtension.toUpperCase()}`);
                 setTimeout(() => location.reload(), 500); // Reload to reflect new data and admin status

             } catch (e) {
                 console.error("Lỗi khi khôi phục dữ liệu:", e);
                 showToast(`Lỗi khôi phục: ${e.message || 'Không thể khôi phục dữ liệu!'}`, true);
             } finally {
                 window.hideGlobalLoading();
                 document.getElementById('import-file').value = ''; // Clear file input
             }
         }
        
        // --- ADMIN UTILS ---
        window.updateCatField = (id, field, val) => {
            window.showGlobalLoading();
            updateDoc(doc(db, "categories", id), { [field]: val })
            .then(() => { showToast("Đã cập nhật danh mục!"); logActivity('CAT_UPDATED', id, categories.find(c=>c.id === id)?.name); }) 
            .catch(e => showToast("Lỗi khi cập nhật danh mục!", true))
            .finally(window.hideGlobalLoading);
        }
            
        // MODIFIED: Category Delete Logic
        window.deleteCatConfirm = (id, name) => {
            catToDeleteId = id;
            const appsInCategory = apps.filter(a => a.categoryId === id && !a.isDeleted);
            
            if (appsInCategory.length > 0) {
                 const availableCats = categories.filter(c => c.id !== id);
                 if (availableCats.length === 0) {
                     showToast("Không thể xóa. Vui lòng thêm ít nhất một danh mục khác trước!", true);
                     return;
                 }
                 document.getElementById('cat-migrate-count').innerText = appsInCategory.length;
                 
                 const migrateSelect = document.getElementById('cat-migrate-select');
                 migrateSelect.innerHTML = availableCats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                 
                 window.openModal('modal-cat-migrate');
            } else {
                window.showConfirm(
                    'Xác nhận Xóa Danh mục',
                    `Bạn có chắc chắn muốn xóa vĩnh viễn danh mục "${name}" không?`,
                    () => window.deleteCat(id, name),
                    'XÓA VĨNH VIỄN'
                );
            }
        };

        window.executeCatDeleteAndMigrate = async () => {
            const oldCatId = catToDeleteId;
            const newCatId = document.getElementById('cat-migrate-select').value;
            const oldCatName = categories.find(c => c.id === oldCatId)?.name;
            const newCatName = categories.find(c => c.id === newCatId)?.name;

            if (!oldCatId || !newCatId) return;

            window.closeModal('modal-cat-migrate');
            window.showGlobalLoading();

            try {
                const batch = writeBatch(db);
                const appsToMigrate = apps.filter(a => a.categoryId === oldCatId && !a.isDeleted);
                
                // 1. Update all apps in the old category
                appsToMigrate.forEach(app => {
                    batch.update(doc(db, "apps", app.id), { categoryId: newCatId });
                });

                // 2. Delete the old category
                batch.delete(doc(db, "categories", oldCatId));
                
                await batch.commit();
                
                showToast(`Đã xóa danh mục "${oldCatName}" và chuyển ${appsToMigrate.length} ứng dụng sang "${newCatName}"!`);
                logActivity('CAT_DELETED_MIGRATED', oldCatId, oldCatName, `Đã chuyển sang ${newCatName}`);
                catToDeleteId = null; 

            } catch (e) {
                console.error("Error deleting category and migrating apps:", e);
                showToast("Lỗi khi xóa danh mục và chuyển đổi ứng dụng!", true);
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        window.deleteCat = (id, name) => {
            window.showGlobalLoading();
            deleteDoc(doc(db, "categories", id))
                .then(() => { showToast(`Đã xóa danh mục "${name}"!`); logActivity('CAT_DELETED', id, name); }) 
                .catch(e => showToast("Lỗi khi xóa danh mục!", true))
                .finally(window.hideGlobalLoading); 
        };
        
        window.addCategory = async () => {
            const name = document.getElementById('new-cat-name').value.trim();
            const icon = document.getElementById('new-cat-icon').value.trim();
            if(!name) { showToast("Tên danh mục không được trống!", true); return; }
            window.showGlobalLoading();
            await addDoc(collection(db, "categories"), { name, icon, order: categories.length })
                .then((docRef) => {
                    document.getElementById('new-cat-name').value = '';
                    document.getElementById('new-cat-icon').value = '';
                    showToast("Đã thêm danh mục mới!");
                    logActivity('CAT_ADDED', docRef.id, name); 
                })
                .catch(e => showToast("Lỗi khi thêm danh mục.", true))
                .finally(window.hideGlobalLoading);
        };

        window.renderDeputyList = () => {
            const list = document.getElementById('deputy-list');
            list.innerHTML = deputies.map(email => `<div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5"><span class="text-sm font-bold">${email}</span>${isSuper ? `<button onclick="window.removeDeputyConfirm('${email}')" class="text-red-500 p-2"><i data-lucide="user-minus" class="w-4 h-4"></i></button>` : ''}</div>`).join('');
            
            document.getElementById('deputy-guard').classList.toggle('hidden', isSuper);
            document.getElementById('deputy-ui').classList.toggle('hidden', !isSuper);
            
            lucide.createIcons();
        };

        window.addDeputy = async () => {
            const email = document.getElementById('new-deputy-email').value.trim().toLowerCase();
            if(!email || !isSuper) return;
            if (!email.includes('@')) { showToast("Vui lòng nhập email hợp lệ!", true); return; }
            window.showGlobalLoading();
            try {
                await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
                document.getElementById('new-deputy-email').value = '';
                showToast(`Đã cấp quyền cho ${email}.`);
                logActivity('DEPUTY_ADDED', email, email); 
                // Tải lại trang sau 500ms để cập nhật quyền ngay lập tức
                setTimeout(() => location.reload(), 500);
            } catch (e) { 
                showToast("Lỗi khi cấp quyền Phó Admin.", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        window.removeDeputyConfirm = (email) => {
            window.showConfirm(
                'Xác nhận Thu hồi quyền',
                `Bạn có chắc chắn muốn thu hồi quyền Phó Admin của ${email}? Họ sẽ không thể truy cập Sidebar Admin nữa.`,
                () => window.removeDeputy(email),
                'THU HỒI QUYỀN'
            );
        };

        window.removeDeputy = async (email) => {
            if (!isSuper) return;
            window.showGlobalLoading();
            try {
                await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayRemove(email) }, { merge: true });
                showToast(`Đã xóa quyền của ${email}.`);
                logActivity('DEPUTY_REMOVED', email, email); 
                // Tải lại trang sau 500ms để cập nhật quyền ngay lập tức
                setTimeout(() => location.reload(), 500);
            } catch (e) { 
                showToast("Lỗi khi xóa quyền Phó Admin.", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        // NEW: Maintenance Mode Logic (MODIFIED: Use Custom Confirm)
        window.toggleMaintenanceMode = () => {
            if (!isAdmin) return;
            const newState = !globalSettings.maintenanceMode;
            const action = newState ? 'BẬT' : 'TẮT';

            window.showConfirm(
                `Xác nhận ${action} Chế độ Bảo trì`,
                `Bạn có chắc chắn muốn ${action} Chế độ Bảo trì không? Khi bật, tất cả Khách (Guest) sẽ không thể xem nội dung.`,
                async () => {
                    window.showGlobalLoading();
                    try {
                        await setDoc(doc(db, "settings", "global"), { maintenanceMode: newState }, { merge: true });
                        showToast(`Đã ${action} Chế độ Bảo trì!`);
                        logActivity(newState ? 'ENABLED_MAINTENANCE' : 'DISABLED_MAINTENANCE', 'system', 'Chế độ Bảo trì'); 
                    } catch (e) {
                        showToast("Lỗi khi thay đổi Chế độ Bảo trì!", true);
                    } finally {
                        window.hideGlobalLoading();
                    }
                },
                action
            );
        };
        
        // NEW: Activity Logging Utility (Unchanged)
        function logActivity(type, itemId, itemName, details = '') {
            if (!isAdmin || !currentUser) return; 
            addDoc(collection(db, LOGS_COLLECTION), {
                timestamp: new Date().toISOString(),
                adminUid: currentUser.uid,
                adminEmail: currentUser.email,
                type: type, 
                itemId: itemId,
                itemName: itemName,
                details: details 
            }).catch(e => console.error("Error logging activity:", e));
        }

        // NEW: Render Activity Logs (FIXED: The listener should fetch data)
        function renderActivityLogs() { 
            if (!isAdmin) return;
            const logs = activityLogs;
            const list = document.getElementById('logs-list');
            
            if (logs.length === 0) {
                list.innerHTML = `<div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Chưa có hoạt động nào được ghi lại.</div>`;
                return;
            }

            list.innerHTML = logs.map(log => {
                const date = new Date(log.timestamp).toLocaleString('vi-VN');
                const actionMap = {
                    'APP_ADDED': 'Thêm ứng dụng',
                    'APP_UPDATED': 'Cập nhật ứng dụng',
                    'APP_SOFT_DELETED': 'Chuyển ứng dụng vào Thùng rác',
                    'APP_PERM_DELETED': 'Xóa vĩnh viễn ứng dụng',
                    'APP_RESTORED': 'Khôi phục ứng dụng',
                    'CAT_UPDATED': 'Cập nhật danh mục',
                    'CAT_ADDED': 'Thêm danh mục',
                    'CAT_DELETED': 'Xóa danh mục',
                    'CAT_DELETED_MIGRATED': 'Xóa & Chuyển đổi Danh mục', // NEW
                    'DEPUTY_ADDED': 'Cấp quyền Phó Admin',
                    'DEPUTY_REMOVED': 'Thu hồi quyền Phó Admin',
                    'ENABLED_MAINTENANCE': 'Bật chế độ Bảo trì',
                    'DISABLED_MAINTENANCE': 'Tắt chế độ Bảo trì',
                    'ANNOUNCEMENT_UPDATED': 'Cập nhật thông báo Marquee',
                    'ANNOUNCEMENT_ENABLED': 'Bật thông báo Marquee',
                    'ANNOUNCEMENT_DISABLED': 'Tắt thông báo Marquee',
                    'NOTIFICATION_PUBLISHED': 'Đăng thông báo Feed', 
                    'NOTIFICATION_DELETED': 'Xóa thông báo Feed', 
                    'DATA_EXPORTED': 'Xuất dữ liệu',
                    'DATA_IMPORTED': 'Nhập dữ liệu',
                    'ADMIN_REQUEST_REJECTED': 'Từ chối yêu cầu Admin',
                    'APP_ORDER_UPDATED': 'Sắp xếp ứng dụng',
                    'CAT_ORDER_UPDATED': 'Sắp xếp danh mục'
                };
                const action = actionMap[log.type] || log.type;
                
                return `
                    <div class="p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5 text-xs space-y-1">
                        <p class="font-bold text-primary dark:text-white">${action}: <span class="text-slate-700 dark:text-slate-300">${log.itemName}</span></p>
                        <p class="text-[10px] text-slate-500 uppercase">Admin: ${log.adminEmail} | Lúc: ${date}</p>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // NEW: Trash List Renderer and Actions (Unchanged)
        function renderTrash() {
            if (!isAdmin) return;
            const trashList = document.getElementById('trash-list');
            const deletedApps = apps.filter(a => a.isDeleted).sort((a, b) => new Date(b.deletedAt) - new Date(a.deletedAt));

            document.getElementById('clear-trash-btn').classList.toggle('hidden', deletedApps.length === 0);

            if (deletedApps.length === 0) {
                 trashList.innerHTML = `<div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Thùng rác trống.</div>`;
                 return;
            }

            trashList.innerHTML = deletedApps.map(a => {
                const deletedDate = a.deletedAt ? new Date(a.deletedAt).toLocaleDateString('vi-VN') : 'N/A';
                return `
                    <div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-bold truncate">${a.name}</h4>
                            <p class="text-[10px] text-slate-500">Xóa ngày: ${deletedDate}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.restoreAppConfirm('${a.id}', '${a.name}')" class="bg-primary text-white px-3 py-1 rounded-lg text-xs font-bold uppercase hover:opacity-90">KHÔI PHỤC</button>
                            <button onclick="window.clearTrashConfirm(false, '${a.id}', '${a.name}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-bold uppercase hover:opacity-90">XÓA VĨNH VIỄN</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        window.restoreAppConfirm = (id, name) => {
            window.showConfirm(
                'Xác nhận Khôi phục',
                `Bạn có chắc chắn muốn khôi phục ứng dụng "${name}" về trang chủ không?`,
                () => window.restoreApp(id, name),
                'KHÔI PHỤC'
            );
        };
        
        // NEW: Restore App
        window.restoreApp = async (id, name) => {
            if (!isAdmin) return;
            window.showGlobalLoading();
            try {
                await updateDoc(doc(db, "apps", id), { isDeleted: false, deletedAt: null });
                showToast(`Đã khôi phục ứng dụng "${name}"!`);
                logActivity('APP_RESTORED', id, name);
            } catch (e) {
                showToast("Lỗi khi khôi phục ứng dụng!", true);
            } finally {
                window.hideGlobalLoading();
            }
        };

        window.clearTrashConfirm = (clearAll = false, id = null, name = '') => {
            const isAll = clearAll;
            const title = isAll ? 'XÓA VĨNH VIỄN TẤT CẢ' : 'XÓA VĨNH VIỄN MỤC NÀY';
            const message = isAll 
                ? "BẠN CÓ CHẮC CHẮN MUỐN XÓA VĨNH VIỄN TẤT CẢ mục trong Thùng rác? Hành động này không thể hoàn tác."
                : `XÓA VĨNH VIỄN ứng dụng "${name}"? Hành động này không thể hoàn tác.`;

            window.showConfirm(
                title,
                message,
                () => window.clearTrash(clearAll, id, name),
                title
            );
        };

        // NEW: Permanent Delete App / Clear All Trash 
        window.clearTrash = async (clearAll = false, id = null, name = '') => {
            if (!isAdmin) return;
            window.showGlobalLoading();
            try {
                if (clearAll) {
                    const deletedApps = apps.filter(a => a.isDeleted);
                    const batch = writeBatch(db);
                    deletedApps.forEach(a => batch.delete(doc(db, "apps", a.id)));
                    
                    logActivity('APP_PERM_DELETED', 'bulk', `Tất cả ${deletedApps.length} mục`);
                    
                    await batch.commit();
                    showToast(`Đã dọn sạch ${deletedApps.length} mục trong Thùng rác!`);
                    
                } else if (id) {
                    await deleteDoc(doc(db, "apps", id));
                    showToast(`Đã xóa vĩnh viễn ứng dụng "${name}"!`);
                    logActivity('APP_PERM_DELETED', id, name);
                }
            } catch (e) {
                showToast("Lỗi khi xóa vĩnh viễn!", true);
            } finally {
                window.hideGlobalLoading();
            }
        };

        window.toggleFormFields = () => {
            const catName = categories.find(c => c.id === document.getElementById('app-category').value)?.name;
            const isPhone = catName === "Số điện thoại";
            document.getElementById('field-position').classList.toggle('hidden', !isPhone);
            document.getElementById('label-name').innerText = isPhone ? "Tên liên hệ" : "Tên hiển thị";
            document.getElementById('label-link').innerText = isPhone ? "Số điện thoại" : "Link URL";
        };

        window.openAppModal = () => { document.getElementById('app-form').reset(); document.getElementById('edit-id').value = ''; window.toggleFormFields(); window.openModal('modal-app'); };
        window.editApp = (id) => {
            const a = apps.find(x => x.id === id);
            document.getElementById('edit-id').value = a.id;
            document.getElementById('app-name').value = a.name;
            document.getElementById('app-position').value = a.position || '';
            document.getElementById('app-link').value = a.url;
            document.getElementById('app-icon').value = a.iconUrl || '';
            document.getElementById('app-category').value = a.categoryId || '';
            document.getElementById('app-visible').checked = a.visible;
            window.toggleFormFields();
            window.openModal('modal-app');
        };

        document.getElementById('app-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const data = { name: document.getElementById('app-name').value, position: document.getElementById('app-position').value, url: document.getElementById('app-link').value, iconUrl: document.getElementById('app-icon').value, categoryId: document.getElementById('app-category').value, visible: document.getElementById('app-visible').checked, order: id ? apps.find(x => x.id === id).order : apps.length };
            
            window.showGlobalLoading();
            try {
                if (id) {
                    await updateDoc(doc(db, "apps", id), data);
                    showToast("Đã cập nhật ứng dụng!");
                    logActivity('APP_UPDATED', id, data.name); 
                } else {
                    const docRef = await addDoc(collection(db, "apps"), data);
                    showToast("Đã thêm ứng dụng mới!");
                    logActivity('APP_ADDED', docRef.id, data.name); 
                }
                window.closeModal('modal-app');
            } catch (e) {
                console.error("Error saving app:", e);
                showToast("Lỗi khi lưu ứng dụng!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        window.deleteAppConfirm = (id, name) => {
             window.showConfirm(
                'Xác nhận Chuyển vào Thùng rác',
                `Bạn có chắc chắn muốn chuyển ứng dụng "${name}" vào Thùng rác không? Bạn có thể khôi phục sau.`,
                () => window.deleteApp(id, name),
                'CHUYỂN VÀO THÙNG RÁC'
            );
        };

        // MODIFIED: Soft Delete instead of hard delete (Unchanged logic, now only called by confirm)
        window.deleteApp = (id, appName) => {
            if (!isAdmin) return;
            window.showGlobalLoading();
            updateDoc(doc(db, "apps", id), { isDeleted: true, deletedAt: new Date().toISOString() })
                .then(() => {
                    showToast(`Đã chuyển ứng dụng "${appName}" vào Thùng rác!`);
                    logActivity('APP_SOFT_DELETED', id, appName); 
                })
                .catch(e => showToast("Lỗi khi chuyển vào thùng rác!", true))
                .finally(window.hideGlobalLoading); 
        };

        window.toggleAppVisibility = (id) => {
            if (!isAdmin) return;
            const app = apps.find(a => a.id === id);
            if (!app) return;
            window.showGlobalLoading();
            updateDoc(doc(db, "apps", id), { visible: !app.visible })
                .then(() => { showToast(`Đã ${!app.visible ? 'BẬT' : 'TẮT'} hiển thị.`); logActivity('APP_VISIBILITY_TOGGLED', id, app.name); }) 
                .catch(e => showToast("Lỗi cập nhật hiển thị!", true))
                .finally(window.hideGlobalLoading); 
        };

        window.renderCategories = renderCategories; 
        function renderCategories() {
            const barDesktop = document.getElementById('category-bar');
            const barMobile = document.getElementById('category-bar-mobile');
            
            // Icon Fallback Logic: Use folder icon if no iconUrl provided
            const getIconHtml = (c) => c.icon ? `<img src="${c.icon}" class="w-3 h-3 object-contain">` : `<i data-lucide="folder" class="w-3 h-3"></i>`;
            
            // MODIFIED: setFilter now only takes id/isDesktop
            let htmlMobile = `<button onclick="window.setFilter('all', false)" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest transition-all w-full text-left ${currentFilter === 'all' ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-500'}">TẤT CẢ</button>`;
            
            categories.forEach(c => {
                const buttonClass = `px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest transition-all flex items-center gap-2 w-full text-left ${currentFilter === c.id ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-500'}`;
                htmlMobile += `<button onclick="window.setFilter('${c.id}', false)" class="${buttonClass}">
                    ${getIconHtml(c)} ${c.name.toUpperCase()}
                </button>`;
            });
            
            // Render to Desktop Bar
            barDesktop.innerHTML = `<button onclick="window.setFilter('all', true)" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest transition-all ${currentFilter === 'all' ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-500'}">TẤT CẢ</button>` + categories.map(c => {
                const isSelected = currentFilter === c.id;
                return `<button onclick="window.setFilter('${c.id}', true)" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest transition-all flex items-center gap-2 ${isSelected ? 'bg-primary text-white shadow-lg' : 'bg-white dark:bg-slate-800 text-slate-500'}">
                    ${getIconHtml(c)} ${c.name.toUpperCase()}
                </button>`;
            }).join('');
            
            // Render to Mobile Sidebar (Use list style)
            barMobile.innerHTML = `<div class="space-y-2">${htmlMobile}</div>`;

            const list = document.getElementById('cat-list-admin');
            list.innerHTML = categories.map(c => `<li class="flex flex-col gap-2 p-4 bg-slate-50 dark:bg-white/5 rounded-2xl border dark:border-white/5" data-id="${c.id}"><div class="flex items-center gap-3"><i data-lucide="grip-vertical" class="text-slate-300 cursor-move"></i><input type="text" value="${c.name}" onblur="window.updateCatField('${c.id}', 'name', this.value)" class="flex-1 bg-transparent border-none font-bold text-sm outline-none"><button onclick="window.deleteCatConfirm('${c.id}', '${c.name}')" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><input type="text" value="${c.icon || ''}" onblur="window.updateCatField('${c.id}', 'icon', this.value)" placeholder="Icon URL" class="text-[10px] bg-white dark:bg-black/20 px-4 py-2 rounded-lg outline-none w-full border-none shadow-inner"></li>`).join('');
            lucide.createIcons();
            if(isAdmin) new Sortable(list, { animation: 150, handle: '.cursor-move', onEnd: () => { Array.from(list.children).forEach((el, i) => updateDoc(doc(db, "categories", el.dataset.id), { order: i })); logActivity('CAT_ORDER_UPDATED', 'bulk', 'Sắp xếp danh mục'); }});
            document.getElementById('app-category').innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // MODIFIED: Removed auto-close logic
        window.setFilter = (id, isDesktop, closeSidebar = true) => { // Added optional closeSidebar param
            currentFilter = id; 
            renderCategories(); 
            renderApps();
            // Closing logic only happens explicitly via toggleMobileCategorySidebar()
            if (!isDesktop && id !== 'contact_filter' && closeSidebar) {
                 // window.toggleMobileCategorySidebar(); // Removed automatic closing here (logic moved to the button's explicit onclick handler for category selection)
            }
            
            // Ensure desktop view resets to App Tab (Fix for desktop profile view context)
            if (isDesktop && currentMobileTab !== 'app' && currentMobileTab !== 'contact') {
                 window.switchMobileTab('app', true);
            }
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.switchTab = (tabId) => {
            const tabs = ['tab-cat', 'tab-announcement', 'tab-deputy', 'tab-request', 'tab-data', 'tab-trash', 'tab-logs']; 
            const buttons = ['btn-tab-cat', 'btn-tab-announcement', 'btn-tab-deputy', 'btn-tab-request', 'btn-tab-data', 'btn-tab-trash', 'btn-tab-logs']; 

            tabs.forEach(id => document.getElementById(id).classList.add('hidden'));
            buttons.forEach(id => document.getElementById(id).classList.remove('text-primary', 'border-b-2', 'border-primary'));
            
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('text-primary', 'border-b-2', 'border-primary');
            
            if (tabId === 'tab-announcement' && isAdmin) {
                 document.getElementById('announcement-content').value = currentAnnouncement.content || '';
                 document.getElementById('announcement-start').value = currentAnnouncement.startTime || ''; 
                 document.getElementById('announcement-end').value = currentAnnouncement.endTime || ''; 
                 renderAnnouncementControls();
                 renderAdminNotificationList(); // NEW: Render list when tab is opened
            }
            
            if (tabId === 'tab-deputy' && isAdmin) {
                 renderDeputyList();
            }
            
            if (tabId === 'tab-request' && isAdmin) {
                 renderAdminRequests();
            }

            if (tabId === 'tab-trash' && isAdmin) {
                 renderTrash(); 
            }

            if (tabId === 'tab-logs' && isAdmin) {
                 renderActivityLogs(); 
            }
        };
        
        window.toggleTheme = () => { 
            window.showGlobalLoading();
            document.documentElement.classList.toggle('dark'); 
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; 
            
            // NEW: Update Profile Theme Toggle Icon/Text
            const isDark = document.documentElement.classList.contains('dark');
            const themeIconElement = document.getElementById('profile-theme-toggle')?.querySelector('i');
            if(themeIconElement) {
                themeIconElement.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            }
            
            lucide.createIcons();
            window.hideGlobalLoading();
        };

        document.getElementById('search-input').oninput = (e) => { searchQuery = e.target.value; renderApps(); };
        window.setView = (mode) => { 
            viewMode = mode; 
            // Update desktop view button styles
            document.getElementById('view-grid-btn')?.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm');
            document.getElementById('view-list-btn')?.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm');
            if(mode === 'grid') {
                 document.getElementById('view-grid-btn')?.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm');
            } else {
                 document.getElementById('view-list-btn')?.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm');
            }
            renderApps(); 
        };
        
        // CẬP NHẬT & SỬA LỖI TOAST (FIXED & IMPROVED UX)
        function showToast(msg, isError = false, isLong = false) {
            const t = document.getElementById('toast');
            // Support markdown bold in toast
            document.getElementById('toast-msg').innerHTML = msg.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            
            const icon = t.querySelector('i');
            
            icon.classList.remove('text-green-500', 'text-red-500');

            if (isError) {
                 icon.setAttribute('data-lucide', 'alert-triangle');
                 icon.classList.add('text-red-500');
            } else {
                 icon.setAttribute('data-lucide', 'check-circle');
                 icon.classList.add('text-green-500');
                 
                 // NEW: Push to browser notification (only for non-error, non-long toasts)
                 if (!isLong && Notification.permission === "granted") { 
                     const plainMsg = msg.replace(/\*\*(.*?)\*\*/g, '$1').replace(/<br>/g, ' ');
                     const title = msg.includes('thành công') ? 'HUB PORTAL - Thành công' : 'HUB PORTAL - Thông báo';
                     pushBrowserNotification(title, plainMsg);
                 }
            }
            
            lucide.createIcons();
            
            // Clear existing timeout
            clearTimeout(toastTimeout);
            
            // Show toast
            t.classList.remove('hidden');
            t.classList.add('visible');

            // Set timeout for auto-close (3s for normal, 5s for long content)
            const duration = isLong ? 5000 : 3000;
            toastTimeout = setTimeout(() => {
                 window.closeToast();
            }, duration);
        }

        window.closeToast = () => {
             const t = document.getElementById('toast');
             t.classList.remove('visible');
             // Hide after transition
             setTimeout(() => {
                 t.classList.add('hidden');
             }, 500); 
             clearTimeout(toastTimeout);
        };

        // NEW: Toast swipe detection (Mobile UX) (FIXED: Swipe Down to close)
        window.handleToastTouchStart = (e) => {
            if (e.touches.length === 1) {
                toastTouchStartY = e.touches[0].clientY;
            }
        };

        window.handleToastTouchMove = (e) => {
            if (e.touches.length === 1) {
                const deltaY = e.touches[0].clientY - toastTouchStartY;
                if (deltaY > 30) { // FIX: Swipe Down to close (Toast is at bottom)
                    window.closeToast();
                }
            }
        };

        window.handleToastTouchEnd = (e) => {
            // Can be used to check for tap to close if desired, but default onclick is set on the element.
        };


        if(localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        lucide.createIcons();
        
        // Removed redundant setView/setLang calls as they are handled in onAuthStateChanged
        
        trackVisit();
    </script>

</body>
</html>

