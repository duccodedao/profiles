<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Tài khoản Ngân hàng</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --secondary-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --shadow-lg: 0 10px 40px -10px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f0f2f5 url('https://img.freepik.com/free-vector/gradient-network-connection-background_23-2148879890.jpg?w=2000') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: var(--glass-border);
            box-shadow: var(--shadow-lg);
        }

        .navbar-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 30px rgba(0,0,0,0.03);
        }

        /* Buttons */
        .btn-gradient-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            transition: transform 0.2s;
        }
        .btn-gradient-primary:hover { transform: translateY(-2px); color: white; }

        /* Table Styling */
        .custom-table {
            border-collapse: separate;
            border-spacing: 0 8px;
        }
        .custom-table thead th {
            border: none;
            background: rgba(255,255,255,0.5);
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 15px;
        }
        .custom-table tbody tr {
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        .custom-table tbody tr:hover { transform: scale(1.01); z-index: 10; position: relative; }
        .custom-table td {
            border: none;
            padding: 15px;
            vertical-align: middle;
        }
        .custom-table td:first-child { border-radius: 12px 0 0 12px; }
        .custom-table td:last-child { border-radius: 0 12px 12px 0; }

        /* Bank Columns */
        .bank-cell {
            display: flex; align-items: center; gap: 8px;
            font-weight: 600; color: #334155;
            background: #f8fafc; padding: 8px 12px; border-radius: 8px;
            border: 1px solid #e2e8f0; width: fit-content;
        }
        .bank-logo-sm { height: 20px; width: auto; object-fit: contain; }
        .bank-empty { color: #cbd5e1; font-style: italic; font-weight: 400; }

        /* Inputs */
        .form-control {
            border-radius: 12px; padding: 12px 16px;
            border: 1px solid #e2e8f0; background: rgba(255,255,255,0.8);
        }
        .form-control:focus {
            background: white; border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* Loading */
        #loading {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <h6 class="fw-bold text-secondary animate__animated animate__pulse animate__infinite">Đang xử lý dữ liệu...</h6>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-glass sticky-top mb-5">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#">
                <span class="bg-primary text-white rounded-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="fas fa-wallet"></i>
                </span>
                <span style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">HR Finance</span>
            </a>
            
            <div class="d-flex align-items-center gap-3">
                <span id="userInfo" class="fw-bold text-secondary d-none d-md-block small"></span>
                <button id="btnLogin" class="btn btn-dark rounded-pill px-4 btn-sm">
                    <i class="fab fa-google me-2"></i>Admin Login
                </button>
                <button id="btnLogout" class="btn btn-outline-danger rounded-pill px-4 btn-sm d-none">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">

        <!-- Tabs Navigation -->
        <div class="d-flex justify-content-center mb-4">
            <ul class="nav nav-pills bg-white p-1 rounded-pill shadow-sm" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#tab-user">
                        <i class="fas fa-user-edit me-2"></i>Nhập Liệu
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link rounded-pill px-4" id="btnAdminTab" data-bs-toggle="pill" data-bs-target="#tab-admin">
                        <i class="fas fa-shield-alt me-2"></i>Quản Trị Viên
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content">
            
            <!-- === USER TAB === -->
            <div class="tab-pane fade show active animate__animated animate__fadeInUp" id="tab-user">
                <div class="row justify-content-center">
                    <div class="col-lg-7 col-md-10">
                        <div class="glass-card p-4 p-md-5">
                            <h4 class="text-center fw-bold mb-4">Cập Nhật Tài Khoản</h4>
                            
                            <form id="userForm">
                                <div class="mb-4 position-relative">
                                    <label class="form-label fw-bold small text-muted text-uppercase">Tìm kiếm nhân sự</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-secondary"></i></span>
                                        <select id="userSelect" class="form-select border-start-0 shadow-none" required>
                                            <option value="" selected disabled>Đang tải danh sách...</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="formContent" style="opacity: 0.5; pointer-events: none; transition: 0.3s;">
                                    <!-- Info Section -->
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-12 text-end">
                                             <button type="button" class="btn btn-link text-decoration-none p-0 small" onclick="viewHistory()">
                                                <i class="fas fa-history"></i> Xem lịch sử sửa
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="inpName" placeholder="Tên" disabled>
                                                <label>Họ và Tên</label>
                                            </div>
                                            <div class="text-end mt-1"><i class="fas fa-pen text-muted small cursor-pointer" onclick="toggleEdit('inpName')"></i></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="inpCccd" placeholder="CCCD" disabled readonly>
                                                <label>Số CCCD</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <input type="text" class="form-control" id="inpDob" placeholder="Ngày sinh" disabled>
                                                <label>Ngày sinh</label>
                                            </div>
                                            <div class="text-end mt-1"><i class="fas fa-pen text-muted small cursor-pointer" onclick="toggleEdit('inpDob')"></i></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating">
                                                <select class="form-select" id="inpGender" disabled>
                                                    <option value="Nam">Nam</option>
                                                    <option value="Nữ">Nữ</option>
                                                </select>
                                                <label>Giới tính</label>
                                            </div>
                                            <div class="text-end mt-1"><i class="fas fa-pen text-muted small cursor-pointer" onclick="toggleEdit('inpGender')"></i></div>
                                        </div>
                                    </div>

                                    <!-- Bank Section -->
                                    <div class="card border-0 bg-white shadow-sm p-4 rounded-4 mb-4">
                                        <h6 class="fw-bold text-primary mb-3"><i class="fas fa-university me-2"></i>Thông tin ngân hàng</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold small">Agribank (Bắt buộc) <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-white"><img id="logoAgri" src="" class="bank-logo-sm" alt="AGRI"></span>
                                                <input type="number" id="inpAgri" class="form-control" placeholder="Nhập số tài khoản..." required>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="form-label fw-bold small">Vietcombank</label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-white"><img id="logoVcb" src="" class="bank-logo-sm" alt="VCB"></span>
                                                <input type="number" id="inpVcb" class="form-control" placeholder="Nhập số tài khoản (nếu có)...">
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-gradient-primary w-100 rounded-pill py-3 fw-bold">
                                        <i class="fas fa-paper-plane me-2"></i> Lưu Thông Tin
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === ADMIN TAB === -->
            <div class="tab-pane fade" id="tab-admin">
                <!-- Lock Screen -->
                <div id="adminLocked" class="text-center py-5 animate__animated animate__fadeIn">
                    <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-lock fa-2x text-secondary"></i>
                    </div>
                    <h4>Khu vực giới hạn</h4>
                    <p class="text-muted">Vui lòng đăng nhập Google để quản lý dữ liệu.</p>
                </div>

                <!-- Admin Dashboard -->
                <div id="adminContent" class="d-none animate__animated animate__fadeIn">
                    
                    <!-- Stats Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="glass-card p-3 d-flex align-items-center justify-content-between h-100">
                                <div>
                                    <div class="text-muted small fw-bold text-uppercase">Tổng nhân sự</div>
                                    <h2 class="mb-0 fw-bold text-dark" id="statTotal">0</h2>
                                </div>
                                <div class="bg-primary bg-opacity-10 text-primary p-3 rounded-circle"><i class="fas fa-users fa-lg"></i></div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="glass-card p-3 d-flex align-items-center justify-content-between h-100">
                                <div>
                                    <div class="text-muted small fw-bold text-uppercase">Đã nhập</div>
                                    <h2 class="mb-0 fw-bold text-success" id="statDone">0</h2>
                                </div>
                                <div class="bg-success bg-opacity-10 text-success p-3 rounded-circle"><i class="fas fa-check-circle fa-lg"></i></div>
                            </div>
                        </div>
                        
                        <!-- Actions Toolbar -->
                        <div class="col-md-6">
                            <div class="glass-card p-3 h-100 d-flex flex-column justify-content-center gap-2">
                                <div class="d-flex gap-2">
                                    <button onclick="downloadSampleExcel()" class="btn btn-outline-secondary btn-sm flex-fill rounded-pill">
                                        <i class="fas fa-download me-1"></i> Tải Mẫu Import
                                    </button>
                                    <button onclick="document.getElementById('fileExcel').click()" class="btn btn-primary btn-sm flex-fill rounded-pill">
                                        <i class="fas fa-file-import me-1"></i> Import Excel
                                    </button>
                                    <input type="file" id="fileExcel" class="d-none" accept=".xlsx" onchange="handleImport()">
                                </div>
                                <div class="d-flex gap-2">
                                    <button onclick="exportFullExcel()" class="btn btn-success btn-sm flex-fill rounded-pill">
                                        <i class="fas fa-file-excel me-1"></i> Xuất Dữ Liệu
                                    </button>
                                    <button onclick="openAdminEditModal()" class="btn btn-dark btn-sm flex-fill rounded-pill">
                                        <i class="fas fa-plus me-1"></i> Thêm Mới
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Table -->
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <h5 class="fw-bold mb-0 text-dark"><i class="fas fa-list-ul me-2"></i>Danh Sách Chi Tiết</h5>
                            <div class="input-group" style="width: 300px;">
                                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" id="adminSearch" class="form-control border-start-0" placeholder="Tìm tên, CCCD...">
                            </div>
                        </div>

                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table custom-table">
                                <thead class="sticky-top" style="z-index: 20;">
                                    <tr>
                                        <th>Thông tin nhân viên</th>
                                        <th>CCCD / ID</th>
                                        <th style="min-width: 180px;">Agribank</th>
                                        <th style="min-width: 180px;">Vietcombank</th>
                                        <th class="text-end">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTableBody">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Admin Edit/Add -->
    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <div class="modal-header bg-dark text-white rounded-top-4">
                    <h5 class="modal-title fw-bold"><i class="fas fa-user-cog me-2"></i>Quản Lý Hồ Sơ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <form id="adminEditForm" class="row g-3">
                        <input type="hidden" id="editMode" value="add">
                        <div class="col-12">
                            <label class="fw-bold small">Họ và Tên</label>
                            <input type="text" id="admName" class="form-control bg-white" required>
                        </div>
                        <div class="col-6">
                            <label class="fw-bold small">CCCD</label>
                            <input type="text" id="admCccd" class="form-control bg-white" required>
                        </div>
                        <div class="col-6">
                            <label class="fw-bold small">Ngày sinh</label>
                            <input type="text" id="admDob" class="form-control bg-white">
                        </div>
                        <div class="col-12"><div class="border-top my-2"></div></div>
                        <div class="col-12">
                            <label class="fw-bold small text-success">Agribank</label>
                            <input type="number" id="admAgri" class="form-control bg-white" placeholder="Số tài khoản...">
                        </div>
                        <div class="col-12">
                            <label class="fw-bold small text-primary">Vietcombank</label>
                            <input type="number" id="admVcb" class="form-control bg-white" placeholder="Số tài khoản...">
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-dark w-100 py-2 rounded-pill fw-bold">Xác nhận</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: History -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Lịch sử chỉnh sửa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light rounded-bottom-4">
                    <div id="historyContent" class="d-flex flex-column gap-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, addDoc, onSnapshot, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // CẤU HÌNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const COLL_DATA = "personnel_data";
        const COLL_LOGS = "audit_logs";

        let allUsers = [];
        let currentUser = null;
        let currentData = null; // User đang chọn ở tab Nhập liệu
        
        let bankLogoAgri = "";
        let bankLogoVcb = "";

        // 1. LẤY LOGO NGÂN HÀNG API
        async function fetchLogos() {
            try {
                const res = await fetch('https://api.vietqr.io/v2/banks');
                const json = await res.json();
                const banks = json.data;
                const agri = banks.find(b=>b.code=="VBA");
                const vcb = banks.find(b=>b.code=="VCB");
                
                if(agri) { bankLogoAgri = agri.logo; document.getElementById('logoAgri').src = agri.logo; }
                if(vcb) { bankLogoVcb = vcb.logo; document.getElementById('logoVcb').src = vcb.logo; }
            } catch(e){}
        }
        fetchLogos();

        function showLoading(s) { document.getElementById('loading').style.display = s?'flex':'none'; }

        // 2. AUTH
        onAuthStateChanged(auth, (user)=>{
            currentUser = user;
            if(user) {
                document.getElementById('userInfo').textContent = `Admin: ${user.displayName}`;
                document.getElementById('btnLogin').classList.add('d-none');
                document.getElementById('btnLogout').classList.remove('d-none');
                document.getElementById('adminLocked').classList.add('d-none');
                document.getElementById('adminContent').classList.remove('d-none');
            } else {
                document.getElementById('userInfo').textContent = '';
                document.getElementById('btnLogin').classList.remove('d-none');
                document.getElementById('btnLogout').classList.add('d-none');
                document.getElementById('adminLocked').classList.remove('d-none');
                document.getElementById('adminContent').classList.add('d-none');
            }
        });
        document.getElementById('btnLogin').addEventListener('click', ()=>signInWithPopup(auth,provider));
        document.getElementById('btnLogout').addEventListener('click', ()=>signOut(auth));

        // 3. REALTIME DATA
        onSnapshot(collection(db, COLL_DATA), (snap) => {
            allUsers = [];
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="" selected disabled>-- Chọn tên của bạn --</option>';

            snap.forEach(doc => {
                const d = doc.data();
                allUsers.push(d);
                const opt = document.createElement('option');
                opt.value = d.cccd;
                opt.textContent = `${d.agribank ? '✅' : '⬜'} ${d.name} (${d.dob})`;
                select.appendChild(opt);
            });

            renderTable();
            updateStats();
        });

        // 4. LOGIC NHẬP LIỆU (USER)
        document.getElementById('userSelect').addEventListener('change', function(){
            const cccd = this.value;
            currentData = allUsers.find(u=>u.cccd==cccd);
            if(currentData) {
                const form = document.getElementById('formContent');
                form.style.opacity = "1"; form.style.pointerEvents = "auto";
                
                ['Name','Cccd','Dob','Gender','Agri','Vcb'].forEach(k => {
                    // map field name
                    let field = k.toLowerCase();
                    if(k=='Vcb') field='vietcombank';
                    if(k=='Agri') field='agribank';
                    
                    document.getElementById('inp'+k).value = currentData[field] || (k=='Gender'?'Nam':'');
                });

                // Lock fields
                document.getElementById('inpName').disabled = true;
                document.getElementById('inpDob').disabled = true;
                document.getElementById('inpGender').disabled = true;
            }
        });
        
        window.toggleEdit = function(id) { 
            let el=document.getElementById(id); 
            el.disabled=!el.disabled; if(!el.disabled) el.focus(); 
        };

        document.getElementById('userForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const data = {
                name: document.getElementById('inpName').value,
                dob: document.getElementById('inpDob').value,
                gender: document.getElementById('inpGender').value,
                agribank: document.getElementById('inpAgri').value,
                vietcombank: document.getElementById('inpVcb').value
            };
            await saveData(document.getElementById('inpCccd').value, data, currentData);
        });

        // 5. CORE SAVE
        async function saveData(cccd, newData, oldData) {
            showLoading(true);
            const changes = [];
            const editor = currentUser ? `Admin (${currentUser.email})` : "Khách";
            for(let k in newData) {
                if((oldData?.[k]||"") != (newData[k]||"")) changes.push({field:k, old:oldData?.[k]||"", new:newData[k]});
            }
            
            try {
                await setDoc(doc(db, COLL_DATA, cccd), {...newData, cccd, last_updated: new Date().toISOString()}, {merge:true});
                if(changes.length>0) {
                    await addDoc(collection(db, COLL_LOGS), {cccd_ref:cccd, editor, time:new Date().toISOString(), details:changes});
                }
                Swal.fire({icon:'success', title:'Đã lưu!', timer:1500, showConfirmButton:false});
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('adminModal'))?.hide();
            } catch(e){ Swal.fire('Lỗi',e.message,'error'); }
            finally{ showLoading(false); }
        }

        // 6. ADMIN TABLE & LOGIC
        function renderTable() {
            const tbody = document.getElementById('adminTableBody');
            const term = document.getElementById('adminSearch').value.toLowerCase();
            tbody.innerHTML = '';

            const filtered = allUsers.filter(u => (u.name?.toLowerCase().includes(term) || u.cccd?.includes(term)));
            
            filtered.forEach(u => {
                // Tách cột Agribank và Vietcombank riêng
                const row = document.createElement('tr');
                
                // Cột Agribank
                let agriCell = `<span class="bank-empty">-</span>`;
                if(u.agribank) {
                    agriCell = `<div class="bank-cell"><img src="${bankLogoAgri}" class="bank-logo-sm"> ${u.agribank}</div>`;
                }

                // Cột VCB
                let vcbCell = `<span class="bank-empty">-</span>`;
                if(u.vietcombank) {
                    vcbCell = `<div class="bank-cell"><img src="${bankLogoVcb}" class="bank-logo-sm"> ${u.vietcombank}</div>`;
                }

                row.innerHTML = `
                    <td>
                        <div class="fw-bold text-dark">${u.name}</div>
                        <div class="small text-muted"><i class="fas fa-venus-mars me-1"></i>${u.gender} | <i class="fas fa-birthday-cake me-1"></i>${u.dob}</div>
                    </td>
                    <td><span class="badge bg-light text-dark border">${u.cccd}</span></td>
                    <td>${agriCell}</td>
                    <td>${vcbCell}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light border" onclick="editUser('${u.cccd}')"><i class="fas fa-pen text-primary"></i></button>
                        <button class="btn btn-sm btn-light border" onclick="deleteUser('${u.cccd}')"><i class="fas fa-trash text-danger"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        document.getElementById('adminSearch').addEventListener('keyup', renderTable);
        function updateStats(){
            document.getElementById('statTotal').innerText = allUsers.length;
            document.getElementById('statDone').innerText = allUsers.filter(u=>u.agribank).length;
        }

        // 7. ADMIN ACTIONS
        window.editUser = function(cccd) {
            const u = allUsers.find(x=>x.cccd==cccd);
            document.getElementById('editMode').value = 'update';
            document.getElementById('admCccd').value = u.cccd; 
            document.getElementById('admCccd').readOnly = true;
            document.getElementById('admName').value = u.name;
            document.getElementById('admDob').value = u.dob;
            document.getElementById('admAgri').value = u.agribank||"";
            document.getElementById('admVcb').value = u.vietcombank||"";
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        };

        window.openAdminEditModal = function() {
            document.getElementById('adminEditForm').reset();
            document.getElementById('editMode').value = 'add';
            document.getElementById('admCccd').readOnly = false;
            new bootstrap.Modal(document.getElementById('adminModal')).show();
        }

        document.getElementById('adminEditForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const cccd = document.getElementById('admCccd').value;
            const mode = document.getElementById('editMode').value;
            if(mode=='add' && allUsers.some(u=>u.cccd==cccd)) return Swal.fire('Lỗi','CCCD đã tồn tại','error');
            
            const oldData = allUsers.find(u=>u.cccd==cccd) || {};
            const data = {
                name: document.getElementById('admName').value,
                dob: document.getElementById('admDob').value,
                agribank: document.getElementById('admAgri').value,
                vietcombank: document.getElementById('admVcb').value,
                gender: oldData.gender || 'Nam'
            };
            await saveData(cccd, data, oldData);
        });

        window.deleteUser = async function(cccd) {
            if((await Swal.fire({title:'Xóa?', icon:'warning', showCancelButton:true})).isConfirmed) {
                await deleteDoc(doc(db, COLL_DATA, cccd));
                Swal.fire('Đã xóa','','success');
            }
        }

        // 8. TÍNH NĂNG TẢI MẪU IMPORT (NEW)
        window.downloadSampleExcel = function() {
            // Dữ liệu mẫu
            const sampleData = [
                { "Họ tên": "Nguyễn Văn A", "CCCD": "001234567890", "Ngày sinh": "01/01/1990", "Giới tính": "Nam" },
                { "Họ tên": "Trần Thị B", "CCCD": "001234567891", "Ngày sinh": "20/10/1995", "Giới tính": "Nữ" }
            ];
            const ws = XLSX.utils.json_to_sheet(sampleData);
            // Chỉnh độ rộng cột
            ws['!cols'] = [ {wch:25}, {wch:20}, {wch:15}, {wch:10} ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Mau_Import");
            XLSX.writeFile(wb, "Mau_Danh_Sach_Nhan_Vien.xlsx");
        }

        // Import
        window.handleImport = function() {
            const f = document.getElementById('fileExcel').files[0];
            if(!f) return;
            showLoading(true);
            const r = new FileReader();
            r.onload = async(e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                for(let row of data) {
                    let cccd = row['CCCD']||row['cccd'];
                    if(cccd) {
                        cccd = String(cccd);
                        await setDoc(doc(db, COLL_DATA, cccd), {
                            cccd, name: row['Họ tên']||row['Name'],
                            dob: row['Ngày sinh']||row['DOB']||'',
                            gender: row['Giới tính']||row['Gender']||'Nam'
                        }, {merge:true});
                    }
                }
                showLoading(false);
                Swal.fire('Thành công','Đã import danh sách','success');
                document.getElementById('fileExcel').value='';
            }
            r.readAsArrayBuffer(f);
        }

        // Export Full
        window.exportFullExcel = function() {
            const data = allUsers.map(u => ({
                "Họ tên": u.name, "CCCD": u.cccd, "Ngày sinh": u.dob, "Giới tính": u.gender,
                "TK Agribank": u.agribank, "TK Vietcombank": u.vietcombank, "Cập nhật": u.last_updated
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, "Du_Lieu_Full.xlsx");
        }

        // View History
        window.viewHistory = async function() {
            if(!currentData) return;
            const q = query(collection(db, COLL_LOGS), where("cccd_ref","==",currentData.cccd), orderBy("time","desc"));
            const snap = await getDocs(q);
            const div = document.getElementById('historyContent');
            div.innerHTML = "";
            if(snap.empty) div.innerHTML = "Chưa có lịch sử.";
            snap.forEach(d => {
                const log = d.data();
                let det = log.details.map(x=>`<div><b>${x.field}</b>: <span class='text-decoration-line-through text-muted'>${x.old}</span> <i class='fas fa-arrow-right small'></i> <span class='text-success fw-bold'>${x.new}</span></div>`).join('');
                div.innerHTML += `<div class='card p-3 shadow-sm border-0'><small class='text-muted'>${new Date(log.time).toLocaleString()} - ${log.editor}</small><div class='mt-2'>${det}</div></div>`;
            });
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
