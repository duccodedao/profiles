<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu app - Vĩnh Trạch Đông</title>
    <link rel="icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    
    <!-- SEO & PWA Meta Tags -->
    <meta name="description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <link rel="icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    <link rel="apple-touch-icon" href="https://hdd.io.vn/img/bmassloadings.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hub Vĩnh Trạch Đông">
    <link rel="manifest" href="/js/applinkicon.jsonn">
    <meta name="theme-color" content="#4f46e5">

    <!-- Social Media Meta -->
    <meta property="og:title" content="Hub Portal - Vĩnh Trạch Đông">
    <meta property="og:description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <meta property="og:image" content="https://bmass.vercel.app/img/bmasslogo.png">
    <meta property="og:type" content="website">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Excel Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4f46e5', secondary: '#f43f5e', dark: '#020617' } } }
        }
    </script>
    <style>
        /* ADDED: Styles for Sidebar */
        .admin-sidebar { 
            width: 0; 
            transition: width 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .admin-sidebar.open {
            width: 28rem; /* Equivalent to max-w-xl in Tailwind, adjust as needed */
            min-width: 320px; /* Ensures a minimum size on small screens */
        }
        @media (max-width: 768px) {
            .admin-sidebar.open { width: 100%; }
        }
        
        /* NEW: Mobile Category Sidebar */
        .mobile-category-sidebar { 
            width: 0; 
            transition: width 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .mobile-category-sidebar.open {
            width: 75%;
            max-width: 300px;
        }
        /* END ADDED */
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; padding-bottom: 100px; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .app-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drag-ghost { opacity: 0.3; background: #4f46e5 !important; border-radius: 1rem; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .dark .tab-active { color: #818cf8; border-bottom: 2px solid #818cf8; }
        .app-item.selected-for-delete { box-shadow: 0 0 0 3px #f43f5e; border-radius: 1rem; }
        
        /* FIX: Header and Announcement Bar Position */
        header { 
            top: 0;
            transition: top 0.3s; /* Smooth transition for header position */
        }
        #announcement-bar:not(.hidden) ~ header { 
            top: 32px; 
        }
        
        /* Custom Marquee */
        .marquee { overflow: hidden; white-space: nowrap; box-sizing: border-box; }
        .marquee > div { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        
        /* Custom Logo Loader - Zoom In/Out */
        .logo-loader {
            width: 24px;
            height: 24px;
            animation: zoom-logo 1.5s ease-in-out infinite; /* Thay đổi animation */
        }

        @keyframes zoom-logo {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2); /* Phóng to */
            }
            100% {
                transform: scale(1); /* Thu nhỏ lại */
            }
        }
        
        /* NEW: Mobile Footer Height & Padding Correction */
        @media (max-width: 768px) {
            body { padding-bottom: 80px; } /* Footer height approx 60px + padding */
            #main-content-wrapper { padding-bottom: 10px; } /* Reduce padding at the bottom of main content */
            #category-bar { display: none !important; } /* Hide desktop category bar on mobile */
            header { padding-right: 0; } /* Remove right padding on mobile */
            .mobile-hidden { display: none !important; }
        }
        
        /* NEW: Mobile-like Toast Styling & Transitions */
        #toast {
            bottom: 20px;
            right: 50%;
            left: 50%;
            transform: translate(-50%, 100%); /* Start position: bottom center, off-screen */
            opacity: 0;
            transition: all 0.4s ease-out; /* Smooth transition */
            max-width: 90%;
            width: auto;
            min-width: 250px;
            pointer-events: none; /* Allows clicks through when hidden */
        }
        
        #toast.visible {
            transform: translate(-50%, 0); /* End position: bottom center, on-screen */
            opacity: 1;
            pointer-events: auto; /* Enables interaction when visible */
        }

        /* FIXED: Desktop Footer position */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body class="min-h-screen pb-24">
    
    <!-- NEW: Global Loading Overlay -->
    <div id="global-loading-overlay" class="fixed inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm z-[900] flex flex-col items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
        <img src="https://hdd.io.vn/img/bmassloadings.png" class="logo-loader w-12 h-12" alt="Loading Logo">
        <!-- NEW: Loading Timeout Warning -->
        <div id="loading-timeout-warning" class="mt-8 p-4 bg-yellow-500/10 text-yellow-500 rounded-xl text-sm font-bold hidden flex-col items-center space-y-3">
             <p>Việc tải đang mất nhiều thời gian hơn dự kiến (30s+). Vui lòng chọn:</p>
             <div class="flex gap-4">
                 <button onclick="window.location.reload()" class="bg-yellow-500 text-white px-5 py-2 rounded-lg text-xs uppercase font-bold hover:bg-yellow-600 transition">TẢI LẠI TRANG</button>
                 <button onclick="document.getElementById('loading-timeout-warning').classList.add('hidden');" class="bg-slate-500 text-white px-5 py-2 rounded-lg text-xs uppercase font-bold hover:bg-slate-600 transition">TIẾP TỤC ĐỢI</button>
             </div>
        </div>
        <!-- End Loading Timeout Warning -->
    </div>
    
    <!-- NEW: Maintenance Mode Overlay -->
    <div id="maintenance-overlay" class="fixed inset-0 bg-white dark:bg-slate-900 z-[500] flex flex-col items-center justify-center p-8 text-center hidden">
        <i data-lucide="wrench" class="w-16 h-16 text-primary mb-4"></i>
        <h2 class="text-3xl font-black text-primary dark:text-white mb-2">CHẾ ĐỘ BẢO TRÌ</h2>
        <p class="text-slate-500 dark:text-slate-400 max-w-md">
            Hệ thống đang được bảo trì và nâng cấp. Khách truy cập tạm thời không thể xem nội dung. Vui lòng quay lại sau.
        </p>
        <p id="maintenance-admin-info" class="text-sm font-bold mt-4 text-red-500 hidden">(Admin đang thao tác. Dữ liệu vẫn được truy cập qua chế độ quản trị.)</p>
    </div>
    
    <!-- NEW: Announcement Bar (Fixed to top) -->
    <div id="announcement-bar" class="fixed top-0 left-0 w-full z-[101] bg-secondary text-white text-xs font-bold py-2 shadow-md hidden">
        <div class="marquee">
            <div id="announcement-text"></div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="sticky top-0 z-[100] glass px-6 py-3 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <!-- NEW: Mobile Category Toggle (Only visible on mobile) -->
            <button onclick="window.toggleMobileCategorySidebar()" id="mobile-category-toggle" class="p-2 rounded-xl text-slate-600 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 transition md:hidden"><i data-lucide="menu" class="w-5 h-5"></i></button>

            <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg p-1">
                <img src="https://hdd.io.vn/img/bmassloadings.png" alt="Hub Logo" class="w-full h-full object-contain rounded-lg">
            </div>
            <div>
                <h1 class="text-xs font-black tracking-tighter uppercase leading-none">Hub Portal</h1>
                <span id="role-status" class="text-[9px] font-bold text-slate-400">GUEST</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Nút Mở Sidebar Admin (NEW) -->
            <button onclick="window.toggleAdminSidebar()" id="admin-sidebar-toggle" class="p-2 rounded-xl text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition hidden"><i data-lucide="settings-2" class="w-5 h-5"></i></button>

            <!-- Desktop View Mode Toggles (Hidden on mobile) -->
            <div class="mobile-hidden flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                <button onclick="window.setView('grid')" id="view-grid-btn" class="p-1.5 rounded-md transition-all shadow-sm bg-white dark:bg-slate-700"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                <button onclick="window.setView('list')" id="view-list-btn" class="p-1.5 rounded-md transition-all"><i data-lucide="list" class="w-4 h-4"></i></button>
            </div>
            
            <!-- Desktop Theme Toggle -->
            <button onclick="window.toggleTheme()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition mobile-hidden">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden text-slate-600"></i>
            </button>
            
            <div id="auth-section">
                <!-- Auth UI rendered by JS -->
            </div>
        </div>
    </header>

    <!-- NEW: Mobile Category Sidebar (Slide-in from left) -->
    <div id="mobile-category-sidebar" class="mobile-category-sidebar fixed top-0 left-0 bottom-0 bg-white dark:bg-slate-900 border-r dark:border-white/10 shadow-2xl z-[200] flex flex-col pt-0 md:hidden">
        <!-- Sidebar Header (Updated) -->
        <div class="p-6 border-b dark:border-white/5 flex flex-col items-start justify-between">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-8 h-8 flex items-center justify-center p-0.5">
                    <img src="https://hdd.io.vn/img/bmassloadings.png" alt="Hub Logo" class="w-full h-full object-contain rounded-lg">
                </div>
                <h3 class="text-sm font-black tracking-tighter uppercase leading-none">Hub Portal</h3>
            </div>
            <div class="flex items-center justify-between w-full">
                <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">DANH MỤC</h3>
                <button onclick="window.toggleMobileCategorySidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
        <!-- Sidebar Content -->
        <div id="category-bar-mobile" class="flex-1 overflow-y-auto p-6 space-y-2">
            <!-- Categories will be rendered here -->
        </div>
    </div>

    <!-- Main Content and Admin Sidebar Wrapper -->
    <div id="main-content-wrapper" class="flex max-w-7xl mx-auto">
        <!-- Main Content -->
        <main class="flex-1 p-6 space-y-8 min-w-0">
            <!-- Search -->
            <div id="search-container" class="relative max-w-2xl mx-auto">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="search-input" placeholder="Tìm ứng dụng hoặc danh bạ..." 
                    class="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-2xl focus:ring-4 ring-primary/10 outline-none shadow-sm">
            </div>

            <!-- Visit Stats Container -->
            <div id="visit-stats-container" class="max-w-4xl mx-auto p-4 rounded-3xl bg-slate-100 dark:bg-slate-900/50">
                <div class="flex items-center justify-center h-20 text-slate-400">Đang tải thống kê...</div>
            </div>

            <!-- Admin Request Form (NEW) -->
            <div id="request-admin-section" class="max-w-4xl mx-auto hidden p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-3xl border border-yellow-200 dark:border-yellow-700 space-y-4">
                <h3 class="text-xl font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="key" class="w-6 h-6"></i> Xin Cấp Quyền Quản Trị</h3>
                <p id="request-admin-status" class="text-sm font-medium text-yellow-700 dark:text-yellow-300">
                    Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu để Admin chính duyệt.
                </p>
                <form id="request-admin-form" class="flex gap-4">
                    <input type="text" id="request-admin-reason" placeholder="Lý do xin cấp quyền..." required class="flex-1 px-5 py-3 bg-white dark:bg-slate-800 rounded-xl outline-none focus:ring-2 ring-yellow-500 text-sm">
                    <button type="submit" class="bg-yellow-500 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-yellow-600 transition">GỬI YÊU CẦU</button>
                </form>
            </div>
            
            <!-- Categories (Desktop Only) -->
            <div id="category-bar" class="mobile-hidden flex flex-wrap gap-2"></div>
            
            <!-- Main Content Tabs -->
            <div id="main-tabs-content">
                <!-- Tab: App (Home) / Danh bạ (Contacts) Content -->
                <div id="tab-app-content">
                    <!-- App Loading State (UPDATED: Logo Loading) -->
                    <div id="app-loading" class="text-center p-16 text-slate-400 text-sm font-medium hidden">
                        <img src="/img/bmassloadings.png" class="logo-loader w-6 h-6 mx-auto mb-2" alt="Loading Logo">
                        Đang tải ứng dụng...
                    </div>

                    <!-- Main Content App -->
                    <div id="app-container"></div>
                </div>

                <!-- Tab: Notification Content (NEW) -->
                <div id="tab-notify-content" class="hidden max-w-4xl mx-auto">
                    <h3 class="text-xl font-black text-primary dark:text-white mb-6 border-b pb-2 px-2">THÔNG BÁO MỚI</h3>
                    <div id="notification-content-list" class="space-y-4">
                        <div class="p-16 text-center">
                            <i data-lucide="bell" class="w-12 h-12 text-primary mx-auto mb-4"></i>
                            <p class="text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                                Đang tải các thông báo...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Discover Content -->
                <div id="tab-discover-content" class="hidden max-w-4xl mx-auto">
                    <h3 class="text-xl font-black text-primary dark:text-white mb-6 border-b pb-2 px-2">KHÁM PHÁ</h3>
                    <div id="discover-content-list" class="space-y-4">
                        <div class="p-16 text-center">
                            <i data-lucide="compass" class="w-12 h-12 text-primary mx-auto mb-4"></i>
                            <p class="text-slate-500 dark:text-slate-400 max-w-md mx-auto">
                                Đang tải các tiện ích khám phá...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Profile Content -->
                <div id="tab-profile-content" class="hidden max-w-lg mx-auto p-4">
                    <h3 class="mobile-hidden text-xl font-black text-primary dark:text-white mb-6 border-b pb-2">THÔNG TIN CÁ NHÂN</h3>
                    <div id="profile-content-details" class="space-y-4">
                        <p class="text-slate-500 dark:text-slate-400">Vui lòng đăng nhập để xem thông tin cá nhân.</p>
                        <!-- Populated by JS on load/login -->
                    </div>
                    
                    <div id="profile-action-panel" class="space-y-4 mt-8">
                         <!-- Admin Panel Button (Conditionally Rendered) -->
                        <button id="profile-admin-panel-btn" onclick="window.toggleAdminSidebar()" class="hidden w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs flex items-center justify-center gap-2 hover:bg-indigo-600 transition">
                            <i data-lucide="settings" class="w-4 h-4"></i> ADMIN PANEL
                        </button>
                        
                        <div class="grid grid-cols-2 gap-4">
                             <a href="#" onclick="window.showToast('Bảo mật 2 yếu tố sắp ra mắt!', false)" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="shield-check" class="w-5 h-5 text-primary"></i>
                                <span class="text-xs font-bold">Tài khoản & Bảo mật (2FA Sắp ra mắt)</span>
                            </a>
                             <a href="#" target="_blank" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="lock" class="w-5 h-5 text-primary"></i>
                                <span class="text-xs font-bold">Quyền riêng tư</span>
                            </a>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Theme Toggle (Now with dynamic icon) -->
                            <button onclick="window.toggleTheme()" id="profile-theme-toggle" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="${document.documentElement.classList.contains('dark') ? 'sun' : 'moon'}" class="w-5 h-5 text-primary"></i>
                                <span class="text-xs font-bold">Chế độ Sáng/Tối</span>
                            </button>
                            <!-- Language Toggle -->
                            <button onclick="window.setLang(currentLang === 'vi' ? 'en' : 'vi')" id="profile-lang-toggle" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="globe" class="w-5 h-5 text-primary"></i>
                                <span id="current-lang-text" class="text-xs font-bold">Ngôn ngữ: VI</span>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <a href="chat.html" target="_blank" class="w-full py-3 bg-secondary text-white rounded-xl font-bold text-xs uppercase shadow-lg hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i data-lucide="life-buoy" class="w-4 h-4"></i> TRỢ GIÚP & HỖ TRỢ
                            </a>
                            <!-- NEW: Logout button moved here for symmetry -->
                            <button onclick="window.logout()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg uppercase text-xs hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-4 h-4"></i> ĐĂNG XUẤT
                            </button>
                        </div>

                    </div>

                </div>

            </div>
            
            <!-- Bulk Delete Floating Dock -->
            <div id="bulk-delete-dock" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 z-[110]">
                <div class="bg-red-600 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-4">
                    <span id="selected-count">0</span> mục đã chọn
                    <button onclick="window.executeBulkDelete()" class="flex items-center gap-2 px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold shadow-lg uppercase">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> CHUYỂN VÀO THÙNG RÁC
                    </button>
                </div>
            </div>
        </main>

        <!-- Admin Sidebar (NEW) -->
        <div id="admin-sidebar" class="admin-sidebar fixed right-0 top-0 bottom-0 bg-white dark:bg-slate-900 border-l dark:border-white/10 shadow-2xl z-[150] flex flex-col pt-16">
            <!-- Sidebar Header / Controls -->
            <div id="sidebar-controls" class="p-6 border-b dark:border-white/5 flex flex-col gap-3">
                 <div class="flex items-center justify-between">
                    <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">QUẢN TRỊ VIÊN</h3>
                    <button onclick="window.toggleAdminSidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
                 <div class="flex items-center gap-3">
                    <button onclick="window.openAppModal()" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary text-white rounded-xl text-xs font-bold shadow-lg">
                        <i data-lucide="plus" class="w-4 h-4"></i> THÊM ỨNG DỤNG
                    </button>
                    <button onclick="window.toggleBulkDelete()" id="bulk-delete-sidebar-toggle" class="p-3 rounded-xl text-red-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition flex items-center justify-center"><i data-lucide="scissors" class="w-5 h-5"></i></button>
                 </div>
            </div>

            <!-- Sidebar Tabs -->
            <div class="p-6 border-b dark:border-white/5">
                <div class="flex flex-wrap gap-2 text-[10px] font-black tracking-widest text-slate-400">
                    <button onclick="window.switchTab('tab-cat')" id="btn-tab-cat" class="text-primary border-b-2 border-primary pb-1">DANH MỤC</button>
                    <button onclick="window.switchTab('tab-trash')" id="btn-tab-trash" class="pb-1 uppercase">THÙNG RÁC</button>
                    <button onclick="window.switchTab('tab-announcement')" id="btn-tab-announcement" class="pb-1 uppercase">THÔNG BÁO</button>
                    <button onclick="window.switchTab('tab-deputy')" id="btn-tab-deputy" class="pb-1 uppercase">PHÓ ADMIN</button>
                    <button onclick="window.switchTab('tab-request')" id="btn-tab-request" class="pb-1 uppercase flex items-center gap-1">YÊU CẦU ADM <span id="request-count" class="text-red-500">(0)</span></button>
                    <button onclick="window.switchTab('tab-logs')" id="btn-tab-logs" class="pb-1 uppercase">NHẬT KÝ</button>
                    <button onclick="window.switchTab('tab-data')" id="btn-tab-data" class="pb-1 uppercase">DỮ LIỆU</button>
                </div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <!-- Tab Categories -->
                <div id="tab-cat" class="space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Quản lý Danh mục</h4>
                    <div class="flex flex-col gap-2">
                        <input type="text" id="new-cat-name" placeholder="Tên danh mục..." class="px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                        <div class="flex gap-2">
                             <input type="text" id="new-cat-icon" placeholder="Link Icon..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                             <button onclick="window.addCategory()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">Thêm</button>
                        </div>
                    </div>
                    <ul id="cat-list-admin" class="space-y-2"></ul>
                </div>
                
                <!-- Tab Soft Delete (NEW) -->
                <div id="tab-trash" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Thùng rác (Ứng dụng đã xóa)</h4>
                    <div id="trash-list" class="space-y-2">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Thùng rác trống.</div>
                    </div>
                    <button onclick="window.clearTrashConfirm(true)" id="clear-trash-btn" class="w-full py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg uppercase text-xs hidden">DỌN SẠCH VĨNH VIỄN</button>
                </div>
                <!-- End Tab Soft Delete -->
                
                <!-- Tab Announcement & Notification Feed Creator (UPDATED) -->
                <div id="tab-announcement" class="hidden space-y-8">
                    
                    <h4 class="text-sm font-black uppercase tracking-widest text-primary border-b pb-2">Thông báo Chạy chữ (Marquee)</h4>
                    <textarea id="announcement-content" placeholder="Nội dung thông báo (ngắn gọn, lặp lại)" rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                    
                    <!-- NEW: Schedule Inputs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Bắt đầu từ</label>
                            <input type="datetime-local" id="announcement-start" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Kết thúc vào</label>
                            <input type="datetime-local" id="announcement-end" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium">
                        </div>
                    </div>
                    <!-- End NEW -->
                    
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5">
                        <label class="text-sm font-bold opacity-60">Kích hoạt Thông báo Chạy chữ</label>
                        <div class="flex gap-2">
                           <button onclick="window.saveAnnouncementContent(true)" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all bg-primary text-white hover:bg-indigo-600">LƯU & BẬT</button>
                           <button id="toggle-announcement-btn" onclick="window.toggleAnnouncementStatus()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all">Tắt / Bật</button>
                        </div>
                    </div>
                    
                    <!-- New Section: Notification Feed Creator -->
                    <div class="space-y-4 pt-6 border-t dark:border-white/5">
                        <h4 class="text-sm font-black uppercase tracking-widest text-secondary border-b pb-2">Tạo Thông Báo Mới (Notification Feed)</h4>
                        <input type="text" id="notify-title" placeholder="Tiêu đề thông báo..." class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-bold">
                        <textarea id="notify-content" placeholder="Nội dung chi tiết..." rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                        <input type="text" id="notify-icon" placeholder="Icon URL (Để trống để dùng Icon mặc định)" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium">
                        <button onclick="window.publishNotification()" class="w-full py-4 bg-secondary text-white rounded-xl font-bold shadow-lg uppercase text-xs hover:bg-red-600 transition">ĐĂNG THÔNG BÁO</button>
                    </div>

                    <!-- New Section: List/Manage Notifications -->
                    <div class="space-y-4 pt-6 border-t dark:border-white/5">
                        <h4 class="text-sm font-black uppercase tracking-widest text-slate-500 border-b pb-2">Danh sách Thông báo đã đăng</h4>
                        <div id="admin-notify-list" class="space-y-2">
                             <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Đang tải danh sách...</div>
                        </div>
                    </div>
                    <!-- End List/Manage Notifications -->

                </div>
                <!-- End Tab Announcement -->

                <!-- Tab Deputy -->
                <div id="tab-deputy" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Cấp/Thu hồi quyền Phó Admin</h4>
                    <div id="deputy-guard" class="hidden p-4 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-xl text-xs font-bold uppercase">Chỉ Super Admin mới quản lý được mục này.</div>
                    <div id="deputy-ui" class="space-y-4">
                        <div class="flex gap-2">
                            <input type="email" id="new-deputy-email" placeholder="Gmail phó admin..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                            <button onclick="window.addDeputy()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">CẤP QUYỀN</button>
                        </div>
                        <div id="deputy-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tab Admin Requests (NEW) -->
                <div id="tab-request" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Yêu Cầu Cấp Quyền</h4>
                    <div id="requests-list" class="space-y-2">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Không có yêu cầu mới.</div>
                    </div>
                </div>
                <!-- End Tab Admin Requests -->

                <!-- Tab Activity Logs (NEW) -->
                <div id="tab-logs" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Nhật ký Hoạt động</h4>
                    <div id="logs-list" class="space-y-2 max-h-[50vh] overflow-y-auto">
                        <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl text-center text-slate-400">Đang tải nhật ký...</div>
                    </div>
                </div>
                <!-- End Tab Activity Logs -->


                <!-- Tab Data Export/Import -->
                <div id="tab-data" class="hidden space-y-8">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Xuất/Nhập Dữ Liệu & Bảo Trì</h4>
                    <div class="grid gap-6">
                        
                        <!-- Maintenance Mode Toggle (NEW) -->
                        <div class="p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-[2rem] border border-yellow-200 dark:border-yellow-700 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-yellow-700 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="shield-alert" class="w-4 h-4"></i> CHẾ ĐỘ BẢO TRÌ</h4>
                            <p class="text-sm text-yellow-800 dark:text-yellow-300">
                                Bật chế độ này để ẩn toàn bộ nội dung với Khách (Guest). Chỉ Admin mới có thể truy cập.
                            </p>
                            <div class="flex items-center justify-between">
                                <span id="maintenance-status" class="text-sm font-bold">Trạng thái: Tắt</span>
                                <button onclick="window.toggleMaintenanceMode()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all bg-slate-500 text-white" id="maintenance-toggle-btn">BẬT CHẾ ĐỘ</button>
                            </div>
                        </div>
                        
                        <!-- Browser Notification Permission -->
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-primary flex items-center gap-2"><i data-lucide="bell" class="w-4 h-4"></i> THÔNG BÁO TRÌNH DUYỆT</h4>
                            <p id="browser-notify-status" class="text-sm text-slate-500 dark:text-slate-400">Trạng thái: Đang tải...</p>
                            <button onclick="window.requestBrowserNotificationPermission()" id="request-notify-btn" class="w-full py-3 bg-primary text-white rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-indigo-600 transition hidden">YÊU CẦU CẤP QUYỀN</button>
                        </div>


                        <!-- Export -->
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-primary">Xuất dữ liệu</h4>
                            <div class="flex flex-col gap-2">
                                <button onclick="window.handleExport('json')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm">
                                    <span class="text-sm font-bold">Xuất file JSON</span>
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.handleExport('excel')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm">
                                    <span class="text-sm font-bold">Xuất file EXCEL</span>
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Import -->
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-secondary">Nhập dữ liệu</h4>
                            <div class="relative">
                                <input type="file" id="import-file" accept=".json, .xlsx" onchange="window.handleImport(event)" class="hidden">
                                <label for="import-file" class="flex items-center justify-center gap-3 w-full px-5 py-4 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-xl cursor-pointer hover:opacity-90 transition font-bold text-xs uppercase">
                                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                                    Chọn file để khôi phục
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer (Desktop Only) -->
    <footer class="mobile-hidden w-full z-50 bg-white dark:bg-slate-900 border-t dark:border-white/10 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="max-w-7xl mx-auto px-6 py-3 flex justify-between items-center text-sm">
            <div class="text-slate-500 dark:text-slate-400">
                © 2024 Vĩnh Trạch Đông. All rights reserved.
            </div>
            <div class="flex items-center gap-4">
                <a href="#" class="text-xs font-bold text-slate-500 hover:text-primary transition">Privacy Policy</a>
                <a href="chat.html" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-secondary text-white rounded-lg font-bold text-xs uppercase shadow-lg hover:opacity-90 transition">
                    <i data-lucide="life-buoy" class="w-4 h-4"></i> TRỢ GIÚP
                </a>
            </div>
        </div>
    </footer>

    <!-- NEW: Mobile Tab Bar (Fixed Bottom Navigation) (UPDATED) -->
    <nav id="mobile-nav-bar" class="fixed bottom-0 left-0 w-full z-100 bg-white dark:bg-slate-900 border-t dark:border-white/10 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] md:hidden">
        <div class="flex justify-around items-center h-16">
            <button onclick="window.switchMobileTab('app')" id="tab-app-btn" class="flex flex-col items-center justify-center w-full h-full text-primary">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span class="text-[9px] font-bold mt-1">Ứng Dụng</span>
            </button>
            <button onclick="window.switchMobileTab('contact')" id="tab-contact-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="text-[9px] font-bold mt-1">Danh Bạ</span>
            </button>
            <!-- UPDATED: Replaced Discover with Notify (Bell) -->
            <button onclick="window.switchMobileTab('notify')" id="tab-notify-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <div class="relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <!-- NEW: Unread Count Badge (FIXED position) -->
                    <span id="unread-count" class="absolute -top-1 -right-1 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-[8px] font-black px-1.5 rounded-full hidden">0</span>
                </div>
                <span class="text-[9px] font-bold mt-1">Thông Báo</span>
            </button>
            <button onclick="window.switchMobileTab('profile')" id="tab-profile-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <i data-lucide="user-circle" class="w-5 h-5"></i>
                <span class="text-[9px] font-bold mt-1">Cá Nhân</span>
            </button>
        </div>
    </nav>
    <!-- End Mobile Tab Bar -->


    <!-- App Modal (No Changes) -->
    <div id="modal-app" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="app-modal-title" class="font-bold uppercase text-sm tracking-widest">Cấu hình</h3>
                <button onclick="window.closeModal('modal-app')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="app-form" class="p-8 space-y-4">
                <input type="hidden" id="edit-id">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh mục</label>
                    <select id="app-category" onchange="window.toggleFormFields()" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select>
                </div>
                <div class="space-y-1">
                    <label id="label-name" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tên hiển thị</label>
                    <input type="text" id="app-name" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div id="field-position" class="space-y-1 hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Chức vụ</label>
                    <input type="text" id="app-position" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label id="label-link" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Link URL</label>
                    <input type="text" id="app-link" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Icon URL</label>
                    <input type="text" id="app-icon" placeholder="Để trống để tự lấy" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium">
                </div>
                <div class="flex items-center gap-3 p-2">
                    <input type="checkbox" id="app-visible" checked class="w-5 h-5 accent-primary">
                    <label class="text-xs font-bold opacity-60">Hiển thị công khai</label>
                </div>
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg shadow-indigo-500/30 uppercase text-xs">Lưu ứng dụng</button>
            </form>
        </div>
    </div>

    <!-- User Profile Modal (No Changes) -->
    <div id="modal-user-profile" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">Thông tin Tài khoản</h3>
                <button onclick="window.closeModal('modal-user-profile')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="flex flex-col items-center">
                    <img id="profile-photo" class="w-20 h-20 rounded-full mb-3 border-4 border-primary/20 p-0.5 shadow-md" alt="Avatar">
                    <span id="profile-role" class="text-[10px] font-black uppercase tracking-widest px-3 py-1 bg-primary/10 text-primary rounded-full"></span>
                </div>

                <div class="space-y-4">
                    <!-- Editable Field Example (Name) -->
                    <div class="space-y-1 group relative">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tên hiển thị</label>
                        <input type="text" id="profile-name" readonly class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium border-none pr-10">
                        <button onclick="alert('Tính năng chỉnh sửa thông tin Google được chuyển qua mục Nâng cao.')" class="absolute right-3 top-1/2 mt-2 p-1 text-slate-400 hover:text-primary opacity-0 group-hover:opacity-100 transition"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    </div>

                    <!-- Non-Editable Fields -->
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Email</label>
                        <input type="email" id="profile-email" readonly class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl text-slate-500 dark:text-slate-400 text-sm font-medium border-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">UID Firebase</label>
                        <p id="profile-uid" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl text-xs font-mono truncate"></p>
                    </div>
                    <!-- REMOVED: Favorites Count -->
                </div>

                <a href="https://myaccount.google.com/?utm_source=hub-portal-vtd" target="_blank" class="w-full py-3 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded-xl font-bold shadow-sm uppercase text-xs flex items-center justify-center gap-2 hover:bg-slate-300 transition">
                    <i data-lucide="external-link" class="w-4 h-4"></i> Nâng cao: Quản lý tài khoản Google
                </a>
            </div>
        </div>
    </div>
    
    <!-- Modal for Category Delete/Migrate (NEW) -->
    <div id="modal-cat-migrate" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-red-500">Chuyển đổi Ứng dụng trước khi Xóa</h3>
                <button onclick="window.closeModal('modal-cat-migrate')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-4">
                <p id="cat-migrate-message" class="text-sm text-slate-700 dark:text-slate-300">
                    Danh mục này có <span id="cat-migrate-count" class="font-bold">0</span> ứng dụng. Vui lòng chọn danh mục mới để chuyển các ứng dụng này đến trước khi xóa.
                </p>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh mục mới</label>
                    <select id="cat-migrate-select" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select>
                </div>
                <button onclick="window.executeCatDeleteAndMigrate()" class="w-full py-4 bg-red-500 text-white rounded-xl font-bold shadow-lg uppercase text-xs hover:bg-red-600 transition">XÁC NHẬN XÓA & CHUYỂN ĐỔI</button>
            </div>
        </div>
    </div>
    <!-- End Modal for Category Delete/Migrate -->

    <!-- Notification Toast (MODIFIED: Mobile style & interaction) -->
    <div id="toast" class="fixed z-[300]" onclick="window.closeToast()" ontouchstart="window.handleToastTouchStart(event)" ontouchmove="window.handleToastTouchMove(event)" ontouchend="window.handleToastTouchEnd(event)">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border dark:border-white/10">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg" class="text-sm font-bold tracking-tight">Thành công!</span>
        </div>
    </div>
    <!-- End Notification Toast -->
    


    <!-- Custom Confirmation Modal (NEW) -->
<div id="modal-confirm" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[220] hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-sm shadow-2xl overflow-hidden">
        <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
            <h3 id="confirm-modal-title" class="font-bold uppercase text-sm tracking-widest text-red-500">Xác nhận Thao tác</h3>
            <button onclick="window.closeModal('modal-confirm')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-8 space-y-6">
            <p id="confirm-modal-message" class="text-sm text-slate-700 dark:text-slate-300">Bạn có chắc chắn muốn thực hiện thao tác này?</p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closeModal('modal-confirm')" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 transition">Hủy</button>
                <button id="confirm-modal-btn" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-red-500 text-white shadow-lg hover:bg-red-600 transition">Xác nhận</button>
            </div>
        </div>
    </div>
</div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // MODIFIED: Added arrayRemove and getDocs (for notification cleanup)
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch, increment, runTransaction, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const LOGS_COLLECTION = "activityLogs"; 
        const NOTIFY_COLLECTION = "notifications"; 

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        let currentUser = null, isAdmin = false, isSuper = false, apps = [], categories = [], deputies = [], currentFilter = 'all', searchQuery = '', viewMode = 'grid', visitStats = {};
        let appsLoaded = false; 
        let bulkDeleteMode = false; 
        let selectedAppsForDelete = new Set(); 
        let currentAnnouncement = {}; 
        let adminRequests = []; 
        let globalSettings = {}; 
        let activityLogs = []; 
        let discoverApps = []; 
        let notifications = []; 
        let unreadCount = 0; 
        let confirmActionCallback = () => {}; 
        let currentMobileTab = 'app'; 
        let currentLang = 'vi'; 
        let toastTimeout = null; 
        let toastTouchStartY = 0; 
        let catToDeleteId = null; 
        let loadingTimeoutTimer = null; // NEW

        // --- GLOBAL LOADING EFFECT (UPDATED: Added Timeout Logic) ---
        window.showGlobalLoading = () => {
             document.getElementById('global-loading-overlay').classList.remove('opacity-0', 'pointer-events-none');
             document.getElementById('loading-timeout-warning').classList.add('hidden');
             clearTimeout(loadingTimeoutTimer);
             // Start timer to show warning after 30 seconds
             loadingTimeoutTimer = setTimeout(() => {
                 document.getElementById('loading-timeout-warning').classList.remove('hidden');
             }, 30000); 
        };
        window.hideGlobalLoading = () => {
             document.getElementById('global-loading-overlay').classList.add('opacity-0', 'pointer-events-none');
             clearTimeout(loadingTimeoutTimer);
        };
        
        // --- LANGUAGE LOGIC (Unchanged) ---
        window.setLang = (lang, initial = false) => {
             currentLang = lang;
             localStorage.setItem('language', lang);
             const langText = lang === 'vi' ? 'VI' : 'EN';
             
             document.getElementById('current-lang-text').innerText = `Ngôn ngữ: ${langText}`;
             
             // Update theme toggle icon dynamically for consistency
             const isDark = document.documentElement.classList.contains('dark');
             const themeIconElement = document.getElementById('profile-theme-toggle')?.querySelector('i');
             if(themeIconElement) {
                themeIconElement.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
             }
             
             if (!initial) {
                showToast(`Đã chuyển sang ngôn ngữ: ${langText}`);
                lucide.createIcons();
             }
        };


        // --- CUSTOM CONFIRMATION MODAL LOGIC (Unchanged) ---
        window.showConfirm = (title, message, callback, confirmText = 'XÁC NHẬN') => {
            if (!isAdmin) return; 
            document.getElementById('confirm-modal-title').innerText = title;
            document.getElementById('confirm-modal-message').innerText = message;
            document.getElementById('confirm-modal-btn').innerText = confirmText;
            confirmActionCallback = callback; 
            document.getElementById('confirm-modal-btn').onclick = () => {
                window.closeModal('modal-confirm');
                confirmActionCallback(); 
            };
            window.openModal('modal-confirm');
        };
        
        // --- MAINTENANCE MODE FIX (Hide Main Content) (Unchanged) ---
        function checkMaintenanceMode() {
            const maintenanceActive = globalSettings.maintenanceMode;
            const overlay = document.getElementById('maintenance-overlay');
            const adminInfo = document.getElementById('maintenance-admin-info');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const mobileNavBar = document.getElementById('mobile-nav-bar');

            if (maintenanceActive && !isAdmin) {
                overlay.classList.remove('hidden');
                mainContentWrapper.classList.add('hidden'); 
                if (mobileNavBar) mobileNavBar.classList.add('hidden'); 
            } else {
                overlay.classList.add('hidden');
                mainContentWrapper.classList.remove('hidden'); 
                if (window.innerWidth <= 768 && mobileNavBar) mobileNavBar.classList.remove('hidden'); 
            }
            adminInfo.classList.toggle('hidden', !maintenanceActive || !isAdmin);
        }

        function renderMaintenanceControls() {
            if (!isAdmin) return;
            const statusSpan = document.getElementById('maintenance-status');
            const toggleBtn = document.getElementById('maintenance-toggle-btn');
            
            if (globalSettings.maintenanceMode) {
                statusSpan.innerText = "Trạng thái: Bật";
                toggleBtn.innerText = "TẮT CHẾ ĐỘ";
                toggleBtn.classList.remove('bg-slate-500');
                toggleBtn.classList.add('bg-red-500');
            } else {
                statusSpan.innerText = "Trạng thái: Tắt";
                toggleBtn.innerText = "BẬT CHẾ ĐỘ";
                toggleBtn.classList.remove('bg-red-500');
                toggleBtn.classList.add('bg-slate-500');
            }
            // NEW: Update Browser Notification status when controls render
            updateBrowserNotificationUI();
        }

        // --- BROWSER NOTIFICATION LOGIC (NEW) ---
        function updateBrowserNotificationUI() {
             const statusSpan = document.getElementById('browser-notify-status');
             const btn = document.getElementById('request-notify-btn');
             if (!("Notification" in window)) {
                 statusSpan.innerText = "Trình duyệt không hỗ trợ thông báo.";
                 btn.classList.add('hidden');
             } else if (Notification.permission === "granted") {
                 statusSpan.innerText = "Trạng thái: ĐÃ CẤP QUYỀN (Bật)";
                 btn.classList.add('hidden');
             } else if (Notification.permission === "denied") {
                 statusSpan.innerText = "Trạng thái: ĐÃ BỊ CHẶN (Vui lòng thay đổi trong cài đặt trình duyệt)";
                 btn.classList.add('hidden');
             } else {
                 statusSpan.innerText = "Trạng thái: CHƯA CẤP QUYỀN (Hỏi)";
                 btn.classList.remove('hidden');
             }
        }
        
        window.requestBrowserNotificationPermission = () => {
             if (!("Notification" in window) || Notification.permission === "granted") return;
             Notification.requestPermission().then(permission => {
                 updateBrowserNotificationUI();
                 if (permission === "granted") {
                     showToast("Đã cấp quyền Thông báo Trình duyệt!");
                     // Send a test notification
                     new Notification("Hub Portal - Thông báo Test", { body: "Bạn sẽ nhận thông báo trên trình duyệt từ giờ.", icon: "https://hdd.io.vn/img/bmassloadings.png" });
                 } else if (permission === "denied") {
                      showToast("Đã từ chối cấp quyền thông báo.", true);
                 }
             });
        };
        
        function sendBrowserNotification(title, body, icon = "https://hdd.io.vn/img/bmassloadings.png") {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, { body: body, icon: icon });
            }
        }

        // --- AUTH & INITIAL (Unchanged) ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const requestSection = document.getElementById('request-admin-section');
            const requestStatus = document.getElementById('request-admin-status');
            const requestForm = document.getElementById('request-admin-form');
            window.showGlobalLoading(); 

            try { 
                if (user) {
                    const snap = await getDoc(doc(db, "settings", "admins"));
                    const adminData = snap.data() || {};
                    const superUidFromDB = adminData.super_uid; 
                    
                    isSuper = user.uid === superUidFromDB; 
                    deputies = adminData.deputy_emails || []; 
                    
                    isAdmin = isSuper || deputies.includes(user.email);
                    
                    renderAuthUI();
                    renderProfileContent(); 
                    document.getElementById('profile-admin-panel-btn')?.classList.toggle('hidden', !isAdmin);

                    requestSection.classList.toggle('hidden', isAdmin);

                    if (!isAdmin) {
                        const reqSnap = await getDoc(doc(db, "adminRequests", user.uid));
                        if (reqSnap.exists()) {
                            requestStatus.innerText = "Yêu cầu của bạn đang chờ Admin chính duyệt.";
                            requestForm.classList.add('hidden');
                        } else {
                            requestStatus.innerText = "Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu để Admin chính duyệt.";
                            requestForm.classList.remove('hidden');
                        }
                    }
                    
                    if (isAdmin) {
                        document.getElementById('announcement-content').value = currentAnnouncement.content || '';
                    }

                } else {
                    isAdmin = isSuper = false;
                    renderAuthUI(); 
                    requestSection.classList.add('hidden'); 
                    document.getElementById('profile-admin-panel-btn')?.classList.add('hidden');
                    renderProfileContent(); 
                }
                document.getElementById('role-status').innerText = isSuper ? 'SUPER' : (isAdmin ? 'DEPUTY' : 'GUEST');
                document.getElementById('admin-sidebar-toggle').classList.toggle('hidden', !isAdmin); 
                
                checkMaintenanceMode(); 
                // FIXED: Force 'list' view on mobile
                if (window.innerWidth <= 768) { viewMode = 'list'; window.setView('list'); } else { viewMode = 'grid'; }
                renderApps();
                renderDeputyList();
                renderAnnouncementControls();
                
                if (window.innerWidth <= 768) { 
                    window.switchMobileTab('app', false);
                } else {
                    window.switchMobileTab('app', true);
                }
                window.setLang(localStorage.getItem('language') || 'vi', true);

            } catch (error) {
                 console.error("Lỗi trong quá trình khởi tạo Auth:", error);
                 showToast("Lỗi tải dữ liệu người dùng!", true);
            } finally {
                window.hideGlobalLoading(); 
            }
        });
        
        // --- OTHER FUNCTIONS (Mostly Unchanged or Minor Fixes) ---
        window.login = () => { window.showGlobalLoading(); signInWithPopup(auth, provider).catch(() => window.hideGlobalLoading()); };
        // MODIFIED: Logout logic to clear local storage items before reload
        window.logout = () => { 
            window.showGlobalLoading(); 
            signOut(auth).then(() => {
                localStorage.removeItem('language');
                // localStorage.removeItem('theme'); // Keep theme setting
                location.reload();
            }).catch(() => window.hideGlobalLoading()); 
        };
        
        // ... (toggleAdminSidebar, toggleMobileCategorySidebar, renderAuthUI, etc. are unchanged)
        
        // --- MOBILE TAB NAVIGATION LOGIC (FIXED: Search and Sidebar issue) ---
        window.switchMobileTab = (tabId, isDesktop = false) => {
            currentMobileTab = tabId;
            const tabContents = ['tab-app-content', 'tab-notify-content', 'tab-discover-content', 'tab-profile-content'];
            const tabButtons = ['tab-app-btn', 'tab-contact-btn', 'tab-notify-btn', 'tab-profile-btn'];
            
            window.showGlobalLoading(); 

            tabButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.classList.remove('text-primary');
                    btn.classList.add('text-slate-400');
                }
            });

            // Close mobile sidebars to avoid overlay conflict
            document.getElementById('mobile-category-sidebar')?.classList.remove('open');
            document.getElementById('admin-sidebar')?.classList.remove('open');
            
            // Logic to manage filter and content visibility
            if (tabId === 'app' || tabId === 'contact') {
                tabContents.forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById('tab-app-content').classList.remove('hidden');
                
                // Show search/stats for App/Contact tabs
                document.getElementById('search-container').classList.remove('hidden');
                document.getElementById('visit-stats-container').classList.remove('hidden');
                document.getElementById('mobile-category-toggle').classList.remove('hidden'); // Show category toggle

                if (tabId === 'app') {
                    // FIXED: Only clear contact filter if needed, and prevent re-rendering if filter is already 'all'
                    if (currentFilter === 'contact_filter') {
                       currentFilter = 'all'; 
                       renderApps(); 
                       renderCategories();
                    }
                    document.getElementById('tab-app-btn').classList.remove('text-slate-400');
                    document.getElementById('tab-app-btn').classList.add('text-primary');
                    document.getElementById('view-grid-btn')?.parentElement.classList.remove('mobile-hidden');
                } else if (tabId === 'contact') {
                    // FIXED: Only set contact filter if needed
                    if (currentFilter !== 'contact_filter') {
                        currentFilter = 'contact_filter';
                        renderApps();
                        renderCategories();
                    }
                    document.getElementById('tab-contact-btn').classList.remove('text-slate-400');
                    document.getElementById('tab-contact-btn').classList.add('text-primary');
                    document.getElementById('view-grid-btn')?.parentElement.classList.add('mobile-hidden');
                }

            } else {
                // Hide search/stats for other tabs
                document.getElementById('search-container').classList.add('hidden');
                document.getElementById('visit-stats-container').classList.add('hidden');
                document.getElementById('view-grid-btn')?.parentElement.classList.add('mobile-hidden');
                document.getElementById('mobile-category-toggle').classList.add('hidden'); // Hide category toggle

                tabContents.forEach(id => document.getElementById(id).classList.add('hidden'));
                
                const contentId = tabId === 'notify' ? 'tab-notify-content' : `tab-${tabId}-content`;

                document.getElementById(contentId).classList.remove('hidden');
                document.getElementById(`tab-${tabId}-btn`).classList.remove('text-slate-400');
                document.getElementById(`tab-${tabId}-btn`).classList.add('text-primary');
                
                
                if (tabId === 'profile') {
                    renderProfileContent();
                } else if (tabId === 'notify') {
                    renderNotifications(); 
                } else if (tabId === 'discover') {
                    renderDiscoverContent();
                }
            }
            
            // Desktop mode always resets mobile tab UI
            if (isDesktop && window.innerWidth > 768) {
                document.getElementById('tab-app-content').classList.remove('hidden');
                document.getElementById('tab-notify-content').classList.add('hidden');
                document.getElementById('tab-discover-content').classList.add('hidden');
                document.getElementById('tab-profile-content').classList.add('hidden');
                document.getElementById('search-container').classList.remove('hidden');
                document.getElementById('visit-stats-container').classList.remove('hidden');
            }
            
            lucide.createIcons();
            window.hideGlobalLoading(); 
        };


        // --- DATA REALTIME (Unchanged) ---
        onSnapshot(query(collection(db, "categories"), orderBy("order", "asc")), (snap) => {
            categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCategories();
            // Update Select list for Cat Migrate Modal
            const migrateSelect = document.getElementById('cat-migrate-select');
            migrateSelect.innerHTML = categories.filter(c => c.id !== catToDeleteId).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        });

        onSnapshot(query(collection(db, "apps"), orderBy("order", "asc")), (snap) => {
            apps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            appsLoaded = true; 
            renderApps();
            renderTrash(); 
        });
        
        onSnapshot(doc(db, "settings", "visits_stats"), (snap) => {
            visitStats = snap.data() || {};
            renderStats();
        });
        
        // Realtime listener for Announcement 
        onSnapshot(doc(db, "settings", "announcement"), (snap) => {
            currentAnnouncement = snap.data() || { content: '', active: false, startTime: null, endTime: null }; 
            renderAnnouncementBar();
            renderAnnouncementControls();
        });
        
        // Realtime listener for Admin Requests 
        onSnapshot(collection(db, "adminRequests"), (snap) => {
            adminRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAdminRequests();
        });
        
        // Realtime listener for global settings 
        onSnapshot(doc(db, "settings", "global"), (snap) => {
            globalSettings = snap.data() || { maintenanceMode: false };
            checkMaintenanceMode();
            renderMaintenanceControls();
        });

        // Realtime listener for Discover Apps
        onSnapshot(doc(db, "settings", "discover"), (snap) => {
            discoverApps = snap.data()?.apps || [];
            if (document.getElementById('tab-discover-content') && document.getElementById('tab-discover-content').classList.contains('hidden') === false) {
                 renderDiscoverContent();
            }
        });
        
        // NEW: Realtime listener for Activity Logs
        onSnapshot(query(collection(db, LOGS_COLLECTION), orderBy("timestamp", "desc"), limit(100)), (snap) => {
            activityLogs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (document.getElementById('tab-logs') && document.getElementById('tab-logs').classList.contains('hidden') === false) {
                 renderActivityLogs();
            }
        });

        // NEW: Realtime listener for Notifications (UPDATED: Added Admin List Render)
        onSnapshot(query(collection(db, NOTIFY_COLLECTION), orderBy("timestamp", "desc")), (snap) => {
            notifications = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (document.getElementById('tab-notify-content') && document.getElementById('tab-notify-content').classList.contains('hidden') === false) {
                 renderNotifications();
            }
            if (document.getElementById('tab-announcement') && document.getElementById('tab-announcement').classList.contains('hidden') === false) {
                 renderAdminNotificationList(); // NEW: Render admin list when data changes
            }
            updateUnreadCount();
        });

        // --- RENDERING APP (Unchanged) ---
        window.renderApps = () => {
            const container = document.getElementById('app-container');
            const loading = document.getElementById('app-loading');
            
            if (!appsLoaded) {
                loading.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }
            loading.classList.add('hidden');

            const isMobile = window.innerWidth <= 768;
            // FIXED: Force 'list' view on mobile
            const effectiveViewMode = isMobile ? 'list' : viewMode; 
            const phoneCat = categories.find(c => c.name === "Số điện thoại");

            const filtered = apps.filter(a => {
                if (a.isDeleted) return false; 
                const cat = categories.find(c => c.id === a.categoryId);
                
                // Logic for Mobile Tab filtering:
                if (currentMobileTab === 'contact' && cat?.name !== "Số điện thoại") return false;
                
                // Filtering by category bar/sidebar
                if (currentFilter !== 'all' && currentFilter !== 'contact_filter' && a.categoryId !== currentFilter) return false;
                
                // Hide phone numbers on "all" filter (unless in mobile contact tab)
                if (currentFilter === 'all' && cat?.name === "Số điện thoại" && currentMobileTab !== 'contact') return false;
                
                const matchSearch = a.name.toLowerCase().includes(searchQuery.toLowerCase()) || (a.position && a.position.toLowerCase().includes(searchQuery.toLowerCase()));
                return matchSearch && (isAdmin || a.visible);
            });

            if (filtered.length === 0) {
                 container.className = "flex justify-center items-center h-40 text-slate-400";
                 container.innerHTML = `<i data-lucide="folder-search" class="w-6 h-6 mr-2"></i>Không tìm thấy ${currentMobileTab === 'contact' ? 'danh bạ' : 'ứng dụng'} nào.`;
                 lucide.createIcons();
                 return;
            }

            if (effectiveViewMode === 'grid') {
                container.className = "grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-x-4 gap-y-8";
                container.innerHTML = filtered.map(a => {
                    const isAppPhone = categories.find(c => c.id === a.categoryId)?.name === "Số điện thoại";
                    const domain = a.url.startsWith('http') ? new URL(a.url).hostname : '';
                    const icon = a.iconUrl || (isAppPhone ? 'https://cdn-icons-png.flaticon.com/512/3059/3059502.png' : `https://unavatar.io/${domain}?fallback=https://www.google.com/s2/favicons?domain=${domain}&sz=128`);
                    const isSelected = selectedAppsForDelete.has(a.id) ? 'selected-for-delete' : '';
                    const opacity = a.visible ? '' : 'opacity-40';
                    
                    if (bulkDeleteMode) {
                        return `
                        <div class="app-item group flex flex-col items-center relative cursor-pointer ${isSelected}" data-id="${a.id}" onclick="window.toggleAppSelection('${a.id}', event)">
                            <div class="w-full aspect-square bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-white/5 flex items-center justify-center p-3 mb-2 transition-all">
                                <img src="${icon}" class="w-full h-full object-contain rounded-lg ${opacity}">
                            </div>
                            <span class="text-[10px] font-bold text-slate-500 text-center truncate w-full uppercase tracking-tighter ${opacity}">${a.name}</span>
                            ${a.position ? `<span class="text-[8px] text-slate-400 font-bold truncate w-full text-center uppercase ${opacity}">${a.position}</span>` : ''}
                            <input type="checkbox" class="absolute top-1 right-1 w-5 h-5 accent-red-500 pointer-events-none" ${isSelected ? 'checked' : ''}>
                        </div>`;
                    }

                    return `
                    <div class="app-item group flex flex-col items-center relative" data-id="${a.id}">
                        <a href="${isAppPhone ? 'tel:' + a.url : a.url}" target="_blank" class="w-full aspect-square bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-white/5 flex items-center justify-center p-3 mb-2 hover:shadow-xl hover:-translate-y-1 transition-all">
                            <img src="${icon}" class="w-full h-full object-contain rounded-lg ${opacity}">
                        </a>
                        <span class="text-[10px] font-bold text-slate-500 text-center truncate w-full uppercase tracking-tighter ${opacity}">${a.name}</span>
                        ${a.position ? `<span class="text-[8px] text-slate-400 font-bold truncate w-full text-center uppercase ${opacity}">${a.position}</span>` : ''}
                        
                        <div class="absolute -top-1 -right-1 flex flex-col gap-1 transition-all scale-90 z-10 ${isAdmin ? 'opacity-0 group-hover:opacity-100' : 'hidden'}">
                            ${isAdmin ? `
                                <button onclick="window.toggleAppVisibility('${a.id}')" class="p-2 ${a.visible ? 'bg-green-500' : 'bg-slate-500'} text-white rounded-full shadow-lg">
                                    <i data-lucide="${a.visible ? 'eye' : 'eye-off'}" class="w-3 h-3"></i>
                                </button>
                                <button onclick="window.editApp('${a.id}')" class="bg-indigo-500 text-white p-2 rounded-full shadow-lg">
                                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                                </button>
                                <button onclick="window.deleteAppConfirm('${a.id}', '${a.name}')" class="bg-red-500 text-white p-2 rounded-full shadow-lg">
                                    <i data-lucide="trash" class="w-3 h-3"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>`;
                }).join('');
            } else { // List View (Vertical for mobile & desktop list mode)
                container.className = "flex flex-col max-w-4xl mx-auto space-y-1";
                container.innerHTML = filtered.map((a, idx) => {
                    const isAppPhone = categories.find(c => c.id === a.categoryId)?.name === "Số điện thoại";
                    const domain = a.url.startsWith('http') ? new URL(a.url).hostname : '';
                    const icon = a.iconUrl || (isAppPhone ? 'https://cdn-icons-png.flaticon.com/512/3059/3059502.png' : `https://unavatar.io/${domain}?fallback=https://www.google.com/s2/favicons?domain=${domain}&sz=128`);
                    const isSelected = selectedAppsForDelete.has(a.id) ? 'selected-for-delete' : '';
                    const opacity = a.visible ? '' : 'opacity-40';
                    const listIndex = a.order + 1;

                    const bulkSelectControl = bulkDeleteMode ? 
                        `<input type="checkbox" class="w-5 h-5 accent-red-500 pointer-events-none" ${isSelected ? 'checked' : ''}>` : '';

                    return `<div class="app-item flex items-center gap-4 bg-white dark:bg-slate-900 p-3 rounded-xl border dark:border-white/5 group shadow-sm ${isSelected} ${opacity}" data-id="${a.id}" onclick="${bulkDeleteMode ? `window.toggleAppSelection('${a.id}', event)` : ''}">
                        ${bulkSelectControl}
                        <span class="text-[9px] font-black text-slate-300 w-4">${listIndex}</span>
                        <img src="${icon}" class="w-8 h-8 rounded-lg object-contain">
                        <div class="flex-1 min-w-0"><h4 class="text-xs font-bold truncate">${a.name}</h4><p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${a.position || (isAppPhone ? a.url : 'Web App')}</p></div>
                        <div class="flex items-center gap-2">
                            <a href="${isAppPhone ? 'tel:' + a.url : a.url}" target="_blank" class="p-2 text-primary hover:bg-primary hover:text-white rounded-lg transition"><i data-lucide="${isAppPhone ? 'phone' : 'external-link'}" class="w-4 h-4"></i></a>
                            ${isAdmin ? `
                                <button onclick="window.toggleAppVisibility('${a.id}')" class="p-2 ${a.visible ? 'text-green-500 hover:bg-green-100' : 'text-slate-500 hover:bg-slate-100'} rounded-lg"><i data-lucide="${a.visible ? 'eye' : 'eye-off'}" class="w-4 h-4"></i></button>
                                <button onclick="window.editApp('${a.id}')" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <i data-lucide="grip-vertical" class="w-4 h-4 text-slate-300 cursor-move"></i>
                            ` : ''}
                        </div></div>`;
                }).join('');
            }
            lucide.createIcons();
            // Only allow sorting on non-mobile desktop mode in list view
            if(isAdmin && effectiveViewMode === 'list' && !isMobile) new Sortable(container, { animation: 150, handle: '.cursor-move', onEnd: () => { Array.from(container.children).forEach((el, i) => { if(el.dataset.id) updateDoc(doc(db, "apps", el.dataset.id), { order: i }); logActivity('APP_ORDER_UPDATED', 'bulk', 'Sắp xếp ứng dụng'); }); }});
        }

        // --- ADMIN UTILS ---
        window.updateCatField = (id, field, val) => {
            window.showGlobalLoading();
            updateDoc(doc(db, "categories", id), { [field]: val })
            .then(() => { showToast("Đã cập nhật danh mục!"); logActivity('CAT_UPDATED', id, categories.find(c=>c.id === id)?.name); }) 
            .catch(e => showToast("Lỗi khi cập nhật danh mục!", true))
            .finally(window.hideGlobalLoading);
        }
            
        // MODIFIED: Category Delete Logic
        window.deleteCatConfirm = (id, name) => {
            catToDeleteId = id;
            const appsInCategory = apps.filter(a => a.categoryId === id && !a.isDeleted);
            
            if (appsInCategory.length > 0) {
                 const availableCats = categories.filter(c => c.id !== id);
                 if (availableCats.length === 0) {
                     showToast("Không thể xóa. Vui lòng thêm ít nhất một danh mục khác trước!", true);
                     return;
                 }
                 document.getElementById('cat-migrate-count').innerText = appsInCategory.length;
                 
                 const migrateSelect = document.getElementById('cat-migrate-select');
                 migrateSelect.innerHTML = availableCats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                 
                 window.openModal('modal-cat-migrate');
            } else {
                window.showConfirm(
                    'Xác nhận Xóa Danh mục',
                    `Bạn có chắc chắn muốn xóa vĩnh viễn danh mục "${name}" không?`,
                    () => window.deleteCat(id, name),
                    'XÓA VĨNH VIỄN'
                );
            }
        };

        window.executeCatDeleteAndMigrate = async () => {
            const oldCatId = catToDeleteId;
            const newCatId = document.getElementById('cat-migrate-select').value;
            const oldCatName = categories.find(c => c.id === oldCatId)?.name;
            const newCatName = categories.find(c => c.id === newCatId)?.name;

            if (!oldCatId || !newCatId) { 
                showToast("Lỗi: Danh mục mới không hợp lệ.", true);
                window.closeModal('modal-cat-migrate');
                return;
            }

            window.closeModal('modal-cat-migrate');
            window.showGlobalLoading();

            try {
                const batch = writeBatch(db);
                const appsToMigrate = apps.filter(a => a.categoryId === oldCatId && !a.isDeleted);
                
                // 1. Update all apps in the old category
                appsToMigrate.forEach(app => {
                    batch.update(doc(db, "apps", app.id), { categoryId: newCatId });
                });

                // 2. Delete the old category
                batch.delete(doc(db, "categories", oldCatId));
                
                await batch.commit();
                
                showToast(`Đã xóa danh mục "${oldCatName}" và chuyển ${appsToMigrate.length} ứng dụng sang "${newCatName}"!`);
                logActivity('CAT_DELETED_MIGRATED', oldCatId, oldCatName, `Đã chuyển sang ${newCatName}`);
                catToDeleteId = null; 

            } catch (e) {
                console.error("Error deleting category and migrating apps:", e);
                showToast("Lỗi khi xóa danh mục và chuyển đổi ứng dụng!", true);
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        window.deleteCat = (id, name) => {
            window.showGlobalLoading();
            deleteDoc(doc(db, "categories", id))
                .then(() => { showToast(`Đã xóa danh mục "${name}"!`); logActivity('CAT_DELETED', id, name); }) 
                .catch(e => showToast("Lỗi khi xóa danh mục!", true))
                .finally(window.hideGlobalLoading); 
        };
        
        window.addCategory = async () => {
            const name = document.getElementById('new-cat-name').value.trim();
            const icon = document.getElementById('new-cat-icon').value.trim();
            if(!name) { showToast("Tên danh mục không được trống!", true); return; }
            window.showGlobalLoading();
            await addDoc(collection(db, "categories"), { name, icon, order: categories.length })
                .then((docRef) => {
                    document.getElementById('new-cat-name').value = '';
                    document.getElementById('new-cat-icon').value = '';
                    showToast("Đã thêm danh mục mới!");
                    logActivity('CAT_ADDED', docRef.id, name); 
                })
                .catch(e => showToast("Lỗi khi thêm danh mục.", true))
                .finally(window.hideGlobalLoading);
        };
        
        // ... (Deputy functions unchanged)

        // --- PERMANENT DELETE APP (Unchanged) ---
        window.clearTrash = async (clearAll = false, id = null, name = '') => {
            if (!isAdmin) return;
            window.showGlobalLoading();
            try {
                if (clearAll) {
                    const deletedApps = apps.filter(a => a.isDeleted);
                    const batch = writeBatch(db);
                    deletedApps.forEach(a => batch.delete(doc(db, "apps", a.id)));
                    
                    logActivity('APP_PERM_DELETED', 'bulk', `Tất cả ${deletedApps.length} mục`);
                    
                    await batch.commit();
                    showToast(`Đã dọn sạch ${deletedApps.length} mục trong Thùng rác!`);
                    
                } else if (id) {
                    await deleteDoc(doc(db, "apps", id));
                    showToast(`Đã xóa vĩnh viễn ứng dụng "${name}"!`);
                    logActivity('APP_PERM_DELETED', id, name);
                }
            } catch (e) {
                showToast("Lỗi khi xóa vĩnh viễn!", true);
            } finally {
                window.hideGlobalLoading();
            }
        };

        // ... (App CRUD functions unchanged)


        // --- NOTIFICATION FEED LOGIC ---
        
        // ... (updateUnreadCount, markAsRead, renderNotifications unchanged)

        window.markAndOpenNotification = (id, title, content) => {
            if (currentUser) {
                 markAsRead(id);
            }
            // MODIFIED: Use toast for display + send browser notification
            showToast(`📣 **${title}**\n\n${content}`, false, true); 
            sendBrowserNotification(title, content);
        };

        window.publishNotification = async () => {
            if (!isAdmin || !currentUser) { showToast("Bạn không có quyền Admin!", true); return; }
            const title = document.getElementById('notify-title').value.trim();
            const content = document.getElementById('notify-content').value.trim();
            const iconUrl = document.getElementById('notify-icon').value.trim();

            if (title.length < 5 || content.length < 5) {
                showToast("Tiêu đề và Nội dung phải dài hơn 5 ký tự!", true);
                return;
            }
            
            window.showGlobalLoading();
            try {
                const docRef = await addDoc(collection(db, NOTIFY_COLLECTION), {
                    title: title,
                    content: content,
                    iconUrl: iconUrl,
                    timestamp: new Date().toISOString(),
                    senderName: currentUser.displayName,
                    senderEmail: currentUser.email,
                    readBy: []
                });
                
                document.getElementById('notify-title').value = '';
                document.getElementById('notify-content').value = '';
                document.getElementById('notify-icon').value = '';

                showToast("Đã đăng thông báo mới thành công!");
                logActivity('NOTIFICATION_PUBLISHED', docRef.id, title);
                sendBrowserNotification(title, content, iconUrl); // Send browser notification

            } catch (e) {
                console.error("Error publishing notification:", e);
                showToast("Lỗi khi đăng thông báo!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };

        // ... (renderAdminNotificationList, deleteNotificationConfirm, deleteNotification unchanged)


        // --- ANNOUNCEMENT LOGIC (MODIFIED: Added Browser Notification) ---
        function renderAnnouncementBar() {
            const bar = document.getElementById('announcement-bar');
            const textDiv = document.getElementById('announcement-text');
            const now = new Date().getTime();
            const start = currentAnnouncement.startTime ? new Date(currentAnnouncement.startTime).getTime() : 0;
            const end = currentAnnouncement.endTime ? new Date(currentAnnouncement.endTime).getTime() : Infinity;
            
            const isScheduledActive = start <= now && now <= end; 
            
            if (currentAnnouncement.active && currentAnnouncement.content && currentAnnouncement.content.trim() !== '' && isScheduledActive) {
                textDiv.innerText = currentAnnouncement.content.trim().toUpperCase() + " • "; 
                bar.classList.remove('hidden');
                const contentLen = currentAnnouncement.content.length;
                const speed = Math.max(10, Math.min(30, contentLen * 0.2)); 
                bar.querySelector('.marquee > div').style.animationDuration = `${speed}s`;

            } else {
                bar.classList.add('hidden');
            }
        }
        
        // ... (renderAnnouncementControls unchanged)
        
        window.saveAnnouncementContent = async (andEnable = false) => {
            if (!isAdmin) return;
            const content = document.getElementById('announcement-content').value.trim();
            const startTime = document.getElementById('announcement-start').value || null; 
            const endTime = document.getElementById('announcement-end').value || null; 
            
            if (content.length < 5) {
                showToast("Nội dung thông báo phải dài hơn 5 ký tự!", true);
                return;
            }
            window.showGlobalLoading();
            try {
                const updateData = { 
                    content: content, 
                    startTime: startTime, 
                    endTime: endTime 
                };
                const wasActive = currentAnnouncement.active;
                if (andEnable) {
                    updateData.active = true; 
                }
                
                await setDoc(doc(db, "settings", "announcement"), updateData, { merge: true });
                showToast("Đã lưu nội dung thông báo và hẹn giờ!");
                logActivity('ANNOUNCEMENT_UPDATED', 'system', 'Thông báo Marquee'); 

                // Send browser notification if announcement is new/updated AND active
                if (updateData.active && (updateData.content !== currentAnnouncement.content || !wasActive)) {
                    sendBrowserNotification("THÔNG BÁO MỚI (Marquee)", updateData.content);
                }

            } catch (e) {
                console.error("Error saving announcement:", e);
                showToast("Lỗi khi lưu nội dung thông báo!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };
        
        window.toggleAnnouncementStatus = async () => {
            if (!isAdmin) return;
            const newState = !currentAnnouncement.active;
            if (newState && (!currentAnnouncement.content || currentAnnouncement.content.trim() === '')) {
                showToast("Vui lòng nhập nội dung trước khi bật!", true);
                return;
            }
            window.showGlobalLoading();
            try {
                await setDoc(doc(db, "settings", "announcement"), { active: newState }, { merge: true });
                showToast(newState ? "Đã BẬT thông báo!" : "Đã TẮT thông báo!");
                logActivity(newState ? 'ANNOUNCEMENT_ENABLED' : 'ANNOUNCEMENT_DISABLED', 'system', 'Thông báo Marquee'); 
                if (newState) {
                     sendBrowserNotification("THÔNG BÁO MỚI (Marquee)", currentAnnouncement.content);
                }
            } catch (e) {
                console.error("Error toggling announcement status:", e);
                showToast("Lỗi khi thay đổi trạng thái thông báo!", true); 
            } finally {
                window.hideGlobalLoading();
            }
        };

        // ... (Rest of Admin/Data functions unchanged)
        
        // CẬP NHẬT & SỬA LỖI TOAST (FIXED & IMPROVED UX)
        function showToast(msg, isError = false, isLong = false) {
            const t = document.getElementById('toast');
            // Support markdown bold in toast
            document.getElementById('toast-msg').innerHTML = msg.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            
            const icon = t.querySelector('i');
            
            icon.classList.remove('text-green-500', 'text-red-500');

            if (isError) {
                 icon.setAttribute('data-lucide', 'alert-triangle');
                 icon.classList.add('text-red-500');
            } else {
                 icon.setAttribute('data-lucide', 'check-circle');
                 icon.classList.add('text-green-500');
            }
            
            lucide.createIcons();
            
            // Clear existing timeout
            clearTimeout(toastTimeout);
            
            // Show toast
            t.classList.remove('hidden');
            t.classList.add('visible');

            // Set timeout for auto-close (3s for normal, 5s for long content)
            const duration = isLong ? 5000 : 3000;
            toastTimeout = setTimeout(() => {
                 window.closeToast();
            }, duration);
        }

        window.closeToast = () => {
             const t = document.getElementById('toast');
             t.classList.remove('visible');
             // Hide after transition
             setTimeout(() => {
                 t.classList.add('hidden');
             }, 500); 
             clearTimeout(toastTimeout);
        };

        // NEW: Toast swipe detection (Mobile UX)
        window.handleToastTouchStart = (e) => {
            if (e.touches.length === 1) {
                toastTouchStartY = e.touches[0].clientY;
            }
        };

        window.handleToastTouchMove = (e) => {
            if (e.touches.length === 1) {
                const deltaY = e.touches[0].clientY - toastTouchStartY;
                if (deltaY < -30) { // Swipe up threshold
                    window.closeToast();
                }
            }
        };

        window.handleToastTouchEnd = (e) => {
            // Can be used to check for tap to close if desired, but default onclick is set on the element.
        };


        if(localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        lucide.createIcons();
        // Initial view mode based on screen size
        if (window.innerWidth <= 768) {
            window.setView('list'); 
        } else {
            window.setView('grid');
        }
        
        trackVisit();
        updateBrowserNotificationUI(); // Initial check for notification status
    </script>
</body>
</html>
