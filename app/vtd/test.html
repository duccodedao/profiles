
<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu app - Vƒ©nh Tr·∫°ch ƒê√¥ng</title>
    <meta name="description" content="Hub Portal t·ªïng h·ª£p c√°c ·ª©ng d·ª•ng v√† danh b·∫° li√™n h·ªá c·ªßa Vƒ©nh Tr·∫°ch ƒê√¥ng.">
    <link rel="icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    <link rel="apple-touch-icon" href="https://hdd.io.vn/img/bmassloadings.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Hub Vƒ©nh Tr·∫°ch ƒê√¥ng">
    <link rel="manifest" href="/js/applinkicon.json">
    <meta name="theme-color" content="#4f46e5">

    <!-- Social Media Meta -->
    <meta property="og:title" content="Hub Portal - Vƒ©nh Tr·∫°ch ƒê√¥ng">
    <meta property="og:description" content="Hub Portal t·ªïng h·ª£p c√°c ·ª©ng d·ª•ng v√† danh b·∫° li√™n h·ªá c·ªßa Vƒ©nh Tr·∫°ch ƒê√¥ng.">
    <meta property="og:image" content="https://bmass.vercel.app/img/bmasslogo.png">
    <meta property="og:type" content="website">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Excel Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4f46e5', secondary: '#f43f5e', dark: '#020617' } } }
        }
    </script>
    <style>
        .admin-sidebar { 
            width: 28rem; min-width: 320px; 
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .admin-sidebar.open { transform: translateX(0); }
        @media (max-width: 768px) { .admin-sidebar { width: 100%; } }
        
        .mobile-category-sidebar { 
            width: 75%; max-width: 300px;
            transform: translateX(-100%); transition: transform 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .mobile-category-sidebar.open { transform: translateX(0); }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; padding-bottom: 100px; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .app-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drag-ghost { opacity: 0.3; background: #4f46e5 !important; border-radius: 1rem; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        .dark .tab-active { color: #818cf8; border-bottom: 2px solid #818cf8; }
        .app-item.selected-for-delete { box-shadow: 0 0 0 3px #f43f5e; border-radius: 1rem; }
        
        header { top: 0; transition: top 0.3s; }
        #announcement-bar:not(.hidden) ~ header { top: 32px; }
        
        .marquee { overflow: hidden; white-space: nowrap; box-sizing: border-box; }
        .marquee > div { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        
        .logo-loader { width: 24px; height: 24px; animation: zoom-logo 1.5s ease-in-out infinite; }
        @keyframes zoom-logo { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        @media (max-width: 768px) {
            body { padding-bottom: 80px; }
            #main-content-wrapper { padding-bottom: 10px; }
            #category-bar { display: none !important; }
            header { padding-right: 0; }
        }
        
        #toast {
            bottom: 20px; right: 50%; left: 50%;
            transform: translate(-50%, 100%); opacity: 0; transition: all 0.4s ease-out;
            max-width: 90%; width: auto; min-width: 250px; pointer-events: none;
        }
        #toast.visible { transform: translate(-50%, 0); opacity: 1; pointer-events: auto; }
    </style>
</head>
<body class="min-h-screen pb-24">
    
    <!-- Loading Overlay -->
    <div id="global-loading-overlay" class="fixed inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm z-[900] flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="loading-content" class="flex flex-col items-center justify-center">
            <img src="https://hdd.io.vn/img/bmassloadings.png" class="logo-loader w-12 h-12" alt="Loading Logo">
            <span id="loading-text" class="text-slate-600 dark:text-white mt-4 font-medium">ƒêang t·∫£i d·ªØ li·ªáu...</span>
        </div>
    </div>
    
    <!-- Maintenance Overlay -->
    <div id="maintenance-overlay" class="fixed inset-0 bg-white dark:bg-slate-900 z-[500] flex flex-col items-center justify-center p-8 text-center hidden">
        <i data-lucide="wrench" class="w-16 h-16 text-primary mb-4"></i>
        <h2 class="text-3xl font-black text-primary dark:text-white mb-2">CH·∫æ ƒê·ªò B·∫¢O TR√å</h2>
        <p class="text-slate-500 dark:text-slate-400 max-w-md">H·ªá th·ªëng ƒëang ƒë∆∞·ª£c b·∫£o tr√¨ v√† n√¢ng c·∫•p. Kh√°ch truy c·∫≠p t·∫°m th·ªùi kh√¥ng th·ªÉ xem n·ªôi dung.</p>
        <p id="maintenance-admin-info" class="text-sm font-bold mt-4 text-red-500 hidden">(Admin ƒëang thao t√°c. D·ªØ li·ªáu v·∫´n ƒë∆∞·ª£c truy c·∫≠p.)</p>
    </div>
    
    <!-- Announcement Bar -->
    <div id="announcement-bar" class="fixed top-0 left-0 w-full z-[101] bg-secondary text-white text-xs font-bold py-2 shadow-md hidden">
        <div class="marquee"><div id="announcement-text"></div></div>
    </div>
    
    <!-- Header -->
    <header class="sticky top-0 z-[100] glass px-6 py-3 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-3">
            <button onclick="window.toggleMobileCategorySidebar()" id="mobile-category-toggle" class="p-2 rounded-xl text-slate-600 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 transition md:hidden"><i data-lucide="menu" class="w-5 h-5"></i></button>

            <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg p-1">
                <img src="https://hdd.io.vn/img/bmassloadings.png" alt="Hub Logo" class="w-full h-full object-contain rounded-lg">
            </div>
            <div>
                <h1 class="text-xs font-black tracking-tighter uppercase leading-none">Hub Portal</h1>
                <span id="role-status" class="text-[9px] font-bold text-slate-400">GUEST</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="window.toggleAdminSidebar()" id="admin-sidebar-toggle" class="p-2 rounded-xl text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition hidden"><i data-lucide="settings-2" class="w-5 h-5"></i></button>

            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                <button onclick="window.setView('grid')" id="view-grid-btn" class="p-1.5 rounded-md transition-all shadow-sm bg-white dark:bg-slate-700"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                <button onclick="window.setView('list')" id="view-list-btn" class="p-1.5 rounded-md transition-all"><i data-lucide="list" class="w-4 h-4"></i></button>
            </div>
            
            <button onclick="window.toggleTheme()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition mobile-hidden">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden text-slate-600"></i>
            </button>
            
            <div id="auth-section"></div>
        </div>
    </header>

    <!-- Mobile Category Sidebar -->
    <div id="mobile-category-sidebar" class="mobile-category-sidebar fixed top-0 left-0 bottom-0 bg-white dark:bg-slate-900 border-r dark:border-white/10 shadow-2xl z-[200] flex flex-col pt-0 md:hidden">
        <div class="p-6 border-b dark:border-white/5 flex flex-col items-start justify-between">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-8 h-8 flex items-center justify-center p-0.5"><img src="https://hdd.io.vn/img/bmassloadings.png" class="w-full h-full object-contain rounded-lg"></div>
                <h3 class="text-sm font-black tracking-tighter uppercase leading-none">Hub Portal</h3>
            </div>
            <div class="flex items-center justify-between w-full">
                <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">DANH M·ª§C</h3>
                <button onclick="window.toggleMobileCategorySidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
        <div id="category-bar-mobile" class="flex-1 overflow-y-auto p-6 space-y-2"></div>
    </div>

    <!-- Main Content -->
    <div id="main-content-wrapper" class="flex max-w-7xl mx-auto">
        <main class="flex-1 p-6 space-y-8 min-w-0">
            <!-- Search -->
            <div id="search-container" class="relative max-w-2xl mx-auto">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="search-input" placeholder="T√¨m ·ª©ng d·ª•ng ho·∫∑c danh b·∫°..." 
                    class="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-2xl focus:ring-4 ring-primary/10 outline-none shadow-sm">
            </div>

            <div id="visit-stats-container" class="max-w-4xl mx-auto p-4 rounded-3xl bg-slate-100 dark:bg-slate-900/50">
                <div class="flex items-center justify-center h-20 text-slate-400">ƒêang t·∫£i th·ªëng k√™...</div>
            </div>

            <!-- Admin Request -->
            <div id="request-admin-section" class="max-w-4xl mx-auto hidden p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-3xl border border-yellow-200 dark:border-yellow-700 space-y-4">
                <h3 class="text-xl font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="key" class="w-6 h-6"></i> Xin C·∫•p Quy·ªÅn Qu·∫£n Tr·ªã</h3>
                <p id="request-admin-status" class="text-sm font-medium text-yellow-700 dark:text-yellow-300">B·∫°n ch∆∞a c√≥ quy·ªÅn qu·∫£n tr·ªã.</p>
                <form id="request-admin-form" class="flex gap-4">
                    <input type="text" id="request-admin-reason" placeholder="L√Ω do..." required class="flex-1 px-5 py-3 bg-white dark:bg-slate-800 rounded-xl outline-none focus:ring-2 ring-yellow-500 text-sm">
                    <button type="submit" class="bg-yellow-500 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-yellow-600 transition">G·ª¨I Y√äU C·∫¶U</button>
                </form>
            </div>
            
            <div id="category-bar" class="mobile-hidden flex flex-wrap gap-2"></div>
            
            <div id="main-tabs-content">
                <!-- Tab: App -->
                <div id="tab-app-content">
                    <div id="app-loading" class="text-center p-16 text-slate-400 text-sm font-medium hidden">
                        <img src="/img/bmassloadings.png" class="logo-loader w-6 h-6 mx-auto mb-2">ƒêang t·∫£i ·ª©ng d·ª•ng...
                    </div>
                    <div id="app-container"></div>
                </div>

                <!-- Tab: Notify -->
                <div id="tab-notify-content" class="hidden max-w-4xl mx-auto">
                    <h3 class="text-xl font-black text-primary dark:text-white mb-6 border-b pb-2 px-2">TH√îNG B√ÅO M·ªöI</h3>
                    <div id="notification-content-list" class="space-y-4"></div>
                </div>

                <!-- Tab: Staff / HR Content (NEW) -->
                <div id="tab-hr-content" class="hidden max-w-5xl mx-auto">
                    <div class="flex items-center justify-between mb-6 border-b dark:border-white/10 pb-4">
                        <h3 class="text-xl font-black text-primary dark:text-white uppercase">DANH S√ÅCH NH√ÇN S·ª∞</h3>
                        <div class="flex gap-2">
                             <button onclick="window.setViewModeHR('grid')" class="p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:text-primary"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                             <button onclick="window.setViewModeHR('list')" class="p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm hover:text-primary"><i data-lucide="list" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-6">
                        <input type="text" id="staff-search-public" placeholder="T√¨m ki·∫øm nh√¢n s·ª±..." oninput="window.renderStaffPublic()" class="flex-1 min-w-[200px] px-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl outline-none focus:ring-2 ring-primary/20 text-sm">
                        <select id="staff-filter-dept" onchange="window.renderStaffPublic()" class="px-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/10 rounded-xl outline-none text-sm font-bold text-slate-600 dark:text-slate-300">
                            <option value="all">T·∫•t c·∫£ Ch·ª©c v·ª•</option>
                        </select>
                    </div>
                    <div id="staff-container-public" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </div>

                <!-- Tab: Discover -->
                <div id="tab-discover-content" class="hidden max-w-4xl mx-auto">
                    <h3 class="text-xl font-black text-primary dark:text-white mb-6 border-b pb-2 px-2">KH√ÅM PH√Å</h3>
                    <div id="discover-content-list" class="space-y-4"></div>
                </div>

                <!-- Tab: Profile -->
                <div id="tab-profile-content" class="hidden max-w-lg mx-auto p-4">
                    <h3 class="mobile-hidden text-xl font-black text-primary dark:text-white mb-6 border-b pb-2">TH√îNG TIN C√Å NH√ÇN</h3>
                    <div id="profile-content-details" class="space-y-4"></div>
                    <div id="profile-action-panel" class="space-y-4 mt-8">
                        <button id="profile-admin-panel-btn" onclick="window.toggleAdminSidebar()" class="hidden w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs flex items-center justify-center gap-2 hover:bg-indigo-600 transition"><i data-lucide="settings" class="w-4 h-4"></i> ADMIN PANEL</button>
                        <div class="grid grid-cols-2 gap-4">
                             <a href="#" onclick="window.showToast('B·∫£o m·∫≠t 2 y·∫øu t·ªë s·∫Øp ra m·∫Øt!', false)" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="shield-check" class="w-5 h-5 text-primary"></i> <span class="text-xs font-bold">B·∫£o m·∫≠t</span>
                            </a>
                             <button onclick="window.openPrivacyModal()" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition text-left">
                                <i data-lucide="lock" class="w-5 h-5 text-primary"></i> <span class="text-xs font-bold">Quy·ªÅn ri√™ng t∆∞</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="window.toggleTheme()" id="profile-theme-toggle" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="moon" class="w-5 h-5 text-primary"></i> <span class="text-xs font-bold">System</span>
                            </button>
                            <button onclick="window.setLang(currentLang === 'vi' ? 'en' : 'vi')" id="profile-lang-toggle" class="flex items-center gap-3 p-4 bg-slate-100 dark:bg-slate-800 rounded-xl shadow-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                                <i data-lucide="globe" class="w-5 h-5 text-primary"></i> <span id="current-lang-text" class="text-xs font-bold">üáªüá≥ Vi·ªát Nam</span>
                            </button>
                        </div>
                        <button onclick="window.requestNotificationPermission()" class="w-full py-3 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-white rounded-xl font-bold text-xs uppercase shadow-sm hover:bg-slate-300 transition flex items-center justify-center gap-2"><i data-lucide="bell" class="w-4 h-4"></i> TH√îNG B√ÅO</button>
                        <div class="grid grid-cols-2 gap-4">
                            <a href="#" onclick="window.logout()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-red-600 transition flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> ƒêƒÇNG XU·∫§T</a>
                            <a href="chat.html" target="_blank" class="w-full py-3 bg-secondary text-white rounded-xl font-bold text-xs uppercase shadow-lg hover:opacity-90 transition flex items-center justify-center gap-2"><i data-lucide="life-buoy" class="w-4 h-4"></i> TR·ª¢ GI√öP</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="bulk-delete-dock" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 z-[110]">
                <div class="bg-red-600 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-4">
                    <span id="selected-count">0</span> m·ª•c ƒë√£ ch·ªçn
                    <button onclick="window.executeBulkDelete()" class="flex items-center gap-2 px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold shadow-lg uppercase"><i data-lucide="trash-2" class="w-4 h-4"></i> TH√ôNG R√ÅC</button>
                </div>
            </div>
        </main>

        <!-- Admin Sidebar -->
        <div id="admin-sidebar" class="admin-sidebar fixed right-0 top-0 bottom-0 bg-white dark:bg-slate-900 border-l dark:border-white/10 shadow-2xl z-[150] flex flex-col pt-16">
            <div id="sidebar-controls" class="p-6 border-b dark:border-white/5 flex flex-col gap-3">
                 <div class="flex items-center justify-between">
                    <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">QU·∫¢N TR·ªä VI√äN</h3>
                    <button onclick="window.toggleAdminSidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
                 <div class="flex items-center gap-3">
                    <button onclick="window.openAppModal()" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary text-white rounded-xl text-xs font-bold shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i> TH√äM APP</button>
                    <button onclick="window.toggleBulkDelete()" id="bulk-delete-sidebar-toggle" class="p-3 rounded-xl text-red-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition flex items-center justify-center"><i data-lucide="scissors" class="w-5 h-5"></i></button>
                 </div>
            </div>

            <div class="p-6 border-b dark:border-white/5">
                <div class="flex flex-wrap gap-2 text-[10px] font-black tracking-widest text-slate-400">
                    <button onclick="window.switchTab('tab-cat')" id="btn-tab-cat" class="text-primary border-b-2 border-primary pb-1">DANH M·ª§C</button>
                    <button onclick="window.switchTab('tab-hr')" id="btn-tab-hr" class="pb-1 uppercase flex items-center gap-1">NH√ÇN S·ª∞</button>
                    <button onclick="window.switchTab('tab-trash')" id="btn-tab-trash" class="pb-1 uppercase">TH√ôNG R√ÅC</button>
                    <button onclick="window.switchTab('tab-announcement')" id="btn-tab-announcement" class="pb-1 uppercase">TH√îNG B√ÅO</button>
                    <button onclick="window.switchTab('tab-deputy')" id="btn-tab-deputy" class="pb-1 uppercase">PH√ì ADMIN</button>
                    <button onclick="window.switchTab('tab-users')" id="btn-tab-users" class="pb-1 uppercase flex items-center gap-1">NG∆Ø·ªúI D√ôNG <span id="user-count" class="text-red-500">(0)</span></button>
                    <button onclick="window.switchTab('tab-logs')" id="btn-tab-logs" class="pb-1 uppercase">NH·∫¨T K√ù</button>
                    <button onclick="window.switchTab('tab-data')" id="btn-tab-data" class="pb-1 uppercase">D·ªÆ LI·ªÜU</button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <!-- Tab Cat -->
                <div id="tab-cat" class="space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Qu·∫£n l√Ω Danh m·ª•c</h4>
                    <div class="flex flex-col gap-2">
                        <input type="text" id="new-cat-name" placeholder="T√™n danh m·ª•c..." class="px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                        <div class="flex gap-2">
                             <input type="text" id="new-cat-icon" placeholder="Link Icon..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                             <button onclick="window.addCategory()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">Th√™m</button>
                        </div>
                    </div>
                    <ul id="cat-list-admin" class="space-y-2"></ul>
                </div>

                <!-- Tab HR (Admin) -->
                <div id="tab-hr" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Qu·∫£n l√Ω Nh√¢n s·ª±</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="window.openStaffModal()" class="flex items-center justify-center gap-2 px-3 py-3 bg-primary text-white rounded-xl text-xs font-bold shadow-lg uppercase">
                            <i data-lucide="user-plus" class="w-4 h-4"></i> Th√™m Nh√¢n s·ª±
                        </button>
                        <button onclick="window.downloadStaffTemplate()" class="flex items-center justify-center gap-2 px-3 py-3 bg-green-600 text-white rounded-xl text-xs font-bold shadow-lg uppercase">
                            <i data-lucide="file-down" class="w-4 h-4"></i> T·∫£i M·∫´u Excel
                        </button>
                    </div>
                    <div class="relative">
                        <input type="file" id="import-staff-file" accept=".xlsx" onchange="window.handleStaffImport(event)" class="hidden">
                        <label for="import-staff-file" class="flex items-center justify-center gap-2 w-full px-5 py-3 bg-white dark:bg-slate-800 border border-dashed border-slate-300 dark:border-slate-600 text-slate-500 rounded-xl cursor-pointer hover:bg-slate-50 dark:hover:bg-white/5 transition font-bold text-xs uppercase">
                            <i data-lucide="upload" class="w-4 h-4"></i> Import Excel
                        </label>
                    </div>
                    <input type="text" id="staff-search-admin" placeholder="T√¨m t√™n, ch·ª©c v·ª•..." oninput="window.renderStaffListAdmin()" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm">
                    <div id="staff-list-admin" class="space-y-3 pb-20"></div>
                </div>
                
                <!-- Tab Trash -->
                <div id="tab-trash" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Th√πng r√°c</h4>
                    <div id="trash-list" class="space-y-2"></div>
                    <button onclick="window.clearTrashConfirm(true)" id="clear-trash-btn" class="w-full py-3 bg-red-600 text-white rounded-xl font-bold shadow-lg uppercase text-xs hidden">D·ªåN S·∫†CH Vƒ®NH VI·ªÑN</button>
                </div>
                
                <!-- Tab Announcement -->
                <div id="tab-announcement" class="hidden space-y-8">
                    <h4 class="text-sm font-black uppercase tracking-widest text-primary border-b pb-2">Th√¥ng b√°o</h4>
                    <textarea id="announcement-content" placeholder="N·ªôi dung th√¥ng b√°o..." rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">B·∫Øt ƒë·∫ßu t·ª´</label><input type="datetime-local" id="announcement-start" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">K·∫øt th√∫c v√†o</label><input type="datetime-local" id="announcement-end" class="w-full p-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></div>
                    </div>
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5">
                        <label class="text-sm font-bold opacity-60">K√≠ch ho·∫°t Ch·∫°y ch·ªØ</label>
                        <div class="flex gap-2">
                           <button onclick="window.saveAnnouncementContent(true)" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all bg-primary text-white hover:bg-indigo-600">L∆∞u/B·∫≠t</button>
                           <button id="toggle-announcement-btn" onclick="window.toggleAnnouncementStatus()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all">T·∫Øt</button>
                        </div>
                    </div>
                    <div class="space-y-4 pt-6 border-t dark:border-white/5">
                        <h4 class="text-sm font-black uppercase tracking-widest text-secondary border-b pb-2">T·∫°o Th√¥ng B√°o M·ªõi</h4>
                        <input type="text" id="notify-title" placeholder="Ti√™u ƒë·ªÅ..." class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-bold">
                        <textarea id="notify-content" placeholder="N·ªôi dung..." rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                        <input type="text" id="notify-icon" placeholder="Icon URL" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium">
                        <button onclick="window.publishNotification()" class="w-full py-4 bg-secondary text-white rounded-xl font-bold shadow-lg uppercase text-xs hover:bg-red-600 transition">ƒêƒÉng</button>
                    </div>
                    <div class="space-y-4 pt-6 border-t dark:border-white/5">
                        <h4 class="text-sm font-black uppercase tracking-widest text-slate-500 border-b pb-2">Danh s√°ch</h4>
                        <div id="admin-notify-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Tab Deputy -->
                <div id="tab-deputy" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Ph√≥ Admin</h4>
                    <div id="deputy-guard" class="hidden p-4 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-xl text-xs font-bold uppercase">Ch·ªâ Super Admin m·ªõi qu·∫£n l√Ω ƒë∆∞·ª£c m·ª•c n√†y.</div>
                    <div id="deputy-ui" class="space-y-4">
                        <div class="flex gap-2">
                            <input type="email" id="new-deputy-email" placeholder="Gmail..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                            <button onclick="window.addDeputy()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">C·∫§P QUY·ªÄN</button>
                        </div>
                        <div id="deputy-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Tab Users -->
                <div id="tab-users" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Danh s√°ch Ng∆∞·ªùi d√πng</h4>
                    <div id="users-list" class="space-y-2 max-h-[50vh] overflow-y-auto"></div>
                    <div id="user-request-info" class="p-4 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-200 rounded-xl text-xs font-bold">
                        <p id="old-request-list" class="mt-2 space-y-1"></p>
                    </div>
                </div>

                <!-- Tab Logs -->
                <div id="tab-logs" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Nh·∫≠t k√Ω Ho·∫°t ƒë·ªông</h4>
                    <div id="logs-list" class="space-y-2 max-h-[50vh] overflow-y-auto"></div>
                </div>

                <!-- Tab Data -->
                <div id="tab-data" class="hidden space-y-8">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Xu·∫•t/Nh·∫≠p D·ªØ Li·ªáu</h4>
                    <div class="grid gap-6">
                        <div class="p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-[2rem] border border-yellow-200 dark:border-yellow-700 space-y-4">
                            <h4 class="text-xs font-black uppercase tracking-widest text-yellow-700 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="shield-alert" class="w-4 h-4"></i> CH·∫æ ƒê·ªò B·∫¢O TR√å</h4>
                            <div class="flex items-center justify-between">
                                <span id="maintenance-status" class="text-sm font-bold">Tr·∫°ng th√°i: T·∫Øt</span>
                                <button onclick="window.toggleMaintenanceMode()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all bg-slate-500 text-white" id="maintenance-toggle-btn">B·∫¨T CH·∫æ ƒê·ªò</button>
                            </div>
                        </div>
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <div class="flex flex-col gap-2">
                                <button onclick="window.handleExport('json')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm"><span class="text-sm font-bold">Xu·∫•t file JSON</span><i data-lucide="download" class="w-4 h-4"></i></button>
                                <button onclick="window.handleExport('excel')" class="flex items-center justify-between w-full px-5 py-3 bg-white dark:bg-slate-800 rounded-xl hover:ring-2 ring-indigo-500 transition shadow-sm"><span class="text-sm font-bold">Xu·∫•t file EXCEL</span><i data-lucide="file-spreadsheet" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="p-6 bg-slate-50 dark:bg-white/5 rounded-[2rem] border dark:border-white/5 space-y-4">
                            <div class="relative">
                                <input type="file" id="import-file" accept=".json, .xlsx" onchange="window.handleImport(event)" class="hidden">
                                <label for="import-file" class="flex items-center justify-center gap-3 w-full px-5 py-4 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-xl cursor-pointer hover:opacity-90 transition font-bold text-xs uppercase"><i data-lucide="upload-cloud" class="w-5 h-5"></i> Ch·ªçn file ƒë·ªÉ kh√¥i ph·ª•c</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Nav Bar -->
    <nav id="mobile-nav-bar" class="fixed bottom-0 left-0 w-full z-100 bg-white dark:bg-slate-900 border-t dark:border-white/10 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] md:hidden">
        <div class="flex justify-around items-center h-16">
            <button onclick="window.switchMobileTab('app')" id="tab-app-btn" class="flex flex-col items-center justify-center w-full h-full text-primary">
                <i data-lucide="layout-grid" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">·ª®ng D·ª•ng</span>
            </button>
            <button onclick="window.switchMobileTab('contact')" id="tab-contact-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <i data-lucide="users" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">Danh B·∫°</span>
            </button>
             <button onclick="window.switchMobileTab('hr')" id="tab-hr-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <i data-lucide="users-2" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">Nh√¢n S·ª±</span>
            </button>
            <button onclick="window.switchMobileTab('notify')" id="tab-notify-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <div class="relative">
                    <i data-lucide="bell" class="w-5 h-5"></i><span id="unread-count" class="absolute -top-1 -right-1 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-[8px] font-black px-1.5 rounded-full hidden">0</span>
                </div>
                <span class="text-[9px] font-bold mt-1">Th√¥ng B√°o</span>
            </button>
            <button onclick="window.switchMobileTab('profile')" id="tab-profile-btn" class="flex flex-col items-center justify-center w-full h-full text-slate-400">
                <i data-lucide="user-circle" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">C√° Nh√¢n</span>
            </button>
        </div>
    </nav>

    <!-- App Modal -->
    <div id="modal-app" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="app-modal-title" class="font-bold uppercase text-sm tracking-widest">C·∫•u h√¨nh</h3>
                <button onclick="window.closeModal('modal-app')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="app-form" class="p-8 space-y-4">
                <input type="hidden" id="edit-id">
                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh m·ª•c</label><select id="app-category" onchange="window.toggleFormFields()" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select></div>
                <div class="space-y-1"><label id="label-name" class="text-[10px] font-bold text-slate-400 uppercase ml-1">T√™n hi·ªÉn th·ªã</label><input type="text" id="app-name" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></div>
                <div id="field-position" class="space-y-1 hidden"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ch·ª©c v·ª•</label><input type="text" id="app-position" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></div>
                <div class="space-y-1"><label id="label-link" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Link URL</label><input type="text" id="app-link" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></div>
                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Icon URL</label><input type="text" id="app-icon" placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ t·ª± l·∫•y" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></div>
                <div class="flex items-center gap-3 p-2"><input type="checkbox" id="app-visible" checked class="w-5 h-5 accent-primary"><label class="text-xs font-bold opacity-60">Hi·ªÉn th·ªã c√¥ng khai</label></div>
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs">L∆∞u ·ª©ng d·ª•ng</button>
            </form>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="modal-staff" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[220] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2rem] w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">Th√¥ng tin Nh√¢n s·ª±</h3>
                <button onclick="window.closeModal('modal-staff')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="staff-form" class="p-8 space-y-4 overflow-y-auto flex-1">
                <input type="hidden" id="staff-edit-id">
                <div class="flex gap-4 flex-col sm:flex-row">
                    <div class="space-y-2 text-center sm:w-1/3">
                        <div class="w-32 h-32 mx-auto bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden border-4 border-white dark:border-slate-700 shadow-lg relative group">
                            <img id="staff-preview-img" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full object-cover">
                        </div>
                        <input type="text" id="staff-photo" placeholder="URL ·∫¢nh" oninput="document.getElementById('staff-preview-img').src = this.value || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" class="w-full px-3 py-2 bg-slate-50 dark:bg-white/5 rounded-lg text-xs border-none text-center">
                    </div>
                    <div class="flex-1 space-y-3">
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">H·ªç v√† T√™n (*)</label><input type="text" id="staff-name" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-bold"></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ng√†y sinh</label><input type="date" id="staff-dob" class="w-full px-4 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm"></div>
                            <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Gi·ªõi t√≠nh</label><select id="staff-gender" class="w-full px-4 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm"><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option><option value="Kh√°c">Kh√°c</option></select></div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ch·ª©c v·ª• / V·ªã tr√≠</label><input type="text" id="staff-position" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">S·ªë CCCD / CMND</label><input type="text" id="staff-cccd" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></div>
                </div>
                <div class="p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5 space-y-3">
                    <div class="flex items-center gap-2 mb-2"><i data-lucide="credit-card" class="w-4 h-4 text-primary"></i><h4 class="text-xs font-black uppercase tracking-widest">Th√¥ng tin Ng√¢n h√†ng</h4></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ch·ªçn Ng√¢n h√†ng</label><select id="staff-bank-select" onchange="window.updateBankLogo()" class="w-full px-4 py-3 bg-white dark:bg-slate-800 rounded-xl outline-none text-sm border dark:border-white/10"><option value="">-- Ch·ªçn ng√¢n h√†ng --</option></select></div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">S·ªë t√†i kho·∫£n</label><input type="text" id="staff-bank-acc" class="w-full px-4 py-3 bg-white dark:bg-slate-800 rounded-xl outline-none text-sm border dark:border-white/10"></div>
                    </div>
                    <div id="bank-info-preview" class="hidden items-center gap-3 mt-2 p-2 bg-white dark:bg-slate-800 rounded-lg"><img id="selected-bank-logo" class="h-8 object-contain"><span id="selected-bank-name" class="text-xs font-bold text-slate-500"></span></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Th√¥ng tin th√™m (C·ªôt t√πy ch·ªânh)</label><button type="button" onclick="window.addCustomField()" class="text-xs text-primary font-bold hover:underline">+ Th√™m tr∆∞·ªùng</button></div>
                    <div id="staff-custom-fields" class="space-y-2"></div>
                </div>
                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ghi ch√∫</label><textarea id="staff-notes" rows="2" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></textarea></div>
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs mt-4">L∆∞u Nh√¢n s·ª±</button>
            </form>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="modal-user-profile" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">Th√¥ng tin T√†i kho·∫£n</h3>
                <button onclick="window.closeModal('modal-user-profile')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="flex flex-col items-center">
                    <img id="profile-photo" class="w-20 h-20 rounded-full mb-3 border-4 border-primary/20 p-0.5 shadow-md" alt="Avatar">
                    <span id="profile-role" class="text-[10px] font-black uppercase tracking-widest px-3 py-1 bg-primary/10 text-primary rounded-full"></span>
                </div>
                <div class="space-y-4">
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">T√™n hi·ªÉn th·ªã</label><input type="text" id="profile-name" readonly class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm font-medium border-none"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Email</label><input type="email" id="profile-email" readonly class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl text-slate-500 text-sm font-medium border-none"></div>
                    <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">UID Firebase</label><p id="profile-uid" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl text-xs font-mono truncate"></p></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[220] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-sm shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="confirm-modal-title" class="font-bold uppercase text-sm tracking-widest text-red-500">X√°c nh·∫≠n</h3>
                <button onclick="window.closeModal('modal-confirm')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <p id="confirm-modal-message" class="text-sm text-slate-700 dark:text-slate-300"></p>
                <div class="flex justify-end gap-3"><button onclick="window.closeModal('modal-confirm')" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-slate-200 dark:bg-slate-700">H·ªßy</button><button id="confirm-modal-btn" class="px-5 py-3 rounded-xl font-bold text-xs uppercase bg-red-500 text-white shadow-lg">X√°c nh·∫≠n</button></div>
            </div>
        </div>
    </div>
    
    <!-- Category Migrate Modal -->
    <div id="modal-cat-migrate" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-red-500">Chuy·ªÉn ƒë·ªïi ·ª®ng d·ª•ng</h3>
                <button onclick="window.closeModal('modal-cat-migrate')" class="p-2 rounded-lg hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 space-y-4">
                <p id="cat-migrate-message" class="text-sm text-slate-700 dark:text-slate-300">Vui l√≤ng ch·ªçn danh m·ª•c m·ªõi ƒë·ªÉ chuy·ªÉn <span id="cat-migrate-count" class="font-bold"></span> ·ª©ng d·ª•ng ƒë·∫øn tr∆∞·ªõc khi x√≥a.</p>
                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Danh m·ª•c m·ªõi</label><select id="cat-migrate-select" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary text-sm font-medium"></select></div>
                <button onclick="window.executeCatDeleteAndMigrate()" class="w-full py-4 bg-red-500 text-white rounded-xl font-bold shadow-lg uppercase text-xs">X√ÅC NH·∫¨N</button>
            </div>
        </div>
    </div>

    <!-- Notification Detail Modal -->
    <div id="modal-notification-detail" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 id="notify-detail-title" class="font-bold uppercase text-sm tracking-widest text-primary"></h3>
                <button onclick="window.closeModal('modal-notification-detail')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 max-h-[70vh] overflow-y-auto space-y-4">
                <div class="flex items-center gap-3"><img id="notify-detail-icon" class="w-10 h-10 rounded-full object-contain"><div><p class="text-[10px] font-bold text-slate-400 uppercase">ƒêƒÉng b·ªüi: <span id="notify-detail-sender"></span></p><p class="text-[10px] font-bold text-slate-400 uppercase">L√∫c: <span id="notify-detail-timestamp"></span></p></div></div>
                <p id="notify-detail-content" class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap p-4 bg-slate-50 dark:bg-slate-800 rounded-xl"></p>
            </div>
        </div>
    </div>
    
    <!-- Privacy Modal -->
    <div id="modal-privacy-settings" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-2xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center">
                <h3 class="font-bold uppercase text-sm tracking-widest text-primary">C√ÄI ƒê·∫∂T QUY·ªÄN RI√äNG T∆Ø</h3>
                <button onclick="window.closeModal('modal-privacy-settings')" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 max-h-[70vh] overflow-y-auto space-y-6">
                <div id="privacy-settings-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed z-[300]" onclick="window.closeToast()">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border dark:border-white/10">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i><span id="toast-msg" class="text-sm font-bold tracking-tight"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch, increment, runTransaction, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", authDomain: "profile-d1214.firebaseapp.com", projectId: "profile-d1214", storageBucket: "profile-d1214.firebasestorage.app", messagingSenderId: "914980131889", appId: "1:914980131889:web:72f8da15c42dbee671b110", measurementId: "G-C587M69LZW" };
        const LOGS_COLLECTION = "activityLogs"; const NOTIFY_COLLECTION = "notifications"; const USERS_COLLECTION = "users"; const STAFF_COLLECTION = "staff";

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        let currentUser = null, isAdmin = false, isSuper = false, apps = [], categories = [], deputies = [], currentFilter = 'all', searchQuery = '', viewMode = 'grid', visitStats = {}, appsLoaded = false, bulkDeleteMode = false, selectedAppsForDelete = new Set(), currentAnnouncement = {}, adminRequests = [], globalSettings = {}, activityLogs = [], discoverApps = [], notifications = [], allUsers = [], unreadCount = 0, confirmActionCallback = () => {}, currentMobileTab = 'app', currentLang = 'vi', toastTimeout = null, catToDeleteId = null, loadingTimeout = null;
        
        let staffList = [], vietQrBanks = [], viewModeHR = localStorage.getItem('viewModeHR') || 'grid';

        // Fetch Banks
        fetch('https://api.vietqr.io/v2/banks').then(res => res.json()).then(data => { if (data.code === "00") { vietQrBanks = data.data; renderBankOptions(); } });
        function renderBankOptions() {
            const select = document.getElementById('staff-bank-select');
            if(select) { vietQrBanks.sort((a, b) => a.shortName.localeCompare(b.shortName)); select.innerHTML = '<option value="">-- Ch·ªçn ng√¢n h√†ng --</option>' + vietQrBanks.map(b => `<option value="${b.code}" data-logo="${b.logo}" data-name="${b.shortName}">${b.shortName} - ${b.name}</option>`).join(''); }
        }
        window.updateBankLogo = () => {
            const select = document.getElementById('staff-bank-select'); const selectedOpt = select.options[select.selectedIndex];
            if (selectedOpt.value) { document.getElementById('selected-bank-logo').src = selectedOpt.getAttribute('data-logo'); document.getElementById('selected-bank-name').innerText = selectedOpt.getAttribute('data-name'); document.getElementById('bank-info-preview').classList.remove('hidden'); document.getElementById('bank-info-preview').classList.add('flex'); } else { document.getElementById('bank-info-preview').classList.add('hidden'); }
        };

        const PRIVACY_SETTINGS = [{ key: 'location', name: 'V·ªã tr√≠', icon: 'map-pin' }, { key: 'camera', name: 'Camera', icon: 'camera' }, { key: 'notifications', name: 'Th√¥ng b√°o', icon: 'bell' }]; // Shortened for brevity
        window.renderPrivacySettings = () => { document.getElementById('privacy-settings-list').innerHTML = PRIVACY_SETTINGS.map(s => `<div class="flex items-center justify-between p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5"><div class="flex items-center gap-3"><i data-lucide="${s.icon}" class="w-5 h-5 text-primary"></i><span class="text-sm font-bold">${s.name}</span></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" checked class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:bg-primary"></div></label></div>`).join(''); lucide.createIcons(); };
        window.openPrivacyModal = () => { window.renderPrivacySettings(); window.openModal('modal-privacy-settings'); };

        window.showGlobalLoading = () => { document.getElementById('global-loading-overlay').classList.remove('opacity-0', 'pointer-events-none'); clearTimeout(loadingTimeout); loadingTimeout = setTimeout(() => { document.getElementById('loading-content').innerHTML = `<p class="text-sm">T·∫£i qu√° l√¢u! <button onclick="location.reload()" class="text-primary font-bold">T·∫£i l·∫°i</button></p>`; }, 30000); };
        window.hideGlobalLoading = () => { clearTimeout(loadingTimeout); document.getElementById('global-loading-overlay').classList.add('opacity-0', 'pointer-events-none'); };
        
        window.requestNotificationPermission = () => { Notification.requestPermission().then(p => showToast(p === "granted" ? "ƒê√£ c·∫•p quy·ªÅn th√¥ng b√°o!" : "ƒê√£ t·ª´ ch·ªëi quy·ªÅn.")); };
        window.sendBrowserNotification = (title, body) => { if (Notification.permission === "granted") new Notification(title, { body, icon: 'https://hdd.io.vn/img/bmassloadings.png' }); };

        window.setLang = (lang) => { currentLang = lang; localStorage.setItem('language', lang); document.getElementById('current-lang-text').innerText = lang === 'vi' ? 'üáªüá≥ Vi·ªát Nam' : 'üá∫üá∏ English'; showToast(`ƒê·ªïi ng√¥n ng·ªØ: ${lang.toUpperCase()}`); };
        window.showConfirm = (title, message, callback, confirmText = 'X√ÅC NH·∫¨N') => { if (!isAdmin) return; document.getElementById('confirm-modal-title').innerText = title; document.getElementById('confirm-modal-message').innerText = message; document.getElementById('confirm-modal-btn').innerText = confirmText; confirmActionCallback = callback; document.getElementById('confirm-modal-btn').onclick = () => { window.closeModal('modal-confirm'); confirmActionCallback(); }; window.openModal('modal-confirm'); };
        
        function checkMaintenanceMode() { const active = globalSettings.maintenanceMode; document.getElementById('maintenance-overlay').classList.toggle('hidden', !active || isAdmin); document.getElementById('main-content-wrapper').classList.toggle('hidden', active && !isAdmin); document.getElementById('mobile-nav-bar').classList.toggle('hidden', active && !isAdmin); }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user; window.showGlobalLoading();
            try {
                if (user) {
                    const snap = await getDoc(doc(db, "settings", "admins")); const data = snap.data() || {};
                    isSuper = user.uid === data.super_uid; deputies = data.deputy_emails || []; isAdmin = isSuper || deputies.includes(user.email);
                    renderAuthUI(); renderProfileContent(); document.getElementById('profile-admin-panel-btn')?.classList.toggle('hidden', !isAdmin);
                    document.getElementById('request-admin-section').classList.toggle('hidden', isAdmin);
                    if(isAdmin) document.getElementById('announcement-content').value = currentAnnouncement.content || '';
                } else { isAdmin = isSuper = false; renderAuthUI(); renderProfileContent(); document.getElementById('request-admin-section').classList.add('hidden'); }
                document.getElementById('role-status').innerText = isSuper ? 'SUPER' : (isAdmin ? 'DEPUTY' : 'GUEST');
                document.getElementById('admin-sidebar-toggle').classList.toggle('hidden', !isAdmin);
                checkMaintenanceMode();
                viewMode = localStorage.getItem('viewModeDesktop') || 'grid'; window.setView(viewMode, true);
                renderApps(); renderDeputyList(); renderAnnouncementControls(); renderStaffListAdmin();
                window.switchMobileTab('app', window.innerWidth > 768);
            } catch (e) { console.error(e); } finally { window.hideGlobalLoading(); }
        });

        function renderAuthUI() {
            const container = document.getElementById('auth-section');
            if (!currentUser) { container.innerHTML = `<button onclick="window.login()" class="bg-primary text-white px-5 py-2 rounded-lg text-xs font-bold uppercase">Login</button>`; return; }
            container.innerHTML = `<div class="relative"><button onclick="document.getElementById('user-menu').classList.toggle('hidden')" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 pr-3 rounded-lg"><img src="${currentUser.photoURL}" class="w-7 h-7 rounded-md"><i data-lucide="chevron-down" class="w-3 h-3 text-slate-400"></i></button><div id="user-menu" class="absolute right-0 top-full mt-3 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-2xl z-20 hidden p-2"><div class="px-3 py-2 text-sm font-bold truncate">${currentUser.displayName}</div><button onclick="window.openUserProfileModal()" class="flex items-center w-full px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">T√†i kho·∫£n</button><button onclick="window.logout()" class="flex items-center w-full px-3 py-2 text-sm text-red-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">ƒêƒÉng xu·∫•t</button></div></div>`; lucide.createIcons();
        }
        window.openUserProfileModal = () => { if (!currentUser) return; document.getElementById('profile-name').value = currentUser.displayName; document.getElementById('profile-email').value = currentUser.email; document.getElementById('profile-uid').innerText = currentUser.uid; document.getElementById('profile-role').innerText = isSuper ? 'SUPER ADMIN' : (isAdmin ? 'PH√ì ADMIN' : 'KH√ÅCH'); document.getElementById('profile-photo').src = currentUser.photoURL; window.openModal('modal-user-profile'); };
        
        window.login = () => { window.showGlobalLoading(); signInWithPopup(auth, provider).catch(() => window.hideGlobalLoading()); };
        window.logout = () => { window.showGlobalLoading(); signOut(auth).then(() => location.reload()); };
        
        document.getElementById('request-admin-form').onsubmit = async (e) => { e.preventDefault(); if (!currentUser) return; const reason = document.getElementById('request-admin-reason').value.trim(); try { await setDoc(doc(db, "adminRequests", currentUser.uid), { uid: currentUser.uid, email: currentUser.email, name: currentUser.displayName, reason: reason, timestamp: new Date().toISOString() }); showToast("ƒê√£ g·ª≠i y√™u c·∫ßu!"); document.getElementById('request-admin-form').classList.add('hidden'); } catch (e) { showToast("L·ªói!", true); } };

        window.toggleAdminSidebar = () => { document.getElementById('admin-sidebar').classList.toggle('open'); if(window.innerWidth<=768) document.getElementById('mobile-category-sidebar').classList.remove('open'); };
        window.toggleMobileCategorySidebar = () => document.getElementById('mobile-category-sidebar').classList.toggle('open');

        window.switchMobileTab = (tabId, isDesktop = false) => {
            currentMobileTab = tabId; const contents = ['tab-app-content', 'tab-notify-content', 'tab-discover-content', 'tab-profile-content', 'tab-hr-content']; const btns = ['tab-app-btn', 'tab-contact-btn', 'tab-notify-btn', 'tab-profile-btn', 'tab-hr-btn'];
            btns.forEach(id => { const b = document.getElementById(id); if(b) { b.classList.remove('text-primary'); b.classList.add('text-slate-400'); } });
            contents.forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById('search-container').classList.add('hidden'); document.getElementById('visit-stats-container').classList.add('hidden');

            if (tabId === 'app' || tabId === 'contact') {
                document.getElementById('tab-app-content').classList.remove('hidden'); document.getElementById('search-container').classList.remove('hidden'); document.getElementById('visit-stats-container').classList.remove('hidden');
                const btnId = tabId === 'app' ? 'tab-app-btn' : 'tab-contact-btn'; document.getElementById(btnId).classList.add('text-primary');
                if (tabId === 'contact') window.setFilter('contact_filter', false, false);
            } else {
                const cId = tabId === 'hr' ? 'tab-hr-content' : (tabId === 'notify' ? 'tab-notify-content' : `tab-${tabId}-content`);
                document.getElementById(cId).classList.remove('hidden');
                document.getElementById(`tab-${tabId}-btn`).classList.add('text-primary');
                if (tabId === 'hr') renderStaffPublic();
                if (tabId === 'notify') renderNotifications();
                if (tabId === 'discover') renderDiscoverContent();
                if (tabId === 'profile') renderProfileContent();
            }
            if (isDesktop) { document.getElementById('search-container').classList.remove('hidden'); document.getElementById('visit-stats-container').classList.remove('hidden'); }
            lucide.createIcons();
        };

        onSnapshot(query(collection(db, "categories"), orderBy("order", "asc")), (s) => { categories = s.docs.map(d => ({ id: d.id, ...d.data() })); renderCategories(); document.getElementById('cat-migrate-select').innerHTML = categories.filter(c => c.id !== catToDeleteId).map(c => `<option value="${c.id}">${c.name}</option>`).join(''); });
        onSnapshot(query(collection(db, "apps"), orderBy("order", "asc")), (s) => { apps = s.docs.map(d => ({ id: d.id, ...d.data() })); appsLoaded = true; renderApps(); renderTrash(); });
        onSnapshot(doc(db, "settings", "visits_stats"), (s) => { visitStats = s.data() || {}; renderStats(); });
        onSnapshot(doc(db, "settings", "announcement"), (s) => { currentAnnouncement = s.data() || {}; renderAnnouncementBar(); renderAnnouncementControls(); });
        onSnapshot(collection(db, "adminRequests"), (s) => { adminRequests = s.docs.map(d => ({ id: d.id, ...d.data() })); if (isAdmin) renderUserList(); });
        onSnapshot(doc(db, "settings", "global"), (s) => { globalSettings = s.data() || {}; checkMaintenanceMode(); });
        onSnapshot(doc(db, "settings", "discover"), (s) => { discoverApps = s.data()?.apps || []; renderDiscoverContent(); });
        onSnapshot(query(collection(db, LOGS_COLLECTION), orderBy("timestamp", "desc"), limit(50)), (s) => { activityLogs = s.docs.map(d => ({ id: d.id, ...d.data() })); renderActivityLogs(); });
        onSnapshot(query(collection(db, NOTIFY_COLLECTION), orderBy("timestamp", "desc")), (s) => { notifications = s.docs.map(d => ({ id: d.id, ...d.data() })); renderNotifications(); renderAdminNotificationList(); updateUnreadCount(); });
        onSnapshot(query(collection(db, USERS_COLLECTION), orderBy("lastLogin", "desc")), (s) => { allUsers = s.docs.map(d => ({ id: d.id, ...d.data() })); if (isAdmin) renderUserList(); });
        
        // HR Realtime
        onSnapshot(query(collection(db, STAFF_COLLECTION), orderBy("name", "asc")), (s) => { staffList = s.docs.map(d => ({ id: d.id, ...d.data() })); renderStaffListAdmin(); renderStaffPublic(); populateDeptFilter(); });

        function renderDiscoverContent() { document.getElementById('discover-content-list').innerHTML = discoverApps.length ? discoverApps.map(a => `<a href="${a.url}" target="_blank" class="flex items-center gap-4 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm"><img src="${a.iconUrl}" class="w-10 h-10 rounded-lg"><div class="flex-1"><h4 class="font-bold">${a.name}</h4><p class="text-[10px] text-slate-400">${a.description}</p></div><i data-lucide="external-link" class="w-5 h-5 text-primary"></i></a>`).join('') : '<div class="text-center p-10 text-slate-400">Tr·ªëng</div>'; lucide.createIcons(); }
        
        function updateUnreadCount() { unreadCount = currentUser ? notifications.filter(n => !(n.readBy || []).includes(currentUser.uid)).length : 0; const b = document.getElementById('unread-count'); if(b) { b.innerText = unreadCount > 99 ? '99+' : unreadCount; b.classList.toggle('hidden', unreadCount === 0); } }
        window.markAndOpenNotification = async (id) => { if (currentUser) await updateDoc(doc(db, NOTIFY_COLLECTION, id), { readBy: arrayUnion(currentUser.uid) }); const n = notifications.find(x => x.id === id); if(n) { document.getElementById('notify-detail-title').innerText = n.title; document.getElementById('notify-detail-content').innerText = n.content; document.getElementById('notify-detail-sender').innerText = n.senderName; document.getElementById('notify-detail-timestamp').innerText = new Date(n.timestamp).toLocaleString('vi'); document.getElementById('notify-detail-icon').src = n.iconUrl; window.openModal('modal-notification-detail'); } };
        window.renderNotifications = () => { document.getElementById('notification-content-list').innerHTML = notifications.length ? notifications.map(n => `<div class="flex gap-4 p-4 rounded-xl border dark:border-white/5 cursor-pointer ${currentUser && (n.readBy||[]).includes(currentUser.uid) ? 'opacity-70' : 'bg-white dark:bg-slate-900 border-l-4 border-primary shadow-lg'}" onclick="window.markAndOpenNotification('${n.id}')"><img src="${n.iconUrl}" class="w-8 h-8 rounded-full"><div class="flex-1"><h4 class="font-bold text-sm">${n.title}</h4><p class="text-xs text-slate-500 truncate">${n.content}</p></div></div>`).join('') : '<div class="text-center p-10 text-slate-400">Kh√¥ng c√≥ th√¥ng b√°o.</div>'; lucide.createIcons(); };
        window.publishNotification = async () => { if (!isAdmin) return; const t = document.getElementById('notify-title').value, c = document.getElementById('notify-content').value, i = document.getElementById('notify-icon').value; if(t.length<5) return showToast("Ti√™u ƒë·ªÅ ng·∫Øn!", true); try { await addDoc(collection(db, NOTIFY_COLLECTION), { title: t, content: c, iconUrl: i, timestamp: new Date().toISOString(), senderName: currentUser.displayName, readBy: [] }); showToast("ƒê√£ ƒëƒÉng!"); } catch(e){ showToast("L·ªói!", true); } };
        window.deleteNotification = async (id) => { if(!isAdmin) return; try{ await deleteDoc(doc(db, NOTIFY_COLLECTION, id)); showToast("ƒê√£ x√≥a!"); } catch(e){ showToast("L·ªói!", true); } };
        function renderAdminNotificationList() { if(!isAdmin) return; document.getElementById('admin-notify-list').innerHTML = notifications.map(n => `<div class="flex justify-between p-3 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5"><span class="font-bold text-sm truncate w-2/3">${n.title}</span><button onclick="window.deleteNotification('${n.id}')" class="text-red-500 text-xs font-bold">X√ìA</button></div>`).join(''); }

        function renderAnnouncementBar() { const bar = document.getElementById('announcement-bar'), txt = document.getElementById('announcement-text'), now = Date.now(), s = new Date(currentAnnouncement.startTime||0).getTime(), e = new Date(currentAnnouncement.endTime||8640000000000000).getTime(); if (currentAnnouncement.active && currentAnnouncement.content && now >= s && now <= e) { txt.innerText = currentAnnouncement.content.toUpperCase(); bar.classList.remove('hidden'); } else bar.classList.add('hidden'); }
        function renderAnnouncementControls() { if (!isAdmin) return; const btn = document.getElementById('toggle-announcement-btn'); btn.innerText = currentAnnouncement.active ? 'T·∫ÆT' : 'B·∫¨T'; btn.className = `px-5 py-2 rounded-xl font-bold text-xs uppercase ${currentAnnouncement.active ? 'bg-red-500 text-white' : 'bg-slate-500 text-white'}`; }
        window.saveAnnouncementContent = async (active) => { if(!isAdmin) return; try { await setDoc(doc(db, "settings", "announcement"), { content: document.getElementById('announcement-content').value, startTime: document.getElementById('announcement-start').value, endTime: document.getElementById('announcement-end').value, active: active }, { merge: true }); showToast("ƒê√£ l∆∞u!"); } catch(e){ showToast("L·ªói!", true); } };
        window.toggleAnnouncementStatus = () => window.saveAnnouncementContent(!currentAnnouncement.active);

        window.requestApproveConfirm = (uid, email) => window.showConfirm('Duy·ªát', `C·∫•p quy·ªÅn cho ${email}?`, async () => { await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true }); await deleteDoc(doc(db, "adminRequests", uid)); location.reload(); });
        window.requestRejectConfirm = (uid) => window.showConfirm('T·ª´ ch·ªëi', 'X√≥a y√™u c·∫ßu n√†y?', async () => { await deleteDoc(doc(db, "adminRequests", uid)); showToast("ƒê√£ t·ª´ ch·ªëi!"); });

        function renderUserList() {
            if (!isAdmin) return;
            document.getElementById('user-count').innerText = `(${adminRequests.length})`;
            document.getElementById('old-request-list').innerHTML = adminRequests.length ? adminRequests.map(r => `<div class="p-3 bg-white dark:bg-slate-800 rounded-xl space-y-2"><p class="font-bold text-sm">${r.name}</p><div class="flex gap-2"><button onclick="window.requestApproveConfirm('${r.uid}','${r.email}')" class="flex-1 bg-green-500 text-white text-xs py-1 rounded">DUY·ªÜT</button><button onclick="window.requestRejectConfirm('${r.uid}')" class="flex-1 bg-red-500 text-white text-xs py-1 rounded">H·ª¶Y</button></div></div>`).join('') : 'Kh√¥ng c√≥ y√™u c·∫ßu.';
            document.getElementById('users-list').innerHTML = allUsers.map(u => `<div class="flex justify-between p-3 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5"><div class="truncate"><h4 class="font-bold text-sm">${u.name}</h4><p class="text-xs text-slate-500">${u.email}</p></div><span class="text-[9px] font-bold bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded h-fit">${deputies.includes(u.email) ? 'DEPUTY' : (u.uid === (auth.currentUser?.uid) && isSuper ? 'SUPER' : 'USER')}</span></div>`).join('');
        }

        window.executeBulkDelete = () => window.showConfirm('X√≥a h√†ng lo·∫°t', `Chuy·ªÉn ${selectedAppsForDelete.size} m·ª•c v√†o th√πng r√°c?`, async () => { const b = writeBatch(db); selectedAppsForDelete.forEach(id => b.update(doc(db, "apps", id), { isDeleted: true, deletedAt: new Date().toISOString() })); await b.commit(); window.toggleBulkDelete(); showToast("ƒê√£ x√≥a!"); });
        window.toggleBulkDelete = () => { if(!isAdmin) return; bulkDeleteMode = !bulkDeleteMode; selectedAppsForDelete.clear(); document.getElementById('bulk-delete-sidebar-toggle').classList.toggle('text-red-500', !bulkDeleteMode); document.getElementById('bulk-delete-dock').classList.add('hidden'); renderApps(); };
        window.toggleAppSelection = (id, e) => { e.stopPropagation(); const el = document.querySelector(`.app-item[data-id="${id}"]`); if (selectedAppsForDelete.has(id)) { selectedAppsForDelete.delete(id); el.classList.remove('selected-for-delete'); } else { selectedAppsForDelete.add(id); el.classList.add('selected-for-delete'); } document.getElementById('selected-count').innerText = selectedAppsForDelete.size; document.getElementById('bulk-delete-dock').classList.toggle('hidden', selectedAppsForDelete.size === 0); };

        async function trackVisit() { try { await runTransaction(db, async (t) => { const ref = doc(db, "settings", "visits_stats"), s = (await t.get(ref)).data()||{}, d = new Date().toISOString().split('T')[0], m = d.slice(0,7), y = d.slice(0,4); t.set(ref, { totalVisits: increment(1), dailyVisits: s.lastDailyUpdate===d ? (s.dailyVisits||0)+1 : 1, monthlyVisits: s.lastMonthlyUpdate===m ? (s.monthlyVisits||0)+1 : 1, yearlyVisits: s.lastYearlyUpdate===y ? (s.yearlyVisits||0)+1 : 1, lastDailyUpdate: d, lastMonthlyUpdate: m, lastYearlyUpdate: y }, { merge: true }); }); } catch(e){} }
        function renderStats() { document.getElementById('visit-stats-container').innerHTML = `<div class="grid grid-cols-4 gap-3 text-center"><div class="p-3 bg-white dark:bg-slate-800 rounded-xl"><p class="text-[10px] text-slate-400">H√¥m nay</p><span class="font-black text-primary">${(visitStats.dailyVisits||0).toLocaleString()}</span></div><div class="p-3 bg-white dark:bg-slate-800 rounded-xl"><p class="text-[10px] text-slate-400">Th√°ng</p><span class="font-black text-primary">${(visitStats.monthlyVisits||0).toLocaleString()}</span></div><div class="p-3 bg-white dark:bg-slate-800 rounded-xl"><p class="text-[10px] text-slate-400">NƒÉm</p><span class="font-black text-primary">${(visitStats.yearlyVisits||0).toLocaleString()}</span></div><div class="p-3 bg-white dark:bg-slate-800 rounded-xl"><p class="text-[10px] text-slate-400">T·ªïng</p><span class="font-black text-primary">${(visitStats.totalVisits||0).toLocaleString()}</span></div></div>`; }

        window.renderApps = () => {
            const container = document.getElementById('app-container'); if (!appsLoaded) { document.getElementById('app-loading').classList.remove('hidden'); container.innerHTML = ''; return; } document.getElementById('app-loading').classList.add('hidden');
            const filtered = apps.filter(a => !a.isDeleted && (currentFilter === 'all' || a.categoryId === currentFilter || (currentMobileTab==='contact' && categories.find(c=>c.id===a.categoryId)?.name==='S·ªë ƒëi·ªán tho·∫°i')) && (a.name.toLowerCase().includes(searchQuery.toLowerCase()) || (a.position||'').toLowerCase().includes(searchQuery.toLowerCase())) && (isAdmin || a.visible));
            
            if (viewMode === 'grid') {
                container.className = "grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-x-4 gap-y-8";
                container.innerHTML = filtered.map(a => `<div class="app-item group flex flex-col items-center relative ${selectedAppsForDelete.has(a.id)?'selected-for-delete':''}" data-id="${a.id}" ${bulkDeleteMode ? `onclick="window.toggleAppSelection('${a.id}', event)"` : ''}><a href="${a.url}" target="_blank" class="w-full aspect-square bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-white/5 flex items-center justify-center p-3 mb-2 hover:-translate-y-1 transition"><img src="${a.iconUrl}" class="w-full h-full object-contain rounded-lg ${a.visible?'':'opacity-40'}"></a><span class="text-[10px] font-bold text-slate-500 text-center truncate w-full uppercase">${a.name}</span>${a.position?`<span class="text-[8px] text-slate-400 font-bold truncate w-full text-center uppercase">${a.position}</span>`:''} ${isAdmin && !bulkDeleteMode ? `<div class="absolute -top-1 -right-1 hidden group-hover:flex flex-col gap-1 z-10"><button onclick="window.editApp('${a.id}')" class="p-1 bg-indigo-500 text-white rounded-full"><i data-lucide="edit-2" class="w-3 h-3"></i></button><button onclick="window.deleteAppConfirm('${a.id}','${a.name}')" class="p-1 bg-red-500 text-white rounded-full"><i data-lucide="trash" class="w-3 h-3"></i></button></div>` : ''} ${bulkDeleteMode ? `<input type="checkbox" class="absolute top-1 right-1 w-5 h-5 accent-red-500 pointer-events-none" ${selectedAppsForDelete.has(a.id)?'checked':''}>` : ''}</div>`).join('');
            } else {
                container.className = "flex flex-col max-w-4xl mx-auto space-y-1";
                container.innerHTML = filtered.map((a,i) => `<div class="app-item flex items-center gap-4 bg-white dark:bg-slate-900 p-3 rounded-xl border dark:border-white/5 shadow-sm ${selectedAppsForDelete.has(a.id)?'selected-for-delete':''}" data-id="${a.id}" ${bulkDeleteMode ? `onclick="window.toggleAppSelection('${a.id}', event)"` : ''}>${bulkDeleteMode?`<input type="checkbox" class="w-5 h-5 accent-red-500 pointer-events-none" ${selectedAppsForDelete.has(a.id)?'checked':''}>`:''}<span class="text-[9px] font-black text-slate-300 w-4">${i+1}</span><img src="${a.iconUrl}" class="w-8 h-8 rounded-lg object-contain"><div class="flex-1"><h4 class="text-xs font-bold truncate">${a.name}</h4></div>${isAdmin && !bulkDeleteMode ? `<div class="flex gap-2"><button onclick="window.editApp('${a.id}')"><i data-lucide="edit-3" class="w-4 h-4"></i></button><i data-lucide="grip-vertical" class="w-4 h-4 cursor-move"></i></div>`:''}</div>`).join('');
                if(isAdmin && !bulkDeleteMode) new Sortable(container, { animation: 150, handle: '.cursor-move', onEnd: () => { Array.from(container.children).forEach((el, i) => updateDoc(doc(db, "apps", el.dataset.id), { order: i })); }});
            }
            lucide.createIcons();
        }

        window.updateCatField = (id, f, v) => updateDoc(doc(db, "categories", id), { [f]: v });
        window.deleteCatConfirm = (id, name) => { catToDeleteId = id; const hasApps = apps.some(a => a.categoryId === id && !a.isDeleted); if(hasApps) { document.getElementById('cat-migrate-count').innerText = apps.filter(a=>a.categoryId===id).length; window.openModal('modal-cat-migrate'); } else window.showConfirm('X√≥a', `X√≥a danh m·ª•c "${name}"?`, () => deleteDoc(doc(db, "categories", id))); };
        window.executeCatDeleteAndMigrate = async () => { const nid = document.getElementById('cat-migrate-select').value; if(!nid) return; window.closeModal('modal-cat-migrate'); window.showGlobalLoading(); const b = writeBatch(db); apps.filter(a => a.categoryId===catToDeleteId).forEach(a => b.update(doc(db, "apps", a.id), { categoryId: nid })); b.delete(doc(db, "categories", catToDeleteId)); await b.commit(); window.hideGlobalLoading(); showToast("ƒê√£ x√≥a v√† chuy·ªÉn!"); };
        window.addCategory = async () => { const n = document.getElementById('new-cat-name').value; if(n) await addDoc(collection(db, "categories"), { name: n, icon: document.getElementById('new-cat-icon').value, order: categories.length }); document.getElementById('new-cat-name').value = ''; };

        window.renderDeputyList = () => { document.getElementById('deputy-list').innerHTML = deputies.map(e => `<div class="flex justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl"><span class="font-bold text-sm">${e}</span>${isSuper ? `<button onclick="window.removeDeputyConfirm('${e}')" class="text-red-500"><i data-lucide="user-minus" class="w-4 h-4"></i></button>` : ''}</div>`).join(''); lucide.createIcons(); document.getElementById('deputy-guard').classList.toggle('hidden', isSuper); document.getElementById('deputy-ui').classList.toggle('hidden', !isSuper); };
        window.addDeputy = async () => { const e = document.getElementById('new-deputy-email').value; if(e && isSuper) await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(e) }, { merge: true }); };
        window.removeDeputyConfirm = (e) => window.showConfirm('Thu h·ªìi quy·ªÅn', `X√≥a quy·ªÅn c·ªßa ${e}?`, async () => await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayRemove(e) }, { merge: true }));
        window.toggleMaintenanceMode = () => window.showConfirm(globalSettings.maintenanceMode?'T·∫ÆT':'B·∫¨T', 'ƒê·ªïi tr·∫°ng th√°i b·∫£o tr√¨?', async () => await setDoc(doc(db, "settings", "global"), { maintenanceMode: !globalSettings.maintenanceMode }, { merge: true }));

        function renderActivityLogs() { document.getElementById('logs-list').innerHTML = activityLogs.map(l => `<div class="p-4 bg-white dark:bg-slate-800 rounded-xl text-xs border dark:border-white/5"><p class="font-bold text-primary">${l.type}: ${l.itemName}</p><p class="text-slate-500">${l.adminEmail} | ${new Date(l.timestamp).toLocaleString()}</p></div>`).join(''); }

        function renderTrash() { const list = document.getElementById('trash-list'); const del = apps.filter(a => a.isDeleted); document.getElementById('clear-trash-btn').classList.toggle('hidden', del.length===0); list.innerHTML = del.length ? del.map(a => `<div class="flex justify-between p-4 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5"><span class="font-bold text-sm">${a.name}</span><div class="flex gap-2"><button onclick="window.restoreApp('${a.id}')" class="text-primary text-xs font-bold">KH√îI PH·ª§C</button><button onclick="window.clearTrashConfirm(false, '${a.id}', '${a.name}')" class="text-red-500 text-xs font-bold">X√ìA</button></div></div>`).join('') : '<div class="text-center text-slate-400">Tr·ªëng</div>'; }
        window.restoreApp = async (id) => updateDoc(doc(db, "apps", id), { isDeleted: false });
        window.clearTrashConfirm = (all, id, name) => window.showConfirm('X√≥a vƒ©nh vi·ªÖn', all?'X√≥a h·∫øt th√πng r√°c?':`X√≥a "${name}"?`, async () => { if(all) { const b = writeBatch(db); apps.filter(a=>a.isDeleted).forEach(a=>b.delete(doc(db, "apps", a.id))); await b.commit(); } else await deleteDoc(doc(db, "apps", id)); showToast("ƒê√£ x√≥a!"); });

        window.toggleFormFields = () => { const c = categories.find(x => x.id === document.getElementById('app-category').value); const isPhone = c?.name === "S·ªë ƒëi·ªán tho·∫°i"; document.getElementById('field-position').classList.toggle('hidden', !isPhone); document.getElementById('label-name').innerText = isPhone ? "T√™n li√™n h·ªá" : "T√™n hi·ªÉn th·ªã"; document.getElementById('label-link').innerText = isPhone ? "S·ªë ƒëi·ªán tho·∫°i" : "Link URL"; };
        window.openAppModal = () => { document.getElementById('app-form').reset(); document.getElementById('edit-id').value = ''; window.toggleFormFields(); window.openModal('modal-app'); };
        window.editApp = (id) => { const a = apps.find(x => x.id === id); document.getElementById('edit-id').value = a.id; document.getElementById('app-name').value = a.name; document.getElementById('app-position').value = a.position||''; document.getElementById('app-link').value = a.url; document.getElementById('app-icon').value = a.iconUrl||''; document.getElementById('app-category').value = a.categoryId; document.getElementById('app-visible').checked = a.visible; window.toggleFormFields(); window.openModal('modal-app'); };
        document.getElementById('app-form').onsubmit = async (e) => { e.preventDefault(); const id = document.getElementById('edit-id').value; const d = { name: document.getElementById('app-name').value, position: document.getElementById('app-position').value, url: document.getElementById('app-link').value, iconUrl: document.getElementById('app-icon').value, categoryId: document.getElementById('app-category').value, visible: document.getElementById('app-visible').checked, order: id ? apps.find(x=>x.id===id).order : apps.length }; try { if(id) await updateDoc(doc(db, "apps", id), d); else await addDoc(collection(db, "apps"), d); window.closeModal('modal-app'); showToast("ƒê√£ l∆∞u!"); } catch(e){ showToast("L·ªói!", true); } };
        window.deleteAppConfirm = (id, name) => window.showConfirm('X√≥a', `Chuy·ªÉn "${name}" v√†o th√πng r√°c?`, () => updateDoc(doc(db, "apps", id), { isDeleted: true }));

        function renderCategories() {
            document.getElementById('category-bar').innerHTML = `<button onclick="window.setFilter('all', true)" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest ${currentFilter==='all'?'bg-primary text-white':'bg-white dark:bg-slate-800 text-slate-500'}">T·∫§T C·∫¢</button>` + categories.map(c => `<button onclick="window.setFilter('${c.id}', true)" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest flex items-center gap-2 ${currentFilter===c.id?'bg-primary text-white':'bg-white dark:bg-slate-800 text-slate-500'}">${c.icon?`<img src="${c.icon}" class="w-3 h-3">`:''} ${c.name.toUpperCase()}</button>`).join('');
            document.getElementById('category-bar-mobile').innerHTML = `<div class="space-y-2"><button onclick="window.setFilter('all', false)" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest w-full text-left ${currentFilter==='all'?'bg-primary text-white':'bg-white dark:bg-slate-800 text-slate-500'}">T·∫§T C·∫¢</button>` + categories.map(c => `<button onclick="window.setFilter('${c.id}', false)" class="px-5 py-2.5 rounded-xl text-[10px] font-black tracking-widest flex items-center gap-2 w-full text-left ${currentFilter===c.id?'bg-primary text-white':'bg-white dark:bg-slate-800 text-slate-500'}">${c.icon?`<img src="${c.icon}" class="w-3 h-3">`:''} ${c.name.toUpperCase()}</button>`).join('') + `</div>`;
            document.getElementById('cat-list-admin').innerHTML = categories.map(c => `<li class="flex flex-col gap-2 p-4 bg-slate-50 dark:bg-white/5 rounded-2xl border dark:border-white/5" data-id="${c.id}"><div class="flex items-center gap-3"><i data-lucide="grip-vertical" class="text-slate-300 cursor-move"></i><input type="text" value="${c.name}" onblur="window.updateCatField('${c.id}', 'name', this.value)" class="flex-1 bg-transparent border-none font-bold text-sm outline-none"><button onclick="window.deleteCatConfirm('${c.id}', '${c.name}')" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></li>`).join('');
            document.getElementById('app-category').innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if(isAdmin) new Sortable(document.getElementById('cat-list-admin'), { animation: 150, handle: '.cursor-move', onEnd: () => Array.from(document.getElementById('cat-list-admin').children).forEach((el, i) => updateDoc(doc(db, "categories", el.dataset.id), { order: i })) });
            lucide.createIcons();
        }

        window.setFilter = (id, desktop) => { currentFilter = id; renderCategories(); renderApps(); if (!desktop && id!=='contact_filter') window.toggleMobileCategorySidebar(); };
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.switchTab = (id) => { 
            ['tab-cat','tab-announcement','tab-deputy','tab-users','tab-data','tab-trash','tab-logs','tab-hr'].forEach(t => document.getElementById(t).classList.add('hidden')); 
            ['btn-tab-cat','btn-tab-announcement','btn-tab-deputy','btn-tab-users','btn-tab-data','btn-tab-trash','btn-tab-logs','btn-tab-hr'].forEach(b => document.getElementById(b)?.classList.remove('text-primary','border-b-2','border-primary'));
            document.getElementById(id).classList.remove('hidden'); 
            document.getElementById('btn-'+id)?.classList.add('text-primary','border-b-2','border-primary');
            if(id==='tab-deputy') renderDeputyList(); if(id==='tab-users') renderUserList(); if(id==='tab-trash') renderTrash(); if(id==='tab-hr') renderStaffListAdmin();
        };
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; lucide.createIcons(); };
        document.getElementById('search-input').oninput = (e) => { searchQuery = e.target.value; renderApps(); };
        window.setView = (mode, init) => { viewMode = mode; localStorage.setItem(window.innerWidth<=768?'viewModeMobile':'viewModeDesktop', mode); document.getElementById('view-grid-btn').classList.toggle('bg-white', mode==='grid'); document.getElementById('view-list-btn').classList.toggle('bg-white', mode==='list'); if(!init) renderApps(); };
        window.showToast = (msg, err) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.querySelector('i').setAttribute('data-lucide', err?'alert-triangle':'check-circle'); t.querySelector('i').classList.toggle('text-green-500', !err); t.querySelector('i').classList.toggle('text-red-500', err); lucide.createIcons(); t.classList.add('visible'); clearTimeout(toastTimeout); toastTimeout = setTimeout(() => t.classList.remove('visible'), 3000); };
        function renderProfileContent() { 
            if(!currentUser) { document.getElementById('profile-content-details').innerHTML = `<p class="text-slate-500">Vui l√≤ng ƒëƒÉng nh·∫≠p.</p><button onclick="window.login()" class="mt-4 w-full py-3 bg-primary text-white rounded-xl font-bold">ƒêƒÇNG NH·∫¨P</button>`; return; }
            document.getElementById('profile-content-details').innerHTML = `<div class="flex items-center gap-4 p-4 bg-slate-100 dark:bg-slate-800 rounded-2xl"><img src="${currentUser.photoURL}" class="w-12 h-12 rounded-full border-2 border-primary/20"><div class="flex-1"><h4 class="font-bold">${currentUser.displayName}</h4><p class="text-xs text-slate-500">${currentUser.email}</p></div><span class="text-[9px] font-black uppercase px-3 py-1 bg-primary/10 text-primary rounded-full">${isSuper?'SUPER':(isAdmin?'DEPUTY':'GUEST')}</span></div>`;
            lucide.createIcons();
        }

        // --- STAFF / HR LOGIC ---
        window.renderStaffListAdmin = () => {
            if (!isAdmin) return;
            const s = document.getElementById('staff-search-admin').value.toLowerCase();
            const f = staffList.filter(x => x.name.toLowerCase().includes(s) || (x.position||'').toLowerCase().includes(s));
            document.getElementById('staff-list-admin').innerHTML = f.length ? f.map(x => `<div class="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5 group"><img src="${x.photoUrl||'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="w-10 h-10 rounded-full object-cover"><div class="flex-1"><h4 class="font-bold text-sm">${x.name}</h4><p class="text-[10px] uppercase">${x.position||'--'}</p></div><div class="flex gap-2 opacity-0 group-hover:opacity-100 transition"><button onclick="window.editStaff('${x.id}')" class="p-2 bg-indigo-100 text-indigo-600 rounded-lg"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="window.deleteStaffConfirm('${x.id}','${x.name}')" class="p-2 bg-red-100 text-red-600 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('') : '<div class="text-center text-slate-400">Kh√¥ng t√¨m th·∫•y.</div>'; lucide.createIcons();
        };

        window.renderStaffPublic = () => {
            const container = document.getElementById('staff-container-public');
            const s = document.getElementById('staff-search-public')?.value.toLowerCase() || '';
            const d = document.getElementById('staff-filter-dept')?.value || 'all';
            const f = staffList.filter(x => (x.name.toLowerCase().includes(s) || (x.position||'').toLowerCase().includes(s)) && (d === 'all' || x.position === d));
            
            if (f.length === 0) { container.innerHTML = `<div class="col-span-full text-center text-slate-400 py-10">Kh√¥ng t√¨m th·∫•y nh√¢n s·ª±.</div>`; return; }

            if (viewModeHR === 'grid') {
                container.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";
                container.innerHTML = f.map(x => {
                    const custom = x.customFields ? x.customFields.map(k => `<div class="flex justify-between text-xs py-1 border-b dark:border-white/5"><span class="text-slate-500">${k.key}:</span><span class="font-medium truncate pl-2">${k.value}</span></div>`).join('') : '';
                    return `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border dark:border-white/5 overflow-hidden flex flex-col group hover:-translate-y-1 transition"><div class="h-24 bg-gradient-to-r from-primary to-secondary relative"><div class="absolute -bottom-10 left-1/2 -translate-x-1/2 w-20 h-20 rounded-full border-4 border-white dark:border-slate-800 overflow-hidden bg-white"><img src="${x.photoUrl||'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="w-full h-full object-cover"></div></div><div class="pt-12 pb-6 px-6 text-center flex-1"><h3 class="text-lg font-black mb-1">${x.name}</h3><span class="px-3 py-1 rounded-full bg-slate-100 dark:bg-white/10 text-primary dark:text-white text-[10px] font-bold uppercase tracking-widest inline-block mb-4">${x.position||'Nh√¢n vi√™n'}</span><div class="space-y-3 text-left bg-slate-50 dark:bg-black/20 p-4 rounded-xl">${x.dob?`<div class="flex gap-2 text-xs"><i data-lucide="cake" class="w-4 h-4 text-secondary"></i><span>${new Date(x.dob).toLocaleDateString('vi')}</span></div>`:''}${x.cccd?`<div class="flex gap-2 text-xs"><i data-lucide="id-card" class="w-4 h-4 text-blue-500"></i><span>${x.cccd}</span></div>`:''}${x.bankName?`<div class="flex gap-2 text-xs"><img src="${x.bankLogo}" class="w-4 h-4 object-contain"><div><span class="font-bold block">${x.bankName}</span><span class="font-mono text-[10px]">${x.bankAccount}</span></div></div>`:''}${custom}</div>${x.notes?`<p class="mt-4 text-xs italic text-slate-400">"${x.notes}"</p>`:''}</div></div>`;
                }).join('');
            } else {
                container.className = "flex flex-col gap-3";
                container.innerHTML = f.map(x => `<div class="flex items-center gap-4 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-white/5"><img src="${x.photoUrl||'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" class="w-12 h-12 rounded-full object-cover"><div class="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4 items-center"><div><h4 class="font-bold text-sm">${x.name}</h4><p class="text-[10px] uppercase">${x.position}</p></div><div class="hidden md:block text-xs text-slate-500"><p><i data-lucide="cake" class="w-3 h-3 inline mr-1"></i> ${x.dob?new Date(x.dob).toLocaleDateString('vi'):'--'}</p><p><i data-lucide="id-card" class="w-3 h-3 inline mr-1"></i> ${x.cccd||'--'}</p></div><div class="hidden md:block">${x.bankName?`<div class="flex items-center gap-1 text-xs"><img src="${x.bankLogo}" class="w-4 h-4"> <span>${x.bankAccount}</span></div>`:''}</div></div></div>`).join('');
            }
            lucide.createIcons();
        };

        function populateDeptFilter() { 
            const sel = document.getElementById('staff-filter-dept'); 
            if(sel) sel.innerHTML = '<option value="all">T·∫•t c·∫£ Ch·ª©c v·ª•</option>' + [...new Set(staffList.map(s => s.position).filter(Boolean))].map(d => `<option value="${d}">${d}</option>`).join(''); 
        }

        window.setViewModeHR = (m) => { viewModeHR = m; localStorage.setItem('viewModeHR', m); renderStaffPublic(); };
        window.openStaffModal = () => { document.getElementById('staff-form').reset(); document.getElementById('staff-edit-id').value = ''; document.getElementById('staff-preview-img').src = 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'; document.getElementById('staff-custom-fields').innerHTML = ''; document.getElementById('bank-info-preview').classList.add('hidden'); window.openModal('modal-staff'); };
        window.addCustomField = (k='', v='') => { const d = document.createElement('div'); d.className = "flex gap-2 items-center"; d.innerHTML = `<input type="text" placeholder="T√™n tr∆∞·ªùng" value="${k}" class="custom-field-key w-1/3 px-3 py-2 bg-slate-50 dark:bg-white/5 rounded-lg text-xs outline-none border border-slate-200 dark:border-white/10"><input type="text" placeholder="Gi√° tr·ªã" value="${v}" class="custom-field-val flex-1 px-3 py-2 bg-slate-50 dark:bg-white/5 rounded-lg text-xs outline-none border border-slate-200 dark:border-white/10"><button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash" class="w-3 h-3"></i></button>`; document.getElementById('staff-custom-fields').appendChild(d); lucide.createIcons(); };

        window.editStaff = (id) => {
            const s = staffList.find(x => x.id === id); if(!s) return;
            document.getElementById('staff-edit-id').value = s.id; document.getElementById('staff-photo').value = s.photoUrl||''; document.getElementById('staff-preview-img').src = s.photoUrl||'https://cdn-icons-png.flaticon.com/512/3135/3135715.png';
            document.getElementById('staff-name').value = s.name; document.getElementById('staff-dob').value = s.dob||''; document.getElementById('staff-gender').value = s.gender||'Nam';
            document.getElementById('staff-position').value = s.position||''; document.getElementById('staff-cccd').value = s.cccd||'';
            document.getElementById('staff-bank-select').value = s.bankBin||''; document.getElementById('staff-bank-acc').value = s.bankAccount||''; window.updateBankLogo();
            document.getElementById('staff-notes').value = s.notes||'';
            const cf = document.getElementById('staff-custom-fields'); cf.innerHTML = ''; if(s.customFields) s.customFields.forEach(f => window.addCustomField(f.key, f.value));
            window.openModal('modal-staff');
        };

        document.getElementById('staff-form').onsubmit = async (e) => {
            e.preventDefault(); if (!isAdmin) return;
            const id = document.getElementById('staff-edit-id').value;
            const bankSel = document.getElementById('staff-bank-select');
            const custom = []; document.querySelectorAll('#staff-custom-fields > div').forEach(d => { const k = d.querySelector('.custom-field-key').value, v = d.querySelector('.custom-field-val').value; if(k) custom.push({key:k, value:v}); });
            const data = { name: document.getElementById('staff-name').value, photoUrl: document.getElementById('staff-photo').value, dob: document.getElementById('staff-dob').value, gender: document.getElementById('staff-gender').value, position: document.getElementById('staff-position').value, cccd: document.getElementById('staff-cccd').value, bankBin: bankSel.value, bankName: bankSel.options[bankSel.selectedIndex].getAttribute('data-name')||'', bankLogo: bankSel.options[bankSel.selectedIndex].getAttribute('data-logo')||'', bankAccount: document.getElementById('staff-bank-acc').value, notes: document.getElementById('staff-notes').value, customFields: custom, updatedAt: new Date().toISOString() };
            try { if(id) await updateDoc(doc(db, STAFF_COLLECTION, id), data); else { data.createdAt = new Date().toISOString(); await addDoc(collection(db, STAFF_COLLECTION), data); } window.closeModal('modal-staff'); showToast("ƒê√£ l∆∞u!"); } catch(e) { showToast("L·ªói!", true); }
        };
        window.deleteStaffConfirm = (id, name) => window.showConfirm('X√≥a', `X√≥a nh√¢n s·ª± "${name}"?`, async () => { await deleteDoc(doc(db, STAFF_COLLECTION, id)); showToast("ƒê√£ x√≥a!"); });

        window.downloadStaffTemplate = () => {
            const d = [["H·ªç v√† t√™n", "Ng√†y sinh (YYYY-MM-DD)", "Gi·ªõi t√≠nh", "Ch·ª©c v·ª•", "CCCD", "M√£ NH (VietQR)", "S·ªë TK", "Link ·∫£nh", "Ghi ch√∫", "Th√¥ng tin th√™m (Key:Value,...)"], ["Nguyen Van A", "1990-01-01", "Nam", "Gi√°m ƒë·ªëc", "001090000001", "970436", "123456789", "", "", "B·∫±ng c·∫•p:ƒê·∫°i h·ªçc"]];
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(d), "Mau"); XLSX.writeFile(wb, "Mau_Nhan_Su.xlsx");
        };

        window.handleStaffImport = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = async (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                if(json.length < 2) return showToast("File tr·ªëng!", true);
                window.showGlobalLoading(); const b = writeBatch(db); let c = 0;
                for(let i=1; i<json.length; i++) {
                    const row = json[i]; if(!row[0]) continue;
                    let cf = []; if(row[9]) try { cf = row[9].split(',').map(x => { const p=x.split(':'); return p.length===2?{key:p[0].trim(), value:p[1].trim()}:null; }).filter(x=>x); } catch(e){}
                    const bin = row[5]?String(row[5]):'', bank = vietQrBanks.find(x=>x.code===bin||x.bin===bin);
                    b.set(doc(collection(db, STAFF_COLLECTION)), { name: row[0], dob: row[1]||'', gender: row[2]||'Nam', position: row[3]||'', cccd: row[4]?String(row[4]):'', bankBin: bin, bankAccount: row[6]?String(row[6]):'', bankName: bank?.shortName||'', bankLogo: bank?.logo||'', photoUrl: row[7]||'', notes: row[8]||'', customFields: cf, createdAt: new Date().toISOString() });
                    c++;
                }
                await b.commit(); window.hideGlobalLoading(); showToast(`ƒê√£ nh·∫≠p ${c} nh√¢n s·ª±!`); e.target.value = '';
            }; r.readAsArrayBuffer(f);
        };

        if(localStorage.theme === 'dark') document.documentElement.classList.add('dark'); lucide.createIcons();
        trackVisit();
    </script>
</body>
</html>
