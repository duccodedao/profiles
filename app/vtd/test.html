<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Thu thập Dữ liệu & VietQR</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 900px; margin-top: 30px; margin-bottom: 50px; }
        
        /* Card & UI */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        .card-header { background: white; border-bottom: 1px solid #eee; padding: 20px; border-radius: 12px 12px 0 0 !important; }
        
        /* Bank Logos */
        .bank-logo-img { height: 30px; object-fit: contain; margin-right: 10px; }
        
        /* Inputs & Edit Mode */
        .form-control:disabled { background-color: #f8f9fa; border: 1px solid #e9ecef; opacity: 1; color: #495057; }
        .editing { border-color: #198754 !important; background-color: #fff !important; box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25); }
        .btn-edit { cursor: pointer; z-index: 10; }
        
        /* Timeline History */
        .timeline { border-left: 2px solid #e9ecef; padding-left: 20px; margin-left: 5px; }
        .timeline-item { position: relative; margin-bottom: 25px; }
        .timeline-item::before { content: ''; position: absolute; left: -26px; top: 5px; width: 10px; height: 10px; background: #0d6efd; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 2px #0d6efd; }
        .text-old { text-decoration: line-through; color: #dc3545; font-size: 0.85em; margin-right: 5px; }
        .text-new { color: #198754; font-weight: bold; }
        
        /* Loading */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading">
        <div class="spinner-border text-primary mb-2" role="status"></div>
        <span class="fw-bold text-primary">Đang xử lý dữ liệu...</span>
    </div>

    <!-- Header / Navbar -->
    <nav class="navbar navbar-light bg-white shadow-sm mb-4 sticky-top">
        <div class="container-fluid px-lg-5">
            <span class="navbar-brand fw-bold text-primary"><i class="fas fa-university me-2"></i>Thu Thập Dữ Liệu</span>
            <div class="d-flex align-items-center gap-2">
                <span id="userInfo" class="small fw-bold text-secondary"></span>
                <button id="btnLogin" class="btn btn-primary btn-sm rounded-pill px-3"><i class="fab fa-google me-2"></i>Admin Login</button>
                <button id="btnLogout" class="btn btn-outline-danger btn-sm rounded-pill d-none"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <!-- Main Tabs -->
        <ul class="nav nav-pills mb-4 justify-content-center p-1 bg-white rounded-pill shadow-sm" style="width: fit-content; margin: 0 auto;">
            <li class="nav-item">
                <button class="nav-link active rounded-pill px-4" data-bs-toggle="pill" data-bs-target="#tab-user">
                    <i class="fas fa-user-edit me-2"></i>Nhập Liệu
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link rounded-pill px-4" id="btnAdminTab" data-bs-toggle="pill" data-bs-target="#tab-admin">
                    <i class="fas fa-user-shield me-2"></i>Quản Trị (Admin)
                </button>
            </li>
        </ul>

        <div class="tab-content">
            
            <!-- TAB 1: USER -->
            <div class="tab-pane fade show active" id="tab-user">
                <div class="card">
                    <div class="card-body p-4">
                        <form id="userForm">
                            <div class="mb-4 text-center">
                                <h5 class="fw-bold mb-3">Tìm kiếm hồ sơ của bạn</h5>
                                <select id="userSelect" class="form-select form-select-lg shadow-sm border-primary" required>
                                    <option value="" selected disabled>-- Đang tải danh sách... --</option>
                                </select>
                            </div>

                            <div id="formContent" style="opacity: 0.5; pointer-events: none; transition: 0.3s;">
                                
                                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                                    <h6 class="text-primary fw-bold m-0">THÔNG TIN CÁ NHÂN</h6>
                                    <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" onclick="viewHistory()">
                                        <i class="fas fa-history me-1"></i> Lịch sử sửa
                                    </button>
                                </div>

                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="small text-muted">Họ và Tên</label>
                                        <div class="input-group">
                                            <input type="text" id="inpName" class="form-control" disabled>
                                            <button type="button" class="btn btn-light border" onclick="toggleEdit('inpName')"><i class="fas fa-pen text-secondary small"></i></button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted">Số CCCD (Cố định)</label>
                                        <input type="text" id="inpCccd" class="form-control bg-light fw-bold text-dark" disabled readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted">Ngày sinh</label>
                                        <div class="input-group">
                                            <input type="text" id="inpDob" class="form-control" disabled>
                                            <button type="button" class="btn btn-light border" onclick="toggleEdit('inpDob')"><i class="fas fa-pen text-secondary small"></i></button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted">Giới tính</label>
                                        <div class="input-group">
                                            <select id="inpGender" class="form-select" disabled>
                                                <option value="Nam">Nam</option>
                                                <option value="Nữ">Nữ</option>
                                            </select>
                                            <button type="button" class="btn btn-light border" onclick="toggleEdit('inpGender')"><i class="fas fa-pen text-secondary small"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-light p-3 rounded-3 mb-4">
                                    <h6 class="text-success fw-bold mb-3"><i class="fas fa-wallet me-2"></i>THÔNG TIN THANH TOÁN</h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold small">Ngân hàng Agribank <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white"><img id="logoAgri" src="" class="bank-logo-img" alt="AGRI"></span>
                                            <input type="number" id="inpAgri" class="form-control" placeholder="Nhập số tài khoản..." required>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="form-label fw-bold small">Ngân hàng Vietcombank</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white"><img id="logoVcb" src="" class="bank-logo-img" alt="VCB"></span>
                                            <input type="number" id="inpVcb" class="form-control" placeholder="Nhập số tài khoản (nếu có)...">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
                                    <i class="fas fa-save me-2"></i> LƯU DỮ LIỆU
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- TAB 2: ADMIN -->
            <div class="tab-pane fade" id="tab-admin">
                <!-- Lock Screen -->
                <div id="adminLocked" class="text-center py-5">
                    <div class="mb-3"><i class="fas fa-lock fa-3x text-secondary"></i></div>
                    <h5>Khu vực quản trị viên</h5>
                    <p class="text-muted">Vui lòng đăng nhập Google để truy cập.</p>
                </div>

                <!-- Admin Content -->
                <div id="adminContent" class="d-none">
                    
                    <!-- EXPORT BUTTON -->
                    <div class="card mb-4 border-success">
                        <div class="card-body d-flex justify-content-between align-items-center bg-success bg-opacity-10">
                            <div>
                                <h5 class="text-success fw-bold mb-1"><i class="fas fa-file-excel me-2"></i>Báo Cáo Tổng Hợp</h5>
                                <p class="small text-muted mb-0">Xuất toàn bộ dữ liệu nhân viên và tài khoản ra Excel</p>
                            </div>
                            <button onclick="exportFullExcel()" class="btn btn-success fw-bold shadow-sm">
                                <i class="fas fa-download me-2"></i>Tải về Excel
                            </button>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-file-upload me-2"></i>Import Danh Sách
                                </div>
                                <div class="card-body">
                                    <p class="small text-muted">File Excel cần các cột: <code>Họ tên, CCCD, Ngày sinh, Giới tính</code></p>
                                    <input type="file" id="fileExcel" class="form-control mb-2" accept=".xlsx">
                                    <button onclick="handleImport()" class="btn btn-primary w-100">Upload & Xử lý</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-dark text-white">
                                    <i class="fas fa-user-plus me-2"></i>Thêm Thủ Công
                                </div>
                                <div class="card-body">
                                    <form id="adminAddForm" class="row g-2">
                                        <div class="col-12"><input id="addName" class="form-control" placeholder="Họ và Tên" required></div>
                                        <div class="col-12"><input id="addCccd" class="form-control" placeholder="Số CCCD (Duy nhất)" required></div>
                                        <div class="col-6"><input id="addDob" class="form-control" placeholder="Ngày sinh"></div>
                                        <div class="col-6">
                                            <select id="addGender" class="form-select">
                                                <option value="Nam">Nam</option>
                                                <option value="Nữ">Nữ</option>
                                            </select>
                                        </div>
                                        <div class="col-12 mt-2"><button class="btn btn-dark w-100">Thêm Mới</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal History -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold"><i class="fas fa-history text-primary me-2"></i>Lịch sử chỉnh sửa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <div id="historyContent" class="timeline"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDocs, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // --- CẤU HÌNH (ĐÃ CẬP NHẬT) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const COLL_DATA = "personnel_data";
        const COLL_LOGS = "audit_logs";

        let currentUser = null;
        let currentData = null;
        let localList = [];

        // --- 1. VIETQR LOGO ---
        async function fetchBankLogos() {
            try {
                const res = await fetch('https://api.vietqr.io/v2/banks');
                const json = await res.json();
                if(json.code == "00") {
                    const banks = json.data;
                    const agri = banks.find(b => b.code == "VBA"); // Agribank
                    const vcb = banks.find(b => b.code == "VCB"); // Vietcombank
                    if(agri) document.getElementById('logoAgri').src = agri.logo;
                    if(vcb) document.getElementById('logoVcb').src = vcb.logo;
                }
            } catch(e) { console.log("Lỗi tải logo bank", e); }
        }
        fetchBankLogos();

        // --- 2. AUTHENTICATION ---
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const userInfo = document.getElementById('userInfo');

        btnLogin.addEventListener('click', () => signInWithPopup(auth, provider));
        btnLogout.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                userInfo.textContent = user.displayName;
                btnLogin.classList.add('d-none');
                btnLogout.classList.remove('d-none');
                document.getElementById('adminLocked').classList.add('d-none');
                document.getElementById('adminContent').classList.remove('d-none');
            } else {
                userInfo.textContent = '';
                btnLogin.classList.remove('d-none');
                btnLogout.classList.add('d-none');
                document.getElementById('adminLocked').classList.remove('d-none');
                document.getElementById('adminContent').classList.add('d-none');
            }
        });

        // --- 3. DATA REALTIME ---
        onSnapshot(collection(db, COLL_DATA), (snap) => {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="" selected disabled>-- Chọn tên của bạn --</option>';
            localList = [];
            
            snap.forEach(doc => {
                const d = doc.data();
                localList.push(d);
                const opt = document.createElement('option');
                opt.value = d.cccd;
                opt.textContent = `${d.agribank ? '✅' : '⬜'} ${d.name} (${d.dob})`;
                select.appendChild(opt);
            });
        });

        // Chọn User
        document.getElementById('userSelect').addEventListener('change', function() {
            const cccd = this.value;
            currentData = localList.find(u => u.cccd === cccd);
            if(currentData) {
                document.getElementById('formContent').style.opacity = '1';
                document.getElementById('formContent').style.pointerEvents = 'auto';
                
                // Fill fields
                document.getElementById('inpName').value = currentData.name || '';
                document.getElementById('inpCccd').value = currentData.cccd || '';
                document.getElementById('inpDob').value = currentData.dob || '';
                document.getElementById('inpGender').value = currentData.gender || 'Nam';
                document.getElementById('inpAgri').value = currentData.agribank || '';
                document.getElementById('inpVcb').value = currentData.vietcombank || '';

                // Reset inputs to locked
                ['inpName', 'inpDob', 'inpGender'].forEach(id => {
                    document.getElementById(id).disabled = true;
                    document.getElementById(id).classList.remove('editing');
                });
            }
        });

        // Toggle Edit
        window.toggleEdit = function(id) {
            const el = document.getElementById(id);
            el.disabled = !el.disabled;
            el.classList.toggle('editing');
            if(!el.disabled) el.focus();
        };

        // --- 4. SUBMIT & HISTORY ---
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loading').style.display = 'flex';

            const newData = {
                name: document.getElementById('inpName').value,
                dob: document.getElementById('inpDob').value,
                gender: document.getElementById('inpGender').value,
                agribank: document.getElementById('inpAgri').value,
                vietcombank: document.getElementById('inpVcb').value || ""
            };

            const cccd = document.getElementById('inpCccd').value;
            const changes = [];
            const editor = currentUser ? `Admin (${currentUser.email})` : "Khách/User";

            // So sánh tìm thay đổi
            for(let key in newData) {
                const oldVal = currentData[key] || "";
                if(oldVal !== newData[key]) {
                    changes.push({ field: key, old: oldVal, new: newData[key] });
                }
            }

            try {
                // Lưu data mới
                await setDoc(doc(db, COLL_DATA, cccd), { ...newData, cccd, last_updated: new Date().toISOString() }, { merge: true });

                // Lưu lịch sử nếu có thay đổi
                if(changes.length > 0) {
                    await addDoc(collection(db, COLL_LOGS), {
                        cccd_ref: cccd,
                        editor: editor,
                        time: new Date().toISOString(),
                        details: changes
                    });
                }
                Swal.fire('Thành công', 'Đã lưu dữ liệu!', 'success');
            } catch(err) {
                Swal.fire('Lỗi', err.message, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        // Xem lịch sử
        window.viewHistory = async function() {
            if(!currentData) return;
            const q = query(collection(db, COLL_LOGS), where("cccd_ref", "==", currentData.cccd), orderBy("time", "desc"));
            const snap = await getDocs(q);
            const container = document.getElementById('historyContent');
            container.innerHTML = "";

            if(snap.empty) {
                container.innerHTML = "<p class='text-center text-muted'>Chưa có lịch sử thay đổi.</p>";
            } else {
                snap.forEach(doc => {
                    const log = doc.data();
                    let detailsHtml = "";
                    log.details.forEach(d => {
                        const label = {name:"Tên", dob:"Ngày sinh", gender:"Giới tính", agribank:"Agribank", vietcombank:"VCB"}[d.field] || d.field;
                        detailsHtml += `<div><strong>${label}:</strong> <span class="text-old">${d.old||'(Trống)'}</span> <i class="fas fa-arrow-right mx-1 small"></i> <span class="text-new">${d.new}</span></div>`;
                    });
                    
                    container.innerHTML += `
                        <div class="timeline-item">
                            <div class="small text-muted mb-1"><i class="far fa-clock"></i> ${new Date(log.time).toLocaleString('vi-VN')} - <b>${log.editor}</b></div>
                            <div class="card p-2 border-0 shadow-sm bg-white">${detailsHtml}</div>
                        </div>
                    `;
                });
            }
            new bootstrap.Modal(document.getElementById('historyModal')).show();
        };

        // --- 5. ADMIN FEATURES ---
        
        // Add Manual
        document.getElementById('adminAddForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const cccd = document.getElementById('addCccd').value;
            await setDoc(doc(db, COLL_DATA, cccd), {
                cccd, 
                name: document.getElementById('addName').value,
                dob: document.getElementById('addDob').value,
                gender: document.getElementById('addGender').value,
                agribank:"", vietcombank:""
            }, {merge:true});
            Swal.fire('Đã thêm', '', 'success');
            e.target.reset();
        });

        // Import Excel
        window.handleImport = function() {
            const f = document.getElementById('fileExcel').files[0];
            if(!f) return Swal.fire('Lỗi','Chưa chọn file','warning');
            
            const reader = new FileReader();
            reader.onload = async(e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const ws = wb.Sheets[wb.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(ws);
                let count = 0;
                
                document.getElementById('loading').style.display = 'flex';
                for(let row of data) {
                    const cccd = row['CCCD'] || row['ID'];
                    const name = row['Họ tên'] || row['Name'];
                    if(cccd && name) {
                        await setDoc(doc(db, COLL_DATA, String(cccd)), {
                            cccd: String(cccd),
                            name: name,
                            dob: row['Ngày sinh'] || row['DOB'] || '',
                            gender: row['Giới tính'] || row['Gender'] || ''
                        }, {merge: true});
                        count++;
                    }
                }
                document.getElementById('loading').style.display = 'none';
                Swal.fire('Hoàn tất', `Đã import ${count} người`, 'success');
            };
            reader.readAsArrayBuffer(f);
        };

        // --- TÍNH NĂNG MỚI: XUẤT FULL EXCEL ---
        window.exportFullExcel = async function() {
            document.getElementById('loading').style.display = 'flex';
            try {
                // 1. Lấy toàn bộ dữ liệu từ Firestore
                const querySnapshot = await getDocs(collection(db, COLL_DATA));
                
                const exportData = [];
                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    exportData.push({
                        "Họ và Tên": d.name,
                        "Số CCCD": d.cccd,
                        "Ngày sinh": d.dob,
                        "Giới tính": d.gender,
                        "TK Agribank": d.agribank || "",
                        "TK Vietcombank": d.vietcombank || "",
                        "Cập nhật lần cuối": d.last_updated ? new Date(d.last_updated).toLocaleString('vi-VN') : ""
                    });
                });

                if(exportData.length === 0) {
                    Swal.fire('Thông báo', 'Chưa có dữ liệu nào để xuất.', 'info');
                    return;
                }

                // 2. Tạo file Excel
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "DanhSachNhanVien");

                // 3. Tải xuống
                XLSX.writeFile(wb, `Danh_Sach_Ngan_Hang_${new Date().toISOString().slice(0,10)}.xlsx`);

            } catch (error) {
                console.error(error);
                Swal.fire('Lỗi', 'Không thể xuất file: ' + error.message, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        };

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
