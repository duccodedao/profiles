
<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub Portal - Vĩnh Trạch Đông</title>
    <link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">
    
    <!-- SEO & PWA Meta Tags -->
    <meta name="description" content="Hub Portal tổng hợp các ứng dụng và danh bạ liên hệ của Vĩnh Trạch Đông.">
    <link rel="apple-touch-icon" href="https://bmass.vercel.app/img/bmasslogo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#4f46e5">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Excel Library (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4f46e5', secondary: '#f43f5e', dark: '#020617' } } }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* Side Tab (Left Sidebar) */
        #side-tab {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 140;
        }
        .side-tab-item {
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .side-tab-item.active {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            border-left-color: #4f46e5;
        }
        .dark .side-tab-item.active {
            background: rgba(129, 140, 248, 0.1);
            color: #818cf8;
            border-left-color: #818cf8;
        }

        /* Admin Sidebar (Right) */
        .admin-sidebar { 
            width: 0; 
            transition: width 0.3s ease-in-out;
            overflow-x: hidden;
        }
        .admin-sidebar.open {
            width: 28rem;
            min-width: 320px;
        }
        @media (max-width: 768px) {
            .admin-sidebar.open { width: 100%; }
        }

        .app-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .is-favorite .star-icon { fill: #facc15; }
        .app-item.selected-for-delete { box-shadow: 0 0 0 3px #f43f5e; border-radius: 1rem; }
        
        /* Marquee */
        .marquee { overflow: hidden; white-space: nowrap; box-sizing: border-box; }
        .marquee > div { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Overlay for SideTab -->
    <div id="side-tab-overlay" onclick="window.toggleSideTab()" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[135] hidden"></div>

    <!-- Announcement Bar -->
    <div id="announcement-bar" class="fixed top-0 left-0 w-full z-[151] bg-secondary text-white text-xs font-bold py-2 shadow-md hidden">
        <div class="marquee">
            <div id="announcement-text"></div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="sticky top-0 z-[100] glass px-6 py-3 flex justify-between items-center transition-all duration-300">
        <div class="flex items-center gap-4">
            <!-- Nút 3 gạch mở SideTab -->
            <button onclick="window.toggleSideTab()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-all">
                <i data-lucide="menu" class="w-6 h-6 text-slate-600 dark:text-slate-300"></i>
            </button>
            
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i data-lucide="database" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xs font-black tracking-tighter uppercase leading-none">Hub Portal</h1>
                    <span id="role-status" class="text-[9px] font-bold text-slate-400">GUEST</span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="window.toggleAdminSidebar()" id="admin-sidebar-toggle" class="p-2 rounded-xl text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition hidden"><i data-lucide="settings-2" class="w-5 h-5"></i></button>

            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                <button onclick="window.setView('grid')" id="view-grid-btn" class="p-1.5 rounded-md transition-all shadow-sm bg-white dark:bg-slate-700"><i data-lucide="layout-grid" class="w-4 h-4"></i></button>
                <button onclick="window.setView('list')" id="view-list-btn" class="p-1.5 rounded-md transition-all"><i data-lucide="list" class="w-4 h-4"></i></button>
            </div>
            <button onclick="window.toggleTheme()" class="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden text-slate-600"></i>
            </button>
            <div id="auth-section"></div>
        </div>
    </header>

    <!-- SideTab (Left Sidebar) -->
    <aside id="side-tab" class="fixed left-0 top-0 bottom-0 w-72 bg-white dark:bg-slate-900 border-r dark:border-white/10 shadow-2xl -translate-x-full pt-20 flex flex-col">
        <div class="px-6 mb-4">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Danh mục điều hướng</h3>
        </div>
        <nav id="category-side-list" class="flex-1 overflow-y-auto px-3 space-y-1">
            <!-- Categories will be rendered here -->
        </nav>
        <!-- Mini Stats in SideTab -->
        <div id="mini-stats" class="p-6 border-t dark:border-white/5 bg-slate-50/50 dark:bg-white/5">
            <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Truy cập hôm nay</p>
            <p id="today-visits-count" class="text-xl font-black text-primary leading-none">0</p>
        </div>
    </aside>

    <div class="flex max-w-7xl mx-auto">
        <!-- Main Content -->
        <main class="flex-1 p-6 space-y-8 min-w-0">
            <!-- Search -->
            <div class="relative max-w-2xl mx-auto">
                <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="search-input" placeholder="Tìm ứng dụng hoặc danh bạ..." 
                    class="w-full pl-14 pr-6 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-white/5 rounded-2xl focus:ring-4 ring-primary/10 outline-none shadow-sm">
            </div>

            <!-- Visit Stats Container -->
            <div id="visit-stats-container" class="max-w-4xl mx-auto p-4 rounded-3xl bg-slate-100 dark:bg-slate-900/50">
                <div class="flex items-center justify-center h-20 text-slate-400">Đang tải thống kê...</div>
            </div>

            <!-- Admin Request Form -->
            <div id="request-admin-section" class="max-w-4xl mx-auto hidden p-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-3xl border border-yellow-200 dark:border-yellow-700 space-y-4">
                <h3 class="text-xl font-bold text-yellow-800 dark:text-yellow-200 flex items-center gap-2"><i data-lucide="key" class="w-6 h-6"></i> Xin Cấp Quyền Quản Trị</h3>
                <p id="request-admin-status" class="text-sm font-medium text-yellow-700 dark:text-yellow-300">
                    Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu để Admin chính duyệt.
                </p>
                <form id="request-admin-form" class="flex gap-4">
                    <input type="text" id="request-admin-reason" placeholder="Lý do xin cấp quyền..." required class="flex-1 px-5 py-3 bg-white dark:bg-slate-800 rounded-xl outline-none focus:ring-2 ring-yellow-500 text-sm">
                    <button type="submit" class="bg-yellow-500 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-lg hover:bg-yellow-600 transition">GỬI YÊU CẦU</button>
                </form>
            </div>
            
            <!-- App Loading State -->
            <div id="app-loading" class="text-center p-16 text-slate-400 text-sm font-medium hidden">
                <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                Đang tải ứng dụng...
            </div>

            <!-- Main Content App -->
            <div id="app-container"></div>
            
            <!-- Bulk Delete Floating Dock -->
            <div id="bulk-delete-dock" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 z-[110]">
                <div class="bg-red-600 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-4">
                    <span id="selected-count">0</span> mục đã chọn
                    <button onclick="window.executeBulkDelete()" class="flex items-center gap-2 px-5 py-2.5 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold shadow-lg uppercase">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> XÓA
                    </button>
                </div>
            </div>
        </main>

        <!-- Admin Sidebar (Right) -->
        <div id="admin-sidebar" class="admin-sidebar fixed right-0 top-0 bottom-0 bg-white dark:bg-slate-900 border-l dark:border-white/10 shadow-2xl z-[150] flex flex-col pt-16">
            <div id="sidebar-controls" class="p-6 border-b dark:border-white/5 flex flex-col gap-3">
                 <div class="flex items-center justify-between">
                    <h3 class="text-lg font-black uppercase tracking-widest text-primary dark:text-white">QUẢN TRỊ VIÊN</h3>
                    <button onclick="window.toggleAdminSidebar()" class="p-2 hover:bg-slate-100 dark:hover:bg-white/5 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
                 <div class="flex items-center gap-3">
                    <button onclick="window.openAppModal()" class="flex-1 flex items-center justify-center gap-2 px-3 py-2.5 bg-primary text-white rounded-xl text-xs font-bold shadow-lg">
                        <i data-lucide="plus" class="w-4 h-4"></i> THÊM APP
                    </button>
                    <button onclick="window.toggleBulkDelete()" id="bulk-delete-sidebar-toggle" class="p-3 rounded-xl text-red-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition flex items-center justify-center"><i data-lucide="scissors" class="w-5 h-5"></i></button>
                 </div>
            </div>

            <!-- Sidebar Tabs -->
            <div class="p-6 border-b dark:border-white/5 overflow-x-auto">
                <div class="flex gap-4 text-[10px] font-black tracking-widest text-slate-400 min-w-max">
                    <button onclick="window.switchTab('tab-cat')" id="btn-tab-cat" class="text-primary border-b-2 border-primary pb-1">DANH MỤC</button>
                    <button onclick="window.switchTab('tab-announcement')" id="btn-tab-announcement" class="pb-1 uppercase">THÔNG BÁO</button>
                    <button onclick="window.switchTab('tab-deputy')" id="btn-tab-deputy" class="pb-1 uppercase">PHÓ ADMIN</button>
                    <button onclick="window.switchTab('tab-request')" id="btn-tab-request" class="pb-1 uppercase flex items-center gap-1">YÊU CẦU <span id="request-count" class="text-red-500">(0)</span></button>
                    <button onclick="window.switchTab('tab-data')" id="btn-tab-data" class="pb-1 uppercase">DỮ LIỆU</button>
                </div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <!-- Tab Categories -->
                <div id="tab-cat" class="space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Quản lý Danh mục</h4>
                    <div class="flex flex-col gap-2">
                        <input type="text" id="new-cat-name" placeholder="Tên danh mục..." class="px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                        <div class="flex gap-2">
                             <input type="text" id="new-cat-icon" placeholder="Link Icon..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-primary">
                             <button onclick="window.addCategory()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">Thêm</button>
                        </div>
                    </div>
                    <ul id="cat-list-admin" class="space-y-2"></ul>
                </div>
                
                <!-- Tab Announcement -->
                <div id="tab-announcement" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Thông báo Chạy chữ (Marquee)</h4>
                    <textarea id="announcement-content" placeholder="Nội dung thông báo" rows="3" class="w-full p-5 bg-slate-50 dark:bg-white/5 rounded-xl outline-none focus:ring-2 ring-secondary text-sm font-medium"></textarea>
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5">
                        <label class="text-sm font-bold opacity-60">Kích hoạt thông báo</label>
                        <button id="toggle-announcement-btn" onclick="window.toggleAnnouncementStatus()" class="px-5 py-2 rounded-xl font-bold text-xs uppercase transition-all">Tắt / Bật</button>
                    </div>
                    <button onclick="window.saveAnnouncementContent()" class="w-full py-4 bg-primary text-white rounded-xl font-bold shadow-lg uppercase text-xs">LƯU NỘI DUNG</button>
                </div>

                <!-- Tab Deputy -->
                <div id="tab-deputy" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Quản lý Phó Admin</h4>
                    <div id="deputy-guard" class="hidden p-4 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-xl text-xs font-bold uppercase">Chỉ Super Admin mới quản lý mục này.</div>
                    <div id="deputy-ui" class="space-y-4">
                        <div class="flex gap-2">
                            <input type="email" id="new-deputy-email" placeholder="Gmail..." class="flex-1 px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl text-sm">
                            <button onclick="window.addDeputy()" class="bg-primary text-white px-6 rounded-xl font-bold text-xs uppercase">CẤP</button>
                        </div>
                        <div id="deputy-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Tab Admin Requests -->
                <div id="tab-request" class="hidden space-y-6">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Yêu Cầu Cấp Quyền</h4>
                    <div id="requests-list" class="space-y-2"></div>
                </div>

                <!-- Tab Data -->
                <div id="tab-data" class="hidden space-y-8">
                    <h4 class="text-sm font-bold uppercase tracking-widest text-slate-500">Xuất/Nhập Dữ Liệu</h4>
                    <button onclick="window.handleExport('json')" class="w-full flex items-center justify-between px-5 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-sm font-bold shadow-sm">Xuất file JSON <i data-lucide="download" class="w-4 h-4"></i></button>
                    <button onclick="window.handleExport('excel')" class="w-full flex items-center justify-between px-5 py-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-sm font-bold shadow-sm">Xuất file EXCEL <i data-lucide="file-spreadsheet" class="w-4 h-4"></i></button>
                    <div class="h-px bg-slate-100 dark:bg-white/5"></div>
                    <input type="file" id="import-file" accept=".json, .xlsx" onchange="window.handleImport(event)" class="hidden">
                    <label for="import-file" class="flex items-center justify-center gap-3 w-full px-5 py-4 bg-slate-900 text-white dark:bg-white dark:text-slate-900 rounded-xl cursor-pointer hover:opacity-90 font-bold text-xs uppercase"><i data-lucide="upload-cloud" class="w-5 h-5"></i> Chọn file khôi phục</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-app" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center"><h3 id="app-modal-title" class="font-bold uppercase text-sm">Cấu hình</h3><button onclick="window.closeModal('modal-app')" class="p-2 hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <form id="app-form" class="p-8 space-y-4">
                <input type="hidden" id="edit-id">
                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">Danh mục</label><select id="app-category" onchange="window.toggleFormFields()" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm font-medium"></select></div>
                <div class="space-y-1"><label id="label-name" class="text-[10px] font-bold text-slate-400 uppercase">Tên hiển thị</label><input type="text" id="app-name" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm font-medium"></div>
                <div id="field-position" class="space-y-1 hidden"><label class="text-[10px] font-bold text-slate-400 uppercase">Chức vụ</label><input type="text" id="app-position" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm font-medium"></div>
                <div class="space-y-1"><label id="label-link" class="text-[10px] font-bold text-slate-400 uppercase">Link URL / SĐT</label><input type="text" id="app-link" required class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm font-medium"></div>
                <div class="space-y-1"><label class="text-[10px] font-bold text-slate-400 uppercase">Icon URL</label><input type="text" id="app-icon" placeholder="Để trống để tự lấy" class="w-full px-5 py-3 bg-slate-50 dark:bg-white/5 rounded-xl outline-none text-sm font-medium"></div>
                <div class="flex items-center gap-3 p-2"><input type="checkbox" id="app-visible" checked class="w-5 h-5 accent-primary"><label class="text-xs font-bold opacity-60">Hiển thị công khai</label></div>
                <button type="submit" class="w-full py-4 bg-primary text-white rounded-xl font-bold uppercase text-xs shadow-lg shadow-indigo-500/30">Lưu ứng dụng</button>
            </form>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="modal-user-profile" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b dark:border-white/5 flex justify-between items-center"><h3 class="font-bold uppercase text-sm text-primary">Tài khoản</h3><button onclick="window.closeModal('modal-user-profile')" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-8 space-y-6 flex flex-col items-center">
                <img id="profile-photo" class="w-20 h-20 rounded-full border-4 border-primary/20 p-0.5 shadow-md" src="" alt="Avatar">
                <span id="profile-role" class="text-[10px] font-black uppercase px-3 py-1 bg-primary/10 text-primary rounded-full"></span>
                <div class="w-full space-y-4 text-center">
                    <input type="text" id="profile-name" readonly class="w-full text-center font-bold text-lg bg-transparent border-none outline-none">
                    <p id="profile-email" class="text-sm text-slate-500"></p>
                    <div class="flex justify-around py-4 bg-slate-50 dark:bg-white/5 rounded-2xl">
                        <div><p class="text-[10px] font-bold text-slate-400 uppercase">Yêu thích</p><p id="profile-fav-count" class="text-lg font-bold text-primary">0</p></div>
                        <div><p class="text-[10px] font-bold text-slate-400 uppercase">Version</p><p class="text-lg font-bold">2.0</p></div>
                    </div>
                </div>
                <button onclick="window.logout()" class="w-full py-3 bg-red-500 text-white rounded-xl font-bold uppercase text-xs flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Đăng xuất</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 z-[300] transform translate-y-20 opacity-0 transition-all duration-500">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border dark:border-white/10">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg" class="text-sm font-bold tracking-tight">Thành công!</span>
        </div>
    </div>
    
    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, arrayUnion, arrayRemove, writeBatch, increment, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const SUPER_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

        const fbApp = initializeApp(firebaseConfig);
        const auth = getAuth(fbApp);
        const db = getFirestore(fbApp);
        const provider = new GoogleAuthProvider();

        let currentUser = null, isAdmin = false, isSuper = false, apps = [], categories = [], deputies = [], currentFilter = 'all', searchQuery = '', viewMode = 'grid', visitStats = {};
        let userFavorites = []; 
        let appsLoaded = false; 
        let bulkDeleteMode = false; 
        let selectedAppsForDelete = new Set(); 
        let currentAnnouncement = {}; 
        let adminRequests = []; 

        // SIDE TAB TOGGLE
        window.toggleSideTab = () => {
            const sideTab = document.getElementById('side-tab');
            const overlay = document.getElementById('side-tab-overlay');
            const isOpen = !sideTab.classList.contains('-translate-x-full');
            
            if (isOpen) {
                sideTab.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            } else {
                sideTab.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            }
        };

        // AUTH & INITIAL
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const requestSection = document.getElementById('request-admin-section');
            const requestStatus = document.getElementById('request-admin-status');
            const requestForm = document.getElementById('request-admin-form');

            if (user) {
                isSuper = user.uid === SUPER_UID;
                const snap = await getDoc(doc(db, "settings", "admins"));
                deputies = snap.exists() ? snap.data().deputy_emails || [] : [];
                isAdmin = isSuper || deputies.includes(user.email);
                
                const userDoc = await getDoc(doc(db, "users", user.uid));
                userFavorites = userDoc.exists() ? userDoc.data().favorites || [] : [];
                
                renderAuthUI();
                onSnapshot(doc(db, "users", user.uid), (snap) => {
                    userFavorites = snap.data()?.favorites || [];
                    if (currentFilter === 'favorites') renderApps();
                });
                
                requestSection.classList.toggle('hidden', isAdmin);
                if (!isAdmin) {
                    const reqSnap = await getDoc(doc(db, "adminRequests", user.uid));
                    if (reqSnap.exists()) {
                         requestStatus.innerText = "Yêu cầu của bạn đang chờ Admin chính duyệt.";
                         requestForm.classList.add('hidden');
                    } else {
                         requestStatus.innerText = "Bạn chưa có quyền quản trị. Vui lòng gửi yêu cầu.";
                         requestForm.classList.remove('hidden');
                    }
                }
                if (isAdmin) document.getElementById('announcement-content').value = currentAnnouncement.content || '';
            } else {
                isAdmin = isSuper = false;
                userFavorites = [];
                document.getElementById('auth-section').innerHTML = `<button onclick="window.login()" class="bg-primary text-white px-5 py-2 rounded-lg text-xs font-bold uppercase tracking-widest">Login</button>`;
                if (currentFilter === 'favorites') window.setFilter('all'); 
                requestSection.classList.add('hidden'); 
            }
            document.getElementById('role-status').innerText = isSuper ? 'SUPER' : (isAdmin ? 'DEPUTY' : 'GUEST');
            document.getElementById('admin-sidebar-toggle').classList.toggle('hidden', !isAdmin); 
            
            renderApps();
            renderDeputyList();
            renderAnnouncementControls(); 
            renderCategories();
        });

        // REQUEST ADMIN
        document.getElementById('request-admin-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const reason = document.getElementById('request-admin-reason').value.trim();
            if (reason.length < 5) { showToast("Lý do quá ngắn!", true); return; }
            try {
                await setDoc(doc(db, "adminRequests", currentUser.uid), {
                    uid: currentUser.uid, email: currentUser.email, name: currentUser.displayName,
                    reason: reason, timestamp: new Date().toISOString()
                });
                document.getElementById('request-admin-status').innerText = "Đã gửi yêu cầu thành công.";
                document.getElementById('request-admin-form').classList.add('hidden');
                showToast("Đã gửi yêu cầu!");
            } catch (e) { showToast("Lỗi gửi yêu cầu!", true); }
        };

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        window.toggleUserMenu = (event) => {
            event.stopPropagation();
            document.getElementById('user-menu')?.classList.toggle('hidden');
        };

        window.openUserProfileModal = () => {
            if (!currentUser) return;
            const role = isSuper ? 'SUPER ADMIN' : (isAdmin ? 'PHÓ ADMIN' : 'KHÁCH (GUEST)');
            document.getElementById('profile-name').value = currentUser.displayName;
            document.getElementById('profile-email').innerText = currentUser.email;
            document.getElementById('profile-uid').innerText = currentUser.uid; // Note: if you have this element
            document.getElementById('profile-role').innerText = role;
            document.getElementById('profile-fav-count').innerText = userFavorites.length;
            document.getElementById('profile-photo').src = currentUser.photoURL;
            window.openModal('modal-user-profile');
            lucide.createIcons();
        };

        function renderAuthUI() {
            document.getElementById('auth-section').innerHTML = `
                <div class="relative">
                    <button onclick="window.toggleUserMenu(event)" id="user-avatar-btn" class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 pr-3 rounded-lg border dark:border-white/10">
                        <img src="${currentUser.photoURL}" class="w-7 h-7 rounded-md">
                        <i data-lucide="chevron-down" class="w-3 h-3 text-slate-400"></i>
                    </button>
                    <div id="user-menu" class="absolute right-0 top-full mt-3 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-2xl z-20 hidden ring-1 ring-black/5 p-2">
                        <div class="px-3 py-2 text-sm font-bold truncate">${currentUser.displayName}</div>
                        <div class="h-px bg-slate-100 dark:bg-slate-700 my-2"></div>
                        <button onclick="window.openUserProfileModal()" class="flex items-center w-full px-3 py-2 text-sm font-medium rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i> Tài khoản</button>
                        <button onclick="window.logout()" class="flex items-center w-full px-3 py-2 text-sm font-medium text-red-500 rounded-lg hover:bg-red-50"><i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Đăng xuất</button>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        document.addEventListener('click', () => document.getElementById('user-menu')?.classList.add('hidden'));

        window.toggleAdminSidebar = () => document.getElementById('admin-sidebar').classList.toggle('open');

        // REALTIME DATA
        onSnapshot(query(collection(db, "categories"), orderBy("order", "asc")), (snap) => {
            categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCategories();
        });

        onSnapshot(query(collection(db, "apps"), orderBy("order", "asc")), (snap) => {
            apps = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            appsLoaded = true; 
            renderApps();
        });
        
        onSnapshot(doc(db, "settings", "visits_stats"), (snap) => {
            visitStats = snap.data() || {};
            renderStats();
        });
        
        onSnapshot(doc(db, "settings", "announcement"), (snap) => {
            currentAnnouncement = snap.data() || { content: '', active: false };
            renderAnnouncementBar();
            renderAnnouncementControls();
        });
        
        onSnapshot(collection(db, "adminRequests"), (snap) => {
            adminRequests = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAdminRequests();
        });

        // STATS
        function renderStats() {
            const container = document.getElementById('visit-stats-container');
            const miniCount = document.getElementById('today-visits-count');
            const { dailyVisits = 0, monthlyVisits = 0, yearlyVisits = 0, totalVisits = 0 } = visitStats;
            if (miniCount) miniCount.innerText = dailyVisits.toLocaleString('vi-VN');
            if (!container) return;
            container.innerHTML = `
                <div class="flex items-center gap-3 text-[10px] font-black tracking-widest text-primary dark:text-white mb-4"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> THỐNG KÊ LƯỢT TRUY CẬP</div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5"><p class="text-[9px] font-bold text-slate-400 uppercase">Hôm nay</p><span class="text-lg font-black text-primary">${dailyVisits.toLocaleString('vi-VN')}</span></div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5"><p class="text-[9px] font-bold text-slate-400 uppercase">Tháng này</p><span class="text-lg font-black text-primary">${monthlyVisits.toLocaleString('vi-VN')}</span></div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5"><p class="text-[9px] font-bold text-slate-400 uppercase">Năm nay</p><span class="text-lg font-black text-primary">${yearlyVisits.toLocaleString('vi-VN')}</span></div>
                    <div class="p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm text-center border dark:border-white/5"><p class="text-[9px] font-bold text-slate-400 uppercase">Tổng cộng</p><span class="text-lg font-black text-primary">${totalVisits.toLocaleString('vi-VN')}</span></div>
                </div>`;
            lucide.createIcons();
        }

        // APPS RENDER
        window.renderApps = () => {
            const container = document.getElementById('app-container');
            const loading = document.getElementById('app-loading');
            if (!appsLoaded) { loading.classList.remove('hidden'); container.innerHTML = ''; return; }
            loading.classList.add('hidden');

            const filtered = apps.filter(a => {
                if (currentFilter === 'favorites') { if (!userFavorites.includes(a.id)) return false; } 
                else {
                    const cat = categories.find(c => c.id === a.categoryId);
                    if (currentFilter === 'all') { if (cat?.name === "Số điện thoại") return false; } 
                    else if (a.categoryId !== currentFilter) return false;
                }
                return (a.name.toLowerCase().includes(searchQuery.toLowerCase()) || (a.position && a.position.toLowerCase().includes(searchQuery.toLowerCase()))) && (isAdmin || a.visible);
            });

            if (filtered.length === 0) {
                 container.className = "flex justify-center items-center h-40 text-slate-400";
                 container.innerHTML = `<i data-lucide="folder-search" class="w-6 h-6 mr-2"></i>Không tìm thấy ứng dụng nào.`;
                 lucide.createIcons(); return;
            }

            if (viewMode === 'grid') {
                container.className = "grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-x-4 gap-y-8";
                container.innerHTML = filtered.map(a => {
                    const isAppPhone = categories.find(c => c.id === a.categoryId)?.name === "Số điện thoại";
                    const domain = a.url.startsWith('http') ? new URL(a.url).hostname : '';
                    const icon = a.iconUrl || (isAppPhone ? 'https://cdn-icons-png.flaticon.com/512/3059/3059502.png' : `https://unavatar.io/${domain}?fallback=https://www.google.com/s2/favicons?domain=${domain}&sz=128`);
                    const isFav = userFavorites.includes(a.id) ? 'is-favorite' : '';
                    const isSelected = selectedAppsForDelete.has(a.id) ? 'selected-for-delete' : '';
                    const opacity = a.visible ? '' : 'opacity-40';
                    
                    return `<div class="app-item group flex flex-col items-center relative ${isFav} ${isSelected}" data-id="${a.id}" onclick="${bulkDeleteMode ? `window.toggleAppSelection('${a.id}', event)` : ''}">
                        <a href="${bulkDeleteMode ? '#' : (isAppPhone ? 'tel:' + a.url : a.url)}" target="${bulkDeleteMode ? '' : '_blank'}" class="w-full aspect-square bg-white dark:bg-slate-800 rounded-2xl shadow-sm border dark:border-white/5 flex items-center justify-center p-3 mb-2 hover:shadow-xl hover:-translate-y-1 transition-all">
                            <img src="${icon}" class="w-full h-full object-contain rounded-lg ${opacity}">
                        </a>
                        <span class="text-[10px] font-bold text-slate-500 text-center truncate w-full uppercase ${opacity}">${a.name}</span>
                        ${a.position ? `<span class="text-[8px] text-slate-400 font-bold truncate w-full text-center uppercase ${opacity}">${a.position}</span>` : ''}
                        ${bulkDeleteMode ? `<input type="checkbox" class="absolute top-1 right-1 w-5 h-5 accent-red-500" ${selectedAppsForDelete.has(a.id) ? 'checked' : ''}>` : ''}
                        <div class="absolute -top-1 -right-1 flex flex-col gap-1 transition-all scale-90 z-10 ${isAdmin && !bulkDeleteMode ? 'opacity-0 group-hover:opacity-100' : (currentUser && !bulkDeleteMode ? '' : 'hidden') }">
                            <button onclick="window.toggleFavorite('${a.id}', event)" class="bg-yellow-400 text-white p-2 rounded-full shadow-lg"><i data-lucide="star" class="w-3 h-3 star-icon ${isFav ? 'fill-current' : ''}"></i></button>
                            ${isAdmin ? `<button onclick="window.toggleAppVisibility('${a.id}')" class="${a.visible ? 'bg-green-500' : 'bg-slate-500'} text-white p-2 rounded-full shadow-lg"><i data-lucide="${a.visible ? 'eye' : 'eye-off'}" class="w-3 h-3"></i></button><button onclick="window.editApp('${a.id}')" class="bg-indigo-500 text-white p-2 rounded-full shadow-lg"><i data-lucide="edit-2" class="w-3 h-3"></i></button><button onclick="window.deleteApp('${a.id}')" class="bg-red-500 text-white p-2 rounded-full shadow-lg"><i data-lucide="trash" class="w-3 h-3"></i></button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            } else {
                container.className = "flex flex-col max-w-4xl mx-auto space-y-1";
                container.innerHTML = filtered.map((a, idx) => {
                    const isAppPhone = categories.find(c => c.id === a.categoryId)?.name === "Số điện thoại";
                    const icon = a.iconUrl || 'https://www.google.com/s2/favicons?domain=' + a.url;
                    return `<div class="flex items-center gap-4 bg-white dark:bg-slate-900 p-3 rounded-xl border dark:border-white/5 group shadow-sm ${selectedAppsForDelete.has(a.id) ? 'selected-for-delete' : ''}" data-id="${a.id}" onclick="${bulkDeleteMode ? `window.toggleAppSelection('${a.id}', event)` : ''}">
                        ${bulkDeleteMode ? `<input type="checkbox" class="w-5 h-5 accent-red-500" ${selectedAppsForDelete.has(a.id) ? 'checked' : ''}>` : `<span class="text-[9px] font-black text-slate-300 w-4">${idx+1}</span>`}
                        <img src="${icon}" class="w-8 h-8 rounded-lg object-contain ${a.visible ? '' : 'opacity-40'}">
                        <div class="flex-1 min-w-0"><h4 class="text-xs font-bold truncate ${a.visible ? '' : 'opacity-40'}">${a.name}</h4><p class="text-[9px] font-bold text-slate-400 uppercase ${a.visible ? '' : 'opacity-40'}">${a.position || 'App'}</p></div>
                        <div class="flex items-center gap-2">
                            ${currentUser && !bulkDeleteMode ? `<button onclick="window.toggleFavorite('${a.id}', event)" class="p-2 text-yellow-500 hover:bg-slate-100 rounded-lg"><i data-lucide="star" class="w-4 h-4 star-icon ${userFavorites.includes(a.id) ? 'fill-current' : ''}"></i></button>` : ''}
                            <a href="${isAppPhone ? 'tel:' + a.url : a.url}" target="_blank" class="p-2 text-primary hover:bg-primary/10 rounded-lg"><i data-lucide="${isAppPhone ? 'phone' : 'external-link'}" class="w-4 h-4"></i></a>
                            ${isAdmin && !bulkDeleteMode ? `<button onclick="window.toggleAppVisibility('${a.id}')" class="p-2 ${a.visible ? 'text-green-500' : 'text-slate-500'} rounded-lg"><i data-lucide="${a.visible ? 'eye' : 'eye-off'}" class="w-4 h-4"></i></button><button onclick="window.editApp('${a.id}')" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button><i data-lucide="grip-vertical" class="w-4 h-4 text-slate-300 cursor-move"></i>` : ''}
                        </div></div>`;
                }).join('');
            }
            lucide.createIcons();
            if(isAdmin && viewMode === 'list') new Sortable(container, { animation: 150, handle: '.cursor-move', onEnd: () => { Array.from(container.children).forEach((el, i) => { if(el.dataset.id) updateDoc(doc(db, "apps", el.dataset.id), { order: i }); }); }});
        };

        // RENDER CATEGORIES
        window.renderCategories = () => {
            const sideList = document.getElementById('category-side-list');
            let html = `<button onclick="window.setFilter('all')" class="side-tab-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold uppercase tracking-widest ${currentFilter === 'all' ? 'active' : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800'}"><i data-lucide="layout-grid" class="w-4 h-4"></i> Tất cả</button>`;
            
            if (currentUser) {
                html += `<button onclick="window.setFilter('favorites')" class="side-tab-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold uppercase tracking-widest ${currentFilter === 'favorites' ? 'active' : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800'}"><i data-lucide="star" class="w-4 h-4 ${currentFilter === 'favorites' ? 'fill-current' : ''}"></i> Ưa thích</button>`;
            }
            
            categories.forEach(c => {
                html += `<button onclick="window.setFilter('${c.id}')" class="side-tab-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold uppercase tracking-widest ${currentFilter === c.id ? 'active' : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800'}">
                    ${c.icon ? `<img src="${c.icon}" class="w-4 h-4 object-contain">` : '<i data-lucide="folder" class="w-4 h-4"></i>'} 
                    <span class="truncate">${c.name}</span>
                </button>`;
            });
            sideList.innerHTML = html;

            // Render for Admin Sidebar Tab
            const adminList = document.getElementById('cat-list-admin');
            adminList.innerHTML = categories.map(c => `<li class="flex flex-col gap-2 p-4 bg-slate-50 dark:bg-white/5 rounded-2xl border dark:border-white/5" data-id="${c.id}"><div class="flex items-center gap-3"><i data-lucide="grip-vertical" class="text-slate-300 cursor-move"></i><input type="text" value="${c.name}" onblur="window.updateCatField('${c.id}', 'name', this.value)" class="flex-1 bg-transparent border-none font-bold text-sm outline-none"><button onclick="window.deleteCat('${c.id}')" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><input type="text" value="${c.icon || ''}" onblur="window.updateCatField('${c.id}', 'icon', this.value)" placeholder="Icon URL" class="text-[10px] bg-white dark:bg-black/20 px-4 py-2 rounded-lg outline-none w-full border-none"></li>`).join('');
            
            document.getElementById('app-category').innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            lucide.createIcons();
            if(isAdmin) new Sortable(adminList, { animation: 150, handle: '.cursor-move', onEnd: () => { Array.from(adminList.children).forEach((el, i) => updateDoc(doc(db, "categories", el.dataset.id), { order: i })); }});
        };

        window.setFilter = (id) => { 
            if (id === 'favorites' && !currentUser) { showToast("Vui lòng đăng nhập!", true); return; }
            currentFilter = id; 
            renderCategories(); 
            renderApps();
            if (window.innerWidth < 1024) window.toggleSideTab(); // Auto close on mobile
        };

        // ADMIN FUNCTIONS
        window.toggleAnnouncementStatus = async () => {
            await setDoc(doc(db, "settings", "announcement"), { active: !currentAnnouncement.active }, { merge: true });
        };

        window.saveAnnouncementContent = async () => {
            const content = document.getElementById('announcement-content').value;
            await setDoc(doc(db, "settings", "announcement"), { content }, { merge: true });
            showToast("Đã lưu thông báo!");
        };

        window.approveAdminRequest = async (uid, email) => {
            await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
            await deleteDoc(doc(db, "adminRequests", uid));
            showToast("Đã phê duyệt!");
        };

        window.rejectAdminRequest = async (uid) => {
            await deleteDoc(doc(db, "adminRequests", uid));
            showToast("Đã từ chối!");
        };

        window.addCategory = async () => {
            const name = document.getElementById('new-cat-name').value;
            const icon = document.getElementById('new-cat-icon').value;
            if(!name) return;
            await addDoc(collection(db, "categories"), { name, icon, order: categories.length });
            document.getElementById('new-cat-name').value = '';
        };

        window.deleteCat = (id) => confirm("Xóa danh mục này?") && deleteDoc(doc(db, "categories", id));
        window.updateCatField = (id, field, val) => updateDoc(doc(db, "categories", id), { [field]: val });

        window.addDeputy = async () => {
            const email = document.getElementById('new-deputy-email').value;
            if(!email || !isSuper) return;
            await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayUnion(email) }, { merge: true });
            document.getElementById('new-deputy-email').value = '';
        };

        window.removeDeputy = async (email) => {
            if(!isSuper) return;
            await setDoc(doc(db, "settings", "admins"), { deputy_emails: arrayRemove(email) }, { merge: true });
        };

        window.renderDeputyList = () => {
            const list = document.getElementById('deputy-list');
            list.innerHTML = deputies.map(email => `<div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-white/5 rounded-xl border dark:border-white/5"><span class="text-sm font-medium">${email}</span>${isSuper ? `<button onclick="window.removeDeputy('${email}')" class="text-red-500"><i data-lucide="user-minus" class="w-4 h-4"></i></button>` : ''}</div>`).join('');
            document.getElementById('deputy-guard').classList.toggle('hidden', isSuper);
            document.getElementById('deputy-ui').classList.toggle('hidden', !isSuper);
            lucide.createIcons();
        };

        window.renderAdminRequests = () => {
            if (!isSuper) return;
            const list = document.getElementById('requests-list');
            document.getElementById('request-count').innerText = adminRequests.length;
            list.innerHTML = adminRequests.map(req => `<div class="p-4 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5 space-y-2"><p class="text-sm font-bold">${req.name}</p><p class="text-xs text-slate-500">${req.reason}</p><div class="flex gap-2"><button onclick="window.approveAdminRequest('${req.uid}', '${req.email}')" class="flex-1 bg-green-500 text-white py-2 rounded-lg text-[10px] font-bold">DUYỆT</button><button onclick="window.rejectAdminRequest('${req.uid}')" class="flex-1 bg-red-500 text-white py-2 rounded-lg text-[10px] font-bold">XÓA</button></div></div>`).join('');
            lucide.createIcons();
        };

        // EXPORT / IMPORT
        window.handleExport = (type) => {
            const data = { apps: apps.map(({id, ...rest}) => rest), categories: categories.map(({id, ...rest}) => rest), exportedAt: new Date().toISOString() };
            if (type === 'json') {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `hub-portal-backup.json`; a.click();
            } else {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(apps.map(a => ({ 'Tên': a.name, 'URL': a.url, 'Chức vụ': a.position || '', 'Danh mục': categories.find(c => c.id === a.categoryId)?.name || '' })));
                XLSX.utils.book_append_sheet(wb, ws, "Apps");
                XLSX.writeFile(wb, "hub-portal-data.xlsx");
            }
            showToast("Xuất dữ liệu thành công!");
        };

        window.handleImport = async (event) => {
            const file = event.target.files[0]; if (!file || !confirm("Bắt đầu khôi phục?")) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    let imported = JSON.parse(e.target.result);
                    // Import logic here (similar to original)
                    showToast("Nhập dữ liệu thành công!");
                } catch (err) { showToast("Lỗi nhập dữ liệu!", true); }
            };
            reader.readAsText(file);
        };

        // UI HELPERS
        window.toggleFavorite = (id, e) => {
            e.stopPropagation(); if (!currentUser) { showToast("Hãy đăng nhập!", true); return; }
            const isFav = userFavorites.includes(id);
            updateDoc(doc(db, "users", currentUser.uid), { favorites: isFav ? arrayRemove(id) : arrayUnion(id) });
        };

        window.toggleAppVisibility = (id) => {
            const a = apps.find(x => x.id === id);
            updateDoc(doc(db, "apps", id), { visible: !a.visible });
        };

        window.deleteApp = (id) => confirm("Xóa mục này?") && deleteDoc(doc(db, "apps", id));

        window.editApp = (id) => {
            const a = apps.find(x => x.id === id);
            document.getElementById('edit-id').value = a.id;
            document.getElementById('app-name').value = a.name;
            document.getElementById('app-position').value = a.position || '';
            document.getElementById('app-link').value = a.url;
            document.getElementById('app-icon').value = a.iconUrl || '';
            document.getElementById('app-category').value = a.categoryId;
            document.getElementById('app-visible').checked = a.visible;
            window.toggleFormFields(); window.openModal('modal-app');
        };

        window.toggleBulkDelete = () => {
            bulkDeleteMode = !bulkDeleteMode;
            selectedAppsForDelete.clear();
            document.getElementById('bulk-delete-sidebar-toggle').classList.toggle('bg-red-500', bulkDeleteMode);
            document.getElementById('bulk-delete-sidebar-toggle').classList.toggle('text-white', bulkDeleteMode);
            document.getElementById('bulk-delete-dock').classList.toggle('hidden', !bulkDeleteMode);
            renderApps();
        };

        window.toggleAppSelection = (id, e) => {
            e.stopPropagation();
            if (selectedAppsForDelete.has(id)) selectedAppsForDelete.delete(id);
            else selectedAppsForDelete.add(id);
            document.getElementById('selected-count').innerText = selectedAppsForDelete.size;
            renderApps();
        };

        window.executeBulkDelete = async () => {
            if (!confirm(`Xóa ${selectedAppsForDelete.size} mục?`)) return;
            const batch = writeBatch(db);
            selectedAppsForDelete.forEach(id => batch.delete(doc(db, "apps", id)));
            await batch.commit();
            window.toggleBulkDelete();
            showToast("Đã xóa hoàn tất!");
        };

        document.getElementById('app-form').onsubmit = async (e) => {
            e.preventDefault(); const id = document.getElementById('edit-id').value;
            const data = { name: document.getElementById('app-name').value, position: document.getElementById('app-position').value, url: document.getElementById('app-link').value, iconUrl: document.getElementById('app-icon').value, categoryId: document.getElementById('app-category').value, visible: document.getElementById('app-visible').checked, order: id ? apps.find(x => x.id === id).order : apps.length };
            id ? await updateDoc(doc(db, "apps", id), data) : await addDoc(collection(db, "apps"), data);
            window.closeModal('modal-app'); showToast("Thành công!");
        };

        window.toggleFormFields = () => {
            const cat = categories.find(c => c.id === document.getElementById('app-category').value);
            const isPhone = cat?.name === "Số điện thoại";
            document.getElementById('field-position').classList.toggle('hidden', !isPhone);
        };

        // TRACK VISITS
        async function trackVisit() {
            try {
                const now = new Date(); const d = now.toISOString().split('T')[0];
                await runTransaction(db, async (transaction) => {
                    const ref = doc(db, "settings", "visits_stats");
                    const snap = await transaction.get(ref);
                    const data = snap.data() || {};
                    transaction.set(ref, { totalVisits: increment(1), dailyVisits: data.lastDailyUpdate === d ? increment(1) : 1, lastDailyUpdate: d }, { merge: true });
                });
            } catch (e) {}
        }

        function renderAnnouncementBar() {
            const bar = document.getElementById('announcement-bar');
            if (currentAnnouncement.active && currentAnnouncement.content) {
                document.getElementById('announcement-text').innerText = currentAnnouncement.content.toUpperCase() + " • ";
                bar.classList.remove('hidden');
            } else bar.classList.add('hidden');
        }

        function renderAnnouncementControls() {
            if (!isAdmin) return;
            document.getElementById('toggle-announcement-btn').innerText = currentAnnouncement.active ? 'TẮT' : 'BẬT';
        }

        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; };
        window.switchTab = (id) => {
            ['tab-cat', 'tab-announcement', 'tab-deputy', 'tab-request', 'tab-data'].forEach(t => document.getElementById(t).classList.add('hidden'));
            ['btn-tab-cat', 'btn-tab-announcement', 'btn-tab-deputy', 'btn-tab-request', 'btn-tab-data'].forEach(b => document.getElementById(b).classList.remove('text-primary', 'border-b-2', 'border-primary'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('text-primary', 'border-b-2', 'border-primary');
            if(id === 'tab-deputy') renderDeputyList();
            if(id === 'tab-request') renderAdminRequests();
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openAppModal = () => { document.getElementById('app-form').reset(); document.getElementById('edit-id').value = ''; window.openModal('modal-app'); };

        function showToast(msg, err = false) {
            const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-20'), 3000);
        }

        document.getElementById('search-input').oninput = (e) => { searchQuery = e.target.value; renderApps(); };
        window.setView = (v) => { viewMode = v; renderApps(); };

        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        lucide.createIcons();
        trackVisit();
    </script>
</body>
</html>
