
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUX STUDIO | Minimalist Photography Portfolio</title>
    
    <!-- Fonts: Playfair Display (Tiêu đề sang trọng) & Inter (Nội dung hiện đại) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #ffffff;
            --bg-secondary: #f9f9f9;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #222222; /* Màu đen sang trọng */
            --accent-hover: #000000;
            --border: #e0e0e0;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --success: #27ae60;
            --danger: #c0392b;
            --font-main: 'Inter', sans-serif;
            --font-title: 'Playfair Display', serif;
            --radius: 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-main);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- UTILITY & LAYOUT --- */
        .section-padding { padding: 60px 0; }
        .section-title {
            font-family: var(--font-title);
            font-size: 3rem;
            font-weight: 400;
            text-align: center;
            margin-bottom: 50px;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .dash-container { max-width: 1200px; margin: 0 auto; padding: 20px 20px 60px 20px; } /* Dashboard container style */

        /* MODIFIED: Horizontal Scrolling Services */
        .services-grid {
            display: flex;
            overflow-x: auto;
            gap: 30px;
            padding-bottom: 20px; /* Add padding for scrollbar visibility */
            /* Hide the scrollbar for aesthetic purposes, but allow scrolling */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .services-grid::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* --- SERVICE CARD --- */
        .service-card {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            transition: box-shadow 0.3s ease;
            min-width: 320px; /* Ensure cards have a minimum width */
            flex-shrink: 0; /* Important for horizontal scrolling */
        }
        .service-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        .svc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .svc-header h3 {
            font-family: var(--font-main);
            font-size: 1.4rem;
            font-weight: 600;
        }
        .svc-price {
            font-family: var(--font-title);
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent);
        }
        .svc-desc {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .option-group {
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 0.9rem;
        }
        .option-row label {
            cursor: default; /* Changed from pointer to default */
            color: var(--text-primary); /* Changed to primary color to show it's a feature */
        }
        .option-row span {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* --- BADGES (STATUS) --- */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        .badge-pending {
            background: #fdf5e6; /* light yellow */
            color: #cc9900;
        }
        .badge-deposit {
            background: #e6f7ff; /* light blue */
            color: #1890ff;
        }
        .badge-completed {
            background: #f6ffed; /* light green */
            color: var(--success);
        }
        .badge-cancelled {
            background: #fbebeb; /* light red */
            color: var(--danger);
        }

        /* --- MARQUEE --- */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            width: 100%;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin: 40px 0;
        }
        .marquee-content {
            display: inline-block;
            animation: marquee 40s linear infinite;
            padding-right: 10px; /* Space between duplicated sets */
        }
        .marquee-content img {
            height: 250px; /* Standardize image height */
            width: auto;
            object-fit: cover;
            margin-right: 10px;
            vertical-align: middle;
            border-radius: var(--radius);
        }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); } /* Move half of the content width */
        }

        /* --- UI ELEMENTS: BUTTONS, FORMS, LAYOUTS --- */
        .btn {
            padding: 12px 25px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.85rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            font-weight: 500;
            border-radius: var(--radius);
        }

        .btn:hover {
            background: var(--accent-hover);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-fill { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-fill:hover { background: var(--accent-hover); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }

        .btn-sm { padding: 8px 15px; font-size: 0.75rem; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

        /* --- HEADER --- */
        header {
            padding: 20px 40px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(8px);
            z-index: 1000;
            border-bottom: 1px solid transparent;
            transition: 0.3s;
            height: 70px; /* Added height for consistent mobile positioning */
        }
        header.scrolled { border-bottom: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .logo {
            font-family: var(--font-title);
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        nav { display: block; } /* Default: visible on desktop */
        nav ul { display: flex; gap: 40px; list-style: none; }
        nav a { text-decoration: none; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; transition: color 0.3s; }
        nav a:hover { color: var(--text-secondary); }

        .auth-area { display: flex; align-items: center; gap: 15px; }
        #userAvatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; display: none; }
        #menuToggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--accent); } /* Mobile Only */


        /* --- HERO & DASHBOARD --- */
        .hero {
            text-align: center;
            padding: 100px 20px;
            background: var(--bg-secondary);
        }
        .hero h1 {
            font-family: var(--font-title);
            font-size: 4.5rem;
            font-weight: 400;
            margin-bottom: 20px;
            line-height: 1.1;
        }
        .hero p {
            max-width: 600px;
            margin: 0 auto 30px auto;
            color: var(--text-secondary);
        }
        
        /* TAB BAR CHUYÊN NGHIỆP */
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .tab { 
            padding: 10px 15px; 
            cursor: pointer; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s ease-in-out; 
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        .tab.active { 
            color: var(--accent); 
            border-bottom-color: var(--accent); 
            font-weight: 600; 
        }
        .tab:hover { 
            color: var(--accent); 
            background: var(--bg-secondary);
        }

        /* --- TABLE --- */
        .table-wrap {
            overflow-x: auto;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            min-width: 800px; /* Ensure table is readable on small devices */
        }
        table thead th {
            border-bottom: 2px solid var(--accent);
            padding: 10px 15px;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-secondary);
        }
        table tbody td {
            border-bottom: 1px solid var(--border);
            padding: 10px 15px;
            vertical-align: middle;
            font-size: 0.95rem;
        }
        
        /* Form Inputs */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        .form-group input, .form-group textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            font-family: var(--font-main);
            font-size: 1rem;
            transition: all 0.2s;
            border-radius: var(--radius);
        }
        .form-group input:focus, .form-group textarea:focus, select:focus {
             box-shadow: 0 0 0 2px rgba(34, 34, 34, 0.1);
             outline: none;
        }

        /* --- FOOTER --- */
        footer {
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* --- MODAL --- */
        .modal {
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none; 
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background-color: var(--bg-body);
            padding: 30px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 100%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            animation: fadeIn 0.3s;
        }
        .close-btn {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        /* --- LOADER --- */
        #loader {
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: none; 
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border: 5px solid var(--border);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TOAST --- */
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: var(--accent-hover);
            color: #fff;
            text-align: center;
            border-radius: var(--radius);
            padding: 16px;
            position: fixed;
            z-index: 3001;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
        }
        
        /* Keyframe for Modal */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }


        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            
            header {
                padding: 15px 20px;
            }

            .hero {
                padding: 60px 20px;
            }
            .hero h1 {
                font-size: 3rem;
            }
            .section-title {
                font-size: 2.5rem;
            }

            /* Mobile Navigation Fix */
            nav {
                display: none; /* Hide by default */
                position: absolute;
                top: 70px; /* Adjust to header height */
                left: 0;
                right: 0;
                background: var(--bg-body);
                border-top: 1px solid var(--border);
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                padding: 20px 0;
                transition: transform 0.3s ease-in-out;
                transform: translateY(-100%);
            }

            nav.open {
                display: block;
                transform: translateY(0);
            }
            
            nav ul {
                flex-direction: column;
                gap: 15px;
                padding: 0 20px;
            }

            #menuToggle {
                display: block; /* Show the hamburger button */
            }

            .auth-area {
                display: none; /* Hide default auth area on mobile, rely on menu links (login/logout in JS) */
            }
            /* End Mobile Navigation Fix */


            /* Admin Stats on mobile */
            #adminStats { flex-direction: column; }
            #adminStats > div { flex: 1 1 100%; }
        }
    </style>
</head>
<body>

    <!-- UTILS -->
    <div id="loader" style="display:none"><div class="spinner"></div></div>
    <div id="toast">Thông báo</div>

    <!-- HEADER -->
    <header id="mainHeader">
        <div class="logo">LUX STUDIO.</div>
        <!-- Thêm nút Hamburger Menu cho mobile -->
        <button id="menuToggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

        <nav id="mainNav">
            <ul>
                <li><a href="#" onclick="goHome(); toggleMenu(false)">Portfolio</a></li>
                <li><a href="#services" onclick="toggleMenu(false)">Dịch vụ</a></li>
                <li><a href="#" id="menuDash" style="display:none" onclick="goDash(); toggleMenu(false)">Quản lý</a></li>
                <!-- Mobile Only Auth Links -->
                <li><button id="loginBtnMobile" class="btn btn-sm btn-fill" style="display:none; width:100%;" onclick="login(); toggleMenu(false)">Đăng nhập</button></li>
                <li><button id="logoutBtnMobile" class="btn btn-sm btn-danger" style="display:none; width:100%;" onclick="logout(); toggleMenu(false)">Thoát</button></li>
            </ul>
        </nav>
        <div class="auth-area">
            <button id="loginBtn" class="btn" onclick="login()">Đăng nhập</button>
            <img id="userAvatar" src="" alt="User">
            <button id="logoutBtn" class="btn btn-sm" style="display:none; border:none;" onclick="logout()">Thoát</button>
        </div>
    </header>

    <!-- MAIN PAGE -->
    <main id="mainPage">
        <!-- Hero -->
        <section class="hero">
            <h1>Chụp ảnh là<br>kể chuyện bằng ánh sáng</h1>
            <p>Ghi lại những khoảnh khắc chân thực, tinh tế và đầy cảm xúc của bạn. Chúng tôi mang đến trải nghiệm chụp ảnh studio và ngoại cảnh chuyên nghiệp, đẳng cấp.</p>
            <a href="#services" class="btn btn-fill">Đặt lịch ngay</a>
        </section>

        <!-- Marquee Gallery -->
        <div class="marquee-container">
            <div class="marquee-content">
                <!-- Duplicate images to create infinite loop effect -->
                <img src="https://images.unsplash.com/photo-1511285560982-1356c11d4606?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1519741497674-611481863552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1520390138845-fd2d229dd552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=600&q=80">
                <!-- Repeat set -->
                <img src="https://images.unsplash.com/photo-1511285560982-1356c11d4606?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1519741497674-611481863552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1520390138845-fd2d229dd552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=600&q=80">
            </div>
        </div>

        <!-- Services (Horizontal Scroll) -->
        <section id="services" class="container section-padding">
            <h2 class="section-title">Gói chụp (Services)</h2>
            <div id="servicesGrid" class="services-grid">
                <!-- JS render -->
            </div>
        </section>
    </main>

    <!-- DASHBOARD -->
    <section id="dashboardSection" style="display:none">
        <div class="dash-container">
            <h2 class="section-title" style="text-align:left; font-size: 2rem;">Khu vực quản lý</h2>
            
            <div id="dashTabs" class="tabs">
                <div class="tab" id="tabBtn-my-orders" onclick="switchTab('my-orders', this)">Đơn của tôi</div>
                <div class="tab admin-only" id="tabBtn-admin-orders" style="display:none" onclick="switchTab('admin-orders', this)">Quản lý Đơn (Admin)</div>
                <div class="tab admin-only" id="tabBtn-admin-schedule" style="display:none" onclick="switchTab('admin-schedule', this)">Lịch chụp (Admin)</div>
                <div class="tab admin-only" id="tabBtn-admin-services" style="display:none" onclick="switchTab('admin-services', this)">Quản lý Gói (Admin)</div>
            </div>

            <!-- Client: My Orders -->
            <div id="tab-my-orders" class="tab-content" style="display:none">
                <div class="table-wrap">
                    <table id="myOrdersTable">
                        <thead><tr><th>Ngày đặt</th><th>Ngày/Giờ chụp</th><th>Gói</th><th>Địa điểm</th><th>Tổng tiền</th><th>Trạng thái</th><th>Kết quả</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: All Orders (Updated with Search/Stats) -->
            <div id="tab-admin-orders" class="tab-content" style="display:none">
                 <!-- ADMIN STATS -->
                <div id="adminStats" style="display:flex; gap:20px; margin-bottom: 30px; flex-wrap:wrap;">
                    <div style="flex:1; padding:15px; border-left:4px solid #27ae60; background:#f6ffed; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Tổng đơn</p><h3 id="statTotal">0</h3>
                    </div>
                    <div style="flex:1; padding:15px; border-left:4px solid #1890ff; background:#e6f7ff; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Đơn Đã cọc</p><h3 id="statDeposit">0</h3>
                    </div>
                    <div style="flex:1; padding:15px; border-left:4px solid #cc9900; background:#fdf5e6; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Chờ xác nhận</p><h3 id="statPending">0</h3>
                    </div>
                    <div style="flex:1; padding:15px; border-left:4px solid #c0392b; background:#fbebeb; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Tỷ lệ HT</p><h3 id="statCompleteRate">0%</h3>
                    </div>
                </div>

                <!-- ADMIN SEARCH/FILTER -->
                <div style="display:flex; gap:10px; margin-bottom: 20px; flex-wrap:wrap;">
                    <input type="text" id="orderSearch" placeholder="Tìm theo Khách/SĐT/Địa điểm" style="flex: 2; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius);">
                    <select id="orderFilterStatus" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius);">
                        <option value="">-- Tất cả Trạng thái --</option>
                        <option value="Chờ xác nhận">Chờ xác nhận</option>
                        <option value="Đã cọc">Đã cọc</option>
                        <option value="Hoàn thành">Hoàn thành</option>
                        <option value="Đã hủy">Đã hủy</option>
                    </select>
                    <button class="btn btn-fill" onclick="loadAdminOrders()">Tìm kiếm</button>
                </div>

                <div class="table-wrap">
                    <table id="adminOrdersTable">
                        <thead><tr><th>Khách</th><th>SĐT</th><th>Ngày/Giờ chụp</th><th>Địa điểm</th><th>Gói</th><th>Tổng</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- Vị trí cho nút 'Hiển thị tất cả' -->
            </div>
            
            <!-- Admin: Schedule View (Simple List for time being) -->
            <div id="tab-admin-schedule" class="tab-content" style="display:none">
                <h3 style="margin-bottom:10px">Lịch Chụp Đã Duyệt (Đã cọc/Hoàn thành)</h3>
                <input type="date" id="scheduleDateFilter" onchange="renderAdminSchedule()" style="padding:10px; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom:20px;">
                <div id="adminScheduleList" style="display:grid; gap:15px">
                    <p>Chọn ngày để xem lịch chụp.</p>
                </div>
            </div>

            <!-- Admin: Service Management (Updated Layout) -->
            <div id="tab-admin-services" class="tab-content" style="display:none">
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:20px;">
                    <h3>Danh sách gói dịch vụ</h3>
                    <button class="btn btn-fill" onclick="openServiceModal()">+ Tạo gói mới</button>
                </div>
                <!-- Reusing service-card styles for better display -->
                <div id="adminServicesList" style="margin-top:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px"></div>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <p>&copy; 2024 Lux Photography Studio. All rights reserved.</p>
    </footer>

    <!-- MODAL: Booking (ADDED TIME) -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('bookingModal')">&times;</span>
            <h3>Xác nhận đặt lịch</h3>
            <div id="bookingSummary" style="background:#f9f9f9; padding:15px; margin-bottom:20px; border-radius:var(--radius)"></div>
            
            <div class="form-group">
                <label>Ngày chụp (*)</label>
                <input type="date" id="shootDate" required>
            </div>
            <div class="form-group">
                <label>Giờ chụp (*)</label>
                <input type="time" id="shootTime" required value="09:00">
            </div>
            <div class="form-group">
                <label>Địa điểm chụp (*)</label>
                <input type="text" id="shootLocation" placeholder="Studio X / Công viên Y / Địa chỉ cụ thể" required>
            </div>
            <div class="form-group">
                <label>Số điện thoại liên hệ (*)</label>
                <input type="tel" id="userPhone" placeholder="09xxxxxxx" required>
            </div>
            
            <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end; margin-top:20px">
                <button class="btn" onclick="closeModal('bookingModal')">Hủy</button>
                <button class="btn btn-fill" onclick="submitBooking()">Đặt ngay</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Admin Service Edit -->
    <div id="svcModal" class="modal">
        <div class="modal-content" style="max-width:600px">
            <span class="close-btn" onclick="closeModal('svcModal')">&times;</span>
            <h3 id="svcModalTitle">Gói dịch vụ</h3>
            <input type="hidden" id="editSvcId">
            <div class="form-group"><label>Tên gói</label><input type="text" id="svcName"></div>
            <div class="form-group"><label>Giá gốc</label><input type="number" id="svcPrice"></div>
            <div class="form-group"><label>Mô tả ngắn</label><textarea id="svcDesc" rows="2"></textarea></div>
            
            <div style="margin: 20px 0; border-top:1px solid #eee; padding-top:10px">
                <label style="font-weight:600; font-size:0.9rem">Tùy chọn thêm (Options)</label>
                <div id="optContainer"></div>
                <button class="btn btn-sm" onclick="addOptionRow()">+ Thêm dòng option</button>
            </div>

            <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end; margin-top:20px">
                <button class="btn" onclick="closeModal('svcModal')">Đóng</button>
                <button class="btn btn-fill" onclick="saveService()">Lưu gói</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Admin Deliver Job (ĐÃ BỊ SỬA THÀNH INPUT CHO updateStatus) -->
    <!-- Giữ lại ID để dùng cho input trong DeliverModalStatus -->
    <div id="deliverModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('deliverModal')">&times;</span>
            <h3>Trả ảnh cho khách và Hoàn thành đơn hàng</h3>
            <input type="hidden" id="deliverOrderId">
            <input type="hidden" id="deliverOrderOriginalStatus">
            <div class="form-group">
                <label>Link Google Drive / Gallery (*)</label>
                <input type="text" id="jobLink" placeholder="https://..." required>
            </div>
            <div class="form-group">
                <label>Mật khẩu / Mã truy cập</label>
                <input type="text" id="jobPass" placeholder="Nếu có">
            </div>
            <button class="btn btn-fill" style="width:100%; margin-top:10px" onclick="submitDelivery()">Xác nhận Hoàn thành và Trả job</button>
            <button class="btn" style="width:100%; margin-top:10px" onclick="closeModal('deliverModal')">Đóng</button>
        </div>
    </div>

    <!-- MODAL: Client View Job -->
    <div id="resultModal" class="modal">
        <div class="modal-content" style="text-align:center">
            <span class="close-btn" onclick="closeModal('resultModal')">&times;</span>
            <h3 style="color:var(--success)">Ảnh của bạn đã sẵn sàng!</h3>
            <p>Vui lòng dùng thông tin dưới đây để truy cập:</p>
            <div style="background:#f0f0f0; padding:20px; margin:20px 0; border-radius:8px">
                <p><strong>Link Truy Cập:</strong></p> 
                <a id="resLink" href="#" target="_blank" class="btn btn-fill" style="text-decoration:none; margin-top:5px">
                    <i class="fas fa-external-link-alt"></i> Bấm vào đây để mở
                </a>
                <p style="margin-top:20px"><strong>Mật khẩu:</strong></p> 
                <span id="resPass" style="font-family:monospace; font-size:1.2rem; background:white; padding:5px 10px; border-radius:var(--radius); display:inline-block"></span>
            </div>
            <button class="btn" onclick="closeModal('resultModal')">Đã nhận</button>
        </div>
    </div>


    <!-- SCRIPT (MAJOR LOGIC CHANGES) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, setDoc, getDoc, documentId } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        
        // CẦN THAY THẾ: UID Của tài khoản Google dùng làm Admin
        const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1"; 
        // CẦN THAY THẾ: UID Của tài khoản Google dùng làm Phó Admin (Hoặc để rỗng "" nếu không có)
        const SUB_ADMIN_UID = "PdJ4lfvT4sgV82Pvjjg4krFboqp1"; // THAY THẾ BẰNG UID THẬT!
        
        // UTILITY: Kiểm tra quyền Admin/SubAdmin
        const isAdmin = (user) => user && (user.uid === ADMIN_UID || user.uid === SUB_ADMIN_UID);

        const ORDER_RENDER_LIMIT = 50; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let services = [];
        let bookingData = {}; 
        let allAdminOrders = []; // Global storage for Admin orders for filtering/stats

        // 1. AUTH & SETUP
        window.login = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).then(res => {
                setDoc(doc(db, "users", res.user.uid), { 
                    email: res.user.email, name: res.user.displayName 
                }, { merge: true });
                showToast("Đăng nhập thành công");
            }).catch(err => alert(err.message));
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, user => {
            currentUser = user;
            document.getElementById('loader').style.display = 'none';
            
            if(user) {
                // Desktop
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('userAvatar').style.display = 'block';
                // Mobile
                document.getElementById('loginBtnMobile').style.display = 'none';
                document.getElementById('logoutBtnMobile').style.display = 'block';

                document.getElementById('menuDash').style.display = 'block';
                
                // Initialize admin-only data loading if user is admin/sub-admin
                if(isAdmin(user)) {
                    document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
                } else {
                    document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
                }
            } else {
                goHome();
                // Desktop
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('userAvatar').style.display = 'none';
                // Mobile
                document.getElementById('loginBtnMobile').style.display = 'block';
                document.getElementById('logoutBtnMobile').style.display = 'none';

                document.getElementById('menuDash').style.display = 'none';
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
            }
        });

        // MOBILE MENU TOGGLE
        window.toggleMenu = (force) => {
            const nav = document.getElementById('mainNav');
            const isMobile = window.matchMedia("(max-width: 768px)").matches;
            
            if (!isMobile && force === undefined) return;
            
            if (force === true) nav.classList.add('open');
            else if (force === false) nav.classList.remove('open');
            else nav.classList.toggle('open');
        };


        // 3. SERVICE DISPLAY & LOGIC
        async function loadServices() {
            try {
                const q = query(collection(db, "services"));
                const snap = await getDocs(q);
                services = [];
                snap.forEach(d => services.push({id: d.id, ...d.data()}));
                
                renderServices();
                if(isAdmin(currentUser)) renderAdminServices();
            } catch (e) {
                 showToast("Lỗi tải dịch vụ: " + e.message);
                 console.error("Lỗi tải dịch vụ:", e);
            }
        }
        
        function renderServices() {
            const grid = document.getElementById('servicesGrid');
            if (!grid) return; 
            grid.innerHTML = services.map(s => `
                <div class="service-card">
                    <div class="svc-header">
                        <h3>${s.name}</h3>
                        <div class="svc-price">${fmt(s.price)}</div> 
                    </div>
                    <p class="svc-desc">${s.desc || 'Chưa có mô tả'}</p>
                    
                    ${(s.options && s.options.length > 0) ? `
                        <div class="option-group">
                            <p style="font-size:0.8rem; font-weight:600; margin-bottom:10px">Bao gồm:</p>
                            ${s.options.map(opt => `
                                <div class="option-row">
                                    <label style="cursor:default; color:var(--text-primary);">${opt.name}</label>
                                    <span style="font-weight:400">${fmt(opt.price)}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div class="option-group"><p style="font-size:0.8rem; color:var(--text-secondary)">Không có tùy chọn thêm.</p></div>'}

                    <button class="btn btn-fill" style="width:100%; margin-top:20px" onclick="openBooking('${s.id}')">Đăng ký gói này</button>
                    ${isAdmin(currentUser) ? `<button class="btn btn-sm" style="margin-top:10px" onclick="openEditSvc('${s.id}')">Sửa (Admin)</button>` : ''}
                </div>
            `).join('');
        }
        
        // 4. BOOKING 
        window.openBooking = (id) => {
            if(!currentUser) return login();
            const svc = services.find(s => s.id === id);
            if (!svc) return;

            let total = svc.price; 
            let opts = svc.options || []; 

            bookingData = { svcName: svc.name, opts, total };
            
            document.getElementById('bookingSummary').innerHTML = `
                <p><strong>Gói:</strong> ${svc.name}</p>
                <p><strong>Options:</strong> ${opts.map(o=>o.name).join(', ') || 'Không'}</p>
                <p style="font-size:1.2rem; margin-top:10px; color:var(--accent)"><strong>Tổng cộng: ${fmt(total)}</strong></p>
            `;
            // Reset fields
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('shootDate').value = today;
            document.getElementById('shootDate').min = today;
            document.getElementById('shootTime').value = '09:00'; 
            document.getElementById('shootLocation').value = '';
            document.getElementById('userPhone').value = '';
            
            document.getElementById('bookingModal').style.display = 'flex';
        };

        window.submitBooking = async () => {
            const phone = document.getElementById('userPhone').value;
            const date = document.getElementById('shootDate').value;
            const time = document.getElementById('shootTime').value; 
            const location = document.getElementById('shootLocation').value;
            
            if(!phone || !date || !time || !location) return alert("Vui lòng nhập đầy đủ Số điện thoại, Ngày chụp, Giờ chụp và Địa điểm");
            
            document.getElementById('bookingModal').style.display = 'none';
            showLoader(true);
            
            try {
                await addDoc(collection(db, "orders"), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    phone: phone,
                    date: date,
                    time: time, 
                    location: location,
                    ...bookingData,
                    status: "Chờ xác nhận",
                    createdAt: new Date(),
                    deliveryLink: "",
                    deliveryPass: ""
                });
                showToast("Đã gửi yêu cầu đặt lịch!");
                loadMyOrders(); 
            } catch(e) { 
                alert("Lỗi khi gửi đơn hàng: " + e.message); 
                console.error("Lỗi khi gửi đơn hàng:", e);
            }
            showLoader(false);
        };

        // 5. CLIENT ORDER MANAGEMENT
        async function loadMyOrders() {
            if(!currentUser) {
                 document.querySelector('#tab-my-orders tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;">Vui lòng Đăng nhập để xem đơn hàng của bạn.</td></tr>';
                 return;
            }
            showLoader(true);
            
            try {
                // LƯU Ý: Query này BẮT BUỘC cần Composite Index: uid (Asc), createdAt (Desc)
                const q = query(collection(db, "orders"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
                const snaps = await getDocs(q);
                const tbody = document.querySelector('#myOrdersTable tbody');
                tbody.innerHTML = '';
                
                if(snaps.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Bạn chưa có đơn hàng nào.</td></tr>';
                } else {
                    snaps.forEach(d => {
                        const data = d.data();
                        const isDone = data.status === "Hoàn thành";
                        const dateOrder = data.createdAt?.toDate().toLocaleDateString('vi-VN') || 'N/A';
                        const statusClass = data.status.includes('Chờ') ? 'badge-pending' : (data.status.includes('Hoàn thành') ? 'badge-completed' : (data.status.includes('Đã hủy') ? 'badge-cancelled' : 'badge-deposit'));

                        tbody.innerHTML += `
                            <tr>
                                <td data-label="Ngày đặt">${dateOrder}</td>
                                <td data-label="Ngày/Giờ chụp">${data.date} ${data.time || ''}</td>
                                <td data-label="Gói">${data.svcName}</td>
                                <td data-label="Địa điểm">${data.location}</td>
                                <td data-label="Tổng tiền">${fmt(data.total)}</td>
                                <td data-label="Trạng thái"><span class="badge ${statusClass}">${data.status}</span></td>
                                <td data-label="Kết quả">
                                    ${isDone && data.deliveryLink ? `<button class="btn btn-sm btn-fill" onclick="viewResult('${d.id}')">NHẬN ẢNH</button>` : '---'}
                                </td>
                            </tr>
                        `;
                    });
                }
            } catch (e) {
                // Hiển thị thông báo lỗi Index yêu cầu người dùng kiểm tra Console
                showToast("LỖI TẢI ĐƠN HÀNG CÁ NHÂN! Vui lòng kiểm tra Console (F12) để tạo Index.");
                console.error("Lỗi khi tải đơn hàng của Client (INDEX ERROR):", e);
                document.querySelector('#tab-my-orders tbody').innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--danger);">LỖI TẢI ĐƠN HÀNG. Vui lòng kiểm tra Console (F12) để lấy link tạo Index.</td></tr>';
            }
            showLoader(false);
        }
        
        window.viewResult = async (id) => {
            showLoader(true);
            try {
                const orderSnap = await getDoc(doc(db, "orders", id));
                const data = orderSnap.data();
                
                document.getElementById('resLink').href = data.deliveryLink || '#';
                document.getElementById('resPass').innerText = data.deliveryPass || "Không có";
                document.getElementById('resultModal').style.display = 'flex';
            } catch (e) {
                showToast("Lỗi khi tải kết quả: " + e.message);
                console.error("Lỗi tải kết quả:", e);
            }
            showLoader(false);
        }

        // TỐI ƯU HIỆU SUẤT: CHỈ RENDER SỐ LƯỢNG GIỚI HẠN MẶC ĐỊNH
        function renderAdminTableBody(orders, count) {
            const tbody = document.querySelector('#adminOrdersTable tbody');
            tbody.innerHTML = '';
            
            // Limit rendering to the specified count
            const ordersToRender = orders.slice(0, count);

            if(ordersToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Không tìm thấy đơn hàng nào.</td></tr>';
            } else {
                ordersToRender.forEach(d => {
                    const statusClass = d.status.includes('Chờ') ? 'badge-pending' : (d.status.includes('Hoàn thành') ? 'badge-completed' : (d.status.includes('Đã hủy') ? 'badge-cancelled' : 'badge-deposit'));
                    
                    tbody.innerHTML += `
                        <tr>
                            <td data-label="Khách">${d.email}</td>
                            <td data-label="SĐT">${d.phone}</td>
                            <td data-label="Ngày/Giờ chụp">${d.date} ${d.time || ''}</td>
                            <td data-label="Địa điểm">${d.location}</td>
                            <td data-label="Gói">${d.svcName}</td>
                            <td data-label="Tổng">${fmt(d.total)}</td>
                            <td data-label="Trạng thái">
                                <select onchange="updateStatus('${d.id}', this.value)" style="padding:5px; border-radius:var(--radius); border-color:var(--border);" data-original-status="${d.status}">
                                    <option value="Chờ xác nhận" ${d.status=='Chờ xác nhận'?'selected':''}>Chờ xác nhận</option>
                                    <option value="Đã cọc" ${d.status=='Đã cọc'?'selected':''}>Đã cọc</option>
                                    <option value="Hoàn thành" ${d.status=='Hoàn thành'?'selected':''}>Hoàn thành</option>
                                    <option value="Đã hủy" ${d.status=='Đã hủy'?'selected':''}>Đã hủy</option>
                                </select>
                            </td>
                            <td data-label="Hành động">
                                 <button class="btn btn-sm" onclick="openDeliver('${d.id}', '${d.deliveryLink||''}', '${d.deliveryPass||''}')">Trả Ảnh</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            // Add Load All button logic
            const adminOrdersContainer = document.getElementById('tab-admin-orders');
            let loadAllBtn = document.getElementById('loadAllOrdersBtn');
            if (loadAllBtn) loadAllBtn.remove(); // Remove previous button

            if (orders.length > count) {
                loadAllBtn = document.createElement('button');
                loadAllBtn.id = 'loadAllOrdersBtn';
                loadAllBtn.className = 'btn btn-sm';
                loadAllBtn.style = 'margin-top: 20px;';
                loadAllBtn.innerText = `Hiển thị tất cả ${orders.length} đơn hàng... (Hiện chỉ hiển thị ${count} đơn)`;
                loadAllBtn.onclick = () => {
                    renderAdminTableBody(orders, orders.length);
                    loadAllBtn.remove(); // Remove button after clicking
                }
                adminOrdersContainer.appendChild(loadAllBtn);
            }
        }

        // 6. ADMIN MANAGEMENT
        // 6a. Orders & Delivery
        window.loadAdminOrders = async () => {
            if(!isAdmin(currentUser)) return;
            showLoader(true);

            try {
                // Get filter values
                const searchVal = document.getElementById('orderSearch').value.toLowerCase();
                const filterStatus = document.getElementById('orderFilterStatus').value;

                // Fetch ALL orders for client-side filtering and stats calculation
                const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q); 
                allAdminOrders = [];
                snap.forEach(d => allAdminOrders.push({id: d.id, ...d.data()}));
                
                // Apply filtering (client-side filtering)
                const filteredOrders = allAdminOrders.filter(d => {
                    const searchMatch = !searchVal || 
                        (d.email && d.email.toLowerCase().includes(searchVal)) || 
                        (d.phone && d.phone.includes(searchVal)) || 
                        (d.location && d.location.toLowerCase().includes(searchVal));
                    
                    const statusMatch = !filterStatus || d.status === filterStatus;
                    
                    return searchMatch && statusMatch;
                });

                // Update Stats based on ALL orders
                updateAdminStats(allAdminOrders);

                // RENDER ONLY THE LIMITED SET (Tối ưu hóa hiệu suất)
                renderAdminTableBody(filteredOrders, ORDER_RENDER_LIMIT);
            } catch (e) {
                showToast("LỖI TẢI DỮ LIỆU ĐƠN HÀNG! Vui lòng kiểm tra Console (F12) để xem lỗi.");
                console.error("LỖI TẢI DỮ LIỆU ĐƠN HÀNG:", e);
                document.querySelector('#adminOrdersTable tbody').innerHTML = '<tr><td colspan="8" style="text-align:center; color: var(--danger);">LỖI TẢI DỮ LIỆU ĐƠN HÀNG. Vui lòng kiểm tra Console (F12) để xem lỗi chi tiết.</td></tr>';
            }
            
            showLoader(false); // CRITICAL: Đảm bảo loader ẩn sau khi hàm chạy xong/gặp lỗi
        };

        function updateAdminStats(orders) {
            const total = orders.length;
            const pending = orders.filter(o => o.status === 'Chờ xác nhận').length;
            const deposit = orders.filter(o => o.status === 'Đã cọc').length;
            const completed = orders.filter(o => o.status === 'Hoàn thành').length;
            const cancelled = orders.filter(o => o.status === 'Đã hủy').length;

            const totalActive = total - cancelled;
            const rate = totalActive > 0 ? ((completed / totalActive) * 100).toFixed(1) : 0; 

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statDeposit').innerText = deposit;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statCompleteRate').innerText = `${rate}%`;
        }

        // Sửa hàm này để bắt Modal nhập link khi chuyển trạng thái sang "Hoàn thành"
        window.updateStatus = async (id, newStatus) => {
            if(!isAdmin(currentUser)) return showToast("Bạn không có quyền admin");
            
            let currentStatus = '';
            const selectEl = document.querySelector(`#adminOrdersTable tbody tr td select[onchange*="${id}"]`);
            if (selectEl) currentStatus = selectEl.dataset.originalStatus; 

            // Nếu chuyển sang Hoàn thành, MỞ MODAL để nhập link ảnh
            if (newStatus === 'Hoàn thành' && currentStatus !== 'Hoàn thành') {
                const orderSnap = await getDoc(doc(db, "orders", id));
                const order = orderSnap.data();
                
                // Mở Modal Deliver để nhập Link/Pass
                openDeliver(id, order.deliveryLink || '', order.deliveryPass || '', currentStatus);
                // Giữ nguyên trạng thái cũ trên select box cho đến khi submit thành công
                if (selectEl) selectEl.value = currentStatus; 
                return;
            }

            // Xử lý các trạng thái khác (Chờ xác nhận, Đã cọc, Đã hủy)
            showLoader(true);
            let proceed = true;

            try {
                const isApproved = ['Đã cọc', 'Hoàn thành'].includes(newStatus);

                if (isApproved && newStatus === 'Đã cọc') {
                    const orderSnap = await getDoc(doc(db, "orders", id));
                    const order = orderSnap.data();

                    // LƯU Ý: Query này BẮT BUỘC cần Composite Index: date (Asc), location (Asc), time (Asc), status (Asc)
                    const conflictQuery = query(
                        collection(db, "orders"), 
                        where("date", "==", order.date),
                        where("location", "==", order.location),
                        where("time", "==", order.time), 
                        where("status", "in", ["Đã cọc", "Hoàn thành"]),
                        where(documentId(), "!=", id) 
                    );
                    
                    const conflictSnaps = await getDocs(conflictQuery);

                    if (conflictSnaps.size > 0) {
                        const msg = `CẢNH BÁO: Lịch ngày ${order.date} lúc ${order.time} tại ${order.location} đã TRÙNG với ${conflictSnaps.size} đơn hàng đã duyệt/hoàn thành. Bạn có muốn duyệt không?`;
                        if (!confirm(msg)) {
                            showToast("Hủy duyệt do trùng lịch");
                            if (selectEl) selectEl.value = currentStatus;
                            proceed = false;
                        }
                    }
                }

                if (proceed) {
                    await updateDoc(doc(db, "orders", id), {status: newStatus});
                    showToast(`Đã cập nhật trạng thái đơn hàng sang: ${newStatus}`);
                }
                
                loadAdminOrders();
                renderAdminSchedule(); 

            } catch(e) { 
                alert("LỖI KHI CẬP NHẬT HOẶC CHECK TRÙNG LỊCH. Vui lòng kiểm tra Console (F12) để lấy link tạo Index."); 
                console.error("LỖI CẬP NHẬT TRẠNG THÁI/CHECK CONFLICT:", e);
                showToast("Lỗi: Không thể cập nhật trạng thái.");
                if (selectEl) selectEl.value = currentStatus;
            }
            showLoader(false);
        };
        
        // Modal Deliver
        window.openDeliver = (id, link, pass, originalStatus) => {
             document.getElementById('deliverOrderId').value = id;
             document.getElementById('jobLink').value = link;
             document.getElementById('jobPass').value = pass;
             document.getElementById('deliverOrderOriginalStatus').value = originalStatus;
             document.getElementById('deliverModal').style.display = 'flex';
        }
        
        window.submitDelivery = async () => {
            const id = document.getElementById('deliverOrderId').value;
            const link = document.getElementById('jobLink').value;
            const pass = document.getElementById('jobPass').value;
            const originalStatus = document.getElementById('deliverOrderOriginalStatus').value;
            
            if(!link) return alert("Vui lòng nhập link trả ảnh");

            showLoader(true);
            try {
                // Cập nhật link/pass và chuyển trạng thái sang Hoàn thành
                await updateDoc(doc(db, "orders", id), {
                    deliveryLink: link,
                    deliveryPass: pass,
                    status: "Hoàn thành" 
                });
                showToast("Đã trả ảnh và chuyển trạng thái sang Hoàn thành");
                closeModal('deliverModal');
                
                // Cập nhật lại select box trên bảng
                const selectEl = document.querySelector(`#adminOrdersTable tbody tr td select[onchange*="${id}"]`);
                if (selectEl) selectEl.value = "Hoàn thành";
                
                loadAdminOrders();
                renderAdminSchedule();
            } catch(e) {
                 alert("Lỗi khi trả ảnh: " + e.message);
                 console.error("Lỗi khi trả ảnh:", e);
            }
            showLoader(false);
        }

        // 6b. Services CRUD 
        window.renderAdminServices = () => {
             if(!isAdmin(currentUser)) return;
             const div = document.getElementById('adminServicesList');
             if (!div) return;
             div.innerHTML = services.map(s => `
                <div class="service-card" style="min-width: unset; flex-shrink: unset;">
                    <div class="svc-header">
                        <h3>${s.name}</h3>
                        <div class="svc-price">${fmt(s.price)}</div>
                    </div>
                    <p class="svc-desc">${s.desc || 'Chưa có mô tả'}</p>
                    <p style="font-size:0.8rem; color:var(--text-secondary)">Options: ${s.options?.length || 0}</p>
                    <div style="margin-top:15px; display:flex; gap:10px">
                        <button class="btn btn-sm btn-fill" onclick="openEditSvc('${s.id}')">Sửa</button>
                        <button class="btn btn-sm btn-danger" onclick="delSvc('${s.id}')">Xóa</button>
                    </div>
                </div>
             `).join('');
        };
        
        // --- Service CRUD Helper Functions ---
        window.openServiceModal = () => {
            if(!isAdmin(currentUser)) return;
             document.getElementById('svcModalTitle').innerText = 'Tạo gói mới';
             document.getElementById('editSvcId').value = '';
             document.getElementById('svcName').value = '';
             document.getElementById('svcPrice').value = 0;
             document.getElementById('svcDesc').value = '';
             document.getElementById('optContainer').innerHTML = '';
             document.getElementById('svcModal').style.display = 'flex';
        }

        window.openEditSvc = (id) => {
            if(!isAdmin(currentUser)) return;
            const svc = services.find(s => s.id === id);
            if (!svc) return;

            document.getElementById('svcModalTitle').innerText = 'Sửa gói: ' + svc.name;
            document.getElementById('editSvcId').value = id;
            document.getElementById('svcName').value = svc.name;
            document.getElementById('svcPrice').value = svc.price;
            document.getElementById('svcDesc').value = svc.desc || '';
            document.getElementById('optContainer').innerHTML = '';

            svc.options?.forEach(opt => addOptionRow(opt.name, opt.price));
            
            document.getElementById('svcModal').style.display = 'flex';
        }

        window.addOptionRow = (name = '', price = 0) => {
            if(!isAdmin(currentUser)) return;
            const container = document.getElementById('optContainer');
            const newRow = document.createElement('div');
            newRow.style.display = 'flex';
            newRow.style.gap = '10px';
            newRow.style.marginBottom = '10px';
            newRow.innerHTML = `
                <input type="text" placeholder="Tên tùy chọn" value="${name}" style="flex: 2;">
                <input type="number" placeholder="Giá (VND)" value="${price}" style="flex: 1;">
                <button class="btn btn-sm btn-danger" onclick="this.parentNode.remove()" style="flex: 0 0 50px;">Xóa</button>
            `;
            container.appendChild(newRow);
        }

        window.saveService = async () => {
            if(!isAdmin(currentUser)) return;
            const id = document.getElementById('editSvcId').value;
            const name = document.getElementById('svcName').value;
            const price = parseInt(document.getElementById('svcPrice').value || 0);
            const desc = document.getElementById('svcDesc').value;
            
            const optRows = document.getElementById('optContainer').querySelectorAll('div');
            const options = Array.from(optRows).map(row => ({
                name: row.querySelector('input[type="text"]').value,
                price: parseInt(row.querySelector('input[type="number"]').value || 0)
            })).filter(o => o.name && o.price > 0);

            if(!name || price <= 0) return alert("Vui lòng nhập Tên gói và Giá hợp lệ.");

            showLoader(true);
            const data = { name, price, desc, options };

            try {
                if(id) {
                    await updateDoc(doc(db, "services", id), data);
                } else {
                    await addDoc(collection(db, "services"), data);
                }
                showToast("Đã lưu gói dịch vụ!");
                closeModal('svcModal');
                await loadServices();
            } catch(e) { 
                alert("Lỗi khi lưu gói dịch vụ: " + e.message); 
                console.error("Lỗi khi lưu gói dịch vụ:", e);
            }
            showLoader(false);
        }

        window.delSvc = async (id) => {
            if(!isAdmin(currentUser)) return;
            if(!confirm("Bạn có chắc chắn muốn xóa gói dịch vụ này?")) return;
            showLoader(true);
            try {
                await deleteDoc(doc(db, "services", id));
                showToast("Đã xóa gói dịch vụ!");
                await loadServices();
            } catch(e) { 
                alert("Lỗi khi xóa gói dịch vụ: " + e.message); 
                console.error("Lỗi khi xóa gói dịch vụ:", e);
            }
            showLoader(false);
        }

        // 6c. Admin Schedule View (NEW)
        window.renderAdminSchedule = async () => {
            if(!isAdmin(currentUser)) return;
            const date = document.getElementById('scheduleDateFilter').value;
            const list = document.getElementById('adminScheduleList');
            
            if(!list || !date) {
                list.innerHTML = '<p>Vui lòng chọn ngày để xem lịch chụp đã được duyệt (Đã cọc/Hoàn thành).</p>';
                return;
            }
            
            showLoader(true);

            try {
                // LƯU Ý: Query này BẮT BUỘC cần Composite Index: date (Asc), status (Asc), time (Asc)
                const q = query(
                    collection(db, "orders"), 
                    where("date", "==", date),
                    where("status", "in", ["Đã cọc", "Hoàn thành"]),
                    orderBy("time", "asc")
                );
                
                const snaps = await getDocs(q);
                
                if(snaps.empty) {
                    list.innerHTML = `<p style="color:var(--success)">Tuyệt vời! Ngày ${date} không có lịch chụp đã được duyệt nào.</p>`;
                } else {
                    list.innerHTML = snaps.docs.map(doc => {
                        const d = doc.data();
                        return `
                            <div style="padding:15px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg-secondary); display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <h4 style="margin-bottom:5px; color:var(--accent)">${d.time} - ${d.svcName}</h4>
                                    <p style="font-size:0.9rem; color:var(--text-secondary)">Địa điểm: ${d.location}</p>
                                    <p style="font-size:0.9rem;">Khách: ${d.email} | SĐT: ${d.phone}</p>
                                </div>
                                <span class="badge ${d.status=='Hoàn thành'?'badge-completed':'badge-deposit'}">${d.status}</span>
                            </div>
                        `;
                    }).join('');
                }
            } catch(e) {
                 showToast("LỖI TẢI LỊCH CHỤP! Vui lòng kiểm tra Console (F12) để lấy link tạo Index.");
                 console.error("LỖI TẢI LỊCH CHỤP (INDEX ERROR):", e);
                 list.innerHTML = `<p style="color:var(--danger);">LỖI TẢI LỊCH CHỤP. Vui lòng kiểm tra Console (F12) để xem thông báo lỗi Index.</p>`;
            }
            showLoader(false); // CRITICAL: Đảm bảo loader ẩn sau khi hàm chạy xong/gặp lỗi
        };


        // GENERAL UI
        window.goHome = () => {
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
        };
        
        window.goDash = () => {
            if(!currentUser) return login();
            
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            
            if(isAdmin(currentUser)) {
                // Admin default: Quản lý Đơn
                switchTab('admin-orders', document.getElementById('tabBtn-admin-orders'));
                // Set default date for schedule tab
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('scheduleDateFilter').value = today;
            } else {
                // Client default: Đơn của tôi
                switchTab('my-orders', document.getElementById('tabBtn-my-orders'));
            }
        };

        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            const targetContent = document.getElementById('tab-' + tabId);
            if (targetContent) targetContent.style.display = 'block';
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            // Logic to load data based on tab
            if(tabId === 'admin-orders') loadAdminOrders();
            if(tabId === 'my-orders') loadMyOrders();
            if(tabId === 'admin-services') renderAdminServices();
            if(tabId === 'admin-schedule') renderAdminSchedule();
        };

        window.closeModal = (id) => {
            // Revert the status dropdown in case the user closes the deliver modal
            if (id === 'deliverModal') {
                const orderId = document.getElementById('deliverOrderId').value;
                const originalStatus = document.getElementById('deliverOrderOriginalStatus').value;
                const selectEl = document.querySelector(`#adminOrdersTable tbody tr td select[onchange*="${orderId}"]`);
                if (selectEl) selectEl.value = originalStatus;
            }
            document.getElementById(id).style.display = 'none';
        }
        
        window.showLoader = (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none';
        
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 3000);
        };
        
        function fmt(n) { return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(n); }
        
        window.addEventListener('scroll', () => {
            const h = document.getElementById('mainHeader');
            if(window.scrollY > 50) h.classList.add('scrolled');
            else h.classList.remove('scrolled');
        });
        
        // Add event listeners to search/filter inputs for instant filtering (after a small delay for input)
        document.getElementById('orderSearch')?.addEventListener('input', () => {
            clearTimeout(window.searchTimer);
            window.searchTimer = setTimeout(loadAdminOrders, 300);
        });
        document.getElementById('orderFilterStatus')?.addEventListener('change', loadAdminOrders);


        // INIT
        loadServices();

    </script>
</body>
</html>
