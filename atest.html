<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUX STUDIO | Minimalist Photography Portfolio</title>
    
    <!-- Fonts: Playfair Display (Tiêu đề sang trọng) & Inter (Nội dung hiện đại) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #ffffff;
            --bg-secondary: #f9f9f9;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #222222; /* Màu đen sang trọng */
            --accent-hover: #000000;
            --border: #e0e0e0;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --success: #27ae60;
            --danger: #c0392b;
            --font-main: 'Inter', sans-serif;
            --font-title: 'Playfair Display', serif;
            --radius: 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-main);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* --- UTILITY & LAYOUT --- */
        .section-padding { padding: 60px 0; }
        .section-title {
            font-family: var(--font-title);
            font-size: 3rem;
            font-weight: 400;
            text-align: center;
            margin-bottom: 50px;
        }
        /* MODIFIED: Horizontal Scrolling Services */
        .services-grid {
            display: flex;
            overflow-x: auto;
            gap: 30px;
            padding-bottom: 20px; /* Add padding for scrollbar visibility */
            /* Hide the scrollbar for aesthetic purposes, but allow scrolling */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .services-grid::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* --- SERVICE CARD --- */
        .service-card {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 30px;
            transition: box-shadow 0.3s ease;
            min-width: 320px; /* Ensure cards have a minimum width */
            flex-shrink: 0; /* Important for horizontal scrolling */
        }
        .service-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        .svc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .svc-header h3 {
            font-family: var(--font-main);
            font-size: 1.4rem;
            font-weight: 600;
        }
        .svc-price {
            font-family: var(--font-title);
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--accent);
        }
        .svc-desc {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .option-group {
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }
        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 0.9rem;
        }
        .option-row label {
            cursor: pointer;
            color: var(--text-secondary);
        }
        .option-row span {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* --- BADGES (STATUS) --- */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        .badge-pending {
            background: #fdf5e6; /* light yellow */
            color: #cc9900;
        }
        .badge-deposit {
            background: #e6f7ff; /* light blue */
            color: #1890ff;
        }
        .badge-completed {
            background: #f6ffed; /* light green */
            color: var(--success);
        }
        .badge-cancelled {
            background: #fbebeb; /* light red */
            color: var(--danger);
        }

        /* --- MARQUEE --- */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            width: 100%;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            margin: 40px 0;
        }
        .marquee-content {
            display: inline-block;
            animation: marquee 40s linear infinite;
            padding-right: 10px; /* Space between duplicated sets */
        }
        .marquee-content img {
            height: 250px; /* Standardize image height */
            width: auto;
            object-fit: cover;
            margin-right: 10px;
            vertical-align: middle;
            border-radius: var(--radius);
        }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); } /* Move half of the content width */
        }

        /* --- UI ELEMENTS: BUTTONS, FORMS, LAYOUTS --- */
        .btn {
            padding: 12px 25px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.85rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            font-weight: 500;
            border-radius: var(--radius);
        }

        .btn:hover {
            background: var(--accent-hover);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-fill { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-fill:hover { background: var(--accent-hover); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }

        .btn-sm { padding: 8px 15px; font-size: 0.75rem; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* --- HEADER --- */
        header {
            padding: 20px 40px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(8px);
            z-index: 1000;
            border-bottom: 1px solid transparent;
            transition: 0.3s;
        }
        header.scrolled { border-bottom: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .logo {
            font-family: var(--font-title);
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        nav { display: block; } /* Default: visible on desktop */
        nav ul { display: flex; gap: 40px; list-style: none; }
        nav a { text-decoration: none; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; transition: color 0.3s; }
        nav a:hover { color: var(--text-secondary); }

        .auth-area { display: flex; align-items: center; gap: 15px; }
        #userAvatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; display: none; }
        #menuToggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--accent); } /* Mobile Only */


        /* --- HERO & DASHBOARD --- */
        /* ... (Hero styles unchanged) ... */
        
        /* TAB BAR CHUYÊN NGHIỆP */
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .tab { 
            padding: 10px 15px; 
            cursor: pointer; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent; 
            transition: all 0.2s ease-in-out; 
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        .tab.active { 
            color: var(--accent); 
            border-bottom-color: var(--accent); 
            font-weight: 600; 
        }
        .tab:hover { 
            color: var(--accent); 
            background: var(--bg-secondary);
        }

        /* ... (Table styles unchanged) ... */
        
        /* Form Inputs */
        .form-group input, .form-group textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            font-family: var(--font-main);
            font-size: 1rem;
            transition: all 0.2s;
            border-radius: var(--radius);
        }
        .form-group input:focus, .form-group textarea:focus, select:focus {
             box-shadow: 0 0 0 2px rgba(34, 34, 34, 0.1);
        }

        /* ... (Modal, Loader, Toast styles unchanged) ... */


        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            /* ... (existing mobile styles) ... */

            /* Admin Stats on mobile */
            #adminStats > div { flex: 1 1 100%; }
        }
    </style>
</head>
<body>

    <!-- UTILS -->
    <div id="loader" style="display:none"><div class="spinner"></div></div>
    <div id="toast">Thông báo</div>

    <!-- HEADER -->
    <header id="mainHeader">
        <div class="logo">LUX STUDIO.</div>
        <!-- Thêm nút Hamburger Menu cho mobile -->
        <button id="menuToggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

        <nav id="mainNav">
            <ul>
                <li><a href="#" onclick="goHome(); toggleMenu(false)">Portfolio</a></li>
                <li><a href="#services" onclick="toggleMenu(false)">Dịch vụ</a></li>
                <li><a href="#" id="menuDash" style="display:none" onclick="goDash(); toggleMenu(false)">Quản lý</a></li>
            </ul>
        </nav>
        <div class="auth-area">
            <button id="loginBtn" class="btn" onclick="login()">Đăng nhập</button>
            <img id="userAvatar" src="" alt="User">
            <button id="logoutBtn" class="btn btn-sm" style="display:none; border:none;" onclick="logout()">Thoát</button>
        </div>
    </header>

    <!-- MAIN PAGE -->
    <main id="mainPage">
        <!-- Hero -->
        <section class="hero">
            <h1>Chụp ảnh là<br>kể chuyện bằng ánh sáng</h1>
            <p>Ghi lại những khoảnh khắc chân thực, tinh tế và đầy cảm xúc của bạn. Chúng tôi mang đến trải nghiệm chụp ảnh studio và ngoại cảnh chuyên nghiệp, đẳng cấp.</p>
            <a href="#services" class="btn btn-fill">Đặt lịch ngay</a>
        </section>

        <!-- Marquee Gallery -->
        <div class="marquee-container">
            <div class="marquee-content">
                <!-- Duplicate images to create infinite loop effect -->
                <img src="https://images.unsplash.com/photo-1511285560982-1356c11d4606?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1519741497674-611481863552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1520390138845-fd2d229dd552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=600&q=80">
                <!-- Repeat set -->
                <img src="https://images.unsplash.com/photo-1511285560982-1356c11d4606?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1519741497674-611481863552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1520390138845-fd2d229dd552?w=600&q=80">
                <img src="https://images.unsplash.com/photo-1469334031218-e382a71b716b?w=600&q=80">
            </div>
        </div>

        <!-- Services (Horizontal Scroll) -->
        <section id="services" class="container section-padding">
            <h2 class="section-title">Gói chụp (Services)</h2>
            <div id="servicesGrid" class="services-grid">
                <!-- JS render -->
            </div>
        </section>
    </main>

    <!-- DASHBOARD -->
    <section id="dashboardSection" style="display:none">
        <div class="dash-container">
            <h2 class="section-title" style="text-align:left; font-size: 2rem;">Khu vực quản lý</h2>
            
            <div id="dashTabs" class="tabs">
                <div class="tab" id="tabBtn-my-orders" onclick="switchTab('my-orders', this)">Đơn của tôi</div>
                <div class="tab admin-only" id="tabBtn-admin-orders" style="display:none" onclick="switchTab('admin-orders', this)">Quản lý Đơn (Admin)</div>
                <div class="tab admin-only" id="tabBtn-admin-schedule" style="display:none" onclick="switchTab('admin-schedule', this)">Lịch chụp (Admin)</div>
                <div class="tab admin-only" id="tabBtn-admin-services" style="display:none" onclick="switchTab('admin-services', this)">Quản lý Gói (Admin)</div>
            </div>

            <!-- Client: My Orders -->
            <div id="tab-my-orders" class="tab-content" style="display:none">
                <div class="table-wrap">
                    <table id="myOrdersTable">
                        <thead><tr><th>Ngày đặt</th><th>Ngày/Giờ chụp</th><th>Gói</th><th>Địa điểm</th><th>Tổng tiền</th><th>Trạng thái</th><th>Kết quả</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Admin: All Orders (Updated with Search/Stats) -->
            <div id="tab-admin-orders" class="tab-content" style="display:none">
                 <!-- ADMIN STATS -->
                <div id="adminStats" style="display:flex; gap:20px; margin-bottom: 30px; flex-wrap:wrap;">
                    <div style="flex:1; padding:15px; border-left:4px solid #27ae60; background:#f6ffed; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Tổng đơn</p><h3 id="statTotal">0</h3>
                    </div>
                    <div style="flex:1; padding:15px; border-left:4px solid #1890ff; background:#e6f7ff; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Đơn Đã cọc</p><h3 id="statDeposit">0</h3>
                    </div>
                    <div style="flex:1; padding:15px; border-left:4px solid #cc9900; background:#fdf5e6; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Chờ xác nhận</p><h3 id="statPending">0</h3>
                    </div>
                    <div style="flex:1; padding:15px; border-left:4px solid #c0392b; background:#fbebeb; border-radius:var(--radius);">
                        <p style="font-size:0.8rem; color:#666">Tỷ lệ HT</p><h3 id="statCompleteRate">0%</h3>
                    </div>
                </div>

                <!-- ADMIN SEARCH/FILTER -->
                <div style="display:flex; gap:10px; margin-bottom: 20px; flex-wrap:wrap;">
                    <input type="text" id="orderSearch" placeholder="Tìm theo Khách/SĐT/Địa điểm" style="flex: 2; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius);">
                    <select id="orderFilterStatus" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius);">
                        <option value="">-- Tất cả Trạng thái --</option>
                        <option value="Chờ xác nhận">Chờ xác nhận</option>
                        <option value="Đã cọc">Đã cọc</option>
                        <option value="Hoàn thành">Hoàn thành</option>
                        <option value="Đã hủy">Đã hủy</option>
                    </select>
                    <button class="btn btn-fill" onclick="loadAdminOrders()">Tìm kiếm</button>
                </div>

                <div class="table-wrap">
                    <table id="adminOrdersTable">
                        <thead><tr><th>Khách</th><th>SĐT</th><th>Ngày/Giờ chụp</th><th>Địa điểm</th><th>Gói</th><th>Tổng</th><th>Trạng thái</th><th>Hành động</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Admin: Schedule View (Simple List for time being) -->
            <div id="tab-admin-schedule" class="tab-content" style="display:none">
                <h3 style="margin-bottom:10px">Lịch Chụp Đã Duyệt (Đã cọc/Hoàn thành)</h3>
                <input type="date" id="scheduleDateFilter" onchange="renderAdminSchedule()" style="padding:10px; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom:20px;">
                <div id="adminScheduleList" style="display:grid; gap:15px">
                    <p>Chọn ngày để xem lịch chụp.</p>
                </div>
            </div>

            <!-- Admin: Service Management (Updated Layout) -->
            <div id="tab-admin-services" class="tab-content" style="display:none">
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:20px;">
                    <h3>Danh sách gói dịch vụ</h3>
                    <button class="btn btn-fill" onclick="openServiceModal()">+ Tạo gói mới</button>
                </div>
                <!-- Reusing service-card styles for better display -->
                <div id="adminServicesList" style="margin-top:20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px"></div>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <p>&copy; 2024 Lux Photography Studio. All rights reserved.</p>
        <!-- REMOVED: Admin Setup Button -->
    </footer>

    <!-- MODAL: Booking (ADDED TIME) -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('bookingModal')">&times;</span>
            <h3>Xác nhận đặt lịch</h3>
            <div id="bookingSummary" style="background:#f9f9f9; padding:15px; margin-bottom:20px; border-radius:var(--radius)"></div>
            
            <div class="form-group">
                <label>Ngày chụp (*)</label>
                <input type="date" id="shootDate" required>
            </div>
            <div class="form-group">
                <label>Giờ chụp (*)</label>
                <input type="time" id="shootTime" required value="09:00">
            </div>
            <div class="form-group">
                <label>Địa điểm chụp (*)</label>
                <input type="text" id="shootLocation" placeholder="Studio X / Công viên Y / Địa chỉ cụ thể" required>
            </div>
            <div class="form-group">
                <label>Số điện thoại liên hệ (*)</label>
                <input type="tel" id="userPhone" placeholder="09xxxxxxx" required>
            </div>
            
            <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end; margin-top:20px">
                <button class="btn" onclick="closeModal('bookingModal')">Hủy</button>
                <button class="btn btn-fill" onclick="submitBooking()">Đặt ngay</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Admin Service Edit (Unchanged structure) -->
    <!-- ... -->
    <div id="svcModal" class="modal">
        <div class="modal-content" style="max-width:600px">
            <span class="close-btn" onclick="closeModal('svcModal')">&times;</span>
            <h3 id="svcModalTitle">Gói dịch vụ</h3>
            <input type="hidden" id="editSvcId">
            <div class="form-group"><label>Tên gói</label><input type="text" id="svcName"></div>
            <div class="form-group"><label>Giá gốc</label><input type="number" id="svcPrice"></div>
            <div class="form-group"><label>Mô tả ngắn</label><textarea id="svcDesc" rows="2"></textarea></div>
            
            <div style="margin: 20px 0; border-top:1px solid #eee; padding-top:10px">
                <label style="font-weight:600; font-size:0.9rem">Tùy chọn thêm (Options)</label>
                <div id="optContainer"></div>
                <button class="btn btn-sm" onclick="addOptionRow()">+ Thêm dòng option</button>
            </div>

            <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end; margin-top:20px">
                <button class="btn" onclick="closeModal('svcModal')">Đóng</button>
                <button class="btn btn-fill" onclick="saveService()">Lưu gói</button>
            </div>
        </div>
    </div>

    <!-- MODAL: Admin Deliver Job (Unchanged) -->
    <!-- ... -->
    <div id="deliverModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('deliverModal')">&times;</span>
            <h3>Trả ảnh cho khách</h3>
            <input type="hidden" id="deliverOrderId">
            <div class="form-group">
                <label>Link Google Drive / Gallery</label>
                <input type="text" id="jobLink" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Mật khẩu / Mã truy cập</label>
                <input type="text" id="jobPass" placeholder="Nếu có">
            </div>
            <button class="btn btn-fill" style="width:100%; margin-top:10px" onclick="submitDelivery()">Xác nhận trả job</button>
            <button class="btn" style="width:100%; margin-top:10px" onclick="closeModal('deliverModal')">Đóng</button>
        </div>
    </div>

    <!-- MODAL: Client View Job (Unchanged) -->
    <!-- ... -->
    <div id="resultModal" class="modal">
        <div class="modal-content" style="text-align:center">
            <span class="close-btn" onclick="closeModal('resultModal')">&times;</span>
            <h3 style="color:var(--success)">Ảnh của bạn đã sẵn sàng!</h3>
            <p>Vui lòng dùng thông tin dưới đây để truy cập:</p>
            <div style="background:#f0f0f0; padding:20px; margin:20px 0; border-radius:8px">
                <p><strong>Link:</strong> <a id="resLink" href="#" target="_blank">Bấm vào đây để mở</a></p>
                <p style="margin-top:10px"><strong>Mật khẩu:</strong> <span id="resPass" style="font-family:monospace; font-size:1.2rem; background:white; padding:2px 8px; border-radius:var(--radius);"></span></p>
            </div>
            <button class="btn btn-fill" onclick="closeModal('resultModal')">Đã nhận</button>
        </div>
    </div>


    <!-- SCRIPT (MAJOR LOGIC CHANGES) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, setDoc, getDoc, documentId } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        
        // ADMIN UID CONFIG - THAY THẾ SAU KHI DÙNG NÚT "ADMIN SETUP"
        const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let services = [];
        let bookingData = {}; 
        let allAdminOrders = []; // Global storage for Admin orders for filtering/stats

        // 1. AUTH & SETUP
        window.login = () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).then(res => {
                setDoc(doc(db, "users", res.user.uid), { 
                    email: res.user.email, name: res.user.displayName 
                }, { merge: true });
                showToast("Đăng nhập thành công");
            }).catch(err => alert(err.message));
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, user => {
            currentUser = user;
            document.getElementById('loader').style.display = 'none';
            
            if(user) {
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('userAvatar').style.display = 'block';
                document.getElementById('menuDash').style.display = 'block';
                
                // Initialize admin-only data loading if user is admin
                if(user.uid === ADMIN_UID) {
                    document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
                    // Data loading is deferred to switchTab/goDash
                } else {
                    // Client data loading is deferred to switchTab/goDash
                }
            } else {
                goHome();
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('userAvatar').style.display = 'none';
                document.getElementById('menuDash').style.display = 'none';
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
            }
        });

        // REMOVED: getAdminUID function as requested

        // MOBILE MENU TOGGLE
        window.toggleMenu = (force) => {
            const nav = document.getElementById('mainNav');
            const isMobile = window.matchMedia("(max-width: 768px)").matches;
            
            if (!isMobile && force === undefined) return;
            
            if (force === true) nav.classList.add('open');
            else if (force === false) nav.classList.remove('open');
            else nav.classList.toggle('open');
        };


        // 3. SERVICE DISPLAY & LOGIC
        async function loadServices() {
            const q = query(collection(db, "services"));
            const snap = await getDocs(q);
            services = [];
            snap.forEach(d => services.push({id: d.id, ...d.data()}));
            
            renderServices();
            if(currentUser && currentUser.uid === ADMIN_UID) renderAdminServices();
        }
        
        function renderServices() {
            const grid = document.getElementById('servicesGrid');
            // Check if grid exists before rendering (for admin tab)
            if (!grid) return; 
            grid.innerHTML = services.map(s => `
                <div class="service-card">
                    <div class="svc-header">
                        <h3>${s.name}</h3>
                        <div class="svc-price" id="price-${s.id}" data-curr="${s.price}">${fmt(s.price)}</div>
                    </div>
                    <p class="svc-desc">${s.desc || 'Chưa có mô tả'}</p>
                    
                    ${(s.options && s.options.length > 0) ? `
                        <div class="option-group">
                            <p style="font-size:0.8rem; font-weight:600; margin-bottom:10px">Thêm tùy chọn:</p>
                            ${s.options.map((opt, i) => `
                                <div class="option-row">
                                    <label>
                                        <input type="checkbox" onchange="calcPrice('${s.id}', ${s.price}, this, ${opt.price})" data-name="${opt.name}" data-price="${opt.price}">
                                        ${opt.name}
                                    </label>
                                    <span>+${fmt(opt.price)}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <button class="btn btn-fill" style="width:100%; margin-top:20px" onclick="openBooking('${s.id}')">Đăng ký gói này</button>
                    ${currentUser && currentUser.uid === ADMIN_UID ? `<button class="btn btn-sm" style="margin-top:10px" onclick="openEditSvc('${s.id}')">Sửa (Admin)</button>` : ''}
                </div>
            `).join('');
        }

        window.calcPrice = (id, base, checkbox, optPrice) => {
            const el = document.getElementById(`price-${id}`);
            let total = parseInt(el.dataset.curr || base);
            total = checkbox.checked ? total + optPrice : total - optPrice;
            el.dataset.curr = total;
            el.innerText = fmt(total);
        };

        // 4. BOOKING (UPDATED with Time)
        window.openBooking = (id) => {
            if(!currentUser) return login();
            const svc = services.find(s => s.id === id);
            
            const card = document.querySelector(`input[onchange*="'${id}'"]`)?.closest('.service-card') || document.querySelector(`#price-${id}`).closest('.service-card');
            const checks = card ? card.querySelectorAll('.option-row input[type="checkbox"]:checked') : []; 
            let opts = [];
            let total = svc.price;

            checks.forEach(c => {
                opts.push({name: c.dataset.name, price: parseInt(c.dataset.price)});
                total += parseInt(c.dataset.price);
            });

            bookingData = { svcName: svc.name, opts, total };
            
            document.getElementById('bookingSummary').innerHTML = `
                <p><strong>Gói:</strong> ${svc.name}</p>
                <p><strong>Options:</strong> ${opts.map(o=>o.name).join(', ') || 'Không'}</p>
                <p style="font-size:1.2rem; margin-top:10px; color:var(--accent)"><strong>Tổng cộng: ${fmt(total)}</strong></p>
            `;
            // Reset fields
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('shootDate').value = today;
            document.getElementById('shootDate').min = today;
            document.getElementById('shootTime').value = '09:00'; // Default Time
            document.getElementById('shootLocation').value = '';
            document.getElementById('userPhone').value = '';
            
            document.getElementById('bookingModal').style.display = 'flex';
        };

        window.submitBooking = async () => {
            const phone = document.getElementById('userPhone').value;
            const date = document.getElementById('shootDate').value;
            const time = document.getElementById('shootTime').value; // ADDED TIME
            const location = document.getElementById('shootLocation').value;
            
            if(!phone || !date || !time || !location) return alert("Vui lòng nhập đầy đủ Số điện thoại, Ngày chụp, Giờ chụp và Địa điểm");
            
            document.getElementById('bookingModal').style.display = 'none';
            showLoader(true);
            
            try {
                await addDoc(collection(db, "orders"), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    phone: phone,
                    date: date,
                    time: time, // SAVE TIME
                    location: location,
                    ...bookingData,
                    status: "Chờ xác nhận",
                    createdAt: new Date(),
                    deliveryLink: "",
                    deliveryPass: ""
                });
                showToast("Đã gửi yêu cầu đặt lịch!");
                loadMyOrders(); // FIX: ensure loadMyOrders is called to refresh the list
            } catch(e) { alert(e.message); }
            showLoader(false);
        };

        // 5. CLIENT ORDER MANAGEMENT (UPDATED with Time)
        async function loadMyOrders() {
            if(!currentUser) {
                 document.querySelector('#tab-my-orders tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;">Vui lòng Đăng nhập để xem đơn hàng của bạn.</td></tr>';
                 return;
            }
            showLoader(true);
            
            const q = query(collection(db, "orders"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snaps = await getDocs(q);
            const tbody = document.querySelector('#myOrdersTable tbody');
            tbody.innerHTML = '';
            
            if(snaps.empty) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Bạn chưa có đơn hàng nào.</td></tr>';
            } else {
                snaps.forEach(d => {
                    const data = d.data();
                    const isDone = data.status === "Hoàn thành";
                    const dateOrder = data.createdAt.toDate().toLocaleDateString('vi-VN');
                    const statusClass = data.status.includes('Chờ') ? 'badge-pending' : (data.status.includes('Hoàn thành') ? 'badge-completed' : (data.status.includes('Đã hủy') ? 'badge-cancelled' : 'badge-deposit'));

                    tbody.innerHTML += `
                        <tr>
                            <td data-label="Ngày đặt">${dateOrder}</td>
                            <td data-label="Ngày/Giờ chụp">${data.date} ${data.time || ''}</td> <!-- UPDATED -->
                            <td data-label="Gói">${data.svcName}</td>
                            <td data-label="Địa điểm">${data.location}</td>
                            <td data-label="Tổng tiền">${fmt(data.total)}</td>
                            <td data-label="Trạng thái"><span class="badge ${statusClass}">${data.status}</span></td>
                            <td data-label="Kết quả">
                                ${isDone && data.deliveryLink ? `<button class="btn btn-sm btn-fill" onclick="viewResult('${data.deliveryLink}', '${data.deliveryPass}')">NHẬN ẢNH</button>` : '---'}
                            </td>
                        </tr>
                    `;
                });
            }
            showLoader(false);
        }
        
        window.viewResult = (link, pass) => {
            document.getElementById('resLink').href = link;
            document.getElementById('resPass').innerText = pass || "Không có";
            document.getElementById('resultModal').style.display = 'flex';
        }

        // 6. ADMIN MANAGEMENT
        // 6a. Orders & Delivery (UPDATED with Search, Filter, Stats, Time)
        window.loadAdminOrders = async () => {
            if(currentUser.uid !== ADMIN_UID) return;
            showLoader(true);

            // Get filter values
            const searchVal = document.getElementById('orderSearch').value.toLowerCase();
            const filterStatus = document.getElementById('orderFilterStatus').value;

            // Fetch ALL orders for client-side filtering and stats calculation
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            allAdminOrders = [];
            snap.forEach(d => allAdminOrders.push({id: d.id, ...d.data()}));
            
            // Apply filtering
            const filteredOrders = allAdminOrders.filter(d => {
                const searchMatch = !searchVal || 
                    d.email.toLowerCase().includes(searchVal) || 
                    d.phone.includes(searchVal) || 
                    d.location.toLowerCase().includes(searchVal);
                
                const statusMatch = !filterStatus || d.status === filterStatus;
                
                return searchMatch && statusMatch;
            });

            // Update Stats based on ALL orders
            updateAdminStats(allAdminOrders);

            const tbody = document.querySelector('#adminOrdersTable tbody');
            tbody.innerHTML = '';
            
            if(filteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Không tìm thấy đơn hàng nào.</td></tr>';
            } else {
                 filteredOrders.forEach(d => {
                    const statusClass = d.status.includes('Chờ') ? 'badge-pending' : (d.status.includes('Hoàn thành') ? 'badge-completed' : (d.status.includes('Đã hủy') ? 'badge-cancelled' : 'badge-deposit'));
                    
                    tbody.innerHTML += `
                        <tr>
                            <td data-label="Khách">${d.email}</td>
                            <td data-label="SĐT">${d.phone}</td>
                            <td data-label="Ngày/Giờ chụp">${d.date} ${d.time || ''}</td> <!-- UPDATED -->
                            <td data-label="Địa điểm">${d.location}</td>
                            <td data-label="Gói">${d.svcName}</td>
                            <td data-label="Tổng">${fmt(d.total)}</td>
                            <td data-label="Trạng thái">
                                <select onchange="updateStatus('${d.id}', this.value)" style="padding:5px; border-radius:var(--radius); border-color:var(--border);">
                                    <option value="Chờ xác nhận" ${d.status=='Chờ xác nhận'?'selected':''}>Chờ xác nhận</option>
                                    <option value="Đã cọc" ${d.status=='Đã cọc'?'selected':''}>Đã cọc</option>
                                    <option value="Hoàn thành" ${d.status=='Hoàn thành'?'selected':''}>Hoàn thành</option>
                                    <option value="Đã hủy" ${d.status=='Đã hủy'?'selected':''}>Đã hủy</option> <!-- ADDED STATUS -->
                                </select>
                            </td>
                            <td data-label="Hành động">
                                 <button class="btn btn-sm" onclick="openDeliver('${d.id}')">Trả Ảnh</button>
                            </td>
                        </tr>
                    `;
                });
            }
            showLoader(false);
        };

        function updateAdminStats(orders) {
            const total = orders.length;
            const pending = orders.filter(o => o.status === 'Chờ xác nhận').length;
            const deposit = orders.filter(o => o.status === 'Đã cọc').length;
            const completed = orders.filter(o => o.status === 'Hoàn thành').length;
            const cancelled = orders.filter(o => o.status === 'Đã hủy').length;

            const rate = (total - cancelled) > 0 ? ((completed / (total - cancelled)) * 100).toFixed(1) : 0; 

            document.getElementById('statTotal').innerText = total;
            document.getElementById('statDeposit').innerText = deposit;
            document.getElementById('statPending').innerText = pending;
            document.getElementById('statCompleteRate').innerText = `${rate}%`;
        }


        window.updateStatus = async (id, newStatus) => {
            if(currentUser.uid !== ADMIN_UID) return showToast("Bạn không có quyền admin");

            const isApproved = ['Đã cọc', 'Hoàn thành'].includes(newStatus);
            let proceed = true;

            if (isApproved) {
                showLoader(true);
                const orderSnap = await getDoc(doc(db, "orders", id));
                const order = orderSnap.data();

                // Check for conflict: Same Date AND Same Location AND Same Time
                const conflictQuery = query(
                    collection(db, "orders"), 
                    where("date", "==", order.date),
                    where("location", "==", order.location),
                    where("time", "==", order.time), // ADDED TIME CHECK
                    where("status", "in", ["Đã cọc", "Hoàn thành"]),
                    where(documentId(), "!=", id) 
                );
                
                const conflictSnaps = await getDocs(conflictQuery);
                showLoader(false); 

                if (conflictSnaps.size > 0) {
                    const msg = `CẢNH BÁO: Lịch ngày ${order.date} lúc ${order.time} tại ${order.location} đã TRÙNG với ${conflictSnaps.size} đơn hàng đã duyệt/hoàn thành. Bạn có muốn duyệt không?`;
                    proceed = confirm(msg);
                }
            }

            if (proceed) {
                showLoader(true);
                await updateDoc(doc(db, "orders", id), {status: newStatus});
                showToast("Đã cập nhật trạng thái đơn hàng");
            } else {
                 // Revert select box to previous status if the user cancels the confirmation
                 // Reloading data ensures the select box reverts
                 showToast("Hủy duyệt do trùng lịch");
            }
            showLoader(false);
            loadAdminOrders();
            renderAdminSchedule(); // Update schedule if active tab
        };

        // ... (openDeliver & submitDelivery remain the same)

        // 6b. Services CRUD (UPDATED renderAdminServices layout)
        window.renderAdminServices = () => {
             const div = document.getElementById('adminServicesList');
             if (!div) return;
             div.innerHTML = services.map(s => `
                <div class="service-card" style="min-width: unset; flex-shrink: unset;">
                    <div class="svc-header">
                        <h3>${s.name}</h3>
                        <div class="svc-price">${fmt(s.price)}</div>
                    </div>
                    <p class="svc-desc">${s.desc || 'Chưa có mô tả'}</p>
                    <p style="font-size:0.8rem; color:var(--text-secondary)">Options: ${s.options?.length || 0}</p>
                    <div style="margin-top:15px; display:flex; gap:10px">
                        <button class="btn btn-sm btn-fill" onclick="openEditSvc('${s.id}')">Sửa</button>
                        <button class="btn btn-sm btn-danger" onclick="delSvc('${s.id}')">Xóa</button>
                    </div>
                </div>
             `).join('');
        };
        
        // ... (openServiceModal, openEditSvc, addOptionRow, saveService, delSvc remain the same)

        // 6c. Admin Schedule View (NEW)
        window.renderAdminSchedule = async () => {
            const date = document.getElementById('scheduleDateFilter').value;
            const list = document.getElementById('adminScheduleList');
            
            if(!list || !date) {
                list.innerHTML = '<p>Vui lòng chọn ngày để xem lịch chụp đã được duyệt (Đã cọc/Hoàn thành).</p>';
                return;
            }
            
            showLoader(true);
            const q = query(
                collection(db, "orders"), 
                where("date", "==", date),
                where("status", "in", ["Đã cọc", "Hoàn thành"]),
                orderBy("time", "asc")
            );
            
            const snaps = await getDocs(q);
            showLoader(false);
            
            if(snaps.empty) {
                list.innerHTML = `<p style="color:var(--success)">Tuyệt vời! Ngày ${date} không có lịch chụp đã được duyệt nào.</p>`;
            } else {
                list.innerHTML = snaps.docs.map(doc => {
                    const d = doc.data();
                    return `
                        <div style="padding:15px; border:1px solid var(--border); border-radius:var(--radius); background:var(--bg-secondary); display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h4 style="margin-bottom:5px; color:var(--accent)">${d.time} - ${d.svcName}</h4>
                                <p style="font-size:0.9rem; color:var(--text-secondary)">Địa điểm: ${d.location}</p>
                                <p style="font-size:0.9rem;">Khách: ${d.email} | SĐT: ${d.phone}</p>
                            </div>
                            <span class="badge ${d.status=='Hoàn thành'?'badge-completed':'badge-deposit'}">${d.status}</span>
                        </div>
                    `;
                }).join('');
            }
        };


        // GENERAL UI (UPDATED goDash and switchTab)
        window.goHome = () => {
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
        };
        
        window.goDash = () => {
            if(!currentUser) return login();
            
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            
            if(currentUser.uid === ADMIN_UID) {
                switchTab('admin-orders', document.getElementById('tabBtn-admin-orders'));
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('scheduleDateFilter').value = today; // Set default date for schedule
            } else {
                switchTab('my-orders', document.getElementById('tabBtn-my-orders'));
            }
        };

        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            const targetContent = document.getElementById('tab-' + tabId);
            if (targetContent) targetContent.style.display = 'block';
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            if(tabId === 'admin-orders') loadAdminOrders();
            if(tabId === 'my-orders') loadMyOrders();
            if(tabId === 'admin-services') renderAdminServices();
            if(tabId === 'admin-schedule') renderAdminSchedule();
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.showLoader = (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none';
        
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 3000);
        };
        
        function fmt(n) { return new Intl.NumberFormat('vi-VN', {style:'currency', currency:'VND'}).format(n); }
        
        window.addEventListener('scroll', () => {
            const h = document.getElementById('mainHeader');
            if(window.scrollY > 50) h.classList.add('scrolled');
            else h.classList.remove('scrolled');
        });
        
        // Add event listeners to search/filter inputs for instant filtering
        document.getElementById('orderSearch')?.addEventListener('input', loadAdminOrders);
        document.getElementById('orderFilterStatus')?.addEventListener('change', loadAdminOrders);


        // INIT
        loadServices();

    </script>
</body>
</html>
