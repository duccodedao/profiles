<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X·ªï S·ªë Blockchain 4.0 - Glassmorphism</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --accent: #ec4899;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #94a3b8;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Classes */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.3);
        }

        /* Inputs & Buttons */
        input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: white;
            transition: all 0.3s;
        }
        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        .btn-glow {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            position: relative;
            z-index: 1;
            overflow: hidden;
            transition: 0.3s;
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.5);
            transform: scale(1.02);
        }

        /* Lottery Slots Animation */
        .slot-machine {
            display: flex;
            gap: 10px;
            justify-content: center;
            perspective: 1000px;
        }
        .slot-digit {
            width: 50px;
            height: 70px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            font-size: 2.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4ade80;
            text-shadow: 0 0 10px #4ade80;
            border: 1px solid rgba(74, 222, 128, 0.3);
            overflow: hidden;
            position: relative;
        }
        .slot-digit.rolling span {
            animation: roll 0.1s infinite linear;
        }
        @keyframes roll {
            0% { transform: translateY(-100%); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: translateY(100%); opacity: 0; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Helpers */
        .hidden-app { display: none !important; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: rgba(0, 0, 0, 0.8);
            border-left: 4px solid var(--primary);
            color: white;
            padding: 15px 25px;
            margin-bottom: 10px;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(5px);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- Notification Area -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Auth Section -->
    <div id="auth-section" class="flex items-center justify-center min-h-screen relative overflow-hidden">
        <!-- Background Orbs -->
        <div class="absolute top-0 left-0 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-0 right-0 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>

        <div class="glass-card p-8 w-full max-w-md relative z-10">
            <h1 class="text-3xl font-bold text-center mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-pink-500">
                X·ªî S·ªê 4.0
            </h1>
            <p class="text-center text-gray-400 mb-8">N·ªÅn t·∫£ng c∆∞·ª£c minh b·∫°ch & hi·ªán ƒë·∫°i</p>

            <div class="flex gap-2 mb-6 p-1 glass rounded-lg">
                <button id="tab-login" class="flex-1 py-2 rounded-md bg-white/10 text-white transition">ƒêƒÉng Nh·∫≠p</button>
                <button id="tab-register" class="flex-1 py-2 rounded-md text-gray-400 hover:text-white transition">ƒêƒÉng K√Ω</button>
            </div>

            <form id="auth-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 rounded-lg" placeholder="name@example.com" required>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="w-full px-4 py-2 rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div id="register-fields" class="hidden-app">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                        <input type="password" id="confirm-password" class="w-full px-4 py-2 rounded-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
                <button type="submit" class="w-full py-3 rounded-lg btn-glow font-bold text-white mt-4">
                    <i class="fa-solid fa-rocket mr-2"></i> <span id="auth-btn-text">B·∫Øt ƒë·∫ßu ngay</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard-section" class="hidden-app min-h-screen flex flex-col md:flex-row">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-64 glass border-r border-white/10 flex flex-col">
            <div class="p-6">
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-pink-500">LUCKY 66</h2>
            </div>
            
            <nav class="flex-1 px-4 space-y-2">
                <button onclick="UI.switchTab('home')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center">
                    <i class="fa-solid fa-gamepad w-6"></i> Trang Ch·ªß
                </button>
                <button onclick="UI.switchTab('wallet')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center">
                    <i class="fa-solid fa-wallet w-6"></i> V√≠ Ti·ªÅn
                </button>
                <button onclick="UI.switchTab('history')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center">
                    <i class="fa-solid fa-clock-rotate-left w-6"></i> L·ªãch S·ª≠
                </button>
                <button onclick="UI.switchTab('stats')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center">
                    <i class="fa-solid fa-chart-pie w-6"></i> Th·ªëng K√™
                </button>
                <button id="admin-link" onclick="UI.switchTab('admin')" class="hidden-app w-full text-left px-4 py-3 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition flex items-center">
                    <i class="fa-solid fa-user-shield w-6"></i> Qu·∫£n Tr·ªã Admin
                </button>
            </nav>

            <div class="p-4 border-t border-white/10">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold" id="user-avatar">U</div>
                    <div>
                        <div class="text-sm font-bold truncate w-32" id="user-email">User</div>
                        <div class="text-xs text-green-400" id="user-balance">0 VND</div>
                    </div>
                </div>
                <button id="logout-btn" class="w-full py-2 border border-white/20 rounded-lg hover:bg-white/5 transition text-sm">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            
            <!-- HOME TAB -->
            <div id="tab-content-home" class="tab-content animate-fade-in">
                <!-- Header Status -->
                <div class="flex flex-wrap gap-4 justify-between items-center mb-8">
                    <div>
                        <h1 class="text-2xl font-bold">V√≤ng Quay May M·∫Øn</h1>
                        <p class="text-gray-400 text-sm">C·∫≠p nh·∫≠t m·ªói 60 gi√¢y</p>
                    </div>
                    <div class="glass px-6 py-3 rounded-xl flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Th·ªùi gian c√≤n l·∫°i</p>
                            <p id="timer" class="text-2xl font-mono font-bold text-yellow-400">60s</p>
                        </div>
                        <i class="fa-solid fa-hourglass-half text-2xl text-yellow-400 animate-pulse"></i>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Game Area -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Display Numbers -->
                        <div class="glass-card p-10 flex flex-col items-center justify-center min-h-[250px] relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-purple-500/10 to-transparent pointer-events-none"></div>
                            <h3 class="text-gray-400 mb-6 uppercase tracking-widest text-sm">K·∫æT QU·∫¢ K·ª≤ TR∆Ø·ªöC</h3>
                            <div class="slot-machine" id="result-display">
                                <div class="slot-digit"><span>0</span></div>
                                <div class="slot-digit"><span>0</span></div>
                                <div class="slot-digit"><span>0</span></div>
                                <div class="slot-digit"><span>0</span></div>
                                <div class="slot-digit"><span>0</span></div>
                                <div class="slot-digit"><span>0</span></div>
                            </div>
                            <div id="win-message" class="hidden-app mt-6 text-xl font-bold text-yellow-400 animate-bounce">
                                üéâ CH√öC M·ª™NG B·∫†N ƒê√É CHI·∫æN TH·∫ÆNG!
                            </div>
                        </div>

                        <!-- Betting Controls -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-bold mb-4 flex items-center"><i class="fa-solid fa-ticket mr-2 text-pink-500"></i> ƒê·∫∑t C∆∞·ª£c</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-400 mb-1 block">Ch·ªçn s·ªë (6 ch·ªØ s·ªë)</label>
                                    <input type="number" id="bet-number" class="w-full px-4 py-3 rounded-lg text-lg tracking-widest font-mono" placeholder="123456" max="999999">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 mb-1 block">S·ªë ti·ªÅn c∆∞·ª£c</label>
                                    <input type="number" id="bet-amount" class="w-full px-4 py-3 rounded-lg text-lg font-mono" placeholder="50000" step="1000">
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2 overflow-x-auto pb-2">
                                <button onclick="setQuickBet(10000)" class="px-3 py-1 text-xs rounded border border-white/20 hover:bg-white/10">10k</button>
                                <button onclick="setQuickBet(50000)" class="px-3 py-1 text-xs rounded border border-white/20 hover:bg-white/10">50k</button>
                                <button onclick="setQuickBet(100000)" class="px-3 py-1 text-xs rounded border border-white/20 hover:bg-white/10">100k</button>
                                <button onclick="setQuickBet(500000)" class="px-3 py-1 text-xs rounded border border-white/20 hover:bg-white/10">500k</button>
                            </div>
                            <button id="place-bet-btn" class="w-full mt-6 py-3 rounded-lg btn-glow font-bold text-white text-lg shadow-lg">
                                ƒê·∫∂T C∆Ø·ª¢C NGAY
                            </button>
                        </div>
                    </div>

                    <!-- Right Sidebar: Stats -->
                    <div class="space-y-6">
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-bold mb-4">Gi·∫£i Th∆∞·ªüng</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between p-2 rounded bg-white/5">
                                    <span>Gi·∫£i ƒê·∫∑c Bi·ªát (6 s·ªë)</span>
                                    <span class="text-yellow-400 font-bold">x90</span>
                                </div>
                                <div class="flex justify-between p-2 rounded bg-white/5">
                                    <span>Gi·∫£i Nh·∫•t (2 s·ªë cu·ªëi)</span>
                                    <span class="text-yellow-400 font-bold">x3.5</span>
                                </div>
                                <div class="text-xs text-gray-500 mt-2 italic">* T·ª∑ l·ªá c√≥ th·ªÉ thay ƒë·ªïi b·ªüi Admin</div>
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-trophy text-yellow-500 mr-2"></i> B·∫£ng X·∫øp H·∫°ng</h3>
                            <div class="space-y-3" id="leaderboard-list">
                                <!-- JS Injected -->
                                <div class="text-center text-gray-500 text-sm">ƒêang t·∫£i...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WALLET TAB -->
            <div id="tab-content-wallet" class="tab-content hidden-app">
                <h2 class="text-2xl font-bold mb-6">V√≠ C·ªßa T√¥i</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 bg-gradient-to-br from-indigo-900 to-blue-900">
                        <p class="text-gray-400">S·ªë d∆∞ kh·∫£ d·ª•ng</p>
                        <h1 class="text-4xl font-bold text-white my-2" id="wallet-balance-display">0 VND</h1>
                        <p class="text-xs text-gray-400">ID: <span id="wallet-id">...</span></p>
                    </div>

                    <div class="glass-card p-6">
                        <h3 class="text-lg font-bold mb-4">N·∫°p Ti·ªÅn</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-400">S·ªë ti·ªÅn mu·ªën n·∫°p</label>
                                <input type="number" id="deposit-amount" class="w-full px-4 py-2 rounded-lg mt-1" placeholder="V√≠ d·ª•: 500000">
                            </div>
                            <div class="p-3 bg-yellow-500/10 border border-yellow-500/20 rounded text-xs text-yellow-200">
                                <i class="fa-solid fa-circle-info mr-1"></i> Chuy·ªÉn kho·∫£n t·ªõi STK Admin hi·ªÉn th·ªã b√™n d∆∞·ªõi, sau ƒë√≥ b·∫•m "G·ª≠i y√™u c·∫ßu". Admin s·∫Ω duy·ªát trong 5 ph√∫t.
                            </div>
                            <div id="bank-info-display" class="text-sm space-y-1 text-gray-300">
                                <!-- Bank info injected by Admin settings -->
                            </div>
                            <button id="btn-deposit" class="w-full py-2 rounded-lg bg-green-600 hover:bg-green-500 transition font-bold">G·ª≠i Y√™u C·∫ßu N·∫°p</button>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-xl font-bold mt-8 mb-4">L·ªãch S·ª≠ Giao D·ªãch</h3>
                <div class="glass-card overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white/5 text-gray-400">
                            <tr>
                                <th class="p-4">Th·ªùi gian</th>
                                <th class="p-4">Lo·∫°i</th>
                                <th class="p-4">S·ªë ti·ªÅn</th>
                                <th class="p-4">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-list" class="divide-y divide-white/10">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div id="tab-content-history" class="tab-content hidden-app">
                <h2 class="text-2xl font-bold mb-6">L·ªãch S·ª≠ C∆∞·ª£c</h2>
                <div class="glass-card overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white/5 text-gray-400">
                            <tr>
                                <th class="p-4">K·ª≥ #</th>
                                <th class="p-4">S·ªë ch·ªçn</th>
                                <th class="p-4">K·∫øt qu·∫£</th>
                                <th class="p-4">Ti·ªÅn c∆∞·ª£c</th>
                                <th class="p-4">K·∫øt qu·∫£</th>
                            </tr>
                        </thead>
                        <tbody id="bet-history-list" class="divide-y divide-white/10">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- STATS TAB -->
            <div id="tab-content-stats" class="tab-content hidden-app">
                <h2 class="text-2xl font-bold mb-6">Th·ªëng K√™ C√° Nh√¢n</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6">
                        <h3 class="text-center mb-4">T·ª∑ L·ªá Th·∫Øng/Thua</h3>
                        <canvas id="winLossChart"></canvas>
                    </div>
                     <div class="glass-card p-6 flex flex-col justify-center space-y-4">
                        <div class="flex justify-between items-center border-b border-white/10 pb-4">
                            <span>T·ªïng ti·ªÅn ƒë√£ c∆∞·ª£c:</span>
                            <span class="font-bold text-blue-400" id="stat-total-bet">0 VND</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-white/10 pb-4">
                            <span>T·ªïng ti·ªÅn th·∫Øng:</span>
                            <span class="font-bold text-green-400" id="stat-total-win">0 VND</span>
                        </div>
                         <div class="flex justify-between items-center">
                            <span>S·ªë l·∫ßn c∆∞·ª£c:</span>
                            <span class="font-bold" id="stat-count">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN TAB -->
            <div id="tab-content-admin" class="tab-content hidden-app">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-red-400">Admin Dashboard</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Auto Loop:</span>
                        <button id="toggle-game-loop" class="px-4 py-2 bg-green-600 rounded text-xs font-bold">ON</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card p-4">
                        <p class="text-gray-400 text-xs">T·ªïng ng∆∞·ªùi d√πng</p>
                        <h3 class="text-2xl font-bold" id="admin-total-users">0</h3>
                    </div>
                    <div class="glass-card p-4">
                        <p class="text-gray-400 text-xs">T·ªïng c∆∞·ª£c h·ªá th·ªëng</p>
                        <h3 class="text-2xl font-bold text-blue-400" id="admin-total-bets">0 VND</h3>
                    </div>
                     <div class="glass-card p-4">
                        <p class="text-gray-400 text-xs">Y√™u c·∫ßu n·∫°p ch·ªù duy·ªát</p>
                        <h3 class="text-2xl font-bold text-yellow-400" id="admin-pending-deposits">0</h3>
                    </div>
                </div>

                <!-- Admin Tabs -->
                <div class="flex gap-2 mb-4 border-b border-white/10 pb-2">
                    <button onclick="AdminUI.switchSubTab('users')" class="text-sm px-3 py-1 bg-white/10 rounded">Users</button>
                    <button onclick="AdminUI.switchSubTab('deposits')" class="text-sm px-3 py-1 hover:bg-white/10 rounded">Duy·ªát N·∫°p</button>
                    <button onclick="AdminUI.switchSubTab('settings')" class="text-sm px-3 py-1 hover:bg-white/10 rounded">C·∫•u h√¨nh</button>
                </div>

                <div id="admin-sub-users" class="admin-subtab">
                    <div class="glass-card overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-white/5">
                                <tr><th>Email</th><th>S·ªë d∆∞</th><th>H√†nh ƒë·ªông</th></tr>
                            </thead>
                            <tbody id="admin-user-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-sub-deposits" class="admin-subtab hidden-app">
                    <div class="glass-card overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-white/5">
                                <tr><th>Email</th><th>S·ªë ti·ªÅn</th><th>Th·ªùi gian</th><th>H√†nh ƒë·ªông</th></tr>
                            </thead>
                            <tbody id="admin-deposit-list"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-sub-settings" class="admin-subtab hidden-app">
                    <div class="glass-card p-6 space-y-4">
                        <h4 class="font-bold text-lg">Ng√¢n h√†ng nh·∫≠n ti·ªÅn</h4>
                        <textarea id="admin-bank-config" class="w-full h-24 p-2 rounded bg-black/30 border border-white/20" placeholder="MB Bank - STK: 9999..."></textarea>
                        <button id="save-config-btn" class="px-4 py-2 bg-blue-600 rounded">L∆∞u C·∫•u H√¨nh</button>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- Firebase SDK (Modular via CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, updateDoc, doc, getDoc, setDoc, limit, serverTimestamp, runTransaction, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const ADMIN_EMAIL = "sonlyhongduc@gmail.com";
        let currentUser = null;
        let userData = null;
        let currentRoundId = null;
        let isSpinning = false;
        let gameInterval = null;
        let nextDrawTime = 0;

        // --- DOM ELEMENTS ---
        const $ = (selector) => document.querySelector(selector);
        
        // --- HELPER FUNCTIONS ---
        const toast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast border-l-4 ${type === 'error' ? 'border-red-500' : 'border-green-500'}`;
            div.innerHTML = msg;
            container.appendChild(div);
            setTimeout(() => { div.remove(); }, 3000);
        };

        const formatMoney = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);
        
        // --- AUTH LOGIC ---
        const Auth = {
            init: () => {
                $('#tab-login').onclick = () => Auth.toggleView('login');
                $('#tab-register').onclick = () => Auth.toggleView('register');
                $('#auth-form').onsubmit = Auth.handleSubmit;
                $('#logout-btn').onclick = () => signOut(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        $('#auth-section').classList.add('hidden-app');
                        $('#dashboard-section').classList.remove('hidden-app');
                        
                        // Setup Realtime User Data
                        onSnapshot(doc(db, "users", user.uid), (doc) => {
                            if(doc.exists()) {
                                userData = doc.data();
                                UI.updateUserInfo(user, userData);
                                // Check admin
                                if(user.email === ADMIN_EMAIL) {
                                    $('#admin-link').classList.remove('hidden-app');
                                    Admin.init();
                                }
                            } else {
                                // Create user doc if not exists
                                setDoc(doc(db, "users", user.uid), {
                                    email: user.email,
                                    balance: 0,
                                    createdAt: serverTimestamp()
                                });
                            }
                        });

                        Game.init();
                        Wallet.init();
                        History.init();
                        Stats.init();

                    } else {
                        currentUser = null;
                        userData = null;
                        $('#auth-section').classList.remove('hidden-app');
                        $('#dashboard-section').classList.add('hidden-app');
                    }
                });
            },
            toggleView: (view) => {
                const btnLog = $('#tab-login');
                const btnReg = $('#tab-register');
                const fields = $('#register-fields');
                const btnText = $('#auth-btn-text');

                if (view === 'login') {
                    btnLog.className = 'flex-1 py-2 rounded-md bg-white/10 text-white transition';
                    btnReg.className = 'flex-1 py-2 rounded-md text-gray-400 hover:text-white transition';
                    fields.classList.add('hidden-app');
                    btnText.innerText = "ƒêƒÉng Nh·∫≠p";
                    $('#auth-form').dataset.mode = 'login';
                } else {
                    btnReg.className = 'flex-1 py-2 rounded-md bg-white/10 text-white transition';
                    btnLog.className = 'flex-1 py-2 rounded-md text-gray-400 hover:text-white transition';
                    fields.classList.remove('hidden-app');
                    btnText.innerText = "ƒêƒÉng K√Ω";
                    $('#auth-form').dataset.mode = 'register';
                }
            },
            handleSubmit: async (e) => {
                e.preventDefault();
                const email = $('#email').value;
                const password = $('#password').value;
                const mode = $('#auth-form').dataset.mode || 'login';

                try {
                    if (mode === 'login') {
                        await signInWithEmailAndPassword(auth, email, password);
                        toast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng', 'success');
                    } else {
                        const confirm = $('#confirm-password').value;
                        if (password !== confirm) return toast('M·∫≠t kh·∫©u kh√¥ng kh·ªõp', 'error');
                        await createUserWithEmailAndPassword(auth, email, password);
                        toast('ƒêƒÉng k√Ω th√†nh c√¥ng', 'success');
                    }
                } catch (err) {
                    toast(err.message, 'error');
                }
            }
        };

        // --- GAME LOGIC ---
        const Game = {
            init: () => {
                // Listen to latest result
                const q = query(collection(db, "results"), orderBy("createdAt", "desc"), limit(1));
                onSnapshot(q, (snapshot) => {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        Game.updateLastResult(data.number);
                        // Sync round time
                        if (data.nextDrawTime) {
                            nextDrawTime = data.nextDrawTime.toMillis ? data.nextDrawTime.toMillis() : Date.now() + 60000;
                        }
                    });
                    if(snapshot.empty) {
                        // First run default
                        nextDrawTime = Date.now() + 60000;
                    }
                });

                // Start Timer Loop
                setInterval(Game.tick, 1000);

                $('#place-bet-btn').onclick = Game.placeBet;
            },
            tick: () => {
                const now = Date.now();
                let diff = Math.ceil((nextDrawTime - now) / 1000);
                
                // Correction if sync issue
                if (diff < -5) { 
                    nextDrawTime = now + 60000; 
                    diff = 60;
                }

                if (diff <= 0 && !isSpinning) {
                    $('#timer').innerText = "0s";
                    Game.spin();
                } else {
                    $('#timer').innerText = (diff > 0 ? diff : 0) + "s";
                }
            },
            spin: async () => {
                isSpinning = true;
                const digits = document.querySelectorAll('.slot-digit');
                digits.forEach(d => d.classList.add('rolling'));
                
                // Play animation for 3 seconds
                await new Promise(r => setTimeout(r, 3000));
                
                // Normally this result comes from Server/Admin
                // We wait for Firestore update. If admin is online, they write it.
                // If we are admin, we write it.
                if (currentUser && currentUser.email === ADMIN_EMAIL && Admin.autoLoop) {
                     Admin.generateResult(); 
                }
            },
            updateLastResult: (numberStr) => {
                const digits = document.querySelectorAll('.slot-digit');
                const str = String(numberStr).padStart(6, '0');
                
                digits.forEach((d, i) => {
                    d.classList.remove('rolling');
                    d.querySelector('span').innerText = str[i];
                });
                isSpinning = false;
                
                // Check if user won recently (Local notification)
                // This is simplified. Real check in History.
            },
            placeBet: async () => {
                if(!currentUser) return;
                const number = $('#bet-number').value;
                const amount = parseInt($('#bet-amount').value);

                if (!number || number.length !== 6) return toast('Vui l√≤ng nh·∫≠p 6 ch·ªØ s·ªë', 'error');
                if (!amount || amount < 1000) return toast('C∆∞·ª£c t·ªëi thi·ªÉu 1.000ƒë', 'error');
                if (userData.balance < amount) return toast('S·ªë d∆∞ kh√¥ng ƒë·ªß', 'error');

                try {
                    // Transaction: Deduct Money -> Save Bet
                    await runTransaction(db, async (transaction) => {
                        const userRef = doc(db, "users", currentUser.uid);
                        const userDoc = await transaction.get(userRef);
                        if(userDoc.data().balance < amount) throw "S·ªë d∆∞ kh√¥ng ƒë·ªß";

                        const newBalance = userDoc.data().balance - amount;
                        transaction.update(userRef, { balance: newBalance });
                        
                        const betRef = doc(collection(db, "bets"));
                        transaction.set(betRef, {
                            userId: currentUser.uid,
                            email: currentUser.email,
                            number: number,
                            amount: amount,
                            createdAt: serverTimestamp(),
                            status: 'pending', // pending, won, lost
                            roundTime: nextDrawTime
                        });
                    });
                    
                    toast('ƒê·∫∑t c∆∞·ª£c th√†nh c√¥ng!', 'success');
                    $('#bet-number').value = '';
                } catch (e) {
                    toast('L·ªói: ' + e, 'error');
                }
            }
        };

        // --- WALLET LOGIC ---
        const Wallet = {
            init: () => {
                // Listen to transactions
                const q = query(collection(db, "transactions"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(10));
                onSnapshot(q, (snapshot) => {
                    const list = $('#transaction-list');
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        const date = t.createdAt ? new Date(t.createdAt.seconds * 1000).toLocaleString() : 'Just now';
                        const color = t.status === 'completed' ? 'text-green-400' : (t.status === 'pending' ? 'text-yellow-400' : 'text-red-400');
                        list.innerHTML += `
                            <tr>
                                <td class="p-4 text-gray-400">${date}</td>
                                <td class="p-4 uppercase">${t.type}</td>
                                <td class="p-4 font-bold">${formatMoney(t.amount)}</td>
                                <td class="p-4 ${color}">${t.status}</td>
                            </tr>
                        `;
                    });
                });

                $('#btn-deposit').onclick = async () => {
                    const amount = parseInt($('#deposit-amount').value);
                    if(!amount || amount < 10000) return toast('N·∫°p t·ªëi thi·ªÉu 10.000ƒë', 'error');

                    await addDoc(collection(db, "transactions"), {
                        userId: currentUser.uid,
                        email: currentUser.email,
                        type: 'deposit',
                        amount: amount,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    toast('ƒê√£ g·ª≠i y√™u c·∫ßu n·∫°p ti·ªÅn. Vui l√≤ng ƒë·ª£i Admin duy·ªát.', 'success');
                    $('#deposit-amount').value = '';
                };
                
                // Get Bank Config
                getDoc(doc(db, "settings", "bank")).then(doc => {
                    if(doc.exists()) $('#bank-info-display').innerText = doc.data().info;
                });
            }
        };

        // --- HISTORY & STATS ---
        const History = {
            init: () => {
                const q = query(collection(db, "bets"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20));
                onSnapshot(q, (snapshot) => {
                    const list = $('#bet-history-list');
                    list.innerHTML = '';
                    let wins = 0; let totalBet = 0; let totalWin = 0; let count = 0;

                    snapshot.forEach(doc => {
                        const b = doc.data();
                        count++;
                        totalBet += b.amount;
                        if(b.status === 'won') {
                            wins++;
                            totalWin += (b.winAmount || 0);
                        }

                        const date = b.createdAt ? new Date(b.createdAt.seconds * 1000).toLocaleTimeString() : '';
                        const statusClass = b.status === 'won' ? 'text-green-400 font-bold' : (b.status === 'pending' ? 'text-gray-400' : 'text-red-400');
                        
                        list.innerHTML += `
                            <tr>
                                <td class="p-4 text-gray-500">${date}</td>
                                <td class="p-4 font-mono tracking-wider">${b.number}</td>
                                <td class="p-4">${b.result || '-'}</td>
                                <td class="p-4">${formatMoney(b.amount)}</td>
                                <td class="p-4 ${statusClass}">${b.status === 'won' ? '+' + formatMoney(b.winAmount) : b.status}</td>
                            </tr>
                        `;
                    });

                    Stats.update(wins, count - wins, totalBet, totalWin, count);
                });
            }
        };

        const Stats = {
            chart: null,
            init: () => {
                const ctx = document.getElementById('winLossChart').getContext('2d');
                Stats.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Th·∫Øng', 'Thua'],
                        datasets: [{
                            data: [0, 1],
                            backgroundColor: ['#4ade80', '#f87171'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: 'white' } } } }
                });
            },
            update: (wins, losses, moneyBet, moneyWin, count) => {
                if(Stats.chart) {
                    Stats.chart.data.datasets[0].data = [wins, losses];
                    Stats.chart.update();
                }
                $('#stat-total-bet').innerText = formatMoney(moneyBet);
                $('#stat-total-win').innerText = formatMoney(moneyWin);
                $('#stat-count').innerText = count;
            }
        };

        // --- ADMIN ---
        const Admin = {
            autoLoop: false,
            init: () => {
                // Listen pending deposits
                const qDep = query(collection(db, "transactions"), where("status", "==", "pending"));
                onSnapshot(qDep, (snap) => {
                    $('#admin-pending-deposits').innerText = snap.size;
                    const list = $('#admin-deposit-list');
                    list.innerHTML = '';
                    snap.forEach(d => {
                        const data = d.data();
                        const btnId = `approve-${d.id}`;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-2">${data.email}</td>
                            <td class="p-2 font-bold">${formatMoney(data.amount)}</td>
                            <td class="p-2 text-xs">${new Date(data.createdAt.seconds*1000).toLocaleTimeString()}</td>
                            <td class="p-2"><button class="bg-green-600 px-2 py-1 rounded text-xs" onclick="AdminUI.approve('${d.id}', '${data.userId}', ${data.amount})">Duy·ªát</button></td>
                        `;
                        list.appendChild(tr);
                    });
                });

                // Stats
                onSnapshot(collection(db, "users"), snap => $('#admin-total-users').innerText = snap.size);
                
                // Users List
                AdminUI.loadUsers();

                // Config
                $('#save-config-btn').onclick = () => {
                    setDoc(doc(db, "settings", "bank"), { info: $('#admin-bank-config').value });
                    toast('ƒê√£ l∆∞u c·∫•u h√¨nh', 'success');
                };
                
                // Toggle Loop
                $('#toggle-game-loop').onclick = () => {
                    Admin.autoLoop = !Admin.autoLoop;
                    $('#toggle-game-loop').innerText = Admin.autoLoop ? "ON" : "OFF";
                    $('#toggle-game-loop').className = Admin.autoLoop ? "px-4 py-2 bg-green-600 rounded text-xs font-bold" : "px-4 py-2 bg-gray-600 rounded text-xs font-bold";
                }
            },
            generateResult: async () => {
                // 1. Generate RNG
                const winNum = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
                const nextTime = new Date(Date.now() + 60000);
                
                // 2. Save Result
                const resRef = await addDoc(collection(db, "results"), {
                    number: winNum,
                    createdAt: serverTimestamp(),
                    nextDrawTime: nextTime
                });

                // 3. Check Winners (Client-side implementation of server logic)
                const qBets = query(collection(db, "bets"), where("status", "==", "pending"));
                const snap = await getDocs(qBets);
                
                snap.forEach(async (betDoc) => {
                    const b = betDoc.data();
                    let winAmount = 0;
                    let status = 'lost';

                    // Rule: Exact 6 digits (x90), Last 2 digits (x3.5)
                    if (b.number === winNum) {
                        winAmount = b.amount * 90;
                        status = 'won';
                    } else if (b.number.slice(-2) === winNum.slice(-2)) {
                        winAmount = b.amount * 3.5;
                        status = 'won';
                    }

                    // Update Bet
                    await updateDoc(doc(db, "bets", betDoc.id), {
                        status: status,
                        result: winNum,
                        winAmount: winAmount
                    });

                    // Update Balance if Won
                    if (status === 'won') {
                         const userRef = doc(db, "users", b.userId);
                         // Use transaction for safety
                         await runTransaction(db, async (t) => {
                             const u = await t.get(userRef);
                             const bal = u.data().balance || 0;
                             t.update(userRef, { balance: bal + winAmount });
                         });
                         // Create Transaction Record
                         addDoc(collection(db, "transactions"), {
                             userId: b.userId,
                             type: 'win_reward',
                             amount: winAmount,
                             status: 'completed',
                             createdAt: serverTimestamp()
                         });
                    }
                });
            }
        };

        // Needs to be global for HTML onclick access
        window.AdminUI = {
            switchSubTab: (tab) => {
                document.querySelectorAll('.admin-subtab').forEach(el => el.classList.add('hidden-app'));
                document.getElementById(`admin-sub-${tab}`).classList.remove('hidden-app');
            },
            loadUsers: () => {
                onSnapshot(collection(db, "users"), snap => {
                    const list = $('#admin-user-list');
                    list.innerHTML = '';
                    snap.forEach(u => {
                        const d = u.data();
                        list.innerHTML += `
                            <tr>
                                <td class="p-2 truncate max-w-[100px]">${d.email}</td>
                                <td class="p-2">${formatMoney(d.balance)}</td>
                                <td class="p-2"><button onclick="AdminUI.editUser('${u.id}')" class="text-blue-400"><i class="fa-solid fa-pen"></i></button></td>
                            </tr>
                        `;
                    });
                });
            },
            approve: async (transId, userId, amount) => {
                try {
                    await runTransaction(db, async (t) => {
                        // 1. Update Transaction
                        const transRef = doc(db, "transactions", transId);
                        t.update(transRef, { status: 'completed' });

                        // 2. Update User Balance
                        const userRef = doc(db, "users", userId);
                        const uDoc = await t.get(userRef);
                        const newBal = (uDoc.data().balance || 0) + amount;
                        t.update(userRef, { balance: newBal });
                    });
                    toast('ƒê√£ duy·ªát n·∫°p ti·ªÅn', 'success');
                } catch(e) { toast('L·ªói: ' + e, 'error'); }
            },
            editUser: (uid) => {
                const amount = prompt("Admin: C·ªông/Tr·ª´ ti·ªÅn user (nh·∫≠p s·ªë √¢m ƒë·ªÉ tr·ª´):");
                if(amount) {
                    const val = parseInt(amount);
                    if(isNaN(val)) return;
                    const userRef = doc(db, "users", uid);
                    getDoc(userRef).then(d => {
                         updateDoc(userRef, { balance: (d.data().balance || 0) + val });
                         toast('ƒê√£ c·∫≠p nh·∫≠t s·ªë d∆∞', 'success');
                    });
                }
            }
        };

        // --- UI MANAGER ---
        const UI = {
            switchTab: (tabName) => {
                // Hide all
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden-app'));
                // Show selected
                document.getElementById(`tab-content-${tabName}`).classList.remove('hidden-app');
            },
            updateUserInfo: (user, data) => {
                $('#user-email').innerText = user.email.split('@')[0];
                $('#user-balance').innerText = formatMoney(data.balance || 0);
                $('#wallet-balance-display').innerText = formatMoney(data.balance || 0);
                $('#wallet-id').innerText = user.uid.slice(0, 8);
                $('#user-avatar').innerText = user.email[0].toUpperCase();
            }
        };

        // Helper for quick bet buttons
        window.setQuickBet = (amt) => {
            $('#bet-amount').value = amt;
        };
        
        // Expose UI to global for onclicks
        window.UI = UI;

        // Init App
        Auth.init();

    </script>
</body>
</html>
