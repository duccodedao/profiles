
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro SpeedTest - Ki·ªÉm tra t·ªëc ƒë·ªô m·∫°ng</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           CSS VARIABLES & RESET
           ========================================= */
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --bg-light: #f3f4f6;
            --text-light: #1f2937;
            --glass-light: rgba(255, 255, 255, 0.8);
            --glass-border-light: rgba(255, 255, 255, 0.5);
            
            --bg-dark: #0f172a;
            --text-dark: #f8fafc;
            --glass-dark: rgba(15, 23, 42, 0.65);
            --glass-border-dark: rgba(255, 255, 255, 0.1);

            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode {
            --bg-color: var(--bg-dark);
            --text-color: var(--text-dark);
            --glass-bg: var(--glass-dark);
            --glass-border: var(--glass-border-dark);
        }

        body {
            --bg-color: var(--bg-light);
            --text-color: var(--text-light);
            --glass-bg: var(--glass-light);
            --glass-border: var(--glass-border-light);

            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: background-color 0.5s ease, color 0.5s ease;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Animated Background Blob */
        .bg-shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(90px);
            z-index: -1;
            animation: moveShape 12s infinite alternate ease-in-out;
        }
        .shape-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: var(--primary); opacity: 0.35; }
        .shape-2 { bottom: -10%; right: -10%; width: 400px; height: 400px; background: var(--secondary); opacity: 0.3; animation-delay: -5s; }
        .shape-3 { top: 40%; left: 40%; width: 300px; height: 300px; background: var(--accent); opacity: 0.25; animation-duration: 18s; }

        @keyframes moveShape {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(40px, 60px) scale(1.15); }
        }

        /* =========================================
           MAIN CONTAINER
           ========================================= */
        .app-container {
            width: 92%;
            max-width: 1000px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            box-shadow: var(--shadow);
            padding: 2.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        h1 { margin: 0; font-size: 1.8rem; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .controls { display: flex; gap: 12px; }
        .btn-icon {
            background: rgba(128,128,128,0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-icon:hover { background: rgba(128,128,128,0.25); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* =========================================
           GAUGE & CHART
           ========================================= */
        .main-display { display: flex; flex-direction: column; align-items: center; position: relative; }

        .gauge-container { position: relative; width: 300px; height: 300px; }
        svg.gauge { width: 100%; height: 100%; transform: rotate(-135deg); } /* Start from bottom left */
        
        circle { fill: none; stroke-width: 16; stroke-linecap: round; }
        .circle-bg { stroke: rgba(128, 128, 128, 0.15); stroke-dasharray: 816; stroke-dashoffset: 204; } /* 3/4 circle */
        .circle-progress {
            stroke: url(#gradient);
            stroke-dasharray: 816;
            stroke-dashoffset: 816;
            transition: stroke-dashoffset 0.3s ease-out;
        }

        .gauge-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; width: 100%;
        }
        
        .speed-value { font-size: 4.5rem; font-weight: 700; line-height: 1; letter-spacing: -1px; }
        .speed-unit { font-size: 1.2rem; opacity: 0.7; font-weight: 500; }
        .gauge-max { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; opacity: 0.4; }

        .status-text { margin-top: 5px; font-size: 1rem; font-weight: 500; color: var(--accent); text-transform: uppercase; letter-spacing: 1.5px; }

        canvas#realtimeChart { width: 100%; height: 80px; margin-top: 1rem; border-radius: 8px; }

        /* =========================================
           STATS GRID
           ========================================= */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.2rem; }
        .stat-card {
            background: rgba(128, 128, 128, 0.05);
            padding: 1.2rem; border-radius: 20px; border: 1px solid var(--glass-border);
            text-align: center; transition: var(--transition);
        }
        .stat-card.active { background: rgba(99, 102, 241, 0.15); border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.1); }
        .stat-label { font-size: 0.9rem; opacity: 0.7; display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 500; }
        .stat-value { font-size: 1.8rem; font-weight: 700; margin-top: 8px; }
        .stat-unit { font-size: 0.85rem; opacity: 0.5; }

        /* =========================================
           NETWORK INFO & ACTIONS
           ========================================= */
        .network-details {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            background: rgba(128, 128, 128, 0.05); border: 1px solid var(--glass-border);
            padding: 15px 20px; border-radius: 16px; width: 100%; box-sizing: border-box;
        }

        .detail-item { display: flex; flex-direction: column; align-items: center; text-align: center; font-size: 0.95rem; }
        .detail-item svg { color: var(--secondary); margin-bottom: 5px; opacity: 0.9; }
        .detail-label { opacity: 0.5; font-size: 0.8rem; margin-bottom: 2px; }
        .detail-value { font-weight: 600; color: var(--text-color); }

        .action-area { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        
        .action-buttons { display: flex; gap: 15px; }

        .btn-start {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none; color: white; padding: 1rem 3.5rem; font-size: 1.3rem; font-weight: 600;
            border-radius: 50px; cursor: pointer; box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            transition: var(--transition);
        }
        .btn-start:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 30px rgba(99, 102, 241, 0.6); }
        .btn-start:disabled { background: #6b7280; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        .btn-share {
            background: rgba(128, 128, 128, 0.2); border: 1px solid var(--glass-border);
            color: var(--text-color); padding: 0 2rem; border-radius: 50px; cursor: pointer;
            font-weight: 600; display: none; align-items: center; gap: 8px; transition: var(--transition);
        }
        .btn-share:hover { background: rgba(128, 128, 128, 0.3); }

        .server-info { font-size: 0.9rem; opacity: 0.6; display: flex; align-items: center; gap: 6px; }

        /* =========================================
           MODAL HISTORY
           ========================================= */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.open { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: var(--bg-color); border: 1px solid var(--glass-border);
            padding: 2rem; border-radius: 24px; width: 90%; max-width: 650px; max-height: 85vh;
            overflow-y: auto; box-shadow: var(--shadow);
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; text-align: center; }
        th, td { padding: 12px; border-bottom: 1px solid rgba(128,128,128,0.2); }
        th { color: var(--primary); font-weight: 600; }
        .modal-footer { display: flex; justify-content: space-between; margin-top: 1.5rem; }

        /* =========================================
           RESPONSIVE
           ========================================= */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .gauge-container { width: 240px; height: 240px; }
            .speed-value { font-size: 3.5rem; }
        }
        @media (max-width: 550px) {
            .app-container { padding: 1.5rem; width: 95%; margin: 1rem 0; border-radius: 20px;}
            .network-details { grid-template-columns: 1fr; gap: 10px; text-align: left;}
            .detail-item { flex-direction: row; text-align: left; gap: 10px; }
            .detail-item svg { margin-bottom: 0; }
            .action-buttons { flex-direction: column; width: 100%; }
            .btn-start, .btn-share { width: 100%; padding: 1rem; justify-content: center;}
        }
    </style>
</head>
<body class="dark-mode">

    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <div class="app-container">
        <!-- Header -->
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary);"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                <h1>SpeedTest Pro</h1>
            </div>
            <div class="controls">
                <button class="btn-icon" id="toggleTheme" title="Ch·∫ø ƒë·ªô S√°ng/T·ªëi">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="themeIcon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                <button class="btn-icon" id="toggleHistory" title="L·ªãch s·ª≠">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"></path><circle cx="12" cy="12" r="10"></circle></svg>
                </button>
            </div>
        </header>

        <!-- Main Display -->
        <div class="main-display">
            <div class="gauge-container">
                <svg class="gauge" viewBox="0 0 300 300">
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="100%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color: var(--primary)" />
                            <stop offset="100%" style="stop-color: var(--accent)" />
                        </linearGradient>
                    </defs>
                    <circle class="circle-bg" cx="150" cy="150" r="130"></circle>
                    <circle class="circle-progress" id="progressCircle" cx="150" cy="150" r="130"></circle>
                </svg>
                <div class="gauge-content">
                    <span class="speed-value" id="mainSpeed">0.0</span>
                    <span class="speed-unit">Mbps</span>
                    <div class="status-text" id="statusText">Ready</div>
                </div>
                <div class="gauge-max" id="gaugeMaxText">0 - 100 Mbps</div>
            </div>
            <canvas id="realtimeChart"></canvas>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card" id="card-ping">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    Ping
                </div>
                <div class="stat-value" id="val-ping">--</div>
                <div class="stat-unit">ms</div>
            </div>
            <div class="stat-card" id="card-jitter">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--secondary)" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    Jitter
                </div>
                <div class="stat-value" id="val-jitter">--</div>
                <div class="stat-unit">ms</div>
            </div>
            <div class="stat-card" id="card-download">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Download
                </div>
                <div class="stat-value" id="val-download" style="color:#10b981">--</div>
                <div class="stat-unit">Mbps</div>
            </div>
            <div class="stat-card" id="card-upload">
                <div class="stat-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Upload
                </div>
                <div class="stat-value" id="val-upload" style="color:#8b5cf6">--</div>
                <div class="stat-unit">Mbps</div>
            </div>
        </div>

        <!-- Network Info & Action -->
        <div class="action-area">
            
            <div class="network-details">
                <div class="detail-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect><rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect><line x1="6" y1="6" x2="6.01" y2="6"></line><line x1="6" y1="18" x2="6.01" y2="18"></line></svg>
                    <span class="detail-label">IP Address</span>
                    <span class="detail-value" id="display-ip">ƒêang l·∫•y IP...</span>
                </div>
                <div class="detail-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span class="detail-label">Nh√† m·∫°ng (ISP)</span>
                    <span class="detail-value" id="display-isp">--</span>
                </div>
                <div class="detail-item">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <span class="detail-label">V·ªã tr√≠</span>
                    <span class="detail-value" id="display-location">--</span>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-start" id="startBtn">B·∫Øt ƒë·∫ßu ƒëo</button>
                <button class="btn-share" id="shareBtn" onclick="shareResult()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                    Chia s·∫ª
                </button>
            </div>
            
            <div class="server-info">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                <span>Server ƒë√≠ch: <strong id="serverName">ƒêang k·∫øt n·ªëi...</strong></span>
                <span id="connType" style="margin-left:10px; color:var(--accent)"></span>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>L·ªãch s·ª≠ ki·ªÉm tra</h2>
                <button class="btn-icon" onclick="document.getElementById('historyModal').classList.remove('open')">‚úï</button>
            </div>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th style="text-align: left;">Th·ªùi gian</th>
                        <th>Ping</th>
                        <th>Down</th>
                        <th>Up</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="modal-footer">
                <button onclick="exportCSV()" style="background:none; border:none; color: var(--accent); cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Xu·∫•t CSV
                </button>
                <button onclick="clearHistory()" style="background:none; border:none; color: #ef4444; cursor: pointer; font-weight: bold;">X√≥a t·∫•t c·∫£</button>
            </div>
        </div>
    </div>

    <script>
        const UI = {
            btnStart: document.getElementById('startBtn'),
            btnShare: document.getElementById('shareBtn'),
            mainSpeed: document.getElementById('mainSpeed'),
            statusText: document.getElementById('statusText'),
            serverName: document.getElementById('serverName'),
            progressCircle: document.getElementById('progressCircle'),
            chartCanvas: document.getElementById('realtimeChart'),
            gaugeMaxText: document.getElementById('gaugeMaxText'),
            displayIP: document.getElementById('display-ip'),
            displayISP: document.getElementById('display-isp'),
            displayLocation: document.getElementById('display-location'),
            connType: document.getElementById('connType'),
            cards: {
                ping: document.getElementById('card-ping'),
                jitter: document.getElementById('card-jitter'),
                download: document.getElementById('card-download'),
                upload: document.getElementById('card-upload'),
            },
            vals: {
                ping: document.getElementById('val-ping'),
                jitter: document.getElementById('val-jitter'),
                download: document.getElementById('val-download'),
                upload: document.getElementById('val-upload'),
            }
        };

        const CIRCLE_CIRCUMFERENCE = 816; // Approx 2*pi*130
        const VISIBLE_CIRCUMFERENCE = CIRCLE_CIRCUMFERENCE * 0.75; // We use 3/4 of the circle
        
        const SERVERS = ["VNPT - Hanoi", "Viettel - Ho Chi Minh", "FPT Telecom - Da Nang", "CMC Telecom - Hanoi"];

        let isTesting = false;
        let chartCtx = UI.chartCanvas.getContext('2d');
        let chartData = [];
        let resultData = { down: 0, up: 0, ping: 0 }; // L·ªØu t·∫°m k·∫øt qu·∫£ ƒë·ªÉ share

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            UI.progressCircle.style.strokeDashoffset = CIRCLE_CIRCUMFERENCE; 
            UI.serverName.innerText = SERVERS[Math.floor(Math.random() * SERVERS.length)] + ` [${Math.floor(Math.random()*50 + 5)}km]`;
            setupTheme();
            renderHistory();
            getNetworkInfo();
            checkConnectionType();
        });

        // --- API NETWORK INFO ---
        async function getNetworkInfo() {
            try {
                // S·ª≠ d·ª•ng ipinfo.io (·ªïn ƒë·ªãnh, free 50k req/th√°ng)
                const response = await fetch('https://ipinfo.io/json');
                const data = await response.json();
                
                UI.displayIP.innerText = data.ip;
                // C·∫Øt b·ªè ph·∫ßn "AS1234" ·ªü ƒë·∫ßu t√™n nh√† m·∫°ng n·∫øu c√≥
                let ispName = data.org || "Kh√¥ng x√°c ƒë·ªãnh";
                if(ispName.startsWith("AS")) ispName = ispName.substring(ispName.indexOf(' ') + 1);
                
                UI.displayISP.innerText = ispName;
                UI.displayLocation.innerText = `${data.city}, ${data.country}`;
            } catch (error) {
                console.error("L·ªói IP:", error);
                UI.displayIP.innerText = "·∫®n danh";
                UI.displayISP.innerText = "Kh√¥ng x√°c ƒë·ªãnh";
                UI.displayLocation.innerText = "Kh√¥ng x√°c ƒë·ªãnh";
            }
        }

        function checkConnectionType() {
            const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (conn) {
                UI.connType.innerText = `(${conn.effectiveType.toUpperCase()})`;
            }
        }

        // --- THEME ---
        function setupTheme() {
            const isDark = localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if(isDark) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
            updateThemeIcon();

            document.getElementById('toggleTheme').addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                updateThemeIcon();
            });
        }
        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            if(document.body.classList.contains('dark-mode')) {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            } else {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            }
        }

        // --- GAUGE LOGIC ---
        function setGaugeValue(speed) {
            // Dynamic scale
            let maxGauge = 100;
            if (speed > 80) maxGauge = 500;
            if (speed > 400) maxGauge = 1000;
            
            UI.gaugeMaxText.innerText = `0 - ${maxGauge} Mbps`;

            let percent = speed / maxGauge;
            if (percent > 1) percent = 1;

            // Offset calculation for 3/4 circle
            const offset = CIRCLE_CIRCUMFERENCE - (percent * VISIBLE_CIRCUMFERENCE);
            UI.progressCircle.style.strokeDashoffset = offset;
        }

        // --- CHART LOGIC (SMOOTH BEZIER CURVE) ---
        function resetChart() {
            chartData = [];
            UI.chartCanvas.width = UI.chartCanvas.offsetWidth * 2; // Hi-DPI
            UI.chartCanvas.height = UI.chartCanvas.offsetHeight * 2;
        }

        function pushChartData(value) {
            chartData.push(value);
            if (chartData.length > 40) chartData.shift(); 
            drawChart();
        }

        function drawChart() {
            const w = UI.chartCanvas.width;
            const h = UI.chartCanvas.height;
            chartCtx.clearRect(0, 0, w, h);
            
            if (chartData.length < 2) return;

            const maxVal = Math.max(...chartData, 50) * 1.2; // C·ªë ƒë·ªãnh t·ª∑ l·ªá Y ƒë·ª° b·ªã gi·∫≠t
            const stepX = w / (40 - 1); // C·ªë ƒë·ªãnh grid X

            chartCtx.beginPath();
            chartCtx.moveTo(0, h);
            
            let pts = chartData.map((val, i) => ({ x: i * stepX, y: h - (val / maxVal) * h }));
            
            chartCtx.lineTo(pts[0].x, pts[0].y);
            
            // Draw smooth curve
            for (let i = 0; i < pts.length - 1; i++) {
                let xc = (pts[i].x + pts[i+1].x) / 2;
                let yc = (pts[i].y + pts[i+1].y) / 2;
                chartCtx.quadraticCurveTo(pts[i].x, pts[i].y, xc, yc);
            }
            chartCtx.lineTo(pts[pts.length-1].x, pts[pts.length-1].y);

            // Stroke
            chartCtx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--primary');
            chartCtx.lineWidth = 4;
            chartCtx.stroke();

            // Fill Gradient
            chartCtx.lineTo(pts[pts.length-1].x, h);
            chartCtx.lineTo(0, h);
            chartCtx.closePath();

            let gradient = chartCtx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');
            chartCtx.fillStyle = gradient;
            chartCtx.fill();
        }

        // --- SIMULATION LOGIC ---
        UI.btnStart.addEventListener('click', async () => {
            if (isTesting) return;
            isTesting = true;
            UI.btnStart.disabled = true;
            UI.btnShare.style.display = 'none';
            resetChart();
            resetValues();

            // 1. PING & JITTER
            activateCard('ping');
            UI.statusText.innerText = 'ƒêang ƒëo Ping...';
            const ping = await simulateNumber(8, 25, 2000);
            UI.vals.ping.innerText = ping.toFixed(0);
            
            activateCard('jitter');
            const jitter = await simulateNumber(1, 5, 1500);
            UI.vals.jitter.innerText = jitter.toFixed(0);

            // 2. DOWNLOAD
            activateCard('download');
            UI.statusText.innerText = 'ƒêang t·∫£i xu·ªëng...';
            resetChart();
            const download = await simulateSpeedTest(250, 6000); 
            UI.vals.download.innerText = download.toFixed(1);

            // 3. UPLOAD
            activateCard('upload');
            UI.statusText.innerText = 'ƒêang t·∫£i l√™n...';
            resetChart();
            const upload = await simulateSpeedTest(120, 5000);
            UI.vals.upload.innerText = upload.toFixed(1);

            finishTest(ping, download, upload);
        });

        function resetValues() {
            UI.vals.ping.innerText = '--'; UI.vals.jitter.innerText = '--';
            UI.vals.download.innerText = '--'; UI.vals.upload.innerText = '--';
            UI.mainSpeed.innerText = '0.0';
            setGaugeValue(0);
            Object.values(UI.cards).forEach(c => c.classList.remove('active'));
        }

        function activateCard(type) {
            Object.values(UI.cards).forEach(c => c.classList.remove('active'));
            UI.cards[type].classList.add('active');
        }

        // Helper m√¥ ph·ªèng s·ªë nhanh (Ping, Jitter)
        function simulateNumber(min, max, duration) {
            return new Promise(resolve => {
                let start = Date.now();
                let timer = setInterval(() => {
                    let val = min + Math.random() * (max - min);
                    UI.mainSpeed.innerText = val.toFixed(0);
                    if (Date.now() - start > duration) {
                        clearInterval(timer);
                        resolve(val);
                    }
                }, 50);
            });
        }

        // Helper m√¥ ph·ªèng t·ªëc ƒë·ªô th·ª±c t·∫ø (C√≥ ƒë∆∞·ªùng cong l·∫•y ƒë√†)
        function simulateSpeedTest(targetMax, duration) {
            return new Promise(resolve => {
                let start = Date.now();
                let current = 0;
                let maxRandomTarget = targetMax * (0.8 + Math.random()*0.4); // Random x√™ d·ªãch t·ª´ target

                let timer = setInterval(() => {
                    let elapsed = Date.now() - start;
                    let progress = elapsed / duration;
                    
                    // Logic m∆∞·ª£t t·ªëc ƒë·ªô
                    if(progress < 0.3) {
                        current += (maxRandomTarget - current) * 0.1; // TƒÉng nhanh ban ƒë·∫ßu
                    } else {
                        current = maxRandomTarget + (Math.random() - 0.5) * (maxRandomTarget * 0.1); // Dao ƒë·ªông nh·∫π
                    }

                    UI.mainSpeed.innerText = current.toFixed(1);
                    setGaugeValue(current);
                    pushChartData(current);

                    if (elapsed >= duration) {
                        clearInterval(timer);
                        resolve(current);
                    }
                }, 50);
            });
        }

        function finishTest(ping, down, up) {
            isTesting = false;
            UI.btnStart.disabled = false;
            UI.statusText.innerText = 'Ho√†n t·∫•t';
            UI.btnStart.innerText = 'ƒêo l·∫°i';
            UI.btnShare.style.display = 'flex'; // Hi·ªán n√∫t Share
            Object.values(UI.cards).forEach(c => c.classList.remove('active'));
            setGaugeValue(0);

            resultData = { down: down.toFixed(1), up: up.toFixed(1), ping: ping.toFixed(0) };

            saveHistory({
                date: new Date().toLocaleString('vi-VN'),
                ping: resultData.ping,
                down: resultData.down,
                up: resultData.up
            });
        }

        // --- SHARE & EXPORT ---
        function shareResult() {
            const isp = UI.displayISP.innerText;
            const text = `üöÄ SpeedTest Pro K·∫øt qu·∫£:\nüîΩ Download: ${resultData.down} Mbps\nüîº Upload: ${resultData.up} Mbps\nüèì Ping: ${resultData.ping} ms\nüåê ISP: ${isp}`;
            
            navigator.clipboard.writeText(text).then(() => {
                let originalText = UI.btnShare.innerHTML;
                UI.btnShare.innerHTML = `‚úì ƒê√£ copy`;
                setTimeout(() => UI.btnShare.innerHTML = originalText, 2000);
            });
        }

        function exportCSV() {
            const history = JSON.parse(localStorage.getItem('speedTestHistory') || '[]');
            if(history.length === 0) return alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
            
            let csvContent = "data:text/csv;charset=utf-8,Th·ªùi gian,Ping (ms),Download (Mbps),Upload (Mbps)\n";
            history.forEach(row => {
                csvContent += `"${row.date}",${row.ping},${row.down},${row.up}\n`;
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "speedtest_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- HISTORY LOGIC ---
        function saveHistory(result) {
            let history = JSON.parse(localStorage.getItem('speedTestHistory') || '[]');
            history.unshift(result);
            if (history.length > 20) history.pop(); // Save up to 20 tests
            localStorage.setItem('speedTestHistory', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('speedTestHistory') || '[]');
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; opacity:0.5; padding: 2rem;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            history.forEach(item => {
                const row = `
                    <tr>
                        <td style="text-align:left; font-size: 0.85rem; opacity: 0.8;">${item.date}</td>
                        <td style="font-weight: 500;">${item.ping}</td>
                        <td style="color: #10b981; font-weight: bold;">${item.down}</td>
                        <td style="color: #8b5cf6; font-weight: bold;">${item.up}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function clearHistory() {
            if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠?')) {
                localStorage.removeItem('speedTestHistory');
                renderHistory();
            }
        }

        document.getElementById('toggleHistory').addEventListener('click', () => {
            document.getElementById('historyModal').classList.add('open');
        });
    </script>
</body>
</html>
