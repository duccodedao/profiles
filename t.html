<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Tra Cứu Thông Tin BHYT</title>
    <style>
        /* CSS Styling */
        :root {
            --primary-color: #0056a3;
            --secondary-color: #f4f7fc;
            --border-color: #dce3f0;
            --text-color: #333;
            --error-color: #d9534f;
            --success-color: #5cb85c;
            --warning-color: #f0ad4e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .form-section, .patient-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 86, 163, 0.2);
        }

        .action-button {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        .action-button:hover:not(:disabled) {
            background-color: #004482;
        }

        .action-button:disabled {
            background-color: #a0b4c7;
            cursor: not-allowed;
        }

        #status {
            text-align: center;
            margin: 20px 0;
            padding: 12px;
            border-radius: 4px;
            font-weight: 500;
            display: none;
        }
        .status-loading { background-color: #e6f7ff; border: 1px solid #91d5ff; color: #096dd9; }
        .status-error { background-color: #fff1f0; border: 1px solid #ffa39e; color: var(--error-color); }

        .results-container {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .info-card {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
        }

        .info-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            line-height: 1.6;
        }
        
        .info-item strong {
            display: block;
            color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--secondary-color);
            font-weight: 600;
        }

        .result-code {
            padding: 10px;
            font-weight: bold;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 15px;
        }
        .code-000 { background-color: #f6ffed; border: 1px solid #b7eb8f; color: var(--success-color); }
        .code-error { background-color: #fffbe6; border: 1px solid #ffe58f; color: var(--warning-color); }
        
        .cors-warning {
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            color: #faad14;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>Tra cứu thông tin Bảo hiểm Y tế</h1>

        <div class="cors-warning">
            <strong>LƯU Ý QUAN TRỌNG:</strong> Để trang web hoạt động, bạn cần cài đặt và bật một tiện ích mở rộng (extension) CORS cho trình duyệt. Ví dụ: "CORS Unblock" hoặc "Allow CORS".
        </div>

        <div class="form-section">
            <div class="form-grid">
                <div class="form-group">
                    <label for="username">Tên đăng nhập (API):</label>
                    <input type="text" id="username" placeholder="Tài khoản API do BHXH cấp">
                </div>
                <div class="form-group">
                    <label for="password">Mật khẩu (API):</label>
                    <input type="password" id="password" placeholder="Mật khẩu API do BHXH cấp">
                </div>
            </div>
        </div>

        <div class="patient-section">
             <div class="form-grid">
                <div class="form-group">
                    <label for="maThe">Mã thẻ BHYT:</label>
                    <input type="text" id="maThe" placeholder="VD: GD479793119xxxx">
                </div>
                <div class="form-group">
                    <label for="hoTen">Họ và tên:</label>
                    <input type="text" id="hoTen" placeholder="VD: NGUYỄN VĂN A">
                </div>
                <div class="form-group">
                    <label for="ngaySinh">Ngày sinh:</label>
                    <input type="text" id="ngaySinh" placeholder="Định dạng DD/MM/YYYY hoặc YYYY">
                </div>
            </div>
        </div>

        <button id="lookupBtn" class="action-button">Tra Cứu</button>

        <div id="status"></div>

        <div id="results" class="results-container"></div>
    </div>

    <script>
        // JavaScript Logic
        const API_BASE_URL = "http://egw.baohiemxahoi.gov.vn";

        // Định nghĩa các mã kết quả trả về từ API theo tài liệu
        const KET_QUA_MAP = {
            "000": "Thẻ còn giá trị sử dụng",
            "001": "Thẻ do BHXH Bộ Quốc Phòng quản lý, đề nghị kiểm tra thẻ và thông tin giấy tờ tùy thân",
            "002": "Thẻ do BHXH Bộ Công An quản lý, đề nghị kiểm tra thẻ và thông tin giấy tờ tùy thân",
            "003": "Thẻ cũ hết giá trị sử dụng nhưng đã được cấp thẻ mới",
            "004": "Thẻ cũ còn giá trị sử dụng nhưng đã được cấp thẻ mới",
            "010": "Thẻ hết giá trị sử dụng",
            "051": "Mã thẻ không đúng",
            "052": "Mã tỉnh cấp thẻ (kí tự thứ 4,5 của mã thẻ) không đúng",
            "053": "Mã quyền lợi thẻ (kí tự thứ 3 của mã thẻ) không đúng",
            "050": "Không thấy thông tin thẻ BHYT",
            "060": "Thẻ sai họ tên",
            "061": "Thẻ sai họ tên (đúng kí tự đầu)",
            "070": "Thẻ sai ngày sinh",
            "100": "Lỗi khi lấy dữ liệu số thẻ",
            "101": "Lỗi server",
            "110": "Thẻ đã thu hồi",
            "120": "Thẻ đã báo giảm",
            "121": "Thẻ đã báo giảm. Giảm chuyển ngoại tỉnh",
            "122": "Thẻ đã báo giảm. Giảm chuyển nội tỉnh",
            "123": "Thẻ đã báo giảm. Thu hồi do tăng lại cùng đơn vị",
            "124": "Thẻ đã báo giảm. Ngừng tham gia",
            "130": "Trẻ em không xuất trình thẻ",
            "205": "Lỗi sai định dạng tham số truyền vào",
            "401": "Lỗi xác thực tài khoản"
        };

        const lookupBtn = document.getElementById('lookupBtn');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        lookupBtn.addEventListener('click', handleLookup);

        async function handleLookup() {
            // Lấy dữ liệu từ input
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const maThe = document.getElementById('maThe').value.trim();
            const hoTen = document.getElementById('hoTen').value.trim();
            const ngaySinh = document.getElementById('ngaySinh').value.trim();

            // Kiểm tra dữ liệu đầu vào
            if (!username || !password || !maThe || !hoTen || !ngaySinh) {
                showStatus("Vui lòng nhập đầy đủ thông tin!", 'error');
                return;
            }

            // Vô hiệu hóa nút bấm và hiển thị trạng thái đang tải
            lookupBtn.disabled = true;
            lookupBtn.textContent = 'Đang tra cứu...';
            showStatus("Đang xử lý, vui lòng chờ...", 'loading');
            resultsDiv.innerHTML = '';

            try {
                // Bước 1: Lấy Token xác thực
                const tokenData = await getToken(username, password);
                if (!tokenData || !tokenData.APIKey || !tokenData.APIKey.access_token) {
                    throw new Error("Xác thực không thành công. Vui lòng kiểm tra lại Tên đăng nhập và Mật khẩu.");
                }

                // Bước 2: Tra cứu thông tin BHYT với token đã lấy
                const historyData = await getBHYTHistory(tokenData.APIKey, username, password, { maThe, hoTen, ngaySinh });
                
                // Bước 3: Hiển thị kết quả
                renderResults(historyData);

            } catch (error) {
                console.error("Lỗi trong quá trình tra cứu:", error);
                showStatus(`Đã xảy ra lỗi: ${error.message}. Vui lòng kiểm tra lại thông tin, kết nối mạng và đảm bảo đã bật Extension CORS.`, 'error');
            } finally {
                // Kích hoạt lại nút bấm
                lookupBtn.disabled = false;
                lookupBtn.textContent = 'Tra Cứu';
            }
        }
        
        // Hàm gọi API để lấy token
        async function getToken(username, password) {
            const url = `${API_BASE_URL}/api/token/take`;
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            });

            if (!response.ok) {
                throw new Error(`Lỗi lấy token: ${response.statusText}`);
            }
            return response.json();
        }

        // Hàm gọi API để tra cứu lịch sử KCB
        async function getBHYTHistory(apiKey, username, password, patientInfo) {
            const params = new URLSearchParams({
                token: apiKey.access_token,
                id_token: apiKey.id_token,
                username: username,
                password: password.toUpperCase() // Theo tài liệu, password ở request này cần viết hoa
            });
            
            const url = `${API_BASE_URL}/api/egw/NhanLichSuKCB2018?${params.toString()}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    maThe: patientInfo.maThe,
                    hoTen: patientInfo.hoTen,
                    ngaySinh: patientInfo.ngaySinh
                })
            });

            if (!response.ok) {
                throw new Error(`Lỗi tra cứu lịch sử: ${response.statusText}`);
            }
            return response.json();
        }

        // Hàm hiển thị kết quả ra giao diện
        function renderResults(data) {
            statusDiv.style.display = 'none';
            resultsDiv.innerHTML = '';
            
            if (!data) {
                showStatus("Không nhận được dữ liệu trả về.", 'error');
                return;
            }

            const maKetQua = data.maKetQua;
            const message = KET_QUA_MAP[maKetQua] || "Mã kết quả không xác định.";
            const resultCodeClass = maKetQua === "000" ? "code-000" : "code-error";
            
            let html = `<div class="result-code ${resultCodeClass}"><strong>${maKetQua}</strong>: ${message}</div>`;
            
            // Chỉ hiển thị thông tin chi tiết nếu tra cứu thành công hoặc có thông tin trả về
            if (data.hoTen) {
                html += `
                    <div class="info-card">
                        <h3>Thông tin thẻ BHYT</h3>
                        <div class="info-grid">
                            <div class="info-item"><strong>Họ tên:</strong> ${data.hoTen || ''}</div>
                            <div class="info-item"><strong>Ngày sinh:</strong> ${data.ngaySinh || ''}</div>
                            <div class="info-item"><strong>Giới tính:</strong> ${data.gioiTinh || ''}</div>
                            <div class="info-item"><strong>Địa chỉ:</strong> ${data.diaChi || ''}</div>
                            <div class="info-item"><strong>Mã thẻ:</strong> ${data.maThe || ''}</div>
                            <div class="info-item"><strong>Nơi ĐK KCB BĐ:</strong> ${data.maDKBD || ''}</div>
                            <div class="info-item"><strong>Giá trị từ:</strong> ${data.gtTheTu || ''}</div>
                            <div class="info-item"><strong>Giá trị đến:</strong> ${data.gtTheDen || ''}</div>
                            <div class="info-item"><strong>Ngày đủ 5 năm:</strong> ${data.ngayDu5Nam || ''}</div>
                        </div>
                    </div>
                `;
            }

            // Hiển thị lịch sử khám chữa bệnh
            html += `
                <div class="info-card">
                    <h3>Lịch sử khám chữa bệnh (dsLichSuKCB2018)</h3>
            `;
            if (data.dsLichSuKCB2018 && data.dsLichSuKCB2018.length > 0) {
                html += `
                    <table>
                        <thead>
                            <tr>
                                <th>Mã CSKCB</th>
                                <th>Ngày vào</th>
                                <th>Ngày ra</th>
                                <th>Tên bệnh</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.dsLichSuKCB2018.map(item => `
                                <tr>
                                    <td>${item.maCSKCB}</td>
                                    <td>${formatDateTime(item.ngayVao)}</td>
                                    <td>${formatDateTime(item.ngayRa)}</td>
                                    <td>${item.tenBenh}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                html += '<p>Không có dữ liệu lịch sử khám chữa bệnh.</p>';
            }
            html += '</div>';

            // Hiển thị lịch sử tra cứu thẻ
            html += `
                <div class="info-card">
                    <h3>Lịch sử tra cứu thẻ (dsLichSuKT2018)</h3>
            `;
            if (data.dsLichSuKT2018 && data.dsLichSuKT2018.length > 0) {
                 html += `
                    <table>
                        <thead>
                            <tr>
                                <th>User tra cứu</th>
                                <th>Thời gian</th>
                                <th>Thông báo</th>
                                <th>Mã lỗi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.dsLichSuKT2018.map(item => `
                                <tr>
                                    <td>${item.userKT}</td>
                                    <td>${formatDateTime(item.thoiGianKT)}</td>
                                    <td>${item.thongBao}</td>
                                    <td>${item.maLoi}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                 html += '<p>Không có dữ liệu lịch sử tra cứu thẻ.</p>';
            }
            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        // Hàm hiển thị thanh trạng thái
        function showStatus(message, type = 'loading') {
            statusDiv.textContent = message;
            statusDiv.className = `status-${type}`;
            statusDiv.style.display = 'block';
        }

        // Hàm định dạng ngày giờ từ yyyyMMddhhmm sang dd/MM/yyyy hh:mm
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr || dateTimeStr.length < 12) return dateTimeStr;
            const year = dateTimeStr.substring(0, 4);
            const month = dateTimeStr.substring(4, 6);
            const day = dateTimeStr.substring(6, 8);
            const hour = dateTimeStr.substring(8, 10);
            const minute = dateTimeStr.substring(10, 12);
            return `${day}/${month}/${year} ${hour}:${minute}`;
        }
    </script>
</body>
</html>
