<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bmass Profiles</title>

    <!-- Meta SEO, Libraries, Fonts -->
    <meta name="description" content="Tạo và chia sẻ trang cá nhân Web3 của bạn một cách dễ dàng.">
    <link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

</head>
<style>
    :root {
        --accent-primary: #915EFF;
        --accent-secondary: #2BCBC4;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --color-verified: #007bff;
        --card-bg: rgba(255, 255, 255, 0.1);
        --transition-smooth: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        --shadow-light: 0 4px 15px rgba(0,0,0,0.07);
        --shadow-strong: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }

    body {
        font-family: 'Poppins', sans-serif;
        color: var(--text-primary);
        transition: background-color 0.3s;
        overflow: hidden;
        margin: 0;
    }
    
    #particles-js {
        position: fixed;
        width: 100%;
        height: 100%;
        z-index: -1;
        background-color: #000000;
        background-image: linear-gradient(45deg, #000000 0%, #1a0a24 100%);
    }

    /* === Header & Sidebar === */
    .header-controls { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1050; }
    .sidebar-toggle {
        background: white; border: none; border-radius: 50%; width: 50px; height: 50px;
        font-size: 1.2rem; box-shadow: var(--shadow-light); transition: var(--transition-smooth);
        display: flex; align-items: center; justify-content: center;
    }
    .sidebar-toggle:hover { transform: scale(1.1); box-shadow: var(--shadow-strong); }
    .sidebar {
        position: fixed; top: 0; left: 0; height: 100%; width: 280px;
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); z-index: 1051;
        transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 0 50px rgba(0,0,0,0.1); padding: 2rem 1.5rem; display: flex; flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { font-weight: 600; font-size: 1.5rem; margin-bottom: 2rem; }
    .sidebar-link {
        display: block; padding: 0.8rem 1rem; border-radius: 10px; color: var(--text-primary);
        text-decoration: none; font-weight: 500; margin-bottom: 0.5rem; transition: background-color 0.3s, color 0.3s;
    }
    .sidebar-link:hover { background-color: #f0f2f5; }
    .sidebar-link i { margin-right: 12px; width: 20px; text-align: center; }
    .sidebar-link.logout { margin-top: auto; color: #dc3545; }
    .sidebar-link.logout:hover { background-color: #fdf2f3; }
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4);
        z-index: 1045; opacity: 0; visibility: hidden; transition: opacity 0.4s, visibility 0.4s;
    }
    .overlay.show { opacity: 1; visibility: visible; }

    /* === Main Container & Views === */
    .main-container { padding: 2rem 1rem; margin: auto; height: 100vh; overflow-y: auto; }
    .view { display: none; animation: fadeIn 0.6s; }
    .view-center-content {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }
    #email-verification-banner {
        position: sticky;
        top: 0;
        z-index: 1040;
    }

    /* === Profile View === */
    .card-glass {
        position: relative; background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 25px; padding: 2rem; box-shadow: var(--shadow-strong); color: #fff;
    }
    .profile-avatar { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.15); margin-top: -95px; }
    .profile-name-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; }
    .profile-name { font-size: 2rem; font-weight: 700; margin-bottom: 0; }
    .verified-tick { color: var(--color-verified); font-size: 1.6rem; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
    .social-links { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; }
    .social-link { font-size: 1.5rem; color: #fff; transition: var(--transition-smooth); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); text-decoration: none; }
    .social-link:hover { transform: translateY(-5px); color: white; background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); box-shadow: 0 4px 15px rgba(145, 94, 255, 0.4); }
    .project-card { display: flex; align-items: center; text-decoration: none; color: var(--text-primary); background: rgba(255, 255, 255, 0.9); padding: 1rem; border-radius: 15px; border: 1px solid #dee2e6; transition: var(--transition-smooth); box-shadow: var(--shadow-light); }
    .project-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px rgba(145, 94, 255, 0.15); border-color: var(--accent-primary); }
    .project-icon { width: 64px; height: 64px; border-radius: 12px; object-fit: cover; margin-right: 1rem; flex-shrink: 0; }
    #edit-profile-btn { position: absolute; bottom: -25px; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: white; font-size: 1.5rem; display: none; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.3s; }
    #edit-profile-btn:hover { transform: scale(1.1); }
    
    /* *** NEW STYLES for Project Clicks *** */
    .project-card-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-start;
        flex-grow: 1;
        min-height: 64px; /* Match icon height */
    }
    .project-clicks {
        align-self: flex-end;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 8px;
    }

    /* === Category Tabs Styling === */
    .category-tabs-container {
        padding: 1rem 0;
        margin-top: 2rem;
        position: relative;
    }
    .category-tabs {
        display: flex;
        justify-content: center;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
    }
    .category-tab {
        padding: 10px 20px;
        cursor: pointer;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
        font-size: 1rem;
        transition: color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .category-tab.active {
        color: #fff;
    }
    .category-tab:hover {
        color: #fff;
    }
    .rename-category-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        padding: 0;
        margin-left: 0;
        font-size: 0.8em;
        opacity: 0;
        transition: opacity 0.3s, color 0.3s;
    }
    .category-tab:hover .rename-category-btn {
        opacity: 1;
    }
    .rename-category-btn:hover {
        color: var(--accent-secondary);
    }
    #add-category-btn {
        background-color: rgba(255,255,255,0.1);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        margin-left: 15px;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tab-underline {
        position: absolute;
        bottom: -1px;
        left: 0;
        height: 3px;
        background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 3px;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .category-content-container { padding-top: 1.5rem; }
    .category-content { display: none; animation: fadeInUp 0.5s; }
    .category-content.active { display: block; }

    /* === Auth Views: Flip Card & Forms === */
    .flip-card {
        background-color: transparent; width: 100%; max-width: 420px;
        height: 620px;
    }
    .flip-card-inner {
        position: relative; width: 100%; height: 100%; text-align: center;
        transition: transform 0.8s; transform-style: preserve-3d;
    }
    .flip-card.is-flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back {
        position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden;
        border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-strong);
        background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .flip-card-back { transform: rotateY(180deg); }
    .auth-header {
        background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        color: white; padding: 2rem;
    }
    .auth-header h2 { font-weight: 700; margin-bottom: 0.5rem;}
    .auth-body { padding: 1.5rem 2rem; }
    .form-control {
        border-radius: 10px; padding: 0.9rem 1rem; border: 1px solid rgba(255, 255, 255, 0.2);
        transition: border-color 0.3s, box-shadow 0.3s; background: rgba(255, 255, 255, 0.1); color: #fff;
    }
    .form-control::placeholder { color: rgba(255, 255, 255, 0.7); }
    .form-control:focus {
        border-color: var(--accent-primary); box-shadow: 0 0 0 0.25rem rgba(145, 94, 255, 0.25);
        background: rgba(255, 255, 255, 0.2);
    }
    .btn-submit-grad {
        background-size: 200% auto;
        background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-secondary) 51%, var(--accent-primary) 100%);
        border: none; border-radius: 10px; padding: 0.9rem; font-weight: 600; color: white;
        width: 100%; transition: 0.5s;
    }
    .btn-submit-grad:hover { background-position: right center; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(145, 94, 255, 0.4); }
    .btn-google {
        background: #fff; color: #757575; border: 1px solid #ddd;
    }
    .btn-google:hover { background: #f8f8f8; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .auth-switch-link, .forgot-password-link {
        background: none; border: none; color: var(--accent-secondary); text-decoration: none;
        font-weight: 600; cursor: pointer; padding: 0;
    }
    .auth-switch-link:hover, .forgot-password-link:hover { text-decoration: underline; }
    #auth-status { min-height: 24px; margin-top: 1rem; color: #ffcdd2; }
    .divider { display: flex; align-items: center; text-align: center; color: rgba(255,255,255,0.5); margin: 1.5rem 0;}
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.2); }
    .divider:not(:empty)::before { margin-right: .5em; }
    .divider:not(:empty)::after { margin-left: .5em; }

    /* === General & Footer === */
    .footer-section { padding: 2rem 1rem; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin-top: 2rem; }
    .spinner-border { color: var(--accent-primary); }

    /* === FIX FOR MODAL INPUTS === */
    #editModal .modal-content, #changePasswordModal .modal-content {
        color: var(--text-primary);
    }
    #editModal .form-control, #changePasswordModal .modal-control, #editModal .form-select {
        background-color: #f8f9fa;
        color: var(--text-primary);
        border: 1px solid #ced4da;
    }
    #editModal .form-control::placeholder, #changePasswordModal .form-control::placeholder {
        color: #6c757d;
    }
    #editModal .form-control:focus, #changePasswordModal .form-control:focus, #editModal .form-select:focus {
        color: var(--text-primary);
        background-color: #fff;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 0.25rem rgba(145, 94, 255, 0.25);
    }
</style>
<body>
    <div id="particles-js"></div>
    <!-- Header Controls -->
    <div class="header-controls" id="header-controls"></div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <h3 class="sidebar-header">Bmass Profiles</h3>
        <div id="sidebar-links"></div>
    </div>
    <div class="overlay" id="overlay"></div>

    <main class="main-container" id="app-container">
        
        <input type="file" id="import-json-input" accept=".json" style="display: none;" />

        <!-- Email Verification Banner -->
        <div id="email-verification-banner" class="alert alert-warning rounded-3 m-3" style="display: none;">
            Email của bạn chưa được xác thực. Vui lòng kiểm tra hộp thư đến. 
            <button id="resend-verification-btn" class="btn btn-sm btn-primary ms-2">Gửi lại email</button>
        </div>

        <!-- Loading View -->
        <div class="view text-center" id="view-loading">
            <div class="spinner-border" style="width: 3rem; height: 3rem; color: white;"></div>
        </div>

        <!-- Auth View with Flip Card -->
        <div class="view view-center-content" id="view-auth">
            <div class="flip-card" id="auth-flip-card">
                <div class="flip-card-inner">
                    <!-- Login Form (Front) -->
                    <div class="flip-card-front">
                        <div class="auth-header">
                            <h2>Chào mừng trở lại!</h2>
                            <p class="mb-0">Đăng nhập để tiếp tục hành trình</p>
                        </div>
                        <div class="auth-body">
                            <form id="login-form">
                                <div class="mb-3"><input type="email" class="form-control" id="login-email" placeholder="Email" required></div>
                                <div class="mb-3"><input type="password" class="form-control" id="login-password" placeholder="Mật khẩu" required></div>
                                <div class="d-flex justify-content-end mb-3">
                                    <button type="button" class="forgot-password-link" id="forgot-password-btn">Quên mật khẩu?</button>
                                </div>
                                <div class="d-grid"><button type="submit" class="btn-submit-grad">Đăng nhập</button></div>
                            </form>
                            <div class="divider">HOẶC</div>
                            <div class="d-grid">
                                <button class="btn btn-light btn-google" id="google-login-btn">
                                    <img src="https://www.google.com/favicon.ico" alt="Google icon" width="20" height="20" class="me-2"> Đăng nhập với Google
                                </button>
                            </div>
                            <p class="mt-4 text-center text-white-50">
                                Chưa có tài khoản? <button class="auth-switch-link" id="show-register-btn">Đăng ký ngay</button>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Register Form (Back) -->
                    <div class="flip-card-back">
                         <div class="auth-header">
                            <h2>Tạo tài khoản mới</h2>
                            <p class="mb-0">Bắt đầu hành trình của bạn cùng chúng tôi</p>
                        </div>
                        <div class="auth-body">
                            <form id="register-form">
                                <div class="mb-3"><input type="text" class="form-control" id="register-username" placeholder="Username (a-z, 0-9, _)" required pattern="[a-zA-Z0-9_]{3,20}"></div>
                                <div class="mb-3"><input type="email" class="form-control" id="register-email" placeholder="Email" required></div>
                                <div class="mb-3"><input type="tel" class="form-control" id="register-phone" placeholder="Số điện thoại (Không bắt buộc)"></div>
                                <div class="mb-3"><input type="password" class="form-control" id="register-password" placeholder="Mật khẩu (tối thiểu 6 ký tự)" required minlength="6"></div>
                                <div class="d-grid mt-4"><button type="submit" class="btn-submit-grad">Đăng ký</button></div>
                            </form>
                            <p class="mt-4 text-center text-white-50">
                                Đã có tài khoản? <button class="auth-switch-link" id="show-login-btn">Đăng nhập</button>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="auth-status" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>
        </div>

        <!-- Forgot Password View -->
        <div class="view view-center-content" id="view-forgot-password">
            <div class="card-glass" style="width: 100%; max-width: 420px;">
                 <div class="auth-header" style="border-radius: 20px 20px 0 0; margin: -2rem -2rem 0 -2rem;">
                    <h2>Đặt lại mật khẩu</h2>
                    <p class="mb-0">Chọn phương thức để nhận liên kết</p>
                </div>
                <div class="auth-body">
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-4">
                        <button type="button" id="reset-mode-email-btn" class="btn btn-primary">
                            <i class="fas fa-envelope me-2"></i>Sử dụng Email
                        </button>
                        <button type="button" id="reset-mode-phone-btn" class="btn btn-outline-light">
                             <i class="fas fa-phone me-2"></i>Sử dụng SĐT
                        </button>
                    </div>

                    <form id="forgot-password-form">
                        <div id="reset-email-group">
                             <label class="form-label text-white-50">Email đã đăng ký</label>
                            <input type="email" class="form-control" id="reset-email-input" placeholder="Email của bạn">
                        </div>
                        <div id="reset-phone-group" style="display: none;">
                            <label class="form-label text-white-50">Số điện thoại đã đăng ký</label>
                            <input type="tel" class="form-control" id="reset-phone-input" placeholder="Số điện thoại của bạn">
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn-submit-grad">Gửi liên kết</button>
                        </div>
                    </form>
                    <p class="mt-4 text-center text-white-50">
                        <button class="auth-switch-link" id="back-to-login-btn">Quay lại Đăng nhập</button>
                    </p>
                </div>
            </div>
        </div>


        <!-- Profile View -->
        <div class="view" id="view-profile">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8" id="profile-page-content"></div>
            </div>
        </div>

        <!-- Not Found View -->
        <div class="view text-center" id="view-not-found">
            <div class="card-glass p-5">
                <h2>Không tìm thấy trang</h2>
                <p>Trang cá nhân bạn đang tìm kiếm không tồn tại.</p>
                <a href="/" class="btn btn-primary">Về trang chủ</a>
            </div>
        </div>
    </main>

    <footer class="text-center footer-section">
        <p class="mb-0">© <span id="footer-year"></span> Bmass Profiles. All Rights Reserved.</p>
    </footer>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Chỉnh sửa trang cá nhân</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="edit-modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" id="save-profile-btn" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Đổi mật khẩu</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="change-password-modal-body"></div>
                <div class="modal-footer" id="change-password-modal-footer"></div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    particlesJS("particles-js", {
        "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#ffffff" }, "shape": { "type": "circle", }, "opacity": { "value": 0.5, "random": false, }, "size": { "value": 3, "random": true, }, "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 6, "direction": "none", "out_mode": "out", } },
        "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" }, "resize": true }, "modes": { "repulse": { "distance": 200, "duration": 0.4 }, "push": { "particles_nb": 4 }, } },
        "retina_detect": true
    });

  const firebaseConfig = {
    apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
    authDomain: "profile-d1214.firebaseapp.com",
    projectId: "profile-d1214",
    storageBucket: "profile-d1214.firebasestorage.app",
    messagingSenderId: "914980131889",
    appId: "1:914980131889:web:72f8da15c42dbee671b110",
    measurementId: "G-C587M69LZW"
  };

    let auth, db, storage;
    let currentUser = null;
    let passwordResetMode = 'email'; 

    const views = { 
        loading: document.getElementById('view-loading'), 
        auth: document.getElementById('view-auth'), 
        profile: document.getElementById('view-profile'), 
        notFound: document.getElementById('view-not-found'),
        forgotPassword: document.getElementById('view-forgot-password') 
    };
    const headerControls = document.getElementById('header-controls');
    const profilePageContent = document.getElementById('profile-page-content');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
    const importJsonInput = document.getElementById('import-json-input'); 

    const socialIcons = { 
        github: 'fa-brands fa-github', x: 'fa-brands fa-xing', ig: 'fa-brands fa-instagram', 
        tele: 'fa-brands fa-telegram', tiktok: 'fa-brands fa-tiktok', youtube: 'fa-brands fa-youtube',
        discord: 'fa-brands fa-discord', zalo: 'fa-solid fa-comment-dots', gmail: 'fa-solid fa-envelope',
        channel: 'fa-solid fa-satellite-dish', website: 'fa-solid fa-globe' 
    };

    const defaultCategories = {
        project: 'Dự án ',
        exchange: 'Sàn giao dịch',
        airdrop: 'Airdrop'
    };
    
    const sidebar = document.getElementById('sidebar');
    const sidebarLinks = document.getElementById('sidebar-links');
    const overlay = document.getElementById('overlay');

    const authFlipCard = document.getElementById('auth-flip-card');
    const showRegisterBtn = document.getElementById('show-register-btn');
    const showLoginBtn = document.getElementById('show-login-btn');
    const statusEl = document.getElementById('auth-status');
    const verificationBanner = document.getElementById('email-verification-banner');


    function initializeFirebase() {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
    }

    function switchView(viewName) {
        Object.values(views).forEach(view => view.style.display = 'none');
        if (views[viewName]) {
            views[viewName].style.display = (views[viewName].classList.contains('view-center-content')) ? 'flex' : 'block';
        }
    }

    function showToast(message, type = 'danger') {
        const toastId = 'toast-' + Date.now();
        const toastHTML = `<div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
        statusEl.insertAdjacentHTML('beforeend', toastHTML);
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
    }

    function setupSidebar() {
        headerControls.innerHTML = `<button class="sidebar-toggle" id="sidebar-toggle-btn"><i class="fas fa-bars"></i></button>`;
        document.getElementById('sidebar-toggle-btn').addEventListener('click', toggleSidebar);

        if (currentUser) {
            sidebarLinks.innerHTML = `<a class="sidebar-link" href="?=${currentUser.username}"><i class="fas fa-user-circle"></i> Trang của tôi</a><a class="sidebar-link" href="#" id="copy-profile-link-btn"><i class="fas fa-copy"></i> Sao chép Link</a><a class="sidebar-link" href="#" id="change-password-btn"><i class="fas fa-key"></i> Đổi mật khẩu</a><hr><a class="sidebar-link" href="#" id="export-json-btn"><i class="fas fa-file-export"></i> Xuất JSON</a><a class="sidebar-link" href="#" id="import-json-btn"><i class="fas fa-file-import"></i> Nhập JSON</a><hr><a class="sidebar-link logout" href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>`;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('copy-profile-link-btn').addEventListener('click', handleCopyLink);
            document.getElementById('change-password-btn').addEventListener('click', openChangePasswordModal);
            document.getElementById('export-json-btn').addEventListener('click', handleExportJson);
            document.getElementById('import-json-btn').addEventListener('click', () => importJsonInput.click()); 
        } else {
            sidebarLinks.innerHTML = `<a class="sidebar-link" href="#" id="sidebar-login-btn"><i class="fas fa-sign-in-alt"></i> Đăng nhập</a><a class="sidebar-link" href="#" id="sidebar-register-btn"><i class="fas fa-user-plus"></i> Đăng ký</a>`;
            document.getElementById('sidebar-login-btn').addEventListener('click', (e) => { e.preventDefault(); closeSidebar(); history.pushState(null, '', '/'); switchView('auth'); authFlipCard.classList.remove('is-flipped'); });
            document.getElementById('sidebar-register-btn').addEventListener('click', (e) => { e.preventDefault(); closeSidebar(); history.pushState(null, '', '/'); switchView('auth'); authFlipCard.classList.add('is-flipped'); });
        }
        overlay.addEventListener('click', closeSidebar);
    }
    
    function handleCopyLink(e) { e.preventDefault(); const profileUrl = `${window.location.origin}${window.location.pathname}?=${currentUser.username}`; navigator.clipboard.writeText(profileUrl).then(() => { showToast("Link đã được sao chép!", "success"); closeSidebar(); }); }
    function toggleSidebar() { sidebar.classList.toggle('open'); overlay.classList.toggle('show'); }
    function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('show'); }
    
    async function handleExportJson(e) { e.preventDefault(); if (!currentUser) return; try { const docSnap = await db.collection('profiles').doc(currentUser.username).get(); if (!docSnap.exists) { showToast("Không tìm thấy dữ liệu hồ sơ."); return; } const data = docSnap.data(); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `bmass_profile_${currentUser.username}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); showToast("Đã xuất dữ liệu thành công!", "success"); closeSidebar(); } catch (error) { console.error("Lỗi khi xuất JSON:", error); showToast("Đã có lỗi xảy ra khi xuất dữ liệu."); } }
    async function handleImportJson(e) { const file = e.target.files[0]; if (!file) return; if (!confirm("Bạn có chắc chắn muốn nhập dữ liệu từ tệp này không? Mọi dữ liệu hồ sơ hiện tại (ngoại trừ username, email) sẽ bị ghi đè.")) return; const reader = new FileReader(); reader.onload = async (event) => { try { const importedData = JSON.parse(event.target.result); if (typeof importedData !== 'object' || importedData === null || !importedData.name) throw new Error("Tệp JSON không hợp lệ."); delete importedData.ownerUid; delete importedData.username; delete importedData.email; await db.collection('profiles').doc(currentUser.username).update(importedData); showToast("Nhập dữ liệu thành công! Trang sẽ được làm mới.", "success"); setTimeout(() => location.reload(), 1500); } catch (error) { console.error("Lỗi khi nhập JSON:", error); showToast("Lỗi: " + error.message); } finally { e.target.value = null; } }; reader.readAsText(file); closeSidebar(); }

    async function handleRouteChange() { const username = new URLSearchParams(window.location.search).get('user'); if (username) { await fetchAndRenderProfile(username); } else { if (currentUser) { history.pushState(null, '', `?=${currentUser.username}`); await fetchAndRenderProfile(currentUser.username); } else { switchView('auth'); } } }

    function getCategoryDisplayName(key, customCategories = {}) {
        if (defaultCategories[key]) {
            return defaultCategories[key];
        }
        if (customCategories[key]) {
            return customCategories[key];
        }
        return key.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function generateCategoryKey(name) { return name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-'); }
    
    async function fetchAndRenderProfile(username) {
        switchView('loading');
        try {
            const docSnap = await db.collection('profiles').doc(username).get();
            if (!docSnap.exists) { switchView('notFound'); return; }
            
            const data = docSnap.data();
            const isOwner = currentUser && currentUser.uid === data.ownerUid;

            let socialLinksHTML = '';
            for (const [key, url] of Object.entries(data.socials || {})) { if (url && socialIcons[key]) { const href = key === 'gmail' ? `mailto:${url}` : url; socialLinksHTML += `<a href="${href}" ${key !== 'gmail' ? 'target="_blank" rel="noopener noreferrer"' : ''} class="social-link" title="${key}"><i class="${socialIcons[key]}"></i></a>`; } }
            const profileInfoHTML = `<div class="card-glass text-center" style="padding-top: 80px;"><img src="${data.avatarUrl || 'https://via.placeholder.com/150'}" class="profile-avatar"><div class="profile-name-wrapper mt-3"><h1 class="profile-name">${data.name}</h1>${data.isVerified ? '<i class="fas fa-check-circle verified-tick" title="Đã xác thực"></i>' : ''}</div><p class="text-secondary col-md-10 mx-auto mt-2" style="color: rgba(255, 255, 255, 0.7) !important;">${data.bio}</p><div class="social-links">${socialLinksHTML}</div>${isOwner ? '<button id="edit-profile-btn" title="Chỉnh sửa"><i class="fas fa-pencil-alt"></i></button>' : ''}</div>`;
            
            const customCategories = data.customCategories || {}; 
            const allCategoryKeys = [...new Set([...Object.keys(defaultCategories), ...Object.keys(customCategories)])];
            const allProjects = data.projects || [];
            
            let tabsHTML = '';
            let contentHTML = '';

            allCategoryKeys.forEach(key => {
                const displayName = getCategoryDisplayName(key, customCategories);
                const isCustom = !defaultCategories.hasOwnProperty(key);
                const renameButton = isOwner && isCustom ? `<button class="rename-category-btn" data-category-key="${key}" title="Đổi tên danh mục"><i class="fas fa-pencil-alt"></i></button>` : '';
                tabsHTML += `<button class="category-tab" data-category="${key}"><span>${displayName}</span>${renameButton}</button>`;
                
                const projectsInCategory = allProjects.filter(p => (p.category || 'project') === key);
                let itemsHTML = '<p class="text-white-50">Chưa có mục nào trong danh mục này.</p>';
                if(projectsInCategory.length > 0) {
                    // *** MODIFIED: HTML structure for project card with clicks counter ***
                    itemsHTML = projectsInCategory.map(p => {
                        const projectIndex = allProjects.indexOf(p); // Get the absolute index
                        return `<div class="col-12 col-md-6 mb-3">
                            <a href="#" data-link="${p.link}" data-project-index="${projectIndex}" class="project-card h-100">
                                <img src="${p.imageUrl || 'https://via.placeholder.com/64'}" class="project-icon" alt="${p.name}">
                                <div class="project-card-content">
                                    <div class="text-start">
                                        <h5>${p.name}</h5>
                                        <p class="mb-0">${p.description || ''}</p>
                                    </div>
                                    <div class="project-clicks">
                                        <i class="fas fa-eye me-1"></i>
                                        <span class="project-clicks-count">${p.clicks || 0}</span>
                                    </div>
                                </div>
                            </a>
                        </div>`;
                    }).join('');
                }
                contentHTML += `<div class="category-content" data-category="${key}"><div class="row g-3">${itemsHTML}</div></div>`;
            });
            
            const projectsContainerHTML = allProjects.length > 0 || isOwner ? `<div class="category-tabs-container"><div class="category-tabs" id="category-tabs">${tabsHTML}${isOwner ? '<button class="category-tab" id="add-category-btn" title="Thêm danh mục mới"><i class="fas fa-plus"></i></button>' : ''}<div class="tab-underline" id="tab-underline"></div></div><div class="category-content-container" id="category-content-container">${contentHTML}</div></div>` : '';

            profilePageContent.innerHTML = profileInfoHTML + projectsContainerHTML;
            switchView('profile');

            if (document.getElementById('category-tabs')) {
                setupCategoryTabs();
            }
             if (isOwner) {
                const editBtn = document.getElementById('edit-profile-btn');
                if (editBtn) {
                    editBtn.style.display = 'flex';
                    editBtn.addEventListener('click', openEditModal);
                }
                const addCategoryBtn = document.getElementById('add-category-btn');
                if (addCategoryBtn) addCategoryBtn.addEventListener('click', () => handleAddCategory());
            }

            // *** NEW: Add event listeners to all new project cards ***
            document.querySelectorAll('.project-card').forEach(card => {
                card.addEventListener('click', handleProjectClick);
            });

        } catch (error) { console.error("Error loading profile:", error); switchView('notFound'); }
    }

    function setupCategoryTabs() {
        const tabsContainer = document.getElementById('category-tabs');
        const underline = document.getElementById('tab-underline');
        const contentContainer = document.getElementById('category-content-container');
        const tabs = tabsContainer.querySelectorAll('.category-tab:not(#add-category-btn)');
        const contents = contentContainer.querySelectorAll('.category-content');

        if (tabs.length === 0) return;

        function updateUnderline(activeTab) { if (!activeTab) return; requestAnimationFrame(() => { const offsetLeft = activeTab.offsetLeft; const offsetWidth = activeTab.offsetWidth; underline.style.transform = `translateX(${offsetLeft}px)`; underline.style.width = `${offsetWidth}px`; }); }
        
        function switchTab(targetTab) {
            const category = targetTab.dataset.category;
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            targetTab.classList.add('active');
            const activeContent = contentContainer.querySelector(`.category-content[data-category="${category}"]`);
            if (activeContent) activeContent.classList.add('active');
            updateUnderline(targetTab);
        }

        tabsContainer.addEventListener('click', (e) => {
            const targetTab = e.target.closest('.category-tab:not(#add-category-btn)');
            const renameBtn = e.target.closest('.rename-category-btn');
            if (renameBtn) {
                e.stopPropagation(); 
                handleRenameCategory(renameBtn.dataset.categoryKey);
            } else if (targetTab) {
                switchTab(targetTab);
            }
        });
        
        if (tabs[0]) switchTab(tabs[0]); 
    }

    // *** NEW FUNCTION to handle clicks, update count, and redirect ***
    async function handleProjectClick(e) {
        e.preventDefault();
        const card = e.currentTarget;
        const link = card.dataset.link;
        const projectIndex = parseInt(card.dataset.projectIndex, 10);
        const username = new URLSearchParams(window.location.search).get('user');

        if (!link || isNaN(projectIndex) || !username) return;

        // Redirect user immediately
        window.open(link, '_blank', 'noopener,noreferrer');

        // Update count in the background
        try {
            const docRef = db.collection('profiles').doc(username);
            const docSnap = await docRef.get();
            if (!docSnap.exists) return;

            const data = docSnap.data();
            let projects = data.projects || [];

            if (projects[projectIndex]) {
                const currentClicks = projects[projectIndex].clicks || 0;
                projects[projectIndex].clicks = currentClicks + 1;
                
                // Update Firestore
                await docRef.update({ projects: projects });
                
                // Update UI in real-time
                const clicksElement = card.querySelector('.project-clicks-count');
                if (clicksElement) {
                    clicksElement.textContent = projects[projectIndex].clicks;
                }
            }
        } catch (error) {
            console.error("Failed to update click count:", error);
            // Don't show an error to the user, as they've already been redirected.
        }
    }

    async function handleAddCategory(fromModal = false) {
        const categoryName = prompt("Nhập tên danh mục mới:");
        if (!categoryName || categoryName.trim() === '') return;

        const categoryKey = generateCategoryKey(categoryName);
        if (!categoryKey) {
            showToast("Tên danh mục không hợp lệ.");
            return;
        }

        try {
            const docRef = db.collection('profiles').doc(currentUser.username);
            const docSnap = await docRef.get();
            const data = docSnap.data();
            const customCategories = data.customCategories || {};

            if (defaultCategories.hasOwnProperty(categoryKey) || customCategories.hasOwnProperty(categoryKey)) {
                showToast("Danh mục này đã tồn tại.");
                return;
            }
            
            const updateData = {};
            updateData[`customCategories.${categoryKey}`] = categoryName.trim();

            await docRef.update(updateData);
            showToast("Đã thêm danh mục mới!", "success");
            
            if (fromModal) {
                editModal.hide();
            }
            fetchAndRenderProfile(currentUser.username);
        } catch (error) {
            console.error("Lỗi khi thêm danh mục:", error);
            showToast("Không thể thêm danh mục.");
        }
    }
    
    async function handleRenameCategory(oldKey, fromModal = false) {
        try {
            const docRef = db.collection('profiles').doc(currentUser.username);
            const docSnap = await docRef.get();
            if (!docSnap.exists) return;
            const data = docSnap.data();
            const customCategories = data.customCategories || {};
            const projects = data.projects || [];

            const oldDisplayName = customCategories[oldKey] || oldKey;
            const newName = prompt("Đổi tên danh mục:", oldDisplayName);

            if (!newName || newName.trim() === '' || newName.trim() === oldDisplayName) return;

            const newKey = generateCategoryKey(newName);
            if (!newKey) {
                showToast("Tên danh mục mới không hợp lệ.");
                return;
            }

            if (newKey !== oldKey && (defaultCategories.hasOwnProperty(newKey) || customCategories.hasOwnProperty(newKey))) {
                showToast("Tên danh mục này đã tồn tại.");
                return;
            }
            
            delete customCategories[oldKey];
            customCategories[newKey] = newName.trim();

            const updatedProjects = projects.map(proj => {
                if (proj.category === oldKey) {
                    return { ...proj, category: newKey };
                }
                return proj;
            });

            await docRef.update({
                customCategories: customCategories,
                projects: updatedProjects
            });

            showToast("Đổi tên danh mục thành công!", "success");
            
            if (fromModal) {
                editModal.hide();
            }
            fetchAndRenderProfile(currentUser.username);
        } catch (error) {
            console.error("Lỗi khi đổi tên danh mục:", error);
            showToast("Không thể đổi tên danh mục.");
        }
    }

    async function handleDeleteCategory(keyToDelete) {
        try {
            const docRef = db.collection('profiles').doc(currentUser.username);
            const docSnap = await docRef.get();
            if (!docSnap.exists) return;

            const data = docSnap.data();
            const customCategories = data.customCategories || {};
            const projects = data.projects || [];
            const displayName = customCategories[keyToDelete] || keyToDelete;
            
            if (!confirm(`Bạn có chắc chắn muốn xóa danh mục "${displayName}" không?\nTất cả các mục trong danh mục này sẽ được chuyển về "Dự án / Tiện ích".`)) {
                return;
            }

            delete customCategories[keyToDelete];

            const updatedProjects = projects.map(proj => {
                if (proj.category === keyToDelete) {
                    return { ...proj, category: 'project' }; // Move to default
                }
                return proj;
            });
            
            await docRef.update({
                customCategories: customCategories,
                projects: updatedProjects
            });

            showToast("Đã xóa danh mục thành công!", "success");
            editModal.hide();
            fetchAndRenderProfile(currentUser.username);

        } catch (error) {
            console.error("Lỗi khi xóa danh mục:", error);
            showToast("Không thể xóa danh mục.");
        }
    }


    async function handleRegister(e) { e.preventDefault(); const username = document.getElementById('register-username').value.trim().toLowerCase(); const email = document.getElementById('register-email').value.trim(); const password = document.getElementById('register-password').value; const phone = document.getElementById('register-phone').value.trim(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div>`; if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) { showToast("Username không hợp lệ."); btn.disabled = false; btn.textContent = 'Đăng ký'; return; } if (phone && phone.length < 9) { showToast("Số điện thoại không hợp lệ."); btn.disabled = false; btn.textContent = 'Đăng ký'; return; } try { const userDoc = await db.collection('profiles').doc(username).get(); if (userDoc.exists) { showToast("Username này đã được sử dụng."); btn.disabled = false; btn.textContent = 'Đăng ký'; return; } const userCredential = await auth.createUserWithEmailAndPassword(email, password); const user = userCredential.user; await user.sendEmailVerification(); await db.collection('profiles').doc(username).set({ ownerUid: user.uid, username, name: username, avatarUrl: "", isVerified: false, email, phoneNumber: phone, bio: "Chào mừng đến trang của tôi!", socials: {}, projects: [], customCategories: {} }); showToast("Đăng ký thành công! Vui lòng xác thực email.", 'success'); currentUser = { uid: user.uid, email: user.email, username, providerId: 'password' }; setupSidebar(); history.pushState(null, '', `?=${username}`); verificationBanner.style.display = 'block'; await fetchAndRenderProfile(username); } catch (error) { showToast(error.code === 'auth/email-already-in-use' ? "Email này đã được sử dụng." : "Đã có lỗi xảy ra."); } finally { btn.disabled = false; btn.textContent = 'Đăng ký'; } }
    async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value.trim(); const password = document.getElementById('login-password').value; const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div>`; try { await auth.signInWithEmailAndPassword(email, password); } catch (error) { showToast("Email hoặc mật khẩu không chính xác."); btn.disabled = false; btn.textContent = 'Đăng nhập'; } }
    async function handleLogout(e) { e.preventDefault(); await auth.signOut(); window.location.href = '/'; }
    async function handleGoogleLogin() { const provider = new firebase.auth.GoogleAuthProvider(); try { const result = await auth.signInWithPopup(provider); const user = result.user; const profileQuery = await db.collection('profiles').where('ownerUid', '==', user.uid).limit(1).get(); if (profileQuery.empty) { let username = user.email.split('@')[0].replace(/[^a-zA-Z0-9_]/g, ''); let userDoc = await db.collection('profiles').doc(username).get(); while(userDoc.exists) { username = username + Math.floor(Math.random() * 100); userDoc = await db.collection('profiles').doc(username).get(); } await db.collection('profiles').doc(username).set({ ownerUid: user.uid, username, name: user.displayName || username, avatarUrl: user.photoURL || "", isVerified: true, email: user.email, phoneNumber: "", bio: "Chào mừng đến trang của tôi!", socials: {}, projects: [], customCategories: {} }); currentUser = { uid: user.uid, email: user.email, username, providerId: 'google.com' }; setupSidebar(); history.pushState(null, '', `?=${username}`); await fetchAndRenderProfile(username); showToast("Tài khoản đã được tạo thành công!", 'success'); } else { showToast("Chào mừng bạn trở lại!", 'success'); } } catch (error) { if (error.code !== 'auth/popup-closed-by-user') showToast("Không thể đăng nhập với Google."); } }
    async function handleForgotPassword(e) { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div> Đang gửi...`; try { if (passwordResetMode === 'email') { const email = document.getElementById('reset-email-input').value.trim(); if (!email) { showToast("Vui lòng nhập email."); return; } await auth.sendPasswordResetEmail(email); showToast(`Đã gửi email khôi phục đến ${email}.`, 'success'); switchView('auth'); } else { const phone = document.getElementById('reset-phone-input').value.trim(); if (!phone) { showToast("Vui lòng nhập số điện thoại."); return; } const querySnapshot = await db.collection('profiles').where('phoneNumber', '==', phone).limit(1).get(); if (querySnapshot.empty) showToast("Không tìm thấy tài khoản với số điện thoại này."); else { const userEmail = querySnapshot.docs[0].data().email; if (userEmail) { await auth.sendPasswordResetEmail(userEmail); showToast(`Đã gửi liên kết khôi phục.`, 'success'); switchView('auth'); } else showToast("Tài khoản này không có email để gửi liên kết."); } } } catch (error) { showToast("Đã xảy ra lỗi."); } finally { btn.disabled = false; btn.textContent = 'Gửi liên kết'; } }
    async function reauthenticateUser() { const user = auth.currentUser; const providerId = user.providerData[0].providerId; if (providerId === 'password') { const password = prompt("Để xác nhận, vui lòng nhập mật khẩu của bạn:"); if (!password) return null; return user.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(user.email, password)); } else if (providerId === 'google.com') { return user.reauthenticateWithPopup(new firebase.auth.GoogleAuthProvider()); } }
    async function handleChangeEmail(e) { const newEmail = document.getElementById('edit-email').value.trim(); if (newEmail === auth.currentUser.email) return; const btn = e.target; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; try { await reauthenticateUser(); await auth.currentUser.verifyBeforeUpdateEmail(newEmail); await db.collection('profiles').doc(currentUser.username).update({ email: newEmail }); showToast(`Email xác thực đã được gửi đến ${newEmail}.`, 'success'); editModal.hide(); } catch (error) { if (error.code === 'auth/wrong-password') showToast("Mật khẩu không chính xác."); else if (error.code === 'auth/email-already-in-use') showToast("Email này đã được sử dụng."); else if (error.code !== 'auth/popup-closed-by-user') showToast("Xác thực thất bại."); } finally { btn.disabled = false; btn.textContent = 'Đổi'; } }
    async function handleChangeUsername(e) { const newUsername = document.getElementById('edit-username').value.trim().toLowerCase(); if (!newUsername || newUsername === currentUser.username || !/^[a-zA-Z0-9_]{3,20}$/.test(newUsername)) return; const btn = e.target; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; try { const newDoc = await db.collection('profiles').doc(newUsername).get(); if (newDoc.exists) { showToast("Username này đã tồn tại."); return; } await reauthenticateUser(); const oldDoc = await db.collection('profiles').doc(currentUser.username).get(); if (oldDoc.exists) { const profileData = oldDoc.data(); profileData.username = newUsername; await db.collection('profiles').doc(newUsername).set(profileData); await db.collection('profiles').doc(currentUser.username).delete(); currentUser.username = newUsername; history.pushState(null, '', `?=${newUsername}`); setupSidebar(); editModal.hide(); showToast(`Đổi username thành công!`, "success"); } } catch (error) { if (error.code === 'auth/wrong-password') showToast("Mật khẩu không chính xác."); else if (error.code !== 'auth/popup-closed-by-user') showToast("Xác thực thất bại."); } finally { btn.disabled = false; btn.textContent = 'Đổi'; } }
    
    async function openEditModal() {
        const modalBody = document.getElementById('edit-modal-body');
        const docSnap = await db.collection('profiles').doc(currentUser.username).get();
        const data = docSnap.data();
        
        const customCategories = data.customCategories || {};
        const allCategoryKeys = [...new Set([...Object.keys(defaultCategories), ...Object.keys(customCategories)])];
        let projectFieldsHTML = (data.projects || []).map((p, i) => createProjectFieldHTML(p, i, allCategoryKeys, customCategories)).join('');
        const socialFieldsHTML = Object.keys(socialIcons).map(key => `<div class="col-md-6 mb-3"><label class="form-label small">${key === 'gmail' ? 'Địa chỉ Gmail' : `${key.charAt(0).toUpperCase() + key.slice(1)} URL`}</label><input type="${key === 'gmail' ? 'email' : 'url'}" class="form-control" id="edit-${key}" value="${(data.socials || {})[key] || ''}"></div>`).join('');

        let categoryManagerHTML = '<hr><h6 class="mb-3">Quản lý Danh mục</h6>';
        categoryManagerHTML += '<div id="category-manager-container" class="border rounded p-2 mb-3">';
        if (Object.keys(customCategories).length > 0) {
            for (const [key, name] of Object.entries(customCategories)) {
                categoryManagerHTML += `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span class="text-truncate" style="max-width: 60%;">${name}</span>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-cat-btn" data-cat-key="${key}" title="Sửa tên"><i class="fas fa-pencil-alt"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-cat-btn" data-cat-key="${key}" title="Xóa"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`;
            }
        } else {
             categoryManagerHTML += '<p class="text-muted text-center small mb-0">Bạn chưa có danh mục tùy chỉnh nào.</p>';
        }
        categoryManagerHTML += '</div><button type="button" id="add-category-modal-btn" class="btn btn-outline-success btn-sm"><i class="fas fa-plus me-1"></i>Thêm danh mục mới</button>';


        modalBody.innerHTML = `<form id="edit-form">
            <div class="mb-3"><label class="form-label">Ảnh đại diện</label><div class="d-flex align-items-center"><img id="avatar-preview" src="${data.avatarUrl || 'https://via.placeholder.com/150'}" class="rounded-circle me-3" width="80" height="80" style="object-fit: cover; border: 2px solid #ddd;"><div class="flex-grow-1"><input type="file" class="form-control" id="edit-avatar-file" accept="image/*"><input type="hidden" id="edit-avatar-url" value="${data.avatarUrl || ''}"><div class="form-text">Chọn một file ảnh mới để thay đổi.</div></div></div></div>
            <div class="mb-3"><label class="form-label">Tên hiển thị</label><input type="text" class="form-control" id="edit-name" value="${data.name || ''}" required></div>
            <div class="mb-3"><label class="form-label">Tiểu sử ngắn</label><textarea class="form-control" id="edit-bio" rows="3">${data.bio || ''}</textarea></div>
            <hr><h6 class="mb-3">Tài khoản & Bảo mật</h6>
            <div class="mb-3"><label class="form-label">Username</label><div class="input-group"><span class="input-group-text d-none d-sm-flex">.../?=</span><input type="text" class="form-control" id="edit-username" value="${currentUser.username}"><button class="btn btn-outline-danger" type="button" id="change-username-btn">Đổi</button></div><div class="form-text text-danger">Đổi username sẽ thay đổi đường dẫn trang của bạn.</div></div>
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label">Email</label><div class="input-group"><input type="email" class="form-control" id="edit-email" value="${auth.currentUser.email}" required><button class="btn btn-outline-primary" type="button" id="change-email-btn">Đổi</button></div></div><div class="col-md-6 mb-3"><label class="form-label">Số điện thoại</label><input type="tel" class="form-control" id="edit-phone" value="${data.phoneNumber || ''}"></div></div>
            <hr><h6 class="mb-3">Liên kết Mạng xã hội</h6><div class="row g-2">${socialFieldsHTML}</div>
            
            ${categoryManagerHTML}

            <hr><h6 class="mb-3">Danh sách Liên kết</h6><div id="edit-projects-container">${projectFieldsHTML}</div><button type="button" id="edit-add-project-btn" class="btn btn-outline-secondary mt-2"><i class="fas fa-plus me-2"></i>Thêm Mục</button>
        </form>`;

        modalBody.querySelector('#edit-avatar-file').addEventListener('change', e => { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = event => { document.getElementById('avatar-preview').src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });
        document.getElementById('edit-add-project-btn').addEventListener('click', () => { document.getElementById('edit-projects-container').insertAdjacentHTML('beforeend', createProjectFieldHTML({}, document.querySelectorAll('.project-field').length, allCategoryKeys, customCategories)); });
        modalBody.querySelector('#change-email-btn').addEventListener('click', handleChangeEmail);
        modalBody.querySelector('#change-username-btn').addEventListener('click', handleChangeUsername);

        const managerContainer = modalBody.querySelector('#category-manager-container');
        if (managerContainer) {
             managerContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-cat-btn');
                const deleteBtn = e.target.closest('.delete-cat-btn');
                if (editBtn) {
                    handleRenameCategory(editBtn.dataset.catKey, true);
                }
                if (deleteBtn) {
                    handleDeleteCategory(deleteBtn.dataset.catKey);
                }
            });
        }
        modalBody.querySelector('#add-category-modal-btn').addEventListener('click', () => handleAddCategory(true));

        editModal.show();
    }
    
    // *** MODIFIED: Added hidden input for clicks to preserve data on save ***
    function createProjectFieldHTML(project = {}, index, categories, customCategories = {}) {
        const categoryOptions = categories.map(key => {
            const displayName = getCategoryDisplayName(key, customCategories);
            const isSelected = (project.category || 'project') === key;
            return `<option value="${key}" ${isSelected ? 'selected' : ''}>${displayName}</option>`;
        }).join('');
        return `<div class="p-3 border rounded mb-3 project-field">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Mục #${index + 1}</strong>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <input type="hidden" class="project-clicks-hidden" value="${project.clicks || 0}">
            <div class="row g-2">
                <div class="col-md-6"><label class="form-label small">Tên</label><input type="text" class="form-control mb-2 project-name" placeholder="Tên dự án/sàn" value="${project.name || ''}"></div>
                <div class="col-md-6"><label class="form-label small">Danh mục</label><select class="form-select project-category">${categoryOptions}</select></div>
            </div>
            <label class="form-label small">Mô tả</label><input type="text" class="form-control mb-2 project-desc" placeholder="Mô tả ngắn" value="${project.description || ''}">
            <label class="form-label small">Link</label><input type="url" class="form-control mb-2 project-link" placeholder="Đường dẫn (URL)" value="${project.link || ''}">
            <label class="form-label small">URL Hình ảnh</label><input type="url" class="form-control project-image" placeholder="Link ảnh logo" value="${project.imageUrl || ''}">
        </div>`;
    }

    // *** MODIFIED: Read hidden clicks value on save ***
    async function handleSaveProfile() { 
        const saveBtn = document.getElementById('save-profile-btn'); 
        saveBtn.disabled = true; 
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Đang lưu...`; 
        try { 
            let avatarUrlToSave = document.getElementById('edit-avatar-url').value; 
            const file = document.getElementById('edit-avatar-file').files[0]; 
            if (file) { 
                const filePath = `avatars/${currentUser.uid}/avatar_${Date.now()}`; 
                const fileRef = storage.ref(filePath); 
                await fileRef.put(file); 
                avatarUrlToSave = await fileRef.getDownloadURL(); 
            } 
            const socialsData = {}; 
            Object.keys(socialIcons).forEach(key => { 
                const el = document.getElementById(`edit-${key}`); 
                if (el) socialsData[key] = el.value.trim(); 
            }); 
            
            const projectsData = []; 
            document.querySelectorAll('#edit-projects-container .project-field').forEach(field => { 
                const name = field.querySelector('.project-name').value.trim(); 
                const link = field.querySelector('.project-link').value.trim(); 
                if (name && link) { 
                    projectsData.push({ 
                        name, 
                        description: field.querySelector('.project-desc').value.trim(), 
                        link, 
                        imageUrl: field.querySelector('.project-image').value.trim(), 
                        category: field.querySelector('.project-category').value,
                        clicks: parseInt(field.querySelector('.project-clicks-hidden').value, 10) || 0 // Preserve clicks
                    }); 
                } 
            }); 
            
            const updatedProfileData = { 
                name: document.getElementById('edit-name').value.trim(), 
                avatarUrl: avatarUrlToSave, 
                bio: document.getElementById('edit-bio').value.trim(), 
                phoneNumber: document.getElementById('edit-phone').value.trim(), 
                socials: socialsData, 
                projects: projectsData, 
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp() 
            }; 
            
            await db.collection('profiles').doc(currentUser.username).update(updatedProfileData); 
            editModal.hide(); 
            await fetchAndRenderProfile(currentUser.username); 
            showToast("Cập nhật thành công!", "success"); 
        } catch (error) { 
            console.error("Lỗi khi lưu profile:", error); 
            showToast("Lỗi khi lưu. Vui lòng thử lại."); 
        } finally { 
            saveBtn.disabled = false; 
            saveBtn.textContent = 'Lưu thay đổi'; 
        } 
    }

    function openChangePasswordModal() { const modalBody = document.getElementById('change-password-modal-body'); const modalFooter = document.getElementById('change-password-modal-footer'); if (currentUser.providerId === 'password') { modalBody.innerHTML = `<form id="change-password-form"><div class="mb-3"><label class="form-label">Mật khẩu cũ</label><input type="password" class="form-control" id="old-password" required></div><div class="mb-3"><label class="form-label">Mật khẩu mới</label><input type="password" class="form-control" id="new-password" required minlength="6"></div><div class="mb-3"><label class="form-label">Xác nhận mật khẩu</label><input type="password" class="form-control" id="confirm-password" required></div></form>`; modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="submit" form="change-password-form" class="btn btn-primary">Lưu</button>`; document.getElementById('change-password-form').addEventListener('submit', handleChangePassword); } else { modalBody.innerHTML = `<p>Tài khoản của bạn được liên kết với Google. Để đổi mật khẩu, bạn cần dùng chức năng của Google.</p><p>Gửi email đặt lại mật khẩu đến <strong>${auth.currentUser.email}</strong>?</p>`; modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" id="send-reset-email-google-btn" class="btn btn-primary">Gửi Email</button>`; document.getElementById('send-reset-email-google-btn').addEventListener('click', handleSendResetEmailFromModal); } changePasswordModal.show(); }
    async function handleChangePassword(e) { e.preventDefault(); const oldPass = document.getElementById('old-password').value; const newPass = document.getElementById('new-password').value; if (newPass !== document.getElementById('confirm-password').value) { showToast("Mật khẩu mới không khớp."); return; } const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; try { await auth.currentUser.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, oldPass)); await auth.currentUser.updatePassword(newPass); showToast("Đổi mật khẩu thành công!", "success"); changePasswordModal.hide(); } catch (error) { showToast(error.code === 'auth/wrong-password' ? "Mật khẩu cũ không chính xác." : "Đã có lỗi."); } finally { btn.disabled = false; } }
    async function handleSendResetEmailFromModal() { const btn = document.getElementById('send-reset-email-google-btn'); btn.disabled = true; try { await auth.sendPasswordResetEmail(auth.currentUser.email); showToast("Email đặt lại mật khẩu đã được gửi.", "success"); changePasswordModal.hide(); } catch(error) { showToast("Gửi email thất bại."); } finally { btn.disabled = false; } }
    function setupAuthForm() { showRegisterBtn.addEventListener('click', () => authFlipCard.classList.add('is-flipped')); showLoginBtn.addEventListener('click', () => authFlipCard.classList.remove('is-flipped')); document.getElementById('forgot-password-btn').addEventListener('click', () => switchView('forgotPassword')); document.getElementById('back-to-login-btn').addEventListener('click', () => { switchView('auth'); authFlipCard.classList.remove('is-flipped'); }); const resetEmailBtn = document.getElementById('reset-mode-email-btn'), resetPhoneBtn = document.getElementById('reset-mode-phone-btn'); const resetEmailGroup = document.getElementById('reset-email-group'), resetPhoneGroup = document.getElementById('reset-phone-group'); resetEmailBtn.addEventListener('click', () => { passwordResetMode = 'email'; resetEmailGroup.style.display = 'block'; resetPhoneGroup.style.display = 'none'; resetEmailBtn.classList.replace('btn-outline-light', 'btn-primary'); resetPhoneBtn.classList.replace('btn-primary', 'btn-outline-light'); }); resetPhoneBtn.addEventListener('click', () => { passwordResetMode = 'phone'; resetEmailGroup.style.display = 'none'; resetPhoneGroup.style.display = 'block'; resetPhoneBtn.classList.replace('btn-outline-light', 'btn-primary'); resetEmailBtn.classList.replace('btn-primary', 'btn-outline-light'); }); }

    function main() {
        initializeFirebase();
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await user.reload(); const refreshedUser = auth.currentUser;
                if (!refreshedUser.emailVerified && refreshedUser.providerData.some(p => p.providerId === 'password')) verificationBanner.style.display = 'block'; else verificationBanner.style.display = 'none';
                const profileQuery = await db.collection('profiles').where('ownerUid', '==', refreshedUser.uid).limit(1).get();
                if (!profileQuery.empty) {
                    const profileData = profileQuery.docs[0].data();
                    currentUser = { uid: refreshedUser.uid, email: refreshedUser.email, username: profileData.username, providerId: refreshedUser.providerData[0].providerId };
                } else { console.warn("User in Auth but not Firestore. Logging out."); await auth.signOut(); currentUser = null; }
            } else currentUser = null;
            setupSidebar(); handleRouteChange();
        });
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
        document.getElementById('save-profile-btn').addEventListener('click', handleSaveProfile);
        document.getElementById('resend-verification-btn').addEventListener('click', async () => { try { await auth.currentUser.sendEmailVerification(); showToast("Email đã được gửi lại.", 'success'); } catch (e) { showToast("Gửi email thất bại."); }});
        document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
        importJsonInput.addEventListener('change', handleImportJson); 
        document.getElementById('footer-year').textContent = new Date().getFullYear();
        setupAuthForm();
    }

    main();
});
</script>
</body>
</html>
