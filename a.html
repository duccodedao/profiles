<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BmassHD - Tạo Mã QR Chuyển Khoản</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://duccodedao.github.io/Images/avt.png">
    
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #2d3748;
            --border-radius: 12px;
            --shadow: 0 10px 25px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { background-color: var(--bg-color); color: var(--text-color); padding: 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }

        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-wrap: wrap;
        }

        /* --- Header --- */
        .header { width: 100%; padding: 20px; background: linear-gradient(135deg, var(--primary-color), #224abe); color: white; text-align: center; }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .header p { font-size: 0.9rem; opacity: 0.8; }

        /* --- Layout --- */
        .col-left, .col-right { padding: 30px; }
        .col-left { flex: 1; min-width: 350px; border-right: 1px solid #eee; }
        .col-right { flex: 1; min-width: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f8f9fc; }

        /* --- Bank Grid --- */
        .bank-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .bank-item {
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: var(--transition);
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            position: relative;
        }
        .bank-item img { width: 100%; height: 40px; object-fit: contain; filter: grayscale(100%); transition: var(--transition); }
        .bank-item:hover { transform: translateY(-3px); }
        .bank-item.active { border-color: var(--primary-color); background: #f0f4ff; }
        .bank-item.active img { filter: grayscale(0%); }
        .bank-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 5px 10px; font-size: 0.75rem;
            border-radius: 4px; white-space: nowrap; opacity: 0; visibility: hidden; transition: var(--transition); z-index: 10;
        }
        .bank-item:hover .bank-tooltip { opacity: 1; visibility: visible; bottom: 110%; }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #555; }
        .form-control {
            width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 1rem; transition: var(--transition); outline: none;
        }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1); }
        
        .input-group { display: flex; gap: 10px; }
        .btn-copy { background: var(--secondary-color); color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; transition: var(--transition); }
        .btn-copy:hover { background: #5a5c69; }

        .suggestions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .tag {
            background: #eef2ff; color: var(--primary-color); padding: 5px 12px;
            border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent;
            transition: var(--transition);
        }
        .tag:hover { border-color: var(--primary-color); background: #fff; }

        /* --- Template Options --- */
        .template-options { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .template-opt {
            flex: 1; border: 2px solid #ddd; border-radius: 10px; overflow: hidden;
            cursor: pointer; opacity: 0.6; transition: var(--transition);
        }
        .template-opt img { width: 100%; display: block; }
        .template-opt.active { border-color: var(--primary-color); opacity: 1; transform: scale(1.05); }

        /* --- QR Result --- */
        .qr-frame {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;
            text-align: center; min-height: 300px; display: flex; align-items: center; justify-content: center;
        }
        .qr-frame img { max-width: 100%; height: auto; border-radius: 10px; }
        
        .btn-action {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            background: var(--primary-color); color: white; border: none;
            padding: 12px 25px; border-radius: 30px; font-weight: 600;
            cursor: pointer; transition: var(--transition); width: 100%;
            margin-bottom: 10px;
        }
        .btn-action:hover { background: #2e59d9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78, 115, 223, 0.3); }
        .btn-action.secondary { background: white; color: var(--text-color); border: 1px solid #ddd; }
        .btn-action.secondary:hover { background: #f8f9fc; }

        .status-badge {
            display: inline-block; padding: 4px 10px; border-radius: 20px;
            font-size: 0.75rem; font-weight: bold; margin-left: 10px;
        }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-maintenance { background: #fee2e2; color: #991b1b; }

        /* --- Loading Animation --- */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Modal (Bank Table) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 600px;
            max-height: 80vh; overflow-y: auto; position: relative;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fc; }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .col-left { border-right: none; border-bottom: 1px solid #eee; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-qrcode"></i> BmassHD QR Generator</h1>
        <p>Tạo mã QR chuyển khoản nhanh chóng & chính xác</p>
    </div>

    <!-- CỘT TRÁI: NHẬP LIỆU -->
    <div class="col-left">
        <div class="form-group">
            <label class="form-label">1. Chọn Ngân Hàng <span id="bank-status-badge" class="status-badge status-active">Đang hoạt động</span></label>
            <div class="bank-grid" id="bankGrid">
                <!-- JS sẽ render ngân hàng vào đây -->
            </div>
            <div style="font-size: 0.9rem; margin-top: 5px;">
                Đang chọn: <strong id="selectedBankName" style="color: var(--primary-color);">Vietcombank</strong>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">2. Thông tin tài khoản</label>
            <div class="input-group">
                <input type="text" id="accountNumber" class="form-control" readonly style="background: #f8f9fc; font-weight: bold;">
                <button class="btn-copy" onclick="copyToClipboard('accountNumber')" title="Sao chép số tài khoản">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <input type="text" id="fullName" class="form-control" value="SƠN LÝ HỒNG ĐỨC" readonly style="margin-top: 10px; background: #f8f9fc; color: #555;">
        </div>

        <div class="form-group">
            <label class="form-label">3. Số tiền & Nội dung <span style="color: red;">*</span></label>
            <input type="text" id="amount" class="form-control" placeholder="Nhập số tiền (VD: 50,000)" oninput="formatCurrency(this)">
            <div class="suggestions">
                <span class="tag" onclick="setAmount(10000)">10,000</span>
                <span class="tag" onclick="setAmount(50000)">50,000</span>
                <span class="tag" onclick="setAmount(100000)">100,000</span>
                <span class="tag" onclick="setAmount(500000)">500,000</span>
            </div>
            <textarea id="transferContent" class="form-control" style="margin-top: 15px;" rows="2" placeholder="Nội dung chuyển khoản">Anh Đức đẹp trai nhất thế giới</textarea>
        </div>

        <div class="form-group">
            <label class="form-label">4. Giao diện QR</label>
            <div class="template-options">
                <div class="template-opt active" onclick="selectTemplate('compact2', this)">
                    <img src="https://img.vietqr.io/image/VCB-0891000650891-compact2.jpg" alt="Đầy đủ">
                </div>
                <div class="template-opt" onclick="selectTemplate('compact', this)">
                    <img src="https://img.vietqr.io/image/VCB-0891000650891-compact.jpg" alt="Gọn">
                </div>
                <div class="template-opt" onclick="selectTemplate('qr_only', this)">
                    <img src="https://img.vietqr.io/image/VCB-0891000650891-qr_only.jpg" alt="Chỉ QR">
                </div>
            </div>
        </div>

        <button class="btn-action" onclick="generateQR()" id="btnGenerate">
            <i class="fas fa-magic"></i> TẠO MÃ QR
        </button>
        <button class="btn-action secondary" onclick="document.getElementById('bankModal').style.display='flex'" style="margin-top: 0;">
            <i class="fas fa-list"></i> Xem danh sách Ngân hàng
        </button>
    </div>

    <!-- CỘT PHẢI: KẾT QUẢ -->
    <div class="col-right">
        <label class="form-label">MÃ QR CỦA BẠN</label>
        <div class="qr-frame" id="qrContainer">
            <div class="loader" id="loader"></div>
            <img id="qrImage" src="" alt="QR Code sẽ hiện ở đây" style="display: none;">
            <div id="placeholderText" style="color: #aaa;">
                <i class="fas fa-qrcode" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                Vui lòng nhập số tiền và bấm Tạo Mã
            </div>
        </div>
        
        <div id="resultActions" style="width: 100%; display: none;">
            <button class="btn-action" onclick="downloadQR()">
                <i class="fas fa-download"></i> Tải ảnh về máy
            </button>
            <button class="btn-action secondary" onclick="openBankingApp()">
                <i class="fas fa-external-link-alt"></i> Mở App Ngân hàng
            </button>
        </div>
    </div>
</div>

<!-- Modal Danh Sách Ngân Hàng -->
<div id="bankModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('bankModal').style.display='none'">&times;</span>
        <h2>Danh sách tài khoản</h2>
        <table id="bankTable">
            <thead>
                <tr>
                    <th>Ngân hàng</th>
                    <th>Số tài khoản</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // --- CẤU HÌNH DỮ LIỆU ---
    const BANKS = [
        { code: 'vcb', name: 'Vietcombank', fullName: 'NH TMCP Ngoại Thương VN', acc: '0891000650891', logo: 'https://vietqr.net/portal-service/resources/icons/VCB.png', status: 'active' },
        { code: 'mb', name: 'MBBank', fullName: 'NH TMCP Quân Đội', acc: '00010302003', logo: 'https://vietqr.net/portal-service/resources/icons/MB.png', status: 'active' },
        { code: 'tcb', name: 'Techcombank', fullName: 'NH TMCP Kỹ Thương VN', acc: '234586868686', logo: 'https://vietqr.net/portal-service/resources/icons/TCB.png', status: 'active' },
        { code: 'tpb', name: 'TPBank', fullName: 'NH TMCP Tiên Phong', acc: '00005161486', logo: 'https://vietqr.net/portal-service/resources/icons/TPB.png', status: 'maintenance' },
        { code: 'icb', name: 'VietinBank', fullName: 'NH TMCP Công Thương VN', acc: '104881468669', logo: 'https://vietqr.net/portal-service/resources/icons/ICB.png', status: 'active' },
        { code: 'slhd', name: 'SLHD Bank', fullName: 'Ngân hàng SƠN LÝ HỒNG ĐỨC', acc: '9999999999', logo: 'https://duccodedao.github.io/Images/logobank.png', status: 'active' } // Fake bank logic handled
    ];

    let currentBank = BANKS[0];
    let currentTemplate = 'compact2';

    // --- KHỞI TẠO ---
    document.addEventListener('DOMContentLoaded', () => {
        renderBankGrid();
        renderBankTable();
        selectBank(0); // Chọn mặc định VCB
        
        // Hiệu ứng chào mừng (giữ lại từ code cũ nhưng làm gọn)
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });
        Toast.fire({ icon: 'success', title: 'Chào mừng bạn đến với BmassHD!' });
    });

    // --- RENDER UI ---
    function renderBankGrid() {
        const grid = document.getElementById('bankGrid');
        grid.innerHTML = '';
        BANKS.forEach((bank, index) => {
            const div = document.createElement('div');
            div.className = `bank-item ${index === 0 ? 'active' : ''}`;
            div.onclick = () => selectBank(index);
            div.innerHTML = `
                <img src="${bank.logo}" alt="${bank.code}">
                <div class="bank-tooltip">${bank.name}</div>
            `;
            grid.appendChild(div);
        });
    }

    function renderBankTable() {
        const tbody = document.querySelector('#bankTable tbody');
        tbody.innerHTML = '';
        BANKS.forEach(bank => {
            const tr = document.createElement('tr');
            const statusColor = bank.status === 'active' ? 'green' : 'red';
            const statusText = bank.status === 'active' ? 'Hoạt động' : 'Bảo trì';
            tr.innerHTML = `
                <td><img src="${bank.logo}" width="50" style="vertical-align:middle"> ${bank.name}</td>
                <td>${bank.acc}</td>
                <td style="color:${statusColor}; font-weight:bold">${statusText}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- LOGIC CHỨC NĂNG ---
    function selectBank(index) {
        currentBank = BANKS[index];
        
        // Update UI items
        document.querySelectorAll('.bank-item').forEach((el, i) => {
            el.classList.toggle('active', i === index);
        });

        // Update Text Info
        document.getElementById('selectedBankName').innerText = currentBank.fullName;
        document.getElementById('accountNumber').value = currentBank.acc;

        // Update Status Badge
        const badge = document.getElementById('bank-status-badge');
        if (currentBank.status === 'active') {
            badge.className = 'status-badge status-active';
            badge.innerText = 'Đang hoạt động';
        } else {
            badge.className = 'status-badge status-maintenance';
            badge.innerText = 'Đang bảo trì';
        }

        // Tự động tạo lại QR nếu đã nhập tiền
        if(document.getElementById('amount').value) {
            generateQR();
        }
    }

    function selectTemplate(tpl, element) {
        currentTemplate = tpl;
        document.querySelectorAll('.template-opt').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        if(document.getElementById('amount').value) {
            generateQR();
        }
    }

    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, ''); // Chỉ giữ lại số
        if (value) {
            value = parseInt(value, 10).toLocaleString('en-US');
            input.value = value;
        } else {
            input.value = '';
        }
    }

    function setAmount(val) {
        const input = document.getElementById('amount');
        input.value = val.toLocaleString('en-US');
        generateQR();
    }

    function generateQR() {
        const rawAmount = document.getElementById('amount').value.replace(/,/g, '');
        const amount = parseInt(rawAmount);
        const content = document.getElementById('transferContent').value;
        const qrImg = document.getElementById('qrImage');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholderText');
        const actions = document.getElementById('resultActions');

        // Validation
        if (!amount || amount < 1000) {
            Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Vui lòng nhập số tiền hợp lệ (tối thiểu 1,000đ)' });
            return;
        }

        // Show Loading
        qrImg.style.display = 'none';
        placeholder.style.display = 'none';
        loader.style.display = 'block';
        actions.style.display = 'none';

        // Xử lý link API VietQR
        // Lưu ý: Nếu là ngân hàng fake (SLHD), ta dùng tạm link placeholder hoặc custom logic
        let apiLink = '';
        if (currentBank.code === 'slhd') {
            // Demo logic cho bank tự chế
            apiLink = `https://img.vietqr.io/image/VCB-${currentBank.acc}-${currentTemplate}.jpg?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=SON%20LY%20HONG%20DUC`; 
        } else {
            apiLink = `https://img.vietqr.io/image/${currentBank.code}-${currentBank.acc}-${currentTemplate}.jpg?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent("SƠN LÝ HỒNG ĐỨC")}`;
        }

        // Load ảnh
        qrImg.onload = function() {
            loader.style.display = 'none';
            qrImg.style.display = 'block';
            actions.style.display = 'flex'; // Hiện nút tải về
            // Animation nhẹ
            qrImg.animate([{ opacity: 0 }, { opacity: 1 }], { duration: 500 });
        };
        
        qrImg.onerror = function() {
            loader.style.display = 'none';
            placeholder.style.display = 'block';
            placeholder.innerHTML = '<span style="color:red">Lỗi tải QR. Vui lòng thử lại!</span>';
        };

        // Gán src để kích hoạt tải
        qrImg.setAttribute('data-url', apiLink); // Lưu link gốc
        qrImg.src = apiLink;
    }

    // --- TIỆN ÍCH ---
    async function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).value;
        try {
            await navigator.clipboard.writeText(text);
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
            Toast.fire({ icon: 'success', title: `Đã sao chép: ${text}` });
        } catch (err) {
            Swal.fire('Lỗi', 'Không thể sao chép', 'error');
        }
    }

    function downloadQR() {
        const imgUrl = document.getElementById('qrImage').src;
        if (!imgUrl) return;

        // Sử dụng fetch để lấy blob hình ảnh, tránh lỗi mở tab mới
        fetch(imgUrl)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `QR-${currentBank.code}-${new Date().getTime()}.jpg`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(() => {
                // Fallback nếu fetch lỗi (do CORS) -> Mở tab mới
                window.open(imgUrl, '_blank');
            });
    }

    function openBankingApp() {
        // Deep link cơ bản (Chỉ hoạt động trên mobile có cài app tương ứng)
        const appLink = `https://dl.vietqr.io/pay?app=${currentBank.code}`;
        window.open(appLink, '_blank');
    }

    // Đóng modal khi click ra ngoài
    window.onclick = function(event) {
        const modal = document.getElementById('bankModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
</body>
</html>
