<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO & META -->
    <title>Bmass Profile & Unich Network</title>
    <meta name="description" id="meta-desc" content="Trang cá nhân và mạng lưới kết nối Unich.">
    <link rel="icon" id="meta-icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://hdd.io.vn/img/bmasslogos.png">
    <meta name="theme-color" content="#6366f1">
    
    <!-- PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="dynamic-manifest">
    
    <!-- Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#6366f1', 
                        secondary: '#ec4899',
                        dark: '#0f172a',
                        unich: '#06b6d4', // Unich Brand Color
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        }
                    }
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .custom-bg { background-size: cover; background-position: center; background-attachment: fixed; }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
        .dark .glass { background: rgba(15, 23, 42, 0.75); border: 1px solid rgba(255,255,255,0.05); }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }

        .reveal-on-scroll { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.5, 0, 0, 1); }
        .reveal-on-scroll.active { opacity: 1; transform: translateY(0); }

        /* Unich Specific */
        .unich-gradient { background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); }
        .text-unich { background: linear-gradient(to right, #06b6d4, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden pb-10 custom-bg">

    <!-- Background Blob -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-primary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-secondary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-cyan-500/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Loading -->
    <div id="global-loading" class="fixed inset-0 bg-white dark:bg-slate-950 z-[900] flex flex-col items-center justify-center transition-opacity duration-300">
        <img src="https://hdd.io.vn/img/bmassloadings.png" class="w-20 h-20 mb-4 animate-bounce-slow drop-shadow-2xl">
        <span class="text-sm font-bold text-slate-500 tracking-widest uppercase">Đang tải dữ liệu...</span>
    </div>

    <input type="file" id="usb-key-input" class="hidden" accept=".json,.txt">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass px-6 py-3 flex justify-between items-center mb-4">
        <div class="flex items-center gap-3">
            <img id="nav-avatar" src="https://ui-avatars.com/api/?name=P" class="w-9 h-9 rounded-full object-cover border-2 border-primary/20 shadow-sm">
            <span id="nav-nickname" class="font-bold text-lg hidden sm:block tracking-tight truncate max-w-[150px]">MyProfile</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
            </button>
            <button onclick="document.getElementById('usb-key-input').click()" class="p-2 rounded-full text-slate-400 hover:text-primary hover:bg-black/5 dark:hover:bg-white/10 transition">
                <i data-lucide="usb" class="w-5 h-5"></i>
            </button>
            <button id="admin-btn" onclick="window.openEditModal()" class="hidden px-3 py-1.5 bg-slate-800 dark:bg-white text-white dark:text-slate-900 rounded-lg text-xs font-bold uppercase shadow hover:opacity-90 transition gap-2 items-center">
                <i data-lucide="edit-3" class="w-3 h-3"></i> Sửa
            </button>
             <button id="manager-btn" onclick="window.openManagerModal()" class="hidden p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                <i data-lucide="users" class="w-5 h-5"></i>
            </button>
            <div id="auth-section"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 space-y-6">

        <!-- VIEW SWITCHER (TABS) -->
        <div class="flex justify-center mb-6">
            <div class="bg-white/50 dark:bg-slate-800/50 p-1.5 rounded-2xl flex relative shadow-sm border dark:border-white/5 backdrop-blur-md">
                <button onclick="switchMainView('profile')" id="btn-view-profile" class="px-6 py-2.5 rounded-xl text-sm font-bold transition-all w-32 shadow-md bg-white dark:bg-slate-700 text-primary">
                    Hồ Sơ
                </button>
                <button onclick="switchMainView('unich')" id="btn-view-unich" class="px-6 py-2.5 rounded-xl text-sm font-bold transition-all w-32 text-slate-500 hover:text-cyan-500">
                    Unich
                </button>
            </div>
        </div>

        <!-- ====================== VIEW 1: PROFILE (GỐC) ====================== -->
        <div id="view-profile" class="space-y-6 transition-all duration-300">
            <!-- Header Card -->
            <div class="glass rounded-3xl p-6 sm:p-8 flex flex-col md:flex-row items-center md:items-start gap-6 relative overflow-hidden reveal-on-scroll">
                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-primary to-secondary rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                    <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&size=256" class="relative w-32 h-32 sm:w-40 sm:h-40 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-xl">
                    <div id="online-indicator" class="absolute bottom-2 right-2 w-5 h-5 bg-green-500 border-4 border-white dark:border-slate-800 rounded-full"></div>
                </div>

                <div class="flex-1 text-center md:text-left space-y-2 z-10">
                    <div class="flex flex-col md:flex-row items-center gap-2 md:gap-4 justify-center md:justify-start">
                        <h1 id="profile-name" class="text-3xl sm:text-4xl font-black tracking-tight text-slate-800 dark:text-white">Loading...</h1>
                        <span id="profile-nickname-badge" class="px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold uppercase tracking-wider hidden"></span>
                    </div>
                    
                    <p id="profile-bio" class="text-slate-500 dark:text-slate-400 font-medium max-w-lg mx-auto md:mx-0">...</p>

                    <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 py-3">
                        <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i data-lucide="users" class="w-4 h-4 text-primary"></i>
                            <span id="stat-followers">0</span> <span class="text-slate-400 font-normal">Người theo dõi</span>
                        </div>
                        <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i data-lucide="eye" class="w-4 h-4 text-secondary"></i>
                            <span id="stat-views">0</span> <span class="text-slate-400 font-normal">Lượt xem</span>
                        </div>
                        <div id="relationship-display" class="hidden flex items-center gap-1.5 text-sm font-bold text-pink-500 bg-pink-500/10 px-3 py-1 rounded-full">
                            <i data-lucide="heart" class="w-3 h-3 fill-current"></i>
                            <span id="rel-status">Độc thân</span>
                        </div>
                    </div>

                    <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-2">
                        <button id="follow-btn" onclick="window.toggleFollow()" class="px-6 py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:transform hover:scale-105 transition flex items-center gap-2">
                            <i data-lucide="user-plus" class="w-4 h-4"></i> Theo dõi
                        </button>
                        <button onclick="window.showContactModal('phone')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-primary hover:border-primary transition shadow-sm">
                            <i data-lucide="phone" class="w-5 h-5"></i>
                        </button>
                        <button onclick="window.showContactModal('email')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-secondary hover:border-secondary transition shadow-sm">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Social Links Grid -->
            <div id="social-grid" class="flex flex-wrap justify-center gap-4 reveal-on-scroll"></div>

            <!-- Details Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 reveal-on-scroll">
                <!-- About -->
                <div class="glass p-6 rounded-3xl space-y-4">
                    <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 flex items-center gap-2">
                        <i data-lucide="info" class="w-4 h-4"></i> Thông tin cá nhân
                    </h3>
                    <ul class="space-y-3">
                        <li class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-xl">
                            <span class="text-sm font-medium text-slate-500">Ngày sinh</span>
                            <span id="info-dob" class="text-sm font-bold">--/--/----</span>
                        </li>
                        <li class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-xl">
                            <span class="text-sm font-medium text-slate-500">Giới tính</span>
                            <span id="info-gender" class="text-sm font-bold">---</span>
                        </li>
                        <li class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-xl">
                            <span class="text-sm font-medium text-slate-500">Quê quán</span>
                            <span id="info-hometown" class="text-sm font-bold text-right max-w-[200px] truncate">---</span>
                        </li>
                    </ul>
                </div>

                <!-- Banking -->
                <div class="glass p-6 rounded-3xl space-y-4">
                    <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 flex items-center gap-2">
                        <i data-lucide="credit-card" class="w-4 h-4"></i> Ngân hàng
                    </h3>
                    <div id="bank-list" class="space-y-3 max-h-[200px] overflow-y-auto pr-1"></div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="glass p-6 sm:p-8 rounded-3xl reveal-on-scroll">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                    <i data-lucide="briefcase" class="w-4 h-4"></i> Học vấn & Công việc
                </h3>
                <div id="career-timeline" class="space-y-6 border-l-2 border-slate-200 dark:border-slate-700 ml-3 pl-6 relative"></div>
            </div>

            <!-- Achievements -->
            <div class="glass p-6 sm:p-8 rounded-3xl reveal-on-scroll">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                    <i data-lucide="award" class="w-4 h-4"></i> Thành tựu nổi bật
                </h3>
                <div id="achievement-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>

            <!-- Partners Section -->
            <div id="partners-section" class="glass p-6 sm:p-8 rounded-3xl hidden reveal-on-scroll">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                    <i data-lucide="handshake" class="w-4 h-4"></i> Đối tác
                </h3>
                <div id="partners-grid" class="flex flex-wrap items-center justify-center gap-8 opacity-70 grayscale hover:grayscale-0 transition-all duration-500"></div>
            </div>

            <!-- Send Message Button -->
            <div class="flex justify-center mt-8 reveal-on-scroll">
                <button onclick="window.showContactForm()" class="w-full max-w-md px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl hover:-translate-y-1 transition flex items-center justify-center gap-3">
                    <i data-lucide="send" class="w-6 h-6"></i> Gửi tin nhắn cho tôi
                </button>
            </div>
        </div>

        <!-- ====================== VIEW 2: UNICH NETWORK (NEW) ====================== -->
        <div id="view-unich" class="space-y-6 hidden transition-all duration-300">
            <!-- Unich Info Card -->
            <div class="glass rounded-3xl p-6 sm:p-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-cyan-400/20 rounded-full blur-3xl pointer-events-none"></div>
                <div class="flex flex-col md:flex-row gap-6 items-center">
                    <div class="shrink-0">
                        <img id="unich-logo" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-2xl shadow-xl object-cover bg-white">
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h2 id="unich-title" class="text-3xl font-black text-unich uppercase">Unich Network</h2>
                        <p id="unich-desc" class="text-sm text-slate-600 dark:text-slate-300 mt-2">Dự án kết nối vị trí và cộng đồng. Quét radar để tìm người xung quanh bạn.</p>
                        
                        <!-- Buttons -->
                         <div class="flex flex-wrap gap-3 justify-center md:justify-start pt-4">
                            <a id="unich-ios" href="#" target="_blank" class="hidden hover:opacity-80 transition"><img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Download_on_the_App_Store_Badge.svg" class="h-9"></a>
                            <a id="unich-android" href="#" target="_blank" class="hidden hover:opacity-80 transition"><img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" class="h-9"></a>
                        </div>
                    </div>
                    <div class="hidden md:block">
                        <div class="p-2 bg-white rounded-xl shadow-lg inline-block">
                             <img id="unich-qr" src="" class="w-24 h-24 object-contain">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions: Join/Update Location -->
            <div class="glass p-6 rounded-3xl">
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                    <i data-lucide="map-pin" class="w-5 h-5 text-cyan-500"></i> Cập nhật vị trí của bạn
                </h3>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border dark:border-white/5 space-y-4">
                    <div id="unich-auth-warn" class="text-center text-sm text-red-500 hidden">Bạn cần đăng nhập để tham gia mạng lưới.</div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="lbl">Liên hệ (Zalo/SĐT)</label>
                            <input type="text" id="unich-my-contact" class="inp" placeholder="09xxxx (Để người khác gọi)">
                        </div>
                        <div class="flex items-end">
                            <button onclick="joinUnichNetwork()" class="w-full py-2.5 unich-gradient text-white rounded-xl font-bold shadow-lg hover:brightness-110 transition flex items-center justify-center gap-2">
                                <i data-lucide="radar" class="w-5 h-5"></i> Quét & Cập nhật Vị trí
                            </button>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 italic text-center">*Vị trí của bạn sẽ được chia sẻ với cộng đồng Unich trong mạng lưới này.</p>
                </div>
            </div>

            <!-- Admin Distance -->
            <div id="admin-distance-card" class="glass p-6 rounded-3xl border-2 border-primary/20 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <img id="u-admin-avatar" src="" class="w-14 h-14 rounded-full border-2 border-primary">
                            <div class="absolute -bottom-1 -right-1 bg-primary text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">ADMIN</div>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg" id="u-admin-name">Admin</h4>
                            <p class="text-xs text-slate-500" id="u-admin-status">Đang tính toán...</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="block text-2xl font-black text-primary" id="u-admin-dist">--- km</span>
                        <span class="text-xs text-slate-400">Khoảng cách</span>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="unichAction('call', 'admin')" class="flex-1 py-2 bg-green-500 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 hover:bg-green-600"><i data-lucide="phone" class="w-3 h-3"></i> Gọi Admin</button>
                    <button onclick="unichAction('map', 'admin')" class="flex-1 py-2 bg-blue-500 text-white rounded-lg font-bold text-xs flex items-center justify-center gap-1 hover:bg-blue-600"><i data-lucide="navigation" class="w-3 h-3"></i> Chỉ đường</button>
                </div>
            </div>

            <!-- Network List -->
            <div class="glass p-6 rounded-3xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5 text-secondary"></i> Mạng lưới xung quanh
                    </h3>
                    <span id="unich-count" class="px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-xs font-bold">0 Online</span>
                </div>
                <div id="unich-list" class="space-y-3">
                    <p class="text-center text-slate-400 text-sm py-4">Chưa có ai tham gia mạng lưới hoặc bạn chưa cấp quyền vị trí.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="glass mt-8 p-4 rounded-2xl text-center space-y-2 reveal-on-scroll">
             <div class="grid grid-cols-2 gap-4 text-sm">
                <div><span class="block text-slate-400 text-xs">Địa chỉ IP</span><span id="user-ip" class="font-mono font-bold text-slate-700 dark:text-white">...</span></div>
                <div><span class="block text-slate-400 text-xs">Tọa độ</span><span id="user-coords" class="font-mono font-bold text-slate-700 dark:text-white">...</span></div>
            </div>
            <p class="text-slate-400 text-xs mt-2">&copy; 2024 Profile System.</p>
        </div>

    </main>
    
    <!-- MODALS (Giữ nguyên) -->
    <!-- Contact View Modal -->
    <div id="modal-contact" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4"><h3 id="contact-title" class="font-bold text-lg">Liên hệ</h3><button onclick="window.closeModal('modal-contact')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div id="contact-list" class="space-y-3"></div>
        </div>
    </div>
    <!-- Contact Send Form Modal -->
    <div id="modal-send-msg" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl relative"><button onclick="window.closeModal('modal-send-msg')" class="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button><h3 class="font-bold text-lg mb-4">Gửi tin nhắn</h3><form id="contact-form" class="space-y-4"><div><label class="lbl">Họ tên</label><input type="text" id="msg-name" class="inp"></div><div id="msg-email-group"><label class="lbl">Email</label><input type="email" id="msg-email" class="inp"></div><div><label class="lbl">Nội dung</label><textarea id="msg-content" rows="4" class="inp"></textarea></div><div class="flex items-center gap-2"><input type="checkbox" id="msg-anon" onchange="toggleAnon()" class="w-4 h-4 text-primary"><label for="msg-anon" class="text-sm font-medium">Gửi ẩn danh</label></div><button type="button" onclick="window.sendContact()" class="w-full py-2 bg-primary text-white font-bold rounded-xl shadow hover:bg-indigo-600 transition">Gửi đi</button></form></div>
    </div>
    <!-- Crop Image Modal -->
    <div id="modal-crop" class="fixed inset-0 bg-black z-[500] hidden flex flex-col"><div class="flex-1 bg-black relative flex items-center justify-center overflow-hidden"><img id="image-to-crop" src="" class="max-w-full max-h-full block"></div><div class="bg-slate-900 p-4 flex justify-between items-center text-white"><button onclick="window.closeModal('modal-crop')" class="px-4 py-2 font-bold text-slate-400">Hủy</button><div class="text-sm font-medium">Cắt ảnh</div><button onclick="window.confirmCrop()" class="px-6 py-2 bg-primary rounded-lg font-bold">Xác nhận</button></div></div>
    <!-- Manager Modal -->
    <div id="modal-manager" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4"><div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b dark:border-white/10 pb-4"><h3 class="font-bold text-lg">Quản lý người dùng</h3><button onclick="window.closeModal('modal-manager')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="flex-1 overflow-y-auto space-y-4" id="manager-list"></div></div></div>

    <!-- Admin Edit Modal -->
    <div id="modal-admin" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[300] hidden flex items-center justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full h-full sm:h-[90vh] sm:rounded-2xl sm:max-w-4xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b dark:border-white/10 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                <h3 class="font-black uppercase text-primary tracking-widest">Chỉnh sửa Profile</h3>
                <button onclick="window.closeModal('modal-admin')" class="p-2 bg-slate-200 dark:bg-slate-800 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <!-- Body -->
            <div class="flex-1 flex flex-col sm:flex-row overflow-hidden">
                <div class="w-full sm:w-48 bg-slate-50 dark:bg-slate-950 border-r dark:border-white/5 p-2 flex sm:flex-col gap-2 overflow-x-auto sm:overflow-visible shrink-0">
                    <button onclick="window.switchTab('general')" class="tab-btn active p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Chung</button>
                    <button onclick="window.switchTab('unich')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-cyan-500">Unich Setup</button>
                    <button onclick="window.switchTab('contact')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Liên hệ & MXH</button>
                    <button onclick="window.switchTab('career')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Học vấn & Việc</button>
                    <button onclick="window.switchTab('bank')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Ngân hàng</button>
                    <button onclick="window.switchTab('partners')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Đối tác</button>
                    <button onclick="window.switchTab('website')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-purple-500">Website</button>
                    <button onclick="window.switchTab('config')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-red-500">Cấu hình</button>
                </div>
                <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-slate-900 relative">
                    <form id="admin-form" class="space-y-6 max-w-2xl mx-auto pb-20">
                        <!-- TAB: GENERAL -->
                        <div id="tab-general" class="tab-content space-y-4">
                            <div class="flex gap-4 items-center"><img id="preview-avatar" src="" class="w-20 h-20 rounded-full object-cover border"><label class="flex-1 cursor-pointer"><div class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-bold text-center border-dashed border-2 border-slate-300 hover:border-primary">Tải ảnh mới (Có cắt)</div><input type="file" id="inp-avatar" class="hidden" accept="image/*"></label></div>
                            <div class="grid grid-cols-2 gap-4"><div><label class="lbl">Họ tên</label><input type="text" id="inp-name" class="inp"></div><div><label class="lbl">Biệt danh</label><input type="text" id="inp-nickname" class="inp"></div></div>
                            <div><label class="lbl">Tiểu sử (Bio)</label><textarea id="inp-bio" rows="3" class="inp"></textarea></div>
                            <div class="grid grid-cols-2 gap-4"><div><label class="lbl">Ngày sinh</label><input type="date" id="inp-dob" class="inp"></div><div><label class="lbl">Giới tính</label><select id="inp-gender" class="inp"><option>Nam</option><option>Nữ</option><option>Khác</option></select></div></div>
                            <div class="space-y-2 border p-3 rounded-xl dark:border-white/10"><label class="lbl text-primary">Quê quán (Chọn Tỉnh)</label><select id="api-city" onchange="updateHometownStr()" class="inp text-sm font-bold"><option value="">-- Chọn Tỉnh/Thành phố --</option></select><input type="hidden" id="inp-hometown-full"></div>
                            <div class="border p-3 rounded-xl dark:border-white/10 space-y-2"><label class="lbl">Mối quan hệ</label><select id="inp-rel-status" class="inp mb-2" onchange="togglePartnerInput()"><option value="Độc thân">Độc thân</option><option value="Đang hẹn hò">Đang hẹn hò</option><option value="Đã kết hôn">Đã kết hôn</option></select><div id="partner-inputs" class="hidden grid grid-cols-2 gap-2"><input type="text" id="inp-partner-name" placeholder="Tên người ấy" class="inp"><input type="text" id="inp-partner-link" placeholder="Link Profile (FB...)" class="inp"></div></div>
                        </div>
                        <!-- TAB: UNICH -->
                        <div id="tab-unich" class="tab-content hidden space-y-4">
                            <div class="p-4 bg-cyan-50 dark:bg-cyan-900/20 rounded-xl space-y-3">
                                <h4 class="font-bold text-cyan-600">Cấu hình Unich Project</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="col-span-2"><label class="lbl">Tiêu đề dự án</label><input type="text" id="unich-inp-title" class="inp"></div>
                                    <div class="col-span-2"><label class="lbl">Mô tả ngắn</label><textarea id="unich-inp-desc" rows="2" class="inp"></textarea></div>
                                    <div><label class="lbl">Logo URL</label><input type="text" id="unich-inp-logo" class="inp"></div>
                                    <div><label class="lbl">QR Code URL</label><input type="text" id="unich-inp-qr" class="inp"></div>
                                    <div><label class="lbl">Link App Store</label><input type="text" id="unich-inp-ios" class="inp"></div>
                                    <div><label class="lbl">Link Google Play</label><input type="text" id="unich-inp-android" class="inp"></div>
                                </div>
                            </div>
                        </div>
                        <!-- TAB: CONTACT -->
                        <div id="tab-contact" class="tab-content hidden space-y-4">
                            <div class="space-y-2 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl"><label class="lbl">Số điện thoại</label><div id="phone-list-editor" class="grid grid-cols-1 gap-2"></div><button type="button" onclick="addPhoneInput()" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-white hover:text-primary transition">+ Thêm số mới</button></div>
                             <div><label class="lbl">Email</label><input type="text" id="inp-emails" class="inp"></div><div><label class="lbl">Facebook</label><input type="text" id="inp-fb" class="inp"></div><div><label class="lbl">Zalo</label><input type="text" id="inp-zalo" class="inp"></div><div><label class="lbl">Instagram</label><input type="text" id="inp-ig" class="inp"></div><div><label class="lbl">Telegram</label><input type="text" id="inp-tele" class="inp"></div><div><label class="lbl">LinkedIn</label><input type="text" id="inp-linkedin" class="inp"></div>
                        </div>
                        <!-- TAB: CAREER -->
                        <div id="tab-career" class="tab-content hidden space-y-4"><label class="lbl">Dữ liệu JSON</label><textarea id="inp-career-json" rows="10" class="inp font-mono text-xs"></textarea></div>
                        <!-- TAB: BANK -->
                        <div id="tab-bank" class="tab-content hidden space-y-4"><div class="flex gap-2"><select id="api-bank-list" class="inp w-1/2"></select><input type="text" id="bank-acc-num" placeholder="Số tài khoản" class="inp w-1/2"></div><input type="text" id="bank-acc-name" placeholder="Tên chủ thẻ" class="inp"><button type="button" onclick="addBank()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm Ngân hàng</button><div id="admin-bank-list" class="space-y-2 mt-4"></div></div>
                        <!-- TAB: PARTNERS -->
                        <div id="tab-partners" class="tab-content hidden space-y-4"><div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl space-y-3"><label class="lbl">Thêm/Sửa Đối tác</label><input type="text" id="partner-logo-url" placeholder="Link ảnh Logo" class="inp"><input type="text" id="partner-link" placeholder="Link trang web" class="inp"><button type="button" onclick="addPartner()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm vào danh sách</button></div><div id="admin-partner-list" class="grid grid-cols-2 gap-3"></div></div>
                        <!-- TAB: WEBSITE -->
                        <div id="tab-website" class="tab-content hidden space-y-4"><div class="p-4 bg-purple-50 dark:bg-purple-900/10 rounded-xl space-y-3"><div><label class="lbl">Title</label><input type="text" id="meta-title-inp" class="inp"></div><div><label class="lbl">Description</label><textarea id="meta-desc-inp" rows="2" class="inp"></textarea></div><div><label class="lbl">Favicon</label><input type="text" id="meta-icon-inp" class="inp"></div></div></div>
                        <!-- TAB: CONFIG -->
                        <div id="tab-config" class="tab-content hidden space-y-4"><div class="p-4 bg-red-50 dark:bg-red-900/10 rounded-xl space-y-3"><h4 class="font-bold text-red-500 text-sm">Cấu hình GitHub</h4><input type="password" id="gh-token" placeholder="Token" class="inp"><input type="text" id="gh-owner" placeholder="Username" class="inp"><input type="text" id="gh-repo" placeholder="Repository" class="inp"></div><div class="p-4 bg-blue-50 dark:bg-blue-900/10 rounded-xl space-y-3"><h4 class="font-bold text-blue-500 text-sm">Cấu hình USB Key</h4><div class="flex gap-2"><input type="text" id="usb-secret-val" placeholder="Nhập mã bí mật..." class="inp"><button type="button" onclick="saveUSBConfig()" class="px-4 bg-blue-500 text-white rounded-lg font-bold text-xs">Lưu</button></div></div></div>
                    </form>
                </div>
            </div>
            <div class="p-4 border-t dark:border-white/10 bg-white dark:bg-slate-900 flex justify-end gap-3"><button onclick="window.closeModal('modal-admin')" class="px-6 py-2 rounded-xl text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 transition">Hủy</button><button onclick="window.saveProfile()" class="px-6 py-2 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-indigo-600 transition">Lưu Thay Đổi</button></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 z-[1000] translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 font-bold text-sm">
            <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg">Thông báo</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, arrayUnion, arrayRemove, increment, collection, getDocs, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", 
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };
        const ADMIN_EMAILS = ["sonlyhongduc@gmail.com"]; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;
        let isUSBAdmin = false;
        let profileData = {};
        let ghConfig = {};
        let listBanks = [];
        let listPartners = [];
        let cropper = null;
        let croppedAvatarBase64 = null;
        let unichAdminData = null; // Admin location from DB

        const carrierLogos = {
            'viettel': 'https://upload.wikimedia.org/wikipedia/commons/4/4e/Viettel_logo_2021.png',
            'vinaphone': 'https://hdd.io.vn/img/vina.png',
            'mobifone': 'https://hdd.io.vn/img/mobi.PNG',
            'vietnamobile': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Vietnamobile_Logo.png/800px-Vietnamobile_Logo.png',
            'itel': 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Logo_Itel.png/800px-Logo_Itel.png'
        };

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if(user) {
                await setDoc(doc(db, "users", user.uid), { uid: user.uid, displayName: user.displayName, email: user.email, photoURL: user.photoURL, lastSeen: new Date().toISOString() }, { merge: true });
                const adminRef = doc(db, "settings", "admins");
                const adminSnap = await getDoc(adminRef);
                const serverAdmins = adminSnap.exists() ? adminSnap.data().emails : [];
                isAdmin = ADMIN_EMAILS.includes(user.email) || (serverAdmins && serverAdmins.includes(user.email));
                checkAdminUI();
                document.getElementById('unich-auth-warn').classList.add('hidden');
            } else {
                isAdmin = false; checkAdminUI();
                document.getElementById('unich-auth-warn').classList.remove('hidden');
            }
            renderAuthUI(); checkFollowStatus();
        });

        // VIEW SWITCHER
        window.switchMainView = (view) => {
            const pBtn = document.getElementById('btn-view-profile');
            const uBtn = document.getElementById('btn-view-unich');
            const pDiv = document.getElementById('view-profile');
            const uDiv = document.getElementById('view-unich');

            if(view === 'profile') {
                pBtn.classList.replace('text-slate-500', 'text-primary'); pBtn.classList.add('bg-white','dark:bg-slate-700','shadow-md');
                uBtn.classList.replace('text-cyan-500', 'text-slate-500'); uBtn.classList.remove('bg-white','dark:bg-slate-700','shadow-md');
                pDiv.classList.remove('hidden'); setTimeout(()=>pDiv.classList.remove('opacity-0'),10);
                uDiv.classList.add('hidden', 'opacity-0');
            } else {
                uBtn.classList.replace('text-slate-500', 'text-cyan-500'); uBtn.classList.add('bg-white','dark:bg-slate-700','shadow-md');
                pBtn.classList.replace('text-primary', 'text-slate-500'); pBtn.classList.remove('bg-white','dark:bg-slate-700','shadow-md');
                uDiv.classList.remove('hidden'); setTimeout(()=>uDiv.classList.remove('opacity-0'),10);
                pDiv.classList.add('hidden', 'opacity-0');
                loadUnichNetwork(); // Start listen
            }
        }

        // UNICH LOGIC
        window.joinUnichNetwork = () => {
            if(!currentUser) { window.doLogin(); return; }
            const contact = document.getElementById('unich-my-contact').value;
            if(!contact) { showToast("Vui lòng nhập SĐT/Zalo!", true); return; }
            if(!navigator.geolocation) { showToast("Máy bạn không hỗ trợ GPS!", true); return; }
            
            showToast("Đang lấy vị trí...");
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const data = {
                    uid: currentUser.uid,
                    name: currentUser.displayName,
                    avatar: currentUser.photoURL,
                    contact: contact,
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    timestamp: new Date().toISOString(),
                    device: /iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'iOS' : 'Android/PC'
                };
                await setDoc(doc(db, "unich_network", currentUser.uid), data);
                showToast("Đã cập nhật vị trí lên mạng lưới!");
            }, (err) => showToast("Lỗi lấy vị trí: " + err.message, true), {enableHighAccuracy: true});
        }

        let unichUnsubscribe = null;
        let myCurrentLocation = null;

        function loadUnichNetwork() {
            if(unichUnsubscribe) return; // Already listening
            const listEl = document.getElementById('unich-list');
            
            // Get Admin Location First (from profile data)
            const adminLat = profileData.unich?.adminLat || 0;
            const adminLng = profileData.unich?.adminLng || 0;
            if(adminLat && adminLng) {
                unichAdminData = { lat: adminLat, lng: adminLng };
                document.getElementById('admin-distance-card').classList.remove('hidden');
                document.getElementById('u-admin-avatar').src = profileData.avatar;
                document.getElementById('u-admin-name').innerText = profileData.name;
            }

            unichUnsubscribe = onSnapshot(collection(db, "unich_network"), (snapshot) => {
                const users = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    // If it's me, store my loc
                    if(currentUser && d.uid === currentUser.uid) myCurrentLocation = { lat: d.lat, lng: d.lng };
                    users.push(d);
                });

                document.getElementById('unich-count').innerText = `${users.length} Online`;

                // Calculate distances
                if(myCurrentLocation) {
                    // 1. Calc Admin Dist
                    if(unichAdminData) {
                        const dAdmin = getDist(myCurrentLocation.lat, myCurrentLocation.lng, unichAdminData.lat, unichAdminData.lng);
                        document.getElementById('u-admin-dist').innerText = dAdmin.toFixed(2) + " km";
                        document.getElementById('u-admin-status').innerText = "Đã định vị";
                    }

                    // 2. Calc Peers Dist
                    users.forEach(u => {
                        u.distance = getDist(myCurrentLocation.lat, myCurrentLocation.lng, u.lat, u.lng);
                    });
                    
                    // 3. Sort (Nearest to Farthest)
                    users.sort((a,b) => a.distance - b.distance);
                }

                renderUnichList(users);
            });
        }

        function renderUnichList(users) {
            const listEl = document.getElementById('unich-list');
            if(users.length === 0) { listEl.innerHTML = '<p class="text-center text-slate-400">Chưa có ai.</p>'; return; }
            
            listEl.innerHTML = users.map(u => {
                const isMe = currentUser && u.uid === currentUser.uid;
                const distStr = isMe ? "Bạn ở đây" : (u.distance ? `${u.distance.toFixed(2)} km` : "Đang tính...");
                const contactEncoded = encodeURIComponent(u.contact);
                const uJson = encodeURIComponent(JSON.stringify(u)); // For actions

                return `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5 ${isMe ? 'border-l-4 border-l-cyan-500 shadow-md' : ''}">
                    <div class="flex items-center gap-3">
                        <img src="${u.avatar}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <p class="font-bold text-sm text-slate-800 dark:text-white flex items-center gap-1">
                                ${u.name} ${isMe ? '<span class="text-[10px] bg-cyan-100 text-cyan-600 px-1 rounded">ME</span>' : ''}
                            </p>
                            <p class="text-xs text-slate-500">${distStr}</p>
                        </div>
                    </div>
                    ${!isMe ? `
                    <div class="flex gap-2">
                        <button onclick='unichAction("call", "${uJson}")' class="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"><i data-lucide="phone" class="w-4 h-4"></i></button>
                        <button onclick='unichAction("map", "${uJson}")' class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"><i data-lucide="navigation" class="w-4 h-4"></i></button>
                    </div>
                    ` : ''}
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // Action Handler (Call / Map)
        window.unichAction = (type, dataStr) => {
            let target = {};
            if(dataStr === 'admin') target = { lat: unichAdminData.lat, lng: unichAdminData.lng, contact: profileData.phones?.[0]?.number }; 
            else target = JSON.parse(decodeURIComponent(dataStr));

            if(type === 'call') {
                if(target.contact) window.location.href = `tel:${target.contact}`;
                else showToast("Người này không công khai SĐT", true);
            } else if (type === 'map') {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const url = isIOS 
                    ? `http://maps.apple.com/?daddr=${target.lat},${target.lng}`
                    : `https://www.google.com/maps/dir/?api=1&destination=${target.lat},${target.lng}`;
                window.open(url, '_blank');
            }
        }

        // Distance Calc (Haversine)
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }


        // DATA RENDER (ORIGINAL)
        const profileRef = doc(db, "profile_data", "main");
        onSnapshot(profileRef, (docSnap) => {
            document.getElementById('global-loading').classList.add('opacity-0', 'pointer-events-none');
            if (docSnap.exists()) {
                profileData = docSnap.data();
                renderProfile();
                initScrollReveal();
            }
        });

        function renderProfile() {
            // ... (Code render gốc giữ nguyên)
            document.title = profileData.meta?.title || profileData.name;
            document.getElementById('profile-name').innerText = profileData.name || "No Name";
            document.getElementById('nav-nickname').innerText = profileData.nickname || "User";
            if(profileData.avatar) { document.getElementById('profile-avatar').src = profileData.avatar; document.getElementById('nav-avatar').src = profileData.avatar; }
            if(profileData.nickname) { document.getElementById('profile-nickname-badge').innerText = profileData.nickname; document.getElementById('profile-nickname-badge').classList.remove('hidden'); }
            document.getElementById('profile-bio').innerText = profileData.bio || "...";
            document.getElementById('stat-followers').innerText = (profileData.followers || []).length;
            document.getElementById('stat-views').innerText = profileData.views || 0;
            
            const relEl = document.getElementById('relationship-display');
            if (profileData.relationship?.status && profileData.relationship.status !== 'Độc thân') { relEl.classList.remove('hidden'); let html = `${profileData.relationship.status}`; if(profileData.relationship.partnerName) html += ` với <a href="${profileData.relationship.partnerLink || '#'}" target="_blank" class="font-black hover:underline">${profileData.relationship.partnerName}</a>`; document.getElementById('rel-status').innerHTML = html; } else relEl.classList.add('hidden');

            document.getElementById('info-dob').innerText = formatDate(profileData.dob);
            document.getElementById('info-gender').innerText = profileData.gender || "---";
            document.getElementById('info-hometown').innerText = profileData.hometown?.full || "---";

            let socialHtml = '';
            const socialMap = {facebook:'facebook', zalo:'phone', instagram:'instagram', telegram:'send', linkedin:'linkedin'};
            if(profileData.socials) { Object.keys(profileData.socials).forEach(key => { const val = profileData.socials[key]; if(val) { let link = val; if(key === 'zalo') link = `https://zalo.me/${val}`; if(key === 'telegram') link = `https://t.me/${val}`; socialHtml += `<a href="${link}" target="_blank" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow hover:-translate-y-1 transition text-slate-600 dark:text-white"><i data-lucide="${socialMap[key] || 'link'}" class="w-5 h-5"></i></a>`; } }); }
            document.getElementById('social-grid').innerHTML = socialHtml;
            
            document.getElementById('bank-list').innerHTML = (profileData.banks || []).map(b => `<div class="bank-card p-3 rounded-xl flex items-center justify-between shadow-lg relative overflow-hidden group bg-white dark:bg-slate-900 border dark:border-white/5"><div class="flex items-center gap-4 z-10"><div class="w-12 h-12 bg-white rounded-lg shadow-inner flex items-center justify-center shrink-0 overflow-hidden relative"><img src="${b.logo}" class="w-full h-full object-contain p-1"></div><div><p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">${b.shortName}</p><p class="font-mono font-bold text-lg tracking-normal text-slate-800 dark:text-white select-all">${b.number}</p><p class="text-[10px] font-bold uppercase text-slate-500">${b.owner}</p></div></div><button onclick="window.copyToClip('${b.number}')" class="p-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary hover:text-white rounded-lg z-10 transition"><i data-lucide="copy" class="w-4 h-4"></i></button></div>`).join('');
            
            const timeline = [...(profileData.education || []), ...(profileData.work || [])];
            document.getElementById('career-timeline').innerHTML = timeline.length ? timeline.map(item => `<div class="relative mb-6 last:mb-0"><span class="absolute -left-[33px] w-4 h-4 rounded-full bg-primary border-4 border-white dark:border-slate-800"></span><h4 class="font-bold text-slate-800 dark:text-white">${item.title}</h4><p class="text-xs font-bold text-primary mb-1">${item.org}</p><p class="text-xs text-slate-500">${item.time}</p></div>`).join('') : '<p class="text-sm text-slate-400 italic">Chưa cập nhật.</p>';
            
            document.getElementById('achievement-list').innerHTML = (profileData.achievements||[]).map(a => `<div class="p-4 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5 flex items-start gap-3"><div class="p-2 bg-yellow-100 dark:bg-yellow-900/20 text-yellow-600 rounded-lg"><i data-lucide="award" class="w-5 h-5"></i></div><div><h5 class="font-bold text-sm">${a.title}</h5><span class="text-[10px] font-bold px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-slate-500">${a.date}</span></div></div>`).join('');

            const pGrid = document.getElementById('partners-grid');
            if(profileData.partners?.length) { document.getElementById('partners-section').classList.remove('hidden'); pGrid.innerHTML = profileData.partners.map(p => `<a href="${p.link}" target="_blank" class="block group"><img src="${p.logo}" class="h-8 md:h-10 w-auto object-contain transition group-hover:scale-110"></a>`).join(''); } else document.getElementById('partners-section').classList.add('hidden');

            // Render Unich Tab Info
            if(profileData.unich) {
                document.getElementById('unich-title').innerText = profileData.unich.title || "Unich Network";
                document.getElementById('unich-desc').innerText = profileData.unich.desc || "Kết nối cộng đồng.";
                if(profileData.unich.logo) document.getElementById('unich-logo').src = profileData.unich.logo;
                if(profileData.unich.qr) document.getElementById('unich-qr').src = profileData.unich.qr;
                if(profileData.unich.ios) { document.getElementById('unich-ios').href = profileData.unich.ios; document.getElementById('unich-ios').classList.remove('hidden'); }
                if(profileData.unich.android) { document.getElementById('unich-android').href = profileData.unich.android; document.getElementById('unich-android').classList.remove('hidden'); }
            }

            loadNetworkInfo();
            lucide.createIcons();
        }

        // SAVE PROFILE (ADMIN)
        window.openEditModal = async () => {
            document.getElementById('modal-admin').classList.remove('hidden');
            // Fill basics
            document.getElementById('inp-name').value = profileData.name||''; document.getElementById('inp-nickname').value = profileData.nickname||''; document.getElementById('inp-bio').value = profileData.bio||''; document.getElementById('inp-dob').value = profileData.dob||''; document.getElementById('inp-gender').value = profileData.gender||'Nam';
            await fetchProvinces(); document.getElementById('inp-hometown-full').value = profileData.hometown?.full||''; const cityS = document.getElementById('api-city'); for(let i=0;i<cityS.options.length;i++){if(cityS.options[i].dataset.name === profileData.hometown?.full){cityS.selectedIndex = i;break;}}
            
            // Unich Fill
            const unich = profileData.unich || {};
            document.getElementById('unich-inp-title').value = unich.title||'';
            document.getElementById('unich-inp-desc').value = unich.desc||'';
            document.getElementById('unich-inp-logo').value = unich.logo||'';
            document.getElementById('unich-inp-qr').value = unich.qr||'';
            document.getElementById('unich-inp-ios').value = unich.ios||'';
            document.getElementById('unich-inp-android').value = unich.android||'';

            // Lists
            listBanks=profileData.banks||[]; renderAdminBanks(); loadBankList();
            listPartners=profileData.partners||[]; renderAdminPartners();
            const phones = profileData.phones||[]; document.getElementById('phone-list-editor').innerHTML = ''; phones.forEach(p => addPhoneInput(p.number, p.carrier));
            document.getElementById('inp-emails').value = profileData.email||''; document.getElementById('inp-fb').value = profileData.socials?.facebook||''; document.getElementById('inp-zalo').value = profileData.socials?.zalo||''; document.getElementById('inp-ig').value = profileData.socials?.instagram||''; document.getElementById('inp-tele').value = profileData.socials?.telegram||''; document.getElementById('inp-linkedin').value = profileData.socials?.linkedin||'';
            document.getElementById('inp-career-json').value = JSON.stringify({education:profileData.education||[], work:profileData.work||[], achievements:profileData.achievements||[]},null,2);
        }

        window.saveProfile = async () => {
             const btn = document.querySelector('#modal-admin button.bg-primary'); btn.innerText = "Đang lưu...";
             try {
                let avatarUrl = profileData.avatar;
                if(croppedAvatarBase64 && ghConfig.token) {
                    const content = croppedAvatarBase64.split(',')[1];
                    const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/avatars/${Date.now()}.png`;
                    const res = await fetch(url, { method:'PUT', headers:{'Authorization':`token ${ghConfig.token}`}, body:JSON.stringify({message:"Up", content}) });
                    if(res.ok) { const d = await res.json(); avatarUrl = d.content.download_url; }
                }

                // Get current Admin Geo for Unich Ref
                let adminGeo = {};
                if(navigator.geolocation) {
                    try {
                        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
                        adminGeo = { adminLat: pos.coords.latitude, adminLng: pos.coords.longitude };
                    } catch(e) {}
                }

                const phones = Array.from(document.querySelectorAll('#phone-list-editor .phone-row')).map(r=>({carrier:r.querySelector('select').value, number:r.querySelector('input').value})).filter(x=>x.number);
                let careerData = {}; try{careerData=JSON.parse(document.getElementById('inp-career-json').value)}catch(e){}
                
                const newData = {
                    name: document.getElementById('inp-name').value,
                    nickname: document.getElementById('inp-nickname').value,
                    bio: document.getElementById('inp-bio').value,
                    dob: document.getElementById('inp-dob').value,
                    gender: document.getElementById('inp-gender').value,
                    hometown: { full: document.getElementById('inp-hometown-full').value },
                    avatar: avatarUrl,
                    email: document.getElementById('inp-emails').value,
                    phones: phones,
                    socials: {
                        facebook: document.getElementById('inp-fb').value,
                        zalo: document.getElementById('inp-zalo').value,
                        instagram: document.getElementById('inp-ig').value,
                        telegram: document.getElementById('inp-tele').value,
                        linkedin: document.getElementById('inp-linkedin').value,
                    },
                    unich: {
                        title: document.getElementById('unich-inp-title').value,
                        desc: document.getElementById('unich-inp-desc').value,
                        logo: document.getElementById('unich-inp-logo').value,
                        qr: document.getElementById('unich-inp-qr').value,
                        ios: document.getElementById('unich-inp-ios').value,
                        android: document.getElementById('unich-inp-android').value,
                        ...adminGeo // Save admin coords to profile so users can calculate dist
                    },
                    banks: listBanks,
                    partners: listPartners,
                    education: careerData.education||[], work: careerData.work||[], achievements: careerData.achievements||[]
                };
                await setDoc(profileRef, newData, { merge: true });
                showToast("Lưu thành công!"); window.closeModal('modal-admin');
             } catch(e) { showToast("Lỗi: "+e.message, true); }
             btn.innerText = "Lưu Thay Đổi";
        }

        // HELPERS & OTHERS (Giữ nguyên từ bản gốc)
        document.getElementById('usb-key-input').addEventListener('change', async (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=async(ev)=>{try{const c=JSON.parse(ev.target.result); if(c.key){const s=await getDoc(doc(db,"settings","usb_config")); if(s.exists()&&s.data().secret===c.key){isUSBAdmin=true; showToast("USB Key OK"); checkAdminUI();}}}catch(e){}}; r.readAsText(f); });
        function checkAdminUI(){ const s=isAdmin||isUSBAdmin; document.getElementById('admin-btn').classList.toggle('hidden',!s); document.getElementById('manager-btn').classList.toggle('hidden',!s); if(s)loadGithubConfig(); }
        window.doLogin = () => signInWithPopup(auth, provider); window.doLogout = () => signOut(auth).then(()=> location.reload());
        window.addPhoneInput=(v='',c='Viettel')=>{const d=document.createElement('div');d.className='phone-row flex gap-2 items-center bg-white p-2 rounded shadow-sm';d.innerHTML=`<select class="inp w-[110px] shrink-0 carrier-select text-xs">${Object.keys(carrierLogos).map(k=>`<option value="${k.charAt(0).toUpperCase()+k.slice(1)}" ${c.toLowerCase()===k?'selected':''}>${k.toUpperCase()}</option>`).join('')}</select><input type="text" value="${v}" class="inp phone-inp flex-1 font-bold text-slate-700 min-w-0" placeholder="09xxxx"><button type="button" onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;document.getElementById('phone-list-editor').appendChild(d);lucide.createIcons();}
        
        // Modal & Utils
        window.closeModal=(id)=>document.getElementById(id).classList.add('hidden');
        window.toggleTheme=()=>{document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light');}
        if(localStorage.theme==='dark')document.documentElement.classList.add('dark');
        window.copyToClip=(t)=>{navigator.clipboard.writeText(t); showToast('Đã sao chép!');}
        function formatDate(d){if(!d)return"";const[y,m,day]=d.split('-');return`${day}/${m}/${y}`;}
        function showToast(m,e=false){const t=document.getElementById('toast');document.getElementById('toast-msg').innerText=m;const i=document.getElementById('toast-icon');i.setAttribute('data-lucide',e?'alert-triangle':'check-circle');i.classList.toggle('text-red-500',e);i.classList.toggle('text-green-500',!e);lucide.createIcons();t.classList.remove('translate-y-20','opacity-0');setTimeout(()=>t.classList.add('translate-y-20','opacity-0'),3000);}
        async function fetchProvinces(){const r=await fetch('https://esgoo.net/api-tinhthanh/1/0.htm');const d=await r.json();if(d.error===0)document.getElementById('api-city').innerHTML='<option value="">-- Chọn Tỉnh/Thành phố --</option>'+d.data.map(p=>`<option value="${p.id}" data-name="${p.full_name}">${p.full_name}</option>`).join('');}
        window.updateHometownStr=()=>{const c=document.getElementById('api-city');document.getElementById('inp-hometown-full').value=c.options[c.selectedIndex]?.dataset.name||'';}
        async function loadBankList(){try{const r=await fetch('https://api.vietqr.io/v2/banks');const d=await r.json();if(d.code==="00")document.getElementById('api-bank-list').innerHTML=d.data.map(b=>`<option value='${JSON.stringify({shortName:b.shortName,logo:b.logo})}'>${b.shortName}</option>`).join('');}catch(e){}}
        window.addBank=()=>{listBanks.push({...JSON.parse(document.getElementById('api-bank-list').value),number:document.getElementById('bank-acc-num').value,owner:document.getElementById('bank-acc-name').value});renderAdminBanks();document.getElementById('bank-acc-num').value='';}
        function renderAdminBanks(){document.getElementById('admin-bank-list').innerHTML=listBanks.map((b,i)=>`<div class="flex items-center justify-between p-2 bg-slate-100 rounded"><span class="text-xs font-bold">${b.shortName}-${b.number}</span><button onclick="removeBank(${i})" class="text-red-500 text-xs">X</button></div>`).join('');}
        window.removeBank=(i)=>{listBanks.splice(i,1);renderAdminBanks();}
        window.addPartner=()=>{listPartners.push({logo:document.getElementById('partner-logo-url').value,link:document.getElementById('partner-link').value});renderAdminPartners();}
        function renderAdminPartners(){document.getElementById('admin-partner-list').innerHTML=listPartners.map((p,i)=>`<div class="relative p-2 border rounded flex items-center justify-center bg-white h-16"><img src="${p.logo}" class="h-full object-contain"><button onclick="removePartner(${i})" class="absolute top-1 right-1 text-red-500">x</button></div>`).join('');}
        window.removePartner=(i)=>{listPartners.splice(i,1);renderAdminPartners();}
        window.switchTab=(t)=>{document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));document.getElementById('tab-'+t).classList.remove('hidden');document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('bg-white','dark:bg-white/5','shadow-sm'));event.target.classList.add('bg-white','dark:bg-white/5','shadow-sm');}
        window.togglePartnerInput=()=>{document.getElementById('partner-inputs').classList.toggle('hidden',document.getElementById('inp-rel-status').value==='Độc thân');}
        async function loadGithubConfig(){const s=await getDoc(doc(db,"settings","github_config"));if(s.exists()){ghConfig=s.data();document.getElementById('gh-token').value=ghConfig.token||'';document.getElementById('gh-owner').value=ghConfig.owner||'';document.getElementById('gh-repo').value=ghConfig.repo||'';}}
        document.getElementById('inp-avatar').addEventListener('change',(e)=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=(v)=>{document.getElementById('image-to-crop').src=v.target.result;document.getElementById('modal-crop').classList.remove('hidden');if(cropper)cropper.destroy();cropper=new Cropper(document.getElementById('image-to-crop'),{aspectRatio:1,viewMode:1});};r.readAsDataURL(f);}});
        window.confirmCrop=()=>{if(!cropper)return;croppedAvatarBase64=cropper.getCroppedCanvas({width:400,height:400}).toDataURL();document.getElementById('preview-avatar').src=croppedAvatarBase64;window.closeModal('modal-crop');}
        const obs=new IntersectionObserver(e=>e.forEach(n=>{if(n.isIntersecting)n.target.classList.add('active')}),{threshold:0.1});
        function initScrollReveal(){document.querySelectorAll('.reveal-on-scroll').forEach(e=>obs.observe(e));}
        function loadNetworkInfo(){fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>document.getElementById('user-ip').innerText=d.ip).catch(()=>{});if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>document.getElementById('user-coords').innerText=`${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`);}

        lucide.createIcons();
    </script>
    <style>.inp{width:100%;padding:0.5rem 1rem;border-radius:0.5rem;border:1px solid #e2e8f0;background-color:#f8fafc;outline:none;font-size:0.875rem}.dark .inp{background-color:#1e293b;border-color:rgba(255,255,255,0.1);color:white}.inp:focus{border-color:#6366f1}.lbl{display:block;font-size:0.75rem;font-weight:700;text-transform:uppercase;color:#64748b;margin-bottom:0.25rem}.btn-primary{background-color:#6366f1;color:white}</style>
</body>
</html>
