<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO CONFIG -->
    <title>Bmass Profile</title>
    <meta name="description" id="meta-desc" content="Trang cá nhân & Dự án Unich">
    <link rel="icon" id="meta-icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    
    <!-- PWA -->
    <meta name="theme-color" content="#6366f1">
    <link rel="manifest" id="dynamic-manifest">
    
    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { primary: '#6366f1', secondary: '#ec4899', dark: '#0f172a' },
                    animation: { 'blob': 'blob 7s infinite', 'bounce-slow': 'bounce 2s infinite' },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        }
                    }
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255,255,255,0.05); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        .reveal-on-scroll { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.5, 0, 0, 1); }
        .reveal-on-scroll.active { opacity: 1; transform: translateY(0); }
        .inp { width: 100%; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; background-color: #f8fafc; outline: none; font-size: 0.875rem; }
        .dark .inp { background-color: #1e293b; border-color: rgba(255,255,255,0.1); color: white; }
        .inp:focus { border-color: #6366f1; }
        .lbl { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 0.25rem; }
        .btn-primary { background-color: #6366f1; color: white; }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden pb-10">

    <!-- Background Elements -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-primary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-secondary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-purple-500/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Loading -->
    <div id="global-loading" class="fixed inset-0 bg-white dark:bg-slate-950 z-[900] flex flex-col items-center justify-center transition-opacity duration-300">
        <img src="/img/bmassloadings.png" class="w-20 h-20 mb-4 animate-bounce-slow drop-shadow-2xl" onerror="this.src='https://hdd.io.vn/img/bmassloadings.png'">
        <span class="text-sm font-bold text-slate-500 tracking-widest uppercase">Đang tải dữ liệu...</span>
    </div>

    <input type="file" id="usb-key-input" class="hidden" accept=".json,.txt">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass px-6 py-3 flex justify-between items-center mb-8">
        <div class="flex items-center gap-3">
            <img id="nav-avatar" src="https://ui-avatars.com/api/?name=P" class="w-9 h-9 rounded-full object-cover border-2 border-primary/20 shadow-sm">
            <span id="nav-nickname" class="font-bold text-lg hidden sm:block tracking-tight truncate max-w-[150px]">MyProfile</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
            </button>
            <button onclick="document.getElementById('usb-key-input').click()" class="p-2 rounded-full text-slate-400 hover:text-primary hover:bg-black/5 dark:hover:bg-white/10 transition">
                <i data-lucide="usb" class="w-5 h-5"></i>
            </button>
            <button id="admin-btn" onclick="window.openEditModal()" class="hidden px-3 py-1.5 bg-slate-800 dark:bg-white text-white dark:text-slate-900 rounded-lg text-xs font-bold uppercase shadow hover:opacity-90 transition gap-2 items-center">
                <i data-lucide="edit-3" class="w-3 h-3"></i> Sửa
            </button>
             <button id="manager-btn" onclick="window.openManagerModal()" class="hidden p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                <i data-lucide="users" class="w-5 h-5"></i>
            </button>
            <div id="auth-section"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 space-y-6">

        <!-- Header Card -->
        <div class="glass rounded-3xl p-6 sm:p-8 flex flex-col md:flex-row items-center md:items-start gap-6 relative overflow-hidden reveal-on-scroll">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-primary to-secondary rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&size=256" class="relative w-32 h-32 sm:w-40 sm:h-40 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-xl">
                <div id="online-indicator" class="absolute bottom-2 right-2 w-5 h-5 bg-green-500 border-4 border-white dark:border-slate-800 rounded-full"></div>
            </div>

            <div class="flex-1 text-center md:text-left space-y-2 z-10">
                <div class="flex flex-col md:flex-row items-center gap-2 md:gap-4 justify-center md:justify-start">
                    <h1 id="profile-name" class="text-3xl sm:text-4xl font-black tracking-tight text-slate-800 dark:text-white">Loading...</h1>
                    <span id="profile-nickname-badge" class="px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold uppercase tracking-wider hidden"></span>
                </div>
                
                <p id="profile-bio" class="text-slate-500 dark:text-slate-400 font-medium max-w-lg mx-auto md:mx-0">...</p>

                <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 py-3">
                    <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                        <i data-lucide="users" class="w-4 h-4 text-primary"></i>
                        <span id="stat-followers">0</span> <span class="text-slate-400 font-normal">Người theo dõi</span>
                    </div>
                    <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                        <i data-lucide="eye" class="w-4 h-4 text-secondary"></i>
                        <span id="stat-views">0</span> <span class="text-slate-400 font-normal">Lượt xem</span>
                    </div>
                </div>

                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-2">
                    <button id="follow-btn" onclick="window.toggleFollow()" class="px-6 py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:transform hover:scale-105 transition flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> Theo dõi
                    </button>
                    <button onclick="window.showContactModal('phone')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-primary hover:border-primary transition shadow-sm">
                        <i data-lucide="phone" class="w-5 h-5"></i>
                    </button>
                    <button onclick="window.showContactModal('email')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-secondary hover:border-secondary transition shadow-sm">
                        <i data-lucide="mail" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- === UNICH PROJECT SECTION === -->
        <div id="unich-card" class="glass p-6 sm:p-8 rounded-3xl mt-6 relative overflow-hidden hidden group border-2 border-cyan-500/20">
            <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-400/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            <div class="relative z-10 flex flex-col md:flex-row gap-6 items-center">
                <!-- Logo -->
                <div class="shrink-0 relative">
                    <img id="unich-logo-img" src="https://i.imgur.com/8bgJ4zR.png" class="w-24 h-24 rounded-2xl shadow-lg border-2 border-white dark:border-slate-700 object-cover bg-white">
                    <span class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider shadow-md whitespace-nowrap">Hot Project</span>
                </div>
                <!-- Content -->
                <div class="flex-1 w-full text-center md:text-left space-y-3">
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 dark:text-white flex items-center justify-center md:justify-start gap-2">
                            UNICH <span class="text-xs font-medium text-cyan-600 bg-cyan-100 dark:bg-cyan-900/30 dark:text-cyan-400 px-2 py-0.5 rounded-md border border-cyan-200 dark:border-cyan-800">DEX & OTC</span>
                        </h3>
                        <p id="unich-desc-txt" class="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">Sàn giao dịch phi tập trung tiềm năng. Đăng ký ngay!</p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="p-2 bg-slate-50 dark:bg-slate-900/50 border dark:border-white/10 rounded-xl flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white dark:bg-slate-800 flex items-center justify-center shadow-sm text-slate-400">
                                <i data-lucide="hash" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1 min-w-0 text-left">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Mã mời</p>
                                <p id="unich-ref-code" class="font-mono font-bold text-lg text-cyan-600 dark:text-cyan-400 leading-none truncate">---</p>
                            </div>
                            <button onclick="window.copyToClip(document.getElementById('unich-ref-code').innerText)" class="p-2 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition text-slate-400 hover:text-cyan-500"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        </div>
                        <div class="p-2 bg-slate-50 dark:bg-slate-900/50 border dark:border-white/10 rounded-xl flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white dark:bg-slate-800 flex items-center justify-center shadow-sm text-slate-400">
                                <i data-lucide="link" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1 min-w-0 text-left">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Link tham gia</p>
                                <p id="unich-ref-link-short" class="font-mono text-xs font-bold text-slate-600 dark:text-slate-300 truncate">unich.com/...</p>
                                <input type="hidden" id="unich-ref-link-full">
                            </div>
                            <button onclick="window.copyToClip(document.getElementById('unich-ref-link-full').value)" class="p-2 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition text-slate-400 hover:text-cyan-500"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 pt-2">
                        <a id="btn-unich-ios" href="#" target="_blank" class="hidden px-4 py-2 bg-slate-900 text-white rounded-xl text-xs font-bold items-center gap-2 hover:scale-105 transition shadow-lg">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/3/31/Apple_logo_white.svg" class="w-4 h-4"> App Store
                        </a>
                        <a id="btn-unich-android" href="#" target="_blank" class="hidden px-4 py-2 bg-green-600 text-white rounded-xl text-xs font-bold items-center gap-2 hover:scale-105 transition shadow-lg">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/Google_Play_Arrow_logo.svg" class="w-4 h-4"> Google Play
                        </a>
                        <button onclick="window.openUnichQR()" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-white/10 text-slate-700 dark:text-white rounded-xl text-xs font-bold flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition shadow-sm">
                            <i data-lucide="qr-code" class="w-4 h-4 text-cyan-500"></i> Quét QR
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- === END UNICH SECTION === -->

        <!-- Social Links Grid -->
        <div id="social-grid" class="flex flex-wrap justify-center gap-4 reveal-on-scroll"></div>

        <!-- Details Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 reveal-on-scroll">
            <div class="glass p-6 rounded-3xl space-y-4">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i> Thông tin cá nhân
                </h3>
                <ul class="space-y-3">
                    <li class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-xl">
                        <span class="text-sm font-medium text-slate-500">Ngày sinh</span>
                        <span id="info-dob" class="text-sm font-bold">--/--/----</span>
                    </li>
                    <li class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-xl">
                        <span class="text-sm font-medium text-slate-500">Giới tính</span>
                        <span id="info-gender" class="text-sm font-bold">---</span>
                    </li>
                    <li class="flex items-center justify-between p-3 bg-white/50 dark:bg-slate-800/50 rounded-xl">
                        <span class="text-sm font-medium text-slate-500">Quê quán</span>
                        <span id="info-hometown" class="text-sm font-bold text-right max-w-[200px] truncate">---</span>
                    </li>
                </ul>
            </div>

            <div class="glass p-6 rounded-3xl space-y-4">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 flex items-center gap-2">
                    <i data-lucide="credit-card" class="w-4 h-4"></i> Ngân hàng
                </h3>
                <div id="bank-list" class="space-y-3 max-h-[200px] overflow-y-auto pr-1"></div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="glass p-6 sm:p-8 rounded-3xl reveal-on-scroll">
            <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                <i data-lucide="briefcase" class="w-4 h-4"></i> Học vấn & Công việc
            </h3>
            <div id="career-timeline" class="space-y-6 border-l-2 border-slate-200 dark:border-slate-700 ml-3 pl-6 relative"></div>
        </div>

        <!-- Achievements -->
        <div class="glass p-6 sm:p-8 rounded-3xl reveal-on-scroll">
            <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                <i data-lucide="award" class="w-4 h-4"></i> Thành tựu nổi bật
            </h3>
            <div id="achievement-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>

        <!-- Partners Section -->
        <div id="partners-section" class="glass p-6 sm:p-8 rounded-3xl hidden reveal-on-scroll">
            <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                <i data-lucide="handshake" class="w-4 h-4"></i> Đối tác
            </h3>
            <div id="partners-grid" class="flex flex-wrap items-center justify-center gap-8 opacity-70 grayscale hover:grayscale-0 transition-all duration-500"></div>
        </div>

        <!-- Send Message Button -->
        <div class="flex justify-center mt-8 reveal-on-scroll">
            <button onclick="window.showContactForm()" class="w-full max-w-md px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl hover:-translate-y-1 transition flex items-center justify-center gap-3">
                <i data-lucide="send" class="w-6 h-6"></i> Gửi tin nhắn cho tôi
            </button>
        </div>

        <!-- IP & Geo Info -->
        <div class="glass mt-8 p-4 rounded-2xl text-center space-y-2 reveal-on-scroll">
            <div class="flex items-center justify-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-widest">
                <i data-lucide="globe" class="w-3 h-3"></i> Thông tin kết nối
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><span class="block text-slate-400 text-xs">IP</span><span id="user-ip" class="font-mono font-bold text-slate-700 dark:text-white">...</span></div>
                <div><span class="block text-slate-400 text-xs">GPS</span><span id="user-coords" class="font-mono font-bold text-slate-700 dark:text-white">...</span></div>
            </div>
        </div>

    </main>
    
    <footer class="text-center py-8 text-slate-400 text-xs font-medium">
        <p>&copy; 2026 Profile System.</p>
    </footer>

    <!-- MODALS -->
    
    <!-- Contact View Modal -->
    <div id="modal-contact" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 id="contact-title" class="font-bold text-lg">Liên hệ</h3>
                <button onclick="window.closeModal('modal-contact')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="contact-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Contact Send Form Modal -->
    <div id="modal-send-msg" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
            <button onclick="window.closeModal('modal-send-msg')" class="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="font-bold text-lg mb-4">Gửi tin nhắn</h3>
            <form id="contact-form" class="space-y-4">
                <div><label class="lbl">Họ tên</label><input type="text" id="msg-name" class="inp"></div>
                <div id="msg-email-group"><label class="lbl">Email</label><input type="email" id="msg-email" class="inp"></div>
                <div><label class="lbl">Nội dung</label><textarea id="msg-content" rows="4" class="inp"></textarea></div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="msg-anon" onchange="toggleAnon()" class="w-4 h-4 rounded border-gray-300">
                    <label for="msg-anon" class="text-sm font-medium">Gửi ẩn danh</label>
                </div>
                <button type="button" onclick="window.sendContact()" class="w-full py-2 bg-primary text-white font-bold rounded-xl shadow">Gửi đi</button>
            </form>
        </div>
    </div>

    <!-- Unich QR Modal -->
    <div id="modal-unich-qr" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[1000] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl max-w-sm w-full text-center space-y-4 relative shadow-2xl border dark:border-white/10">
            <button onclick="document.getElementById('modal-unich-qr').classList.add('hidden')" class="absolute top-4 right-4 p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:rotate-90 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="font-bold text-xl dark:text-white">Quét mã tham gia</h3>
            <p class="text-xs text-slate-500">Sử dụng Camera hoặc Zalo để quét mã bên dưới</p>
            <div class="p-4 bg-white rounded-2xl shadow-inner inline-block border-2 border-dashed border-slate-200">
                <img id="unich-qr-display" src="" class="w-48 h-48 object-contain">
            </div>
            <div class="flex justify-center">
                <span class="px-3 py-1 bg-cyan-100 text-cyan-700 text-[10px] font-bold uppercase rounded-full tracking-widest">Unich Network</span>
            </div>
        </div>
    </div>

    <!-- Crop Image Modal -->
    <div id="modal-crop" class="fixed inset-0 bg-black z-[500] hidden flex flex-col">
        <div class="flex-1 bg-black relative flex items-center justify-center overflow-hidden">
             <img id="image-to-crop" src="" class="max-w-full max-h-full block">
        </div>
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
            <button onclick="window.closeModal('modal-crop')" class="px-4 py-2 font-bold text-slate-400">Hủy</button>
            <button onclick="window.confirmCrop()" class="px-6 py-2 bg-primary rounded-lg font-bold">Xác nhận</button>
        </div>
    </div>

    <!-- Manager Modal -->
    <div id="modal-manager" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b dark:border-white/10 pb-4">
                <h3 class="font-bold text-lg">Quản lý người dùng</h3>
                <button onclick="window.closeModal('modal-manager')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-4" id="manager-list"></div>
        </div>
    </div>

    <!-- Admin Edit Modal -->
    <div id="modal-admin" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[300] hidden flex items-center justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full h-full sm:h-[90vh] sm:rounded-2xl sm:max-w-4xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b dark:border-white/10 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                <h3 class="font-black uppercase text-primary tracking-widest">Chỉnh sửa Profile</h3>
                <button onclick="window.closeModal('modal-admin')" class="p-2 bg-slate-200 dark:bg-slate-800 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <!-- Body -->
            <div class="flex-1 flex flex-col sm:flex-row overflow-hidden">
                <div class="w-full sm:w-48 bg-slate-50 dark:bg-slate-950 border-r dark:border-white/5 p-2 flex sm:flex-col gap-2 overflow-x-auto sm:overflow-visible shrink-0">
                    <button onclick="window.switchTab('general')" class="tab-btn active p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Chung</button>
                    <button onclick="window.switchTab('unich')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-cyan-600">Dự án Unich</button>
                    <button onclick="window.switchTab('contact')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Liên hệ</button>
                    <button onclick="window.switchTab('career')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Học vấn</button>
                    <button onclick="window.switchTab('bank')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Ngân hàng</button>
                    <button onclick="window.switchTab('partners')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Đối tác</button>
                    <button onclick="window.switchTab('config')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-red-500">Cấu hình</button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-slate-900 relative">
                    <form id="admin-form" class="space-y-6 max-w-2xl mx-auto pb-20">
                        <!-- TAB: GENERAL -->
                        <div id="tab-general" class="tab-content space-y-4">
                            <div class="flex gap-4 items-center">
                                <img id="preview-avatar" src="" class="w-20 h-20 rounded-full object-cover border">
                                <label class="flex-1 cursor-pointer">
                                    <div class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-bold text-center border-dashed border-2 border-slate-300 hover:border-primary">Tải ảnh mới</div>
                                    <input type="file" id="inp-avatar" class="hidden" accept="image/*">
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="lbl">Họ tên</label><input type="text" id="inp-name" class="inp"></div>
                                <div><label class="lbl">Biệt danh</label><input type="text" id="inp-nickname" class="inp"></div>
                            </div>
                            <div><label class="lbl">Tiểu sử</label><textarea id="inp-bio" rows="3" class="inp"></textarea></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="lbl">Ngày sinh</label><input type="date" id="inp-dob" class="inp"></div>
                                <div><label class="lbl">Giới tính</label><select id="inp-gender" class="inp"><option>Nam</option><option>Nữ</option></select></div>
                            </div>
                            <div>
                                <label class="lbl">Quê quán (Tỉnh)</label>
                                <select id="api-city" onchange="updateHometownStr()" class="inp"></select>
                                <input type="hidden" id="inp-hometown-full">
                            </div>
                        </div>

                        <!-- TAB: UNICH PROJECT -->
                        <div id="tab-unich" class="tab-content hidden space-y-4">
                            <div class="p-5 bg-cyan-50 dark:bg-cyan-900/10 rounded-xl border border-cyan-100 dark:border-cyan-900/20 space-y-4">
                                <div class="flex items-center justify-between border-b border-cyan-200 dark:border-cyan-800 pb-2">
                                    <h4 class="font-black text-cyan-700 dark:text-cyan-400 uppercase tracking-wide">Cấu hình Unich</h4>
                                    <label class="flex items-center gap-2 cursor-pointer select-none">
                                        <span class="text-xs font-bold uppercase text-slate-500">Hiển thị</span>
                                        <input type="checkbox" id="inp-unich-active" class="w-5 h-5 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500">
                                    </label>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label class="lbl">Ref Code</label><input type="text" id="inp-unich-code" class="inp font-mono text-cyan-600 font-bold" placeholder="VD: 123456"></div>
                                    <div><label class="lbl">Ref Link</label><input type="text" id="inp-unich-link" class="inp text-xs" placeholder="https://unich..."></div>
                                </div>
                                <div><label class="lbl">Mô tả ngắn</label><textarea id="inp-unich-desc" rows="2" class="inp" placeholder="Nhập mô tả hấp dẫn..."></textarea></div>
                                <div class="space-y-2">
                                    <label class="lbl">Hình ảnh (URL)</label>
                                    <input type="text" id="inp-unich-logo" class="inp" placeholder="Link Logo">
                                    <input type="text" id="inp-unich-qr" class="inp" placeholder="Link ảnh QR Code">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="lbl">Link iOS</label><input type="text" id="inp-unich-ios" class="inp"></div>
                                    <div><label class="lbl">Link Android</label><input type="text" id="inp-unich-android" class="inp"></div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB: CONTACT -->
                        <div id="tab-contact" class="tab-content hidden space-y-4">
                            <div class="space-y-2 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl">
                                <label class="lbl">Điện thoại</label>
                                <div id="phone-list-editor" class="grid grid-cols-1 gap-2"></div>
                                <button type="button" onclick="addPhoneInput()" class="w-full py-2 border-2 border-dashed rounded-lg text-xs font-bold">+ Thêm số</button>
                            </div>
                            <div><label class="lbl">Email (phẩy cách)</label><input type="text" id="inp-emails" class="inp"></div>
                            <div><label class="lbl">Facebook</label><input type="text" id="inp-fb" class="inp"></div>
                            <div><label class="lbl">Zalo</label><input type="text" id="inp-zalo" class="inp"></div>
                            <div><label class="lbl">Instagram</label><input type="text" id="inp-ig" class="inp"></div>
                        </div>

                        <!-- TAB: CAREER -->
                        <div id="tab-career" class="tab-content hidden space-y-4">
                            <label class="lbl">Dữ liệu JSON</label>
                            <textarea id="inp-career-json" rows="10" class="inp font-mono text-xs"></textarea>
                        </div>

                         <!-- TAB: BANK -->
                         <div id="tab-bank" class="tab-content hidden space-y-4">
                            <div class="flex gap-2">
                                <select id="api-bank-list" class="inp w-1/2"></select>
                                <input type="text" id="bank-acc-num" placeholder="Số TK" class="inp w-1/2">
                            </div>
                            <input type="text" id="bank-acc-name" placeholder="Tên chủ thẻ" class="inp">
                            <button type="button" onclick="addBank()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm Ngân hàng</button>
                            <div id="admin-bank-list" class="space-y-2 mt-4"></div>
                        </div>

                        <!-- TAB: PARTNERS -->
                        <div id="tab-partners" class="tab-content hidden space-y-4">
                            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl space-y-3">
                                <label class="lbl">Thêm Đối tác</label>
                                <input type="text" id="partner-logo-url" placeholder="Link ảnh Logo" class="inp">
                                <input type="text" id="partner-link" placeholder="Link web" class="inp">
                                <button type="button" onclick="addPartner()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm</button>
                            </div>
                            <div id="admin-partner-list" class="grid grid-cols-2 gap-3"></div>
                        </div>

                        <!-- TAB: CONFIG -->
                        <div id="tab-config" class="tab-content hidden space-y-4">
                            <div class="p-4 bg-red-50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/20 space-y-3">
                                <h4 class="font-bold text-red-500 text-sm">GitHub (Lưu ảnh)</h4>
                                <input type="password" id="gh-token" placeholder="Token" class="inp">
                                <input type="text" id="gh-owner" placeholder="Username" class="inp">
                                <input type="text" id="gh-repo" placeholder="Repo" class="inp">
                            </div>
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900/20 space-y-3">
                                <h4 class="font-bold text-blue-500 text-sm">USB Key</h4>
                                <div class="flex gap-2"><input type="text" id="usb-secret-val" class="inp"><button type="button" onclick="saveUSBConfig()" class="px-4 bg-blue-500 text-white rounded-lg font-bold">Lưu</button></div>
                            </div>
                             <div class="flex justify-between items-center"><h4 class="font-bold">Tin nhắn</h4><button type="button" onclick="loadAdminMessages()" class="text-xs bg-slate-200 px-3 py-1 rounded">Làm mới</button></div>
                            <div id="admin-messages-list" class="space-y-3 max-h-[300px] overflow-y-auto"></div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="p-4 border-t dark:border-white/10 bg-white dark:bg-slate-900 flex justify-end gap-3">
                <button onclick="window.closeModal('modal-admin')" class="px-6 py-2 rounded-xl text-slate-500 font-bold hover:bg-slate-100 transition">Hủy</button>
                <button onclick="window.saveProfile()" class="px-6 py-2 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-indigo-600 transition">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 z-[1000] translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 font-bold text-sm">
            <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg">Thông báo</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, arrayUnion, arrayRemove, collection, getDocs, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", authDomain: "profile-d1214.firebaseapp.com", projectId: "profile-d1214", storageBucket: "profile-d1214.firebasestorage.app", messagingSenderId: "914980131889", appId: "1:914980131889:web:72f8da15c42dbee671b110" };
        const ADMIN_EMAILS = ["sonlyhongduc@gmail.com"]; 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null, isAdmin = false, isUSBAdmin = false, profileData = {}, ghConfig = {}, listBanks = [], listPartners = [], cropper = null, croppedAvatarBase64 = null;
        const carrierLogos = { 'viettel': 'https://upload.wikimedia.org/wikipedia/commons/4/4e/Viettel_logo_2021.png', 'vinaphone': '/img/vina.png', 'mobifone': '/img/mobi.PNG', 'vietnamobile': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Vietnamobile_Logo.png/800px-Vietnamobile_Logo.png' };

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if(user) {
                await setDoc(doc(db, "users", user.uid), { uid: user.uid, displayName: user.displayName, email: user.email, photoURL: user.photoURL }, { merge: true });
                const adminSnap = await getDoc(doc(db, "settings", "admins"));
                isAdmin = ADMIN_EMAILS.includes(user.email) || (adminSnap.exists() && adminSnap.data().emails?.includes(user.email));
                checkAdminUI();
            } else { isAdmin = false; checkAdminUI(); }
            renderAuthUI(); checkFollowStatus();
        });

        // USB
        document.getElementById('usb-key-input').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const content = JSON.parse(event.target.result);
                    const snap = await getDoc(doc(db, "settings", "usb_config"));
                    if (snap.exists() && snap.data().secret === content.key) { isUSBAdmin = true; showToast("USB Key OK!"); checkAdminUI(); }
                    else showToast("USB Fail!", true);
                } catch (err) { showToast("USB Error!", true); }
            };
            reader.readAsText(file); e.target.value = ''; 
        });

        function checkAdminUI() {
            if (isAdmin || isUSBAdmin) {
                document.getElementById('admin-btn').classList.remove('hidden');
                document.getElementById('manager-btn').classList.remove('hidden');
                if(isAdmin) loadGithubConfig();
            } else { document.getElementById('admin-btn').classList.add('hidden'); document.getElementById('manager-btn').classList.add('hidden'); }
        }

        // DATA
        loadNetworkInfo();
        onSnapshot(doc(db, "profile_data", "main"), (docSnap) => {
            document.getElementById('global-loading').classList.add('opacity-0', 'pointer-events-none');
            if (docSnap.exists()) { profileData = docSnap.data(); renderProfile(); initScrollReveal(); }
        });

        function renderProfile() {
            if(profileData.meta) { document.title = profileData.meta.title || profileData.name; document.getElementById('meta-desc').content = profileData.meta.description || ''; }
            
            // Basic Info
            document.getElementById('profile-name').innerText = profileData.name || "No Name";
            document.getElementById('nav-nickname').innerText = profileData.nickname || "User";
            if(profileData.avatar) { document.getElementById('profile-avatar').src = profileData.avatar; document.getElementById('nav-avatar').src = profileData.avatar; }
            if(profileData.nickname) { document.getElementById('profile-nickname-badge').innerText = profileData.nickname; document.getElementById('profile-nickname-badge').classList.remove('hidden'); }
            document.getElementById('profile-bio').innerText = profileData.bio || "No bio.";
            document.getElementById('stat-followers').innerText = (profileData.followers || []).length;
            document.getElementById('stat-views').innerText = profileData.views || 0;
            document.getElementById('info-dob').innerText = formatDate(profileData.dob);
            document.getElementById('info-gender').innerText = profileData.gender || "---";
            document.getElementById('info-hometown').innerText = profileData.hometown?.full || "---";

            // Unich Section
            const u = profileData.unich || {};
            const uCard = document.getElementById('unich-card');
            if (u.active) {
                uCard.classList.remove('hidden');
                document.getElementById('unich-desc-txt').innerText = u.desc || "Dự án tiềm năng.";
                document.getElementById('unich-ref-code').innerText = u.code || "---";
                const link = u.link || "";
                document.getElementById('unich-ref-link-full').value = link;
                document.getElementById('unich-ref-link-short').innerText = link ? link.replace(/^https?:\/\//, '').substring(0, 20) + "..." : "---";
                if(u.logo) document.getElementById('unich-logo-img').src = u.logo;
                
                const btnI = document.getElementById('btn-unich-ios'), btnA = document.getElementById('btn-unich-android');
                if(u.ios) { btnI.href = u.ios; btnI.classList.remove('hidden'); btnI.classList.add('flex'); } else btnI.classList.add('hidden');
                if(u.android) { btnA.href = u.android; btnA.classList.remove('hidden'); btnA.classList.add('flex'); } else btnA.classList.add('hidden');
            } else uCard.classList.add('hidden');

            // Socials
            let socialHtml = '';
            const map = { facebook: {i:'facebook', c:'text-blue-600'}, zalo: {i:'phone', c:'text-blue-500'}, instagram: {i:'instagram', c:'text-pink-600'} };
            if(profileData.socials) Object.keys(profileData.socials).forEach(k => {
                if(profileData.socials[k]) {
                    let l = profileData.socials[k]; if(k==='zalo') l=`https://zalo.me/${l}`;
                    socialHtml += `<a href="${l}" target="_blank" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow hover:-translate-y-1 transition ${map[k]?.c || 'text-slate-500'}"><i data-lucide="${map[k]?.i || 'link'}" class="w-5 h-5"></i></a>`;
                }
            });
            document.getElementById('social-grid').innerHTML = socialHtml;

            // Banks
            document.getElementById('bank-list').innerHTML = (profileData.banks || []).map(b => `
                <div class="p-3 rounded-xl flex items-center justify-between shadow-lg relative overflow-hidden bg-white dark:bg-slate-900 border dark:border-white/5">
                    <div class="flex items-center gap-4 z-10">
                        <img src="${b.logo}" class="w-10 h-10 object-contain bg-white rounded p-1">
                        <div><p class="font-mono font-bold text-lg select-all">${b.number}</p><p class="text-[10px] font-bold uppercase text-slate-500">${b.owner}</p></div>
                    </div>
                    <button onclick="window.copyToClip('${b.number}')" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg z-10"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>`).join('');

            // Career
            document.getElementById('career-timeline').innerHTML = [...(profileData.education||[]), ...(profileData.work||[])].map(i => `
                <div class="relative mb-6 last:mb-0"><span class="absolute -left-[33px] w-4 h-4 rounded-full bg-primary border-4 border-white dark:border-slate-800"></span>
                <h4 class="font-bold">${i.title}</h4><p class="text-xs font-bold text-primary mb-1">${i.org}</p><p class="text-xs text-slate-500">${i.time}</p></div>`).join('');

            // Partners
            if(profileData.partners?.length > 0) {
                document.getElementById('partners-section').classList.remove('hidden');
                document.getElementById('partners-grid').innerHTML = profileData.partners.map(p => `<a href="${p.link}" target="_blank"><img src="${p.logo}" class="h-8 md:h-10 w-auto object-contain"></a>`).join('');
            } else document.getElementById('partners-section').classList.add('hidden');

            checkFollowStatus(); lucide.createIcons();
        }

        // EDIT LOGIC
        window.openEditModal = async () => {
            document.getElementById('modal-admin').classList.remove('hidden');
            document.getElementById('inp-name').value = profileData.name || '';
            document.getElementById('inp-nickname').value = profileData.nickname || '';
            document.getElementById('inp-bio').value = profileData.bio || '';
            document.getElementById('inp-dob').value = profileData.dob || '';
            
            // Unich Edit
            const u = profileData.unich || {};
            document.getElementById('inp-unich-active').checked = u.active || false;
            document.getElementById('inp-unich-desc').value = u.desc || '';
            document.getElementById('inp-unich-code').value = u.code || '';
            document.getElementById('inp-unich-link').value = u.link || '';
            document.getElementById('inp-unich-logo').value = u.logo || '';
            document.getElementById('inp-unich-qr').value = u.qr || '';
            document.getElementById('inp-unich-ios').value = u.ios || '';
            document.getElementById('inp-unich-android').value = u.android || '';

            await fetchProvinces();
            document.getElementById('inp-hometown-full').value = profileData.hometown?.full || '';
            
            document.getElementById('phone-list-editor').innerHTML = '';
            (profileData.phones || []).forEach(p => addPhoneInput(p.number, p.carrier));
            document.getElementById('inp-emails').value = profileData.email || '';
            if(profileData.socials) {
                document.getElementById('inp-fb').value = profileData.socials.facebook || '';
                document.getElementById('inp-zalo').value = profileData.socials.zalo || '';
                document.getElementById('inp-ig').value = profileData.socials.instagram || '';
            }
            document.getElementById('inp-career-json').value = JSON.stringify({ education: profileData.education || [], work: profileData.work || [], achievements: profileData.achievements || [] }, null, 2);
            listBanks = profileData.banks || []; renderAdminBanks(); loadBankList();
            listPartners = profileData.partners || []; renderAdminPartners();
            loadAdminMessages();
        }

        window.saveProfile = async () => {
            const btn = document.querySelector('#modal-admin button.bg-primary'); btn.innerText = "Lưu...";
            try {
                let avatarUrl = profileData.avatar;
                if(croppedAvatarBase64 && ghConfig.token) {
                    const res = await fetch(`https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/avatars/${Date.now()}.png`, {
                        method: 'PUT', headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: "Up", content: croppedAvatarBase64.split(',')[1] })
                    });
                    if(res.ok) avatarUrl = (await res.json()).content.download_url;
                }
                
                const phones = Array.from(document.querySelectorAll('.phone-row')).map(r => ({ carrier: r.querySelector('select').value, number: r.querySelector('input').value })).filter(x => x.number);
                const newData = {
                    name: document.getElementById('inp-name').value, nickname: document.getElementById('inp-nickname').value,
                    bio: document.getElementById('inp-bio').value, dob: document.getElementById('inp-dob').value,
                    gender: document.getElementById('inp-gender').value, hometown: { full: document.getElementById('inp-hometown-full').value },
                    avatar: avatarUrl,
                    email: document.getElementById('inp-emails').value, phones: phones,
                    socials: { facebook: document.getElementById('inp-fb').value, zalo: document.getElementById('inp-zalo').value, instagram: document.getElementById('inp-ig').value },
                    banks: listBanks, partners: listPartners,
                    unich: {
                        active: document.getElementById('inp-unich-active').checked,
                        desc: document.getElementById('inp-unich-desc').value, code: document.getElementById('inp-unich-code').value,
                        link: document.getElementById('inp-unich-link').value, logo: document.getElementById('inp-unich-logo').value,
                        qr: document.getElementById('inp-unich-qr').value, ios: document.getElementById('inp-unich-ios').value, android: document.getElementById('inp-unich-android').value
                    },
                    ...JSON.parse(document.getElementById('inp-career-json').value)
                };
                await setDoc(doc(db, "profile_data", "main"), newData, { merge: true });
                showToast("Đã lưu!"); window.closeModal('modal-admin');
            } catch(e) { showToast("Lỗi: " + e.message, true); } finally { btn.innerText = "Lưu Thay Đổi"; }
        }

        // HELPERS
        window.openUnichQR = () => { if(profileData.unich?.qr) { document.getElementById('unich-qr-display').src = profileData.unich.qr; document.getElementById('modal-unich-qr').classList.remove('hidden'); } else showToast("Chưa có QR", true); }
        window.addPhoneInput = (val='', c='Viettel') => {
            const div = document.createElement('div'); div.className = 'phone-row flex gap-2';
            div.innerHTML = `<select class="inp w-24"><option value="Viettel">Viettel</option><option value="Vinaphone">Vinaphone</option></select><input value="${val}" class="inp flex-1"><button onclick="this.parentElement.remove()" class="text-red-500">x</button>`;
            div.querySelector('select').value = c; document.getElementById('phone-list-editor').appendChild(div);
        }
        window.addBank = () => { const m = JSON.parse(document.getElementById('api-bank-list').value); listBanks.push({...m, number: document.getElementById('bank-acc-num').value, owner: document.getElementById('bank-acc-name').value}); renderAdminBanks(); }
        function renderAdminBanks() { document.getElementById('admin-bank-list').innerHTML = listBanks.map((b,i)=>`<div class="flex justify-between bg-slate-100 p-2 text-xs"><span>${b.shortName}-${b.number}</span><button onclick="removeBank(${i})" class="text-red-500">X</button></div>`).join(''); }
        window.removeBank = (i) => { listBanks.splice(i,1); renderAdminBanks(); }
        window.addPartner = () => { listPartners.push({logo: document.getElementById('partner-logo-url').value, link: document.getElementById('partner-link').value}); renderAdminPartners(); }
        function renderAdminPartners() { document.getElementById('admin-partner-list').innerHTML = listPartners.map((p,i)=>`<div class="border p-2 text-center relative"><img src="${p.logo}" class="h-10 mx-auto"><button onclick="listPartners.splice(${i},1);renderAdminPartners()" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs">x</button></div>`).join(''); }

        // CROPPER
        document.getElementById('inp-avatar').addEventListener('change', (e) => {
            const f = e.target.files[0]; if(f) {
                const r = new FileReader(); r.onload = (evt) => { document.getElementById('image-to-crop').src = evt.target.result; document.getElementById('modal-crop').classList.remove('hidden'); if(cropper) cropper.destroy(); cropper = new Cropper(document.getElementById('image-to-crop'), { aspectRatio: 1 }); };
                r.readAsDataURL(f);
            }
        });
        window.confirmCrop = () => { croppedAvatarBase64 = cropper.getCroppedCanvas({width:400,height:400}).toDataURL(); document.getElementById('preview-avatar').src = croppedAvatarBase64; window.closeModal('modal-crop'); }

        // UTILS
        window.switchTab = (n) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+n).classList.remove('hidden'); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('bg-white','dark:bg-white/5')); event.target.classList.add('bg-white','dark:bg-white/5'); }
        window.copyToClip = (t) => { navigator.clipboard.writeText(t); showToast('Đã copy!'); }
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleTheme = () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; }
        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');
        function showToast(m, e=false) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; document.getElementById('toast-icon').className = e ? 'w-5 h-5 text-red-500' : 'w-5 h-5 text-green-500'; t.classList.remove('translate-y-20','opacity-0'); setTimeout(()=>t.classList.add('translate-y-20','opacity-0'), 3000); }
        function formatDate(d) { if(!d) return ""; const [y,m,day] = d.split('-'); return `${day}/${m}/${y}`; }

        // BASIC FETCH
        async function fetchProvinces() { const r = await fetch('https://esgoo.net/api-tinhthanh/1/0.htm'); const d = await r.json(); if(d.error==0) document.getElementById('api-city').innerHTML = '<option>--Chọn--</option>'+d.data.map(p=>`<option value="${p.id}" data-name="${p.full_name}">${p.full_name}</option>`).join(''); }
        window.updateHometownStr = () => { const s=document.getElementById('api-city'); document.getElementById('inp-hometown-full').value = s.options[s.selectedIndex].dataset.name; }
        async function loadBankList() { const r=await fetch('https://api.vietqr.io/v2/banks'); const d=await r.json(); document.getElementById('api-bank-list').innerHTML = d.data.map(b=>`<option value='${JSON.stringify({shortName:b.shortName,logo:b.logo})}'>${b.shortName}</option>`).join(''); }
        async function loadGithubConfig() { const s=await getDoc(doc(db,"settings","github_config")); if(s.exists()) { ghConfig=s.data(); document.getElementById('gh-token').value=ghConfig.token||''; document.getElementById('gh-owner').value=ghConfig.owner||''; document.getElementById('gh-repo').value=ghConfig.repo||''; } }
        window.saveUSBConfig = async () => { await setDoc(doc(db,"settings","usb_config"), {secret:document.getElementById('usb-secret-val').value}); showToast("Đã lưu USB"); }
        window.loadAdminMessages = async () => { const q=query(collection(db,"messages"), orderBy("timestamp","desc"), limit(20)); const s=await getDocs(q); document.getElementById('admin-messages-list').innerHTML = s.docs.map(d=>`<div class="p-2 bg-slate-100 text-xs"><b>${d.data().name}</b>: ${d.data().content}</div>`).join(''); }

        // AUTH UI
        window.doLogin = () => signInWithPopup(auth, provider); window.doLogout = () => signOut(auth).then(()=>location.reload());
        function renderAuthUI() { document.getElementById('auth-section').innerHTML = currentUser ? `<img src="${currentUser.photoURL}" class="w-8 h-8 rounded-full border cursor-pointer" onclick="window.doLogout()">` : `<button onclick="window.doLogin()" class="px-4 py-1.5 bg-primary text-white text-xs rounded-full font-bold">Login</button>`; }
        window.showContactForm = () => { document.getElementById('modal-send-msg').classList.remove('hidden'); if(currentUser){document.getElementById('msg-name').value=currentUser.displayName;document.getElementById('msg-email-group').classList.add('hidden');}else document.getElementById('msg-email-group').classList.remove('hidden'); }
        window.sendContact = async () => { 
            const anon = document.getElementById('msg-anon').checked;
            await addDoc(collection(db,"messages"), {
                content:document.getElementById('msg-content').value, 
                name: anon ? "Ẩn danh" : document.getElementById('msg-name').value,
                email: anon ? "" : document.getElementById('msg-email').value,
                timestamp: new Date().toISOString()
            }); showToast("Đã gửi"); window.closeModal('modal-send-msg'); 
        }
        window.showContactModal = (t) => {
            const m=document.getElementById('modal-contact'), l=document.getElementById('contact-list'); m.classList.remove('hidden');
            if(t==='phone') {
                document.getElementById('contact-title').innerText="Gọi điện";
                l.innerHTML = (profileData.phones||[]).map(p=>`<a href="tel:${p.number}" class="flex justify-between p-3 bg-slate-50 rounded-xl font-bold"><span>${p.carrier}</span><span>${p.number}</span></a>`).join('');
            } else {
                document.getElementById('contact-title').innerText="Email";
                l.innerHTML = (profileData.email||"").split(',').map(e=>`<a href="mailto:${e.trim()}" class="block p-3 bg-slate-50 rounded-xl font-bold">${e.trim()}</a>`).join('');
            }
        }
        function checkFollowStatus() { 
            const btn = document.getElementById('follow-btn');
            if(!currentUser) return;
            if((profileData.followers||[]).includes(currentUser.uid)) { btn.innerHTML=`<i data-lucide="check" class="w-4 h-4"></i> Đang theo dõi`; btn.classList.add('bg-green-600'); }
            else { btn.innerHTML=`<i data-lucide="user-plus" class="w-4 h-4"></i> Theo dõi`; btn.classList.remove('bg-green-600'); }
            lucide.createIcons();
        }
        window.toggleFollow = async () => {
            if(!currentUser) return window.doLogin();
            const f = profileData.followers||[];
            if(f.includes(currentUser.uid)) await updateDoc(doc(db,"profile_data","main"), {followers:arrayRemove(currentUser.uid)});
            else await updateDoc(doc(db,"profile_data","main"), {followers:arrayUnion(currentUser.uid)});
        }
        window.openManagerModal = async () => {
            document.getElementById('modal-manager').classList.remove('hidden');
            const s=await getDocs(collection(db,"users"));
            document.getElementById('manager-list').innerHTML = s.docs.map(d=>`<div class="flex gap-2 items-center p-2 border-b"><img src="${d.data().photoURL}" class="w-8 h-8 rounded-full"><div class="text-xs"><b>${d.data().displayName}</b><br>${d.data().email}</div></div>`).join('');
        }
        function loadNetworkInfo() { 
            fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>document.getElementById('user-ip').innerText=d.ip);
            if("geolocation" in navigator) navigator.geolocation.getCurrentPosition(p=>document.getElementById('user-coords').innerText=`${p.coords.latitude.toFixed(2)}, ${p.coords.longitude.toFixed(2)}`);
        }
        function initScrollReveal() { const o=new IntersectionObserver(e=>e.forEach(i=>{if(i.isIntersecting)i.target.classList.add('active')})); document.querySelectorAll('.reveal-on-scroll').forEach(e=>o.observe(e)); }
        
        lucide.createIcons();
    </script>
</body>
</html>
