<!-- START OF FILE -->
<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- SEO CONFIG -->
    <title>Bmass & Unich</title>
    <meta name="description" id="meta-desc" content="Profile cá nhân & Dự án Unich. Kết nối cộng đồng.">
    <link rel="icon" id="meta-icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">
    
    <meta property="og:type" content="website">
    <meta property="og:title" content="Profile & Unich Connect">
    <meta property="og:image" content="https://hdd.io.vn/img/bmasslogos.png">
    <meta name="theme-color" content="#6366f1">
    
    <!-- PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="dynamic-manifest">
    
    <!-- Libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#6366f1', 
                        secondary: '#ec4899',
                        unich: '#00D2FF', /* Màu chủ đạo Unich */
                        unich_dark: '#3A7BD5',
                        dark: '#0f172a',
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        }
                    }
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        .custom-bg { background-size: cover; background-position: center; background-attachment: fixed; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Unich Gradient Text */
        .text-gradient-unich {
            background: linear-gradient(to right, #00D2FF, #3A7BD5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .bg-gradient-unich { background: linear-gradient(to right, #00D2FF, #3A7BD5); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }

        .reveal-on-scroll { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.5, 0, 0, 1); }
        .reveal-on-scroll.active { opacity: 1; transform: translateY(0); }
        
        /* Tab Navigation */
        .nav-tab.active { color: #6366f1; position: relative; }
        .nav-tab.active::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 2px; background: #6366f1; border-radius: 2px; }
        .dark .nav-tab.active { color: #818cf8; }
        .dark .nav-tab.active::after { background: #818cf8; }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden pb-10 custom-bg">

    <!-- Background Elements -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-primary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-secondary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-cyan-500/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Loading -->
    <div id="global-loading" class="fixed inset-0 bg-white dark:bg-slate-950 z-[900] flex flex-col items-center justify-center transition-opacity duration-300">
        <img src="/img/bmassloadings.png" class="w-20 h-20 mb-4 animate-bounce-slow drop-shadow-2xl">
        <span class="text-sm font-bold text-slate-500 tracking-widest uppercase">Đang tải dữ liệu...</span>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="usb-key-input" class="hidden" accept=".json,.txt">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass px-4 py-3 mb-6 border-b border-white/20">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <img id="nav-avatar" src="https://ui-avatars.com/api/?name=P" class="w-9 h-9 rounded-full object-cover border-2 border-primary/20 shadow-sm">
                    <!-- VIEW SWITCHER -->
                    <div class="flex gap-4 ml-2">
                        <button onclick="window.switchMainView('profile')" id="nav-btn-profile" class="nav-tab active font-bold text-sm uppercase tracking-wide transition-colors">Profile</button>
                        <button onclick="window.switchMainView('unich')" id="nav-btn-unich" class="nav-tab font-bold text-sm uppercase tracking-wide text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">Unich</button>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-1 sm:gap-2">
                <button onclick="window.toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
                </button>
                <button onclick="document.getElementById('usb-key-input').click()" class="p-2 rounded-full text-slate-400 hover:text-primary hover:bg-black/5 dark:hover:bg-white/10 transition">
                    <i data-lucide="usb" class="w-5 h-5"></i>
                </button>
                <button id="admin-btn" onclick="window.openEditModal()" class="hidden px-3 py-1.5 bg-slate-800 dark:bg-white text-white dark:text-slate-900 rounded-lg text-xs font-bold uppercase shadow hover:opacity-90 transition gap-2 items-center">
                    <i data-lucide="edit-3" class="w-3 h-3"></i> Admin
                </button>
                 <button id="manager-btn" onclick="window.openManagerModal()" class="hidden p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </button>
                <div id="auth-section"></div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT WRAPPER -->
    <main class="max-w-4xl mx-auto px-4 pb-20">

        <!-- ======================= -->
        <!-- VIEW 1: PERSONAL PROFILE -->
        <!-- ======================= -->
        <div id="view-profile" class="space-y-6 transition-all duration-300">
            
            <!-- Header Card -->
            <div class="glass rounded-3xl p-6 sm:p-8 flex flex-col md:flex-row items-center md:items-start gap-6 relative overflow-hidden reveal-on-scroll">
                <div class="relative group shrink-0">
                    <div class="absolute -inset-1 bg-gradient-to-r from-primary to-secondary rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                    <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&size=256" class="relative w-32 h-32 sm:w-40 sm:h-40 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-xl">
                    <div id="online-indicator" class="absolute bottom-2 right-2 w-5 h-5 bg-green-500 border-4 border-white dark:border-slate-800 rounded-full"></div>
                </div>

                <div class="flex-1 text-center md:text-left space-y-2 z-10 w-full">
                    <div class="flex flex-col md:flex-row items-center gap-2 md:gap-4 justify-center md:justify-start">
                        <h1 id="profile-name" class="text-3xl sm:text-4xl font-black tracking-tight text-slate-800 dark:text-white">Loading...</h1>
                        <span id="profile-nickname-badge" class="px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold uppercase tracking-wider hidden"></span>
                    </div>
                    
                    <p id="profile-bio" class="text-slate-500 dark:text-slate-400 font-medium max-w-lg mx-auto md:mx-0">...</p>

                    <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 py-3">
                        <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i data-lucide="users" class="w-4 h-4 text-primary"></i>
                            <span id="stat-followers">0</span> <span class="text-slate-400 font-normal">Người theo dõi</span>
                        </div>
                        <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                            <i data-lucide="eye" class="w-4 h-4 text-secondary"></i>
                            <span id="stat-views">0</span> <span class="text-slate-400 font-normal">Lượt xem</span>
                        </div>
                        <div id="relationship-display" class="hidden flex items-center gap-1.5 text-sm font-bold text-pink-500 bg-pink-500/10 px-3 py-1 rounded-full">
                            <i data-lucide="heart" class="w-3 h-3 fill-current"></i>
                            <span id="rel-status"></span>
                        </div>
                    </div>

                    <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-2">
                        <button id="follow-btn" onclick="window.toggleFollow()" class="px-6 py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:transform hover:scale-105 transition flex items-center gap-2">
                            <i data-lucide="user-plus" class="w-4 h-4"></i> Theo dõi
                        </button>
                        <button onclick="window.showContactModal('phone')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-primary hover:border-primary transition shadow-sm">
                            <i data-lucide="phone" class="w-5 h-5"></i>
                        </button>
                        <button onclick="window.showContactModal('email')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-secondary hover:border-secondary transition shadow-sm">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Social Links Grid -->
            <div id="social-grid" class="flex flex-wrap justify-center gap-4 reveal-on-scroll"></div>

            <!-- Banking -->
            <div class="glass p-6 rounded-3xl space-y-4 reveal-on-scroll">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 flex items-center gap-2">
                    <i data-lucide="credit-card" class="w-4 h-4"></i> Thông tin thanh toán
                </h3>
                <div id="bank-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <!-- Timeline -->
            <div class="glass p-6 sm:p-8 rounded-3xl reveal-on-scroll">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                    <i data-lucide="briefcase" class="w-4 h-4"></i> Hành trình sự nghiệp
                </h3>
                <div id="career-timeline" class="space-y-6 border-l-2 border-slate-200 dark:border-slate-700 ml-3 pl-6 relative"></div>
            </div>

            <!-- Achievements -->
            <div class="glass p-6 sm:p-8 rounded-3xl reveal-on-scroll">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                    <i data-lucide="award" class="w-4 h-4"></i> Thành tựu nổi bật
                </h3>
                <div id="achievement-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>

            <!-- Partners -->
            <div id="partners-section" class="glass p-6 sm:p-8 rounded-3xl hidden reveal-on-scroll">
                <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                    <i data-lucide="handshake" class="w-4 h-4"></i> Đối tác
                </h3>
                <div id="partners-grid" class="flex flex-wrap items-center justify-center gap-8 opacity-70 grayscale hover:grayscale-0 transition-all duration-500"></div>
            </div>

            <!-- Send Message -->
            <div class="flex justify-center mt-8 reveal-on-scroll">
                <button onclick="window.showContactForm()" class="w-full max-w-md px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl hover:-translate-y-1 transition flex items-center justify-center gap-3">
                    <i data-lucide="send" class="w-6 h-6"></i> Gửi tin nhắn cho tôi
                </button>
            </div>
            
             <!-- Footer (In profile view) -->
            <footer class="text-center py-4 text-slate-400 text-xs font-medium">
                <p>&copy; 2024 Profile System.</p>
            </footer>
        </div>

        <!-- ======================= -->
        <!-- VIEW 2: UNICH PROJECT & CONNECT -->
        <!-- ======================= -->
        <div id="view-unich" class="hidden space-y-6 transition-all duration-300">
            
            <!-- Unich Hero -->
            <div class="relative glass rounded-3xl overflow-hidden p-6 sm:p-10 reveal-on-scroll">
                <!-- Decorative BG for Unich -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-400/20 rounded-full blur-3xl -mr-16 -mt-16 animate-blob"></div>
                
                <div class="relative z-10 flex flex-col md:flex-row items-center gap-8">
                    <div class="w-24 h-24 sm:w-32 sm:h-32 bg-white rounded-3xl shadow-xl flex items-center justify-center p-4 shrink-0 rotate-3 hover:rotate-0 transition duration-500">
                        <!-- Unich Logo Placeholder (Text if no img) -->
                        <div class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 to-blue-600">U</div>
                    </div>
                    <div class="text-center md:text-left space-y-3">
                        <h2 id="unich-title" class="text-3xl sm:text-4xl font-black text-slate-800 dark:text-white">Unich Project</h2>
                        <p id="unich-desc" class="text-slate-500 dark:text-slate-300 font-medium max-w-xl">Hệ sinh thái kết nối vạn vật. Mang mọi người đến gần nhau hơn thông qua công nghệ định vị thông minh và chia sẻ giá trị.</p>
                        
                        <!-- Download Badges -->
                        <div class="flex flex-wrap justify-center md:justify-start gap-3 pt-2">
                             <a id="link-apple" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-black text-white rounded-xl hover:opacity-80 transition hidden">
                                <i data-lucide="apple" class="w-5 h-5 fill-current"></i>
                                <div class="text-left leading-tight">
                                    <div class="text-[9px] uppercase font-bold text-gray-400">Download on the</div>
                                    <div class="text-xs font-bold">App Store</div>
                                </div>
                             </a>
                             <a id="link-android" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-black text-white rounded-xl hover:opacity-80 transition hidden">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/d/d7/Android_robot.svg" class="w-5 h-5 filter invert">
                                <div class="text-left leading-tight">
                                    <div class="text-[9px] uppercase font-bold text-gray-400">Get it on</div>
                                    <div class="text-xs font-bold">Google Play</div>
                                </div>
                             </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral & QR -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 reveal-on-scroll">
                <!-- Ref Code -->
                <div class="glass p-6 rounded-3xl flex flex-col justify-center items-center text-center space-y-3 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-blue-500/5"></div>
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Mã giới thiệu (Referral)</span>
                    <div onclick="window.copyUnichRef()" class="group cursor-pointer bg-white dark:bg-slate-800 border-2 border-dashed border-cyan-300 dark:border-cyan-700 px-6 py-3 rounded-2xl flex items-center gap-3 hover:bg-cyan-50 dark:hover:bg-slate-700 transition">
                        <span id="unich-ref-code" class="text-2xl font-black font-mono text-cyan-600 tracking-wider">---</span>
                        <i data-lucide="copy" class="w-5 h-5 text-slate-400 group-hover:text-cyan-500"></i>
                    </div>
                    <p class="text-[10px] text-slate-400">Chạm vào mã để sao chép</p>
                    
                    <a id="unich-ref-link" href="#" class="text-sm font-bold text-blue-500 hover:underline mt-2">Link đăng ký nhanh &rarr;</a>
                </div>

                <!-- QR Code -->
                <div class="glass p-6 rounded-3xl flex flex-col items-center justify-center space-y-3">
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Quét mã tải App</span>
                    <div class="p-3 bg-white rounded-2xl shadow-sm">
                        <img id="unich-qr" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=UnichProject" class="w-32 h-32 object-contain">
                    </div>
                </div>
            </div>

            <!-- UNICH CONNECT (RADAR) -->
            <div class="glass rounded-3xl overflow-hidden reveal-on-scroll border border-cyan-500/20">
                <div class="p-6 bg-gradient-to-r from-slate-900 to-slate-800 text-white flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-xl flex items-center gap-2">
                            <i data-lucide="radar" class="w-6 h-6 text-cyan-400 animate-pulse-fast"></i> Unich Connect
                        </h3>
                        <p class="text-xs text-slate-400 mt-1">Tìm kiếm & Kết nối với Admin và cộng đồng quanh bạn.</p>
                    </div>
                    <button onclick="window.updateMyPosition()" class="px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-white text-xs font-bold rounded-full shadow-lg transition flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> Cập nhật vị trí
                    </button>
                </div>
                
                <div class="p-4 bg-slate-50 dark:bg-slate-900/50 min-h-[300px]">
                    <div id="unich-connect-alert" class="hidden mb-4 p-3 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-xl text-sm font-bold flex items-center gap-2 animate-bounce-slow">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                        <span>Admin đang ở rất gần bạn! (Dưới 10km)</span>
                    </div>

                    <div id="unich-list" class="space-y-3">
                        <p class="text-center text-slate-400 text-sm py-10">Bấm "Cập nhật vị trí" để bắt đầu quét...</p>
                    </div>
                </div>
            </div>

            <footer class="text-center py-4 text-slate-400 text-xs font-medium">
                <p>&copy; 2024 Unich Project.</p>
            </footer>
        </div>

    </main>

    <!-- MODALS (Keep existing ones, Add Unich fields to Admin) -->
    
    <!-- Contact View Modal -->
    <div id="modal-contact" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 id="contact-title" class="font-bold text-lg">Liên hệ</h3>
                <button onclick="window.closeModal('modal-contact')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="contact-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Contact Send Form Modal -->
    <div id="modal-send-msg" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-fade-in relative">
            <button onclick="window.closeModal('modal-send-msg')" class="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="font-bold text-lg mb-4">Gửi tin nhắn</h3>
            <form id="contact-form" class="space-y-4">
                <div>
                    <label class="lbl">Họ tên</label>
                    <input type="text" id="msg-name" class="inp" placeholder="Nhập tên của bạn...">
                </div>
                <div id="msg-email-group">
                    <label class="lbl">Email</label>
                    <input type="email" id="msg-email" class="inp" placeholder="email@example.com">
                </div>
                <div>
                    <label class="lbl">Nội dung</label>
                    <textarea id="msg-content" rows="4" class="inp" placeholder="Bạn muốn nhắn gì..."></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="msg-anon" onchange="toggleAnon()" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="msg-anon" class="text-sm font-medium text-slate-600 dark:text-slate-300">Gửi ẩn danh</label>
                </div>
                <button type="button" onclick="window.sendContact()" class="w-full py-2 bg-primary text-white font-bold rounded-xl shadow hover:bg-indigo-600 transition">Gửi đi</button>
            </form>
        </div>
    </div>

    <!-- Crop Image Modal -->
    <div id="modal-crop" class="fixed inset-0 bg-black z-[500] hidden flex flex-col">
        <div class="flex-1 bg-black relative flex items-center justify-center overflow-hidden">
             <img id="image-to-crop" src="" class="max-w-full max-h-full block">
        </div>
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
            <button onclick="window.closeModal('modal-crop')" class="px-4 py-2 font-bold text-slate-400">Hủy</button>
            <div class="text-sm font-medium">Cắt ảnh đại diện (Vuông)</div>
            <button onclick="window.confirmCrop()" class="px-6 py-2 bg-primary rounded-lg font-bold">Xác nhận</button>
        </div>
    </div>

    <!-- Manager Modal -->
    <div id="modal-manager" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b dark:border-white/10 pb-4">
                <h3 class="font-bold text-lg">Quản lý người dùng</h3>
                <button onclick="window.closeModal('modal-manager')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-4" id="manager-list"></div>
        </div>
    </div>

    <!-- Admin Edit Modal -->
    <div id="modal-admin" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[300] hidden flex items-center justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full h-full sm:h-[90vh] sm:rounded-2xl sm:max-w-4xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b dark:border-white/10 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                <h3 class="font-black uppercase text-primary tracking-widest">Chỉnh sửa Profile</h3>
                <button onclick="window.closeModal('modal-admin')" class="p-2 bg-slate-200 dark:bg-slate-800 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <!-- Body -->
            <div class="flex-1 flex flex-col sm:flex-row overflow-hidden">
                <div class="w-full sm:w-48 bg-slate-50 dark:bg-slate-950 border-r dark:border-white/5 p-2 flex sm:flex-col gap-2 overflow-x-auto sm:overflow-visible shrink-0">
                    <button onclick="window.switchTab('general')" class="tab-btn active p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Chung</button>
                    <button onclick="window.switchTab('unich-admin')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-cyan-600">Unich & Radar</button>
                    <button onclick="window.switchTab('contact')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Liên hệ & MXH</button>
                    <button onclick="window.switchTab('career')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Học vấn & Việc</button>
                    <button onclick="window.switchTab('bank')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Ngân hàng</button>
                    <button onclick="window.switchTab('partners')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5">Đối tác</button>
                    <button onclick="window.switchTab('messages')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-green-500">Tin nhắn</button>
                    <button onclick="window.switchTab('config')" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 text-red-500">Cấu hình</button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-slate-900 relative">
                    <form id="admin-form" class="space-y-6 max-w-2xl mx-auto pb-20">
                        <!-- TAB: GENERAL -->
                        <div id="tab-general" class="tab-content space-y-4">
                            <div class="flex gap-4 items-center">
                                <img id="preview-avatar" src="" class="w-20 h-20 rounded-full object-cover border">
                                <label class="flex-1 cursor-pointer">
                                    <div class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-bold text-center border-dashed border-2 border-slate-300 hover:border-primary">
                                        Tải ảnh mới (Có cắt)
                                    </div>
                                    <input type="file" id="inp-avatar" class="hidden" accept="image/*">
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="lbl">Họ tên</label><input type="text" id="inp-name" class="inp"></div>
                                <div><label class="lbl">Biệt danh</label><input type="text" id="inp-nickname" class="inp"></div>
                            </div>
                            <div><label class="lbl">Tiểu sử (Bio)</label><textarea id="inp-bio" rows="3" class="inp"></textarea></div>
                            
                            <!-- Tiêu đề & SEO -->
                            <div class="p-4 bg-purple-50 dark:bg-purple-900/10 rounded-xl space-y-3">
                                <h4 class="font-bold text-purple-600 text-sm">Hiển thị Trang</h4>
                                <div><label class="lbl">Tiêu đề (Title)</label><input type="text" id="meta-title-inp" class="inp"></div>
                                <div><label class="lbl">Mô tả (Description)</label><textarea id="meta-desc-inp" rows="2" class="inp"></textarea></div>
                            </div>

                            <div class="border p-3 rounded-xl dark:border-white/10 space-y-2">
                                <label class="lbl">Mối quan hệ</label>
                                <select id="inp-rel-status" class="inp mb-2" onchange="togglePartnerInput()">
                                    <option value="">Không hiển thị</option>
                                    <option value="Độc thân">Độc thân</option>
                                    <option value="Đang hẹn hò">Đang hẹn hò</option>
                                    <option value="Đã kết hôn">Đã kết hôn</option>
                                </select>
                                <div id="partner-inputs" class="hidden grid grid-cols-2 gap-2">
                                    <input type="text" id="inp-partner-name" placeholder="Tên người ấy" class="inp">
                                    <input type="text" id="inp-partner-link" placeholder="Link Profile (FB...)" class="inp">
                                </div>
                            </div>
                        </div>

                        <!-- TAB: UNICH CONFIG -->
                        <div id="tab-unich-admin" class="tab-content hidden space-y-4">
                            <div class="bg-cyan-50 dark:bg-cyan-900/10 p-4 rounded-xl border border-cyan-100 dark:border-cyan-800">
                                <h4 class="font-bold text-cyan-600 mb-3">Thông tin Dự Án Unich</h4>
                                <div class="grid grid-cols-1 gap-3">
                                    <div><label class="lbl">Tiêu đề dự án</label><input type="text" id="unich-title-inp" class="inp"></div>
                                    <div><label class="lbl">Mô tả ngắn</label><textarea id="unich-desc-inp" rows="3" class="inp"></textarea></div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label class="lbl">Link Apple Store</label><input type="text" id="unich-apple-inp" class="inp"></div>
                                        <div><label class="lbl">Link Google Play</label><input type="text" id="unich-android-inp" class="inp"></div>
                                    </div>
                                    <div><label class="lbl">Link QR Code (Ảnh)</label><input type="text" id="unich-qr-inp" class="inp"></div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label class="lbl">Mã giới thiệu (Code)</label><input type="text" id="unich-ref-code-inp" class="inp"></div>
                                        <div><label class="lbl">Link giới thiệu (URL)</label><input type="text" id="unich-ref-link-inp" class="inp"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl border dark:border-white/10">
                                <h4 class="font-bold text-slate-700 dark:text-white mb-3 flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i> Cấu hình Định Vị Admin
                                </h4>
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-sm font-medium">Cho phép User thấy vị trí Admin?</span>
                                    <input type="checkbox" id="admin-loc-visible" class="w-5 h-5 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500">
                                </div>
                                <div class="flex gap-3">
                                    <div class="flex-1">
                                        <p class="text-xs text-slate-500 mb-1">Vị trí hiện tại đã lưu:</p>
                                        <p id="admin-saved-coords" class="font-mono font-bold text-sm">Chưa có</p>
                                    </div>
                                    <button type="button" onclick="window.getAdminCurrentLoc()" class="px-4 py-2 bg-cyan-600 text-white text-xs font-bold rounded-lg shadow hover:bg-cyan-500">Lấy vị trí hiện tại</button>
                                </div>
                                <input type="hidden" id="admin-lat-inp">
                                <input type="hidden" id="admin-lng-inp">
                            </div>
                        </div>

                        <!-- TAB: CONTACT -->
                        <div id="tab-contact" class="tab-content hidden space-y-4">
                            <div class="space-y-2 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl">
                                <label class="lbl">Số điện thoại</label>
                                <div id="phone-list-editor" class="grid grid-cols-1 gap-2"></div>
                                <button type="button" onclick="addPhoneInput()" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-white hover:text-primary transition">+ Thêm số mới</button>
                            </div>
                             <div><label class="lbl">Email</label><input type="text" id="inp-emails" class="inp" placeholder="email1@gmail.com, email2..."></div>
                             <div class="grid grid-cols-2 gap-3">
                                 <div><label class="lbl">Facebook</label><input type="text" id="inp-fb" class="inp"></div>
                                 <div><label class="lbl">Zalo (SĐT)</label><input type="text" id="inp-zalo" class="inp"></div>
                                 <div><label class="lbl">Instagram</label><input type="text" id="inp-ig" class="inp"></div>
                                 <div><label class="lbl">Telegram</label><input type="text" id="inp-tele" class="inp"></div>
                                 <div><label class="lbl">LinkedIn</label><input type="text" id="inp-linkedin" class="inp"></div>
                             </div>
                        </div>

                        <!-- TAB: CAREER -->
                        <div id="tab-career" class="tab-content hidden space-y-4">
                            <label class="lbl">Dữ liệu JSON (Học vấn, Công việc, Thành tựu)</label>
                            <textarea id="inp-career-json" rows="15" class="inp font-mono text-xs p-3"></textarea>
                        </div>

                         <!-- TAB: BANK -->
                         <div id="tab-bank" class="tab-content hidden space-y-4">
                            <div class="flex gap-2">
                                <select id="api-bank-list" class="inp w-1/2"></select>
                                <input type="text" id="bank-acc-num" placeholder="Số tài khoản" class="inp w-1/2">
                            </div>
                            <input type="text" id="bank-acc-name" placeholder="Tên chủ thẻ" class="inp">
                            <button type="button" onclick="addBank()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm Ngân hàng</button>
                            <div id="admin-bank-list" class="space-y-2 mt-4"></div>
                        </div>

                        <!-- TAB: PARTNERS -->
                        <div id="tab-partners" class="tab-content hidden space-y-4">
                            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl space-y-3">
                                <label class="lbl">Thêm Đối tác</label>
                                <input type="text" id="partner-logo-url" placeholder="Link ảnh Logo" class="inp">
                                <input type="text" id="partner-link" placeholder="Link trang web" class="inp">
                                <button type="button" onclick="addPartner()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm vào danh sách</button>
                            </div>
                            <div id="admin-partner-list" class="grid grid-cols-2 gap-3 mt-4"></div>
                        </div>

                        <!-- TAB: MESSAGES -->
                        <div id="tab-messages" class="tab-content hidden space-y-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold">Tin nhắn đến</h4>
                                <button type="button" onclick="loadAdminMessages()" class="text-xs bg-slate-200 dark:bg-slate-800 px-3 py-1 rounded hover:bg-slate-300">Làm mới</button>
                            </div>
                            <div id="admin-messages-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                        </div>

                        <!-- TAB: CONFIG -->
                        <div id="tab-config" class="tab-content hidden space-y-4">
                            <div class="p-4 bg-red-50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/20 space-y-3">
                                <h4 class="font-bold text-red-500 text-sm">GitHub Storage (Lưu ảnh)</h4>
                                <input type="password" id="gh-token" placeholder="Token" class="inp">
                                <input type="text" id="gh-owner" placeholder="Username" class="inp">
                                <input type="text" id="gh-repo" placeholder="Repository" class="inp">
                            </div>
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900/20 space-y-3">
                                <h4 class="font-bold text-blue-500 text-sm">USB Key Login</h4>
                                <div class="flex gap-2">
                                    <input type="text" id="usb-secret-val" placeholder="Nhập mã bí mật..." class="inp">
                                    <button type="button" onclick="saveUSBConfig()" class="px-4 bg-blue-500 text-white rounded-lg font-bold text-xs">Lưu</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="p-4 border-t dark:border-white/10 bg-white dark:bg-slate-900 flex justify-end gap-3">
                <button onclick="window.closeModal('modal-admin')" class="px-6 py-2 rounded-xl text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 transition">Hủy</button>
                <button onclick="window.saveProfile()" class="px-6 py-2 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-indigo-600 transition">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 z-[1000] translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 font-bold text-sm">
            <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg">Thông báo</span>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, arrayUnion, arrayRemove, increment, collection, getDocs, addDoc, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (GIỮ NGUYÊN) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", 
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };
        
        const ADMIN_EMAILS = ["sonlyhongduc@gmail.com"]; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;
        let isUSBAdmin = false;
        let profileData = {};
        let ghConfig = {};
        let listBanks = [];
        let listPartners = [];
        let cropper = null;
        let croppedAvatarBase64 = null;

        // Carrier Logos
        const carrierLogos = {
            'viettel': 'https://upload.wikimedia.org/wikipedia/commons/4/4e/Viettel_logo_2021.png',
            'vinaphone': '/img/vina.png',
            'mobifone': '/img/mobi.PNG',
            'vietnamobile': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Vietnamobile_Logo.png/800px-Vietnamobile_Logo.png',
            'gmobile': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Gmobile_logo.png/800px-Gmobile_logo.png',
            'itel': 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Logo_Itel.png/800px-Logo_Itel.png'
        };

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if(user) {
                // Save user minimal info
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastSeen: new Date().toISOString()
                }, { merge: true });

                const adminRef = doc(db, "settings", "admins");
                const adminSnap = await getDoc(adminRef);
                const serverAdmins = adminSnap.exists() ? adminSnap.data().emails : [];
                isAdmin = ADMIN_EMAILS.includes(user.email) || (serverAdmins && serverAdmins.includes(user.email));

                checkAdminUI();
            } else {
                isAdmin = false;
                checkAdminUI();
            }
            renderAuthUI();
            checkFollowStatus();
        });

        // --- USB LOGIN LOGIC ---
        const usbInput = document.getElementById('usb-key-input');
        usbInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const content = JSON.parse(event.target.result);
                    if (content.key) {
                        const usbRef = doc(db, "settings", "usb_config");
                        const snap = await getDoc(usbRef);
                        if (snap.exists() && snap.data().secret === content.key) {
                            isUSBAdmin = true;
                            showToast("Đã xác thực USB Key thành công!");
                            checkAdminUI();
                        } else {
                            showToast("USB Key không hợp lệ!", true);
                        }
                    }
                } catch (err) { showToast("Lỗi đọc file USB!", true); }
            };
            reader.readAsText(file);
            usbInput.value = ''; 
        });

        function checkAdminUI() {
            if (isAdmin || isUSBAdmin) {
                document.getElementById('admin-btn').classList.remove('hidden');
                document.getElementById('manager-btn').classList.remove('hidden');
                if(isAdmin) loadGithubConfig();
            } else {
                document.getElementById('admin-btn').classList.add('hidden');
                document.getElementById('manager-btn').classList.add('hidden');
            }
        }

        window.saveUSBConfig = async () => {
            const val = document.getElementById('usb-secret-val').value;
            if (!val) return;
            await setDoc(doc(db, "settings", "usb_config"), { secret: val });
            showToast("Đã lưu mã USB Key!");
        }

        // --- SCROLL REVEAL ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.classList.add('active');
            });
        }, { threshold: 0.1 });

        function initScrollReveal() {
            document.querySelectorAll('.reveal-on-scroll').forEach(el => observer.observe(el));
        }

        // --- MAIN DATA SYNC ---
        const profileRef = doc(db, "profile_data", "main");
        
        onSnapshot(profileRef, (docSnap) => {
            document.getElementById('global-loading').classList.add('opacity-0', 'pointer-events-none');
            if (docSnap.exists()) {
                profileData = docSnap.data();
                renderProfile();
                renderUnichSection();
                initScrollReveal();
            }
        });

        // --- RENDER FUNCTIONS ---
        function renderProfile() {
            // Meta
            if(profileData.meta) {
                document.title = profileData.meta.title || profileData.name;
                document.getElementById('meta-desc').setAttribute('content', profileData.meta.description || '');
                if(profileData.meta.favicon) document.getElementById('meta-icon').href = profileData.meta.favicon;
            }

            // PWA Manifest (Dynamic)
            const manifestLink = document.getElementById('dynamic-manifest');
            const currentIcon = profileData.avatar || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            const manifestObj = {
                "name": profileData.name,
                "short_name": profileData.nickname,
                "start_url": location.href,
                "display": "standalone",
                "background_color": "#f8fafc",
                "theme_color": "#6366f1",
                "icons": [{ "src": currentIcon, "sizes": "512x512", "type": "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifestObj)], {type: 'application/json'});
            manifestLink.setAttribute('href', URL.createObjectURL(blob));

            // Basic Info
            document.getElementById('profile-name').innerText = profileData.name || "No Name";
            if(profileData.avatar) {
                document.getElementById('profile-avatar').src = profileData.avatar;
                document.getElementById('nav-avatar').src = profileData.avatar;
            }
            if(profileData.nickname) {
                const badge = document.getElementById('profile-nickname-badge');
                badge.innerText = profileData.nickname;
                badge.classList.remove('hidden');
            }
            document.getElementById('profile-bio').innerText = profileData.bio || "";
            document.getElementById('stat-followers').innerText = (profileData.followers || []).length;
            document.getElementById('stat-views').innerText = profileData.views || 0;

            // Relationship
            const relEl = document.getElementById('relationship-display');
            if (profileData.relationship?.status && profileData.relationship.status !== '') {
                relEl.classList.remove('hidden');
                let html = `${profileData.relationship.status}`;
                if(profileData.relationship.partnerName) {
                    html += ` với <a href="${profileData.relationship.partnerLink || '#'}" target="_blank" class="font-black hover:underline ml-1">${profileData.relationship.partnerName}</a>`;
                }
                document.getElementById('rel-status').innerHTML = html;
            } else {
                relEl.classList.add('hidden');
            }

            // Socials
            const socialMap = {
                facebook: { icon: 'facebook', color: 'text-blue-600' },
                zalo: { icon: 'phone', color: 'text-blue-500' },
                instagram: { icon: 'instagram', color: 'text-pink-600' },
                telegram: { icon: 'send', color: 'text-sky-500' },
                linkedin: { icon: 'linkedin', color: 'text-blue-700' },
            };
            let socialHtml = '';
            if(profileData.socials) {
                Object.keys(profileData.socials).forEach(key => {
                    const val = profileData.socials[key];
                    if(val) {
                        const meta = socialMap[key] || { icon: 'link', color: 'text-slate-500' };
                        let link = val;
                        if(key === 'zalo') link = `https://zalo.me/${val}`;
                        if(key === 'telegram') link = `https://t.me/${val}`;
                        socialHtml += `
                        <a href="${link}" target="_blank" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow hover:-translate-y-1 transition ${meta.color}">
                            <i data-lucide="${meta.icon}" class="w-5 h-5"></i>
                        </a>`;
                    }
                });
            }
            document.getElementById('social-grid').innerHTML = socialHtml;

            // Banks (FIXED LOGO SIZE)
            document.getElementById('bank-list').innerHTML = (profileData.banks || []).map(b => `
                <div class="bank-card p-4 rounded-xl flex items-center justify-between shadow-lg relative overflow-hidden group bg-white dark:bg-slate-900 border dark:border-white/5">
                    <div class="flex items-center gap-4 z-10 w-full overflow-hidden">
                        <div class="w-12 h-12 bg-white rounded-lg shadow-inner flex items-center justify-center shrink-0 p-1">
                            <img src="${b.logo}" class="w-full h-full object-contain">
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">${b.shortName}</p>
                            <p class="font-mono font-bold text-lg text-slate-800 dark:text-white truncate">${b.number}</p>
                            <p class="text-[10px] font-bold uppercase text-slate-500 truncate">${b.owner}</p>
                        </div>
                    </div>
                    <button onclick="window.copyToClip('${b.number}')" class="p-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary hover:text-white rounded-lg z-10 transition shrink-0 ml-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                    <!-- Deco BG -->
                    <div class="absolute -right-4 -bottom-4 opacity-5 pointer-events-none">
                       <img src="${b.logo}" class="w-24 h-24 object-contain grayscale">
                    </div>
                </div>
            `).join('');

            // Timeline & Achievements (Kept same logic)
            const careerContainer = document.getElementById('career-timeline');
            const items = [...(profileData.education || []), ...(profileData.work || [])];
            if(items.length === 0) careerContainer.innerHTML = '<p class="text-sm text-slate-400 italic">Chưa cập nhật.</p>';
            else {
                careerContainer.innerHTML = items.map(item => `
                    <div class="relative mb-6 last:mb-0">
                        <span class="absolute -left-[33px] w-4 h-4 rounded-full bg-primary border-4 border-white dark:border-slate-800"></span>
                        <h4 class="font-bold text-slate-800 dark:text-white">${item.title}</h4>
                        <p class="text-xs font-bold text-primary mb-1">${item.org}</p>
                        <p class="text-xs text-slate-500">${item.time} • ${item.status || ''}</p>
                    </div>
                `).join('');
            }
            
            const achContainer = document.getElementById('achievement-list');
             achContainer.innerHTML = (profileData.achievements || []).length ? profileData.achievements.map(a => `
                <div class="p-4 bg-white dark:bg-slate-800 rounded-xl border dark:border-white/5 flex items-start gap-3">
                    <div class="p-2 bg-yellow-100 dark:bg-yellow-900/20 text-yellow-600 rounded-lg"><i data-lucide="award" class="w-5 h-5"></i></div>
                    <div>
                        <h5 class="font-bold text-sm">${a.title}</h5>
                        <span class="text-[10px] font-bold px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-slate-500">${a.date}</span>
                    </div>
                </div>
            `).join('') : '<p class="text-sm text-slate-400 italic col-span-2 text-center">Chưa có thành tựu.</p>';

            // Partners
            const partnerSec = document.getElementById('partners-section');
            if(profileData.partners && profileData.partners.length > 0) {
                partnerSec.classList.remove('hidden');
                document.getElementById('partners-grid').innerHTML = profileData.partners.map(p => `
                    <a href="${p.link}" target="_blank" class="block group">
                        <img src="${p.logo}" class="h-8 md:h-10 w-auto object-contain transition group-hover:scale-110">
                    </a>
                `).join('');
            } else { partnerSec.classList.add('hidden'); }

            checkFollowStatus(); 
            lucide.createIcons();
        }

        // --- UNICH LOGIC ---
        function renderUnichSection() {
            const u = profileData.unich || {};
            
            document.getElementById('unich-title').innerText = u.title || "Unich Project";
            document.getElementById('unich-desc').innerText = u.desc || "Hệ sinh thái kết nối vạn vật.";
            
            // Store Links
            const appStore = document.getElementById('link-apple');
            const playStore = document.getElementById('link-android');
            if(u.appleLink) { appStore.href = u.appleLink; appStore.classList.remove('hidden'); }
            else appStore.classList.add('hidden');
            if(u.androidLink) { playStore.href = u.androidLink; playStore.classList.remove('hidden'); }
            else playStore.classList.add('hidden');
            
            // Ref & QR
            document.getElementById('unich-ref-code').innerText = u.refCode || "CODE123";
            document.getElementById('unich-ref-link').href = u.refLink || "#";
            if(u.qrCode) document.getElementById('unich-qr').src = u.qrCode;
        }

        window.copyUnichRef = () => {
            const code = document.getElementById('unich-ref-code').innerText;
            navigator.clipboard.writeText(code);
            showToast(`Đã sao chép mã: ${code}`);
        }

        // --- LOCATION / RADAR LOGIC ---
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }

        window.updateMyPosition = () => {
            if(!currentUser) { showToast("Vui lòng đăng nhập để dùng tính năng này!", true); window.doLogin(); return; }
            if(!navigator.geolocation) { showToast("Trình duyệt không hỗ trợ định vị.", true); return; }

            const btn = document.querySelector("button[onclick='window.updateMyPosition()']");
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Đang quét...`;
            lucide.createIcons();

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const phone = profileData.phones && profileData.phones.length > 0 ? profileData.phones[0].number : "Chưa có SĐT";

                // Save user location to 'unich_users' collection
                await setDoc(doc(db, "unich_users", currentUser.uid), {
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    lat: lat,
                    lng: lng,
                    timestamp: new Date().toISOString(),
                    platform: isIOS ? 'ios' : 'android',
                    phone: phone
                }, { merge: true });

                showToast("Đã cập nhật vị trí của bạn!");
                loadUnichRadar(lat, lng);
                btn.innerHTML = originalText;
                lucide.createIcons();
            }, (err) => {
                showToast("Không thể lấy vị trí. Hãy cấp quyền.", true);
                btn.innerHTML = originalText;
                lucide.createIcons();
            });
        }

        async function loadUnichRadar(myLat, myLng) {
            const listEl = document.getElementById('unich-list');
            listEl.innerHTML = '<div class="text-center py-4"><div class="animate-spin w-6 h-6 border-2 border-cyan-500 border-t-transparent rounded-full mx-auto"></div></div>';

            const adminConfig = profileData.unich || {};
            let nearbyData = [];

            // 1. Calculate Admin Distance
            if(adminConfig.showAdminLocation && adminConfig.adminLat && adminConfig.adminLng) {
                const d = haversine(myLat, myLng, adminConfig.adminLat, adminConfig.adminLng);
                nearbyData.push({
                    type: 'admin',
                    uid: 'admin',
                    displayName: profileData.name + " (Admin)",
                    photoURL: profileData.avatar,
                    lat: adminConfig.adminLat,
                    lng: adminConfig.adminLng,
                    distance: d,
                    phone: profileData.phones?.[0]?.number || ''
                });

                if(d < 10) {
                    document.getElementById('unich-connect-alert').classList.remove('hidden');
                } else {
                    document.getElementById('unich-connect-alert').classList.add('hidden');
                }
            }

            // 2. Fetch other users (last 24h)
            try {
                const q = query(collection(db, "unich_users"), orderBy("timestamp", "desc"), limit(50));
                const snap = await getDocs(q);
                snap.forEach(d => {
                    const u = d.data();
                    if(u.uid !== currentUser.uid) { // Exclude self
                         const dist = haversine(myLat, myLng, u.lat, u.lng);
                         nearbyData.push({ ...u, distance: dist, type: 'user' });
                    }
                });
            } catch(e) { console.error(e); }

            // 3. Sort by Distance
            nearbyData.sort((a, b) => a.distance - b.distance);

            // 4. Render
            if(nearbyData.length === 0) {
                listEl.innerHTML = '<p class="text-center text-slate-400 text-xs py-4">Chưa có ai gần đây.</p>';
                return;
            }

            listEl.innerHTML = nearbyData.map(u => {
                // Determine Map Link
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const mapLink = isIOS 
                    ? `http://maps.apple.com/?daddr=${u.lat},${u.lng}`
                    : `https://www.google.com/maps/dir/?api=1&destination=${u.lat},${u.lng}`;
                
                const badge = u.type === 'admin' ? '<span class="bg-primary text-white text-[10px] px-1.5 rounded font-bold">ADMIN</span>' : '';
                const phoneBtn = u.phone ? `<a href="tel:${u.phone}" class="p-2 bg-green-100 text-green-600 rounded-full hover:bg-green-200"><i data-lucide="phone" class="w-4 h-4"></i></a>` : '';

                return `
                <div class="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-white/5">
                    <div class="flex items-center gap-3">
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full border-2 ${u.type === 'admin' ? 'border-primary' : 'border-slate-200'}">
                        <div>
                            <div class="flex items-center gap-1">
                                <span class="font-bold text-sm text-slate-800 dark:text-white">${u.displayName}</span>
                                ${badge}
                            </div>
                            <span class="text-xs font-bold text-cyan-600">${u.distance.toFixed(1)} km</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        ${phoneBtn}
                        <a href="${mapLink}" target="_blank" class="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200">
                            <i data-lucide="navigation" class="w-4 h-4"></i>
                        </a>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }


        // --- VIEW SWITCHER ---
        window.switchMainView = (view) => {
            const profileView = document.getElementById('view-profile');
            const unichView = document.getElementById('view-unich');
            const btnProfile = document.getElementById('nav-btn-profile');
            const btnUnich = document.getElementById('nav-btn-unich');

            if(view === 'profile') {
                profileView.classList.remove('hidden');
                unichView.classList.add('hidden');
                btnProfile.classList.add('active', 'text-slate-800', 'dark:text-white');
                btnProfile.classList.remove('text-slate-400');
                btnUnich.classList.remove('active', 'text-slate-800', 'dark:text-white');
                btnUnich.classList.add('text-slate-400');
            } else {
                profileView.classList.add('hidden');
                unichView.classList.remove('hidden');
                btnUnich.classList.add('active', 'text-slate-800', 'dark:text-white');
                btnUnich.classList.remove('text-slate-400');
                btnProfile.classList.remove('active', 'text-slate-800', 'dark:text-white');
                btnProfile.classList.add('text-slate-400');
            }
        }

        // --- AUTH UI ---
        function renderAuthUI() {
            const container = document.getElementById('auth-section');
            if (currentUser) {
                container.innerHTML = `<img src="${currentUser.photoURL}" onclick="window.doLogout()" class="w-8 h-8 rounded-full border border-slate-200 cursor-pointer">`;
            } else {
                container.innerHTML = `<button onclick="window.doLogin()" class="px-4 py-1.5 bg-primary text-white text-xs font-bold rounded-full shadow">Đăng nhập</button>`;
            }
        }
        window.doLogin = () => signInWithPopup(auth, provider);
        window.doLogout = () => signOut(auth).then(()=> location.reload());

        // --- CONTACT ---
        window.showContactModal = (type) => {
            document.getElementById('modal-contact').classList.remove('hidden');
            const list = document.getElementById('contact-list');
            const title = document.getElementById('contact-title');
            
            if (type === 'phone') {
                title.innerText = "Gọi điện thoại";
                const phones = profileData.phones || [];
                if(phones.length === 0) list.innerHTML = '<p class="text-center text-slate-500">Chưa có số điện thoại.</p>';
                else {
                    list.innerHTML = phones.map(p => {
                        const carrierKey = p.carrier ? p.carrier.toLowerCase().trim() : '';
                        const logoUrl = carrierLogos[carrierKey];
                        const icon = logoUrl ? `<img src="${logoUrl}" class="h-6 w-12 object-contain bg-white rounded px-1">` : `<span class="bg-gray-200 text-xs px-2 py-1 rounded">${p.carrier}</span>`;
                        return `<a href="tel:${p.number}" class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl hover:bg-slate-100 transition"><div class="flex items-center gap-3">${icon}<span class="font-bold text-lg">${p.number}</span></div><i data-lucide="phone-call" class="w-5 h-5 text-green-500"></i></a>`;
                    }).join('');
                }
            } else {
                title.innerText = "Gửi Email";
                const emails = (profileData.email || "").split(',').filter(e=>e);
                list.innerHTML = emails.length ? emails.map(e => `<a href="mailto:${e.trim()}" class="flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100"><span class="font-bold text-sm">${e.trim()}</span><i data-lucide="send" class="w-5 h-5 text-blue-500"></i></a>`).join('') : '<p>Chưa có email.</p>';
            }
            lucide.createIcons();
        }

        window.showContactForm = () => {
             document.getElementById('modal-send-msg').classList.remove('hidden');
             if(currentUser) {
                 document.getElementById('msg-name').value = currentUser.displayName;
                 document.getElementById('msg-email').value = currentUser.email;
                 document.getElementById('msg-email-group').classList.add('hidden'); 
             }
        }
        window.toggleAnon = () => {
            const isAnon = document.getElementById('msg-anon').checked;
            document.getElementById('msg-name').disabled = isAnon;
            if(!currentUser) document.getElementById('msg-email-group').classList.toggle('hidden', isAnon);
        }
        window.sendContact = async () => {
            const content = document.getElementById('msg-content').value;
            if(!content) { showToast("Vui lòng nhập nội dung!", true); return; }
            const isAnon = document.getElementById('msg-anon').checked;
            try {
                await addDoc(collection(db, "messages"), {
                    name: isAnon ? "Ẩn danh" : document.getElementById('msg-name').value,
                    email: isAnon ? "" : (currentUser ? currentUser.email : document.getElementById('msg-email').value),
                    content, timestamp: new Date().toISOString()
                });
                showToast("Đã gửi tin nhắn!"); window.closeModal('modal-send-msg');
            } catch(e) { showToast("Lỗi gửi tin", true); }
        }

        // --- ADMIN ---
        window.openEditModal = async () => {
            document.getElementById('modal-admin').classList.remove('hidden');
            // Populate Fields
            document.getElementById('preview-avatar').src = profileData.avatar || '';
            document.getElementById('inp-name').value = profileData.name || '';
            document.getElementById('inp-nickname').value = profileData.nickname || '';
            document.getElementById('inp-bio').value = profileData.bio || '';
            
            // Meta
            if(profileData.meta) {
                document.getElementById('meta-title-inp').value = profileData.meta.title || '';
                document.getElementById('meta-desc-inp').value = profileData.meta.description || '';
            }
            // Relationship
            if(profileData.relationship) {
                document.getElementById('inp-rel-status').value = profileData.relationship.status;
                document.getElementById('inp-partner-name').value = profileData.relationship.partnerName || '';
                document.getElementById('inp-partner-link').value = profileData.relationship.partnerLink || '';
                togglePartnerInput();
            }
            // Unich
            const u = profileData.unich || {};
            document.getElementById('unich-title-inp').value = u.title || '';
            document.getElementById('unich-desc-inp').value = u.desc || '';
            document.getElementById('unich-apple-inp').value = u.appleLink || '';
            document.getElementById('unich-android-inp').value = u.androidLink || '';
            document.getElementById('unich-qr-inp').value = u.qrCode || '';
            document.getElementById('unich-ref-code-inp').value = u.refCode || '';
            document.getElementById('unich-ref-link-inp').value = u.refLink || '';
            document.getElementById('admin-loc-visible').checked = u.showAdminLocation || false;
            document.getElementById('admin-saved-coords').innerText = (u.adminLat && u.adminLng) ? `${u.adminLat}, ${u.adminLng}` : "Chưa có";
            document.getElementById('admin-lat-inp').value = u.adminLat || '';
            document.getElementById('admin-lng-inp').value = u.adminLng || '';

            // Phones
            const phones = profileData.phones || [];
            document.getElementById('phone-list-editor').innerHTML = '';
            phones.forEach(p => addPhoneInput(p.number, p.carrier));
            // Socials
            document.getElementById('inp-emails').value = profileData.email || '';
            if(profileData.socials) {
                document.getElementById('inp-fb').value = profileData.socials.facebook || '';
                document.getElementById('inp-zalo').value = profileData.socials.zalo || '';
                document.getElementById('inp-ig').value = profileData.socials.instagram || '';
                document.getElementById('inp-tele').value = profileData.socials.telegram || '';
                document.getElementById('inp-linkedin').value = profileData.socials.linkedin || '';
            }
            // Career JSON
            document.getElementById('inp-career-json').value = JSON.stringify({
                education: profileData.education || [], work: profileData.work || [], achievements: profileData.achievements || []
            }, null, 2);
            // Lists
            listBanks = profileData.banks || []; renderAdminBanks(); loadBankList();
            listPartners = profileData.partners || []; renderAdminPartners();
            // Messages
            loadAdminMessages();
        }

        // Admin Geo
        window.getAdminCurrentLoc = () => {
            if(!navigator.geolocation) return alert("Không hỗ trợ định vị");
            navigator.geolocation.getCurrentPosition(p => {
                const lat = p.coords.latitude, lng = p.coords.longitude;
                document.getElementById('admin-lat-inp').value = lat;
                document.getElementById('admin-lng-inp').value = lng;
                document.getElementById('admin-saved-coords').innerText = `${lat}, ${lng} (Mới)`;
            });
        }

        window.saveProfile = async () => {
            const btn = document.querySelector('#modal-admin button.bg-primary');
            btn.innerText = "Đang lưu...";
            try {
                // Github Config Save
                const tk = document.getElementById('gh-token').value;
                const ow = document.getElementById('gh-owner').value;
                const re = document.getElementById('gh-repo').value;
                if(tk) await setDoc(doc(db, "settings", "github_config"), { token: tk, owner: ow, repo: re });

                // Avatar Upload
                let avatarUrl = profileData.avatar;
                if(croppedAvatarBase64 && tk) {
                    const res = await fetch(`https://api.github.com/repos/${ow}/${re}/contents/avatars/${Date.now()}.png`, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${tk}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: "Up Avatar", content: croppedAvatarBase64.split(',')[1] })
                    });
                    if(res.ok) avatarUrl = (await res.json()).content.download_url;
                }

                // Data Construction
                const phones = Array.from(document.querySelectorAll('#phone-list-editor .phone-row')).map(r => ({
                    carrier: r.querySelector('select').value, number: r.querySelector('input').value
                })).filter(x=>x.number);
                
                const career = JSON.parse(document.getElementById('inp-career-json').value);

                const newData = {
                    name: document.getElementById('inp-name').value,
                    nickname: document.getElementById('inp-nickname').value,
                    bio: document.getElementById('inp-bio').value,
                    avatar: avatarUrl,
                    meta: {
                        title: document.getElementById('meta-title-inp').value,
                        description: document.getElementById('meta-desc-inp').value
                    },
                    relationship: {
                        status: document.getElementById('inp-rel-status').value,
                        partnerName: document.getElementById('inp-partner-name').value,
                        partnerLink: document.getElementById('inp-partner-link').value
                    },
                    email: document.getElementById('inp-emails').value,
                    phones: phones,
                    socials: {
                        facebook: document.getElementById('inp-fb').value,
                        zalo: document.getElementById('inp-zalo').value,
                        instagram: document.getElementById('inp-ig').value,
                        telegram: document.getElementById('inp-tele').value,
                        linkedin: document.getElementById('inp-linkedin').value,
                    },
                    unich: {
                        title: document.getElementById('unich-title-inp').value,
                        desc: document.getElementById('unich-desc-inp').value,
                        appleLink: document.getElementById('unich-apple-inp').value,
                        androidLink: document.getElementById('unich-android-inp').value,
                        qrCode: document.getElementById('unich-qr-inp').value,
                        refCode: document.getElementById('unich-ref-code-inp').value,
                        refLink: document.getElementById('unich-ref-link-inp').value,
                        showAdminLocation: document.getElementById('admin-loc-visible').checked,
                        adminLat: parseFloat(document.getElementById('admin-lat-inp').value) || null,
                        adminLng: parseFloat(document.getElementById('admin-lng-inp').value) || null
                    },
                    banks: listBanks,
                    partners: listPartners,
                    education: career.education || [], work: career.work || [], achievements: career.achievements || []
                };

                await setDoc(profileRef, newData, { merge: true });
                showToast("Đã lưu thành công!");
                window.closeModal('modal-admin');
            } catch(e) { showToast("Lỗi: " + e.message, true); }
            btn.innerText = "Lưu Thay Đổi";
        }

        // --- HELPERS (Cropper, UI, Admin Lists) ---
        // Cropper
        document.getElementById('inp-avatar').addEventListener('change', (e) => {
            if(e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    document.getElementById('image-to-crop').src = evt.target.result;
                    document.getElementById('modal-crop').classList.remove('hidden');
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(document.getElementById('image-to-crop'), { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        window.confirmCrop = () => {
            if(cropper) {
                croppedAvatarBase64 = cropper.getCroppedCanvas({width:400,height:400}).toDataURL();
                document.getElementById('preview-avatar').src = croppedAvatarBase64;
                window.closeModal('modal-crop');
            }
        }

        // Phone List (FIXED LAYOUT)
        window.addPhoneInput = (val='', carrier='Viettel') => {
            const div = document.createElement('div');
            div.className = 'phone-row flex gap-2 items-center bg-white p-2 rounded shadow-sm border border-gray-200';
            div.innerHTML = `
                <select class="inp w-[110px] shrink-0 text-xs h-9">
                    <option value="Viettel" ${carrier==='Viettel'?'selected':''}>Viettel</option>
                    <option value="Vinaphone" ${carrier==='Vinaphone'?'selected':''}>Vina</option>
                    <option value="Mobifone" ${carrier==='Mobifone'?'selected':''}>Mobi</option>
                    <option value="Vietnamobile" ${carrier==='Vietnamobile'?'selected':''}>VNM</option>
                    <option value="Gmobile" ${carrier==='Gmobile'?'selected':''}>Gmobile</option>
                    <option value="Itel" ${carrier==='Itel'?'selected':''}>Itel/Khác</option>
                </select>
                <input type="text" value="${val}" class="inp flex-1 font-bold text-slate-700 min-w-0 h-9" placeholder="Số điện thoại">
                <button type="button" onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            document.getElementById('phone-list-editor').appendChild(div);
            lucide.createIcons();
        }

        // Bank List
        async function loadBankList() { try{const r=await fetch('https://api.vietqr.io/v2/banks');const d=await r.json();if(d.code==="00") document.getElementById('api-bank-list').innerHTML=d.data.map(b=>`<option value='${JSON.stringify({shortName:b.shortName,logo:b.logo})}'>${b.shortName}</option>`).join('');}catch(e){} }
        window.addBank=()=>{const m=JSON.parse(document.getElementById('api-bank-list').value);const n=document.getElementById('bank-acc-num').value;const o=document.getElementById('bank-acc-name').value;if(n)listBanks.push({...m,number:n,owner:o});renderAdminBanks();}
        function renderAdminBanks(){document.getElementById('admin-bank-list').innerHTML=listBanks.map((b,i)=>`<div class="flex items-center justify-between p-2 bg-slate-100 rounded text-xs"><div class="flex items-center gap-2"><img src="${b.logo}" class="w-5 h-5 object-contain">${b.shortName}-${b.number}</div><button onclick="listBanks.splice(${i},1);renderAdminBanks()" class="text-red-500">Xóa</button></div>`).join('');}
        
        // Partner List
        window.addPartner=()=>{const l=document.getElementById('partner-logo-url').value;const k=document.getElementById('partner-link').value;if(l)listPartners.push({logo:l,link:k});renderAdminPartners();}
        function renderAdminPartners(){document.getElementById('admin-partner-list').innerHTML=listPartners.map((p,i)=>`<div class="relative border h-16 flex items-center justify-center p-2"><img src="${p.logo}" class="h-full object-contain"><button onclick="listPartners.splice(${i},1);renderAdminPartners()" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs">x</button></div>`).join('');}

        // Messages
        window.loadAdminMessages=async()=>{
            const l=document.getElementById('admin-messages-list'); l.innerHTML='...';
            const s=await getDocs(query(collection(db,"messages"),orderBy("timestamp","desc"),limit(20)));
            l.innerHTML=s.empty?'<span class="text-xs">Trống</span>':"";
            s.forEach(d=>{ const m=d.data(); l.innerHTML+=`<div class="p-2 bg-slate-100 rounded mb-2 text-xs"><b>${m.name}</b>: ${m.content} <br><span class="text-[10px] text-gray-500">${m.email}</span></div>`; });
        }
        
        // Manager
        window.openManagerModal = async () => {
             document.getElementById('modal-manager').classList.remove('hidden');
             const l = document.getElementById('manager-list'); l.innerHTML = 'Loading...';
             const s = await getDocs(collection(db, "users"));
             l.innerHTML = '';
             s.forEach(d => { const u = d.data(); l.innerHTML += `<div class="flex gap-2 p-2 border-b"><img src="${u.photoURL}" class="w-8 h-8 rounded-full"><div class="text-xs"><b>${u.displayName}</b><br>${u.email}</div></div>`; });
        }

        // Utils
        window.closeModal=(id)=>document.getElementById(id).classList.add('hidden');
        window.toggleTheme=()=>{document.documentElement.classList.toggle('dark');localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');}
        if(localStorage.theme==='dark')document.documentElement.classList.add('dark');
        window.copyToClip=(t)=>{navigator.clipboard.writeText(t);showToast('Đã sao chép!');}
        window.switchTab=(t)=>{document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));document.getElementById('tab-'+t).classList.remove('hidden');document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('bg-white','dark:bg-white/5'));event.target.classList.add('bg-white','dark:bg-white/5');}
        window.togglePartnerInput=()=>{document.getElementById('partner-inputs').classList.toggle('hidden',!document.getElementById('inp-rel-status').value);}
        window.checkFollowStatus=()=>{ /* Logic kept in sync with renderProfile */ }
        window.toggleFollow=async()=>{
            if(!currentUser) return window.doLogin();
            const uid=currentUser.uid; const f=profileData.followers||[];
            if(f.includes(uid)) { await updateDoc(profileRef,{followers:arrayRemove(uid)}); showToast("Đã hủy theo dõi"); }
            else { await updateDoc(profileRef,{followers:arrayUnion(uid)}); showToast("Đã theo dõi!"); }
        }
        async function loadGithubConfig() { const s = await getDoc(doc(db, "settings", "github_config")); if(s.exists()) { ghConfig = s.data(); document.getElementById('gh-token').value = ghConfig.token || ''; document.getElementById('gh-owner').value = ghConfig.owner || ''; document.getElementById('gh-repo').value = ghConfig.repo || ''; } }
        
        function showToast(msg,err=false){
            const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=msg;
            const i=document.getElementById('toast-icon'); i.setAttribute('data-lucide',err?'alert-triangle':'check-circle'); i.className=err?'w-5 h-5 text-red-500':'w-5 h-5 text-green-500';
            lucide.createIcons(); t.classList.remove('translate-y-20','opacity-0'); setTimeout(()=>t.classList.add('translate-y-20','opacity-0'),3000);
        }

        lucide.createIcons();
    </script>
    <style>
        .inp { width: 100%; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; background-color: #f8fafc; outline: none; font-size: 0.875rem; transition: border-color 0.2s; }
        .dark .inp { background-color: #1e293b; border-color: rgba(255,255,255,0.1); color: white; }
        .inp:focus { border-color: #6366f1; }
        .lbl { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 0.25rem; }
        .btn-primary { background-color: #6366f1; color: white; }
    </style>
</body>
</html>
