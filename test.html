<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Elite Protocol V2</title>
    
    <!-- SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --surface: #121212;
            --surface-light: #1e1e1e;
            --primary: #00f2ea;
            --secondary: #7000ff;
            --danger: #ff2d55;
            --success: #32d74b;
            --text-main: #ffffff;
            --text-muted: #8899a6;
            --font-head: 'Rajdhani', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .hidden { display: none !important; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .btn-base { width: 100%; border: none; padding: 14px; border-radius: 10px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-family: var(--font-head); transition: 0.2s; }
        .btn-base:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 15px rgba(0, 242, 234, 0.2); }
        .btn-danger { background: var(--danger); color: #fff; }
        
        /* WEB LOGIN */
        .login-box { background: var(--surface); padding: 30px; border-radius: 16px; border: 1px solid #333; text-align: center; }

        /* APP UI */
        #app-container { flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .header-section { padding: 20px; }
        .user-card { background: linear-gradient(135deg, #222, #111); padding: 20px; border-radius: 16px; border: 1px solid #333; display: flex; align-items: center; gap: 15px; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #333; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .balance-box { text-align: center; margin: 40px 0; }
        .balance-val { font-size: 50px; font-weight: 800; font-family: var(--font-head); color: #fff; text-shadow: 0 0 20px rgba(0,242,234,0.3); }

        .tab-content { display: none; padding: 0 20px; animation: fadeUp 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT CODE */
        .code-area { background: var(--surface-light); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #333; }
        .code-input { width: 100%; background: #000; color: var(--primary); border: 1px solid #444; padding: 12px; font-family: var(--font-code); text-align: center; font-size: 18px; margin-bottom: 10px; border-radius: 8px; text-transform: uppercase; }

        /* HISTORY */
        .hist-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #222; font-size: 13px; }
        .plus { color: var(--success); } .minus { color: var(--danger); }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: var(--nav-height); background: rgba(10,10,10,0.95); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 90; }
        .nav-item { color: #666; text-align: center; font-size: 10px; cursor: pointer; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .nav-item.active { color: var(--primary); }

        /* ADMIN PANEL 10X */
        #admin-btn { position: fixed; top: 10px; right: 10px; background: rgba(255,45,85,0.2); color: var(--danger); padding: 5px 10px; border-radius: 20px; font-size: 10px; cursor: pointer; border: 1px solid var(--danger); z-index: 99; }
        
        .admin-modal { position: fixed; inset: 0; background: #000; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; }
        .admin-modal.open { transform: translateY(0); }
        .adm-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .adm-tabs { display: flex; background: #111; padding: 5px; gap: 5px; overflow-x: auto; }
        .adm-tab { padding: 8px 15px; background: #222; border-radius: 6px; font-size: 12px; color: #888; white-space: nowrap; cursor: pointer; }
        .adm-tab.active { background: var(--primary); color: #000; font-weight: bold; }
        
        .adm-content { flex: 1; overflow-y: auto; padding: 15px; }
        .adm-card { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .adm-stat { font-size: 24px; font-family: var(--font-code); color: #fff; }
        .adm-label { font-size: 11px; color: #888; text-transform: uppercase; }
        
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        .user-row-info { font-size: 12px; }
        .user-row-actions button { padding: 4px 8px; font-size: 10px; border-radius: 4px; border: none; cursor: pointer; margin-left: 5px; }
        
        .code-list-item { background: #222; padding: 10px; border-radius: 6px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <!-- 1. WEB LOGIN -->
    <div id="login-screen" class="hidden" style="position:fixed; inset:0; z-index:150; background:#000; display:flex; align-items:center; justify-content:center;">
        <div class="login-box">
            <h2 style="color:var(--primary); font-family:var(--font-head);">ELITE PROTOCOL</h2>
            <p style="color:#888; font-size:13px; margin-bottom:20px;">Secure Login via Telegram</p>
            <script async src="https://telegram.org/js/telegram-widget.js?22" 
                    data-telegram-login="Bmassk3_bot" 
                    data-size="large" 
                    data-radius="8" 
                    data-onauth="onTelegramAuth(user)" 
                    data-request-access="write"></script>
        </div>
    </div>

    <!-- 2. LOADING -->
    <div id="loader" style="position:fixed; inset:0; z-index:140; background:#000; display:flex; align-items:center; justify-content:center; color:#fff;">
        <div style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:30px; color:var(--primary); margin-bottom:15px;"></i>
            <div style="font-family:var(--font-code); font-size:12px;">SYSTEM SYNC...</div>
        </div>
    </div>

    <!-- 3. MAIN APP -->
    <div id="admin-btn" class="hidden" onclick="Admin.open()">ADMIN DASH</div>

    <div id="app-container" class="hidden">
        <div class="header-section">
            <div class="user-card">
                <div class="avatar" id="u-avatar"><i class="fas fa-user" style="line-height:50px; text-align:center; width:50px; color:#888;"></i></div>
                <div>
                    <div id="u-name" style="font-weight:700;">Loading...</div>
                    <div style="font-size:11px; color:#666;">ID: <span id="u-id">---</span></div>
                </div>
            </div>
        </div>

        <!-- HOME -->
        <div id="tab-home" class="tab-content active">
            <div class="balance-box">
                <div style="color:#888; font-size:12px; letter-spacing:2px;">BALANCE</div>
                <div class="balance-val" id="u-score">0</div>
            </div>
            <div style="padding: 0 20px;">
                <div id="ton-connect" style="margin-bottom:15px;"></div>
                <button class="btn-base" style="background:#222; color:#fff; border:1px solid #444;" onclick="alert('Available after TGE')">
                    <i class="fas fa-lock"></i> WITHDRAW
                </button>
            </div>
        </div>

        <!-- EARN (CODE SYSTEM) -->
        <div id="tab-earn" class="tab-content">
            <h2 style="font-family:var(--font-head);">MISSION CENTER</h2>
            
            <div class="code-area">
                <i class="fas fa-gift" style="font-size:30px; color:var(--primary); margin-bottom:10px;"></i>
                <h3 style="margin:0 0 10px 0;">REDEEM CODE</h3>
                <p style="font-size:12px; color:#888;">Enter codes released in our channel.</p>
                <input type="text" id="daily-code" class="code-input" placeholder="ENTER CODE HERE">
                <button class="btn-base btn-primary" onclick="Core.redeemCode()">CLAIM REWARD</button>
            </div>

            <div style="margin-top:20px;">
                <h4 style="margin-bottom:10px;">Daily Tasks</h4>
                <div class="hist-item" style="background:#1a1a1a; border-radius:8px;">
                    <div>Check-in Daily</div>
                    <button style="background:var(--success); border:none; border-radius:4px; color:#000; font-weight:bold; font-size:10px; padding:5px 10px; cursor:pointer;" onclick="Core.dailyCheckIn()">CLAIM +100</button>
                </div>
            </div>
        </div>

        <!-- HISTORY -->
        <div id="tab-history" class="tab-content">
            <h2 style="font-family:var(--font-head);">HISTORY</h2>
            <div id="hist-list"></div>
        </div>
    </div>

    <!-- NAV -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="Core.tab('home')"><i class="fas fa-home"></i>HOME</div>
        <div class="nav-item" onclick="Core.tab('earn')"><i class="fas fa-bolt"></i>EARN</div>
        <div class="nav-item" onclick="Core.tab('history')"><i class="fas fa-clock"></i>HISTORY</div>
    </div>

    <!-- 4. ADMIN PANEL 10X (OVERLAY) -->
    <div id="admin-panel" class="admin-modal">
        <div class="adm-header">
            <span style="font-weight:bold; color:var(--danger);">ADMIN CONSOLE v2.0</span>
            <i class="fas fa-times" onclick="Admin.close()" style="font-size:20px; cursor:pointer;"></i>
        </div>
        
        <div class="adm-tabs">
            <div class="adm-tab active" onclick="Admin.tab('dash', this)">DASHBOARD</div>
            <div class="adm-tab" onclick="Admin.tab('users', this)">USERS</div>
            <div class="adm-tab" onclick="Admin.tab('codes', this)">CODES</div>
            <div class="adm-tab" onclick="Admin.tab('broadcast', this)">BROADCAST</div>
        </div>

        <!-- Adm: Dashboard -->
        <div id="adm-view-dash" class="adm-content">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="adm-card">
                    <div class="adm-stat" id="adm-total-users">...</div>
                    <div class="adm-label">Total Users</div>
                </div>
                <div class="adm-card">
                    <div class="adm-stat" id="adm-total-score" style="font-size:18px;">...</div>
                    <div class="adm-label">Total Points</div>
                </div>
            </div>
            <div class="adm-card">
                <div style="font-size:12px; color:var(--success);">SYSTEM STATUS: ONLINE</div>
                <div style="font-size:10px; color:#666; margin-top:5px;">Database: Firestore Connected</div>
            </div>
        </div>

        <!-- Adm: Users -->
        <div id="adm-view-users" class="adm-content hidden">
            <input type="text" id="adm-search" placeholder="Search ID..." class="code-input" style="font-size:14px; text-align:left;" onchange="Admin.searchUser()">
            <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                <span style="font-size:12px; color:#888;">Top 50 Recent</span>
                <i class="fas fa-sync" onclick="Admin.loadUsers()" style="color:var(--primary); cursor:pointer;"></i>
            </div>
            <div id="adm-user-list"></div>
        </div>

        <!-- Adm: Codes -->
        <div id="adm-view-codes" class="adm-content hidden">
            <div class="adm-card">
                <h4 style="margin:0 0 10px 0;">CREATE NEW CODE</h4>
                <input type="text" id="new-code-str" placeholder="Code (e.g. VIP100)" class="code-input" style="font-size:14px; margin-bottom:5px;">
                <div style="display:flex; gap:5px;">
                    <input type="number" id="new-code-val" placeholder="Value" class="code-input" style="font-size:14px;">
                    <input type="number" id="new-code-lim" placeholder="Limit" class="code-input" style="font-size:14px;">
                </div>
                <button class="btn-base btn-primary" style="margin-top:10px; padding:10px;" onclick="Admin.createCode()">CREATE CODE</button>
            </div>
            <div style="font-size:12px; color:#888; margin:15px 0 5px 0;">ACTIVE CODES</div>
            <div id="adm-code-list"></div>
        </div>

        <!-- Adm: Broadcast -->
        <div id="adm-view-broadcast" class="adm-content hidden">
            <div class="adm-card">
                <h4 style="margin:0 0 10px 0;">GLOBAL ALERT</h4>
                <textarea id="bc-msg" class="code-input" style="height:80px; text-align:left; text-transform:none;" placeholder="Message to all users..."></textarea>
                <button class="btn-base btn-danger" style="margin-top:10px;" onclick="Admin.sendBroadcast()">SEND ALERT</button>
            </div>
        </div>
    </div>

    <!-- JS MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, orderBy, limit, getDocs, serverTimestamp, deleteDoc, where, runTransaction, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        /* --- FIREBASE CONFIG --- */
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", // Thay bằng config thật nếu cần
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };
        
        // ADMIN CONFIG
        const ADMIN_IDS = [5387725104]; // Thêm ID của bạn vào đây

        // INIT
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        tg.expand();

        /* --- GLOBAL STATE --- */
        let currentUser = null;
        let userData = {};

        /* --- CORE APP LOGIC --- */
        window.Core = {
            init: async () => {
                // Check TG App User
                if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    currentUser = tg.initDataUnsafe.user;
                    Core.login();
                } else {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                }
            },

            login: async () => {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('loader').classList.remove('hidden');

                // Setup Admin
                if(ADMIN_IDS.includes(currentUser.id)) {
                    document.getElementById('admin-btn').classList.remove('hidden');
                }

                try {
                    const ref = doc(db, "users", currentUser.id.toString());
                    const snap = await getDoc(ref);

                    if(snap.exists()) {
                        userData = snap.data();
                        if(userData.banned) {
                            alert("BANNED");
                            return; // Stop here
                        }
                    } else {
                        // Create New
                        userData = {
                            id: currentUser.id,
                            first_name: currentUser.first_name,
                            username: currentUser.username || "",
                            score: 0,
                            joinedAt: serverTimestamp(),
                            photo_url: currentUser.photo_url || ""
                        };
                        await setDoc(ref, userData);
                    }
                    
                    Core.renderUI();
                    Core.listenBroadcast();
                    
                } catch(e) { console.error(e); alert("Connection Error"); }
                
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
            },

            renderUI: () => {
                document.getElementById('u-name').innerText = userData.first_name;
                document.getElementById('u-id').innerText = userData.id;
                document.getElementById('u-score').innerText = userData.score.toLocaleString();
                if(userData.photo_url) document.getElementById('u-avatar').innerHTML = `<img src="${userData.photo_url}">`;
                
                Core.loadHistory();
            },

            updateScore: async (amount, reason) => {
                const newScore = (userData.score || 0) + amount;
                userData.score = newScore;
                
                // Optimistic Update UI
                document.getElementById('u-score').innerText = newScore.toLocaleString();
                
                // DB Update
                const userRef = doc(db, "users", currentUser.id.toString());
                await updateDoc(userRef, { score: newScore });
                
                // Add History
                await addDoc(collection(db, "users", currentUser.id.toString(), "history"), {
                    title: reason, amount: amount, type: amount > 0 ? 'plus':'minus', createdAt: serverTimestamp()
                });
                
                Core.loadHistory();
            },

            loadHistory: async () => {
                const q = query(collection(db, "users", currentUser.id.toString(), "history"), orderBy('createdAt', 'desc'), limit(10));
                const snaps = await getDocs(q);
                let html = '';
                snaps.forEach(d => {
                    const data = d.data();
                    html += `<div class="hist-item">
                        <div>${data.title}</div>
                        <div class="${data.type === 'plus' ? 'plus':'minus'}">${data.type==='plus'?'+':''}${data.amount}</div>
                    </div>`;
                });
                document.getElementById('hist-list').innerHTML = html || '<div style="text-align:center;color:#444;margin-top:20px;">No records</div>';
            },

            tab: (name) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('tab-'+name).classList.add('active');
                event.currentTarget.classList.add('active');
            },

            /* --- USER FEATURES --- */
            redeemCode: async () => {
                const input = document.getElementById('daily-code');
                const codeStr = input.value.trim().toUpperCase();
                if(!codeStr) return;

                // 1. Check if Code Exists in DB
                const q = query(collection(db, "codes"), where("code", "==", codeStr));
                const snaps = await getDocs(q);

                if(snaps.empty) {
                    tg.showAlert("Invalid Code!");
                    return;
                }

                const codeDoc = snaps.docs[0];
                const codeData = codeDoc.data();
                const codeId = codeDoc.id;

                // 2. Check Limits
                if(codeData.used >= codeData.limit) {
                    tg.showAlert("Code limit reached!");
                    return;
                }

                // 3. Check if User already used (Subcollection)
                const usedRef = doc(db, "users", currentUser.id.toString(), "redeemed", codeId);
                const usedSnap = await getDoc(usedRef);
                if(usedSnap.exists()) {
                    tg.showAlert("You already used this code!");
                    return;
                }

                // 4. Execute Transaction
                try {
                    await runTransaction(db, async (transaction) => {
                        const freshCodeDoc = await transaction.get(codeDoc.ref);
                        if(freshCodeDoc.data().used >= freshCodeDoc.data().limit) throw "Limit reached during tx";
                        
                        // Increment Code Usage
                        transaction.update(codeDoc.ref, { used: freshCodeDoc.data().used + 1 });
                        // Add to User Redeemed
                        transaction.set(usedRef, { at: serverTimestamp() });
                        // Add Score to User
                        const uRef = doc(db, "users", currentUser.id.toString());
                        const uDoc = await transaction.get(uRef);
                        const newS = (uDoc.data().score || 0) + codeData.value;
                        transaction.update(uRef, { score: newS });
                        
                        // Add History
                        const hRef = doc(collection(db, "users", currentUser.id.toString(), "history"));
                        transaction.set(hRef, { title: "Code: "+codeStr, amount: codeData.value, type: 'plus', createdAt: serverTimestamp() });
                    });

                    // Success UI
                    userData.score += codeData.value;
                    document.getElementById('u-score').innerText = userData.score.toLocaleString();
                    tg.showAlert(`Success! +${codeData.value} Points`);
                    input.value = "";
                    Core.loadHistory();

                } catch(e) {
                    console.error(e);
                    tg.showAlert("Failed to redeem. Try again.");
                }
            },

            dailyCheckIn: async () => {
                const today = new Date().toDateString();
                const last = localStorage.getItem('last_checkin_'+currentUser.id);
                if(last === today) { tg.showAlert("Come back tomorrow!"); return; }
                
                await Core.updateScore(100, "Daily Check-in");
                localStorage.setItem('last_checkin_'+currentUser.id, today);
                tg.showAlert("Checked in!");
            },

            listenBroadcast: () => {
                onSnapshot(doc(db, "system", "broadcast"), (doc) => {
                    if(doc.exists()) {
                        const data = doc.data();
                        const lastMsgId = localStorage.getItem('last_bc_id');
                        if(data.id !== lastMsgId && data.message) {
                            tg.showPopup({ title: "SYSTEM ALERT", message: data.message });
                            localStorage.setItem('last_bc_id', data.id);
                        }
                    }
                });
            }
        };

        /* --- WEB LOGIN CALLBACK --- */
        window.onTelegramAuth = (user) => {
            currentUser = {
                id: user.id,
                first_name: user.first_name,
                username: user.username,
                photo_url: user.photo_url
            };
            Core.login();
        };

        /* --- ADMIN 10X LOGIC --- */
        window.Admin = {
            open: () => document.getElementById('admin-panel').classList.add('open'),
            close: () => document.getElementById('admin-panel').classList.remove('open'),
            
            tab: (tName, el) => {
                document.querySelectorAll('.adm-tab').forEach(e=>e.classList.remove('active'));
                el.classList.add('active');
                document.querySelectorAll('.adm-content').forEach(e=>e.classList.add('hidden'));
                document.getElementById('adm-view-'+tName).classList.remove('hidden');
                
                if(tName === 'dash') Admin.loadDash();
                if(tName === 'users') Admin.loadUsers();
                if(tName === 'codes') Admin.loadCodes();
            },

            loadDash: async () => {
                // Approximate stats (Real apps should use aggregation queries or cloud functions)
                const q = query(collection(db, "users"));
                const snap = await getDocs(q);
                let totalS = 0;
                snap.forEach(d => totalS += (d.data().score || 0));
                
                document.getElementById('adm-total-users').innerText = snap.size;
                document.getElementById('adm-total-score').innerText = totalS.toLocaleString();
            },

            loadUsers: async () => {
                const list = document.getElementById('adm-user-list');
                list.innerHTML = 'Loading...';
                
                const q = query(collection(db, "users"), orderBy("score", "desc"), limit(50));
                const snap = await getDocs(q);
                
                let html = '';
                snap.forEach(d => {
                    const u = d.data();
                    html += `
                    <div class="user-row">
                        <div class="user-row-info">
                            <div style="font-weight:bold; color:${u.banned?'red':'#fff'}">${u.first_name} ${u.banned?'(BANNED)':''}</div>
                            <div style="color:#666;">ID: ${u.id} | Score: ${u.score}</div>
                        </div>
                        <div class="user-row-actions">
                            <button class="btn-primary" onclick="Admin.modUser('${u.id}', 1000)">+1K</button>
                            <button style="background:${u.banned?'green':'red'}" onclick="Admin.banUser('${u.id}', ${!u.banned})">
                                ${u.banned?'UNBAN':'BAN'}
                            </button>
                        </div>
                    </div>`;
                });
                list.innerHTML = html;
            },

            modUser: async (uid, amount) => {
                if(!confirm(`Add ${amount} points to ${uid}?`)) return;
                const ref = doc(db, "users", uid);
                await updateDoc(ref, { score: (await getDoc(ref)).data().score + amount });
                alert("Done"); Admin.loadUsers();
            },

            banUser: async (uid, status) => {
                if(!confirm(`${status ? 'Ban' : 'Unban'} user ${uid}?`)) return;
                await updateDoc(doc(db, "users", uid), { banned: status });
                alert("Done"); Admin.loadUsers();
            },

            /* CODE MANAGEMENT */
            loadCodes: async () => {
                const list = document.getElementById('adm-code-list');
                list.innerHTML = 'Loading...';
                const q = query(collection(db, "codes"), orderBy("created", "desc"));
                const snap = await getDocs(q);
                let html = '';
                snap.forEach(d => {
                    const c = d.data();
                    html += `
                    <div class="code-list-item">
                        <div>
                            <div style="font-weight:bold; color:var(--primary)">${c.code}</div>
                            <div style="font-size:10px; color:#888;">Val: ${c.value} | Used: ${c.used}/${c.limit}</div>
                        </div>
                        <button style="background:#333; color:red; border:none; padding:5px;" onclick="Admin.delCode('${d.id}')">DEL</button>
                    </div>`;
                });
                list.innerHTML = html;
            },

            createCode: async () => {
                const str = document.getElementById('new-code-str').value.trim().toUpperCase();
                const val = parseInt(document.getElementById('new-code-val').value);
                const lim = parseInt(document.getElementById('new-code-lim').value);
                
                if(!str || !val || !lim) return alert("Fill all fields");
                
                await addDoc(collection(db, "codes"), {
                    code: str, value: val, limit: lim, used: 0, created: serverTimestamp()
                });
                
                document.getElementById('new-code-str').value = "";
                Admin.loadCodes();
            },

            delCode: async (id) => {
                if(confirm("Delete this code?")) {
                    await deleteDoc(doc(db, "codes", id));
                    Admin.loadCodes();
                }
            },

            sendBroadcast: async () => {
                const msg = document.getElementById('bc-msg').value;
                if(!msg) return;
                await setDoc(doc(db, "system", "broadcast"), {
                    message: msg, id: Date.now().toString()
                });
                alert("Broadcast sent!");
            }
        };

        // Initialize
        Core.init();
    </script>
</body>
</html>
