<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Account Analyzer Pro</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- TonConnect UI SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #1c1c1e;
            --tg-theme-text-color: #ffffff;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --accent: #00ff88;
            --danger: #ff4757;
            --card-bg: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--tg-theme-bg-color, #1c1c1e);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
        }

        /* Card Style */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            position: relative;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 3px solid var(--accent);
            object-fit: cover;
        }

        h2 { margin: 10px 0 5px; font-size: 20px; }
        .sub-text { font-size: 13px; opacity: 0.6; margin-bottom: 15px; }

        /* Score Display */
        .score-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border: 1px dashed var(--accent);
        }
        .score-val { font-size: 32px; font-weight: bold; color: var(--accent); }

        /* Buttons */
        .btn {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: #fff;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-verify { background-color: var(--accent); color: #000; }
        .btn-copy { background-color: #333; margin-top: 5px; font-size: 14px; }

        /* Ton Connect Centering */
        #ton-connect-btn { display: flex; justify-content: center; margin: 15px 0; }

        /* Referral Section */
        .ref-box {
            text-align: left;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .ref-link {
            word-break: break-all;
            font-family: monospace;
            color: var(--accent);
            font-size: 12px;
        }

        /* Loading & Hidden */
        .hidden { display: none !important; }
        #full-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .matrix-text { color: var(--accent); font-family: monospace; font-size: 12px; margin-top: 10px; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Full Screen Loader -->
    <div id="full-loader">
        <div class="spinner"></div>
        <div class="matrix-text" id="loader-msg">Connecting...</div>
    </div>

    <!-- M√†n h√¨nh 1: Ch√†o m·ª´ng (D√†nh cho user m·ªõi ch∆∞a c√≥ data) -->
    <div class="card hidden" id="welcome-screen">
        <img id="intro-avatar" class="avatar" src="">
        <h2 id="intro-name">Xin ch√†o</h2>
        <p class="sub-text">H·ªá th·ªëng s·∫Ω ph√¢n t√≠ch t√†i kho·∫£n c·ªßa b·∫°n ƒë·ªÉ t√≠nh ƒëi·ªÉm.</p>
        <button class="btn" onclick="analyzeAndRegister()">B·∫Øt ƒë·∫ßu ph√¢n t√≠ch</button>
    </div>

    <!-- M√†n h√¨nh 2: Dashboard (D√†nh cho user ƒë√£ c√≥ data) -->
    <div class="card hidden" id="dashboard-screen">
        <img id="dash-avatar" class="avatar" src="">
        <h2 id="dash-name">User</h2>
        <p class="sub-text" id="dash-id">ID: ---</p>

        <!-- ƒêi·ªÉm s·ªë -->
        <div class="score-container">
            <div>T·ªïng ƒëi·ªÉm t√≠ch l≈©y</div>
            <div class="score-val" id="user-score">0</div>
            <div style="font-size: 11px; margin-top: 5px; color: #aaa;">ƒê√£ x√°c minh: <span id="verify-status" style="color: red;">CH∆ØA</span></div>
        </div>

        <!-- K·∫øt n·ªëi v√≠ -->
        <div id="ton-connect-btn"></div>

        <!-- N√∫t x√°c minh chuy·ªÉn ti·ªÅn -->
        <div id="verify-section" class="hidden">
            <p style="font-size: 13px; color: #ccc;">Chuy·ªÉn <b>1 TON</b> ƒë·ªÉ x√°c minh t√†i kho·∫£n th·∫≠t.</p>
            <button class="btn btn-verify" onclick="sendTransaction()">üî• X√°c minh ngay (1 TON)</button>
        </div>

        <!-- Khu v·ª±c m·ªùi b·∫°n b√® -->
        <div style="margin-top: 25px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
            <h3 style="font-size: 16px; margin: 0 0 10px 0;">ü§ù M·ªùi b·∫°n b√® (+50 ƒëi·ªÉm)</h3>
            <p style="font-size: 12px; color: #aaa;">Nh·∫≠n 50 ƒëi·ªÉm cho c·∫£ b·∫°n v√† ng∆∞·ªùi ƒë∆∞·ª£c m·ªùi.</p>
            <div class="ref-box">
                <div class="ref-link" id="ref-link-text">Loading...</div>
            </div>
            <button class="btn btn-copy" onclick="copyReferral()">Sao ch√©p Link m·ªùi</button>
        </div>
    </div>

    <!-- Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 2. CONFIG TELEGRAM & TON
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // ƒê·ªãa ch·ªâ nh·∫≠n ti·ªÅn x√°c minh
        const ADMIN_WALLET = "UQDu8vyZSZbAYvRRQ_jW4_0EiBGibAGq72wSZjYWRmNAGhRD";

        // Kh·ªüi t·∫°o TON Connect UI
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json', // D√πng t·∫°m manifest demo, n√™n thay b·∫±ng c·ªßa b·∫°n
            buttonRootId: 'ton-connect-btn'
        });

        // 3. MAIN LOGIC
        const user = tg.initDataUnsafe.user;
        const startParam = tg.initDataUnsafe.start_param; // L·∫•y m√£ m·ªùi t·ª´ link (ref_12345)

        // C√°c Element DOM
        const loader = document.getElementById('full-loader');
        const loaderMsg = document.getElementById('loader-msg');
        const welcomeScreen = document.getElementById('welcome-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const verifySection = document.getElementById('verify-section');

        // H√†m ch·∫°y khi m·ªü App
        async function initApp() {
            if (!user) {
                loaderMsg.innerText = "Please open in Telegram";
                return;
            }

            // Ki·ªÉm tra xem user ƒë√£ t·ªìn t·∫°i trong DB ch∆∞a
            const userRef = doc(db, "users", user.id.toString());
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                // User C≈® -> V√†o th·∫≥ng Dashboard
                loadDashboard(userSnap.data());
            } else {
                // User M·ªöI -> Hi·ªán m√†n h√¨nh ch√†o m·ª´ng ƒë·ªÉ ph√¢n t√≠ch
                setupWelcomeScreen();
                loader.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
            }
        }

        // Setup m√†n h√¨nh ch√†o m·ª´ng
        function setupWelcomeScreen() {
            document.getElementById('intro-name').innerText = user.first_name;
            if(user.photo_url) document.getElementById('intro-avatar').src = user.photo_url;
        }

        // Logic ph√¢n t√≠ch v√† ƒëƒÉng k√Ω user m·ªõi (C√≥ x·ª≠ l√Ω Referral)
        window.analyzeAndRegister = async () => {
            welcomeScreen.classList.add('hidden');
            loader.classList.remove('hidden');
            loaderMsg.innerText = "Analyzing Matrix Data...";

            // Delay gi·∫£ l·∫≠p hi·ªáu ·ª©ng
            await new Promise(r => setTimeout(r, 1500));

            let baseScore = calculateBaseScore(user);
            let referrerId = null;

            // X·ª≠ l√Ω m√£ m·ªùi (Ref)
            if (startParam && startParam.startsWith('ref_')) {
                const refId = startParam.split('_')[1];
                if (refId && refId != user.id) {
                    referrerId = refId;
                    baseScore += 50; // C·ªông ƒëi·ªÉm cho ng∆∞·ªùi m·ªõi v√¨ ƒë∆∞·ª£c m·ªùi
                }
            }

            try {
                // S·ª≠ d·ª•ng Transaction ƒë·ªÉ ƒë·∫£m b·∫£o c·ªông ƒëi·ªÉm cho ng∆∞·ªùi m·ªùi an to√†n
                await runTransaction(db, async (transaction) => {
                    // 1. T·∫°o user m·ªõi
                    const newUserRef = doc(db, "users", user.id.toString());
                    transaction.set(newUserRef, {
                        id: user.id,
                        username: user.username || "",
                        firstName: user.first_name,
                        score: baseScore,
                        isVerified: false,
                        wallet: "",
                        referredBy: referrerId,
                        createdAt: serverTimestamp()
                    });

                    // 2. N·∫øu c√≥ ng∆∞·ªùi m·ªùi, c·ªông ƒëi·ªÉm cho ng∆∞·ªùi m·ªùi
                    if (referrerId) {
                        const inviterRef = doc(db, "users", referrerId);
                        const inviterSnap = await transaction.get(inviterRef);
                        if (inviterSnap.exists()) {
                            transaction.update(inviterRef, {
                                score: increment(50),
                                referralCount: increment(1)
                            });
                        }
                    }
                });

                // Load Dashboard sau khi xong
                const updatedUserSnap = await getDoc(doc(db, "users", user.id.toString()));
                loadDashboard(updatedUserSnap.data());

            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi: " + e.message);
                console.error(e);
            }
        };

        // H√†m t√≠nh ƒëi·ªÉm c∆° b·∫£n
        function calculateBaseScore(u) {
            let score = 500;
            const idFactor = 7000000000 - u.id;
            if (idFactor > 0) score += Math.floor(idFactor / 10000000); // Tu·ªïi th·ªç
            if (u.is_premium) score += 2000; // Premium
            return score;
        }

        // Hi·ªÉn th·ªã Dashboard
        function loadDashboard(userData) {
            loader.classList.add('hidden');
            welcomeScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');

            // Fill info
            document.getElementById('dash-name').innerText = userData.firstName;
            document.getElementById('dash-id').innerText = `ID: ${userData.id}`;
            if(user.photo_url) document.getElementById('dash-avatar').src = user.photo_url;
            document.getElementById('user-score').innerText = userData.score.toLocaleString();

            // Link m·ªùi: https://t.me/YOUR_BOT_NAME/APP_NAME?startapp=ref_USERID
            // L∆∞u √Ω: C·∫ßn thay BOT_NAME v√† APP_NAME b·∫±ng t√™n th·∫≠t c·ªßa b·∫°n
            // Code n√†y l·∫•y dynamic link t·ª´ Telegram WebApp n·∫øu c√≥, ho·∫∑c hi·ªÉn th·ªã placeholder
            const botUsername = "YOUR_BOT_USERNAME"; // <-- THAY T√äN BOT C·ª¶A B·∫†N V√ÄO ƒê√ÇY (VD: MyScoreBot)
            const appName = "app"; // T√™n short name c·ªßa Web App
            const refLink = `https://t.me/${botUsername}/${appName}?startapp=ref_${user.id}`;
            document.getElementById('ref-link-text').innerText = refLink;

            // Tr·∫°ng th√°i Verify
            const statusEl = document.getElementById('verify-status');
            if (userData.isVerified) {
                statusEl.innerText = "ƒê√É X√ÅC MINH";
                statusEl.style.color = "#00ff88";
                verifySection.classList.add('hidden');
            } else {
                statusEl.innerText = "CH∆ØA X√ÅC MINH";
                statusEl.style.color = "#ff4757";
            }
        }

        // X·ª≠ l√Ω s·ª± ki·ªán v√≠ TON
        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet && user) {
                // ƒê√£ k·∫øt n·ªëi v√≠ -> Hi·ªán n√∫t Verify n·∫øu ch∆∞a verify
                const userRef = doc(db, "users", user.id.toString());
                const snap = await getDoc(userRef);
                if(snap.exists() && !snap.data().isVerified) {
                    verifySection.classList.remove('hidden');
                }
                
                // L∆∞u ƒë·ªãa ch·ªâ v√≠ v√†o DB
                await updateDoc(userRef, {
                    wallet: wallet.account.address
                });
            } else {
                verifySection.classList.add('hidden');
            }
        });

        // H√ÄM G·ª¨I TI·ªÄN X√ÅC MINH (1 TON)
        window.sendTransaction = async () => {
            if (!tonConnectUI.connected) {
                alert("Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!");
                return;
            }

            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 360, // 6 ph√∫t
                messages: [
                    {
                        address: ADMIN_WALLET,
                        amount: "1000000000", // 1 TON = 10^9 nanoton
                        payload: "" // C√≥ th·ªÉ th√™m comment text m√£ h√≥a base64 ·ªü ƒë√¢y n·∫øu c·∫ßn
                    }
                ]
            };

            try {
                loader.classList.remove('hidden');
                loaderMsg.innerText = "Waiting for transaction...";
                
                const result = await tonConnectUI.sendTransaction(transaction);

                // Giao d·ªãch th√†nh c√¥ng (·ªü ph√≠a client)
                loaderMsg.innerText = "Verifying...";
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i Verified l√™n Firebase
                // L∆∞u √Ω: Trong th·ª±c t·∫ø b·∫°n n√™n d√πng Backend ƒë·ªÉ check hash giao d·ªãch tr√™n blockchain
                // ƒê√¢y l√† client-side only n√™n ta t·∫°m ch·∫•p nh·∫≠n k·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ v√≠.
                await updateDoc(doc(db, "users", user.id.toString()), {
                    isVerified: true,
                    score: increment(1000) // Th∆∞·ªüng th√™m 1000 ƒëi·ªÉm khi verify
                });

                alert("X√°c minh th√†nh c√¥ng! B·∫°n nh·∫≠n th√™m 1000 ƒëi·ªÉm.");
                window.location.reload(); // Reload l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t UI

            } catch (e) {
                loader.classList.add('hidden');
                console.error(e);
                alert("Giao d·ªãch b·ªã h·ªßy ho·∫∑c l·ªói.");
            }
        };

        // H√†m copy link m·ªùi
        window.copyReferral = () => {
            const text = document.getElementById('ref-link-text').innerText;
            if(text.includes("YOUR_BOT_USERNAME")) {
                alert("B·∫°n c·∫ßn s·ª≠a code thay t√™n Bot Username v√†o tr∆∞·ªõc!");
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                alert("ƒê√£ sao ch√©p link m·ªùi!");
            });
        };

        // B·∫Øt ƒë·∫ßu ch·∫°y
        initApp();

    </script>
</body>
</html>
