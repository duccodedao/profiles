<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Super App V3</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: radial-gradient(circle at top, #1a1a2e, #16213e, #0f3460);
            --card-bg: rgba(22, 33, 62, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --neon-blue: #00f2ff;
            --neon-purple: #bd00ff;
            --text-main: #ffffff;
            --text-sub: #8a8d91;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            padding: 20px 20px 100px 20px;
            max-width: 480px;
            margin: 0 auto;
        }

        /* 1. Header Info */
        .header-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .user-block { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 50px; height: 50px; border-radius: 12px; border: 2px solid var(--neon-blue); box-shadow: 0 0 10px rgba(0, 242, 255, 0.3); }
        .user-name { font-weight: 700; font-size: 16px; font-family: 'Rajdhani', sans-serif; }
        .user-id { font-size: 12px; color: var(--text-sub); }
        .balance-block { text-align: right; }
        .balance-val { font-size: 24px; font-weight: 800; color: var(--neon-blue); text-shadow: 0 0 10px rgba(0,242,255,0.4); font-family: 'Rajdhani', sans-serif; }
        .balance-lbl { font-size: 10px; color: var(--text-sub); text-transform: uppercase; }

        /* 2. Mining Section */
        .mining-card {
            background: var(--card-bg);
            border: var(--glass-border);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        .mining-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .mining-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .mining-timer { font-family: monospace; color: var(--neon-purple); font-weight: bold; }
        
        .progress-track {
            height: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            box-shadow: 0 0 10px var(--neon-blue);
            transition: width 1s linear;
        }

        .btn-action {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
        }
        
        .btn-start { background: rgba(0, 242, 255, 0.15); color: var(--neon-blue); border: 1px solid var(--neon-blue); }
        .btn-claim { background: linear-gradient(90deg, #00f2ff, #0099ff); color: #000; box-shadow: 0 0 20px rgba(0,242,255,0.4); animation: pulse 1.5s infinite; }
        .btn-disabled { background: rgba(255,255,255,0.05); color: #555; pointer-events: none; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* 3. Wheel Section */
        .wheel-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 20px auto;
        }
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid var(--neon-purple);
            background: conic-gradient(
                #16213e 0deg 60deg,
                #0f3460 60deg 120deg,
                #16213e 120deg 180deg,
                #0f3460 180deg 240deg,
                #16213e 240deg 300deg,
                #0f3460 300deg 360deg
            );
            position: relative;
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-shadow: 0 0 30px rgba(189, 0, 255, 0.2);
        }
        .wheel::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            background: #fff; border-radius: 50%;
            z-index: 2; border: 4px solid var(--neon-purple);
        }
        .marker {
            position: absolute; top: -10px; left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid var(--neon-blue);
            z-index: 5;
            filter: drop-shadow(0 0 5px var(--neon-blue));
        }
        
        .wheel-item {
            position: absolute;
            top: 50%; left: 50%;
            transform-origin: 0 0;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 5px #000;
        }

        /* 4. Task List */
        .task-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.03); border-radius: 12px;
            padding: 12px 15px; margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .task-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
        .reward-pill { font-size: 11px; color: var(--neon-blue); background: rgba(0, 242, 255, 0.1); padding: 2px 6px; border-radius: 4px; }

        /* Nav Bar */
        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 400px;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px);
            border-radius: 50px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; padding: 10px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 100;
        }
        .nav-item { color: #666; font-size: 20px; padding: 10px; border-radius: 50%; transition: 0.3s; position: relative; }
        .nav-item.active { color: #fff; background: var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue); transform: translateY(-5px); }
        .nav-item.active i { color: #000; }

        /* Views */
        .view { display: none; animation: fadeUp 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header-card">
            <div class="user-block">
                <img id="u-avatar" src="https://via.placeholder.com/50" class="avatar">
                <div>
                    <div class="user-name" id="u-name">...</div>
                    <div class="user-id" id="u-id">ID: ...</div>
                </div>
            </div>
            <div class="balance-block">
                <div class="balance-lbl">Points</div>
                <div class="balance-val" id="u-balance">0</div>
            </div>
        </div>

        <!-- VIEW: HOME (Mining) -->
        <div id="view-home" class="view active">
            <!-- Thẻ Khai thác -->
            <div class="mining-card">
                <div class="mining-header">
                    <div class="mining-title"><i class="fas fa-hammer"></i> Cloud Mining</div>
                    <div class="mining-timer" id="mining-timer">00:00:00</div>
                </div>
                <div class="progress-track">
                    <div class="progress-bar" id="mining-bar"></div>
                </div>
                <p style="font-size: 12px; color: var(--text-sub); margin-bottom: 15px; text-align: center;">
                    Tốc độ: <span style="color:white">50 Points/giờ</span>
                </p>
                <button id="mining-btn" class="btn-action btn-start" onclick="handleMining()">Start Mining</button>
            </div>

            <!-- Check Analysis (Feature cũ nhưng làm đẹp lại) -->
             <div class="mining-card" style="padding: 15px;">
                <div class="mining-title" style="margin-bottom: 10px;"><i class="fas fa-microchip"></i> Account Scan</div>
                <p style="font-size: 12px; color: #aaa; margin-bottom: 10px;">Quét dữ liệu hoạt động để nhận điểm thưởng một lần.</p>
                <button class="btn-action" style="background:#2a2a3e; color:white; font-size:12px; padding:10px" onclick="analyzeAccount()">Quét Ngay</button>
            </div>
        </div>

        <!-- VIEW: GAME (Lucky Wheel) -->
        <div id="view-game" class="view">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">VÒNG QUAY</h2>
                <p style="margin: 5px 0; font-size: 12px; color: #aaa;">Thử vận may mỗi ngày</p>
            </div>
            
            <div class="wheel-container">
                <div class="marker"></div>
                <div class="wheel" id="wheel">
                    <!-- Text items được add bằng JS -->
                </div>
            </div>
            
            <button id="spin-btn" class="btn-action btn-claim" style="margin-top: 20px;" onclick="spinWheel()">QUAY (Free)</button>
        </div>

        <!-- VIEW: TASKS -->
        <div id="view-tasks" class="view">
            <h3 style="margin-bottom: 15px;">Nhiệm vụ</h3>
            
            <div class="task-row">
                <div style="display:flex; align-items:center">
                    <div class="task-icon"><i class="fab fa-telegram"></i></div>
                    <div>
                        <div style="font-weight:600; font-size:14px">Join Channel</div>
                        <div class="reward-pill">+200</div>
                    </div>
                </div>
                <button class="btn-action" style="width:auto; padding: 6px 12px; font-size:12px" onclick="doTask(this, 200)">Go</button>
            </div>

            <div class="task-row">
                <div style="display:flex; align-items:center">
                    <div class="task-icon"><i class="fab fa-youtube"></i></div>
                    <div>
                        <div style="font-weight:600; font-size:14px">Watch Video</div>
                        <div class="reward-pill">+150</div>
                    </div>
                </div>
                <button class="btn-action" style="width:auto; padding: 6px 12px; font-size:12px" onclick="doTask(this, 150)">Go</button>
            </div>
        </div>

    </div>

    <!-- Bottom Nav -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="switchTab('game', this)"><i class="fas fa-gamepad"></i></div>
        <div class="nav-item" onclick="switchTab('tasks', this)"><i class="fas fa-clipboard-list"></i></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config Firebase cũ của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // Global State
        let currentUser = null;
        let userData = { score: 0, miningStart: null, lastSpin: null };
        const MINING_TIME = 4 * 60 * 60 * 1000; // 4 tiếng (mili giây)
        const MINING_REWARD = 200; // 200 điểm cho 4 tiếng
        
        // Wheel config
        const wheelValues = [50, 0, 500, 100, 0, 1000]; // 6 phần
        let currentRotation = 0;

        // Init
        async function init() {
            tg.expand();
            tg.setHeaderColor('#1a1a2e');
            
            currentUser = tg.initDataUnsafe.user;
            if(!currentUser) {
                // Test mode
                currentUser = { id: 99999, first_name: "Tester", username: "dev" };
            }

            // Render Info
            document.getElementById('u-name').innerText = currentUser.first_name;
            document.getElementById('u-id').innerText = "ID: " + currentUser.id;
            if(currentUser.photo_url) document.getElementById('u-avatar').src = currentUser.photo_url;

            // Load Data
            await loadData();
            
            // Start Loop UI
            setInterval(updateMiningUI, 1000);
            renderWheelItems();
        }

        async function loadData() {
            const ref = doc(db, "users", currentUser.id.toString());
            const snap = await getDoc(ref);
            
            if(snap.exists()) {
                userData = snap.data();
                // Fix lỗi nếu user cũ thiếu trường miningStart
                if(!userData.miningStart) userData.miningStart = null;
            } else {
                // User mới chưa có data, tạo doc rỗng để tránh lỗi
                await setDoc(ref, { 
                    id: currentUser.id, 
                    score: 0,
                    firstName: currentUser.first_name
                }, { merge: true });
            }
            updateBalanceUI();
            updateMiningUI();
        }

        // --- CORE FUNCTIONS ---

        function updateBalanceUI() {
            document.getElementById('u-balance').innerText = Math.floor(userData.score).toLocaleString();
        }

        // 1. MINING LOGIC
        window.handleMining = async () => {
            const btn = document.getElementById('mining-btn');
            const now = Date.now();
            const ref = doc(db, "users", currentUser.id.toString());

            // Case 1: Start Mining
            if(!userData.miningStart) {
                userData.miningStart = now;
                await updateDoc(ref, { miningStart: now });
                btn.innerText = "Mining...";
                btn.className = "btn-action btn-disabled";
                return;
            }

            // Case 2: Claim Reward
            const elapsed = now - userData.miningStart;
            if(elapsed >= MINING_TIME) {
                // Claim
                await updateDoc(ref, {
                    score: increment(MINING_REWARD),
                    miningStart: null // Reset
                });
                userData.score += MINING_REWARD;
                userData.miningStart = null;
                
                updateBalanceUI();
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Đã nhận ${MINING_REWARD} điểm!`);
                
                // Reset UI
                updateMiningUI();
            }
        };

        function updateMiningUI() {
            const btn = document.getElementById('mining-btn');
            const timerEl = document.getElementById('mining-timer');
            const barEl = document.getElementById('mining-bar');

            if (!userData.miningStart) {
                // Chưa đào
                btn.innerText = "START MINING";
                btn.className = "btn-action btn-start";
                timerEl.innerText = "00:00:00";
                barEl.style.width = "0%";
                return;
            }

            const now = Date.now();
            const elapsed = now - userData.miningStart;
            
            if (elapsed >= MINING_TIME) {
                // Đã xong -> Hiện nút Claim
                btn.innerText = "CLAIM REWARD";
                btn.className = "btn-action btn-claim";
                timerEl.innerText = "DONE!";
                barEl.style.width = "100%";
            } else {
                // Đang chạy
                btn.innerText = "MINING...";
                btn.className = "btn-action btn-disabled";
                
                // Tính %
                const percent = (elapsed / MINING_TIME) * 100;
                barEl.style.width = `${percent}%`;

                // Tính giờ còn lại
                const remain = MINING_TIME - elapsed;
                const h = Math.floor(remain / (1000 * 60 * 60));
                const m = Math.floor((remain % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((remain % (1000 * 60)) / 1000);
                timerEl.innerText = `${h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            }
        }

        // 2. LUCKY WHEEL LOGIC
        function renderWheelItems() {
            const wheel = document.getElementById('wheel');
            wheelValues.forEach((val, i) => {
                const el = document.createElement('div');
                el.className = 'wheel-item';
                // Xoay text vào giữa múi (60 độ mỗi múi, offset 30 độ)
                el.style.transform = `rotate(${i * 60 + 30}deg) translateY(-80px)`;
                el.innerText = val > 0 ? val : "MISS";
                wheel.appendChild(el);
            });
        }

        window.spinWheel = async () => {
            const btn = document.getElementById('spin-btn');
            if(btn.disabled) return;
            
            // Check cooldown (giả sử mỗi ngày 1 lần)
            const today = new Date().toDateString();
            if(userData.lastSpin === today) {
                tg.showAlert("Hôm nay bạn đã quay rồi. Quay lại vào ngày mai!");
                return;
            }

            btn.disabled = true;
            
            // Random kết quả (0-5)
            const resultIndex = Math.floor(Math.random() * 6); 
            // Góc quay thêm: 
            // 6 múi, mỗi múi 60 độ.
            // Kết quả rơi vào múi index, cần xoay sao cho múi đó nằm trên cùng (0 độ - marker).
            // Công thức: Xoay ngược chiều kim đồng hồ.
            const segmentAngle = 60;
            const randomOffset = Math.floor(Math.random() * 40) - 20; // Random một chút trong múi
            const rotateAngle = 360 * 5 + (360 - (resultIndex * segmentAngle)) + randomOffset; 
            
            currentRotation += rotateAngle;
            
            const wheel = document.getElementById('wheel');
            wheel.style.transform = `rotate(${currentRotation}deg)`;
            
            // Đợi quay xong (4s)
            setTimeout(async () => {
                const points = wheelValues[resultIndex];
                
                if(points > 0) {
                    const ref = doc(db, "users", currentUser.id.toString());
                    await updateDoc(ref, {
                        score: increment(points),
                        lastSpin: today
                    });
                    userData.score += points;
                    userData.lastSpin = today;
                    updateBalanceUI();
                    
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert(`Chúc mừng! Bạn nhận được ${points} điểm!`);
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.showAlert("Tiếc quá! Chúc may mắn lần sau.");
                    // Vẫn update lastSpin để chặn quay tiếp
                    const ref = doc(db, "users", currentUser.id.toString());
                    await updateDoc(ref, { lastSpin: today });
                    userData.lastSpin = today;
                }
                
                btn.disabled = false;
                btn.innerText = "Mai quay tiếp nhé";
                
            }, 4000);
        };

        // 3. SCAN LOGIC (Từ bản cũ, giữ lại để user có điểm khởi đầu)
        window.analyzeAccount = async () => {
            if(userData.score > 0) {
                 tg.showAlert("Bạn đã nhận điểm phân tích rồi!");
                 return;
            }
            // Logic đơn giản
            let pts = 1000 + (currentUser.is_premium ? 2000 : 0);
            const ref = doc(db, "users", currentUser.id.toString());
            await updateDoc(ref, { score: increment(pts) });
            userData.score += pts;
            updateBalanceUI();
            tg.showAlert(`Đã nhận ${pts} điểm từ hồ sơ của bạn!`);
        }

        // 4. TASK LOGIC
        window.doTask = async (btn, reward) => {
             // Fake delay
             btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
             await new Promise(r => setTimeout(r, 2000));
             
             const ref = doc(db, "users", currentUser.id.toString());
             await updateDoc(ref, { score: increment(reward) });
             userData.score += reward;
             updateBalanceUI();
             
             btn.innerText = "Done";
             btn.disabled = true;
             btn.style.background = "#2ecc71";
        }

        // UI Switcher
        window.switchTab = (name, el) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + name).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            tg.HapticFeedback.selectionChanged();
        };

        // Run
        init();

    </script>
</body>
</html>
