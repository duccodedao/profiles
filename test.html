<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio & Admin Hub | Profile D1214</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .hide { display: none !important; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- NAVIGATION -->
    <nav class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="router.navigate('home')">
                    <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">DevPortfolio</span>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btn-home" onclick="router.navigate('home')" class="text-slate-600 hover:text-blue-600 font-medium hidden">Trang chủ</button>
                    <button id="btn-admin" onclick="router.navigate('admin')" class="text-slate-600 hover:text-blue-600 font-medium hidden">Admin Panel</button>
                    <div id="auth-section">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main id="app" class="min-h-screen">
        <!-- Views will be injected here -->
    </main>

    <!-- MODAL: PROJECT EDITOR -->
    <div id="project-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 class="text-xl font-bold text-slate-800" id="modal-title">Thêm Dự Án Mới</h2>
                <button onclick="ui.closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="p-id">
                
                <!-- Image Upload -->
                <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition-colors relative" id="drop-zone">
                    <input type="file" id="p-image" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*">
                    <div id="preview-container" class="hidden">
                        <img id="img-preview" src="" class="mx-auto h-48 object-cover rounded-md shadow-sm">
                        <button type="button" onclick="ui.clearImage()" class="mt-2 text-red-500 text-sm font-medium">Xóa ảnh</button>
                    </div>
                    <div id="upload-placeholder" class="text-slate-500">
                        <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto mb-2 text-blue-500"></i>
                        <p>Kéo thả hoặc click để tải ảnh banner</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Tên Dự Án</label>
                        <input type="text" id="p-name" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Danh Mục</label>
                        <select id="p-category" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="Web App">Web App</option>
                            <option value="Mobile App">Mobile App</option>
                            <option value="Landing Page">Landing Page</option>
                            <option value="UI/UX Design">UI/UX Design</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Mô Tả Chi Tiết</label>
                    <textarea id="p-desc" rows="3" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="p-demo" placeholder="Link Demo URL" class="w-full border rounded-lg px-3 py-2">
                    <input type="text" id="p-github" placeholder="GitHub URL" class="w-full border rounded-lg px-3 py-2">
                </div>

                <!-- Guide -->
                <div>
                     <label class="block text-sm font-medium text-slate-700 mb-1">Hướng dẫn sử dụng (Guide)</label>
                     <textarea id="p-guide" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="Nhập hướng dẫn ngắn gọn..."></textarea>
                </div>

                <!-- Dynamic FAQ -->
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-slate-700">Câu Hỏi Thường Gặp (FAQ)</label>
                        <button type="button" onclick="ui.addFaqField()" class="text-sm text-blue-600 hover:underline">+ Thêm câu hỏi</button>
                    </div>
                    <div id="faq-list" class="space-y-3">
                        <!-- Dynamic Fields Here -->
                    </div>
                </div>

                <div class="flex items-center gap-4 pt-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="p-featured" class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm">Nổi bật (Featured)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="p-visible" class="w-4 h-4 text-blue-600 rounded" checked>
                        <span class="text-sm">Hiển thị công khai</span>
                    </label>
                </div>
            </div>
            <div class="p-6 border-t bg-slate-50 flex justify-end gap-3">
                <button onclick="ui.closeModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg">Hủy</button>
                <button onclick="dataManager.saveProject()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg shadow-md flex items-center gap-2">
                    <span id="save-btn-text">Lưu Dự Án</span>
                    <div id="save-loader" class="loader w-4 h-4 border-white border-t-transparent hidden"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ================= CONFIGURATION =================
        const firebaseConfig = {
            // ⚠️ THAY THẾ BẰNG CONFIG CỦA BẠN TỪ FIREBASE CONSOLE
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    
        };

        const MASTER_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();

        // ================= STATE MANAGEMENT =================
        const state = {
            user: null,
            role: 'guest', // guest, user, sub-admin, admin
            projects: [],
            categories: [], // Extracted from projects or settings
            profile: {},
            socials: []
        };

        // ================= UI HELPERS =================
        const ui = {
            toast: (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-slate-800';
                toast.className = `${colors} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transition-all transform translate-x-full opacity-0`;
                toast.innerHTML = `<span>${message}</span>`;
                container.appendChild(toast);
                
                // Animate in
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                });

                // Remove after 3s
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-[-20px]');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            renderIcons: () => {
                lucide.createIcons();
            },

            toggleLoading: (btnId, isLoading) => {
                const btn = document.getElementById(btnId);
                if(!btn) return;
                // Simple opacity toggle for demo
                btn.style.opacity = isLoading ? '0.7' : '1';
                btn.disabled = isLoading;
            },

            // Modal Logic
            openModal: (mode = 'add', project = null) => {
                document.getElementById('project-modal').classList.remove('hidden');
                document.getElementById('modal-title').innerText = mode === 'add' ? 'Thêm Dự Án Mới' : 'Cập Nhật Dự Án';
                
                // Reset Form
                document.getElementById('p-id').value = project ? project.id : '';
                document.getElementById('p-name').value = project ? project.name : '';
                document.getElementById('p-category').value = project ? project.category : 'Web App';
                document.getElementById('p-desc').value = project ? project.description : '';
                document.getElementById('p-demo').value = project ? project.demoLink : '';
                document.getElementById('p-github').value = project ? project.githubLink : '';
                document.getElementById('p-guide').value = project ? project.guide : '';
                document.getElementById('p-featured').checked = project ? project.isFeatured : false;
                document.getElementById('p-visible').checked = project ? project.isVisible : true;

                // Handle Image Preview
                if (project && project.imageUrl) {
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('upload-placeholder').classList.add('hidden');
                    document.getElementById('img-preview').src = project.imageUrl;
                } else {
                    ui.clearImage();
                }

                // Handle FAQs
                document.getElementById('faq-list').innerHTML = '';
                if (project && project.faqs) {
                    project.faqs.forEach(faq => ui.addFaqField(faq.q, faq.a));
                } else {
                    ui.addFaqField(); // Add one empty field by default
                }
            },

            closeModal: () => {
                document.getElementById('project-modal').classList.add('hidden');
            },

            clearImage: () => {
                document.getElementById('p-image').value = '';
                document.getElementById('preview-container').classList.add('hidden');
                document.getElementById('upload-placeholder').classList.remove('hidden');
                document.getElementById('img-preview').src = '';
            },

            addFaqField: (q = '', a = '') => {
                const container = document.getElementById('faq-list');
                const div = document.createElement('div');
                div.className = "flex gap-2 items-start bg-slate-50 p-2 rounded border";
                div.innerHTML = `
                    <div class="flex-1 space-y-2">
                        <input type="text" class="w-full text-sm border rounded px-2 py-1 faq-q" placeholder="Câu hỏi" value="${q}">
                        <textarea class="w-full text-sm border rounded px-2 py-1 faq-a" placeholder="Câu trả lời">${a}</textarea>
                    </div>
                    <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                `;
                container.appendChild(div);
                ui.renderIcons();
            }
        };

        // Make ui global for HTML access
        window.ui = ui;

        // ================= ROUTER & VIEWS =================
        const router = {
            currentView: 'home',
            
            navigate: (viewId, param = null) => {
                router.currentView = viewId;
                const app = document.getElementById('app');
                
                // Hide Navbar Buttons Logic
                const btnHome = document.getElementById('btn-home');
                const btnAdmin = document.getElementById('btn-admin');
                
                if (viewId === 'home') {
                    app.innerHTML = views.home();
                    btnHome.classList.add('hidden');
                    if (['admin', 'sub-admin'].includes(state.role)) btnAdmin.classList.remove('hidden');
                } else if (viewId === 'admin') {
                    if (!['admin', 'sub-admin'].includes(state.role)) {
                        ui.toast('Bạn không có quyền truy cập!', 'error');
                        return router.navigate('home');
                    }
                    app.innerHTML = views.admin();
                    btnHome.classList.remove('hidden');
                    btnAdmin.classList.add('hidden');
                    // Re-attach listeners for admin after render
                    adminLogic.init(); 
                } else if (viewId === 'detail') {
                    const project = state.projects.find(p => p.id === param);
                    if (project) {
                        app.innerHTML = views.detail(project);
                        btnHome.classList.remove('hidden');
                    }
                }
                
                window.scrollTo(0, 0);
                ui.renderIcons();
            }
        };
        window.router = router;

        const views = {
            home: () => {
                const featured = state.projects.filter(p => p.isVisible && p.isFeatured);
                const allVisible = state.projects.filter(p => p.isVisible);
                const categories = [...new Set(allVisible.map(p => p.category))];

                return `
                <!-- HERO SECTION -->
                <section class="bg-white py-20 px-4 text-center border-b">
                    <div class="max-w-4xl mx-auto">
                        <h1 class="text-4xl md:text-6xl font-extrabold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-violet-600">
                            ${state.profile.name || 'Xin chào, tôi là Developer'}
                        </h1>
                        <p class="text-xl text-slate-600 mb-8 max-w-2xl mx-auto">${state.profile.bio || 'Chuyên xây dựng các giải pháp web hiện đại và hiệu quả.'}</p>
                        <button onclick="document.getElementById('projects-grid').scrollIntoView({behavior: 'smooth'})" class="bg-blue-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-blue-700 transition shadow-lg hover:shadow-xl">
                            Khám phá Dự án
                        </button>
                    </div>
                </section>

                <!-- FILTERS -->
                <div class="max-w-7xl mx-auto px-4 mt-12 mb-8">
                    <div class="flex flex-wrap gap-2 justify-center" id="filter-container">
                        <button onclick="filters.apply('all')" class="filter-btn active px-4 py-2 rounded-full text-sm font-medium bg-blue-600 text-white shadow-sm">Tất cả</button>
                        ${categories.map(c => `
                            <button onclick="filters.apply('${c}')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium bg-white text-slate-600 border hover:bg-slate-50 shadow-sm">${c}</button>
                        `).join('')}
                    </div>
                </div>

                <!-- PROJECTS GRID -->
                <section id="projects-grid" class="max-w-7xl mx-auto px-4 pb-20 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    ${allVisible.map(p => `
                        <div class="group bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 project-card" data-category="${p.category}">
                            <div class="relative h-56 overflow-hidden cursor-pointer" onclick="router.navigate('detail', '${p.id}')">
                                <img src="${p.imageUrl || 'https://via.placeholder.com/400x300?text=No+Image'}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                ${p.isFeatured ? '<span class="absolute top-3 right-3 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full shadow-md">Featured</span>' : ''}
                                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                    <span class="bg-white/90 text-slate-800 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-sm">Xem chi tiết</span>
                                </div>
                            </div>
                            <div class="p-6">
                                <span class="text-xs font-semibold text-blue-600 uppercase tracking-wider">${p.category}</span>
                                <h3 class="text-xl font-bold mt-2 mb-2 text-slate-800 group-hover:text-blue-600 transition-colors">${p.name}</h3>
                                <p class="text-slate-500 text-sm line-clamp-2 mb-4">${p.description}</p>
                                <div class="flex items-center justify-between border-t pt-4">
                                    <div class="flex gap-3">
                                        ${p.githubLink ? `<a href="${p.githubLink}" target="_blank" class="text-slate-400 hover:text-slate-800"><i data-lucide="github" class="w-5 h-5"></i></a>` : ''}
                                        ${p.demoLink ? `<a href="${p.demoLink}" target="_blank" class="text-slate-400 hover:text-blue-600"><i data-lucide="external-link" class="w-5 h-5"></i></a>` : ''}
                                    </div>
                                    <button onclick="router.navigate('detail', '${p.id}')" class="text-sm font-medium text-blue-600 hover:underline">Xem thêm &rarr;</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </section>

                <!-- FOOTER -->
                <footer class="bg-slate-900 text-white py-12 text-center">
                    <div class="flex justify-center gap-6 mb-6">
                        ${state.socials.map(s => `
                            <a href="${s.url}" target="_blank" class="p-3 bg-white/10 rounded-full hover:bg-white/20 transition"><i data-lucide="${s.icon || 'link'}" class="w-5 h-5"></i></a>
                        `).join('')}
                    </div>
                    <p class="text-slate-400">© 2024 DevPortfolio. Built with Firebase.</p>
                </footer>
                `;
            },

            detail: (p) => {
                return `
                <div class="animate-fade-in pb-20">
                    <!-- Banner -->
                    <div class="w-full h-[50vh] relative">
                        <img src="${p.imageUrl || 'https://via.placeholder.com/1200x600'}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 to-transparent flex items-end">
                            <div class="max-w-7xl mx-auto px-4 w-full pb-12">
                                <span class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-semibold mb-3 inline-block">${p.category}</span>
                                <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">${p.name}</h1>
                                <div class="flex gap-4">
                                    ${p.demoLink ? `<a href="${p.demoLink}" target="_blank" class="bg-white text-slate-900 px-6 py-2 rounded-lg font-bold hover:bg-slate-100 flex items-center gap-2"><i data-lucide="eye"></i> Xem Demo</a>` : ''}
                                    ${p.githubLink ? `<a href="${p.githubLink}" target="_blank" class="bg-slate-700/50 backdrop-blur text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-700/70 flex items-center gap-2"><i data-lucide="github"></i> GitHub</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="max-w-4xl mx-auto px-4 mt-12 grid gap-12">
                        <!-- Content -->
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-4 border-l-4 border-blue-600 pl-4">Giới thiệu</h2>
                            <p class="text-lg text-slate-600 leading-relaxed whitespace-pre-line">${p.description}</p>
                        </div>

                        <!-- Guide -->
                        ${p.guide ? `
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                            <h2 class="text-xl font-bold text-blue-800 mb-3 flex items-center gap-2"><i data-lucide="book-open"></i> Hướng dẫn sử dụng</h2>
                            <p class="text-slate-700">${p.guide}</p>
                        </div>
                        ` : ''}

                        <!-- FAQ Accordion -->
                        ${p.faqs && p.faqs.length > 0 ? `
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Câu hỏi thường gặp</h2>
                            <div class="space-y-4">
                                ${p.faqs.map((faq, idx) => `
                                    <div class="border rounded-lg overflow-hidden">
                                        <button onclick="document.getElementById('faq-${idx}').classList.toggle('hidden')" class="w-full flex justify-between items-center p-4 bg-slate-50 hover:bg-slate-100 text-left font-semibold text-slate-700">
                                            <span>${faq.q}</span>
                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                        </button>
                                        <div id="faq-${idx}" class="hidden p-4 bg-white text-slate-600 border-t">
                                            ${faq.a}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;
            },

            admin: () => {
                const totalViews = state.projects.reduce((acc, p) => acc + (p.views || 0), 0);
                return `
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <!-- Dashboard Header -->
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-slate-800">Admin Dashboard</h1>
                        <p class="text-slate-500">Xin chào, ${state.user.email} (${state.role.toUpperCase()})</p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <p class="text-sm text-slate-500">Tổng Dự Án</p>
                            <h3 class="text-3xl font-bold text-slate-800">${state.projects.length}</h3>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <p class="text-sm text-slate-500">Dự Án Hiển Thị</p>
                            <h3 class="text-3xl font-bold text-blue-600">${state.projects.filter(p => p.isVisible).length}</h3>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <p class="text-sm text-slate-500">Danh Mục</p>
                            <h3 class="text-3xl font-bold text-indigo-600">${new Set(state.projects.map(p => p.category)).size}</h3>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <p class="text-sm text-slate-500">Lượt Truy Cập</p>
                            <h3 class="text-3xl font-bold text-green-600">${totalViews}</h3> <!-- Demo metric -->
                        </div>
                    </div>

                    <!-- TABS -->
                    <div class="border-b mb-6">
                        <nav class="flex gap-6" id="admin-tabs">
                            <button onclick="adminLogic.switchTab('projects')" class="tab-btn active text-blue-600 border-b-2 border-blue-600 pb-2 font-medium">Quản Lý Dự Án</button>
                            <button onclick="adminLogic.switchTab('profile')" class="tab-btn text-slate-500 pb-2 font-medium hover:text-slate-700">Thông Tin Profile</button>
                            ${state.role === 'admin' ? `<button onclick="adminLogic.switchTab('users')" class="tab-btn text-slate-500 pb-2 font-medium hover:text-slate-700">Quản Lý Users</button>` : ''}
                        </nav>
                    </div>

                    <!-- TAB CONTENT: PROJECTS -->
                    <div id="tab-projects" class="admin-tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-slate-800">Danh Sách Dự Án</h2>
                            <button onclick="ui.openModal('add')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i> Thêm mới</button>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-slate-500 text-sm">
                                    <tr>
                                        <th class="p-4">Tên Dự Án</th>
                                        <th class="p-4">Category</th>
                                        <th class="p-4">Trạng Thái</th>
                                        <th class="p-4">Nổi Bật</th>
                                        <th class="p-4 text-right">Hành Động</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${state.projects.map(p => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="p-4 font-medium">${p.name}</td>
                                            <td class="p-4"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">${p.category}</span></td>
                                            <td class="p-4">
                                                <button onclick="dataManager.toggleProject('${p.id}', 'isVisible', ${!p.isVisible})" class="${p.isVisible ? 'text-green-600 bg-green-50' : 'text-slate-400 bg-slate-100'} px-2 py-1 rounded text-xs font-bold">
                                                    ${p.isVisible ? 'HIỆN' : 'ẨN'}
                                                </button>
                                            </td>
                                            <td class="p-4">
                                                <button onclick="dataManager.toggleProject('${p.id}', 'isFeatured', ${!p.isFeatured})" class="${p.isFeatured ? 'text-yellow-600 bg-yellow-50' : 'text-slate-400 bg-slate-100'} px-2 py-1 rounded text-xs font-bold">
                                                    ${p.isFeatured ? '★ YES' : 'NO'}
                                                </button>
                                            </td>
                                            <td class="p-4 text-right flex justify-end gap-2">
                                                <button onclick='ui.openModal("edit", ${JSON.stringify(p).replace(/'/g, "&apos;")})' class="p-2 text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                                ${state.role === 'admin' ? `<button onclick="dataManager.deleteProject('${p.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash" class="w-4 h-4"></i></button>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB CONTENT: PROFILE (Simplified) -->
                    <div id="tab-profile" class="admin-tab-content hidden">
                        <div class="bg-white rounded-xl shadow-sm border p-6 max-w-2xl">
                             <h2 class="text-xl font-bold mb-4">Cập nhật Profile</h2>
                             <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Tên hiển thị</label>
                                    <input type="text" id="prof-name" value="${state.profile.name || ''}" class="w-full border rounded px-3 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Bio (Slogan)</label>
                                    <textarea id="prof-bio" class="w-full border rounded px-3 py-2" rows="3">${state.profile.bio || ''}</textarea>
                                </div>
                                <button onclick="dataManager.saveProfile()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Lưu thông tin</button>
                             </div>
                        </div>
                    </div>
                    
                    <!-- TAB CONTENT: USERS (Admin Only) -->
                    <div id="tab-users" class="admin-tab-content hidden">
                         <div class="bg-white rounded-xl shadow-sm border p-6">
                            <p class="text-slate-500 mb-4">Quản lý người dùng (Tính năng dành riêng cho Master Admin)</p>
                            <!-- List users logic would fetch from 'users' collection here -->
                            <div id="user-list-placeholder" class="text-sm text-slate-400 italic">Đang tải danh sách user...</div>
                         </div>
                    </div>
                </div>
                `;
            }
        };

        // ================= BUSINESS LOGIC (CLIENT FILTER) =================
        window.filters = {
            apply: (category) => {
                const btns = document.querySelectorAll('.filter-btn');
                btns.forEach(b => {
                    if (b.innerText === category || (category === 'all' && b.innerText === 'Tất cả')) {
                        b.classList.remove('bg-white', 'text-slate-600', 'border');
                        b.classList.add('bg-blue-600', 'text-white');
                    } else {
                        b.classList.add('bg-white', 'text-slate-600', 'border');
                        b.classList.remove('bg-blue-600', 'text-white');
                    }
                });

                const cards = document.querySelectorAll('.project-card');
                cards.forEach(card => {
                    if (category === 'all' || card.dataset.category === category) {
                        card.classList.remove('hide');
                    } else {
                        card.classList.add('hide');
                    }
                });
            }
        };

        // ================= ADMIN LOGIC HELPERS =================
        window.adminLogic = {
            init: () => {
                ui.renderIcons();
                if (state.role === 'admin') adminLogic.loadUsers();
            },
            switchTab: (tabName) => {
                document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    b.classList.add('text-slate-500');
                });
                // Highlight active tab logic simplified for demo
                event.target.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                event.target.classList.remove('text-slate-500');
            },
            loadUsers: async () => {
                // Real implementation would utilize onSnapshot on 'users' collection
                const q = query(collection(db, "users"), orderBy("joinedAt", "desc"));
                const snapshot = await getDocs(q);
                const users = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                
                const html = `
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-sm"><tr><th class="p-3">Email</th><th class="p-3">Role</th><th class="p-3">Status</th><th class="p-3">Action</th></tr></thead>
                    <tbody>
                        ${users.map(u => `
                            <tr class="border-t">
                                <td class="p-3 text-sm">${u.email} <br> <span class="text-xs text-slate-400">${u.uid}</span></td>
                                <td class="p-3">
                                    ${u.uid === MASTER_UID ? '<span class="font-bold text-red-600">MASTER</span>' : 
                                    `<select onchange="dataManager.updateUserRole('${u.id}', this.value)" class="border rounded text-sm p-1">
                                        <option value="user" ${u.role === 'user' ? 'selected' : ''}>User</option>
                                        <option value="sub-admin" ${u.role === 'sub-admin' ? 'selected' : ''}>Sub-Admin</option>
                                    </select>`}
                                </td>
                                <td class="p-3 text-sm">${u.isBanned ? '<span class="text-red-500">Banned</span>' : '<span class="text-green-500">Active</span>'}</td>
                                <td class="p-3">
                                    ${u.uid !== MASTER_UID ? 
                                    `<button onclick="dataManager.toggleBan('${u.id}', ${!u.isBanned})" class="text-xs underline ${u.isBanned ? 'text-green-600' : 'text-red-600'}">${u.isBanned ? 'Unlock' : 'Lock'}</button>` 
                                    : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
                document.getElementById('user-list-placeholder').innerHTML = html;
            }
        };

        // ================= DATA MANAGER (CRUD) =================
        window.dataManager = {
            saveProject: async () => {
                const id = document.getElementById('p-id').value;
                const fileInput = document.getElementById('p-image');
                const file = fileInput.files[0];
                
                const btn = document.querySelector('button[onclick="dataManager.saveProject()"]');
                const loader = document.getElementById('save-loader');
                const btnText = document.getElementById('save-btn-text');
                
                btn.disabled = true;
                loader.classList.remove('hidden');
                btnText.innerText = 'Đang xử lý...';

                try {
                    let imageUrl = document.getElementById('img-preview').src;

                    // Upload Image if new file selected
                    if (file) {
                        ui.toast('Đang tải ảnh lên...', 'info');
                        const storageRef = ref(storage, `projects/${Date.now()}_${file.name}`);
                        await uploadBytes(storageRef, file);
                        imageUrl = await getDownloadURL(storageRef);
                    }

                    // Collect FAQ
                    const faqs = [];
                    const qInputs = document.querySelectorAll('.faq-q');
                    const aInputs = document.querySelectorAll('.faq-a');
                    qInputs.forEach((q, i) => {
                        if(q.value.trim()) faqs.push({ q: q.value, a: aInputs[i].value });
                    });

                    const projectData = {
                        name: document.getElementById('p-name').value,
                        category: document.getElementById('p-category').value,
                        description: document.getElementById('p-desc').value,
                        demoLink: document.getElementById('p-demo').value,
                        githubLink: document.getElementById('p-github').value,
                        guide: document.getElementById('p-guide').value,
                        isFeatured: document.getElementById('p-featured').checked,
                        isVisible: document.getElementById('p-visible').checked,
                        imageUrl: imageUrl,
                        faqs: faqs,
                        updatedAt: serverTimestamp()
                    };

                    if (id) {
                        await updateDoc(doc(db, "projects", id), projectData);
                        ui.toast('Cập nhật thành công!', 'success');
                    } else {
                        projectData.createdAt = serverTimestamp();
                        projectData.views = 0;
                        await addDoc(collection(db, "projects"), projectData);
                        ui.toast('Thêm dự án mới thành công!', 'success');
                    }
                    ui.closeModal();
                } catch (error) {
                    console.error(error);
                    ui.toast('Lỗi: ' + error.message, 'error');
                } finally {
                    btn.disabled = false;
                    loader.classList.add('hidden');
                    btnText.innerText = 'Lưu Dự Án';
                }
            },

            toggleProject: async (id, field, value) => {
                try {
                    await updateDoc(doc(db, "projects", id), { [field]: value });
                    ui.toast('Đã cập nhật trạng thái', 'success');
                } catch (e) { ui.toast('Lỗi cập nhật', 'error'); }
            },

            deleteProject: async (id) => {
                if(!confirm("Bạn chắc chắn muốn xóa dự án này?")) return;
                try {
                    await deleteDoc(doc(db, "projects", id));
                    ui.toast('Đã xóa dự án', 'success');
                } catch (e) { ui.toast('Lỗi xóa', 'error'); }
            },

            saveProfile: async () => {
                try {
                    await setDoc(doc(db, "content", "profile"), {
                        name: document.getElementById('prof-name').value,
                        bio: document.getElementById('prof-bio').value
                    }, { merge: true });
                    ui.toast('Đã lưu Profile', 'success');
                } catch (e) { ui.toast('Lỗi lưu Profile', 'error'); }
            },

            updateUserRole: async (uid, newRole) => {
                try {
                    await updateDoc(doc(db, "users", uid), { role: newRole });
                    ui.toast('Đã cập nhật quyền', 'success');
                    adminLogic.loadUsers(); // Refresh table
                } catch (e) { ui.toast('Lỗi cập nhật quyền', 'error'); }
            },

            toggleBan: async (uid, banStatus) => {
                try {
                    await updateDoc(doc(db, "users", uid), { isBanned: banStatus });
                    ui.toast(banStatus ? 'Đã khóa tài khoản' : 'Đã mở khóa', 'success');
                    adminLogic.loadUsers();
                } catch (e) { ui.toast('Lỗi xử lý', 'error'); }
            }
        };

        // ================= AUTH LOGIC =================
        window.authActions = {
            login: async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    ui.toast(error.message, 'error');
                }
            },
            logout: async () => {
                await signOut(auth);
                ui.toast('Đã đăng xuất', 'info');
                router.navigate('home');
            }
        };

        // ================= INITIALIZATION & LISTENERS =================
        const init = () => {
            // Auth Listener
            onAuthStateChanged(auth, async (user) => {
                const authSection = document.getElementById('auth-section');
                state.user = user;
                
                if (user) {
                    // Check DB for user role
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    let role = 'user';
                    
                    if (user.uid === MASTER_UID) {
                        role = 'admin';
                    } else if (userSnap.exists()) {
                        const userData = userSnap.data();
                        if (userData.isBanned) {
                            await signOut(auth);
                            ui.toast('Tài khoản của bạn đã bị khóa.', 'error');
                            return;
                        }
                        role = userData.role || 'user';
                    } else {
                        // First time login, create doc
                        await setDoc(userRef, {
                            email: user.email,
                            uid: user.uid,
                            photoURL: user.photoURL,
                            role: 'user',
                            joinedAt: serverTimestamp(),
                            isBanned: false
                        });
                    }
                    
                    state.role = role;
                    
                    authSection.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${user.photoURL}" class="w-8 h-8 rounded-full border border-slate-300">
                            <button onclick="authActions.logout()" class="text-sm font-medium text-slate-500 hover:text-red-600">Thoát</button>
                        </div>
                    `;
                } else {
                    state.role = 'guest';
                    authSection.innerHTML = `
                        <button onclick="authActions.login()" class="flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-full text-sm font-bold hover:bg-slate-800 transition">
                            <i data-lucide="log-in" class="w-4 h-4"></i> Login
                        </button>
                    `;
                }
                
                // Refresh View if necessary
                if (router.currentView === 'admin' && state.role === 'guest') {
                    router.navigate('home');
                } else {
                    router.navigate(router.currentView); // re-render nav buttons
                }
            });

            // Real-time Data Listeners
            onSnapshot(collection(db, "projects"), (snapshot) => {
                state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Re-render current view to reflect changes
                router.navigate(router.currentView, router.currentView === 'detail' ? state.projects.find(p=>p.id===document.getElementById('p-id')?.value)?.id : null);
            });

            onSnapshot(doc(db, "content", "profile"), (doc) => {
                if(doc.exists()) {
                    state.profile = doc.data();
                    if(router.currentView === 'home') router.navigate('home');
                }
            });
            
            // Initial render
            router.navigate('home');
        };

        // Initialize App
        init();

        // Drag and Drop Logic for Modal
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('p-image');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('upload-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-blue-50', 'border-blue-400');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-blue-50', 'border-blue-400');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-blue-50', 'border-blue-400');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        });

    </script>
</body>
</html>
