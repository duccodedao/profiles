<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Elite Journey</title>
    
    <!-- CORE SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    
    <!-- ANIMATION ENGINE (GSAP) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;800&family=Rajdhani:wght@500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --primary: #00f2ea; /* Cyan Neon */
            --primary-dim: rgba(0, 242, 234, 0.1);
            --secondary: #7000ff; /* Electric Purple */
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            
            --font-head: 'Rajdhani', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-body);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- BACKGROUND FX --- */
        .ambient-glow {
            position: fixed; top: -20%; left: -20%; width: 140%; height: 140%;
            background: radial-gradient(circle at 50% 50%, rgba(112, 0, 255, 0.15), transparent 60%);
            z-index: 0; pointer-events: none;
            animation: pulseBg 10s ease-in-out infinite alternate;
        }
        @keyframes pulseBg { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } }

        /* --- LAYOUT UTILS --- */
        .screen {
            position: fixed; inset: 0; z-index: 10;
            background: var(--bg-dark);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* --- LOADER --- */
        .loader-ring {
            width: 60px; height: 60px;
            border: 4px solid var(--glass); border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- SLIDES --- */
        .slide-container {
            position: fixed; inset: 0; z-index: 20; padding: 24px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden;
            transform: scale(0.95);
        }
        .slide-container.active {
            opacity: 1; visibility: visible; transform: scale(1);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        h1 { font-family: var(--font-head); font-size: 42px; line-height: 1; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px; text-align: center; }
        .text-gradient { background: linear-gradient(135deg, #fff 30%, var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { color: var(--text-muted); font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }

        /* --- STATS CIRCLE --- */
        .stat-ring-container { position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; margin: 20px 0; }
        .stat-ring-bg { position: absolute; inset: 0; border-radius: 50%; border: 2px solid var(--glass); }
        .stat-ring-active {
            position: absolute; inset: -2px; border-radius: 50%;
            border: 2px solid transparent; border-top-color: var(--primary); border-right-color: var(--secondary);
            animation: spin 3s linear infinite; box-shadow: 0 0 20px rgba(0, 242, 234, 0.3);
        }
        .stat-value { font-family: var(--font-head); font-size: 48px; font-weight: 700; color: #fff; z-index: 2; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        
        /* --- INPUT --- */
        .input-group { width: 100%; max-width: 320px; position: relative; margin-top: 20px; }
        .verify-input {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--primary);
            color: var(--primary); font-family: var(--font-code); font-size: 24px;
            padding: 16px; text-align: center; border-radius: 12px; letter-spacing: 8px;
            outline: none; box-shadow: 0 0 15px var(--primary-dim);
            transition: 0.3s; text-transform: uppercase;
        }
        .verify-input:focus { box-shadow: 0 0 30px rgba(0, 242, 234, 0.3); }

        /* --- DASHBOARD --- */
        .dashboard-layout {
            display: grid; grid-template-rows: auto 1fr auto;
            height: 100%; width: 100%; padding: 60px 20px 40px 20px;
            gap: 20px; align-items: start;
        }
        
        .profile-strip { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px; }
        .user-pill {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.08); padding: 8px 16px 8px 8px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .avatar-placeholder { width: 32px; height: 32px; background: linear-gradient(45deg, var(--secondary), var(--primary)); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; }

        .balance-card {
            width: 100%; border-radius: 24px; padding: 30px; text-align: center;
            position: relative; overflow: hidden;
            background: linear-gradient(180deg, rgba(20, 20, 20, 0.8) 0%, rgba(10, 10, 10, 0.95) 100%);
        }
        .balance-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }
        .balance-val { font-family: var(--font-head); font-size: 64px; font-weight: 700; line-height: 1.1; margin: 10px 0; background: linear-gradient(to bottom, #fff, #aaddff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* --- WITHDRAW BUTTON (HERO) --- */
        .withdraw-container { width: 100%; margin-top: auto; }
        .btn-withdraw {
            position: relative; width: 100%; padding: 20px;
            border: none; border-radius: 16px;
            background: linear-gradient(90deg, #1a1a1a, #2a2a2a);
            color: #888; font-family: var(--font-body); font-weight: 700; font-size: 16px;
            overflow: hidden; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);
        }
        
        /* Active State for Button when eligible (future) */
        .btn-withdraw.active {
            background: var(--primary); color: #000;
            box-shadow: 0 0 30px var(--primary-dim);
        }
        
        .shimmer-fx::after {
            content: ""; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: skewX(-20deg); animation: shimmer 3s infinite;
        }
        @keyframes shimmer { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }

        /* --- FOOTER NAV --- */
        .nav-footer { position: fixed; bottom: 40px; left: 20px; right: 20px; z-index: 100; }
        .btn-main {
            width: 100%; padding: 18px; border-radius: 14px; border: none;
            background: #fff; color: #000; font-family: var(--font-body); font-weight: 800; font-size: 16px; letter-spacing: 0.5px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .btn-main:active { transform: scale(0.97); }

        /* BANNED SCREEN */
        .glitch-text { position: relative; color: #ff3b30; font-family: var(--font-code); font-size: 24px; font-weight: bold; }

    </style>
</head>
<body>

    <!-- BACKGROUND -->
    <div class="ambient-glow"></div>

    <!-- SCREEN 0: LOADING -->
    <div id="loader" class="screen">
        <div class="loader-ring"></div>
        <div style="margin-top: 20px; font-family: var(--font-code); font-size: 12px; letter-spacing: 3px; color: var(--text-muted);">SYSTEM INIT</div>
    </div>

    <!-- SCREEN: BANNED -->
    <div id="banned-screen" class="screen hidden" style="background: #000; z-index: 9999;">
        <i class="fas fa-ban" style="font-size: 50px; color: #ff3b30; margin-bottom: 20px;"></i>
        <div class="glitch-text">ACCESS DENIED</div>
        <p style="color: #666; margin-top: 10px; font-size: 12px;">Multi-account activity detected.</p>
    </div>

    <!-- APP WRAPPER -->
    <div id="app-wrapper" class="hidden">
        
        <!-- SLIDE 1: INTRO -->
        <div class="slide-container active" id="slide-1">
            <i class="fab fa-telegram fa-4x" style="color: #fff; margin-bottom: 30px; text-shadow: 0 0 30px var(--primary);"></i>
            <h1 class="text-gradient">TG ELITE</h1>
            <p class="subtitle">Analyzing Digital Footprint</p>
        </div>

        <!-- SLIDE 2: YEARS -->
        <div class="slide-container" id="slide-2">
            <p class="subtitle" style="color: var(--primary);">LEGACY METRIC</p>
            <h1>CREATION YEAR</h1>
            <div class="stat-ring-container">
                <div class="stat-ring-bg"></div>
                <div class="stat-ring-active"></div>
                <div class="stat-value" id="val-year">0000</div>
            </div>
            <div style="background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-top: 10px;">
                +<span id="score-age">0</span> XP
            </div>
        </div>

        <!-- SLIDE 3: PREMIUM -->
        <div class="slide-container" id="slide-3">
            <p class="subtitle" style="color: var(--secondary);">STATUS CHECK</p>
            <h1>PREMIUM</h1>
            <div style="height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-star" id="icon-premium" style="font-size: 80px; color: #333; transition: 0.5s;"></i>
            </div>
            <div style="font-family: var(--font-code); font-size: 24px; margin-top: 20px;">
                +<span id="score-premium">0</span> XP
            </div>
        </div>

        <!-- SLIDE 4: VERIFY -->
        <div class="slide-container" id="slide-4">
            <div class="glass-panel" style="padding: 40px 20px; border-radius: 24px; width: 100%; max-width: 350px; text-align: center;">
                <i class="fas fa-fingerprint" style="font-size: 40px; color: var(--primary); margin-bottom: 20px;"></i>
                <h2 style="font-family: var(--font-head); margin: 0;">HUMAN VERIFY</h2>
                <p style="color: #888; font-size: 13px; margin: 10px 0 25px 0;">Enter the security code below</p>
                
                <div style="font-family: var(--font-code); font-size: 32px; letter-spacing: 5px; color: #fff; margin-bottom: 10px; text-shadow: 0 0 10px white;" id="captcha-display">LOADING</div>
                
                <input type="text" class="verify-input" id="captcha-input" maxlength="6" placeholder="CODE" autocomplete="off">
                
                <button onclick="verifyCode()" style="margin-top: 25px; width: 100%; background: #fff; border: none; padding: 15px; border-radius: 12px; font-weight: 800;">VERIFY IDENTITY</button>
            </div>
        </div>

        <!-- SLIDE 5: DASHBOARD (MAIN) -->
        <div class="slide-container dashboard-layout" id="dashboard-view" style="padding: 60px 20px 20px 20px;">
            
            <!-- Header -->
            <div class="profile-strip">
                <div class="user-pill glass-panel">
                    <div class="avatar-placeholder"><i class="fas fa-user"></i></div>
                    <div style="font-size: 13px; font-weight: 600;" id="username-disp">User</div>
                </div>
                <div style="font-family: var(--font-code); color: #666; font-size: 12px;">ID: <span id="uid-disp">...</span></div>
            </div>

            <!-- Balance -->
            <div class="balance-card glass-panel">
                <div style="color: #888; font-size: 12px; letter-spacing: 1px; text-transform: uppercase;">Total Allocation</div>
                <div class="balance-val" id="final-balance">0</div>
                <div style="color: var(--primary); font-size: 14px; font-weight: 700; background: rgba(0, 242, 234, 0.1); display: inline-block; padding: 4px 12px; border-radius: 8px;">$TGE TOKEN</div>
            </div>

            <!-- Action Area -->
            <div class="withdraw-container">
                <div class="glass-panel" style="padding: 20px; border-radius: 20px; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 15px; text-align: center;">WALLET CONNECTION</div>
                    <div id="ton-connect-btn" style="display: flex; justify-content: center;"></div>
                </div>

                <button class="btn-withdraw shimmer-fx" onclick="handleWithdraw()">
                    <i class="fas fa-vault"></i> WITHDRAW TO WALLET
                </button>
                <div style="text-align: center; margin-top: 15px; font-size: 11px; color: #555;">
                    <i class="fas fa-lock"></i> Liquidity locked until TGE Event
                </div>
            </div>

        </div>

        <!-- FOOTER NAV (Next Button) -->
        <div class="nav-footer" id="nav-footer">
            <button class="btn-main" id="btn-next" onclick="nextSlide()">START SCAN</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE INIT
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        let db;
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e){ console.error(e); }

        // TON CONNECT UI - Custom Style
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn',
            uiPreferences: {
                theme: 'DARK',
                borderRadius: 'm',
                colorsSet: {
                    connectButton: { background: '#ffffff', foreground: '#000000' }
                }
            }
        });

        // TG APP
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#050505');
        tg.setBackgroundColor('#050505');

        // STATE
        let currentUser = tg.initDataUnsafe.user;
        // currentUser = {id: 12345, first_name: "Demo", is_premium: true}; // Debug
        let deviceId = "unk-" + Math.random();
        let currentSlide = 1;
        let score = 0;
        let generatedCode = "";
        let isLoaded = false;

        // ANIMATIONS (GSAP)
        const animateNumber = (target, val) => {
            gsap.to(target, { innerText: val, duration: 1.5, snap: { innerText: 1 }, ease: "power2.out" });
        };

        // --- CORE LOGIC ---
        async function init() {
            if(!currentUser) {
                document.body.innerHTML = "<div class='screen' style='color:#fff'>Please open in Telegram</div>";
                return;
            }
            
            document.getElementById('uid-disp').innerText = currentUser.id;
            document.getElementById('username-disp').innerText = currentUser.first_name;

            // Failsafe timer
            setTimeout(() => { if(!isLoaded) startApp(true); }, 5000);

            // Get Fingerprint
            try {
                const fp = await FingerprintJS.load();
                const res = await fp.get();
                deviceId = res.visitorId;
            } catch(e) {}

            // Security Check
            await checkUserStatus();
        }

        async function checkUserStatus() {
            if(!db) { startApp(true); return; }
            try {
                const userRef = doc(db, "users", currentUser.id.toString());
                const userSnap = await getDoc(userRef);

                if(userSnap.exists() && userSnap.data().isBanned) {
                    showBanned(); return;
                }

                // Check Multi-account
                if(!deviceId.startsWith("unk")) {
                    const q = query(collection(db, "users"), where("deviceId", "==", deviceId));
                    const snaps = await getDocs(q);
                    let dupe = false;
                    snaps.forEach(d => { if(d.id != currentUser.id) dupe = true; });
                    
                    if(dupe) {
                        await setDoc(userRef, { isBanned: true, reason: "Multi", deviceId }, { merge: true });
                        showBanned(); return;
                    }
                }

                // Save Device
                if(!userSnap.exists() || !userSnap.data().deviceId) {
                    await setDoc(userRef, { deviceId }, { merge: true });
                }

                calcScore();
                
                if(userSnap.exists() && userSnap.data().isAnalyzed) {
                    score = userSnap.data().score || score;
                    startDashboard();
                } else {
                    startStory();
                }

            } catch(e) { startApp(true); }
        }

        function startApp(force) {
            if(isLoaded) return;
            calcScore();
            startStory();
        }

        function calcScore() {
            let year = 2024;
            if (currentUser.id < 500000000) year = 2016;
            else if (currentUser.id < 1200000000) year = 2019;
            else if (currentUser.id < 5500000000) year = 2022;

            let agePts = Math.floor((7000000000 - currentUser.id) / 250000);
            if(agePts < 100) agePts = 100;
            if(agePts > 15000) agePts = 15000;

            let premPts = currentUser.is_premium ? 5000 : 0;
            score = agePts + premPts + 500;

            document.getElementById('val-year').innerText = year;
            document.getElementById('score-age').innerText = agePts;
            document.getElementById('score-premium').innerText = premPts;

            if(currentUser.is_premium) {
                const star = document.getElementById('icon-premium');
                star.style.color = "#FFD700";
                star.style.filter = "drop-shadow(0 0 20px gold)";
            }
        }

        function showBanned() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('banned-screen').classList.remove('hidden');
            isLoaded = true;
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
        }

        function startStory() {
            isLoaded = true;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            generateCaptcha();
        }

        function startDashboard() {
            isLoaded = true;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            
            // Kill slides
            document.querySelectorAll('.slide-container').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-footer').style.display = 'none';
            
            // Show Dash
            const dash = document.getElementById('dashboard-view');
            dash.classList.add('active');
            
            // GSAP Count up
            animateNumber('#final-balance', score);
        }

        // --- NAVIGATION & INTERACTION ---
        window.nextSlide = () => {
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            
            const curr = document.getElementById(`slide-${currentSlide}`);
            // GSAP Exit
            gsap.to(curr, { opacity: 0, scale: 0.9, duration: 0.3, onComplete: () => {
                curr.classList.remove('active');
                currentSlide++;
                
                if(currentSlide === 2) document.getElementById('btn-next').innerText = "NEXT STEP";
                if(currentSlide === 4) document.getElementById('nav-footer').style.display = 'none';

                const next = document.getElementById(`slide-${currentSlide}`);
                next.classList.add('active');
                // GSAP Enter
                gsap.fromTo(next, { opacity: 0, scale: 1.1 }, { opacity: 1, scale: 1, duration: 0.5 });
            }});
        };

        // --- CAPTCHA ---
        function generateCaptcha() {
            const chars = "ABCDEFHJKLMNPQRSTUVWXYZ23456789";
            generatedCode = "";
            for(let i=0; i<6; i++) generatedCode += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('captcha-display').innerText = generatedCode.split('').join(' ');
        }

        window.verifyCode = async () => {
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            const inp = document.getElementById('captcha-input');
            
            if(inp.value.toUpperCase() === generatedCode) {
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                
                // Save
                if(db) {
                    setDoc(doc(db, "users", currentUser.id.toString()), {
                        id: currentUser.id, firstName: currentUser.first_name, score: score, isAnalyzed: true, lastSeen: serverTimestamp()
                    }, { merge: true });
                }
                
                startDashboard();
            } else {
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                inp.style.borderColor = "#ff3b30";
                gsap.to(inp, { x: 10, duration: 0.1, yoyo: true, repeat: 5 });
                setTimeout(() => { inp.style.borderColor = "var(--primary)"; inp.value = ""; generateCaptcha(); }, 1000);
            }
        };

        window.handleWithdraw = () => {
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
            tg.showPopup({
                title: "Withdrawal Locked",
                message: "Tokens are currently locked. Withdrawal will open after the TGE (Token Generation Event). Connect wallet to be ready.",
                buttons: [{type: 'ok'}]
            });
        };

        // RUN
        init();

    </script>
</body>
</html>
