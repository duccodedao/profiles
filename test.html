<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Journey</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Lora:ital,wght@1,400;1,600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --ton-blue: #0098EA;
            --text-main: #ffffff;
            --text-sub: #8E8E93;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- UI COMPONENTS --- */
        #access-denied, #loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #000; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #access-denied { display: none; text-align: center; }
        .spinner {
            width: 40px; height: 40px; border: 3px solid var(--glass);
            border-top-color: var(--ton-blue); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- SLIDES --- */
        .slide {
            position: absolute; inset: 0;
            padding: 40px 20px 100px 20px; /* Padding bottom for footer */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            text-align: center; overflow-y: auto; /* Allow scroll on small screens */
        }
        .slide.active { opacity: 1; pointer-events: auto; transform: scale(1); }

        h1 { font-family: 'Lora', serif; font-size: 32px; font-weight: 600; margin: 0 0 10px 0; font-style: italic; }
        .big-number { font-size: 48px; font-weight: 800; color: var(--ton-blue); margin: 15px 0; letter-spacing: -1px; }
        .description { font-size: 15px; color: var(--text-sub); line-height: 1.5; max-width: 300px; margin: 0 auto; }
        .chapter-label { font-size: 11px; letter-spacing: 2px; color: #555; text-transform: uppercase; margin-bottom: 5px; }

        .points-badge {
            background: rgba(0, 152, 234, 0.15); color: var(--ton-blue);
            padding: 6px 14px; border-radius: 20px; font-weight: bold;
            margin-top: 15px; display: inline-block; border: 1px solid rgba(0, 152, 234, 0.3);
        }

        /* --- RANK BOX --- */
        .rank-box {
            margin-top: 20px; padding: 10px 20px; width: 100%; max-width: 280px;
            background: var(--glass); border: 1px solid var(--border);
            border-radius: 12px; text-align: center;
        }

        /* --- NEW: TOKEN & WITHDRAW SECTION --- */
        .token-section {
            width: 100%; max-width: 320px; margin-top: 25px;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }
        
        .countdown-timer {
            font-family: 'Courier New', monospace;
            color: var(--ton-blue); font-size: 14px; letter-spacing: 1px;
            margin-bottom: 15px; font-weight: bold;
            background: rgba(0, 152, 234, 0.1); padding: 5px 10px; border-radius: 4px;
            display: inline-block;
        }
        .listing-lbl { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px; }

        .grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn-feature {
            background: var(--glass); border: 1px solid var(--border);
            border-radius: 12px; padding: 12px;
            color: #777; /* Dimmed color */
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            font-size: 11px; font-weight: 600;
            cursor: not-allowed; position: relative; overflow: hidden;
            transition: 0.2s;
        }
        
        /* Lock overlay effect */
        .btn-feature::after {
            content: "\f023"; /* FontAwesome Lock */
            font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 5px; right: 8px; font-size: 10px; opacity: 0.5;
        }

        .btn-feature:active { transform: scale(0.98); }
        .btn-feature i { font-size: 18px; margin-bottom: 2px; }

        /* --- FOOTER --- */
        .bottom-action {
            position: fixed; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; z-index: 50;
            flex-direction: column; align-items: center; gap: 10px;
        }
        .btn-next {
            background: white; color: black; border: none;
            padding: 14px 40px; border-radius: 30px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 20px rgba(255,255,255,0.15);
            transition: transform 0.2s; width: 80%; max-width: 300px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-next:active { transform: scale(0.95); }
        .btn-share { background: var(--ton-blue); color: white; box-shadow: 0 5px 20px rgba(0, 152, 234, 0.4); }

        /* Animation */
        .fade-in-up { animation: fadeInUp 0.8s ease forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .delay-1 { animation-delay: 0.2s; } .delay-2 { animation-delay: 0.5s; } .delay-3 { animation-delay: 0.8s; }

    </style>
</head>
<body>

    <!-- SCREEN 1: ACCESS DENIED -->
    <div id="access-denied">
        <i class="fas fa-lock" style="font-size:40px; color:#ff3b30; margin-bottom:20px"></i>
        <div style="font-weight:bold; color:#ff3b30">MOBILE ACCESS ONLY</div>
    </div>

    <!-- SCREEN 2: LOADER -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <!-- CONTENT -->
    <div id="progress-wrap" style="position:fixed; top:0; left:0; width:100%; height:4px; background:rgba(255,255,255,0.1); z-index:100;">
        <div id="progress" style="height:100%; width:0%; background:var(--ton-blue); transition:width 0.5s;"></div>
    </div>

    <!-- SLIDE 1: INTRO -->
    <div class="slide" id="slide-1">
        <i class="fab fa-telegram fa-4x fade-in-up" style="color: white; margin-bottom: 30px;"></i>
        <h1 class="fade-in-up delay-1">The Digital Archives</h1>
        <p class="description fade-in-up delay-2">Every journey leaves a trace. Let's uncover your legacy.</p>
    </div>

    <!-- SLIDE 2: ORIGIN -->
    <div class="slide" id="slide-2">
        <div class="chapter-label fade-in-up">CHAPTER I</div>
        <h1 class="fade-in-up">The Origin</h1>
        <div class="big-number fade-in-up delay-1" id="val-year">...</div>
        <p class="description fade-in-up delay-2">You joined the network early. A true pioneer.</p>
        <div class="points-badge fade-in-up delay-3" id="score-age">+0 PTS</div>
    </div>

    <!-- SLIDE 3: ELITE -->
    <div class="slide" id="slide-3">
        <div class="chapter-label fade-in-up">CHAPTER II</div>
        <h1 class="fade-in-up">The Elite</h1>
        <div id="icon-premium" class="fade-in-up delay-1" style="font-size: 60px; margin: 20px 0;"><i class="fas fa-star" style="color:#333"></i></div>
        <p class="description fade-in-up delay-2" id="text-premium">Checking contribution tier.</p>
        <div class="points-badge fade-in-up delay-3" id="score-premium">+0 PTS</div>
    </div>

    <!-- SLIDE 4: IDENTITY -->
    <div class="slide" id="slide-4">
        <div class="chapter-label fade-in-up">CHAPTER III</div>
        <h1 class="fade-in-up">The Identity</h1>
        <img id="user-avatar" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid white; margin:20px 0;" class="fade-in-up delay-1">
        <p class="description fade-in-up delay-2">Identity Verified: <span style="color:white" id="user-username">...</span></p>
        <div class="points-badge fade-in-up delay-3" id="score-identity">+0 PTS</div>
    </div>

    <!-- SLIDE 5: DASHBOARD (FINAL) -->
    <div class="slide" id="slide-5">
        <div class="chapter-label fade-in-up">SUMMARY</div>
        <h1 class="fade-in-up" style="font-size:32px; color:var(--ton-blue)">TOTAL SCORE</h1>
        <div class="big-number fade-in-up delay-1" id="final-score" style="font-size:54px">0</div>
        
        <!-- RANK -->
        <div class="rank-box fade-in-up delay-2">
            <div style="font-size:10px; color:#888; letter-spacing:1px">GLOBAL RANK</div>
            <div id="user-rank" style="font-size:20px; font-weight:bold; margin-top:5px">CALCULATING...</div>
        </div>

        <!-- NEW: TOKEN SECTION -->
        <div class="token-section fade-in-up delay-3">
            <div class="listing-lbl">LISTING COUNTDOWN</div>
            <div id="countdown" class="countdown-timer">00d 00h 00m 00s</div>
            
            <div class="grid-actions">
                <button class="btn-feature" onclick="featureLocked()">
                    <i class="fas fa-coins"></i>
                    <span>Convert to $TG</span>
                </button>
                <button class="btn-feature" onclick="featureLocked()">
                    <i class="fas fa-wallet"></i>
                    <span>Withdraw</span>
                </button>
            </div>
        </div>
    </div>

    <!-- FOOTER BTN -->
    <div class="bottom-action">
        <button class="btn-next" id="btn-action" onclick="handleAction()">Start Journey</button>
        <div style="font-size:9px; color:#444; letter-spacing:1px">SECURED BY TON</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, query, where, getCountFromServer, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // STATE
        let currentSlide = 1;
        const totalSlides = 5;
        let userData = null;
        let scores = { total: 0 };
        let isReturning = false;

        async function init() {
            if (!tg.initData) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('access-denied').style.display = 'flex';
                document.querySelector('.bottom-action').style.display = 'none';
                return;
            }

            tg.expand();
            tg.setHeaderColor('#000000');
            userData = tg.initDataUnsafe.user;
            
            // Testing (Remove line below in Prod)
            // if(!userData) userData = { id: 9999999, first_name: "Tester", username: "dev", is_premium: true };

            if(!userData) return;

            calculateData(userData);
            startCountdown();
            await checkUser();
        }

        function calculateData(user) {
            const id = user.id;
            let year = 2024;
            // Calcs
            if(id < 100000000) year = 2015;
            else if(id < 500000000) year = 2017;
            else if(id < 1000000000) year = 2020;
            else if(id < 5000000000) year = 2022;

            let ageScore = Math.floor((7000000000 - id) / 500000); 
            if(ageScore < 100) ageScore = 100;
            
            let premiumScore = user.is_premium ? 5000 : 0;
            let identityScore = (user.username ? 500 : 0) + (user.photo_url ? 300 : 0);
            
            scores.total = ageScore + premiumScore + identityScore;

            // Render
            document.getElementById('val-year').innerText = `Year ${year}`;
            document.getElementById('score-age').innerText = `+${ageScore.toLocaleString()} PTS`;
            
            if(user.is_premium) {
                document.getElementById('icon-premium').innerHTML = '<i class="fas fa-star" style="color:#FFD700; text-shadow:0 0 15px #FFD700"></i>';
                document.getElementById('text-premium').innerText = "Premium Verified.";
                document.getElementById('score-premium').innerText = `+${premiumScore.toLocaleString()} PTS`;
            }

            if(user.photo_url) document.getElementById('user-avatar').src = user.photo_url;
            document.getElementById('user-username').innerText = user.username ? `@${user.username}` : user.first_name;
            document.getElementById('score-identity').innerText = `+${identityScore.toLocaleString()} PTS`;
        }

        async function checkUser() {
            try {
                const docRef = doc(db, "users", userData.id.toString());
                const snap = await getDoc(docRef);
                
                document.getElementById('loader').style.display = 'none';

                if(snap.exists() && snap.data().isAnalyzed) {
                    isReturning = true;
                    showDashboard();
                } else {
                    document.getElementById('slide-1').classList.add('active');
                }
            } catch(e) { console.error(e); }
        }

        window.handleAction = async () => {
            if(isReturning) { shareStory(); return; }

            if(currentSlide >= totalSlides) { shareStory(); return; }

            tg.HapticFeedback.impactOccurred('medium');
            
            document.getElementById(`slide-${currentSlide}`).classList.remove('active');
            currentSlide++;
            
            // Progress
            document.getElementById('progress').style.width = `${((currentSlide-1)/(totalSlides-1))*100}%`;
            document.getElementById(`slide-${currentSlide}`).classList.add('active');

            const btn = document.getElementById('btn-action');

            if(currentSlide === 5) {
                btn.style.display = 'none';
                await saveDB();
                animateScore();
                calculateRank();
                
                isReturning = true;
                btn.innerHTML = '<i class="fas fa-share-alt"></i> Share Story';
                btn.classList.add('btn-share');
                btn.style.display = 'flex';
                document.getElementById('progress-wrap').style.opacity = 0;
            } else {
                btn.innerText = "Continue";
            }
        }

        async function saveDB() {
            const ref = doc(db, "users", userData.id.toString());
            // Ref check
            const startParam = tg.initDataUnsafe.start_param;
            if(startParam && startParam.startsWith('ref_')) {
                const refId = startParam.split('_')[1];
                if(refId !== userData.id.toString()) {
                    updateDoc(doc(db, "users", refId), { referralCount: increment(1) }).catch(()=>{});
                }
            }
            await setDoc(ref, {
                id: userData.id,
                firstName: userData.first_name,
                username: userData.username || "",
                score: scores.total,
                isAnalyzed: true,
                isPremium: userData.is_premium || false,
                lastSeen: serverTimestamp()
            }, { merge: true });
        }

        function showDashboard() {
            document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
            document.getElementById('slide-5').classList.add('active');
            document.getElementById('progress-wrap').style.display = 'none';
            
            document.getElementById('final-score').innerText = scores.total.toLocaleString();
            calculateRank();

            const btn = document.getElementById('btn-action');
            btn.innerHTML = '<i class="fas fa-share-alt"></i> Share Story';
            btn.classList.add('btn-share');
            btn.style.display = 'flex';
        }

        // --- NEW FEATURES ---

        function startCountdown() {
            const targetDate = new Date("Dec 31, 2025 00:00:00").getTime();
            
            setInterval(() => {
                const now = new Date().getTime();
                const dist = targetDate - now;

                if (dist < 0) {
                    document.getElementById("countdown").innerHTML = "TGE LIVE NOW";
                    return;
                }

                const d = Math.floor(dist / (1000 * 60 * 60 * 24));
                const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((dist % (1000 * 60)) / 1000);

                document.getElementById("countdown").innerHTML = 
                    `${d}d ${h < 10 ? '0'+h : h}h ${m < 10 ? '0'+m : m}m ${s < 10 ? '0'+s : s}s`;
            }, 1000);
        }

        window.featureLocked = () => {
            tg.HapticFeedback.notificationOccurred('error');
            tg.showAlert("Coming Soon! Listing Date: 31/12/2025");
        };

        async function calculateRank() {
            try {
                const q = query(collection(db, "users"), where("score", ">", scores.total));
                const snap = await getCountFromServer(q);
                document.getElementById('user-rank').innerText = `#${(snap.data().count + 1).toLocaleString()}`;
            } catch(e) { 
                document.getElementById('user-rank').innerText = "TOP 1%";
            }
        }

        function animateScore() {
            let cur = 0;
            const el = document.getElementById('final-score');
            const step = Math.ceil(scores.total / 40);
            const t = setInterval(() => {
                cur += step;
                if(cur >= scores.total) { cur = scores.total; clearInterval(t); tg.HapticFeedback.notificationOccurred('success'); }
                el.innerText = cur.toLocaleString();
            }, 20);
        }

        window.shareStory = () => {
            const r = document.getElementById('user-rank').innerText;
            const link = "https://t.me/YOUR_BOT_NAME"; // !!! REPLACE THIS
            const txt = `TG Journey Analysis üìä\nüíé Points: ${scores.total}\nüèÜ Rank: ${r}\nAre you an OG? Check now:`;
            tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(txt)}`);
        }

        init();
    </script>
</body>
</html>
