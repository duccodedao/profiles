
<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ================================================================================== -->
    <!-- === KHU VỰC CẤU HÌNH SEO (THAY ĐỔI NỘI DUNG TẠY ĐÂY) === -->
    <!-- ================================================================================== -->
    
    <!-- 1. TIÊU ĐỀ TRANG (Hiển thị trên tab trình duyệt) -->
    <title>Bmass</title>

    <!-- 2. MÔ TẢ (Hiển thị dưới tiêu đề khi tìm kiếm Google) -->
    <meta name="description" id="meta-desc" content="Chào mừng đến với trang cá nhân. Nơi cập nhật thông tin, công việc và kết nối mạng xã hội nhanh chóng.">
    
    <!-- 3. LOGO ICON (Favicon - Icon nhỏ trên tab) -->
    <link rel="icon" id="meta-icon" href="https://hdd.io.vn/img/bmassloadings.png" type="image/png">

    <!-- 4. OPEN GRAPH (Cấu hình hiển thị khi gửi link qua Zalo/Facebook) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Profile Cá Nhân | Kết Nối & Chia Sẻ">
    <meta property="og:description" content="Click để xem thông tin chi tiết, số điện thoại và các liên kết mạng xã hội của tôi.">
    <meta property="og:image" content="https://hdd.io.vn/img/bmasslogos.png"> <!-- Link ảnh đại diện khi share link -->

    <!-- 5. MÀU SẮC TRÌNH DUYỆT (Mobile) -->
    <meta name="theme-color" content="#6366f1">
    
    <!-- ================================================================================== -->
    <!-- === KẾT THÚC KHU VỰC SEO === -->
    <!-- ================================================================================== -->
    
    <!-- PWA / Mobile Capable -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Link Manifest động -->
    <link rel="manifest" id="dynamic-manifest">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cropper.js -->
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#6366f1', 
                        secondary: '#ec4899',
                        dark: '#0f172a',
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        }
                    }
                } 
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; transition: background 0.3s; } 
        .dark body { background-color: #020617; color: #e2e8f0; }
        
        /* --- CẤU HÌNH NỀN (BACKGROUND) --- */
        /* Nếu muốn dùng ảnh nền thay vì màu, hãy bỏ comment dòng background-image bên dưới và thay link ảnh */
        .custom-bg {
            /* background-image: url('https://link-anh-nen-cua-ban.com/bg.jpg'); */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255,255,255,0.05); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }

        /* Carrier Branding Colors */
        .carrier-viettel { background: #008445; color: white; }
        .carrier-vinaphone { background: #00aeef; color: white; }
        .carrier-mobifone { background: #005baa; color: white; }
        .carrier-vietnamobile { background: #ff6a00; color: white; }
        .carrier-gmobile { background: #ffcc00; color: black; }
        .carrier-itel { background: #ed1c24; color: white; }

        /* Scroll Reveal Effect */
        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s cubic-bezier(0.5, 0, 0, 1);
        }
        .reveal-on-scroll.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* Input/Label styles */
        .inp { width: 100%; padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; background-color: #f8fafc; outline: none; font-size: 0.875rem; }
        .dark .inp { background-color: #1e293b; border-color: rgba(255,255,255,0.1); color: white; }
        .inp:focus { border-color: #6366f1; }
        .lbl { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 0.25rem; }
        .btn-primary { background-color: #6366f1; color: white; }
        .loader { width: 20px; height: 20px; border: 3px solid #e2e8f0; border-bottom-color: #6366f1; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden pb-10 custom-bg">

    <!-- Background Elements (Hiệu ứng Blob) - Nếu dùng ảnh nền ở trên thì có thể xóa đoạn này -->
    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-primary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-secondary/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-32 left-1/3 w-96 h-96 bg-purple-500/20 rounded-full mix-blend-multiply filter blur-3xl opacity-70 animate-blob animation-delay-4000"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="global-loading" class="fixed inset-0 bg-white dark:bg-slate-950 z-[900] flex flex-col items-center justify-center transition-opacity duration-300">
        <img src="https://hdd.io.vn/img/bmassloadings.png" class="w-20 h-20 mb-4 animate-bounce-slow drop-shadow-2xl">
        <span class="text-sm font-bold text-slate-500 tracking-widest uppercase">Đang tải dữ liệu...</span>
    </div>

    <!-- USB File Input (Hidden) -->
    <input type="file" id="usb-key-input" class="hidden" accept=".json,.txt">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass px-6 py-3 flex justify-between items-center mb-8">
        <div class="flex items-center gap-3">
            <button id="sidebar-toggle-btn" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition mr-2">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
            <img id="nav-avatar" src="https://ui-avatars.com/api/?name=P" class="w-9 h-9 rounded-full object-cover border-2 border-primary/20 shadow-sm">
            <span id="nav-nickname" class="font-bold text-lg hidden sm:block tracking-tight truncate max-w-[150px]">MyProfile</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
            </button>
            <button id="usb-connect-btn" onclick="document.getElementById('usb-key-input').click()" class="p-2 rounded-full text-slate-400 hover:text-primary hover:bg-black/5 dark:hover:bg-white/10 transition" title="Kết nối USB Key">
                <i data-lucide="usb" class="w-5 h-5"></i>
            </button>
            <button id="account-info-btn" onclick="window.openAccountModal()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition" title="Tài khoản">
                <i data-lucide="user" class="w-5 h-5"></i>
            </button>
            <div id="auth-section"></div>
        </div>
    </nav>

    <!-- Admin/User Sidebar -->
    <div id="admin-sidebar" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-slate-900 shadow-lg z-[400] transform -translate-x-full transition-transform duration-300 flex flex-col pt-16">
        <button id="sidebar-close-btn" class="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        <div class="p-4 border-b dark:border-white/10">
            <h4 class="font-black text-xl text-primary">Admin Panel</h4>
        </div>
        <div class="flex-1 overflow-y-auto p-2 space-y-1">
            <h5 class="text-xs font-bold uppercase text-slate-400 px-3 py-2">Cài đặt cá nhân</h5>
            <button onclick="window.openAccountModal()" class="flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                <i data-lucide="user" class="w-5 h-5"></i> <span>Tài khoản</span>
            </button>
            <button onclick="window.toggleTheme()" class="flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i> <span>Chế độ sáng/tối</span>
            </button>
            <button onclick="document.getElementById('usb-key-input').click()" class="flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                <i data-lucide="usb" class="w-5 h-5"></i> <span>Kết nối USB Key</span>
            </button>

            <div id="admin-sections" class="hidden">
                <hr class="my-4 border-slate-200 dark:border-slate-700">
                <h5 class="text-xs font-bold uppercase text-slate-400 px-3 py-2">Quản lý</h5>
                <button onclick="window.openEditProfileTab()" class="tab-btn-sidebar flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <i data-lucide="edit-3" class="w-5 h-5 text-primary"></i> <span>Chỉnh sửa Profile</span>
                </button>
                <button onclick="window.openManagerModal()" class="tab-btn-sidebar flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <i data-lucide="users" class="w-5 h-5 text-purple-500"></i> <span>Quản lý người dùng</span>
                </button>
                <button onclick="window.openProjectsModal()" class="tab-btn-sidebar flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <i data-lucide="package" class="w-5 h-5 text-cyan-500"></i> <span>Quản lý Dự án</span>
                </button>
                <button onclick="window.openMessagesTab()" class="tab-btn-sidebar flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <i data-lucide="message-square" class="w-5 h-5 text-green-500"></i> <span>Tin nhắn</span>
                </button>
                <button onclick="window.openConfigTab()" class="tab-btn-sidebar flex items-center gap-3 w-full p-3 rounded-lg text-left text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition">
                    <i data-lucide="settings" class="w-5 h-5 text-red-500"></i> <span>Cấu hình hệ thống</span>
                </button>
            </div>
        </div>
        <div class="p-4 border-t dark:border-white/10">
            <button onclick="window.doLogout()" class="flex items-center gap-3 w-full p-3 bg-red-500 text-white rounded-lg text-left text-sm font-bold shadow-md hover:bg-red-600 transition">
                <i data-lucide="log-out" class="w-5 h-5"></i> <span>Đăng xuất</span>
            </button>
        </div>
    </div>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-[350] hidden opacity-0 transition-opacity duration-300"></div>


    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 space-y-6">

        <!-- Header Card -->
        <div class="glass rounded-3xl p-6 sm:p-8 flex flex-col md:flex-row items-center md:items-start gap-6 relative overflow-hidden reveal-on-scroll">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-primary to-secondary rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&size=256" class="relative w-32 h-32 sm:w-40 sm:h-40 rounded-full object-cover border-4 border-white dark:border-slate-800 shadow-xl">
                <div id="online-indicator" class="absolute bottom-2 right-2 w-5 h-5 bg-green-500 border-4 border-white dark:border-slate-800 rounded-full"></div>
            </div>

            <div class="flex-1 text-center md:text-left space-y-2 z-10">
                <div class="flex flex-col md:flex-row items-center gap-2 md:gap-4 justify-center md:justify-start">
                    <h1 id="profile-name" class="text-3xl sm:text-4xl font-black tracking-tight text-slate-800 dark:text-white">Loading...</h1>
                    <span id="profile-nickname-badge" class="px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold uppercase tracking-wider hidden"></span>
                </div>
                
                <p id="profile-bio" class="text-slate-500 dark:text-slate-400 font-medium max-w-lg mx-auto md:mx-0">...</p>

                <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 py-3">
                    <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                        <i data-lucide="users" class="w-4 h-4 text-primary"></i>
                        <span id="stat-followers">0</span> <span class="text-slate-400 font-normal">Người theo dõi</span>
                    </div>
                    <div class="flex items-center gap-1.5 text-sm font-bold text-slate-700 dark:text-slate-300">
                        <i data-lucide="eye" class="w-4 h-4 text-secondary"></i>
                        <span id="stat-views">0</span> <span class="text-slate-400 font-normal">Lượt xem</span>
                    </div>
                    <div id="relationship-display" class="hidden flex items-center gap-1.5 text-sm font-bold text-pink-500 bg-pink-500/10 px-3 py-1 rounded-full">
                        <i data-lucide="heart" class="w-3 h-3 fill-current"></i>
                        <span id="rel-status">Độc thân</span>
                    </div>
                </div>

                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-2">
                    <button id="follow-btn" onclick="window.toggleFollow()" class="px-6 py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:transform hover:scale-105 transition flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> Theo dõi
                    </button>
                    <button onclick="window.showContactModal('phone')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-primary hover:border-primary transition shadow-sm">
                        <i data-lucide="phone" class="w-5 h-5"></i>
                    </button>
                    <button onclick="window.showContactModal('email')" class="p-2.5 bg-white dark:bg-slate-800 border dark:border-white/10 rounded-xl text-slate-600 dark:text-slate-300 hover:text-secondary hover:border-secondary transition shadow-sm">
                        <i data-lucide="mail" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Social Links Grid -->
        <div id="social-grid" class="flex flex-wrap justify-center gap-4 reveal-on-scroll"></div>

        <!-- Banking -->
        <div class="glass p-6 rounded-3xl space-y-4 reveal-on-scroll">
            <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 flex items-center gap-2">
                <i data-lucide="credit-card" class="w-4 h-4"></i> Ngân hàng
            </h3>
            <div id="bank-list" class="space-y-3 max-h-[200px] overflow-y-auto pr-1"></div>
        </div>

        <!-- Projects Section -->
        <div class="glass p-6 sm:p-8 rounded-3xl reveal-on-scroll">
            <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                <i data-lucide="package" class="w-4 h-4"></i> Dự án
            </h3>
            <div id="projects-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Project cards will be rendered here -->
            </div>
            <p id="no-projects-message" class="text-center text-slate-400 text-sm italic mt-4 hidden">Chưa có dự án nào được thêm.</p>
        </div>

        <!-- Partners Section -->
        <div id="partners-section" class="glass p-6 sm:p-8 rounded-3xl hidden reveal-on-scroll">
            <h3 class="font-black uppercase text-sm tracking-widest text-slate-400 mb-6 flex items-center gap-2">
                <i data-lucide="handshake" class="w-4 h-4"></i> Đối tác
            </h3>
            <div id="partners-grid" class="flex flex-wrap items-center justify-center gap-8 opacity-70 grayscale hover:grayscale-0 transition-all duration-500"></div>
        </div>

        <!-- Send Message Button (Bottom) -->
        <div class="flex justify-center mt-8 reveal-on-scroll">
            <button onclick="window.showContactForm()" class="w-full max-w-md px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl hover:-translate-y-1 transition flex items-center justify-center gap-3">
                <i data-lucide="send" class="w-6 h-6"></i> Gửi tin nhắn cho tôi
            </button>
        </div>

        <!-- IP & Geo Info -->
        <div class="glass mt-8 p-4 rounded-2xl text-center space-y-2 reveal-on-scroll">
            <div class="flex items-center justify-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-widest">
                <i data-lucide="globe" class="w-3 h-3"></i> Thông tin kết nối của bạn
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="block text-slate-400 text-xs">Địa chỉ IP</span>
                    <span id="user-ip" class="font-mono font-bold text-slate-700 dark:text-white">Đang tải...</span>
                </div>
                <div>
                    <span class="block text-slate-400 text-xs">Địa chỉ</span>
                    <span id="user-address" class="font-bold text-slate-700 dark:text-white">Đang tải...</span>
                </div>
                <div>
                    <span class="block text-slate-400 text-xs">Thiết bị</span>
                    <span id="user-device" class="font-bold text-slate-700 dark:text-white">Đang tải...</span>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Footer -->
    <footer class="text-center py-8 text-slate-400 text-xs font-medium">
        <p>&copy; 2024 Profile System.</p>
    </footer>

    <!-- MODALS -->
    
    <!-- Contact View Modal -->
    <div id="modal-contact" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 id="contact-title" class="font-bold text-lg">Liên hệ</h3>
                <button onclick="window.closeModal('modal-contact')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="contact-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Contact Send Form Modal -->
    <div id="modal-send-msg" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-fade-in relative">
            <button onclick="window.closeModal('modal-send-msg')" class="absolute top-4 right-4 p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="font-bold text-lg mb-4">Gửi tin nhắn</h3>
            <form id="contact-form" class="space-y-4">
                <div>
                    <label class="lbl">Họ tên</label>
                    <input type="text" id="msg-name" class="inp" placeholder="Nhập tên của bạn...">
                </div>
                <div id="msg-email-group">
                    <label class="lbl">Email</label>
                    <input type="email" id="msg-email" class="inp" placeholder="email@example.com">
                </div>
                <div>
                    <label class="lbl">Nội dung</label>
                    <textarea id="msg-content" rows="4" class="inp" placeholder="Bạn muốn nhắn gì..."></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="msg-anon" onchange="toggleAnon()" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary">
                    <label for="msg-anon" class="text-sm font-medium text-slate-600 dark:text-slate-300">Gửi ẩn danh</label>
                </div>
                <button type="button" onclick="window.sendContact()" class="w-full py-2 bg-primary text-white font-bold rounded-xl shadow hover:bg-indigo-600 transition">Gửi đi</button>
            </form>
        </div>
    </div>

    <!-- Crop Image Modal -->
    <div id="modal-crop" class="fixed inset-0 bg-black z-[500] hidden flex flex-col">
        <div class="flex-1 bg-black relative flex items-center justify-center overflow-hidden">
             <img id="image-to-crop" src="" class="max-w-full max-h-full block">
        </div>
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
            <button onclick="window.closeModal('modal-crop')" class="px-4 py-2 font-bold text-slate-400">Hủy</button>
            <div class="text-sm font-medium">Cắt ảnh đại diện (Vuông)</div>
            <button onclick="window.confirmCrop()" class="px-6 py-2 bg-primary rounded-lg font-bold">Xác nhận</button>
        </div>
    </div>

    <!-- Manager Modal -->
    <div id="modal-manager" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b dark:border-white/10 pb-4">
                <h3 class="font-bold text-lg">Quản lý người dùng</h3>
                <button onclick="window.closeModal('modal-manager')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-4" id="manager-list"></div>
        </div>
    </div>

    <!-- Account Info Modal (New) -->
    <div id="modal-account" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Thông tin tài khoản</h3>
                <button onclick="window.closeModal('modal-account')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="account-info-content" class="space-y-4 text-center">
                <!-- User info will be loaded here -->
                <p class="text-slate-500">Đang tải...</p>
            </div>
        </div>
    </div>

    <!-- Admin Edit Modal (Profile Editing) -->
    <div id="modal-admin-edit" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[300] hidden flex items-center justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full h-full sm:h-[90vh] sm:rounded-2xl sm:max-w-4xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b dark:border-white/10 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                <h3 class="font-black uppercase text-primary tracking-widest">Chỉnh sửa Profile</h3>
                <button onclick="window.closeModal('modal-admin-edit')" class="p-2 bg-slate-200 dark:bg-slate-800 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <!-- Body -->
            <div class="flex-1 flex flex-col sm:flex-row overflow-hidden">
                <div class="w-full sm:w-48 bg-slate-50 dark:bg-slate-950 border-r dark:border-white/5 p-2 flex sm:flex-col gap-2 overflow-x-auto sm:overflow-visible shrink-0">
                    <button onclick="window.switchAdminTab('general', this)" class="tab-btn active p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="sliders" class="w-4 h-4"></i> Chung</button>
                    <button onclick="window.switchAdminTab('contact', this)" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="contact" class="w-4 h-4"></i> Liên hệ & MXH</button>
                    <button onclick="window.switchAdminTab('bank', this)" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4"></i> Ngân hàng</button>
                    <button onclick="window.switchAdminTab('projects', this)" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="package" class="w-4 h-4 text-cyan-500"></i> Dự án</button>
                    <button onclick="window.switchAdminTab('partners', this)" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="handshake" class="w-4 h-4"></i> Đối tác</button>
                    <button onclick="window.switchAdminTab('website', this)" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="globe" class="w-4 h-4 text-purple-500"></i> Website (SEO)</button>
                    <button onclick="window.switchAdminTab('messages', this)" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4 text-green-500"></i> Tin nhắn</button>
                    <button onclick="window.switchAdminTab('config', this)" class="tab-btn p-3 rounded-lg text-left text-xs font-bold uppercase hover:bg-white dark:hover:bg-white/5 flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4 text-red-500"></i> Cấu hình</button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-slate-900 relative">
                    <form id="admin-form" class="space-y-6 max-w-2xl mx-auto pb-20">
                        <!-- TAB: GENERAL -->
                        <div id="tab-admin-general" class="tab-content space-y-4">
                            <div class="flex gap-4 items-center">
                                <img id="preview-avatar" src="" class="w-20 h-20 rounded-full object-cover border">
                                <label class="flex-1 cursor-pointer">
                                    <div class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-bold text-center border-dashed border-2 border-slate-300 hover:border-primary">
                                        Tải ảnh mới (Có cắt)
                                    </div>
                                    <input type="file" id="inp-avatar" class="hidden" accept="image/*">
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="lbl">Họ tên</label><input type="text" id="inp-name" class="inp"></div>
                                <div><label class="lbl">Biệt danh</label><input type="text" id="inp-nickname" class="inp"></div>
                            </div>
                            <div><label class="lbl">Tiểu sử (Bio)</label><textarea id="inp-bio" rows="3" class="inp"></textarea></div>
                            
                            <div class="border p-3 rounded-xl dark:border-white/10 space-y-2">
                                <label class="lbl">Mối quan hệ</label>
                                <select id="inp-rel-status" class="inp mb-2" onchange="togglePartnerInput()">
                                    <option value="Độc thân">Độc thân</option>
                                    <option value="Đang hẹn hò">Đang hẹn hò</option>
                                    <option value="Đã kết hôn">Đã kết hôn</option>
                                </select>
                                <div id="partner-inputs" class="hidden grid grid-cols-2 gap-2">
                                    <input type="text" id="inp-partner-name" placeholder="Tên người ấy" class="inp">
                                    <input type="text" id="inp-partner-link" placeholder="Link Profile (FB...)" class="inp">
                                </div>
                            </div>
                        </div>

                        <!-- TAB: CONTACT -->
                        <div id="tab-admin-contact" class="tab-content hidden space-y-4">
                            <div class="space-y-2 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl">
                                <label class="lbl">Số điện thoại</label>
                                <div id="phone-list-editor" class="grid grid-cols-1 gap-2"></div>
                                <button type="button" onclick="addPhoneInput()" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 rounded-lg text-xs font-bold hover:bg-white hover:text-primary transition">+ Thêm số mới</button>
                            </div>
                             <div><label class="lbl">Email (Cách nhau dấu phẩy)</label><input type="text" id="inp-emails" class="inp" placeholder="email1@gmail.com, email2@yahoo.com"></div>
                             <div><label class="lbl">Facebook (Link)</label><input type="text" id="inp-fb" class="inp"></div>
                             <div><label class="lbl">Zalo (SĐT)</label><input type="text" id="inp-zalo" class="inp"></div>
                             <div><label class="lbl">Instagram (Link/User)</label><input type="text" id="inp-ig" class="inp"></div>
                             <div><label class="lbl">Telegram (User không @)</label><input type="text" id="inp-tele" class="inp"></div>
                             <div><label class="lbl">LinkedIn (Link)</label><input type="text" id="inp-linkedin" class="inp"></div>
                        </div>

                         <!-- TAB: BANK -->
                         <div id="tab-admin-bank" class="tab-content hidden space-y-4">
                            <div class="flex gap-2">
                                <select id="api-bank-list" class="inp w-1/2"></select>
                                <input type="text" id="bank-acc-num" placeholder="Số tài khoản" class="inp w-1/2">
                            </div>
                            <input type="text" id="bank-acc-name" placeholder="Tên chủ thẻ" class="inp">
                            <button type="button" onclick="addBank()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm Ngân hàng</button>
                            <div id="admin-bank-list" class="space-y-2 mt-4"></div>
                        </div>

                        <!-- TAB: PROJECTS (NEW) -->
                        <div id="tab-admin-projects" class="tab-content hidden space-y-4">
                            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl space-y-3">
                                <h4 class="font-bold text-cyan-600">Thêm/Sửa Dự án</h4>
                                <div><label class="lbl">Tiêu đề</label><input type="text" id="project-title" class="inp"></div>
                                <div><label class="lbl">Mô tả</label><textarea id="project-description" rows="2" class="inp"></textarea></div>
                                <div><label class="lbl">Link Logo</label><input type="text" id="project-logo" class="inp"></div>
                                <div><label class="lbl">Link Ảnh Bìa</label><input type="text" id="project-cover" class="inp"></div>
                                <div><label class="lbl">Link Tham gia (Ref)</label><input type="text" id="project-ref-link" class="inp"></div>
                                <div><label class="lbl">Mã Ref (Nếu có)</label><input type="text" id="project-ref-code" class="inp"></div>
                                <button type="button" onclick="addProject()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm/Cập nhật Dự án</button>
                                <p class="text-[10px] text-slate-400 italic text-center">Bấm vào dự án bên dưới để sửa hoặc nút X để xóa.</p>
                            </div>
                            <label class="lbl mt-4">Danh sách Dự án hiện tại</label>
                            <div id="admin-projects-list" class="grid grid-cols-1 gap-3"></div>
                        </div>

                        <!-- TAB: PARTNERS -->
                        <div id="tab-admin-partners" class="tab-content hidden space-y-4">
                            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl space-y-3">
                                <label class="lbl">Thêm/Sửa Đối tác</label>
                                <input type="text" id="partner-logo-url" placeholder="Link ảnh Logo" class="inp">
                                <input type="text" id="partner-link" placeholder="Link trang web" class="inp">
                                <button type="button" onclick="addPartner()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm vào danh sách</button>
                                <p class="text-[10px] text-slate-400 italic text-center">Bấm vào nút X để xóa, bấm vào ảnh để sửa lại.</p>
                            </div>
                            <label class="lbl mt-4">Danh sách hiện tại</label>
                            <div id="admin-partner-list" class="grid grid-cols-2 gap-3"></div>
                        </div>

                        <!-- TAB: WEBSITE (META) -->
                        <div id="tab-admin-website" class="tab-content hidden space-y-4">
                            <div class="p-4 bg-purple-50 dark:bg-purple-900/10 rounded-xl space-y-3">
                                <h4 class="font-bold text-purple-600">Cấu hình SEO & Hiển thị</h4>
                                <div>
                                    <label class="lbl">Tiêu đề trang (Title)</label>
                                    <input type="text" id="meta-title-inp" class="inp" placeholder="VD: Nguyễn Văn A - Profile">
                                </div>
                                <div>
                                    <label class="lbl">Mô tả (Description)</label>
                                    <textarea id="meta-desc-inp" rows="2" class="inp" placeholder="Mô tả ngắn gọn về trang..."></textarea>
                                </div>
                                <div>
                                    <label class="lbl">Icon trang (Favicon URL)</label>
                                    <input type="text" id="meta-icon-inp" class="inp" placeholder="https://...">
                                </div>
                            </div>
                        </div>

                        <!-- TAB: MESSAGES -->
                        <div id="tab-admin-messages" class="tab-content hidden space-y-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold">Danh sách tin nhắn</h4>
                                <button type="button" onclick="loadAdminMessages()" class="text-xs bg-slate-200 dark:bg-slate-800 px-3 py-1 rounded hover:bg-slate-300">Làm mới</button>
                            </div>
                            <div id="admin-messages-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                                <p class="text-center text-slate-500 text-sm">Đang tải...</p>
                            </div>
                        </div>

                        <!-- TAB: CONFIG -->
                        <div id="tab-admin-config" class="tab-content hidden space-y-4">
                            <div class="p-4 bg-red-50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900/20 space-y-3">
                                <h4 class="font-bold text-red-500 text-sm">Cấu hình GitHub (Lưu trữ ảnh)</h4>
                                <input type="password" id="gh-token" placeholder="Token" class="inp">
                                <input type="text" id="gh-owner" placeholder="Username" class="inp">
                                <input type="text" id="gh-repo" placeholder="Repository" class="inp">
                            </div>

                            <div class="p-4 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900/20 space-y-3">
                                <h4 class="font-bold text-blue-500 text-sm">Cấu hình USB Key</h4>
                                <p class="text-[10px] text-slate-500">Nhập mã bí mật bên dưới. Trên USB tạo file .json chứa: {"key": "MÃ_CỦA_BẠN"}</p>
                                <div class="flex gap-2">
                                    <input type="text" id="usb-secret-val" placeholder="Nhập mã bí mật..." class="inp">
                                    <button type="button" onclick="saveUSBConfig()" class="px-4 bg-blue-500 text-white rounded-lg font-bold text-xs">Lưu</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="p-4 border-t dark:border-white/10 bg-white dark:bg-slate-900 flex justify-end gap-3">
                <button onclick="window.closeModal('modal-admin-edit')" class="px-6 py-2 rounded-xl text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 transition">Hủy</button>
                <button onclick="window.saveProfile()" class="px-6 py-2 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-indigo-600 transition">Lưu Thay Đổi</button>
            </div>
        </div>
    </div>

    <!-- Projects Admin Modal -->
    <div id="modal-projects-admin" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[300] hidden flex items-center justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full h-full sm:h-[90vh] sm:rounded-2xl sm:max-w-4xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-4 border-b dark:border-white/10 flex justify-between items-center bg-slate-50 dark:bg-slate-950">
                <h3 class="font-black uppercase text-cyan-500 tracking-widest">Quản lý Dự án</h3>
                <button onclick="window.closeModal('modal-projects-admin')" class="p-2 bg-slate-200 dark:bg-slate-800 rounded-lg"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-white dark:bg-slate-900 relative">
                <form id="projects-admin-form" class="space-y-6 max-w-2xl mx-auto pb-20">
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl space-y-3">
                        <h4 class="font-bold text-cyan-600">Thêm/Sửa Dự án</h4>
                        <input type="hidden" id="project-edit-index">
                        <div><label class="lbl">Tiêu đề</label><input type="text" id="project-title-admin" class="inp"></div>
                        <div><label class="lbl">Mô tả</label><textarea id="project-description-admin" rows="2" class="inp"></textarea></div>
                        <div><label class="lbl">Link Logo (URL)</label><input type="text" id="project-logo-admin" class="inp"></div>
                        <div><label class="lbl">Link Ảnh Bìa (URL)</label><input type="text" id="project-cover-admin" class="inp"></div>
                        <div><label class="lbl">Link Tham gia (Ref)</label><input type="text" id="project-ref-link-admin" class="inp"></div>
                        <div><label class="lbl">Mã Ref (Nếu có)</label><input type="text" id="project-ref-code-admin" class="inp"></div>
                        <button type="button" onclick="addOrUpdateProject()" class="w-full btn-primary py-2 text-xs rounded-lg font-bold">Thêm/Cập nhật Dự án</button>
                    </div>
                    <label class="lbl mt-4">Danh sách Dự án hiện tại</label>
                    <div id="admin-projects-list-full" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                </form>
            </div>
            <div class="p-4 border-t dark:border-white/10 bg-white dark:bg-slate-900 flex justify-end gap-3">
                <button onclick="window.closeModal('modal-projects-admin')" class="px-6 py-2 rounded-xl text-slate-500 font-bold hover:bg-slate-100 dark:hover:bg-slate-800 transition">Đóng</button>
                <button onclick="window.saveProjects()" class="px-6 py-2 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-indigo-600 transition">Lưu Dự án</button>
            </div>
        </div>
    </div>


    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 z-[1000] translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-slate-900 text-white dark:bg-white dark:text-slate-900 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 font-bold text-sm">
            <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>
            <span id="toast-msg">Thông báo</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, arrayUnion, arrayRemove, increment, collection, getDocs, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", 
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };
        
        const ADMIN_EMAILS = ["sonlyhongduc@gmail.com"]; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let isAdmin = false;
        let isUSBAdmin = false;
        let profileData = {};
        let ghConfig = {};
        let listBanks = [];
        let listPartners = [];
        let listProjects = []; // New array for projects
        let cropper = null;
        let croppedAvatarBase64 = null;
        const carrierLogos = {
            'viettel': 'https://upload.wikimedia.org/wikipedia/commons/4/4e/Viettel_logo_2021.png',
            'vinaphone': 'https://hdd.io.vn/img/vina.png',
            'mobifone': 'https://hdd.io.vn/img/mobi.PNG',
            'vietnamobile': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Vietnamobile_Logo.png/800px-Vietnamobile_Logo.png',
            'gmobile': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Gmobile_logo.png/800px-Gmobile_logo.png',
            'itel': 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Logo_Itel.png/800px-Logo_Itel.png'
        };

        // --- SIDEBAR TOGGLE ---
        document.getElementById('sidebar-toggle-btn').addEventListener('click', () => {
            document.getElementById('admin-sidebar').classList.remove('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('sidebar-overlay').classList.add('opacity-100'), 10);
        });

        document.getElementById('sidebar-close-btn').addEventListener('click', () => {
            document.getElementById('admin-sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('opacity-100');
            setTimeout(() => document.getElementById('sidebar-overlay').classList.add('hidden'), 300);
        });

        document.getElementById('sidebar-overlay').addEventListener('click', () => {
            document.getElementById('admin-sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.remove('opacity-100');
            setTimeout(() => document.getElementById('sidebar-overlay').classList.add('hidden'), 300);
        });

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if(user) {
                // Get device info
                const deviceInfo = getDeviceInfo();

                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastSeen: new Date().toISOString(),
                    device: deviceInfo.type,
                    deviceDetails: deviceInfo.details
                }, { merge: true });

                const adminRef = doc(db, "settings", "admins");
                const adminSnap = await getDoc(adminRef);
                const serverAdmins = adminSnap.exists() ? adminSnap.data().emails : [];
                isAdmin = ADMIN_EMAILS.includes(user.email) || (serverAdmins && serverAdmins.includes(user.email));

                checkAdminUI();
            } else {
                isAdmin = false;
                checkAdminUI();
            }
            renderAuthUI();
            checkFollowStatus();
        });

        // --- USB LOGIN ---
        const usbInput = document.getElementById('usb-key-input');
        usbInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const content = JSON.parse(event.target.result);
                    if (content.key) {
                        const usbRef = doc(db, "settings", "usb_config");
                        const snap = await getDoc(usbRef);
                        if (snap.exists() && snap.data().secret === content.key) {
                            isUSBAdmin = true;
                            showToast("Đã xác thực USB Key thành công!");
                            checkAdminUI();
                        } else {
                            showToast("USB Key không hợp lệ!", true);
                        }
                    }
                } catch (err) { showToast("Lỗi đọc file USB!", true); }
            };
            reader.readAsText(file);
            usbInput.value = ''; 
        });

        function checkAdminUI() {
            if (isAdmin || isUSBAdmin) {
                document.getElementById('admin-sections').classList.remove('hidden');
                document.getElementById('usb-connect-btn').classList.remove('hidden'); // Ensure USB button is visible for admin
            } else {
                document.getElementById('admin-sections').classList.add('hidden');
                document.getElementById('usb-connect-btn').classList.add('hidden'); // Hide USB button for normal users
            }
            // Always show account info and theme toggle for all users
            document.getElementById('account-info-btn').classList.remove('hidden');
            document.querySelector('button[onclick="window.toggleTheme()"]').classList.remove('hidden');
        }

        window.saveUSBConfig = async () => {
            const val = document.getElementById('usb-secret-val').value;
            if (!val) return;
            await setDoc(doc(db, "settings", "usb_config"), { secret: val });
            showToast("Đã lưu mã USB Key!");
        }

        // --- IP & GEO FETCH ---
        let userLat = null;
        let userLon = null;
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                return { type: 'Tablet', details: ua };
            }
            if (/Mobile|iP(hone|od)|Android|BlackBerry|IEMobile|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                return { type: 'Mobile', details: ua };
            }
            return { type: 'Desktop', details: ua };
        }

        async function loadNetworkInfo() {
            // Get IP
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('user-ip').innerText = data.ip;
                })
                .catch(() => document.getElementById('user-ip').innerText = "Không xác định");

            // Get Geo & Reverse Geocode
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;
                        document.getElementById('user-address').innerText = await reverseGeocode(userLat, userLon);
                    },
                    (error) => {
                         document.getElementById('user-address').innerText = "Không xác định";
                    }
                );
            } else {
                document.getElementById('user-address').innerText = "Không hỗ trợ";
            }

            // Get Device Info
            document.getElementById('user-device').innerText = getDeviceInfo().type;
        }
        loadNetworkInfo();

        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();
                return data.display_name || "Không xác định";
            } catch (error) {
                console.error("Error during reverse geocoding:", error);
                return "Không xác định";
            }
        }

        // --- SCROLL REVEAL OBSERVER ---
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('active');
                }
            });
        }, observerOptions);

        function initScrollReveal() {
            document.querySelectorAll('.reveal-on-scroll').forEach(el => {
                observer.observe(el);
            });
        }

        // --- DATA SYNC ---
        const profileRef = doc(db, "profile_data", "main");
        
        onSnapshot(profileRef, async (docSnap) => {
            document.getElementById('global-loading').classList.add('opacity-0', 'pointer-events-none');
            if (docSnap.exists()) {
                profileData = docSnap.data();
                // Increment views only if it's the first load and not an admin
                if (!sessionStorage.getItem('viewed') && !(isAdmin || isUSBAdmin)) {
                    await updateDoc(profileRef, { views: increment(1) });
                    sessionStorage.setItem('viewed', 'true'); // Prevent multiple increments on refresh
                }
                renderProfile();
                initScrollReveal(); // Re-init observer on new data render
            }
        });

        // --- RENDER ---
        function renderProfile() {
            // Meta & Title
            if(profileData.meta) {
                document.title = profileData.meta.title || profileData.name;
                document.getElementById('meta-desc').setAttribute('content', profileData.meta.description || '');
                if(profileData.meta.favicon) document.getElementById('meta-icon').href = profileData.meta.favicon;
            } else {
                document.title = `${profileData.name} - Profile`;
            }

            // --- PWA DYNAMIC MANIFEST GENERATION ---
            const manifestLink = document.getElementById('dynamic-manifest');
            const currentIcon = profileData.avatar || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            const manifestObj = {
                "name": profileData.name || "Profile Cá Nhân",
                "short_name": profileData.nickname || "Profile",
                "start_url": location.href,
                "display": "standalone",
                "background_color": "#f8fafc",
                "theme_color": "#6366f1",
                "icons": [
                    { "src": currentIcon, "sizes": "192x192", "type": "image/png" },
                    { "src": currentIcon, "sizes": "512x512", "type": "image/png" }
                ]
            };
            const stringManifest = JSON.stringify(manifestObj);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            manifestLink.setAttribute('href', manifestURL);
            // ----------------------------------------

            document.getElementById('profile-name').innerText = profileData.name || "No Name";
            document.getElementById('nav-nickname').innerText = profileData.nickname || "User";
            if(profileData.avatar) {
                document.getElementById('profile-avatar').src = profileData.avatar;
                document.getElementById('nav-avatar').src = profileData.avatar;
            }
            if(profileData.nickname) {
                const badge = document.getElementById('profile-nickname-badge');
                badge.innerText = profileData.nickname;
                badge.classList.remove('hidden');
            }
            
            document.getElementById('profile-bio').innerText = profileData.bio || "Chưa cập nhật tiểu sử.";
            document.getElementById('stat-followers').innerText = (profileData.followers || []).length;
            document.getElementById('stat-views').innerText = profileData.views || 0;

            const relEl = document.getElementById('relationship-display');
            if (profileData.relationship?.status && profileData.relationship.status !== 'Độc thân') {
                relEl.classList.remove('hidden');
                let html = `${profileData.relationship.status}`;
                if(profileData.relationship.partnerName) {
                    html += ` với <a href="${profileData.relationship.partnerLink || '#'}" target="_blank" class="font-black hover:underline cursor-pointer transition-all">${profileData.relationship.partnerName}</a>`;
                }
                document.getElementById('rel-status').innerHTML = html;
            } else {
                relEl.classList.add('hidden');
            }

            const socialMap = {
                facebook: { icon: 'facebook', color: 'text-blue-600' },
                zalo: { icon: 'phone', color: 'text-blue-500' },
                instagram: { icon: 'instagram', color: 'text-pink-600' },
                telegram: { icon: 'send', color: 'text-sky-500' },
                linkedin: { icon: 'linkedin', color: 'text-blue-700' },
            };
            let socialHtml = '';
            if(profileData.socials) {
                Object.keys(profileData.socials).forEach(key => {
                    const val = profileData.socials[key];
                    if(val) {
                        const meta = socialMap[key] || { icon: 'link', color: 'text-slate-500' };
                        let link = val;
                        if(key === 'zalo') link = `https://zalo.me/${val}`;
                        if(key === 'telegram') link = `https://t.me/${val}`;
                        socialHtml += `
                        <a href="${link}" target="_blank" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow hover:-translate-y-1 transition ${meta.color}">
                            <i data-lucide="${meta.icon}" class="w-5 h-5"></i>
                        </a>`;
                    }
                });
            }
            document.getElementById('social-grid').innerHTML = socialHtml;

            // BANK RENDER
            const bankContainer = document.getElementById('bank-list');
            bankContainer.innerHTML = (profileData.banks || []).map(b => `
                <div class="bank-card p-3 rounded-xl flex items-center justify-between shadow-lg relative overflow-hidden group bg-white dark:bg-slate-900 border dark:border-white/5">
                    <div class="flex items-center gap-4 z-10">
                        <div class="w-12 h-12 bg-white rounded-lg shadow-inner flex items-center justify-center shrink-0 overflow-hidden relative">
                            <img src="${b.logo}" class="w-full h-full object-contain p-1">
                        </div>
                        <div>
                            <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">${b.shortName}</p>
                            <p class="font-mono font-bold text-lg tracking-normal text-slate-800 dark:text-white select-all">${b.number}</p>
                            <p class="text-[10px] font-bold uppercase text-slate-500">${b.owner}</p>
                        </div>
                    </div>
                    <button onclick="window.copyToClip('${b.number}')" class="p-2 bg-slate-100 dark:bg-slate-800 hover:bg-primary hover:text-white rounded-lg z-10 transition">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                    <div class="absolute right-0 bottom-0 opacity-5 pointer-events-none">
                       <img src="${b.logo}" class="w-32 h-32 -mb-8 -mr-8 object-contain">
                    </div>
                </div>
            `).join('');

            // PROJECTS RENDER
            const projectsContainer = document.getElementById('projects-list');
            const noProjectsMessage = document.getElementById('no-projects-message');
            listProjects = profileData.projects || [];
            if(listProjects.length === 0) {
                projectsContainer.innerHTML = '';
                noProjectsMessage.classList.remove('hidden');
            } else {
                noProjectsMessage.classList.add('hidden');
                projectsContainer.innerHTML = listProjects.map(p => `
                    <div class="glass rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 relative">
                        <img src="${p.cover || p.logo}" class="w-full h-40 object-cover">
                        <div class="p-4 flex flex-col items-center text-center relative z-10">
                            <img src="${p.logo}" class="w-16 h-16 rounded-full object-cover border-2 border-white dark:border-slate-800 -mt-12 mb-3 shadow-md">
                            <h4 class="font-bold text-lg mb-1">${p.title}</h4>
                            <p class="text-sm text-slate-500 mb-3 line-clamp-2">${p.description}</p>
                            <div class="flex flex-wrap gap-2 justify-center mb-4">
                                ${p.refCode ? `<div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-xs font-medium"><i data-lucide="tag" class="w-3 h-3 text-primary"></i> <span>${p.refCode}</span> <button onclick="window.copyToClip('${p.refCode}')" class="ml-1 text-slate-400 hover:text-primary"><i data-lucide="copy" class="w-3 h-3"></i></button></div>` : ''}
                                <button onclick="window.showQrCode('${p.refLink}')" class="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-xs font-medium"><i data-lucide="qr-code" class="w-3 h-3 text-purple-500"></i> <span>Mã QR</span></button>
                            </div>
                            <a href="${p.refLink}" target="_blank" class="w-full btn-primary py-2 text-sm font-bold rounded-lg flex items-center justify-center gap-2 hover:opacity-90 transition">
                                <i data-lucide="external-link" class="w-4 h-4"></i> Tham gia ngay
                            </a>
                        </div>
                    </div>
                `).join('');
            }


            const partnerSec = document.getElementById('partners-section');
            const partnerGrid = document.getElementById('partners-grid');
            if(profileData.partners && profileData.partners.length > 0) {
                partnerSec.classList.remove('hidden');
                partnerGrid.innerHTML = profileData.partners.map(p => `
                    <a href="${p.link}" target="_blank" class="block group">
                        <img src="${p.logo}" class="h-8 md:h-10 w-auto object-contain transition group-hover:scale-110">
                    </a>
                `).join('');
            } else {
                partnerSec.classList.add('hidden');
            }

            checkFollowStatus(); 
            lucide.createIcons();
        }

        window.showQrCode = (link) => {
            const qrModal = document.getElementById('modal-qr-code');
            const qrCanvas = document.getElementById('qrcode-canvas');
            if (!qrModal) {
                 // Create modal if it doesn't exist
                const modalHtml = `
                    <div id="modal-qr-code" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[800] hidden flex items-center justify-center p-4">
                        <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-xs p-6 shadow-2xl animate-fade-in text-center">
                            <h3 class="font-bold text-lg mb-4">Mã QR Dự án</h3>
                            <div id="qrcode-canvas" class="p-2 bg-white rounded-lg mx-auto w-48 h-48 flex items-center justify-center"></div>
                            <p class="text-xs text-slate-500 mt-4">Quét mã để tham gia dự án!</p>
                            <button onclick="window.closeModal('modal-qr-code')" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg font-bold">Đóng</button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                window.showQrCode(link); // Recall function to open the new modal
                return;
            }

            qrCanvas.innerHTML = ''; // Clear previous QR
            new QRCode(qrCanvas, {
                text: link,
                width: 160,
                height: 160,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            qrModal.classList.remove('hidden');
        };

        // --- CROPPER LOGIC ---
        const imageToCrop = document.getElementById('image-to-crop');
        document.getElementById('inp-avatar').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    imageToCrop.src = evt.target.result;
                    document.getElementById('modal-crop').classList.remove('hidden');
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1,
                    });
                }
                reader.readAsDataURL(file);
            }
            e.target.value = ''; 
        });

        window.confirmCrop = () => {
            if(!cropper) return;
            croppedAvatarBase64 = cropper.getCroppedCanvas({ width: 400, height: 400 }).toDataURL();
            document.getElementById('preview-avatar').src = croppedAvatarBase64;
            window.closeModal('modal-crop');
            showToast("Đã cắt ảnh xong! Nhấn Lưu để cập nhật.");
        }

        // --- CONTACT MODAL ---
        window.showContactModal = (type) => {
            const modal = document.getElementById('modal-contact');
            const list = document.getElementById('contact-list');
            const title = document.getElementById('contact-title');
            
            modal.classList.remove('hidden');
            list.innerHTML = '';
            
            if (type === 'phone') {
                title.innerText = "Gọi điện thoại";
                const phones = profileData.phones || [];

                if(phones.length === 0) list.innerHTML = '<p class="text-center text-slate-500">Chưa có số điện thoại.</p>';
                else {
                    list.innerHTML = phones.map(p => {
                        const carrierKey = p.carrier ? p.carrier.toLowerCase().trim() : '';
                        const logoUrl = carrierLogos[carrierKey] || '';
                        
                        let carrierDisplayHtml = '';
                        if(logoUrl) {
                            carrierDisplayHtml = `<img src="${logoUrl}" class="h-6 w-12 object-contain bg-white rounded px-1">`;
                        } else {
                            carrierDisplayHtml = `<span class="text-[10px] font-black uppercase px-2 py-0.5 rounded shadow-sm w-12 text-center bg-slate-500 text-white">${p.carrier || 'Sim'}</span>`;
                        }
                        
                        return `
                        <a href="tel:${p.number}" class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition group">
                            <div class="flex items-center gap-3">
                                ${carrierDisplayHtml}
                                <span class="font-bold text-lg text-slate-700 dark:text-white">${p.number}</span>
                            </div>
                            <i data-lucide="phone-call" class="w-5 h-5 text-green-500 group-hover:scale-110 transition"></i>
                        </a>`;
                    }).join('');
                }
            } else {
                title.innerText = "Gửi Email";
                const emails = (profileData.email || "").split(',').map(e => e.trim()).filter(e=>e);
                if(emails.length === 0) list.innerHTML = '<p>Chưa có email.</p>';
                else {
                    list.innerHTML = emails.map(e => `
                        <a href="mailto:${e}" class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition">
                             <span class="font-bold text-sm truncate">${e}</span>
                            <i data-lucide="send" class="w-5 h-5 text-blue-500"></i>
                        </a>`).join('');
                }
            }
            lucide.createIcons();
        }

        window.showContactForm = () => {
             document.getElementById('modal-send-msg').classList.remove('hidden');
             if(currentUser) {
                 document.getElementById('msg-name').value = currentUser.displayName || '';
                 document.getElementById('msg-email').value = currentUser.email || '';
                 document.getElementById('msg-email-group').classList.add('hidden'); 
             } else {
                 document.getElementById('msg-email-group').classList.remove('hidden');
             }
        }
        window.toggleAnon = () => {
            const isAnon = document.getElementById('msg-anon').checked;
            const nameInp = document.getElementById('msg-name');
            const emailGrp = document.getElementById('msg-email-group');
            if(isAnon) {
                nameInp.value = "Người ẩn danh";
                nameInp.disabled = true;
                emailGrp.classList.add('hidden');
            } else {
                nameInp.value = currentUser ? currentUser.displayName : "";
                nameInp.disabled = false;
                if(!currentUser) emailGrp.classList.remove('hidden');
            }
        }
        window.sendContact = async () => {
            const content = document.getElementById('msg-content').value;
            if(!content) { showToast("Vui lòng nhập nội dung!", true); return; }
            
            const isAnon = document.getElementById('msg-anon').checked;
            let data = {
                content: content,
                timestamp: new Date().toISOString(),
                isAnon: isAnon
            };

            if(isAnon) {
                data.name = "Ẩn danh";
            } else {
                data.name = document.getElementById('msg-name').value;
                data.email = currentUser ? currentUser.email : document.getElementById('msg-email').value;
            }

            try {
                await addDoc(collection(db, "messages"), data);
                showToast("Tin nhắn đã được gửi!");
                window.closeModal('modal-send-msg');
                document.getElementById('contact-form').reset();
            } catch(e) {
                showToast("Lỗi gửi tin nhắn", true);
            }
        }

        // --- AUTH UI ---
        function renderAuthUI() {
            const container = document.getElementById('auth-section');
            if (currentUser) {
                container.innerHTML = `<button onclick="window.doLogout()" class="px-4 py-1.5 bg-red-500 text-white text-xs font-bold rounded-full shadow hover:bg-red-600">Đăng xuất</button>`;
                document.getElementById('account-info-btn').classList.remove('hidden'); // Show account info for logged-in users
            } else {
                container.innerHTML = `<button onclick="window.doLogin()" class="px-4 py-1.5 bg-primary text-white text-xs font-bold rounded-full shadow hover:bg-indigo-600">Đăng nhập</button>`;
                document.getElementById('account-info-btn').classList.add('hidden'); // Hide account info for logged-out users
            }
        }
        window.doLogin = () => signInWithPopup(auth, provider);
        window.doLogout = () => signOut(auth).then(()=> location.reload());

        // --- ADMIN OPEN PROFILE EDIT ---
        window.openEditProfileTab = async () => {
            document.getElementById('admin-sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');

            document.getElementById('modal-admin-edit').classList.remove('hidden');
            document.getElementById('preview-avatar').src = profileData.avatar || '';
            document.getElementById('inp-name').value = profileData.name || '';
            document.getElementById('inp-nickname').value = profileData.nickname || '';
            document.getElementById('inp-bio').value = profileData.bio || '';
            
            if(profileData.meta) {
                document.getElementById('meta-title-inp').value = profileData.meta.title || '';
                document.getElementById('meta-desc-inp').value = profileData.meta.description || '';
                document.getElementById('meta-icon-inp').value = profileData.meta.favicon || '';
            }

            if(profileData.relationship) {
                document.getElementById('inp-rel-status').value = profileData.relationship.status;
                document.getElementById('inp-partner-name').value = profileData.relationship.partnerName || '';
                document.getElementById('inp-partner-link').value = profileData.relationship.partnerLink || '';
                togglePartnerInput();
            }

            const phones = profileData.phones || [];
            document.getElementById('phone-list-editor').innerHTML = '';
            phones.forEach(p => addPhoneInput(p.number, p.carrier));
            
            document.getElementById('inp-emails').value = profileData.email || '';
            if(profileData.socials) {
                document.getElementById('inp-fb').value = profileData.socials.facebook || '';
                document.getElementById('inp-zalo').value = profileData.socials.zalo || '';
                document.getElementById('inp-ig').value = profileData.socials.instagram || '';
                document.getElementById('inp-tele').value = profileData.socials.telegram || '';
                document.getElementById('inp-linkedin').value = profileData.socials.linkedin || '';
            }

            listBanks = profileData.banks || [];
            renderAdminBanks();
            loadBankList();

            listPartners = profileData.partners || [];
            renderAdminPartners();

            listProjects = profileData.projects || [];
            renderAdminProjectsFull();
            
            const usbSnap = await getDoc(doc(db, "settings", "usb_config"));
            if(usbSnap.exists()) document.getElementById('usb-secret-val').value = usbSnap.data().secret || '';

            // Default to general tab
            window.switchAdminTab('general', document.querySelector('#modal-admin-edit .tab-btn'));
        }

        window.openMessagesTab = () => {
            document.getElementById('admin-sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
            window.openEditProfileTab(); // Open main admin modal
            window.switchAdminTab('messages', document.querySelector('#modal-admin-edit .tab-btn[onclick*="messages"]')); // Switch to messages tab
        }

        window.openConfigTab = () => {
            document.getElementById('admin-sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
            window.openEditProfileTab(); // Open main admin modal
            window.switchAdminTab('config', document.querySelector('#modal-admin-edit .tab-btn[onclick*="config"]')); // Switch to config tab
        }

        window.loadAdminMessages = async () => {
            const list = document.getElementById('admin-messages-list');
            list.innerHTML = '<p class="text-center text-xs">Đang tải...</p>';
            try {
                const q = query(collection(db, "messages"), orderBy("timestamp", "desc"), limit(20));
                const snap = await getDocs(q);
                if(snap.empty) {
                    list.innerHTML = '<p class="text-center text-slate-400 text-xs">Chưa có tin nhắn nào.</p>';
                    return;
                }
                list.innerHTML = '';
                snap.forEach(doc => {
                    const msg = doc.data();
                    const d = new Date(msg.timestamp).toLocaleString('vi-VN');
                    list.innerHTML += `
                        <div class="p-3 bg-slate-50 dark:bg-slate-800 rounded border dark:border-white/10">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-sm text-primary">${msg.name}</span>
                                <span class="text-[10px] text-slate-400">${d}</span>
                            </div>
                            <p class="text-xs text-slate-500 italic mb-1">${msg.email || 'No Email'}</p>
                            <p class="text-sm bg-white dark:bg-slate-900 p-2 rounded mt-1">${msg.content}</p>
                        </div>
                    `;
                });
            } catch (error) {
                list.innerHTML = '<p class="text-red-500 text-xs">Lỗi tải tin nhắn.</p>';
            }
        }

        // --- SAVE PROFILE ---
        window.saveProfile = async () => {
            const btn = document.querySelector('#modal-admin-edit button.bg-primary');
            btn.innerText = "Đang lưu...";
            
            try {
                const token = document.getElementById('gh-token').value;
                const owner = document.getElementById('gh-owner').value;
                const repo = document.getElementById('gh-repo').value;
                if(token && owner && repo) {
                    await setDoc(doc(db, "settings", "github_config"), { token, owner, repo });
                    ghConfig = { token, owner, repo };
                }

                let avatarUrl = profileData.avatar;
                if(croppedAvatarBase64 && ghConfig.token) {
                    const content = croppedAvatarBase64.split(',')[1];
                    const path = `avatars/${Date.now()}_avatar.png`;
                    const url = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${path}`;
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: "Update Avatar", content: content, branch: 'main' })
                    });
                    if(res.ok) {
                        const data = await res.json();
                        avatarUrl = data.content.download_url;
                    }
                }

                const phoneElements = document.querySelectorAll('#phone-list-editor .phone-row');
                const phones = Array.from(phoneElements).map(row => ({
                    carrier: row.querySelector('.carrier-select').value,
                    number: row.querySelector('.phone-inp').value
                })).filter(x => x.number);
                
                const newData = {
                    name: document.getElementById('inp-name').value,
                    nickname: document.getElementById('inp-nickname').value,
                    bio: document.getElementById('inp-bio').value,
                    avatar: avatarUrl,
                    meta: {
                        title: document.getElementById('meta-title-inp').value,
                        description: document.getElementById('meta-desc-inp').value,
                        favicon: document.getElementById('meta-icon-inp').value
                    },
                    relationship: {
                        status: document.getElementById('inp-rel-status').value,
                        partnerName: document.getElementById('inp-partner-name').value,
                        partnerLink: document.getElementById('inp-partner-link').value
                    },
                    email: document.getElementById('inp-emails').value,
                    phones: phones,
                    socials: {
                        facebook: document.getElementById('inp-fb').value,
                        zalo: document.getElementById('inp-zalo').value,
                        instagram: document.getElementById('inp-ig').value,
                        telegram: document.getElementById('inp-tele').value,
                        linkedin: document.getElementById('inp-linkedin').value,
                    },
                    banks: listBanks,
                    partners: listPartners,
                    projects: listProjects // Save projects
                };

                await setDoc(profileRef, newData, { merge: true });
                showToast("Đã cập nhật Profile!");
                window.closeModal('modal-admin-edit');
                croppedAvatarBase64 = null; 

            } catch(e) {
                showToast("Lỗi: " + e.message, true);
                console.error(e);
            } finally {
                btn.innerText = "Lưu Thay Đổi";
            }
        }

        // --- ADMIN HELPERS ---
        window.addPhoneInput = (val = '', carrier = 'Viettel') => {
            const container = document.getElementById('phone-list-editor');
            const div = document.createElement('div');
            div.className = 'phone-row flex gap-2 items-center bg-white p-2 rounded shadow-sm';
            // Adjusted width for select box here (w-[110px])
            div.innerHTML = `
                <select class="inp w-[110px] shrink-0 carrier-select text-xs">
                    <option value="Viettel" ${carrier === 'Viettel' ? 'selected' : ''}>Viettel</option>
                    <option value="Vinaphone" ${carrier === 'Vinaphone' ? 'selected' : ''}>Vinaphone</option>
                    <option value="Mobifone" ${carrier === 'Mobifone' ? 'selected' : ''}>Mobifone</option>
                    <option value="Vietnamobile" ${carrier === 'Vietnamobile' ? 'selected' : ''}>Vietnamobile</option>
                    <option value="Gmobile" ${carrier === 'Gmobile' ? 'selected' : ''}>Gmobile</option>
                    <option value="Itel" ${carrier === 'Itel' ? 'selected' : ''}>Itel/Khác</option>
                </select>
                <input type="text" value="${val}" class="inp phone-inp flex-1 font-bold text-slate-700 min-w-0" placeholder="09xxxx">
                <button type="button" onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            container.appendChild(div);
            lucide.createIcons();
        }

        window.addPartner = () => {
            const logo = document.getElementById('partner-logo-url').value;
            const link = document.getElementById('partner-link').value;
            if(!logo) return;
            listPartners.push({ logo, link });
            renderAdminPartners();
            document.getElementById('partner-logo-url').value = '';
            document.getElementById('partner-link').value = '';
        }
        function renderAdminPartners() {
            document.getElementById('admin-partner-list').innerHTML = listPartners.map((p, i) => `
                <div class="relative p-2 border rounded flex items-center justify-center bg-white h-20 group cursor-pointer" onclick="editPartner(${i})">
                    <img src="${p.logo}" class="h-full object-contain">
                    <button onclick="event.stopPropagation(); removePartner(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center">x</button>
                    <div class="absolute inset-0 bg-black/10 hidden group-hover:flex items-center justify-center text-xs font-bold text-white">Sửa</div>
                </div>
            `).join('');
        }
        window.removePartner = (i) => { listPartners.splice(i, 1); renderAdminPartners(); }
        window.editPartner = (i) => {
            const p = listPartners[i];
            document.getElementById('partner-logo-url').value = p.logo;
            document.getElementById('partner-link').value = p.link;
            listPartners.splice(i, 1);
            renderAdminPartners();
            showToast("Đã đưa thông tin lên ô nhập để sửa.");
        }

        window.openManagerModal = async () => {
             document.getElementById('admin-sidebar').classList.add('-translate-x-full');
             document.getElementById('sidebar-overlay').classList.add('hidden');

             const modal = document.getElementById('modal-manager');
             modal.classList.remove('hidden');
             const list = document.getElementById('manager-list');
             list.innerHTML = '<div class="text-center p-4"><div class="loader"></div></div>';
             try {
                const snap = await getDocs(collection(db, "users"));
                let html = '';
                for (const d of snap.docs) {
                    const u = d.data();
                    let address = "Đang tải...";
                    if (u.latitude && u.longitude) {
                        address = await reverseGeocode(u.latitude, u.longitude);
                    } else {
                        address = "Không xác định";
                    }
                    html += `
                    <div class="flex items-center gap-3 p-3 border-b dark:border-white/5">
                        <img src="${u.photoURL}" class="w-10 h-10 rounded-full bg-slate-100">
                        <div class="flex-1 min-w-0">
                            <p class="font-bold text-sm truncate">${u.displayName}</p>
                            <p class="text-xs text-slate-500 truncate">${u.email}</p>
                            <p class="text-xs text-slate-400">Thiết bị: <span class="font-semibold">${u.device || 'N/A'}</span></p>
                            <p class="text-xs text-slate-400">Địa chỉ: <span class="font-semibold">${address}</span></p>
                        </div>
                    </div>`;
                }
                list.innerHTML = html;
             } catch(e) { list.innerHTML = "Lỗi tải danh sách."; }
        }

        window.openAccountModal = () => {
            document.getElementById('admin-sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');

            const modal = document.getElementById('modal-account');
            const content = document.getElementById('account-info-content');
            modal.classList.remove('hidden');

            if (currentUser) {
                content.innerHTML = `
                    <img src="${currentUser.photoURL}" class="w-24 h-24 rounded-full object-cover border-4 border-primary/20 shadow-md mx-auto mb-4">
                    <p class="font-bold text-xl">${currentUser.displayName}</p>
                    <p class="text-sm text-slate-500 italic">${currentUser.email}</p>
                    <p class="text-xs text-slate-400 mt-2">UID: <span class="font-mono">${currentUser.uid}</span></p>
                    <p class="text-xs text-slate-400">Tham gia: <span class="font-mono">${new Date(currentUser.metadata.creationTime).toLocaleDateString()}</span></p>
                `;
            } else {
                content.innerHTML = '<p class="text-slate-500">Bạn chưa đăng nhập.</p>';
            }
        }

        function checkFollowStatus() {
            const btn = document.getElementById('follow-btn');
            if (!currentUser) {
                btn.innerHTML = `<i data-lucide="user-plus" class="w-4 h-4"></i> Theo dõi`;
                btn.classList.remove('bg-green-600');
                return;
            }
            const followers = profileData.followers || [];
            const isFollowing = followers.includes(currentUser.uid);
            if (isFollowing) {
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Đang theo dõi`;
                btn.classList.add('bg-green-600', 'text-white');
                btn.classList.remove('bg-slate-900', 'dark:bg-white');
            } else {
                btn.innerHTML = `<i data-lucide="user-plus" class="w-4 h-4"></i> Theo dõi`;
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-slate-900', 'dark:bg-white');
            }
            lucide.createIcons();
        }
        window.toggleFollow = async () => {
            if (!currentUser) { window.doLogin(); return; }
            const uid = currentUser.uid;
            const followers = profileData.followers || [];
            if (followers.includes(uid)) {
                await updateDoc(profileRef, { followers: arrayRemove(uid) });
                showToast("Đã hủy theo dõi");
            } else {
                await updateDoc(profileRef, { followers: arrayUnion(uid) });
                showToast("Đã theo dõi!");
            }
        }

        // --- PROJECTS ADMIN ---
        window.openProjectsModal = () => {
            document.getElementById('admin-sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
            document.getElementById('modal-projects-admin').classList.remove('hidden');
            listProjects = profileData.projects || [];
            renderAdminProjectsFull();
            clearProjectForm();
        }

        window.addOrUpdateProject = () => {
            const title = document.getElementById('project-title-admin').value;
            const description = document.getElementById('project-description-admin').value;
            const logo = document.getElementById('project-logo-admin').value;
            const cover = document.getElementById('project-cover-admin').value;
            const refLink = document.getElementById('project-ref-link-admin').value;
            const refCode = document.getElementById('project-ref-code-admin').value;
            const editIndex = document.getElementById('project-edit-index').value;

            if (!title || !refLink) {
                showToast("Tiêu đề và Link Tham gia là bắt buộc!", true);
                return;
            }

            const newProject = { title, description, logo, cover, refLink, refCode };

            if (editIndex !== "") {
                listProjects[parseInt(editIndex)] = newProject;
            } else {
                listProjects.push(newProject);
            }
            renderAdminProjectsFull();
            clearProjectForm();
            showToast("Dự án đã được thêm/cập nhật. Nhấn 'Lưu Dự án' để hoàn tất.");
        }

        function renderAdminProjectsFull() {
            const container = document.getElementById('admin-projects-list-full');
            container.innerHTML = listProjects.map((p, i) => `
                <div class="relative p-3 border rounded-lg bg-white dark:bg-slate-800 flex items-center gap-3">
                    <img src="${p.logo || p.cover || 'https://via.placeholder.com/40'}" class="w-10 h-10 object-cover rounded">
                    <div class="flex-1">
                        <p class="font-bold text-sm">${p.title}</p>
                        <p class="text-xs text-slate-500 truncate">${p.refLink}</p>
                    </div>
                    <button onclick="editProject(${i})" class="p-1 text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="removeProject(${i})" class="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.editProject = (index) => {
            const p = listProjects[index];
            document.getElementById('project-title-admin').value = p.title;
            document.getElementById('project-description-admin').value = p.description;
            document.getElementById('project-logo-admin').value = p.logo;
            document.getElementById('project-cover-admin').value = p.cover;
            document.getElementById('project-ref-link-admin').value = p.refLink;
            document.getElementById('project-ref-code-admin').value = p.refCode;
            document.getElementById('project-edit-index').value = index;
            showToast("Đã tải thông tin dự án lên để chỉnh sửa.");
        }

        window.removeProject = (index) => {
            listProjects.splice(index, 1);
            renderAdminProjectsFull();
            showToast("Dự án đã được xóa khỏi danh sách tạm. Nhấn 'Lưu Dự án' để hoàn tất.", false);
        }

        function clearProjectForm() {
            document.getElementById('project-title-admin').value = '';
            document.getElementById('project-description-admin').value = '';
            document.getElementById('project-logo-admin').value = '';
            document.getElementById('project-cover-admin').value = '';
            document.getElementById('project-ref-link-admin').value = '';
            document.getElementById('project-ref-code-admin').value = '';
            document.getElementById('project-edit-index').value = '';
        }

        window.saveProjects = async () => {
            const btn = document.querySelector('#modal-projects-admin button.bg-primary');
            btn.innerText = "Đang lưu...";
            try {
                await updateDoc(profileRef, { projects: listProjects });
                showToast("Đã lưu các thay đổi về dự án!");
                window.closeModal('modal-projects-admin');
            } catch (e) {
                showToast("Lỗi khi lưu dự án: " + e.message, true);
            } finally {
                btn.innerText = "Lưu Dự án";
            }
        }

        // --- UTILS ---
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        if (localStorage.theme === 'dark') document.documentElement.classList.add('dark');

        window.copyToClip = (text) => { navigator.clipboard.writeText(text); showToast('Đã sao chép!'); }
        function formatDate(dateStr) { if (!dateStr) return ""; const [y, m, d] = dateStr.split('-'); return `${d}/${m}/${y}`; }
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            const icon = document.getElementById('toast-icon');
            if(isError) { icon.classList.replace('text-green-500','text-red-500'); icon.setAttribute('data-lucide','alert-triangle'); }
            else { icon.classList.replace('text-red-500','text-green-500'); icon.setAttribute('data-lucide','check-circle'); }
            lucide.createIcons();
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        
        // --- API HELPERS ---
        async function loadBankList() { try { const res = await fetch('https://api.vietqr.io/v2/banks'); const data = await res.json(); if(data.code === "00") document.getElementById('api-bank-list').innerHTML = data.data.map(b => `<option value='${JSON.stringify({shortName: b.shortName, logo: b.logo})}'>${b.shortName}</option>`).join(''); } catch(e) {} }
        window.addBank = () => { const meta = JSON.parse(document.getElementById('api-bank-list').value); const num = document.getElementById('bank-acc-num').value; const owner = document.getElementById('bank-acc-name').value; if(!num) return; listBanks.push({ ...meta, number: num, owner }); renderAdminBanks(); document.getElementById('bank-acc-num').value = ''; }
        function renderAdminBanks() { document.getElementById('admin-bank-list').innerHTML = listBanks.map((b, i) => `<div class="flex items-center justify-between p-2 bg-slate-100 dark:bg-slate-800 rounded"><div class="flex items-center gap-2"><img src="${b.logo}" class="w-6 h-6 object-contain bg-white"><span class="text-xs font-bold">${b.shortName} - ${b.number}</span></div><button onclick="removeBank(${i})" class="text-red-500 text-xs">Xóa</button></div>`).join(''); }
        window.removeBank = (i) => { listBanks.splice(i, 1); renderAdminBanks(); }
        
        window.switchAdminTab = (tabName, element) => { 
            document.querySelectorAll('#modal-admin-edit .tab-content').forEach(el => el.classList.add('hidden')); 
            document.getElementById('tab-admin-' + tabName).classList.remove('hidden'); 
            document.querySelectorAll('#modal-admin-edit .tab-btn').forEach(el => el.classList.remove('bg-white', 'dark:bg-white/5', 'shadow-sm')); 
            if (element) {
                element.classList.add('bg-white', 'dark:bg-white/5', 'shadow-sm'); 
            }
            if (tabName === 'messages') {
                loadAdminMessages();
            }
            if (tabName === 'config') {
                loadGithubConfig();
            }
            if (tabName === 'projects') {
                renderAdminProjectsFull(); // Ensure projects are loaded when tab is opened
            }
        }
        window.togglePartnerInput = () => { const val = document.getElementById('inp-rel-status').value; document.getElementById('partner-inputs').classList.toggle('hidden', val === 'Độc thân'); }
        async function loadGithubConfig() { const s = await getDoc(doc(db, "settings", "github_config")); if(s.exists()) { ghConfig = s.data(); document.getElementById('gh-token').value = ghConfig.token || ''; document.getElementById('gh-owner').value = ghConfig.owner || ''; document.getElementById('gh-repo').value = ghConfig.repo || ''; } }
        
        lucide.createIcons();
    </script>
</body>
</html>
