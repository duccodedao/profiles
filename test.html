<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crypto Signal Analyzer</title>
    <!-- Th∆∞ vi·ªán bi·ªÉu ƒë·ªì c·ªßa TradingView -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-color: #0f111a;
            --panel-color: #1c1f2e;
            --text-color: #d1d4dc;
            --accent-color: #2962ff;
            --green: #00b3a6;
            --red: #f23645;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        h1 { margin: 0 0 20px 0; font-size: 24px; color: #fff; }

        .container {
            display: flex;
            gap: 20px;
            height: 100%;
        }

        /* Sidebar Controls */
        .sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            background-color: var(--panel-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 12px; color: #787b86; }
        
        input, select {
            width: 100%;
            padding: 10px;
            background: #2a2e39;
            border: 1px solid #363a45;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        button:hover { background-color: #1e4bd1; }
        button:disabled { background-color: #555; cursor: not-allowed; }

        /* Signal Box */
        .signal-box { text-align: center; }
        .signal-status { font-size: 28px; font-weight: bold; margin: 10px 0; }
        .buy { color: var(--green); }
        .sell { color: var(--red); }
        .neutral { color: #888; }

        .setup-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            text-align: left;
            font-size: 14px;
        }

        .setup-row { display: flex; justify-content: space-between; border-bottom: 1px solid #363a45; padding-bottom: 5px; }
        .val-entry { color: #ebac00; font-weight: bold; }
        .val-tp { color: var(--green); font-weight: bold; }
        .val-sl { color: var(--red); font-weight: bold; }

        /* Chart Area */
        .chart-container {
            flex-grow: 1;
            background-color: var(--panel-color);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        #chart { width: 100%; height: 100%; }
        
        .loading { display: none; text-align: center; color: var(--accent-color); font-weight: bold; }
    </style>
</head>
<body>

    <h1>ü§ñ AI Crypto Analyzer (M√¥ ph·ªèng d·ªØ li·ªáu Binance)</h1>

    <div class="container">
        <!-- Sidebar Setup -->
        <div class="sidebar">
            <div class="card">
                <div class="input-group">
                    <label>C·∫∑p ti·ªÅn (VD: BTCUSDT, ETHUSDT)</label>
                    <input type="text" id="symbol" value="BTCUSDT" style="text-transform: uppercase;">
                </div>
                <div class="input-group">
                    <label>Khung th·ªùi gian</label>
                    <select id="interval">
                        <option value="15m">15 Ph√∫t</option>
                        <option value="1h" selected>1 Gi·ªù</option>
                        <option value="4h">4 Gi·ªù</option>
                        <option value="1d">1 Ng√†y</option>
                    </select>
                </div>
                <button onclick="runAnalysis()" id="btnAnalyze">üöÄ Ph√¢n t√≠ch & T√¨m Setup</button>
                <div class="loading" id="loading">ƒêang t·∫£i d·ªØ li·ªáu & t√≠nh to√°n...</div>
            </div>

            <!-- K·∫øt qu·∫£ Ph√¢n t√≠ch -->
            <div class="card signal-box" id="resultPanel" style="display:none;">
                <label>T√çN HI·ªÜU AI</label>
                <div id="signalText" class="signal-status neutral">NEUTRAL</div>
                
                <div class="setup-details" id="setupDetails">
                    <div class="setup-row">
                        <span>Gi√° hi·ªán t·∫°i:</span> <span id="currentPrice">--</span>
                    </div>
                    <div class="setup-row">
                        <span>RSI (14):</span> <span id="rsiValue">--</span>
                    </div>
                    <div class="setup-row">
                        <span>Xu h∆∞·ªõng (EMA200):</span> <span id="trendValue">--</span>
                    </div>
                    
                    <div id="tradeSetup" style="display:none; margin-top:10px; background:#2a2e39; padding:10px; border-radius:4px;">
                        <div class="setup-row"><span>üéØ TP (Take Profit):</span> <span class="val-tp" id="tpPrice">--</span></div>
                        <div class="setup-row"><span>‚ö° Entry (V√†o l·ªánh):</span> <span class="val-entry" id="entryPrice">--</span></div>
                        <div class="setup-row"><span>üõë STL (Stop Loss):</span> <span class="val-sl" id="slPrice">--</span></div>
                        <div style="font-size:11px; margin-top:5px; color:#787b86;">*Setup t√≠nh theo ATR (Risk:Reward 1:2)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <div id="chart"></div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & INIT CHART ---
        const chartElement = document.getElementById('chart');
        const chart = LightweightCharts.createChart(chartElement, {
            layout: { background: { color: '#1c1f2e' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
            timeScale: { timeVisible: true, secondsVisible: false },
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: '#00b3a6', downColor: '#f23645', borderVisible: false, wickUpColor: '#00b3a6', wickDownColor: '#f23645'
        });
        
        const emaSeries = chart.addLineSeries({ color: '#2962ff', lineWidth: 2, title: 'EMA 50' });
        const emaSlowSeries = chart.addLineSeries({ color: '#ff9800', lineWidth: 2, title: 'EMA 200' });

        let currentCandles = [];

        // --- 2. MATH FUNCTIONS (INDICATORS) ---
        // T√≠nh RSI
        function calculateRSI(closes, period = 14) {
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                let change = closes[i] - closes[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            let rsis = new Array(period).fill(null); // Padding

            for (let i = period + 1; i < closes.length; i++) {
                let change = closes[i] - closes[i - 1];
                let gain = change > 0 ? change : 0;
                let loss = change < 0 ? Math.abs(change) : 0;
                
                avgGain = (avgGain * (period - 1) + gain) / period;
                avgLoss = (avgLoss * (period - 1) + loss) / period;
                
                let rs = avgGain / avgLoss;
                rsis.push(100 - (100 / (1 + rs)));
            }
            return rsis;
        }

        // T√≠nh EMA
        function calculateEMA(closes, period) {
            let k = 2 / (period + 1);
            let emaArray = [closes[0]];
            for (let i = 1; i < closes.length; i++) {
                emaArray.push(closes[i] * k + emaArray[i - 1] * (1 - k));
            }
            return emaArray;
        }

        // T√≠nh ATR (ƒê·ªô bi·∫øn ƒë·ªông)
        function calculateATR(highs, lows, closes, period = 14) {
            let trs = [highs[0] - lows[0]];
            for(let i=1; i < closes.length; i++) {
                let hl = highs[i] - lows[i];
                let hc = Math.abs(highs[i] - closes[i-1]);
                let lc = Math.abs(lows[i] - closes[i-1]);
                trs.push(Math.max(hl, hc, lc));
            }
            // Simple Moving Average of TR for ATR
            let atrs = new Array(period-1).fill(null);
            let sum = 0;
            for(let i=0; i<period; i++) sum += trs[i];
            atrs.push(sum/period);
            
            for(let i=period; i<trs.length; i++) {
                let prevATR = atrs[atrs.length-1];
                atrs.push((prevATR * (period - 1) + trs[i]) / period);
            }
            return atrs;
        }

        // --- 3. LOGIC X·ª¨ L√ù CH√çNH ---
        async function runAnalysis() {
            const symbol = document.getElementById('symbol').value.toUpperCase();
            const interval = document.getElementById('interval').value;
            const btn = document.getElementById('btnAnalyze');
            const loading = document.getElementById('loading');
            
            btn.disabled = true;
            loading.style.display = 'block';

            try {
                // Fetch data t·ª´ Binance API (Public)
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=300`);
                const data = await response.json();

                if (!Array.isArray(data)) throw new Error("L·ªói c·∫∑p ti·ªÅn ho·∫∑c m·∫°ng.");

                // Parse Data
                const times = [], opens = [], highs = [], lows = [], closes = [];
                const chartData = data.map(d => {
                    const time = d[0] / 1000;
                    const open = parseFloat(d[1]);
                    const high = parseFloat(d[2]);
                    const low = parseFloat(d[3]);
                    const close = parseFloat(d[4]);
                    
                    times.push(time);
                    opens.push(open);
                    highs.push(high);
                    lows.push(low);
                    closes.push(close);

                    return { time, open, high, low, close };
                });

                // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
                candleSeries.setData(chartData);

                // --- T√çNH TO√ÅN CH·ªà B√ÅO ---
                const ema50 = calculateEMA(closes, 50);
                const ema200 = calculateEMA(closes, 200);
                const rsi = calculateRSI(closes, 14);
                const atr = calculateATR(highs, lows, closes, 14);

                // V·∫Ω EMA l√™n bi·ªÉu ƒë·ªì
                const ema50Data = chartData.map((d, i) => ({ time: d.time, value: ema50[i] }));
                const ema200Data = chartData.map((d, i) => ({ time: d.time, value: ema200[i] }));
                emaSeries.setData(ema50Data);
                emaSlowSeries.setData(ema200Data);

                // --- LOGIC PH√ÇN T√çCH T√çN HI·ªÜU (AI LOGIC) ---
                const lastIdx = closes.length - 1;
                const price = closes[lastIdx];
                const lastRSI = rsi[lastIdx];
                const lastATR = atr[atr.length - 1]; // ATR array is shorter due to padding
                const curEMA50 = ema50[lastIdx];
                const curEMA200 = ema200[lastIdx];

                let signal = "NEUTRAL";
                let setup = null;

                // X√°c ƒë·ªãnh xu h∆∞·ªõng
                const trend = price > curEMA200 ? "UPTREND (TƒÉng)" : "DOWNTREND (Gi·∫£m)";

                // Chi·∫øn l∆∞·ª£c: Pullback theo xu h∆∞·ªõng
                // BUY: Gi√° > EMA200 (Uptrend) v√† RSI b·ªã b√°n qu√° m·ª©c (<40) nh∆∞ng b·∫Øt ƒë·∫ßu h·ªìi
                if (price > curEMA200 && price > curEMA50) {
                    if (lastRSI < 45) { // ƒêi·ªÅu ki·ªán mua s·ªõm khi RSI th·∫•p trong uptrend
                        signal = "BUY / LONG";
                        setup = {
                            entry: price,
                            sl: price - (2 * lastATR), // Stoploss d∆∞·ªõi 2 ATR
                            tp: price + (3 * lastATR)  // TP 3 ATR (RR 1.5)
                        };
                    }
                }
                // SELL: Gi√° < EMA200 (Downtrend) v√† RSI cao (>60)
                else if (price < curEMA200 && price < curEMA50) {
                    if (lastRSI > 55) {
                        signal = "SELL / SHORT";
                        setup = {
                            entry: price,
                            sl: price + (2 * lastATR),
                            tp: price - (3 * lastATR)
                        };
                    }
                }

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                document.getElementById('resultPanel').style.display = 'block';
                const signalEl = document.getElementById('signalText');
                signalEl.innerText = signal;
                signalEl.className = `signal-status ${signal.includes('BUY') ? 'buy' : (signal.includes('SELL') ? 'sell' : 'neutral')}`;

                document.getElementById('currentPrice').innerText = price.toFixed(2);
                document.getElementById('rsiValue').innerText = lastRSI ? lastRSI.toFixed(2) : "N/A";
                document.getElementById('trendValue').innerText = trend;

                const tradeSetupDiv = document.getElementById('tradeSetup');
                if (setup) {
                    tradeSetupDiv.style.display = 'block';
                    document.getElementById('tpPrice').innerText = setup.tp.toFixed(2);
                    document.getElementById('entryPrice').innerText = setup.entry.toFixed(2);
                    document.getElementById('slPrice').innerText = setup.sl.toFixed(2);

                    // V·∫Ω marker l√™n chart
                    const markerColor = signal.includes('BUY') ? '#00b3a6' : '#f23645';
                    const markerText = signal.includes('BUY') ? 'BUY' : 'SELL';
                    const markerPos = signal.includes('BUY') ? 'belowBar' : 'aboveBar';
                    const markerShape = signal.includes('BUY') ? 'arrowUp' : 'arrowDown';

                    candleSeries.setMarkers([
                        {
                            time: chartData[lastIdx].time,
                            position: markerPos,
                            color: markerColor,
                            shape: markerShape,
                            text: markerText,
                        }
                    ]);
                } else {
                    tradeSetupDiv.style.display = 'none';
                    candleSeries.setMarkers([]);
                }

                // Auto scale chart
                chart.timeScale().fitContent();

            } catch (error) {
                alert("L·ªói: " + error.message);
                console.error(error);
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        // Ch·∫°y resize chart khi ƒë·ªïi k√≠ch th∆∞·ªõc c·ª≠a s·ªï
        window.addEventListener('resize', () => {
            chart.resize(document.querySelector('.chart-container').clientWidth, document.querySelector('.chart-container').clientHeight);
        });
    </script>
</body>
</html>
