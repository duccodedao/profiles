<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BmassHD - QR Pro (Verify)</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --primary: #4e73df; --primary-dark: #2e59d9;
            --secondary: #858796; --success: #1cc88a; --danger: #e74a3b;
            --bg-body: #f3f4f6; --bg-card: #ffffff; --bg-input: #ffffff;
            --text-main: #2d3748; --text-sub: #718096; --border: #e2e8f0;
            --shadow: 0 10px 25px rgba(0,0,0,0.05); --radius: 12px; --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary: #4e73df; --primary-dark: #3751a0;
            --bg-body: #1a202c; --bg-card: #2d3748; --bg-input: #4a5568;
            --text-main: #f7fafc; --text-sub: #a0aec0; --border: #4a5568;
            --shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; transition: var(--transition); }
        
        .container { width: 100%; max-width: 1200px; background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-wrap: wrap; margin-bottom: 30px; position: relative; transition: var(--transition); }
        
        /* HEADER */
        .header { width: 100%; padding: 20px; background: linear-gradient(135deg, var(--primary), #224abe); color: white; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        .btn-icon { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .btn-icon:hover { background: rgba(255,255,255,0.35); transform: rotate(15deg); }

        /* LAYOUT */
        .col-left, .col-right { padding: 30px; flex: 1; min-width: 350px; transition: var(--transition); }
        .col-left { border-right: 1px solid var(--border); }
        .col-right { background-color: var(--bg-body); display: flex; flex-direction: column; align-items: center; }
        [data-theme="dark"] .col-right { background-color: #283141; }

        /* BANK GRID */
        .search-box { position: relative; margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-main); outline: none; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        
        .bank-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; max-height: 220px; overflow-y: auto; padding-right: 5px; }
        .bank-item { border: 2px solid var(--border); border-radius: 10px; padding: 5px; cursor: pointer; transition: var(--transition); background: var(--bg-card); height: 70px; display: flex; align-items: center; justify-content: center; position: relative; }
        .bank-item img { max-width: 80%; max-height: 80%; object-fit: contain; filter: grayscale(100%); transition: var(--transition); }
        .bank-item:hover { transform: translateY(-3px); border-color: var(--primary); }
        .bank-item.active { border-color: var(--primary); background: rgba(78, 115, 223, 0.05); }
        .bank-item.active img { filter: grayscale(0%); }

        /* INPUTS */
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--text-sub); }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-input); color: var(--text-main); font-size: 1rem; outline: none; transition: var(--transition); }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.15); }

        /* BUTTONS */
        .btn-action { width: 100%; padding: 14px; border: none; border-radius: 30px; background: var(--primary); color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .btn-action:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); }
        .btn-secondary:hover { background: #6c757d; }

        /* QR FRAME */
        .qr-frame { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; min-height: 380px; width: 100%; max-width: 380px; display: flex; align-items: center; justify-content: center; position: relative; border: 1px solid #eee; }
        .qr-frame img { max-width: 100%; height: auto; border-radius: 8px; display: none; }
        .qr-frame img.loaded { display: block; animation: zoomIn 0.4s ease; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ADMIN SPECIFIC */
        #adminPanel { width: 100%; max-width: 1200px; background: var(--bg-card); padding: 25px; border-radius: var(--radius); border-top: 4px solid var(--primary); display: none; margin-top: 20px; box-shadow: var(--shadow); }
        .verify-box { display: flex; gap: 10px; align-items: center; }
        .btn-verify { background: var(--success); color: white; border: none; padding: 0 15px; border-radius: 8px; height: 45px; cursor: pointer; white-space: nowrap; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .btn-verify:hover { background: #169b6b; }
        .btn-verify:disabled { opacity: 0.6; cursor: not-allowed; }

        /* LOADING */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-card); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .col-left { border-right: none; border-bottom: 1px solid var(--border); }
            .verify-box { flex-direction: column; align-items: stretch; }
            .btn-verify { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<div id="initialLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 15px; font-weight: 500;">ƒêang kh·ªüi t·∫°o...</p>
</div>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-qrcode"></i> BmassHD Pro</h1>
        <div style="display: flex; gap: 10px;">
            <button class="btn-icon" onclick="toggleTheme()"><i class="fas fa-moon" id="themeIcon"></i></button>
            <button class="btn-icon" id="btnLogin" onclick="handleLogin()"><i class="fas fa-user-shield"></i></button>
            <button class="btn-icon" id="btnLogout" onclick="handleLogout()" style="display: none;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <!-- USER INTERFACE -->
    <div class="col-left">
        <div class="form-group">
            <label class="form-label">1. Ch·ªçn Ng√¢n H√†ng</label>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="bankSearch" placeholder="T√¨m ki·∫øm ng√¢n h√†ng..." onkeyup="filterBanks()">
            </div>
            <div class="bank-grid" id="bankGrid"></div>
            <div style="margin-top: 8px; font-size: 0.9rem;">
                ƒêang ch·ªçn: <strong id="selectedBankName" style="color: var(--primary);">...</strong>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">2. Th√¥ng tin nh·∫≠n ti·ªÅn</label>
            <input type="text" id="accountNumber" class="form-control" readonly placeholder="S·ªë t√†i kho·∫£n">
            <input type="text" id="fullName" class="form-control" readonly style="margin-top: 10px;" placeholder="T√™n ch·ªß t√†i kho·∫£n">
        </div>

        <div class="form-group">
            <label class="form-label">3. Nh·∫≠p s·ªë ti·ªÅn</label>
            <input type="text" id="amount" class="form-control" placeholder="0ƒë" oninput="formatCurrency(this)">
            <textarea id="transferContent" class="form-control" style="margin-top: 15px;" rows="2" placeholder="N·ªôi dung chuy·ªÉn kho·∫£n">Chuyen khoan</textarea>
        </div>

        <button class="btn-action" onclick="generateQR()"><i class="fas fa-magic"></i> T·∫†O M√É QR</button>
    </div>

    <div class="col-right">
        <label class="form-label">M√É QR C·ª¶A B·∫†N</label>
        <div class="qr-frame" id="qrFrame">
            <div id="qrLoader" style="display: none; flex-direction: column; align-items: center;">
                <div class="spinner"></div><br><small>ƒêang t·∫°o...</small>
            </div>
            <div id="qrPlaceholder" style="color: var(--text-sub); text-align: center;">
                <i class="fas fa-qrcode" style="font-size: 4rem; opacity: 0.2; margin-bottom: 15px;"></i>
                <p>Nh·∫≠p th√¥ng tin ƒë·ªÉ xem tr∆∞·ªõc</p>
            </div>
            <img id="qrImage" src="" alt="QR Code">
        </div>
        <button class="btn-action" onclick="downloadQR()" id="btnDownload" style="display:none;">
            <i class="fas fa-download"></i> T·∫£i ·∫£nh v·ªÅ
        </button>
    </div>
</div>

<!-- ADMIN PANEL WITH LOOKUP FEATURE -->
<div id="adminPanel">
    <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px;">
        <h2 style="color: var(--primary);"><i class="fas fa-link"></i> Qu·∫£n L√Ω & Li√™n K·∫øt Ng√¢n H√†ng</h2>
        <button onclick="document.getElementById('adminPanel').style.display='none'" style="border:none; background:none; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>

    <!-- FORM LI√äN K·∫æT -->
    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
        <select id="admBankSelect" class="form-control">
            <option value="">-- Ch·ªçn ng√¢n h√†ng --</option>
        </select>
        
        <!-- Khu v·ª±c nh·∫≠p v√† ki·ªÉm tra -->
        <div class="verify-box">
            <input type="text" id="admAccNum" class="form-control" placeholder="Nh·∫≠p S·ªë t√†i kho·∫£n">
            <button class="btn-verify" id="btnLookup" onclick="lookupBankAccount()">
                <i class="fas fa-search-dollar"></i> Ki·ªÉm tra t√™n
            </button>
        </div>

        <input type="text" id="admFullName" class="form-control" placeholder="T√™n ch·ªß TK (T·ª± ƒë·ªông ƒëi·ªÅn khi ki·ªÉm tra)">
        
        <select id="admStatus" class="form-control">
            <option value="active">üü¢ Hi·ªÉn th·ªã (Active)</option>
            <option value="maintenance">üî¥ B·∫£o tr√¨</option>
        </select>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn-action" id="btnSaveBank" onclick="saveBankToFirebase()">
            <i class="fas fa-save"></i> L∆∞u Ng√¢n H√†ng
        </button>
        <button class="btn-action btn-secondary" id="btnCancelEdit" onclick="cancelEditBank()" style="display: none; width: auto;">H·ªßy</button>
    </div>

    <!-- DANH S√ÅCH -->
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead style="background: var(--bg-input);">
            <tr>
                <th style="padding: 10px; text-align: left;">Ng√¢n h√†ng</th>
                <th style="padding: 10px; text-align: left;">Chi ti·∫øt</th>
                <th style="padding: 10px; text-align: right;">Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="adminTableBody"></tbody>
    </table>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
    /* ============================================================
       C·∫§U H√åNH API - THAY ƒê·ªîI TH√îNG TIN C·ª¶A B·∫†N T·∫†I ƒê√ÇY
    ============================================================ */
    // 1. Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110"
    };

    // 2. VietQR API Keys (ƒêƒÉng k√Ω t·∫°i my.vietqr.io ƒë·ªÉ l·∫•y)
    // N·∫øu ch∆∞a c√≥, t√≠nh nƒÉng "Ki·ªÉm tra t√™n" s·∫Ω b√°o l·ªói.
    const VIETQR_CLIENT_ID = "493f6415-eafb-45f3-9e33-ec2f95f4deae"; 
    const VIETQR_API_KEY = "140e9860-5b03-4a8d-aa15-6ba79bef92ce"; 

    // 3. Admin Config
    const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

    /* ============================================================ */

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    let USER_BANKS = [];
    let API_BANKS_LIST = [];
    let currentBank = null;
    let editingBankId = null;
    let qrBlobUrl = null;

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        initTheme();
        await fetchVietQRBanks();
        listenFirebaseBanks();
    });

    // --- THEME ---
    function initTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('themeIcon').className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }
    function toggleTheme() {
        const cur = document.documentElement.getAttribute('data-theme');
        const next = cur === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        document.getElementById('themeIcon').className = next === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }

    // --- DATA HANDLING ---
    async function fetchVietQRBanks() {
        try {
            const res = await fetch('https://api.vietqr.io/v2/banks');
            const data = await res.json();
            if(data.code === "00") {
                API_BANKS_LIST = data.data;
                populateAdminDropdown();
            }
        } catch(e) { console.error(e); }
    }

    function listenFirebaseBanks() {
        db.collection("banks").orderBy("createdAt", "desc").onSnapshot(snap => {
            USER_BANKS = [];
            snap.forEach(doc => USER_BANKS.push({id: doc.id, ...doc.data()}));
            document.getElementById('initialLoading').style.display = 'none';
            renderBankGrid();
            loadAdminTable();
            if(!currentBank && USER_BANKS.length) {
                const active = USER_BANKS.find(b => b.status === 'active');
                if(active) selectBank(active.id);
            }
        });
    }

    // --- UI RENDER ---
    function renderBankGrid(filter = "") {
        const grid = document.getElementById('bankGrid');
        grid.innerHTML = '';
        const list = filter ? USER_BANKS.filter(b => b.shortName.toLowerCase().includes(filter.toLowerCase())) : USER_BANKS;
        
        list.forEach(bank => {
            const div = document.createElement('div');
            const activeClass = (currentBank && currentBank.id === bank.id) ? 'active' : '';
            div.className = `bank-item ${activeClass}`;
            div.onclick = () => selectBank(bank.id);
            div.innerHTML = `<img src="${bank.logo}">`;
            grid.appendChild(div);
        });
    }

    function filterBanks() { renderBankGrid(document.getElementById('bankSearch').value); }

    function selectBank(id) {
        const bank = USER_BANKS.find(b => b.id === id);
        if(!bank) return;
        currentBank = bank;
        renderBankGrid(document.getElementById('bankSearch').value);
        
        document.getElementById('selectedBankName').innerText = bank.shortName + " - " + bank.name;
        document.getElementById('accountNumber').value = bank.acc;
        document.getElementById('fullName').value = bank.fullName;
        
        if(document.getElementById('amount').value) generateQR();
    }

    // --- QR GENERATE ---
    async function generateQR() {
        if(!currentBank) return showToast("Ch·ªçn ng√¢n h√†ng tr∆∞·ªõc!", "error");
        
        const amount = parseInt(document.getElementById('amount').value.replace(/,/g, ''));
        if(!amount) return showToast("Nh·∫≠p s·ªë ti·ªÅn!", "warning");

        const loader = document.getElementById('qrLoader');
        const img = document.getElementById('qrImage');
        const ph = document.getElementById('qrPlaceholder');
        const btn = document.getElementById('btnDownload');
        
        loader.style.display = 'flex';
        img.style.display = 'none';
        ph.style.display = 'none';
        btn.style.display = 'none';

        const content = document.getElementById('transferContent').value;
        const url = `https://img.vietqr.io/image/${currentBank.code}-${currentBank.acc}-compact2.jpg?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(currentBank.fullName)}`;

        try {
            const res = await fetch(url);
            const blob = await res.blob();
            qrBlobUrl = URL.createObjectURL(blob);
            img.src = qrBlobUrl;
            img.onload = () => {
                loader.style.display = 'none';
                img.style.display = 'block';
                img.classList.add('loaded');
                btn.style.display = 'flex';
            }
        } catch(e) {
            loader.style.display = 'none';
            ph.style.display = 'block';
            showToast("L·ªói t·∫£i QR", "error");
        }
    }

    function downloadQR() {
        if(!qrBlobUrl) return;
        const a = document.createElement('a');
        a.href = qrBlobUrl;
        a.download = `QR_${currentBank.shortName}.png`;
        a.click();
    }

    // --- ADMIN & LOOKUP FEATURE (T√çNH NƒÇNG M·ªöI) ---
    auth.onAuthStateChanged(user => {
        const isAdm = user && user.uid === ADMIN_UID;
        document.getElementById('btnLogin').style.display = isAdm ? 'none' : 'flex';
        document.getElementById('btnLogout').style.display = isAdm ? 'flex' : 'none';
        document.getElementById('adminPanel').style.display = isAdm ? 'block' : 'none';
    });

    function handleLogin() { auth.signInWithPopup(provider); }
    function handleLogout() { auth.signOut(); }

    function populateAdminDropdown() {
        const sel = document.getElementById('admBankSelect');
        API_BANKS_LIST.sort((a,b) => a.shortName.localeCompare(b.shortName));
        API_BANKS_LIST.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.id;
            opt.text = `${b.shortName} - ${b.name}`;
            sel.appendChild(opt);
        });
    }

    // üöÄ H√ÄM TRA C·ª®U T√ÄI KHO·∫¢N NG√ÇN H√ÄNG (LOOKUP)
    async function lookupBankAccount() {
        const bankId = document.getElementById('admBankSelect').value;
        const accNum = document.getElementById('admAccNum').value;
        const btn = document.getElementById('btnLookup');

        if (!bankId || !accNum) {
            return showToast("Vui l√≤ng ch·ªçn ng√¢n h√†ng v√† nh·∫≠p s·ªë TK!", "warning");
        }

        if (VIETQR_CLIENT_ID === "YOUR_CLIENT_ID_HERE") {
            return Swal.fire("Thi·∫øu API Key", "Vui l√≤ng c·∫≠p nh·∫≠t Client ID v√† API Key trong code ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y!", "error");
        }

        const selectedBank = API_BANKS_LIST.find(b => b.id == bankId);
        
        // UI Loading
        btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;"></div> ƒêang tra c·ª©u...';
        btn.disabled = true;

        try {
            const response = await fetch("https://api.vietqr.io/v2/lookup", {
                method: "POST",
                headers: {
                    "x-client-id": VIETQR_CLIENT_ID,
                    "x-api-key": VIETQR_API_KEY,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    bin: selectedBank.bin,
                    accountNumber: accNum,
                }),
            });

            const data = await response.json();
            
            if (data.code === "00") {
                // Th√†nh c√¥ng
                document.getElementById('admFullName').value = data.data.accountName;
                showToast(`ƒê√£ t√¨m th·∫•y: ${data.data.accountName}`, "success");
                Swal.fire("Th√†nh c√¥ng", `Ch·ªß t√†i kho·∫£n: <b>${data.data.accountName}</b>`, "success");
            } else {
                // Th·∫•t b·∫°i (Sai s·ªë TK ho·∫∑c l·ªói Bank)
                showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin t√†i kho·∫£n!", "error");
                Swal.fire("L·ªói", data.desc || "Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c t√†i kho·∫£n n√†y.", "error");
            }

        } catch (error) {
            console.error(error);
            showToast("L·ªói k·∫øt n·ªëi API", "error");
        } finally {
            btn.innerHTML = '<i class="fas fa-search-dollar"></i> Ki·ªÉm tra t√™n';
            btn.disabled = false;
        }
    }

    function saveBankToFirebase() {
        const bankId = document.getElementById('admBankSelect').value;
        const accNum = document.getElementById('admAccNum').value;
        const fullName = document.getElementById('admFullName').value;
        
        if(!bankId || !accNum || !fullName) return showToast("ƒêi·ªÅn ƒë·ªß th√¥ng tin!", "warning");

        const apiBank = API_BANKS_LIST.find(b => b.id == bankId);
        const data = {
            code: apiBank.code, bin: apiBank.bin, shortName: apiBank.shortName, 
            name: apiBank.name, logo: apiBank.logo, acc: accNum, 
            fullName: fullName.toUpperCase(), status: document.getElementById('admStatus').value,
            ...(editingBankId ? {} : {createdAt: firebase.firestore.FieldValue.serverTimestamp()})
        };

        const promise = editingBankId 
            ? db.collection("banks").doc(editingBankId).update(data)
            : db.collection("banks").add(data);

        promise.then(() => {
            showToast("ƒê√£ l∆∞u th√†nh c√¥ng!", "success");
            cancelEditBank();
        }).catch(e => showToast(e.message, "error"));
    }

    function loadAdminTable() {
        const tb = document.getElementById('adminTableBody');
        tb.innerHTML = '';
        USER_BANKS.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:10px;"><img src="${b.logo}" width="30"> ${b.shortName}</td>
                <td style="padding:10px;">${b.acc}<br><b>${b.fullName}</b></td>
                <td style="padding:10px; text-align:right;">
                    <button class="btn-secondary" onclick="startEdit('${b.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-secondary" style="background:var(--danger)" onclick="delBank('${b.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tb.appendChild(tr);
        });
    }

    function startEdit(id) {
        editingBankId = id;
        const b = USER_BANKS.find(x => x.id === id);
        const apiB = API_BANKS_LIST.find(x => x.bin === b.bin);
        if(apiB) document.getElementById('admBankSelect').value = apiB.id;
        document.getElementById('admAccNum').value = b.acc;
        document.getElementById('admFullName').value = b.fullName;
        document.getElementById('admStatus').value = b.status;
        document.getElementById('btnSaveBank').innerHTML = "C·∫≠p nh·∫≠t";
        document.getElementById('btnCancelEdit').style.display = 'inline-flex';
        document.getElementById('adminPanel').scrollIntoView({behavior:'smooth'});
    }

    function cancelEditBank() {
        editingBankId = null;
        document.getElementById('admBankSelect').value = "";
        document.getElementById('admAccNum').value = "";
        document.getElementById('admFullName').value = "";
        document.getElementById('btnSaveBank').innerHTML = '<i class="fas fa-save"></i> L∆∞u Ng√¢n H√†ng';
        document.getElementById('btnCancelEdit').style.display = 'none';
    }

    function delBank(id) {
        if(confirm("X√≥a ng√¢n h√†ng n√†y?")) db.collection("banks").doc(id).delete();
    }

    function formatCurrency(el) {
        let v = el.value.replace(/\D/g, '');
        el.value = v ? parseInt(v).toLocaleString('en-US') : '';
    }
    
    function showToast(msg, type="info") {
        Toastify({
            text: msg, duration: 3000, gravity: "top", position: "right",
            backgroundColor: type==="success"?"#1cc88a":(type==="error"?"#e74a3b":"#4e73df")
        }).showToast();
    }
</script>
</body>
</html>
