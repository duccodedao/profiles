<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P USDT Exchange | Professional Fintech</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind Config for Fintech Theme -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#00D632', // Fintech Green
                        secondary: '#1A1B23',
                        surface: '#242631',
                        accent: '#3B82F6',
                        danger: '#EF4444',
                        warning: '#F59E0B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Custom CSS -->
    <style>
        body {
            background-color: #0F1014;
            color: #E2E8F0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(36, 38, 49, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-panel {
            background: linear-gradient(145deg, rgba(36, 38, 49, 0.9), rgba(20, 21, 28, 0.9));
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0F1014;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #00D632 0%, #00A825 100%);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 214, 50, 0.4);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #242631 25%, #2d303e 50%, #242631 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="app-loader" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0F1014]">
        <div class="text-primary text-4xl animate-pulse">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </div>
    </div>

    <!-- Login View -->
    <div id="login-view" class="hidden min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <!-- Background Decor -->
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-primary/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-blue-500/10 rounded-full blur-[120px]"></div>

        <div class="glass-panel p-8 rounded-2xl w-full max-w-md text-center z-10 animate-fade-in">
            <div class="mb-6 flex justify-center">
                <div class="w-16 h-16 bg-primary/20 rounded-xl flex items-center justify-center text-primary text-3xl">
                    <i class="fa-solid fa-coins"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold mb-2">P2P Exchange</h1>
            <p class="text-gray-400 mb-8">Nền tảng mua bán USDT tự động, an toàn và nhanh chóng.</p>
            
            <button id="btn-login" class="w-full bg-white text-black font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-100 transition-colors shadow-lg">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                Đăng nhập với Google
            </button>
        </div>
    </div>

    <!-- Main App View -->
    <div id="main-view" class="hidden flex-1 flex flex-col md:flex-row h-screen overflow-hidden">
        
        <!-- Sidebar (Desktop) / Navbar (Mobile) -->
        <nav class="md:w-64 bg-secondary border-r border-white/5 flex-shrink-0 flex flex-col justify-between z-20">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <i class="fa-solid fa-bolt text-primary text-2xl"></i>
                    <span class="text-xl font-bold tracking-tight">Flash<span class="text-primary">USDT</span></span>
                </div>
                
                <div class="space-y-2">
                    <button onclick="router.navigate('buy')" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-400 hover:text-white hover:bg-white/5 transition-all active-nav" data-page="buy">
                        <i class="fa-solid fa-cart-shopping w-5"></i> Mua USDT
                    </button>
                    <button onclick="router.navigate('history')" class="nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-gray-400 hover:text-white hover:bg-white/5 transition-all" data-page="history">
                        <i class="fa-solid fa-clock-rotate-left w-5"></i> Lịch sử
                    </button>
                    <button id="admin-nav-btn" onclick="router.navigate('admin')" class="hidden nav-item w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 text-warning hover:bg-warning/10 transition-all" data-page="admin">
                        <i class="fa-solid fa-shield-halved w-5"></i> Admin Panel
                    </button>
                </div>
            </div>

            <div class="p-4 border-t border-white/5">
                <div class="flex items-center gap-3 mb-4 px-2">
                    <img id="user-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full border border-white/10">
                    <div class="overflow-hidden">
                        <p id="user-name" class="text-sm font-semibold truncate">User</p>
                        <p id="user-rank" class="text-xs text-primary">Bronze Member</p>
                    </div>
                </div>
                <button id="btn-logout" class="w-full py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i> Đăng xuất
                </button>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto relative bg-[#0F1014] p-4 md:p-8">
            <!-- Header Mobile -->
            <div class="md:hidden flex justify-between items-center mb-6">
                <span class="text-xl font-bold">Flash<span class="text-primary">USDT</span></span>
                <button id="mobile-menu-btn" class="text-gray-300"><i class="fa-solid fa-bars text-xl"></i></button>
            </div>

            <!-- Page: BUY USDT -->
            <div id="page-buy" class="page-content max-w-4xl mx-auto animate-fade-in">
                <h2 class="text-2xl font-bold mb-6">Mua USDT <span class="text-primary text-sm font-normal bg-primary/10 px-2 py-1 rounded ml-2">Live Rate</span></h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Config Form -->
                    <div class="md:col-span-2 space-y-6">
                        <div class="glass-panel p-6 rounded-2xl">
                            <div class="mb-4">
                                <label class="block text-gray-400 text-sm mb-2">Chọn mạng lưới (Network)</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <button class="network-opt p-3 rounded-xl border border-white/10 bg-white/5 hover:border-primary transition-all text-center text-sm font-medium active" data-net="TRC20">TRC20</button>
                                    <button class="network-opt p-3 rounded-xl border border-white/10 bg-white/5 hover:border-primary transition-all text-center text-sm font-medium" data-net="BEP20">BEP20</button>
                                    <button class="network-opt p-3 rounded-xl border border-white/10 bg-white/5 hover:border-primary transition-all text-center text-sm font-medium" data-net="ERC20">ERC20</button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-400 text-sm mb-2">Số lượng mua (USDT)</label>
                                <div class="relative">
                                    <input type="number" id="input-amount" class="w-full bg-[#1A1B23] border border-white/10 rounded-xl py-4 px-4 pr-16 text-xl font-bold focus:outline-none focus:border-primary transition-colors text-white placeholder-gray-600" placeholder="100">
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">USDT</span>
                                </div>
                                <div class="flex justify-between mt-2 text-xs">
                                    <span class="text-gray-500">Min: <span id="limit-min">--</span></span>
                                    <span class="text-gray-500">Max: <span id="limit-max">--</span></span>
                                </div>
                            </div>

                            <div class="bg-white/5 rounded-xl p-4 space-y-2 mb-6">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Tỷ giá hiện tại:</span>
                                    <span class="font-mono text-white" id="display-rate">Loading...</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Phí giao dịch (<span id="user-fee-percent">--</span>%):</span>
                                    <span class="font-mono text-red-400" id="display-fee">0 VND</span>
                                </div>
                                <div class="flex justify-between text-sm" id="tier-discount-row">
                                    <span class="text-warning"><i class="fa-solid fa-crown mr-1"></i>Giảm giá VIP:</span>
                                    <span class="font-mono text-primary" id="display-discount">-0 VND</span>
                                </div>
                                <div class="h-px bg-white/10 my-2"></div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-300 font-medium">Tổng thanh toán:</span>
                                    <span class="text-2xl font-bold text-primary" id="display-total">0 VND</span>
                                </div>
                            </div>

                            <button id="btn-create-order" class="w-full btn-gradient py-4 rounded-xl font-bold text-black text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-wallet mr-2"></i> Tạo giao dịch
                            </button>
                        </div>
                    </div>

                    <!-- Side Info -->
                    <div class="space-y-6">
                         <div class="glass p-6 rounded-2xl text-center">
                            <div class="w-16 h-16 bg-primary/20 rounded-full flex items-center justify-center mx-auto mb-3 text-primary text-2xl">
                                <i class="fa-solid fa-shield-halved"></i>
                            </div>
                            <h3 class="font-bold mb-1">Bảo mật tuyệt đối</h3>
                            <p class="text-xs text-gray-400">Giao dịch được kiểm duyệt bởi Admin.</p>
                        </div>

                        <div class="glass p-6 rounded-2xl">
                             <h3 class="font-bold mb-3 border-b border-white/10 pb-2">Hỗ trợ</h3>
                             <div id="support-links" class="space-y-3">
                                 <!-- Links injected by JS -->
                                 <div class="skeleton h-8 w-full rounded"></div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page: PAYMENT (Dynamic Overlay) -->
            <div id="payment-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                <div class="glass-panel w-full max-w-lg rounded-2xl p-6 relative animate-fade-in overflow-y-auto max-h-[90vh]">
                    <button onclick="ui.closePayment()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>

                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold">Thanh toán đơn hàng</h2>
                        <div class="text-sm text-yellow-500 mt-1 font-mono" id="pay-timer">15:00</div>
                    </div>

                    <div class="bg-white p-4 rounded-xl mb-6 mx-auto w-48 h-48 flex items-center justify-center">
                        <img id="pay-qr" src="" alt="QR Code" class="w-full h-full object-contain">
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="bg-white/5 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <div class="text-xs text-gray-400">Ngân hàng</div>
                                <div class="font-bold" id="pay-bank-name">--</div>
                            </div>
                            <button onclick="utils.copyText('pay-bank-name')" class="text-primary hover:text-white"><i class="fa-regular fa-copy"></i></button>
                        </div>
                        <div class="bg-white/5 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <div class="text-xs text-gray-400">Số tài khoản</div>
                                <div class="font-bold font-mono text-lg" id="pay-bank-num">--</div>
                            </div>
                            <button onclick="utils.copyText('pay-bank-num')" class="text-primary hover:text-white"><i class="fa-regular fa-copy"></i></button>
                        </div>
                        <div class="bg-white/5 p-3 rounded-lg flex justify-between items-center border border-primary/50 bg-primary/5">
                            <div>
                                <div class="text-xs text-primary font-semibold">Nội dung chuyển khoản (Bắt buộc)</div>
                                <div class="font-bold font-mono text-lg text-white" id="pay-content">--</div>
                            </div>
                            <button onclick="utils.copyText('pay-content')" class="text-primary hover:text-white"><i class="fa-regular fa-copy"></i></button>
                        </div>
                         <div class="bg-white/5 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <div class="text-xs text-gray-400">Số tiền</div>
                                <div class="font-bold font-mono text-xl text-primary" id="pay-amount">--</div>
                            </div>
                            <button onclick="utils.copyText('pay-amount', true)" class="text-primary hover:text-white"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>

                    <div id="pay-action-area">
                        <button onclick="ui.showConfirmForm()" class="w-full bg-primary hover:bg-green-600 text-black font-bold py-3 rounded-xl transition-colors">
                            Tôi đã chuyển tiền
                        </button>
                        <p class="text-center text-xs text-gray-500 mt-2">Chỉ nhấn khi đã chuyển khoản thành công</p>
                    </div>

                    <div id="pay-confirm-form" class="hidden space-y-4">
                        <div>
                            <label class="text-sm text-gray-400">Mã tham chiếu ngân hàng (Ref No)</label>
                            <input type="text" id="input-tx-ref" class="w-full bg-[#1A1B23] border border-white/10 rounded-lg p-3 text-white focus:border-primary focus:outline-none" placeholder="Ví dụ: 823123...">
                        </div>
                        <button id="btn-submit-payment" class="w-full btn-gradient py-3 rounded-xl font-bold text-black">
                            Xác nhận giao dịch
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page: HISTORY -->
            <div id="page-history" class="page-content hidden max-w-6xl mx-auto animate-fade-in">
                <h2 class="text-2xl font-bold mb-6">Lịch sử giao dịch</h2>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="glass p-4 rounded-xl">
                        <p class="text-gray-400 text-xs">Tổng đơn</p>
                        <p class="text-xl font-bold" id="stat-total-orders">0</p>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <p class="text-gray-400 text-xs">Thành công</p>
                        <p class="text-xl font-bold text-primary" id="stat-success">0</p>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <p class="text-gray-400 text-xs">Tổng Volume</p>
                        <p class="text-xl font-bold text-yellow-400" id="stat-volume">0 USDT</p>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <p class="text-gray-400 text-xs">Cấp bậc</p>
                        <p class="text-xl font-bold text-accent" id="stat-rank">Bronze</p>
                    </div>
                </div>

                <!-- Table -->
                <div class="glass-panel rounded-xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-white/5 text-gray-400 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">ID</th>
                                <th class="px-6 py-3">Thời gian</th>
                                <th class="px-6 py-3">Mạng</th>
                                <th class="px-6 py-3 text-right">USDT</th>
                                <th class="px-6 py-3 text-right">VND</th>
                                <th class="px-6 py-3 text-center">Trạng thái</th>
                                <th class="px-6 py-3 text-center">Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody id="history-list" class="divide-y divide-white/5">
                            <!-- JS injected -->
                        </tbody>
                    </table>
                    <div id="empty-history" class="text-center py-8 text-gray-500 hidden">
                        Chưa có giao dịch nào.
                    </div>
                </div>
            </div>

            <!-- Page: ADMIN -->
            <div id="page-admin" class="page-content hidden max-w-6xl mx-auto animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-warning">Admin Dashboard</h2>
                    <button onclick="admin.saveSettings()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition-colors">
                        <i class="fa-solid fa-save mr-2"></i> Lưu Cài Đặt
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Settings -->
                    <div class="glass-panel p-6 rounded-2xl lg:col-span-1 space-y-4 h-fit">
                        <h3 class="font-bold text-lg mb-4 border-b border-white/10 pb-2">Cấu hình hệ thống</h3>
                        
                        <div>
                            <label class="text-xs text-gray-400">Phí giao dịch (%)</label>
                            <input type="number" id="adm-fee" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="text-xs text-gray-400">Min (USDT)</label>
                                <input type="number" id="adm-min" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1">
                            </div>
                             <div>
                                <label class="text-xs text-gray-400">Max (USDT)</label>
                                <input type="number" id="adm-max" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Thời gian chờ (phút)</label>
                            <input type="number" id="adm-timer" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1">
                        </div>
                        
                        <div class="pt-4 border-t border-white/10">
                            <h4 class="font-bold text-sm mb-2">Thông tin ngân hàng</h4>
                            <input type="text" id="adm-bank-name" placeholder="Tên Ngân hàng" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1 mb-2">
                            <input type="text" id="adm-bank-acc" placeholder="Số tài khoản" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1 mb-2">
                            <input type="text" id="adm-bank-owner" placeholder="Chủ tài khoản" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1 mb-2">
                            <input type="text" id="adm-bank-qr" placeholder="Link ảnh QR" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-sm mt-1">
                        </div>

                         <div class="pt-4 border-t border-white/10">
                            <h4 class="font-bold text-sm mb-2">Liên hệ (JSON)</h4>
                            <textarea id="adm-contacts" rows="3" class="w-full bg-black/20 border border-white/10 rounded px-3 py-2 text-xs font-mono text-gray-300"></textarea>
                        </div>
                    </div>

                    <!-- Order Management -->
                    <div class="glass-panel p-6 rounded-2xl lg:col-span-2 min-h-[500px]">
                        <h3 class="font-bold text-lg mb-4 flex justify-between">
                            Quản lý đơn hàng 
                            <span class="text-xs font-normal bg-white/10 px-2 py-1 rounded cursor-pointer" onclick="admin.loadOrders()"><i class="fa-solid fa-rotate"></i> Refresh</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white/5 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-2">Order ID</th>
                                        <th class="px-4 py-2">User</th>
                                        <th class="px-4 py-2">USDT / VND</th>
                                        <th class="px-4 py-2">Status</th>
                                        <th class="px-4 py-2">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-order-list" class="divide-y divide-white/5">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- State Management ---
        const store = {
            user: null,
            isAdmin: false,
            settings: {
                fee: 2, // 2% default
                min: 10,
                max: 5000,
                timer: 15,
                bank: { name: 'Techcombank', acc: '1903333333', owner: 'ADMIN', qr: 'https://via.placeholder.com/200' },
                contacts: { "Telegram": "#", "Zalo": "#" }
            },
            currentRate: 25500, // Fallback rate
            selectedNet: 'TRC20',
            activeOrder: null,
            userOrders: []
        };

        // --- Utility Functions ---
        const utils = {
            formatVND: (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount),
            formatDate: (timestamp) => {
                if(!timestamp) return '';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString('vi-VN');
            },
            randomId: () => 'ORD-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
            copyText: (elementId, raw = false) => {
                const text = document.getElementById(elementId).innerText;
                const val = raw ? text.replace(/\D/g,'') : text; // raw for money
                navigator.clipboard.writeText(val).then(() => {
                    utils.showToast('Đã sao chép vào bộ nhớ tạm!', 'success');
                });
            },
            showToast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-600',
                    error: 'bg-red-600',
                    info: 'bg-blue-600'
                };
                const icon = type === 'success' ? 'fa-check' : (type === 'error' ? 'fa-triangle-exclamation' : 'fa-info-circle');
                
                toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-2xl mb-3 flex items-center gap-3 animate-fade-in min-w-[250px]`;
                toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${msg}</span>`;
                
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            playSound: (type) => {
                // Simple beep simulation or real file
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(type === 'success' ? 880 : 440, audioCtx.currentTime);
                oscillator.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.1);
            },
            calculateTier: (volume) => {
                if (volume >= 1000) return { name: 'VIP', discount: 20, color: 'text-yellow-400' };
                if (volume >= 500) return { name: 'Gold', discount: 10, color: 'text-yellow-200' };
                if (volume >= 100) return { name: 'Silver', discount: 5, color: 'text-gray-300' };
                return { name: 'Bronze', discount: 0, color: 'text-orange-400' };
            }
        };

        // --- Core Logic ---

        // 1. Auth Logic
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('app-loader');
            const loginView = document.getElementById('login-view');
            const mainView = document.getElementById('main-view');

            if (user) {
                store.user = user;
                
                // Check User/Save DB
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, { 
                        email: user.email, 
                        uid: user.uid, 
                        totalVolume: 0,
                        createdAt: serverTimestamp() 
                    });
                }
                
                // Check Admin
                const adminRef = doc(db, "Settings", "Admins", user.uid, "profile"); // Check within collection structure
                // Simplified: Check if doc exists in Settings/Admins/{uid}
                // Since prompt says UID in collection Settings/Admins/{uid}
                // We will check by trying to get a dummy doc or just logic by path.
                // Better: Have a collection "admins".
                // FOR THIS DEMO: I'll use a hardcoded logic or check a specific doc.
                // Let's assume there is a collection 'admins' with docID = uid
                const adminCheck = await getDoc(doc(db, "Settings/Admins/" + user.uid)); 
                if (adminCheck.exists()) {
                    store.isAdmin = true;
                    document.getElementById('admin-nav-btn').classList.remove('hidden');
                }

                // UI Updates
                document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('user-name').innerText = user.displayName;
                
                // Load System Settings
                await appLogic.loadSettings();
                
                // Fetch Price
                await appLogic.fetchPrice();
                
                // Listen to User Stats
                appLogic.listenUserStats();

                loginView.classList.add('hidden');
                mainView.classList.remove('hidden');
                router.navigate('buy');
            } else {
                store.user = null;
                loginView.classList.remove('hidden');
                mainView.classList.add('hidden');
            }
            loader.classList.add('hidden');
        });

        document.getElementById('btn-login').addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(err => utils.showToast(err.message, 'error'));
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        // 2. Router
        const router = {
            navigate: (page) => {
                document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`page-${page}`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('bg-white/5', 'text-white');
                    el.classList.add('text-gray-400');
                    if(el.dataset.page === page) {
                        el.classList.add('bg-white/5', 'text-white');
                        el.classList.remove('text-gray-400');
                    }
                });

                if(page === 'admin' && store.isAdmin) admin.loadOrders();
                if(page === 'history') appLogic.renderHistory();
                
                // Mobile menu close
                document.querySelector('nav').classList.add('hidden', 'md:flex'); // Reset mobile state
            }
        };

        // 3. App Logic
        const appLogic = {
            loadSettings: async () => {
                const docSnap = await getDoc(doc(db, "Settings", "Config"));
                if (docSnap.exists()) {
                    store.settings = { ...store.settings, ...docSnap.data() };
                }
                // Render Settings to UI
                document.getElementById('limit-min').innerText = store.settings.min;
                document.getElementById('limit-max').innerText = store.settings.max;
                document.getElementById('user-fee-percent').innerText = store.settings.fee;
                
                // Render Support Links
                const contactHtml = Object.entries(store.settings.contacts).map(([k, v]) => 
                    `<a href="${v}" target="_blank" class="block w-full text-center py-2 rounded border border-white/10 hover:bg-white/5 transition-colors text-sm">${k}</a>`
                ).join('');
                document.getElementById('support-links').innerHTML = contactHtml;
            },

            fetchPrice: async () => {
                try {
                    // Try fetch from public API
                    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=vnd');
                    const data = await res.json();
                    store.currentRate = data.tether.vnd;
                } catch (e) {
                    console.log("API Error, using fallback rate");
                    // Keep default 25500 if fail
                }
                document.getElementById('display-rate').innerText = `${utils.formatVND(store.currentRate)} / USDT`;
                appLogic.calcPrice();
            },

            listenUserStats: () => {
                const q = query(collection(db, "orders"), where("uid", "==", store.user.uid), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    store.userOrders = [];
                    let successCount = 0;
                    let totalVolume = 0;

                    snapshot.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        store.userOrders.push(data);
                        if (data.status === 'completed') {
                            successCount++;
                            totalVolume += data.amountUSDT;
                        }
                    });

                    // Update UI Stats
                    const tier = utils.calculateTier(totalVolume);
                    document.getElementById('user-rank').innerText = tier.name;
                    document.getElementById('user-rank').className = `text-xs font-bold ${tier.color}`;
                    
                    document.getElementById('stat-total-orders').innerText = store.userOrders.length;
                    document.getElementById('stat-success').innerText = successCount;
                    document.getElementById('stat-volume').innerText = totalVolume.toLocaleString() + ' USDT';
                    document.getElementById('stat-rank').innerText = tier.name;
                    document.getElementById('stat-rank').className = `text-xl font-bold ${tier.color}`;

                    // Update Discount Display in Buy Tab
                    store.userTier = tier;
                    if(document.getElementById('page-buy').classList.contains('hidden') === false) {
                         appLogic.calcPrice();
                    }
                    if(document.getElementById('page-history').classList.contains('hidden') === false) {
                         appLogic.renderHistory();
                    }
                });
            },

            calcPrice: () => {
                const amountInput = parseFloat(document.getElementById('input-amount').value) || 0;
                const basePrice = amountInput * store.currentRate;
                
                // Fee Logic
                const baseFeePercent = store.settings.fee;
                const discount = store.userTier ? store.userTier.discount : 0; // % discount on fee? or Fee reduction? 
                // Prompt: Silver -5%, Gold -10%. Assuming percentage of the fee.
                // Real Fee % = BaseFee * (1 - discount/100)
                
                const effectiveFeePercent = baseFeePercent * (1 - (discount/100));
                const feeAmount = basePrice * (effectiveFeePercent / 100);
                
                const total = basePrice + feeAmount;
                const discountAmount = (basePrice * (baseFeePercent/100)) - feeAmount;

                document.getElementById('display-fee').innerText = utils.formatVND(feeAmount);
                document.getElementById('display-discount').innerText = `-${utils.formatVND(discountAmount)} (${discount}%)`;
                document.getElementById('display-total').innerText = utils.formatVND(total);

                // Enable/Disable Button
                const btn = document.getElementById('btn-create-order');
                if (amountInput >= store.settings.min && amountInput <= store.settings.max) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            },

            createOrder: async () => {
                const amount = parseFloat(document.getElementById('input-amount').value);
                const basePrice = amount * store.currentRate;
                const discount = store.userTier ? store.userTier.discount : 0;
                const effectiveFeePercent = store.settings.fee * (1 - (discount/100));
                const fee = basePrice * (effectiveFeePercent / 100);
                const total = basePrice + fee;

                const orderData = {
                    uid: store.user.uid,
                    orderId: utils.randomId(),
                    network: store.selectedNet,
                    amountUSDT: amount,
                    priceVND: store.currentRate,
                    fee: fee,
                    totalVND: Math.round(total),
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    referenceCode: '', // User will fill
                    txHash: '', // User/Admin will fill
                };

                try {
                    const docRef = await addDoc(collection(db, "orders"), orderData);
                    store.activeOrder = { id: docRef.id, ...orderData };
                    ui.showPaymentModal();
                } catch (e) {
                    utils.showToast('Lỗi tạo đơn: ' + e.message, 'error');
                }
            },

            renderHistory: () => {
                const tbody = document.getElementById('history-list');
                tbody.innerHTML = '';
                
                if(store.userOrders.length === 0) {
                    document.getElementById('empty-history').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-history').classList.add('hidden');

                const statusMap = {
                    'pending': '<span class="px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 text-xs">Chờ thanh toán</span>',
                    'pending_confirm': '<span class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs">Đang xử lý</span>',
                    'completed': '<span class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs">Thành công</span>',
                    'failed': '<span class="px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs">Thất bại</span>',
                    'expired': '<span class="px-2 py-1 rounded bg-gray-500/20 text-gray-400 text-xs">Hết hạn</span>'
                };

                store.userOrders.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-white/5 transition-colors';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-mono text-xs">${order.orderId}</td>
                        <td class="px-6 py-4 text-xs text-gray-400">${utils.formatDate(order.createdAt)}</td>
                        <td class="px-6 py-4"><span class="bg-white/10 px-2 py-1 rounded text-xs">${order.network}</span></td>
                        <td class="px-6 py-4 text-right font-bold text-green-400">${order.amountUSDT}</td>
                        <td class="px-6 py-4 text-right font-mono">${order.totalVND.toLocaleString()}</td>
                        <td class="px-6 py-4 text-center">${statusMap[order.status] || order.status}</td>
                        <td class="px-6 py-4 text-center">
                            ${order.txHash ? `<a href="#" class="text-primary hover:underline text-xs" title="${order.txHash}">TX Hash</a>` : '--'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        };

        // 4. Admin Logic
        const admin = {
            saveSettings: async () => {
                if(!store.isAdmin) return;
                const newSettings = {
                    fee: parseFloat(document.getElementById('adm-fee').value),
                    min: parseFloat(document.getElementById('adm-min').value),
                    max: parseFloat(document.getElementById('adm-max').value),
                    timer: parseFloat(document.getElementById('adm-timer').value),
                    bank: {
                        name: document.getElementById('adm-bank-name').value,
                        acc: document.getElementById('adm-bank-acc').value,
                        owner: document.getElementById('adm-bank-owner').value,
                        qr: document.getElementById('adm-bank-qr').value
                    },
                    contacts: JSON.parse(document.getElementById('adm-contacts').value || '{}')
                };
                try {
                    await setDoc(doc(db, "Settings", "Config"), newSettings, { merge: true });
                    utils.showToast('Đã lưu cấu hình!', 'success');
                    store.settings = { ...store.settings, ...newSettings };
                } catch(e) {
                    utils.showToast('Lỗi lưu: ' + e.message, 'error');
                }
            },
            
            loadOrders: () => {
                const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    const tbody = document.getElementById('admin-order-list');
                    tbody.innerHTML = '';
                    snapshot.forEach(docSnap => {
                        const order = { id: docSnap.id, ...docSnap.data() };
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-white/5';
                        
                        // Action Buttons Logic
                        let actions = '';
                        if(order.status === 'pending_confirm') {
                            actions = `
                                <div class="flex gap-2">
                                    <button onclick="window.adminApprove('${order.id}')" class="bg-green-600 p-2 rounded text-xs hover:bg-green-500" title="Duyệt"><i class="fa-solid fa-check"></i></button>
                                    <button onclick="window.adminReject('${order.id}')" class="bg-red-600 p-2 rounded text-xs hover:bg-red-500" title="Từ chối"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            `;
                        } else {
                            actions = '<span class="text-gray-500 text-xs">--</span>';
                        }

                        // Ref Code highlight
                        const refDisplay = order.referenceCode ? `<div class="text-xs text-yellow-400 bg-yellow-400/10 px-1 rounded mt-1">Ref: ${order.referenceCode}</div>` : '';

                        tr.innerHTML = `
                            <td class="px-4 py-3">
                                <div class="font-mono text-xs font-bold">${order.orderId}</div>
                                <div class="text-[10px] text-gray-500">${utils.formatDate(order.createdAt)}</div>
                            </td>
                            <td class="px-4 py-3 text-xs">${order.uid.substr(0, 8)}...</td>
                            <td class="px-4 py-3">
                                <div class="font-bold text-green-400 text-sm">${order.amountUSDT} U</div>
                                <div class="font-mono text-xs text-gray-400">${order.totalVND.toLocaleString()} đ</div>
                                <div class="text-[10px] bg-white/10 inline-block px-1 rounded mt-1">${order.network}</div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="text-xs font-bold ${order.status === 'completed' ? 'text-green-500' : (order.status==='failed' ? 'text-red-500' : 'text-blue-400')}">
                                    ${order.status.toUpperCase()}
                                </span>
                                ${refDisplay}
                            </td>
                            <td class="px-4 py-3">${actions}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    // Populate Admin Form Inputs if empty
                    if(!document.getElementById('adm-fee').value) {
                         document.getElementById('adm-fee').value = store.settings.fee;
                         document.getElementById('adm-min').value = store.settings.min;
                         document.getElementById('adm-max').value = store.settings.max;
                         document.getElementById('adm-timer').value = store.settings.timer;
                         document.getElementById('adm-bank-name').value = store.settings.bank.name;
                         document.getElementById('adm-bank-acc').value = store.settings.bank.acc;
                         document.getElementById('adm-bank-owner').value = store.settings.bank.owner;
                         document.getElementById('adm-bank-qr').value = store.settings.bank.qr;
                         document.getElementById('adm-contacts').value = JSON.stringify(store.settings.contacts, null, 2);
                    }
                });
            }
        };

        // Window scope for onclick events in HTML string
        window.adminApprove = async (docId) => {
            const txHash = prompt("Nhập Transaction Hash (Blockchain):");
            if(txHash) {
                await updateDoc(doc(db, "orders", docId), {
                    status: 'completed',
                    txHash: txHash
                });
                utils.showToast('Đã duyệt đơn hàng!', 'success');
            }
        };

        window.adminReject = async (docId) => {
            if(confirm("Bạn có chắc muốn hủy đơn này?")) {
                await updateDoc(doc(db, "orders", docId), {
                    status: 'failed'
                });
                utils.showToast('Đã từ chối đơn hàng!', 'info');
            }
        };


        // 5. UI Helpers
        const ui = {
            showPaymentModal: () => {
                const modal = document.getElementById('payment-overlay');
                const order = store.activeOrder;
                
                // Populate Data
                document.getElementById('pay-bank-name').innerText = store.settings.bank.name;
                document.getElementById('pay-bank-num').innerText = store.settings.bank.acc;
                document.getElementById('pay-content').innerText = order.orderId; // Transfer content = OrderID
                document.getElementById('pay-amount').innerText = utils.formatVND(order.totalVND);
                document.getElementById('pay-qr').src = store.settings.bank.qr;
                
                // Reset View
                document.getElementById('pay-action-area').classList.remove('hidden');
                document.getElementById('pay-confirm-form').classList.add('hidden');
                document.getElementById('input-tx-ref').value = '';

                modal.classList.remove('hidden');

                // Timer
                let timeLeft = store.settings.timer * 60;
                const timerEl = document.getElementById('pay-timer');
                if(window.payInterval) clearInterval(window.payInterval);
                
                window.payInterval = setInterval(() => {
                    const m = Math.floor(timeLeft / 60);
                    const s = timeLeft % 60;
                    timerEl.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                    if(timeLeft <= 0) {
                        clearInterval(window.payInterval);
                        ui.closePayment();
                        utils.showToast('Đơn hàng đã hết hạn!', 'error');
                        // Logic update DB expired could be here
                    }
                    timeLeft--;
                }, 1000);
            },
            
            closePayment: () => {
                document.getElementById('payment-overlay').classList.add('hidden');
                if(window.payInterval) clearInterval(window.payInterval);
            },

            showConfirmForm: () => {
                document.getElementById('pay-action-area').classList.add('hidden');
                document.getElementById('pay-confirm-form').classList.remove('hidden');
            }
        };
        
        // Expose UI to window
        window.ui = ui;
        window.router = router;
        window.utils = utils;
        window.admin = admin;

        // --- Event Listeners ---
        
        // Input Amount Change
        document.getElementById('input-amount').addEventListener('input', appLogic.calcPrice);

        // Network Selection
        document.querySelectorAll('.network-opt').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.network-opt').forEach(b => b.classList.remove('active', 'border-primary', 'text-primary'));
                e.target.classList.add('active', 'border-primary', 'text-primary');
                store.selectedNet = e.target.dataset.net;
            });
        });

        // Create Order Button
        document.getElementById('btn-create-order').addEventListener('click', appLogic.createOrder);

        // Submit Payment
        document.getElementById('btn-submit-payment').addEventListener('click', async () => {
            const refCode = document.getElementById('input-tx-ref').value;
            if(!refCode) return utils.showToast('Vui lòng nhập mã tham chiếu!', 'error');

            try {
                await updateDoc(doc(db, "orders", store.activeOrder.id), {
                    status: 'pending_confirm',
                    referenceCode: refCode
                });
                utils.showToast('Đã gửi xác nhận. Vui lòng chờ Admin duyệt!', 'success');
                ui.closePayment();
                router.navigate('history');
            } catch (e) {
                utils.showToast('Lỗi: ' + e.message, 'error');
            }
        });

        // Mobile Menu
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            const nav = document.querySelector('nav');
            nav.classList.toggle('hidden');
            nav.classList.add('absolute', 'top-0', 'left-0', 'h-full', 'w-64');
        });

    </script>
</body>
</html>
