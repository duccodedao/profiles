<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrafficSnap - Bản đồ & Locket Giao Thông</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #ff9f1c; /* Cam Locket */
            --danger-color: #ff4444;
            --bg-glass: rgba(20, 20, 20, 0.85);
            --text-color: #ffffff;
        }

        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #000; color: white; }

        /* Fullscreen Map */
        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* Login Screen */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .login-btn {
            background: white; color: #333; padding: 12px 24px;
            border-radius: 30px; border: none; font-weight: bold; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; gap: 10px;
        }

        /* UI Overlay */
        .ui-layer {
            position: absolute; pointer-events: none;
            top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;
        }
        .interactive { pointer-events: auto; }

        /* Dashboard Info */
        .dashboard-top {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .speed-panel {
            background: var(--bg-glass);
            padding: 10px 20px; border-radius: 15px;
            backdrop-filter: blur(10px); text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .speed-val { font-size: 32px; font-weight: 800; color: var(--primary-color); }
        .speed-unit { font-size: 12px; color: #aaa; }

        /* User Info & Admin Badge */
        .user-panel {
            display: flex; flex-direction: column; align-items: flex-end; gap: 5px;
        }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-color); }
        .admin-badge { 
            background: var(--danger-color); font-size: 10px; padding: 2px 8px; 
            border-radius: 4px; display: none; /* Ẩn mặc định */
        }

        /* Camera Button (Locket Style) */
        .camera-container {
            position: absolute; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-snap {
            width: 70px; height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: transparent;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-snap::after {
            content: ''; position: absolute;
            top: 5px; left: 5px; right: 5px; bottom: 5px;
            background: var(--primary-color); border-radius: 50%;
        }
        .btn-snap:active { transform: scale(0.9); }

        /* Upload Status */
        #statusMsg {
            position: absolute; bottom: 110px; width: 100%;
            text-align: center; font-size: 14px; text-shadow: 0 1px 3px black;
            display: none;
        }

        /* Red Alert Effect */
        .alert-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 50px 20px red;
            display: none; pointer-events: none; z-index: 900;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* Hidden Input */
        #cameraInput { display: none; }

        /* Popup Image Style */
        .popup-img {
            width: 100%; max-width: 200px; border-radius: 10px; margin-top: 5px;
            border: 2px solid var(--primary-color);
        }
    </style>
</head>
<body>

    <!-- Màn hình Đăng nhập -->
    <div id="loginOverlay">
        <h1 style="color:var(--primary-color); margin-bottom: 30px;"><i class="fa-solid fa-camera-retro"></i> TrafficSnap</h1>
        <button class="login-btn" onclick="loginWithGoogle()">
            <i class="fa-brands fa-google"></i> Đăng nhập bằng Google
        </button>
    </div>

    <!-- Hiệu ứng cảnh báo -->
    <div id="alertEffect" class="alert-screen"></div>

    <!-- Bản đồ -->
    <div id="map"></div>

    <!-- Giao diện chính -->
    <div class="ui-layer">
        <div class="dashboard-top">
            <div class="speed-panel interactive">
                <div class="speed-val" id="speedEl">0</div>
                <div class="speed-unit">km/h</div>
            </div>
            
            <div class="user-panel interactive">
                <img id="userAvatar" class="avatar" src="" style="display:none;">
                <span id="adminLabel" class="admin-badge">ADMIN</span>
                <button id="logoutBtn" onclick="handleLogout()" style="display:none; background: #333; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-top: 5px;">Đăng xuất</button>
            </div>
        </div>

        <div id="statusMsg">Đang tải ảnh lên GitHub...</div>

        <div class="camera-container interactive">
            <!-- Nút chụp -->
            <div class="btn-snap" onclick="document.getElementById('cameraInput').click()"></div>
        </div>
    </div>

    <!-- Input file ẩn để chụp ảnh -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFileUpload(this)">

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, doc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        
        // Cấu hình Firebase (Theo yêu cầu của bạn)
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE", 
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };

        // Cấu hình GitHub (BẠN PHẢI TỰ ĐIỀN VÀO ĐÂY ĐỂ CHẠY)
        const GITHUB_CONFIG = {
            TOKEN: 'ghp_YOUR_GITHUB_TOKEN_HERE', // Thay bằng Token thật (bắt đầu bằng ghp_...)
            OWNER: 'YOUR_GITHUB_USERNAME',       // Tên user GitHub của bạn
            REPO: 'YOUR_REPO_NAME',              // Tên repo bạn đã tạo
            BRANCH: 'main'                       // Branch mặc định
        };

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let map, userMarker;
        let isAdmin = false;

        // --- 2. AUTHENTICATION & ADMIN CHECK ---

        window.loginWithGoogle = () => {
            signInWithPopup(auth, provider).catch(error => alert("Lỗi đăng nhập: " + error.message));
        };

        window.handleLogout = () => {
            signOut(auth).then(() => location.reload());
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('userAvatar').src = user.photoURL;
                document.getElementById('userAvatar').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';

                // Check Admin từ Firestore: settings -> admins
                await checkAdminRole(user);
                
                initMap(); // Khởi động bản đồ sau khi login
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        });

        async function checkAdminRole(user) {
            try {
                // Đọc document "admins" trong collection "settings"
                const docRef = doc(db, "settings", "admins");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Kiểm tra xem UID của user có nằm trong danh sách không
                    // Giả sử cấu trúc data là { "UID_CUA_ADMIN": "gmail@gmail.com" }
                    if (data[user.uid]) {
                        isAdmin = true;
                        document.getElementById('adminLabel').style.display = 'block';
                        console.log("Welcome Admin: " + user.email);
                    }
                }
            } catch (e) {
                console.error("Lỗi check admin:", e);
            }
        }

        // --- 3. MAP LOGIC & REALTIME ---

        function initMap() {
            // Khởi tạo map tại HCM (mặc định)
            map = L.map('map').setView([10.7769, 106.7009], 15);

            // Map nền tối (Dark mode)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap & CartoDB',
                maxZoom: 19
            }).addTo(map);

            // Theo dõi vị trí người dùng
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updatePosition, 
                    (err) => console.log("GPS Error", err), 
                    { enableHighAccuracy: true }
                );
            }

            // Lắng nghe dữ liệu báo cáo từ Firestore (Realtime)
            listenToReports();
        }

        function updatePosition(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const speed = pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0; // m/s -> km/h

            // Cập nhật giao diện tốc độ
            document.getElementById('speedEl').innerText = speed;

            // Di chuyển marker người dùng
            if (!userMarker) {
                const icon = L.divIcon({
                    html: '<i class="fa-solid fa-circle-dot" style="color:#4285F4; font-size: 20px; border: 2px solid white; border-radius: 50%;"></i>',
                    className: 'user-marker',
                    iconSize: [20, 20]
                });
                userMarker = L.marker([lat, lng], {icon: icon}).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                userMarker.setLatLng([lat, lng]);
            }

            // Logic cảnh báo đơn giản (Demo: Nếu tốc độ > 50km/h thì cảnh báo đỏ)
            if (speed > 50) {
                document.getElementById('alertEffect').style.display = 'block';
            } else {
                document.getElementById('alertEffect').style.display = 'none';
            }
        }

        function listenToReports() {
            // Lấy 50 báo cáo mới nhất
            const q = query(collection(db, "reports"), orderBy("timestamp", "desc"), limit(50));
            
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        addReportMarker(data);
                    }
                });
            });
        }

        function addReportMarker(data) {
            // Icon Camera
            const camIcon = L.divIcon({
                html: '<i class="fa-solid fa-camera" style="color:var(--primary-color); font-size: 24px; filter: drop-shadow(0 0 5px orange);"></i>',
                className: 'cam-icon',
                iconSize: [30, 30]
            });

            const marker = L.marker([data.lat, data.lng], {icon: camIcon}).addTo(map);
            
            // Popup hiển thị ảnh lấy từ GitHub (thông qua link raw hoặc cdn)
            // Lưu ý: data.imageUrl là link raw github userContent
            const popupContent = `
                <div style="text-align:center;">
                    <b>${data.userEmail}</b><br>
                    <small>${new Date(data.timestamp?.toDate()).toLocaleTimeString()}</small><br>
                    <img src="${data.imageUrl}" class="popup-img" alt="Loading...">
                </div>
            `;
            marker.bindPopup(popupContent);
        }

        // --- 4. GITHUB UPLOAD & CREATE REPORT ---

        window.handleFileUpload = async (input) => {
            const file = input.files[0];
            if (!file || !userMarker) return;

            const statusEl = document.getElementById('statusMsg');
            statusEl.style.display = 'block';
            statusEl.innerText = "Đang xử lý ảnh...";

            try {
                // 1. Convert ảnh sang Base64
                const base64Content = await toBase64(file);
                // Loại bỏ phần header "data:image/jpeg;base64,"
                const cleanBase64 = base64Content.split(',')[1];

                // 2. Upload lên GitHub thông qua API
                const fileName = `images/report_${Date.now()}.jpg`;
                const githubUrl = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/contents/${fileName}`;

                statusEl.innerText = "Đang đẩy lên GitHub...";
                
                const response = await fetch(githubUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "New traffic report",
                        content: cleanBase64,
                        branch: GITHUB_CONFIG.BRANCH
                    })
                });

                if (!response.ok) throw new Error("GitHub Upload Failed");
                
                const result = await response.json();
                // Lấy link raw để hiển thị (download_url)
                const rawUrl = result.content.download_url;

                // 3. Lưu thông tin vào Firestore
                statusEl.innerText = "Lưu dữ liệu...";
                const lat = userMarker.getLatLng().lat;
                const lng = userMarker.getLatLng().lng;

                await addDoc(collection(db, "reports"), {
                    lat: lat,
                    lng: lng,
                    imageUrl: rawUrl,
                    userUid: currentUser.uid,
                    userEmail: currentUser.email,
                    timestamp: serverTimestamp(),
                    type: "traffic_snap"
                });

                statusEl.innerText = "Thành công!";
                setTimeout(() => statusEl.style.display = 'none', 2000);

            } catch (error) {
                console.error(error);
                statusEl.innerText = "Lỗi: " + error.message;
                setTimeout(() => statusEl.style.display = 'none', 3000);
            }
        };

        // Hàm helper chuyển file sang base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

    </script>
</body>
</html>
