<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Your TG Journey</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Lora:ital,wght@1,400;1,600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --ton-blue: #0098EA;
            --text-main: #ffffff;
            --text-sub: #8E8E93;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* PROGRESS BAR */
        .progress-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: rgba(255,255,255,0.1); z-index: 100;
        }
        .progress-bar {
            height: 100%; width: 0%; background: var(--ton-blue);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px var(--ton-blue);
        }

        /* SLIDES */
        .slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            padding: 40px 24px; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            text-align: center;
        }
        .slide.active {
            opacity: 1; pointer-events: auto; transform: scale(1);
        }

        /* TYPOGRAPHY */
        h1 { font-family: 'Lora', serif; font-size: 32px; font-weight: 600; margin-bottom: 10px; font-style: italic; }
        .big-number { font-size: 48px; font-weight: 800; color: var(--ton-blue); margin: 20px 0; letter-spacing: -1px; }
        .description { font-size: 16px; color: var(--text-sub); line-height: 1.6; max-width: 300px; margin: 0 auto; }
        .points-badge {
            background: rgba(0, 152, 234, 0.15); color: var(--ton-blue);
            padding: 8px 16px; border-radius: 20px; font-weight: bold;
            margin-top: 15px; display: inline-block;
            border: 1px solid rgba(0, 152, 234, 0.3);
        }

        /* FOOTER ACTIONS */
        .bottom-action {
            position: fixed; bottom: 40px; left: 0; width: 100%;
            display: flex; justify-content: center; z-index: 50;
            flex-direction: column; align-items: center; gap: 15px;
        }
        .btn-next {
            background: white; color: black; border: none;
            padding: 16px 40px; border-radius: 30px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 20px rgba(255,255,255,0.2);
            transition: transform 0.2s;
            width: 80%; max-width: 300px;
        }
        .btn-next:active { transform: scale(0.95); }
        
        .powered-by { font-size: 10px; color: #444; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; gap: 8px; }
        .ton-logo { width: 16px; height: 16px; }

        /* ANIMATIONS */
        .fade-in-up { animation: fadeInUp 0.8s ease forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .delay-1 { animation-delay: 0.2s; }
        .delay-2 { animation-delay: 0.5s; }
        .delay-3 { animation-delay: 0.8s; }

        /* LEADERBOARD (Embed in Final Slide) */
        .lb-container {
            background: #111; border-radius: 16px; width: 100%; max-width: 350px;
            max-height: 200px; overflow-y: auto; margin-top: 20px;
            border: 1px solid #333; text-align: left;
        }
        .lb-item { padding: 12px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-size: 14px; }
        .lb-rank { color: #666; width: 25px; }
        .lb-score { color: var(--ton-blue); font-weight: bold; }

    </style>
</head>
<body>

    <div class="progress-container">
        <div class="progress-bar" id="progress"></div>
    </div>

    <!-- SLIDE 1: INTRO -->
    <div class="slide active" id="slide-1">
        <i class="fab fa-telegram fa-4x fade-in-up" style="color: white; margin-bottom: 30px;"></i>
        <h1 class="fade-in-up delay-1">The Digital Archives</h1>
        <p class="description fade-in-up delay-2">
            Mọi hành trình đều để lại dấu ấn.<br>Hãy xem lại dấu chân của bạn trên Telegram.
        </p>
    </div>

    <!-- SLIDE 2: THE ORIGIN (AGE) -->
    <div class="slide" id="slide-2">
        <div class="fade-in-up">CHƯƠNG I</div>
        <h1 class="fade-in-up">The Origin</h1>
        <div class="big-number fade-in-up delay-1" id="val-year">...</div>
        <p class="description fade-in-up delay-2" id="text-age">
            Bạn đã gia nhập dòng chảy này từ rất sớm. Một trong những người tiên phong.
        </p>
        <div class="points-badge fade-in-up delay-3" id="score-age">+0 PTS</div>
    </div>

    <!-- SLIDE 3: THE ELITE (PREMIUM) -->
    <div class="slide" id="slide-3">
        <div class="fade-in-up">CHƯƠNG II</div>
        <h1 class="fade-in-up">The Elite</h1>
        <div id="icon-premium" class="fade-in-up delay-1" style="font-size: 60px; margin: 20px 0;">
            <i class="fas fa-star" style="color: #333;"></i>
        </div>
        <p class="description fade-in-up delay-2" id="text-premium">
            Kiểm tra sự đóng góp của bạn cho hệ sinh thái Telegram.
        </p>
        <div class="points-badge fade-in-up delay-3" id="score-premium">+0 PTS</div>
    </div>

    <!-- SLIDE 4: THE IDENTITY (PROFILE) -->
    <div class="slide" id="slide-4">
        <div class="fade-in-up">CHƯƠNG III</div>
        <h1 class="fade-in-up">The Identity</h1>
        <img id="user-avatar" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid white; margin: 20px 0;" class="fade-in-up delay-1">
        <p class="description fade-in-up delay-2" id="text-identity">
            Danh tính của bạn đã được xác lập.<br><span style="color:white" id="user-username">@username</span>
        </p>
        <div class="points-badge fade-in-up delay-3" id="score-identity">+0 PTS</div>
    </div>

    <!-- SLIDE 5: FINALE -->
    <div class="slide" id="slide-5">
        <div class="fade-in-up">TỔNG KẾT</div>
        <h1 class="fade-in-up" style="font-size: 40px; color: var(--ton-blue);">TOTAL SCORE</h1>
        <div class="big-number fade-in-up delay-1" id="final-score" style="font-size: 60px;">0</div>
        <p class="description fade-in-up delay-2">
            Cảm ơn bạn đã đồng hành cùng Telegram & TON Foundation.
        </p>
        
        <!-- Mini Leaderboard -->
        <div class="lb-container fade-in-up delay-3" id="lb-box">
            <div style="padding:10px; color:#555; text-align:center; font-size:12px">TOP SUPPORTERS</div>
            <div id="lb-content">Loading...</div>
        </div>
    </div>

    <!-- BUTTONS -->
    <div class="bottom-action">
        <button class="btn-next" id="btn-action" onclick="nextSlide()">Bắt đầu</button>
        <div class="powered-by">
            Supported by 
            <img src="https://ton.org/download/ton_symbol.png" class="ton-logo"> 
            TON
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // APP STATE
        let currentSlide = 1;
        const totalSlides = 5;
        let userData = null;
        let calculatedScores = { age: 0, premium: 0, identity: 0, total: 0 };
        let joinYear = 2024;

        // INIT
        async function init() {
            tg.expand();
            tg.setHeaderColor('#000000');
            
            // Get User
            let user = tg.initDataUnsafe.user;
            if(!user) user = { id: 139000000, first_name: "Test", username: "tester", is_premium: true, photo_url: "https://via.placeholder.com/100" }; // Mock
            userData = user;

            // Pre-calculate Data
            calculateData(user);
        }

        function calculateData(user) {
            // 1. AGE Calculation (Approximate based on ID)
            // Telegram ID ranges: 
            // < 100M: ~2014-2016
            // < 500M: ~2017-2019
            // < 1B: ~2020-2021
            // > 5B: 2023-2024
            const id = user.id;
            
            if(id < 100000000) joinYear = 2015;
            else if(id < 300000000) joinYear = 2017;
            else if(id < 1000000000) joinYear = 2020;
            else if(id < 5000000000) joinYear = 2022;
            else joinYear = 2024;

            // Score Formula
            calculatedScores.age = Math.floor((7000000000 - id) / 500000); 
            if(calculatedScores.age < 100) calculatedScores.age = 100;

            // 2. Premium
            if(user.is_premium) calculatedScores.premium = 5000;

            // 3. Identity
            if(user.username) calculatedScores.identity += 500;
            if(user.photo_url) calculatedScores.identity += 300;
            if(user.last_name) calculatedScores.identity += 200;

            calculatedScores.total = calculatedScores.age + calculatedScores.premium + calculatedScores.identity;

            // Render static elements
            document.getElementById('val-year').innerText = `Năm ${joinYear}`;
            document.getElementById('score-age').innerText = `+${calculatedScores.age.toLocaleString()} PTS`;
            
            if(user.is_premium) {
                document.getElementById('icon-premium').innerHTML = '<i class="fas fa-star" style="color: #FFD700; text-shadow: 0 0 20px #FFD700;"></i>';
                document.getElementById('text-premium').innerText = "Bạn là người dùng Premium. Cảm ơn sự đóng góp của bạn.";
                document.getElementById('score-premium').innerText = `+${calculatedScores.premium.toLocaleString()} PTS`;
            } else {
                document.getElementById('text-premium').innerText = "Bạn đang sử dụng gói tiêu chuẩn.";
                document.getElementById('score-premium').innerText = "+0 PTS";
            }

            if(user.photo_url) document.getElementById('user-avatar').src = user.photo_url;
            document.getElementById('user-username').innerText = user.username ? `@${user.username}` : user.first_name;
            document.getElementById('score-identity').innerText = `+${calculatedScores.identity.toLocaleString()} PTS`;
        }

        // NAVIGATION LOGIC
        window.nextSlide = async () => {
            if(currentSlide >= totalSlides) {
                // Đã ở slide cuối -> Action là Mời bạn bè
                inviteFriend();
                return;
            }

            tg.HapticFeedback.impactOccurred('medium');

            // Hide current
            document.getElementById(`slide-${currentSlide}`).classList.remove('active');
            
            // Increment
            currentSlide++;
            
            // Update Progress
            const progressPct = ((currentSlide - 1) / (totalSlides - 1)) * 100;
            document.getElementById('progress').style.width = `${progressPct}%`;

            // Show next
            const nextEl = document.getElementById(`slide-${currentSlide}`);
            nextEl.classList.add('active');

            // Logic per slide
            const btn = document.getElementById('btn-action');
            
            if (currentSlide === 5) {
                // Final Slide Logic
                btn.style.display = 'none'; // Tạm ẩn nút để load
                await saveToFirebase();
                animateScore(calculatedScores.total);
                loadLeaderboard();
                
                btn.innerText = "Mời bạn bè";
                btn.style.background = "#0098EA";
                btn.style.color = "white";
                btn.style.display = 'block';
            } else {
                btn.innerText = "Tiếp tục";
            }
        };

        async function saveToFirebase() {
            try {
                const userRef = doc(db, "users", userData.id.toString());
                
                // Check refer
                const startParam = tg.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('ref_')) {
                    const refId = startParam.split('_')[1];
                    if (refId && refId !== userData.id.toString()) {
                         // Logic cộng ref (chỉ làm 1 lần nếu cần, ở đây update đè cũng ko sao)
                         const refUser = doc(db, "users", refId);
                         await updateDoc(refUser, { referralCount: increment(1) }).catch(()=>{});
                    }
                }

                await setDoc(userRef, {
                    id: userData.id,
                    firstName: userData.first_name,
                    username: userData.username || "",
                    score: calculatedScores.total,
                    isPremium: userData.is_premium || false,
                    lastSeen: serverTimestamp()
                }, { merge: true });

            } catch (e) {
                console.error(e);
            }
        }

        function animateScore(target) {
            let current = 0;
            const el = document.getElementById('final-score');
            const step = Math.ceil(target / 50);
            
            const timer = setInterval(() => {
                current += step;
                if(current >= target) {
                    current = target;
                    clearInterval(timer);
                    tg.HapticFeedback.notificationOccurred('success');
                }
                el.innerText = current.toLocaleString();
            }, 20);
        }

        async function loadLeaderboard() {
            const box = document.getElementById('lb-content');
            try {
                const q = query(collection(db, "users"), orderBy("score", "desc"), limit(5));
                const snap = await getDocs(q);
                let html = '';
                let i = 1;
                snap.forEach(doc => {
                    const u = doc.data();
                    html += `
                        <div class="lb-item">
                            <div><span class="lb-rank">#${i}</span> ${u.firstName}</div>
                            <div class="lb-score">${u.score.toLocaleString()}</div>
                        </div>
                    `;
                    i++;
                });
                box.innerHTML = html;
            } catch(e) {
                box.innerHTML = "Leaderboard loading...";
            }
        }

        window.inviteFriend = () => {
            const link = `https://t.me/YOUR_BOT_USERNAME?start=ref_${userData.id}`;
            const msg = `My TG Journey Score: ${calculatedScores.total}. What is yours?`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(msg)}`;
            tg.openTelegramLink(url);
        };

        // Run
        init();

    </script>
</body>
</html>
