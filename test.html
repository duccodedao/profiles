<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Legacy</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --accent: #0088cc; /* TG Blue */
            --accent-glow: rgba(0, 136, 204, 0.4);
            --text-main: #ffffff;
            --text-dim: #555555;
            --font-head: 'Syncopate', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-body);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- 1. BLOCKED SCREEN (WEB ACCESS) --- */
        #blocked-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: #050505;
            display: none; /* JS will toggle this */
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .lock-icon { font-size: 50px; color: #ff3333; margin-bottom: 20px; }
        .blocked-title { font-family: var(--font-head); font-weight: 700; margin-bottom: 10px; color: #ff3333; }

        /* --- 2. LOADING SCREEN --- */
        #loader {
            position: fixed; inset: 0; z-index: 5000;
            background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .pulse-ring {
            width: 80px; height: 80px; border-radius: 50%;
            border: 2px solid var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            animation: pulse 2s infinite;
            display: flex; align-items: center; justify-content: center;
        }
        .pulse-ring i { font-size: 30px; color: var(--accent); }
        .loading-text {
            margin-top: 20px; font-family: var(--font-head); font-size: 12px; letter-spacing: 3px;
            color: var(--accent); animation: blink 1s infinite;
        }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(0,136,204, 0.7);} 70% {box-shadow: 0 0 0 20px rgba(0,136,204, 0);} 100% {box-shadow: 0 0 0 0 rgba(0,136,204, 0);} }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* --- 3. STORY SLIDES --- */
        #story-container {
            position: relative; width: 100%; height: 100%;
            display: none; /* Active via JS */
        }
        .slide {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
            opacity: 0; pointer-events: none; transform: translateY(20px);
            transition: 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .slide.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        
        .slide-subtitle { font-size: 10px; letter-spacing: 4px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 15px; }
        .slide-title { font-family: var(--font-head); font-size: 28px; font-weight: 700; margin-bottom: 20px; text-transform: uppercase; line-height: 1.2; }
        .slide-desc { color: #888; font-size: 14px; line-height: 1.6; max-width: 300px; }
        .highlight { color: var(--accent); font-weight: bold; }

        /* --- 4. DASHBOARD (FINAL RESULT) --- */
        #dashboard {
            display: none; /* Active via JS */
            flex-direction: column; align-items: center; justify-content: center;
            height: 100%; padding: 20px;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
        }
        
        .rank-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px 20px;
            width: 100%; max-width: 340px;
            text-align: center;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .score-val { font-family: var(--font-head); font-size: 48px; color: var(--text-main); margin: 10px 0; text-shadow: 0 0 20px var(--accent-glow); }
        .score-lbl { font-size: 12px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
        
        .rank-badge {
            display: inline-flex; align-items: center; gap: 10px;
            background: #1a1a1a; padding: 8px 16px; border-radius: 30px;
            border: 1px solid #333; margin-top: 15px;
        }
        .rank-num { color: var(--accent); font-weight: bold; font-family: var(--font-head); }

        .btn-main {
            background: var(--text-main); color: #000;
            border: none; padding: 16px 32px; border-radius: 12px;
            font-weight: 600; font-size: 16px; width: 100%; max-width: 300px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-story { background: var(--accent); color: white; box-shadow: 0 0 20px var(--accent-glow); }

        /* Fade effects */
        .fade-in { animation: fadeIn 1s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <!-- 1. BLOCKED (For Web Browsers) -->
    <div id="blocked-screen">
        <div class="lock-icon"><i class="fas fa-lock"></i></div>
        <div class="blocked-title">ACCESS DENIED</div>
        <p style="color: #666; font-size: 14px;">This application only runs inside the Telegram secure environment.</p>
        <a href="https://t.me/YOUR_BOT_USERNAME" style="color: var(--accent); margin-top: 20px; text-decoration: none;">Open Telegram Bot</a>
    </div>

    <!-- 2. LOADER -->
    <div id="loader">
        <div class="pulse-ring"><i class="fab fa-telegram-plane"></i></div>
        <div class="loading-text">ESTABLISHING UPLINK...</div>
    </div>

    <!-- 3. STORY MODE -->
    <div id="story-container">
        <!-- Slide 1 -->
        <div class="slide active" id="slide-1">
            <div class="slide-subtitle">Chapter I</div>
            <div class="slide-title">The<br>Beginning</div>
            <p class="slide-desc">You joined the network in <span class="highlight" id="year-text">...</span>. A true pioneer of the digital age.</p>
            <button class="btn-main" style="margin-top: 30px; width: auto;" onclick="nextSlide(2)">Continue</button>
        </div>
        <!-- Slide 2 -->
        <div class="slide" id="slide-2">
            <div class="slide-subtitle">Chapter II</div>
            <div class="slide-title">Status<br>Check</div>
            <div id="prem-icon" style="font-size: 50px; margin: 20px 0; color: #333;"><i class="fas fa-star"></i></div>
            <p class="slide-desc" id="prem-text">Analyzing your contribution tier...</p>
            <button class="btn-main" style="margin-top: 30px; width: auto;" onclick="finishStory()">Reveal Results</button>
        </div>
    </div>

    <!-- 4. DASHBOARD (RESULT) -->
    <div id="dashboard">
        <div class="slide-subtitle">ANALYSIS COMPLETE</div>
        
        <div class="rank-card">
            <div class="score-lbl">Total Contribution</div>
            <div class="score-val" id="final-score">0</div>
            
            <div class="rank-badge">
                <span style="color: #666; font-size: 10px;">GLOBAL RANK</span>
                <span class="rank-num" id="my-rank">CALCULATING...</span>
            </div>
            
            <div style="margin-top: 20px; font-size: 12px; color: #555; border-top: 1px solid #222; padding-top: 10px;">
                <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                    <span>ID Tier</span> <span style="color:white" id="res-age">---</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Premium</span> <span style="color:white" id="res-prem">---</span>
                </div>
            </div>
        </div>

        <button class="btn-main btn-story" onclick="shareStory()">
            <i class="fas fa-share-alt"></i> Share Result
        </button>
        <div style="font-size: 10px; color: #333; margin-top: 20px;">TG LEGACY v1.0</div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, query, where, getCountFromServer, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // STATE
        let currentUser = null;
        let scoreData = { total: 0, age: 0, premium: 0 };

        // --- CORE LOGIC ---

        function init() {
            // 1. SECURITY CHECK (No Web Access)
            // Telegram WebApp platform is 'unknown' if opened in standard browser without initData
            if (!tg.initData) {
                document.getElementById('blocked-screen').style.display = 'flex';
                document.getElementById('loader').style.display = 'none';
                return; // STOP EXECUTION
            }

            tg.expand();
            tg.setHeaderColor('#000000');
            
            currentUser = tg.initDataUnsafe.user;
            // Only for dev testing (Remove in production if strict)
            // if (!currentUser) currentUser = { id: 123456, first_name: "Dev", username: "dev", is_premium: true };

            if (!currentUser) {
                document.getElementById('blocked-screen').style.display = 'flex';
                return;
            }

            // Calculate Score Locally first
            calculateScore();

            // Check DB
            checkUserStatus();
        }

        function calculateScore() {
            // Age Score
            const id = currentUser.id;
            let year = 2024;
            let agePts = 100;

            if (id < 100000000) { year = 2015; agePts = 5000; }
            else if (id < 500000000) { year = 2018; agePts = 3000; }
            else if (id < 1500000000) { year = 2020; agePts = 1500; }
            else if (id < 5000000000) { year = 2022; agePts = 500; }

            // Premium
            const premPts = currentUser.is_premium ? 5000 : 0;
            const userPts = currentUser.username ? 500 : 0;

            scoreData = {
                year: year,
                age: agePts,
                premium: premPts,
                total: agePts + premPts + userPts
            };

            // Prep UI Text
            document.getElementById('year-text').innerText = year;
            document.getElementById('res-age').innerText = `+${agePts}`;
            document.getElementById('res-prem').innerText = currentUser.is_premium ? "YES (+5000)" : "NO";
            
            if(currentUser.is_premium) {
                document.getElementById('prem-icon').innerHTML = '<i class="fas fa-star" style="color:#ffd700; text-shadow:0 0 15px #ffd700"></i>';
                document.getElementById('prem-text').innerText = "Verified Premium Member. Maximum Tier.";
            } else {
                document.getElementById('prem-text').innerText = "Standard Member.";
            }
        }

        async function checkUserStatus() {
            try {
                const userRef = doc(db, "users", currentUser.id.toString());
                const snap = await getDoc(userRef);

                // Simulate network delay for effect
                setTimeout(async () => {
                    document.getElementById('loader').style.display = 'none';

                    if (snap.exists() && snap.data().isAnalyzed) {
                        // USER EXISTS & DONE STORY -> JUMP TO DASHBOARD
                        showDashboard(true);
                    } else {
                        // NEW USER -> START STORY
                        document.getElementById('story-container').style.display = 'block';
                    }
                }, 1500);

            } catch (e) {
                console.error(e);
                alert("Connection Error");
            }
        }

        // --- STORY NAVIGATION ---

        window.nextSlide = (slideNum) => {
            tg.HapticFeedback.selectionChanged();
            document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
            document.getElementById(`slide-${slideNum}`).classList.add('active');
        };

        window.finishStory = async () => {
            tg.HapticFeedback.notificationOccurred('success');
            
            // Save to DB
            const userRef = doc(db, "users", currentUser.id.toString());
            await setDoc(userRef, {
                id: currentUser.id,
                firstName: currentUser.first_name,
                username: currentUser.username || "",
                score: scoreData.total,
                isPremium: currentUser.is_premium || false,
                isAnalyzed: true, // Marker to skip story next time
                lastActive: serverTimestamp()
            }, { merge: true });

            showDashboard(false);
        };

        // --- DASHBOARD & RANK LOGIC ---

        function showDashboard(isInstant) {
            document.getElementById('story-container').style.display = 'none';
            const dash = document.getElementById('dashboard');
            dash.style.display = 'flex';
            if(!isInstant) dash.classList.add('fade-in');

            // Animate Score
            const scoreEl = document.getElementById('final-score');
            scoreEl.innerText = scoreData.total.toLocaleString(); // Static update
            
            // Calculate Rank
            calculateRank();
        }

        async function calculateRank() {
            // Count users with score > my score
            try {
                const coll = collection(db, "users");
                const q = query(coll, where("score", ">", scoreData.total));
                const snapshot = await getCountFromServer(q);
                const count = snapshot.data().count;
                
                // My Rank = count + 1
                const myRank = count + 1;
                document.getElementById('my-rank').innerText = `#${myRank}`;
                
            } catch (e) {
                document.getElementById('my-rank').innerText = "N/A";
                console.log("Rank Error (requires Index):", e);
            }
        }

        // --- SHARE ---

        window.shareStory = () => {
            const link = `https://t.me/YOUR_BOT_NAME`;
            const text = `I just analyzed my Telegram Legacy. \nüèÜ Global Rank: ${document.getElementById('my-rank').innerText}\n‚≠ê Score: ${scoreData.total}\nCheck yours now:`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
            tg.openTelegramLink(url);
        };

        // RUN
        init();

    </script>
</body>
</html>
