<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Analyzer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0e1621;
            --card-bg: #17212b;
            --text-primary: #ffffff;
            --text-secondary: #828a95;
            --accent: #2b95ff; /* Telegram Blue */
            --accent-glow: rgba(43, 149, 255, 0.4);
            --premium: #a665f5;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading / Scanning Effect */
        #scan-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Roboto Mono', monospace;
        }
        .scan-line {
            width: 80%; height: 2px; background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            animation: scan 1.5s infinite alternate;
        }
        .scan-text { margin-top: 20px; color: var(--accent); font-size: 14px; }
        @keyframes scan { from { transform: scaleX(0.2); } to { transform: scaleX(1); } }

        /* Main UI */
        .container { width: 100%; max-width: 420px; display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .logo-area { text-align: center; margin-bottom: 20px; }
        .logo-circle {
            width: 80px; height: 80px; background: var(--accent);
            border-radius: 50%; margin: 0 auto 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; color: white;
            box-shadow: 0 0 30px var(--accent-glow);
        }

        /* Score Card */
        .score-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .score-title { color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .score-value { font-size: 48px; font-weight: 800; margin: 10px 0; color: var(--text-primary); }
        .score-rank { display: inline-block; padding: 4px 12px; border-radius: 20px; background: rgba(255,255,255,0.1); font-size: 12px; }

        /* Details List */
        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: var(--text-secondary); font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .detail-val { font-weight: bold; font-family: 'Roboto Mono', monospace; }
        .premium-text { color: var(--premium); text-shadow: 0 0 10px rgba(166, 101, 245, 0.4); }

        /* Referral & Buttons */
        .invite-card {
            background: linear-gradient(135deg, #17212b, #1f2c3a);
            border-radius: 16px; padding: 20px;
            margin-bottom: 25px; text-align: center;
            border: 1px solid rgba(43, 149, 255, 0.2);
        }
        .invite-btn {
            background: var(--accent); color: white; border: none;
            padding: 14px; width: 100%; border-radius: 10px;
            font-weight: bold; font-size: 16px; cursor: pointer;
            margin-top: 15px; box-shadow: 0 5px 15px var(--accent-glow);
        }
        .invite-btn:active { transform: scale(0.98); }

        /* Leaderboard */
        .leaderboard-section { margin-top: 20px; }
        .lb-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .lb-item {
            background: var(--card-bg); padding: 15px; border-radius: 10px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .lb-user { display: flex; align-items: center; gap: 10px; }
        .lb-avatar { width: 32px; height: 32px; border-radius: 50%; background: #333; }
        .lb-count { color: var(--accent); font-weight: bold; font-family: 'Roboto Mono'; }
        
        /* Language badge */
        .lang-badge { position: absolute; top: 15px; right: 15px; font-size: 10px; opacity: 0.5; }
    </style>
</head>
<body>

    <!-- Màn hình quét -->
    <div id="scan-screen">
        <i class="fab fa-telegram fa-3x" style="color: var(--accent); margin-bottom: 20px;"></i>
        <div class="scan-line"></div>
        <div class="scan-text" id="scan-status">INITIALIZING...</div>
    </div>

    <!-- Giao diện chính -->
    <div class="container" id="main-app">
        <div class="lang-badge" id="lang-display">EN</div>
        
        <div class="logo-area">
            <div class="logo-circle">TG</div>
            <h2 id="welcome-text">Account Analyzer</h2>
        </div>

        <div class="score-card">
            <div class="score-title" id="lbl-total-score">Điểm cống hiến</div>
            <div class="score-value" id="user-score">0</div>
            <div class="score-rank" id="account-rank">Newbie</div>
            
            <div style="margin-top: 20px; text-align: left;">
                <div class="detail-row">
                    <div class="detail-label"><i class="fas fa-id-card"></i> <span id="lbl-id">ID Telegram</span></div>
                    <div class="detail-val" id="val-id">---</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label"><i class="fas fa-hourglass-half"></i> <span id="lbl-age">Tuổi thọ</span></div>
                    <div class="detail-val" id="val-age">+0 PTS</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label"><i class="fas fa-star"></i> Premium</div>
                    <div class="detail-val" id="val-premium">NO</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label"><i class="fas fa-language"></i> <span id="lbl-lang">Ngôn ngữ</span></div>
                    <div class="detail-val" id="val-lang">---</div>
                </div>
            </div>
        </div>

        <div class="invite-card">
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 5px;" id="lbl-invite-desc">
                Mời bạn bè để leo Top Leader
            </div>
            <div style="font-size: 24px; font-weight: bold; color: white;">
                <span id="ref-count">0</span> <span style="font-size: 14px; font-weight: normal; color: #888;">Refs</span>
            </div>
            <button class="invite-btn" onclick="inviteFriend()" id="btn-invite">Mời bạn bè</button>
        </div>

        <div class="leaderboard-section">
            <div class="lb-title">
                <i class="fas fa-trophy" style="color: gold;"></i> <span id="lbl-top">Top Leaders</span>
            </div>
            <div id="lb-list">
                <!-- Javascript will load this -->
                <div style="text-align: center; color: #555; font-size: 12px;">Loading top inviters...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. Cấu hình
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // 2. Ngôn ngữ (Language Dictionary)
        const translations = {
            vi: {
                welcome: "Phân Tích Tài Khoản",
                totalScore: "ĐIỂM CỐNG HIẾN",
                id: "ID Telegram",
                age: "Độ lâu đời",
                premium: "Premium",
                lang: "Ngôn ngữ",
                inviteDesc: "Mời bạn bè để đua Top Leader",
                btnInvite: "Mời Bạn Bè Ngay",
                top: "Top Trùm Mời",
                scanning: "ĐANG QUÉT DỮ LIỆU...",
                rankNew: "Người Mới",
                rankOld: "Lão Làng",
                rankOG: "Huyền Thoại",
                refSuccess: "Đã ghi nhận người giới thiệu!"
            },
            en: {
                welcome: "Account Analyzer",
                totalScore: "TG SCORE",
                id: "Telegram ID",
                age: "Account Age",
                premium: "Premium",
                lang: "Language",
                inviteDesc: "Invite friends to climb the Leaderboard",
                btnInvite: "Invite Friends",
                top: "Top Leaders",
                scanning: "SCANNING DATA...",
                rankNew: "Newbie",
                rankOld: "Veteran",
                rankOG: "Legend",
                refSuccess: "Referral recorded!"
            },
            ru: {
                welcome: "Анализ аккаунта",
                totalScore: "TG СЧЕТ",
                id: "Telegram ID",
                age: "Возраст аккаунта",
                premium: "Премиум",
                lang: "Язык",
                inviteDesc: "Пригласи друзей в топ",
                btnInvite: "Пригласить",
                top: "Топ Лидеров",
                scanning: "СКАНИРОВАНИЕ...",
                rankNew: "Новичок",
                rankOld: "Ветеран",
                rankOG: "Легенда",
                refSuccess: "Реферал засчитан!"
            }
        };

        let currentLang = 'en';
        let currentUser = null;

        // 3. Hàm tính điểm cống hiến
        function calculateScore(user) {
            let score = 0;
            const details = { ageScore: 0, premiumScore: 0, id: user.id };

            // A. Tính điểm tuổi thọ dựa trên ID
            // ID càng nhỏ = càng già. 
            // Giả sử ID hiện tại ~ 7.5 tỷ. Mỗi 100tr ID thấp hơn = +100 điểm.
            // Công thức: (7.5 Tỷ - ID) / 500,000
            const maxId = 7500000000; 
            let agePoints = Math.floor((maxId - user.id) / 500000); 
            if (agePoints < 0) agePoints = 100; // User mới tinh vẫn cho chút điểm
            
            score += agePoints;
            details.ageScore = agePoints;

            // B. Premium (+5000 điểm)
            if (user.is_premium) {
                score += 5000;
                details.premiumScore = 5000;
            }

            // C. Username (+500 điểm)
            if (user.username) score += 500;

            return { total: score, details };
        }

        // 4. Khởi tạo & Dịch thuật
        function setLanguage(langCode) {
            // Mặc định en nếu không tìm thấy
            currentLang = translations[langCode] ? langCode : 'en';
            const t = translations[currentLang];
            
            document.getElementById('lang-display').innerText = langCode.toUpperCase();
            document.getElementById('welcome-text').innerText = t.welcome;
            document.getElementById('lbl-total-score').innerText = t.totalScore;
            document.getElementById('lbl-id').innerText = t.id;
            document.getElementById('lbl-age').innerText = t.age;
            document.getElementById('lbl-lang').innerText = t.lang;
            document.getElementById('lbl-invite-desc').innerText = t.inviteDesc;
            document.getElementById('btn-invite').innerText = t.btnInvite;
            document.getElementById('lbl-top').innerText = t.top;
            document.getElementById('scan-status').innerText = t.scanning;
        }

        async function init() {
            tg.expand();
            tg.setHeaderColor('#0e1621');
            
            // Lấy user
            currentUser = tg.initDataUnsafe.user;
            // Test user nếu chạy trên browser
            if (!currentUser) currentUser = { id: 123456789, first_name: "Test", last_name: "User", username: "tester", language_code: "vi", is_premium: true };

            // Detect Language
            setLanguage(currentUser.language_code || 'en');

            // Hiệu ứng scan giả lập (2 giây)
            setTimeout(async () => {
                await processUser();
            }, 2000);
        }

        // 5. Xử lý Logic chính
        async function processUser() {
            document.getElementById('scan-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            const userRef = doc(db, "users", currentUser.id.toString());
            const docSnap = await getDoc(userRef);
            
            const calc = calculateScore(currentUser);
            let finalScore = calc.total;
            let referralCount = 0;

            if (!docSnap.exists()) {
                // --- USER MỚI ---
                
                // Xử lý Referral (Nếu có start_param)
                const startParam = tg.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('ref_')) {
                    const referrerId = startParam.split('_')[1];
                    if (referrerId && referrerId !== currentUser.id.toString()) {
                        try {
                            // Cộng ref cho người mời
                            const refUserRef = doc(db, "users", referrerId);
                            await updateDoc(refUserRef, { 
                                referralCount: increment(1),
                                score: increment(1000) // Người mời được cộng điểm
                            });
                        } catch (e) { console.log("Ref error", e); }
                    }
                }

                // Lưu user mới
                await setDoc(userRef, {
                    id: currentUser.id,
                    firstName: currentUser.first_name,
                    username: currentUser.username || "",
                    language: currentUser.language_code || "en",
                    isPremium: currentUser.is_premium || false,
                    score: finalScore,
                    referralCount: 0,
                    joinedAt: serverTimestamp()
                });

            } else {
                // --- USER CŨ ---
                const data = docSnap.data();
                // Giữ nguyên điểm cũ, chỉ update thông tin mới (nếu cần logic update điểm real-time thì sửa ở đây)
                // Ở đây mình ưu tiên hiển thị điểm đã lưu + ref count đã lưu
                // Tuy nhiên nếu user mới mua Premium, cần update lại
                if(currentUser.is_premium && !data.isPremium) {
                    finalScore = data.score + 5000;
                    await updateDoc(userRef, { isPremium: true, score: finalScore });
                } else {
                    finalScore = data.score;
                }
                referralCount = data.referralCount || 0;
            }

            // Render dữ liệu ra màn hình
            updateUI(finalScore, calc.details, referralCount);
            
            // Load Leaderboard
            loadLeaderboard();
        }

        function updateUI(score, details, refCount) {
            // Hiệu ứng nhảy số
            const scoreEl = document.getElementById('user-score');
            scoreEl.innerText = score.toLocaleString();

            document.getElementById('val-id').innerText = currentUser.id;
            document.getElementById('val-age').innerText = `+${details.ageScore.toLocaleString()}`;
            document.getElementById('val-lang').innerText = (currentUser.language_code || 'en').toUpperCase();
            
            const premEl = document.getElementById('val-premium');
            if (currentUser.is_premium) {
                premEl.innerHTML = '<i class="fas fa-check-circle"></i> YES (+5000)';
                premEl.classList.add('premium-text');
            } else {
                premEl.innerText = "NO";
            }

            // Set Rank title
            const t = translations[currentLang];
            let rank = t.rankNew;
            if (details.ageScore > 5000) rank = t.rankOld;
            if (details.ageScore > 10000) rank = t.rankOG;
            document.getElementById('account-rank').innerText = rank;

            document.getElementById('ref-count').innerText = refCount;
        }

        // 6. Xử lý mời bạn bè
        window.inviteFriend = () => {
            const inviteLink = `https://t.me/YOUR_BOT_USERNAME?start=ref_${currentUser.id}`;
            const msg = `Check my TG Account Score: ${document.getElementById('user-score').innerText}! Check yours now:`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(msg)}`;
            tg.openTelegramLink(url);
        };

        // 7. Load Leaderboard (Chỉ tính theo Referral Count)
        async function loadLeaderboard() {
            const lbList = document.getElementById('lb-list');
            try {
                // Query: Sort by referralCount DESC, limit 10
                const q = query(collection(db, "users"), orderBy("referralCount", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                let html = '';
                let index = 1;

                if (querySnapshot.empty) {
                    lbList.innerHTML = '<div style="text-align:center; opacity:0.5; padding:10px">Chưa có dữ liệu</div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const u = doc.data();
                    const isMe = u.id === currentUser.id;
                    
                    html += `
                        <div class="lb-item" style="${isMe ? 'border:1px solid var(--accent)' : ''}">
                            <div class="lb-user">
                                <div style="width:20px; text-align:center; font-weight:bold; color:#666">#${index}</div>
                                <div class="lb-avatar" style="background-color: ${stringToColor(u.firstName)}"></div>
                                <div>
                                    <div style="font-weight:600; font-size:14px">${u.firstName}</div>
                                    <div style="font-size:10px; color:#888">${u.id}</div>
                                </div>
                            </div>
                            <div class="lb-count">
                                ${u.referralCount || 0} <i class="fas fa-user-friends" style="font-size:10px"></i>
                            </div>
                        </div>
                    `;
                    index++;
                });
                lbList.innerHTML = html;
            } catch (error) {
                console.error("LB Error:", error);
                // Để chạy được orderBy, Firestore đôi khi yêu cầu tạo Index. 
                // Nếu lỗi, mở Console trình duyệt xem link tạo index.
                lbList.innerHTML = '<div style="color:red; font-size:10px; text-align:center">Cần tạo Index trên Firestore</div>';
            }
        }

        // Helper: Tạo màu từ tên
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // Start
        init();

    </script>
</body>
</html>
