<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Super App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Th√™m Font v√† Icon -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: 1px solid rgba(255, 255, 255, 0.1);
            --accent: #00c6ff;
            --accent-grad: linear-gradient(90deg, #00c6ff, #0072ff);
            --text-main: #ffffff;
            --text-sub: #b0b0b0;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Layout */
        .container {
            padding: 20px 20px 100px 20px; /* Padding bottom cho Nav bar */
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header Profile */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.3);
            object-fit: cover;
        }

        .user-info h2 { margin: 0; font-size: 18px; font-weight: 800; }
        .user-info p { margin: 2px 0 0; color: var(--text-sub); font-size: 12px; }
        .badge {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-top: 4px;
        }

        /* Main Score Display */
        .main-score {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: var(--card-border);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .main-score::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(0,198,255,0.1) 0%, transparent 60%);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .score-label { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); }
        .score-number { font-size: 42px; font-weight: 800; margin: 10px 0; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Action Buttons */
        .btn-grad {
            background: var(--accent-grad);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 12px;
            width: 100%;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-grad:active { transform: scale(0.97); }
        .btn-grad.disabled { opacity: 0.6; filter: grayscale(1); pointer-events: none; }

        /* Task List */
        .section-title { font-size: 18px; margin-bottom: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        .task-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: var(--card-border);
        }
        .task-left { display: flex; align-items: center; gap: 12px; }
        .task-icon { width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .task-reward { font-size: 12px; color: var(--accent); font-weight: bold; }
        .btn-claim { background: rgba(255,255,255,0.1); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .btn-claim.claimed { color: #00ff88; background: rgba(0, 255, 136, 0.1); }

        /* Navigation Bar */
        .nav-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(20, 20, 30, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .nav-item {
            color: var(--text-sub);
            text-align: center;
            font-size: 10px;
            cursor: pointer;
            transition: color 0.3s;
            width: 60px;
        }
        
        .nav-item i { font-size: 20px; margin-bottom: 4px; display: block; }
        .nav-item.active { color: var(--accent); }

        /* Views Logic */
        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .matrix-text { color: #00ff88; font-family: monospace; font-size: 12px; margin-top: 15px; }

        /* Leaderboard specific */
        .rank-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-num { width: 30px; font-weight: bold; color: var(--text-sub); }
        .rank-name { flex-grow: 1; margin-left: 10px; }
        .rank-score { font-weight: bold; color: var(--accent); }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <i class="fas fa-satellite-dish fa-spin fa-2x" style="color: var(--accent)"></i>
        <div class="matrix-text" id="loading-text">INITIALIZING SYSTEM...</div>
    </div>

    <div class="container">
        <!-- VIEW: HOME -->
        <div id="view-home" class="view-section active">
            <div class="profile-header">
                <img id="user-avatar" src="https://via.placeholder.com/60" class="avatar">
                <div class="user-info">
                    <h2 id="user-name">Loading...</h2>
                    <p id="user-id">ID: ---</p>
                    <span id="premium-badge" class="badge" style="display:none">PREMIUM USER</span>
                </div>
            </div>

            <div class="main-score">
                <div class="score-label">T·ªïng ƒêi·ªÉm C·ªßa B·∫°n</div>
                <div class="score-number" id="total-score">0</div>
                <button class="btn-grad" id="check-btn" onclick="analyzeAccount()">
                    <i class="fas fa-sync-alt"></i> Qu√©t & C·∫≠p nh·∫≠t
                </button>
            </div>

            <div class="section-title"><i class="fas fa-calendar-check"></i> ƒêi·ªÉm danh h√†ng ng√†y</div>
            <div class="task-item">
                <div class="task-left">
                    <div class="task-icon">üìÖ</div>
                    <div>
                        <div>Daily Check-in</div>
                        <div class="task-reward">+100 Points</div>
                    </div>
                </div>
                <button class="btn-claim" id="daily-btn" onclick="claimDaily()">Nh·∫≠n</button>
            </div>
            
            <div class="section-title"><i class="fas fa-user-friends"></i> M·ªùi b·∫°n b√®</div>
             <div class="task-item" style="display: block; text-align: center;">
                 <p style="font-size: 12px; color: #ccc; margin-bottom: 10px;">Nh·∫≠n 10% s·ªë ƒëi·ªÉm t·ª´ b·∫°n b√® c·ªßa b·∫°n!</p>
                 <button class="btn-grad" style="padding: 10px;" onclick="copyReferral()">
                    <i class="fas fa-copy"></i> Copy Link M·ªùi
                 </button>
            </div>
        </div>

        <!-- VIEW: TASKS -->
        <div id="view-tasks" class="view-section">
            <div class="section-title"><i class="fas fa-tasks"></i> Nhi·ªám v·ª• kh·∫£ d·ª•ng</div>
            <div id="task-list">
                <!-- Task m·∫´u -->
                <div class="task-item">
                    <div class="task-left">
                        <div class="task-icon"><i class="fab fa-telegram"></i></div>
                        <div>
                            <div>Tham gia Channel</div>
                            <div class="task-reward">+500 PTS</div>
                        </div>
                    </div>
                    <button class="btn-claim" onclick="completeTask(this, 500)">L√†m</button>
                </div>
                 <div class="task-item">
                    <div class="task-left">
                        <div class="task-icon"><i class="fab fa-twitter"></i></div>
                        <div>
                            <div>Follow Twitter (X)</div>
                            <div class="task-reward">+300 PTS</div>
                        </div>
                    </div>
                    <button class="btn-claim" onclick="completeTask(this, 300)">L√†m</button>
                </div>
            </div>
        </div>

        <!-- VIEW: LEADERBOARD -->
        <div id="view-rank" class="view-section">
            <div class="section-title"><i class="fas fa-trophy"></i> Top 10 Ng∆∞·ªùi D√πng</div>
            <div class="main-score" style="padding: 15px;">
                <div class="score-label">X·∫øp h·∫°ng c·ªßa b·∫°n</div>
                <div style="font-size: 24px; font-weight: bold; margin-top: 5px;">#<span id="my-rank">--</span></div>
            </div>
            <div id="leaderboard-list" style="background: var(--card-bg); border-radius: 12px; border: var(--card-border);">
                <div style="padding: 20px; text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <i class="fas fa-home"></i> Home
        </div>
        <div class="nav-item" onclick="switchTab('tasks', this)">
            <i class="fas fa-scroll"></i> Tasks
        </div>
        <div class="nav-item" onclick="switchTab('rank', this)">
            <i class="fas fa-chart-bar"></i> Rank
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;
        
        let currentUser = null;
        let userData = null;

        // Init App
        async function initApp() {
            tg.expand();
            tg.enableClosingConfirmation();
            
            // L·∫•y theme color t·ª´ Telegram ƒë·ªÉ set status bar (n·∫øu c·∫ßn)
            tg.setHeaderColor('#0f0c29'); 

            currentUser = tg.initDataUnsafe.user;
            
            // M√¥i tr∆∞·ªùng test n·∫øu kh√¥ng c√≥ Telegram
            if (!currentUser) {
                currentUser = { id: 123456789, first_name: "Test", last_name: "User", username: "tester", is_premium: true, photo_url: "https://via.placeholder.com/60" };
            }

            // Render UI c∆° b·∫£n
            document.getElementById('user-name').innerText = currentUser.first_name + (currentUser.last_name ? " " + currentUser.last_name : "");
            document.getElementById('user-id').innerText = `ID: ${currentUser.id}`;
            if(currentUser.photo_url) document.getElementById('user-avatar').src = currentUser.photo_url;
            if(currentUser.is_premium) document.getElementById('premium-badge').style.display = 'inline-block';

            // Load Data t·ª´ Firebase
            await loadUserData();
            
            // ·∫®n loading
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
            }, 1000);
        }

        // Load User Data
        async function loadUserData() {
            const userRef = doc(db, "users", currentUser.id.toString());
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                userData = docSnap.data();
                document.getElementById('total-score').innerText = userData.score.toLocaleString();
                checkDailyStatus();
            } else {
                // User m·ªõi
                userData = { score: 0, lastCheckin: null };
                document.getElementById('total-score').innerText = "0";
                // T·ª± ƒë·ªông ph√¢n t√≠ch l·∫ßn ƒë·∫ßu cho user m·ªõi
                // analyzeAccount(); -> ƒê·ªÉ user t·ª± b·∫•m th√¨ hay h∆°n
            }
        }

        // T√≠nh nƒÉng 1: Ph√¢n t√≠ch t√†i kho·∫£n (Core c≈©)
        window.analyzeAccount = async () => {
            const btn = document.getElementById('check-btn');
            if(btn.disabled) return;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang qu√©t...';
            btn.disabled = true;

            // Logic t√≠nh ƒëi·ªÉm
            let ageScore = 0;
            const idFactor = 7000000000 - currentUser.id;
            if (idFactor > 0) ageScore += Math.floor(idFactor / 10000000); // V√≠ d·ª• c√¥ng th·ª©c
            if (currentUser.is_premium) ageScore += 5000;
            if (currentUser.username) ageScore += 500;
            
            // Gi·ªØ l·∫°i ƒëi·ªÉm c≈© (n·∫øu c√≥) v√† c·ªông th√™m ƒëi·ªÉm ageScore (n·∫øu ch∆∞a t·ª´ng nh·∫≠n)
            // ·ªû ƒë√¢y m√¨nh l√†m ƒë∆°n gi·∫£n: Update l·∫°i profile v√† set ƒëi·ªÉm n·∫øu l√† l·∫ßn ƒë·∫ßu.
            // N·∫øu user ƒë√£ t·ªìn t·∫°i, ch·ªâ update th√¥ng tin, kh√¥ng reset ƒëi·ªÉm.
            
            const userRef = doc(db, "users", currentUser.id.toString());
            
            let finalScore = userData.score;
            // N·∫øu score b·∫±ng 0 (user m·ªõi) th√¨ c·ªông ƒëi·ªÉm tu·ªïi th·ªç
            if(userData.score === 0) {
                finalScore = ageScore + 1000; // 1000 bonus
            }

            try {
                await setDoc(userRef, {
                    id: currentUser.id,
                    username: currentUser.username || "",
                    firstName: currentUser.first_name,
                    lastName: currentUser.last_name || "",
                    isPremium: currentUser.is_premium || false,
                    score: finalScore,
                    lastActive: serverTimestamp()
                }, { merge: true }); // Merge ƒë·ªÉ kh√¥ng m·∫•t fields kh√°c
                
                userData.score = finalScore;
                animateScore(finalScore);
                tg.HapticFeedback.notificationOccurred('success');
                btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ c·∫≠p nh·∫≠t';
            } catch (e) {
                console.error(e);
                btn.innerHTML = 'L·ªói';
            }
            
            setTimeout(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> Qu√©t & C·∫≠p nh·∫≠t'; }, 3000);
        };

        // T√≠nh nƒÉng 2: Daily Check-in
        window.claimDaily = async () => {
            const btn = document.getElementById('daily-btn');
            if(btn.classList.contains('claimed')) return;

            const today = new Date().toDateString();
            const userRef = doc(db, "users", currentUser.id.toString());

            try {
                await updateDoc(userRef, {
                    score: increment(100),
                    lastCheckin: today
                });
                
                userData.score += 100;
                document.getElementById('total-score').innerText = userData.score.toLocaleString();
                
                btn.innerText = "ƒê√£ nh·∫≠n";
                btn.classList.add('claimed');
                tg.HapticFeedback.notificationOccurred('success');
                
                // Show popup effect (ƒë∆°n gi·∫£n)
                tg.showAlert("B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c 100 ƒëi·ªÉm!");
            } catch (e) {
                console.log("User ch∆∞a c√≥ trong DB, c·∫ßn analyze tr∆∞·ªõc");
                tg.showAlert("Vui l√≤ng Qu√©t t√†i kho·∫£n tr∆∞·ªõc!");
            }
        };

        function checkDailyStatus() {
            if(!userData.lastCheckin) return;
            const today = new Date().toDateString();
            if(userData.lastCheckin === today) {
                const btn = document.getElementById('daily-btn');
                btn.innerText = "ƒê√£ nh·∫≠n";
                btn.classList.add('claimed');
            }
        }

        // T√≠nh nƒÉng 3: Leaderboard
        window.loadLeaderboard = async () => {
            const listDiv = document.getElementById('leaderboard-list');
            listDiv.innerHTML = '<div style="padding:20px; text-align:center"><i class="fas fa-spinner fa-spin"></i></div>';

            const q = query(collection(db, "users"), orderBy("score", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            
            let html = '';
            let index = 1;
            querySnapshot.forEach((doc) => {
                const u = doc.data();
                const isMe = u.id === currentUser.id;
                if(isMe) document.getElementById('my-rank').innerText = index;
                
                html += `
                    <div class="rank-item" style="${isMe ? 'background:rgba(0,198,255,0.1)' : ''}">
                        <div class="rank-num" style="color: ${index === 1 ? '#ffd700' : (index === 2 ? '#c0c0c0' : (index === 3 ? '#cd7f32' : 'inherit'))}">${index}</div>
                        <div class="avatar" style="width:30px; height:30px; border-width:1px; margin-right:10px; background:#333"></div> 
                        <div class="rank-name">
                            ${u.firstName} ${u.isPremium ? '<i class="fas fa-star" style="color:#ffd700; font-size:10px"></i>' : ''}
                        </div>
                        <div class="rank-score">${u.score.toLocaleString()}</div>
                    </div>
                `;
                index++;
            });
            listDiv.innerHTML = html;
        }

        // UI Helpers
        window.switchTab = (tabName, el) => {
            // Update Nav UI
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');

            // Hide all views
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            
            // Show target view
            document.getElementById(`view-${tabName}`).classList.add('active');
            
            // Logic khi chuy·ªÉn tab
            if(tabName === 'rank') {
                loadLeaderboard();
            }
            tg.HapticFeedback.selectionChanged();
        };

        window.completeTask = async (btn, points) => {
            if(btn.innerText === "Xong") return;
            
            // Gi·∫£ l·∫≠p m·ªü link
            // window.open('https://t.me/your_channel', '_blank');
            
            // Gi·∫£ l·∫≠p delay check
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            await new Promise(r => setTimeout(r, 1500));
            
            // C·ªông ƒëi·ªÉm
            const userRef = doc(db, "users", currentUser.id.toString());
            try {
                await updateDoc(userRef, { score: increment(points) });
                userData.score += points;
                document.getElementById('total-score').innerText = userData.score.toLocaleString();
                
                btn.innerText = "Xong";
                btn.classList.add('claimed');
                tg.HapticFeedback.notificationOccurred('success');
            } catch(e) {
                tg.showAlert("Vui l√≤ng Qu√©t t√†i kho·∫£n tr∆∞·ªõc!");
                btn.innerText = "L√†m";
            }
        };

        window.copyReferral = () => {
            const link = `https://t.me/YOUR_BOT_NAME?start=ref_${currentUser.id}`;
            navigator.clipboard.writeText(link);
            tg.showAlert("ƒê√£ copy link m·ªùi!");
        }

        function animateScore(target) {
            let current = 0;
            const el = document.getElementById('total-score');
            const step = target / 50;
            const interval = setInterval(() => {
                current += step;
                if(current >= target) {
                    current = target;
                    clearInterval(interval);
                }
                el.innerText = Math.floor(current).toLocaleString();
            }, 10);
        }

        // Run
        initApp();
    </script>
</body>
</html>
