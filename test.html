<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng Y T·∫ø Hi·ªáp Th√†nh - V10 Data Manager</title>
    
    <!-- Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e3a8a; --secondary: #0284c7; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --input-yellow: #fff9c4;
            --bg: #f8fafc; --radius: 16px;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); margin: 0; padding: 0; color: #1e293b; overflow-x: hidden; }

        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            color: white; padding: 50px 20px; text-align: center;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        }

        .container { max-width: 1250px; margin: -40px auto 150px; padding: 0 15px; }

        .config-bar {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: flex; flex-wrap: wrap;
            gap: 15px; position: sticky; top: 10px; z-index: 1000; border: 1px solid #e2e8f0;
        }
        .config-item { flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 5px; }
        .config-item label { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; }

        .form-control { padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; font-weight: 700; outline: none; }

        #main-wrapper { position: relative; min-height: 400px; }
        .lock-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(248, 250, 252, 0.98); z-index: 100;
            display: flex; flex-direction: column; align-items: center; padding-top: 100px; text-align: center;
        }
        .is-unlocked .lock-overlay { display: none; }

        .card { background: white; padding: 25px; border-radius: var(--radius); margin-bottom: 25px; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .card-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        .table-scroll { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; padding: 15px; font-size: 11px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }

        .input-num { width: 100%; padding: 10px; border-radius: 8px; border: 1.5px solid #cbd5e1; background: var(--input-yellow); text-align: center; font-weight: 800; }
        .input-text { width: 100%; padding: 10px; border-radius: 8px; border: 1.5px solid #cbd5e1; font-weight: 600; }

        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 800; }
        .badge-danger { background: #fee2e2; color: #ef4444; animation: blink 1s infinite; }
        .badge-success { background: #dcfce7; color: #10b981; }

        .action-group { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 800px; display: flex; gap: 10px; z-index: 2000; flex-wrap: wrap; }
        .btn-action { flex: 1; padding: 15px; border-radius: 50px; border: none; font-weight: 800; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn-save { background: var(--success); }
        .btn-excel { background: #1d6f42; display: none; }
        .btn-import { background: #0284c7; display: none; }
        
        .btn-del { color: var(--danger); background: none; border: none; font-size: 1.5rem; cursor: pointer; visibility: hidden; }
        .admin-mode .btn-del { visibility: visible; }
        .locked-cell { background: #f1f5f9 !important; pointer-events: none; opacity: 0.5; }

        @keyframes blink { 50% { opacity: 0.5; } }
        @media (max-width: 600px) { .config-bar { flex-direction: column; } .btn-action { flex: unset; width: 48%; } }
    </style>
</head>
<body>

<div class="header">
    <h1>Y T·∫æ HI·ªÜP TH√ÄNH - V10</h1>
    <p>Qu·∫£n l√Ω d·ªØ li·ªáu H·ª£p nh·∫•t & Import/Export Excel</p>
</div>

<div class="container" id="app-container">
    <div class="config-bar">
        <div class="config-item">
            <label>üë§ ƒê∆°n v·ªã</label>
            <select id="userUnit" class="form-control" onchange="initSession()">
                <option value="">-- Ch·ªçn ƒë∆°n v·ªã --</option>
                <option value="NM">Ph∆∞·ªùng Nh√† M√°t</option>
                <option value="HT">X√£ Hi·ªáp Th√†nh</option>
                <option value="VTD">X√£ Vƒ©nh Tr·∫°ch ƒê√¥ng</option>
                <option value="PHT">Ph∆∞·ªùng Hi·ªáp Th√†nh (Admin)</option>
            </select>
        </div>
        <div class="config-item">
            <label>üìÖ Th√°ng b√°o c√°o</label>
            <input type="month" id="reportMonth" class="form-control" onchange="initSession()">
        </div>
    </div>

    <div id="main-wrapper">
        <div class="lock-overlay">
            <div style="font-size: 4rem;">üîí</div>
            <h3>Kh√≥a d·ªØ li·ªáu</h3>
            <p style="color:#64748b">Vui l√≤ng ch·ªçn <b>ƒê∆°n v·ªã</b> v√† <b>Th√°ng</b> ƒë·ªÉ l√†m vi·ªác.</p>
        </div>

        <!-- MODULE A -->
        <div class="card">
            <div class="card-title">üßÇ A. Mu·ªëi I-·ªët (16 kh√≥m)</div>
            <div id="khomGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px;"></div>
            <div style="margin-top:20px; font-weight:800; color:var(--primary); background:#eff6ff; padding:15px; border-radius:12px;">
                T·ªïng: <span id="sumA">0</span>/336 | T·ª∑ l·ªá: <span id="rateA">0%</span>
            </div>
        </div>

        <!-- MODULE B -->
        <div class="card">
            <div class="card-title">ü©∫ B. Kh√°m s√†ng l·ªçc (HTA, ƒêTƒê, COPD, HEN)</div>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr><th>Ch·ªâ ti√™u</th><th style="color:var(--secondary)">NM</th><th style="color:var(--success)">HT</th><th style="color:var(--warning)">VTD</th><th style="background:#f1f5f9">T·ªîNG</th></tr>
                    </thead>
                    <tbody id="bodyB">
                        <tr data-row="HTA"><td>TƒÉng huy·∫øt √°p</td><td><input type="number" class="input-num cell-b" data-u="NM"></td><td><input type="number" class="input-num cell-b" data-u="HT"></td><td><input type="number" class="input-num cell-b" data-u="VTD"></td><td class="res-b" style="color:red; font-weight:900">0</td></tr>
                        <tr data-row="DTD"><td>ƒê√°i th√°o ƒë∆∞·ªùng</td><td><input type="number" class="input-num cell-b" data-u="NM"></td><td><input type="number" class="input-num cell-b" data-u="HT"></td><td><input type="number" class="input-num cell-b" data-u="VTD"></td><td class="res-b" style="color:red; font-weight:900">0</td></tr>
                        <tr data-row="COPD"><td>COPD</td><td><input type="number" class="input-num cell-b" data-u="NM"></td><td><input type="number" class="input-num cell-b" data-u="HT"></td><td><input type="number" class="input-num cell-b" data-u="VTD"></td><td class="res-b" style="color:red; font-weight:900">0</td></tr>
                        <tr data-row="HEN"><td>Hen ph·∫ø qu·∫£n</td><td><input type="number" class="input-num cell-b" data-u="NM"></td><td><input type="number" class="input-num cell-b" data-u="HT"></td><td><input type="number" class="input-num cell-b" data-u="VTD"></td><td class="res-b" style="color:red; font-weight:900">0</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- MODULE C -->
        <div class="card">
            <div class="card-title">üì¢ C. Truy·ªÅn th√¥ng</div>
            <div class="table-scroll">
                <table>
                    <thead><tr><th>H√¨nh th·ª©c</th><th>N·ªôi dung</th><th width="70">L∆∞·ª£t</th><th width="70">Ph√∫t</th><th width="70">Ng∆∞·ªùi</th><th width="40"></th></tr></thead>
                    <tbody id="bodyC"></tbody>
                </table>
            </div>
            <button onclick="addRowC()" style="margin-top:15px; border:none; background:var(--primary); color:white; padding:10px 20px; border-radius:10px; font-weight:700; cursor:pointer">+ Th√™m d√≤ng</button>
        </div>

        <!-- MODULE D -->
        <div class="card" style="border-top: 5px solid var(--danger);">
            <div class="card-title">‚ö†Ô∏è D. T·ªìn t·∫°i xuy√™n su·ªët (Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn x√≥a)</div>
            <div class="table-scroll">
                <table>
                    <thead><tr><th>N·ªôi dung</th><th>Ph·ª• tr√°ch</th><th width="150">H·∫°n</th><th width="100">ST</th><th width="130">C·∫£nh b√°o</th><th width="40"></th></tr></thead>
                    <tbody id="bodyD"></tbody>
                </table>
            </div>
            <button onclick="addRowD()" style="margin-top:15px; border:none; background:var(--danger); color:white; padding:10px 20px; border-radius:10px; font-weight:700; cursor:pointer">+ Th√™m t·ªìn t·∫°i</button>
        </div>
    </div>

    <!-- ACTIONS -->
    <div class="action-group">
        <input type="file" id="importFile" style="display:none" accept=".xlsx, .xls" onchange="processExcel(event)">
        <button class="btn-action btn-import" id="btnImport" onclick="document.getElementById('importFile').click()">üì• NH·∫¨P EXCEL</button>
        <button class="btn-action btn-excel" id="btnExport" onclick="exportExcel()">üìä XU·∫§T EXCEL</button>
        <button class="btn-action btn-save" onclick="saveToCloud()">üíæ L∆ØU ƒê·ªíNG B·ªò</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const khoms = ["Bi·ªÉn ƒê√¥ng A", "Bi·ªÉn ƒê√¥ng B", "Bi·ªÉn T√¢y A", "Bi·ªÉn T√¢y B", "Gi·ªìng Gi·ªØa A", "Gi·ªìng Gi·ªØa B", "Gi·ªìng Gi·ªØa", "X√≥m L·∫©m", "Gi·ªìng Nh√£n", "Gi·ªìng Nh√£n A", "ƒê·∫ßu L·ªô", "ƒê·∫ßu L·ªô A", "Ch√≤m Xo√†i", "Nh√† M√°t", "B·ªù T√¢y", "Kinh T·∫ø"];
    const grid = document.getElementById('khomGrid');
    khoms.forEach(k => {
        grid.innerHTML += `<div style="background:#f8fafc; padding:8px; border-radius:10px; border:1px solid #e2e8f0"><label style="font-size:10px; font-weight:800; color:#64748b">${k}</label><input type="number" class="input-num input-a" data-k="${k}" max="21" oninput="calcA()"></div>`;
    });

    window.initSession = () => {
        const u = document.getElementById('userUnit').value;
        const m = document.getElementById('reportMonth').value;
        const wrapper = document.getElementById('main-wrapper');
        const container = document.getElementById('app-container');
        const btnEx = document.getElementById('btnExport');
        const btnIm = document.getElementById('btnImport');
        
        if(u && m) {
            wrapper.classList.add('is-unlocked');
            const isAdmin = (u === 'PHT');
            btnEx.style.display = isAdmin ? 'flex' : 'none';
            btnIm.style.display = isAdmin ? 'flex' : 'none';
            container.classList.toggle('admin-mode', isAdmin);
            
            document.querySelectorAll('.cell-b').forEach(i => {
                const can = (i.dataset.u === u) || isAdmin;
                i.classList.toggle('locked-cell', !can); i.readOnly = !can;
            });
            loadData(m);
        } else { wrapper.classList.remove('is-unlocked'); }
    };

    window.calcA = () => {
        let s = 0; document.querySelectorAll('.input-a').forEach(i => s += (parseInt(i.value)||0));
        document.getElementById('sumA').innerText = s;
        document.getElementById('rateA').innerText = ((s/(16*21))*100).toFixed(1) + '%';
    };

    const calcB = () => {
        document.querySelectorAll('#bodyB tr').forEach(tr => {
            let rs = 0; tr.querySelectorAll('.cell-b').forEach(i => rs += (parseInt(i.value)||0));
            tr.querySelector('.res-b').innerText = rs;
        });
    };

    document.addEventListener('input', (e) => {
        if(e.target.classList.contains('cell-b')) calcB();
        if(e.target.classList.contains('dd-input') || e.target.classList.contains('st-input')) updateAlerts();
    });

    window.addRowC = (d = null) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="text" class="input-text" value="${d?.type||''}"></td><td><input type="text" class="input-text" value="${d?.cont||''}"></td><td><input type="number" class="input-num" value="${d?.l||''}"></td><td><input type="number" class="input-num" value="${d?.p||''}"></td><td><input type="number" class="input-num" value="${d?.n||''}"></td><td><button onclick="this.closest('tr').remove()" style="border:none; background:none; color:red; font-size:20px; cursor:pointer">&times;</button></td>`;
        document.getElementById('bodyC').appendChild(tr);
    };

    window.addRowD = (d = null) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="text" class="input-text" value="${d?.issue||''}"></td><td><input type="text" class="input-text" value="${d?.per||''}"></td><td><input type="date" class="form-control dd-input" value="${d?.dl||''}"></td><td><select class="form-control st-input"><option value="0" ${d?.st=='0'?'selected':''}>Ch∆∞a</option><option value="1" ${d?.st=='1'?'selected':''}>Xong</option></select></td><td class="alert-box"></td><td><button class="btn-del" onclick="this.closest('tr').remove(); updateAlerts();">&times;</button></td>`;
        document.getElementById('bodyD').appendChild(tr); updateAlerts();
    };

    const updateAlerts = () => {
        const now = new Date(); now.setHours(0,0,0,0);
        document.querySelectorAll('#bodyD tr').forEach(tr => {
            const dateStr = tr.querySelector('.dd-input').value;
            const status = tr.querySelector('.st-input').value;
            const box = tr.querySelector('.alert-box');
            if(!dateStr) return;
            const dl = new Date(dateStr); const diff = Math.ceil((dl - now) / (1000*60*60*24));
            if(status == '1') box.innerHTML = `<span class="badge badge-success">XONG</span>`;
            else if(diff < 0) box.innerHTML = `<span class="badge badge-danger">QU√Å H·∫†N ${Math.abs(diff)}N</span>`;
            else box.innerHTML = `<span class="badge" style="background:#fef3c7; color:#92400e">C√íN ${diff}N</span>`;
        });
    };

    const loadData = async (m) => {
        const sMonth = await getDoc(doc(db, "BaoCaoV10", m));
        const sGlobal = await getDoc(doc(db, "BaoCaoV10", "Global_Pending"));
        document.querySelectorAll('input[type="number"], input[type="text"]').forEach(i => i.value = "");
        document.getElementById('bodyC').innerHTML = ""; document.getElementById('bodyD').innerHTML = "";
        
        if(sMonth.exists()){
            const d = sMonth.data();
            document.querySelectorAll('.input-a').forEach(i => i.value = d.A[i.dataset.k] || "");
            document.querySelectorAll('.cell-b').forEach(i => i.value = d.B[i.closest('tr').dataset.row][i.dataset.u] || "");
            if(d.C) d.C.forEach(c => addRowC(c));
        } else { addRowC(); }

        if(sGlobal.exists()){
            const dG = sGlobal.data();
            if(dG.D) dG.D.forEach(v => addRowD(v));
        } else { addRowD(); }
        calcA(); calcB(); updateAlerts();
    };

    window.saveToCloud = async () => {
        const m = document.getElementById('reportMonth').value;
        const u = document.getElementById('userUnit').value;
        if(!m || !u) return;
        Swal.fire({title: 'ƒêang l∆∞u...', didOpen: () => Swal.showLoading()});
        const dM = { A:{}, B:{HTA:{}, DTD:{}, COPD:{}, HEN:{}}, C:[] };
        const dG = { D:[] };
        document.querySelectorAll('.input-a').forEach(i => dM.A[i.dataset.k] = i.value);
        document.querySelectorAll('.cell-b').forEach(i => dM.B[i.closest('tr').dataset.row][i.dataset.u] = i.value);
        document.querySelectorAll('#bodyC tr').forEach(tr => {
            const ins = tr.querySelectorAll('input');
            dM.C.push({type:ins[0].value, cont:ins[1].value, l:ins[2].value, p:ins[3].value, n:ins[4].value});
        });
        document.querySelectorAll('#bodyD tr').forEach(tr => {
            const ins = tr.querySelectorAll('input, select');
            dG.D.push({issue:ins[0].value, per:ins[1].value, dl:ins[2].value, st:ins[3].value});
        });
        await setDoc(doc(db, "BaoCaoV10", m), dM);
        await setDoc(doc(db, "BaoCaoV10", "Global_Pending"), dG);
        Swal.fire("Th√†nh c√¥ng", "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô.", "success");
    };

    // --- IMPORT / EXCEL ---
    window.processExcel = (event) => {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Import Module A
            const sheetA = workbook.Sheets["I-ot"];
            if(sheetA) {
                const jsonA = XLSX.utils.sheet_to_json(sheetA);
                jsonA.forEach(row => {
                    const inp = document.querySelector(`.input-a[data-k="${row['Kh√≥m']}"]`);
                    if(inp) inp.value = row['S·ªë h·ªô'];
                });
            }
            
            // Import Module B
            const sheetB = workbook.Sheets["Sang Loc"];
            if(sheetB) {
                const jsonB = XLSX.utils.sheet_to_json(sheetB);
                const rows = { "TƒÉng huy·∫øt √°p": "HTA", "ƒê√°i th√°o ƒë∆∞·ªùng": "DTD", "COPD": "COPD", "Hen ph·∫ø qu·∫£n": "HEN" };
                jsonB.forEach(row => {
                    const rowId = rows[row['B·ªánh']];
                    if(rowId) {
                        const tr = document.querySelector(`tr[data-row="${rowId}"]`);
                        tr.querySelector('[data-u="NM"]').value = row['NM'];
                        tr.querySelector('[data-u="HT"]').value = row['HT'];
                        tr.querySelector('[data-u="VTD"]').value = row['VTD'];
                    }
                });
            }

            // Import Module C
            const sheetC = workbook.Sheets["Truyen Thong"];
            if(sheetC) {
                document.getElementById('bodyC').innerHTML = "";
                const jsonC = XLSX.utils.sheet_to_json(sheetC);
                jsonC.forEach(row => addRowC({type: row['H√¨nh th·ª©c'], cont: row['N·ªôi dung'], l: row['L∆∞·ª£t'], p: row['Ph√∫t'], n: row['Ng∆∞·ªùi']}));
            }

            // Import Module D
            const sheetD = workbook.Sheets["Ton Tai"];
            if(sheetD) {
                document.getElementById('bodyD').innerHTML = "";
                const jsonD = XLSX.utils.sheet_to_json(sheetD);
                jsonD.forEach(row => addRowD({issue: row['N·ªôi dung'], per: row['Ph·ª• tr√°ch'], dl: row['H·∫°n'], st: row['Tr·∫°ng th√°i'] === 'Xong' ? '1' : '0'}));
            }

            calcA(); calcB(); updateAlerts();
            Swal.fire("Th√†nh c√¥ng", "ƒê√£ n·∫°p d·ªØ li·ªáu t·ª´ file Excel. H√£y nh·∫•n L∆ØU ƒê·ªíNG B·ªò ƒë·ªÉ c·∫≠p nh·∫≠t l√™n h·ªá th·ªëng.", "success");
        };
        reader.readAsArrayBuffer(file);
    };

    window.exportExcel = () => {
        const m = document.getElementById('reportMonth').value;
        const wb = XLSX.utils.book_new();
        const dsA = []; document.querySelectorAll('.input-a').forEach(i => dsA.push({"Kh√≥m": i.dataset.k, "S·ªë h·ªô": i.value}));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dsA), "I-ot");
        const dsB = []; document.querySelectorAll('#bodyB tr').forEach(tr => {
            const ins = tr.querySelectorAll('input');
            dsB.push({"B·ªánh": tr.cells[0].innerText, "NM": ins[0].value, "HT": ins[1].value, "VTD": ins[2].value, "T·ªïng": tr.cells[4].innerText});
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dsB), "Sang Loc");
        const dsC = []; document.querySelectorAll('#bodyC tr').forEach(tr => {
            const ins = tr.querySelectorAll('input');
            dsC.push({"H√¨nh th·ª©c": ins[0].value, "N·ªôi dung": ins[1].value, "L∆∞·ª£t": ins[2].value, "Ph√∫t": ins[3].value, "Ng∆∞·ªùi": ins[4].value});
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dsC), "Truyen Thong");
        const dsD = []; document.querySelectorAll('#bodyD tr').forEach(tr => {
            const ins = tr.querySelectorAll('input, select');
            dsD.push({"N·ªôi dung": ins[0].value, "Ph·ª• tr√°ch": ins[1].value, "H·∫°n": ins[2].value, "Tr·∫°ng th√°i": ins[3].options[ins[3].selectedIndex].text});
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dsD), "Ton Tai");
        XLSX.writeFile(wb, `BaoCao_YTe_${m}.xlsx`);
    };
</script>
</body>
</html>
