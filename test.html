<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Terminal | Professional Crypto Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- Web3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #05070a; color: #e2e8f0; }
        .glass { background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .active-tab { border-bottom: 2px solid #6366f1; color: #6366f1; }
        .shimmer { animation: shimmer 2s infinite; background: linear-gradient(90deg, #0d1117 25%, #161b22 50%, #0d1117 75%); background-size: 200% 100%; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .xp-bar { height: 6px; border-radius: 3px; background: #1e293b; overflow: hidden; }
        .xp-progress { height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); width: 45%; transition: 0.5s; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="fixed left-0 top-0 h-full w-64 glass hidden lg:flex flex-col z-50">
        <div class="p-6 text-xl font-extrabold tracking-tighter text-indigo-500 flex items-center gap-2">
            <i data-lucide="layout-grid"></i> NEXUS PRO
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <div onclick="switchTab('market')" class="nav-btn active-tab flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-white/5 transition">
                <i data-lucide="line-chart"></i> Th·ªã tr∆∞·ªùng
            </div>
            <div onclick="switchTab('portfolio')" class="nav-btn flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-white/5 transition">
                <i data-lucide="briefcase"></i> Portfolio
            </div>
            <div onclick="switchTab('airdrops')" class="nav-btn flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-white/5 transition">
                <i data-lucide="gift"></i> Airdrops
            </div>
            <div onclick="switchTab('gamification')" class="nav-btn flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-white/5 transition">
                <i data-lucide="award"></i> Quest & XP
            </div>
            <div id="admin-nav" onclick="switchTab('admin')" class="hidden flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-white/5 text-red-400">
                <i data-lucide="shield-check"></i> Admin
            </div>
        </nav>
        
        <!-- USER PROFILE PREVIEW -->
        <div id="user-preview" class="p-4 border-t border-white/5 hidden">
            <div class="flex items-center gap-3 mb-3">
                <img id="u-avatar" src="" class="w-10 h-10 rounded-full">
                <div class="overflow-hidden">
                    <p id="u-name" class="font-bold text-sm truncate">User</p>
                    <p class="text-[10px] text-gray-500">Lv. <span id="u-level">1</span> Trader</p>
                </div>
            </div>
            <div class="xp-bar mb-2"><div id="u-xp-progress" class="xp-progress"></div></div>
            <button onclick="logout()" class="text-xs text-gray-500 hover:text-red-400">ƒêƒÉng xu·∫•t</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="lg:ml-64 p-4 lg:p-8 pb-24">
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-8">
            <div class="search-box relative hidden sm:block">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i>
                <input type="text" placeholder="T√¨m coin, airdrop..." class="glass rounded-full py-2 pl-10 pr-4 text-sm w-80 focus:ring-1 ring-indigo-500 outline-none">
            </div>
            <div class="flex gap-3">
                <button id="btn-login" onclick="login()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                    <i data-lucide="log-in"></i> ƒêƒÉng nh·∫≠p
                </button>
                <button id="btn-wallet" onclick="connectWallet()" class="glass px-5 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                    <i data-lucide="wallet"></i> <span id="wallet-addr">K·∫øt n·ªëi v√≠</span>
                </button>
            </div>
        </header>

        <!-- TAB: MARKET (CRYPTRANK CLONE) -->
        <section id="tab-market" class="tab-content">
            <div class="flex justify-between items-end mb-6">
                <h1 class="text-3xl font-black">Th·ªã tr∆∞·ªùng</h1>
                <div class="flex gap-2 text-xs">
                    <span class="text-gray-500">Global Cap:</span> <span class="text-indigo-400" id="global-cap">--</span>
                </div>
            </div>
            <div class="glass rounded-3xl overflow-hidden border border-white/5">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-gray-400 text-xs">
                        <tr>
                            <th class="p-4">#</th>
                            <th class="p-4">T√™n</th>
                            <th class="p-4 text-right">Gi√°</th>
                            <th class="p-4 text-right">24h%</th>
                            <th class="p-4 text-right">V·ªën h√≥a</th>
                            <th class="p-4 text-center">7 Ng√†y</th>
                        </tr>
                    </thead>
                    <tbody id="market-tbody"></tbody>
                </table>
            </div>
        </section>

        <!-- TAB: PORTFOLIO (PnL Tracking) -->
        <section id="tab-portfolio" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass p-6 rounded-3xl">
                    <p class="text-gray-500 text-sm">T·ªïng t√†i s·∫£n</p>
                    <h2 class="text-3xl font-bold" id="p-total">$0.00</h2>
                </div>
                <div class="glass p-6 rounded-3xl">
                    <p class="text-gray-500 text-sm">L·ª£i nhu·∫≠n (PnL)</p>
                    <h2 class="text-3xl font-bold text-green-400" id="p-pnl">+$0.00</h2>
                </div>
                <div class="glass p-6 rounded-3xl flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">ƒê·ªô ph√¢n b·ªï</p>
                        <p class="font-bold">ƒêa d·∫°ng h√≥a</p>
                    </div>
                    <canvas id="p-chart" class="w-16 h-16"></canvas>
                </div>
            </div>
            <div class="glass rounded-3xl p-6">
                <div class="flex justify-between mb-4">
                    <h3 class="font-bold">Danh m·ª•c t√†i s·∫£n</h3>
                    <button onclick="addAssetManual()" class="text-xs bg-indigo-600 px-3 py-1 rounded-lg">+ Th√™m th·ªß c√¥ng</button>
                </div>
                <div id="portfolio-list" class="space-y-4">
                    <!-- Portfolio Items -->
                </div>
            </div>
        </section>

        <!-- TAB: AIRDROPS -->
        <section id="tab-airdrops" class="tab-content hidden">
            <h1 class="text-3xl font-black mb-6">Airdrops Ti·ªÅm NƒÉng</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="airdrop-list">
                <!-- Airdrop Card -->
            </div>
        </section>

        <!-- TAB: GAMIFICATION -->
        <section id="tab-gamification" class="tab-content hidden">
            <div class="max-w-2xl mx-auto text-center py-10">
                <div class="mb-6 relative inline-block">
                    <div class="w-32 h-32 bg-indigo-600 rounded-full flex items-center justify-center mx-auto text-4xl shadow-2xl shadow-indigo-500/50">
                        üèÜ
                    </div>
                    <div class="absolute -bottom-2 -right-2 bg-yellow-500 text-black px-3 py-1 rounded-full text-xs font-bold">Lv. <span id="u-level-big">1</span></div>
                </div>
                <h2 class="text-2xl font-bold mb-2" id="u-name-big">Crypto Explorer</h2>
                <p class="text-gray-500 mb-8">Ho√†n th√†nh nhi·ªám v·ª• ƒë·ªÉ nh·∫≠n XP v√† ƒë·ªïi l·∫•y NFT Pro.</p>
                <div class="grid grid-cols-1 gap-4 text-left">
                    <div class="glass p-4 rounded-2xl flex justify-between items-center">
                        <div class="flex gap-4 items-center">
                            <div class="p-3 bg-white/5 rounded-xl"><i data-lucide="calendar"></i></div>
                            <div>
                                <p class="font-bold">ƒêi·ªÉm danh h√†ng ng√†y</p>
                                <p class="text-xs text-indigo-400">+10 XP</p>
                            </div>
                        </div>
                        <button onclick="claimXP(10, 'daily')" class="bg-indigo-600 px-4 py-2 rounded-lg text-xs font-bold">Nh·∫≠n</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- MOBILE NAV -->
    <div class="fixed bottom-0 w-full glass border-t border-white/5 flex lg:hidden justify-around p-4 z-50">
        <i data-lucide="line-chart" onclick="switchTab('market')"></i>
        <i data-lucide="briefcase" onclick="switchTab('portfolio')"></i>
        <i data-lucide="award" onclick="switchTab('gamification')"></i>
        <i data-lucide="user" onclick="switchTab('profile')"></i>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        lucide.createIcons();

        let currentUser = null;
        let userData = { xp: 0, level: 1, portfolio: [] };
        const ADMIN_EMAIL = "your-email@gmail.com";

        // --- 2. AUTH & USER SYNC ---
        async function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await auth.signInWithPopup(provider);
            await syncUser(result.user);
        }

        async function syncUser(user) {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            
            if (!doc.exists) {
                const newProfile = {
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName,
                    photo: user.photoURL,
                    xp: 0,
                    level: 1,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                };
                await userRef.set(newProfile);
                userData = newProfile;
            } else {
                userData = doc.data();
                await userRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
            }
            updateUI();
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                syncUser(user);
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('user-preview').classList.remove('hidden');
                if(user.email === ADMIN_EMAIL) document.getElementById('admin-nav').classList.remove('hidden');
            }
        });

        function logout() { auth.signOut(); location.reload(); }

        // --- 3. MARKET DATA ---
        async function fetchMarket() {
            const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&sparkline=true');
            const coins = await res.json();
            const tbody = document.getElementById('market-tbody');
            tbody.innerHTML = coins.map((c, i) => `
                <tr class="border-b border-white/5 hover:bg-white/5 transition cursor-pointer">
                    <td class="p-4 text-gray-500">${i+1}</td>
                    <td class="p-4 flex items-center gap-3">
                        <img src="${c.image}" class="w-6 h-6">
                        <span class="font-bold">${c.name}</span> <span class="text-xs text-gray-500 uppercase">${c.symbol}</span>
                    </td>
                    <td class="p-4 text-right font-medium">$${c.current_price.toLocaleString()}</td>
                    <td class="p-4 text-right ${c.price_change_percentage_24h >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${c.price_change_percentage_24h.toFixed(2)}%
                    </td>
                    <td class="p-4 text-right text-gray-400 text-xs">$${(c.market_cap / 1e9).toFixed(2)}B</td>
                    <td class="p-4"><canvas id="spark-${c.id}" width="80" height="30"></canvas></td>
                </tr>
            `).join('');
            
            // Render Sparklines
            coins.forEach(c => renderSpark(`spark-${c.id}`, c.sparkline_in_7d.price, c.price_change_percentage_24h >= 0 ? '#4ade80' : '#f87171'));
        }

        function renderSpark(id, data, color) {
            const ctx = document.getElementById(id).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels: data.map((_,i)=>i), datasets: [{ data: data, borderColor: color, borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.4 }] },
                options: { responsive: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        // --- 4. PORTFOLIO LOGIC ---
        function addAssetManual() {
            if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
            const coin = prompt("Nh·∫≠p ID coin (v√≠ d·ª•: bitcoin):");
            const amount = prompt("S·ªë l∆∞·ª£ng:");
            const price = prompt("Gi√° v·ªën (USD):");
            
            if(coin && amount) {
                db.collection('users').doc(currentUser.uid).collection('portfolio').add({
                    coinId: coin, amount: parseFloat(amount), avgPrice: parseFloat(price), date: new Date()
                });
                alert("ƒê√£ th√™m v√†o Portfolio!");
                loadPortfolio();
            }
        }

        async function loadPortfolio() {
            if(!currentUser) return;
            const snap = await db.collection('users').doc(currentUser.uid).collection('portfolio').get();
            // X·ª≠ l√Ω t√≠nh to√°n PnL ·ªü ƒë√¢y b·∫±ng c√°ch fetch gi√° hi·ªán t·∫°i...
            document.getElementById('portfolio-list').innerHTML = `<p class="text-gray-500 text-center py-10">Danh m·ª•c ƒëang ƒë∆∞·ª£c ƒë·ªìng b·ªô h√≥a...</p>`;
        }

        // --- 5. GAMIFICATION ---
        async function claimXP(amt, type) {
            if(!currentUser) return alert("Login first!");
            const userRef = db.collection('users').doc(currentUser.uid);
            userData.xp += amt;
            if(userData.xp >= 100) { userData.level += 1; userData.xp = 0; }
            await userRef.update({ xp: userData.xp, level: userData.level });
            updateUI();
            alert(`B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ${amt} XP!`);
        }

        // --- 6. AIRDROPS ---
        function loadAirdrops() {
            const airdrops = [
                { name: "LayerZero", status: "Live", reward: "High", icon: "üîó" },
                { name: "ZkSync", status: "Ended", reward: "Very High", icon: "‚ö°" },
                { name: "Linea", status: "Upcoming", reward: "Medium", icon: "üåø" }
            ];
            document.getElementById('airdrop-list').innerHTML = airdrops.map(a => `
                <div class="glass p-6 rounded-3xl hover:border-indigo-500/50 transition cursor-pointer">
                    <div class="text-4xl mb-4">${a.icon}</div>
                    <h3 class="text-xl font-bold mb-1">${a.name}</h3>
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-xs px-2 py-1 rounded bg-white/5">${a.status}</span>
                        <span class="text-indigo-400 font-bold">${a.reward} Reward</span>
                    </div>
                </div>
            `).join('');
        }

        // --- UTILS ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            event.currentTarget.classList.add('active-tab');
        }

        function updateUI() {
            document.getElementById('u-name').innerText = userData.name;
            document.getElementById('u-avatar').src = userData.photo;
            document.getElementById('u-level').innerText = userData.level;
            document.getElementById('u-level-big').innerText = userData.level;
            document.getElementById('u-xp-progress').style.width = userData.xp + "%";
        }

        async function connectWallet() {
            if (window.ethereum) {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const addr = await signer.getAddress();
                document.getElementById('wallet-addr').innerText = addr.slice(0,6) + "..." + addr.slice(-4);
                // Sync address to Firestore...
            } else {
                alert("H√£y c√†i ƒë·∫∑t MetaMask!");
            }
        }

        // INIT
        window.onload = () => {
            fetchMarket();
            loadAirdrops();
            setInterval(fetchMarket, 60000);
        };
    </script>
</body>
</html>
