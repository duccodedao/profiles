<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Journey</title>
    <!-- Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- TON Connect SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #121212;
            --ton-blue: #0098EA;
            --accent: #7000FF;
            --text-main: #ffffff;
            --text-sub: #888;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.05);
            --success: #00E096;
            --danger: #FF3B30;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- LOADER --- */
        #loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #000; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #333;
            border-top-color: var(--ton-blue); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- STORY VIEW --- */
        #story-view { position: relative; width: 100%; height: 100%; display: none; }
        
        .slide {
            position: absolute; inset: 0; padding: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transform: scale(0.95);
            transition: all 0.5s ease; text-align: center;
        }
        .slide.active { opacity: 1; pointer-events: auto; transform: scale(1); }

        .big-number { font-family: 'Rajdhani', sans-serif; font-size: 50px; font-weight: 700; color: var(--ton-blue); margin: 10px 0; }
        .chapter { font-size: 10px; letter-spacing: 3px; color: #555; text-transform: uppercase; margin-bottom: 5px; }
        
        /* CODE INPUT STYLE */
        .code-box {
            background: var(--card-bg); border: var(--border);
            padding: 20px; border-radius: 16px; width: 100%; max-width: 300px;
            margin-top: 20px;
        }
        .code-input {
            width: 100%; padding: 12px; background: #000; border: 1px solid #333;
            color: white; text-align: center; letter-spacing: 2px;
            font-size: 16px; border-radius: 8px; margin-bottom: 10px;
            text-transform: uppercase; outline: none;
        }
        .code-input:focus { border-color: var(--ton-blue); }
        .btn-verify {
            width: 100%; padding: 12px; background: var(--ton-blue); color: white;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        }

        /* --- DASHBOARD VIEW (NEW) --- */
        #dashboard-view {
            display: none; flex-direction: column; height: 100%;
            padding: 20px; overflow-y: auto;
            background: radial-gradient(circle at top right, #1a1a2e 0%, #000 60%);
        }

        .dash-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-top: 10px;
        }
        .user-badge {
            display: flex; align-items: center; gap: 10px;
            background: var(--glass); padding: 5px 12px 5px 5px; border-radius: 30px; border: var(--border);
        }
        .u-avatar { width: 28px; height: 28px; border-radius: 50%; }
        .u-name { font-size: 12px; font-weight: 600; }

        /* BALANCE CARD */
        .balance-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px; padding: 30px 20px;
            text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .balance-label { font-size: 11px; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; }
        .balance-val { font-family: 'Rajdhani', sans-serif; font-size: 48px; font-weight: 700; color: white; margin: 5px 0; text-shadow: 0 0 20px rgba(0, 152, 234, 0.3); }
        .balance-est { font-size: 12px; color: var(--ton-blue); background: rgba(0, 152, 234, 0.1); padding: 4px 10px; border-radius: 12px; display: inline-block; }

        /* DEADLINE COUNTER */
        .deadline-box {
            margin-top: 20px; background: rgba(255, 59, 48, 0.05);
            border: 1px solid rgba(255, 59, 48, 0.2); border-radius: 12px;
            padding: 15px; text-align: center;
        }
        .deadline-lbl { color: var(--danger); font-size: 10px; font-weight: bold; margin-bottom: 5px; }
        .deadline-timer { font-family: monospace; font-size: 16px; font-weight: bold; color: white; }

        /* WALLET SECTION */
        .wallet-panel {
            margin-top: 20px; background: var(--card-bg);
            border: var(--border); border-radius: 16px; padding: 20px;
        }
        .wp-title { font-size: 14px; font-weight: 600; margin-bottom: 15px; display: flex; justify-content: space-between; }
        
        /* Connected State */
        .wallet-active {
            display: none; flex-direction: column; gap: 10px;
        }
        .w-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .w-val { font-family: monospace; color: var(--ton-blue); }
        .w-log { font-size: 10px; color: #555; margin-top: 10px; padding-top: 10px; border-top: 1px solid #222; }

        .btn-disconnect {
            background: rgba(255, 59, 48, 0.1); color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.3);
            width: 100%; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer;
            margin-top: 10px;
        }

        /* Not Connected State */
        .wallet-inactive { display: block; text-align: center; }
        .ton-btn-wrap { display: flex; justify-content: center; margin-top: 10px; }

        /* FOOTER NAV */
        .nav-btn {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; color: black; border: none;
            padding: 14px 40px; border-radius: 30px; font-weight: bold;
            box-shadow: 0 5px 20px rgba(255,255,255,0.1);
            cursor: pointer; z-index: 100;
        }

    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:15px; font-size:10px; color:#666; letter-spacing:2px">LOADING DATA...</div>
    </div>

    <!-- VIEW 1: STORY MODE -->
    <div id="story-view">
        <div class="slide active" id="slide-1">
            <i class="fab fa-telegram fa-4x" style="color:white; margin-bottom:20px"></i>
            <h1>The Journey</h1>
            <p style="color:#888; font-size:14px">Your legacy on Telegram.</p>
        </div>
        <div class="slide" id="slide-2">
            <div class="chapter">CHAPTER I</div>
            <h1>The Origin</h1>
            <div class="big-number" id="val-year">...</div>
            <div style="color:var(--ton-blue)" id="score-age">+0</div>
        </div>
        <div class="slide" id="slide-3">
            <div class="chapter">CHAPTER II</div>
            <h1>The Status</h1>
            <div class="big-number" id="val-prem">BASIC</div>
            <div style="color:var(--ton-blue)" id="score-prem">+0</div>
        </div>
        <div class="slide" id="slide-4">
            <div class="chapter">CHAPTER III</div>
            <h1>The Identity</h1>
            <img id="u-avatar" src="" style="width:80px; height:80px; border-radius:50%; margin:10px 0; border:2px solid white">
            <div id="u-username" style="font-weight:bold">...</div>
            <div style="color:var(--ton-blue)" id="score-id">+0</div>
        </div>
        <div class="slide" id="slide-5">
            <div class="chapter">VERIFICATION</div>
            <h1>Final Step</h1>
            <div class="big-number" id="total-score-story">0</div>
            
            <div class="code-box">
                <div style="font-size:12px; margin-bottom:10px; color:#aaa">ENTER SECRET CODE</div>
                <input type="text" id="code-input" class="code-input" placeholder="CODE">
                <button class="btn-verify" onclick="verifyCode()">VERIFY & UNLOCK</button>
            </div>
        </div>

        <button class="nav-btn" id="story-btn" onclick="nextSlide()">START</button>
    </div>

    <!-- VIEW 2: DASHBOARD MODE (Final Destination) -->
    <div id="dashboard-view">
        <div class="dash-header">
            <div class="user-badge">
                <img id="dash-avatar" src="" class="u-avatar">
                <div class="u-name" id="dash-name">User</div>
            </div>
            <div style="font-size:10px; color:#444">VERIFIED <i class="fas fa-check-circle" style="color:var(--success)"></i></div>
        </div>

        <div class="balance-card">
            <div class="balance-label">Available Balance</div>
            <div class="balance-val" id="dash-balance">0</div>
            <div class="balance-est">$TG TOKEN</div>
        </div>

        <div class="deadline-box">
            <div class="deadline-lbl">CONNECT WALLET DEADLINE</div>
            <div class="deadline-timer" id="deadline-timer">00d 00h 00m 00s</div>
            <div style="font-size:10px; color:#666; margin-top:5px">Withdraw starts: 31/12/2025</div>
        </div>

        <div class="wallet-panel">
            <div class="wp-title">
                <span><i class="fas fa-wallet"></i> Web3 Wallet</span>
                <span id="w-status" style="font-size:10px; color:#666">NOT CONNECTED</span>
            </div>

            <!-- Not Connected -->
            <div id="wallet-inactive" class="wallet-inactive">
                <p style="font-size:12px; color:#777; margin-bottom:15px">Connect your TON wallet to receive airdrop.</p>
                <div class="ton-btn-wrap">
                    <div id="ton-connect"></div>
                </div>
            </div>

            <!-- Connected -->
            <div id="wallet-active" class="wallet-active">
                <div class="w-row">
                    <span>Provider</span>
                    <span style="color:white" id="w-app">...</span>
                </div>
                <div class="w-row">
                    <span>Address</span>
                    <span class="w-val" id="w-addr">...</span>
                </div>
                <button class="btn-disconnect" onclick="disconnectWallet()">
                    <i class="fas fa-unlink"></i> DISCONNECT
                </button>
                <div class="w-log" id="w-history">No history.</div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // TON CONNECT
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        // STATE
        let userData = null;
        let scores = { total: 0 };
        let currentSlide = 1;
        const totalSlides = 5;

        // --- INIT ---
        async function init() {
            if (!tg.initData) {
                document.body.innerHTML = '<div style="color:red; text-align:center; padding:50px">Mobile Access Only</div>';
                return;
            }

            tg.expand();
            tg.setHeaderColor('#000000');
            userData = tg.initDataUnsafe.user;
            // userData = { id: 123456, first_name: "Test", username: "dev", is_premium: true, photo_url: "" }; // Mock

            calculateScore(userData);
            startCountdown();

            // Check DB Status
            await checkUserDB();
        }

        // --- DATA & LOGIC ---
        function calculateScore(user) {
            const id = user.id;
            let year = 2024;
            let ageScore = 100;

            if(id < 1000000000) { year = 2020; ageScore = 1000; }
            if(id < 500000000) { year = 2017; ageScore = 3000; }
            
            const premScore = user.is_premium ? 5000 : 0;
            const idScore = (user.username ? 500 : 0) + (user.photo_url ? 300 : 0);
            scores.total = ageScore + premScore + idScore;

            // Render Story Data
            document.getElementById('val-year').innerText = year;
            document.getElementById('score-age').innerText = `+${ageScore}`;
            document.getElementById('val-prem').innerText = user.is_premium ? "PREMIUM" : "BASIC";
            document.getElementById('score-prem').innerText = `+${premScore}`;
            if(user.photo_url) document.getElementById('u-avatar').src = user.photo_url;
            document.getElementById('u-username').innerText = user.username || user.first_name;
            document.getElementById('score-id').innerText = `+${idScore}`;
            document.getElementById('total-score-story').innerText = scores.total;

            // Render Dashboard Data
            if(user.photo_url) document.getElementById('dash-avatar').src = user.photo_url;
            document.getElementById('dash-name').innerText = user.first_name;
        }

        async function checkUserDB() {
            try {
                const docRef = doc(db, "users", userData.id.toString());
                const snap = await getDoc(docRef);
                
                document.getElementById('loader').style.display = 'none';

                if(snap.exists() && snap.data().isAnalyzed) {
                    // USER EXISTS -> SKIP STORY -> GOTO DASHBOARD
                    const data = snap.data();
                    const convertedScore = Math.floor(data.score / 10); // Ratio 1:10
                    document.getElementById('dash-balance').innerText = convertedScore.toLocaleString();
                    
                    if(data.lastWalletAction) {
                        document.getElementById('w-history').innerText = "Last update: " + data.lastWalletAction;
                    }
                    
                    showDashboard();
                } else {
                    // NEW USER -> SHOW STORY
                    document.getElementById('story-view').style.display = 'block';
                }
            } catch(e) { console.error(e); }
        }

        // --- STORY NAVIGATION ---
        window.nextSlide = () => {
            if(currentSlide >= totalSlides) return;
            
            tg.HapticFeedback.impactOccurred('light');
            document.getElementById(`slide-${currentSlide}`).classList.remove('active');
            currentSlide++;
            document.getElementById(`slide-${currentSlide}`).classList.add('active');

            if(currentSlide === 5) {
                document.getElementById('story-btn').style.display = 'none';
            } else {
                document.getElementById('story-btn').innerText = "NEXT";
            }
        }

        // --- VERIFICATION ---
        window.verifyCode = async () => {
            const input = document.getElementById('code-input').value.trim().toUpperCase();
            if(input === "ILOVETG") {
                tg.HapticFeedback.notificationOccurred('success');
                
                // Save to DB
                const ref = doc(db, "users", userData.id.toString());
                await setDoc(ref, {
                    id: userData.id,
                    username: userData.username || "",
                    score: scores.total,
                    isAnalyzed: true, // Mark as analyzed/verified
                    isVerified: true,
                    lastSeen: serverTimestamp()
                }, { merge: true });

                // Convert & Go to Dashboard
                const converted = Math.floor(scores.total / 10);
                document.getElementById('dash-balance').innerText = converted.toLocaleString();
                
                document.getElementById('story-view').classList.add('fade-out'); // simple transition
                setTimeout(() => {
                    document.getElementById('story-view').style.display = 'none';
                    showDashboard();
                }, 500);

            } else {
                tg.HapticFeedback.notificationOccurred('error');
                tg.showAlert("Invalid Code. Hint: ILOVETG");
            }
        }

        function showDashboard() {
            const dash = document.getElementById('dashboard-view');
            dash.style.display = 'flex';
            dash.classList.add('fade-in');
        }

        // --- WALLET LOGIC ---
        // 1. Monitor Connection
        tonConnectUI.onStatusChange(async (wallet) => {
            const activeDiv = document.getElementById('wallet-active');
            const inactiveDiv = document.getElementById('wallet-inactive');
            const statusLbl = document.getElementById('w-status');

            if(wallet) {
                // CONNECTED
                inactiveDiv.style.display = 'none';
                activeDiv.style.display = 'flex';
                statusLbl.innerText = "CONNECTED";
                statusLbl.style.color = "var(--success)";

                const raw = wallet.account.address;
                const short = raw.slice(0,4) + "..." + raw.slice(-4);
                const appName = wallet.device.appName || "Wallet";

                document.getElementById('w-app').innerText = appName;
                document.getElementById('w-addr').innerText = short;

                // Log History (Connect)
                await logWalletAction(`Connected ${appName}`);

            } else {
                // DISCONNECTED
                activeDiv.style.display = 'none';
                inactiveDiv.style.display = 'block';
                statusLbl.innerText = "NOT CONNECTED";
                statusLbl.style.color = "#666";
            }
        });

        // 2. Disconnect Action
        window.disconnectWallet = async () => {
            await tonConnectUI.disconnect();
            await logWalletAction("Disconnected Wallet");
        }

        // 3. Log History Helper
        async function logWalletAction(action) {
            const time = new Date().toLocaleString();
            document.getElementById('w-history').innerText = `${action} at ${time}`;
            
            // Save to DB
            try {
                const ref = doc(db, "users", userData.id.toString());
                await updateDoc(ref, {
                    lastWalletAction: `${action} at ${time}`
                });
            } catch(e) {}
        }

        // --- COUNTDOWN TIMER (Connect Deadline) ---
        // Deadline: 30/12/2025 (1 day before withdraw 31/12)
        function startCountdown() {
            const deadline = new Date("Dec 30, 2025 00:00:00").getTime();
            setInterval(() => {
                const now = new Date().getTime();
                const dist = deadline - now;
                
                if(dist < 0) {
                    document.getElementById('deadline-timer').innerText = "ENDED";
                    return;
                }

                const d = Math.floor(dist / (1000 * 60 * 60 * 24));
                const h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((dist % (1000 * 60)) / 1000);

                document.getElementById('deadline-timer').innerText = `${d}d ${h}h ${m}m ${s}s`;
            }, 1000);
        }

        init();
    </script>
</body>
</html>
