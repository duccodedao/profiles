<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Elite Protocol</title>
    
    <!-- CORE SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    
    <!-- ANIMATION & FONTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rajdhani:wght@600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050505;
            --surface: #121212;
            --surface-light: #1e1e1e;
            --primary: #00f2ea;
            --primary-dim: rgba(0, 242, 234, 0.15);
            --secondary: #7000ff;
            --danger: #ff2d55;
            --success: #32d74b;
            --text-main: #ffffff;
            --text-muted: #8899a6;
            --font-head: 'Rajdhani', sans-serif;
            --font-body: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-body);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- GLOBAL UTILS --- */
        .hidden { display: none !important; }
        .full-width { width: 100%; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        
        .btn-base {
            width: 100%; border: none; padding: 16px; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
            font-family: var(--font-head); text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-base:active { transform: scale(0.97); opacity: 0.9; }

        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 20px rgba(0, 242, 234, 0.3); }
        .btn-glass { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.1); }

        /* --- SCREENS --- */
        .screen { position: fixed; inset: 0; background: var(--bg-dark); z-index: 100; flex-direction: column; }
        
        /* LOADER */
        .loader-box { text-align: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite linear; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- MAIN APP LAYOUT --- */
        #app-container {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; overflow-x: hidden;
            padding-bottom: calc(var(--nav-height) + 20px); /* Space for nav */
        }

        /* HEADER / USER CARD */
        .header-section { padding: 20px 20px 0 20px; }
        .user-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; overflow: hidden;
        }
        .user-card::before {
            content: ''; position: absolute; top: -50px; right: -50px; width: 100px; height: 100px;
            background: var(--primary); filter: blur(60px); opacity: 0.2;
        }
        .user-top { display: flex; justify-content: space-between; align-items: center; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 48px; height: 48px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #888; border: 2px solid var(--primary-dim); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: rgba(255,255,255,0.03); border-radius: 12px; padding: 10px; text-align: center; }
        .stat-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
        .stat-val { font-size: 16px; font-weight: bold; font-family: var(--font-code); color: var(--primary); }

        /* BALANCE MAIN */
        .balance-section { text-align: center; margin: 30px 0; }
        .balance-huge { font-size: 56px; font-weight: 800; font-family: var(--font-head); line-height: 1; text-shadow: 0 0 20px rgba(0, 242, 234, 0.2); }
        .balance-label { color: var(--text-muted); font-size: 12px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }

        /* TABS CONTENT */
        .tab-content { display: none; padding: 0 20px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* EARN TAB */
        .input-code-box {
            background: var(--surface-light); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05);
            text-align: center; margin-bottom: 20px;
        }
        .code-input {
            width: 100%; background: #000; border: 1px solid #333; color: #fff;
            padding: 14px; text-align: center; font-family: var(--font-code); font-size: 20px;
            border-radius: 10px; margin-bottom: 15px; outline: none; text-transform: uppercase;
        }
        .code-input:focus { border-color: var(--primary); }

        /* HISTORY TAB */
        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .hist-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--surface); padding: 15px; border-radius: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .hist-left { display: flex; align-items: center; gap: 12px; }
        .hist-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .hist-amount { font-family: var(--font-code); font-weight: bold; }
        .hist-amount.plus { color: var(--success); }
        .hist-amount.minus { color: var(--danger); }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 90; padding-bottom: 10px; /* Safe area */
        }
        .nav-item {
            flex: 1; text-align: center; color: #666; font-size: 10px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px; padding-top: 10px;
        }
        .nav-item i { font-size: 20px; margin-bottom: 2px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-2px); text-shadow: 0 0 10px var(--primary); }

        /* ADMIN BUTTON */
        #admin-float-btn {
            position: fixed; top: 15px; right: 15px; z-index: 99;
            background: rgba(255, 45, 85, 0.2); border: 1px solid var(--danger); color: var(--danger);
            padding: 6px 12px; border-radius: 20px; font-size: 10px; font-weight: bold;
            backdrop-filter: blur(4px); cursor: pointer;
        }

        /* ADMIN PANEL */
        .admin-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200;
            padding: 20px; display: flex; flex-direction: column;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .admin-modal.open { transform: translateY(0); }
    </style>
</head>
<body>

    <!-- === SYSTEM LAYERS === -->
    
    <!-- 1. LOADING -->
    <div id="loader" class="screen flex-center">
        <div class="loader-box">
            <div class="spinner"></div>
            <div style="font-family: var(--font-code); font-size: 12px; letter-spacing: 2px;">SYNCING DATA...</div>
        </div>
    </div>

    <!-- 2. BANNED -->
    <div id="banned-screen" class="screen hidden flex-center" style="background: #000;">
        <i class="fas fa-ban" style="font-size: 50px; color: var(--danger); margin-bottom: 20px;"></i>
        <h2 style="color: var(--danger); font-family: var(--font-head);">ACCOUNT RESTRICTED</h2>
        <p style="color: #666; font-size: 13px;">Suspicious activity detected.</p>
    </div>

    <!-- 3. ADMIN BUTTON (Conditional) -->
    <div id="admin-float-btn" class="hidden" onclick="openAdmin()">OP MODE</div>

    <!-- === MAIN APPLICATION === -->
    <div id="app-container" class="hidden">
        
        <!-- HEADER: USER CARD -->
        <div class="header-section">
            <div class="user-card">
                <div class="user-top">
                    <div class="user-info">
                        <div class="avatar"><i class="fas fa-user"></i></div>
                        <div>
                            <div style="font-weight: 700; font-size: 16px;" id="disp-name">User</div>
                            <div style="font-size: 11px; color: var(--primary); font-family: var(--font-code);">ID: <span id="disp-id">---</span></div>
                        </div>
                    </div>
                    <div id="badge-premium" class="hidden">
                        <i class="fas fa-star" style="color: #FFD700; font-size: 18px; filter: drop-shadow(0 0 5px #FFD700);"></i>
                    </div>
                </div>

                <!-- Live Stats in Card -->
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-label">ACCOUNT AGE</div>
                        <div class="stat-val"><span id="stat-age">0</span> YRS</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">RANK</div>
                        <div class="stat-val" id="stat-rank">ROOKIE</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 1: HOME (DASHBOARD) -->
        <div id="tab-home" class="tab-content active">
            <div class="balance-section">
                <div class="balance-label">Total Points</div>
                <div class="balance-huge" id="main-balance">0</div>
                <div style="margin-top: 5px; font-size: 12px; color: var(--success); background: rgba(50, 215, 75, 0.1); display: inline-block; padding: 4px 10px; border-radius: 6px;">
                    <i class="fas fa-wifi"></i> LIVE SYNC
                </div>
            </div>

            <!-- Main Actions -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Wallet Connect -->
                <div style="background: var(--surface); padding: 15px; border-radius: 12px; text-align: center;">
                     <div style="font-size: 11px; color: #666; margin-bottom: 10px;">TON WALLET CONNECTION</div>
                     <div id="ton-connect-btn" style="width: 100%;"></div>
                </div>

                <button class="btn-base btn-glass" onclick="showWithdrawLock()">
                    <i class="fas fa-vault"></i> WITHDRAW (LOCKED)
                </button>
            </div>
        </div>

        <!-- TAB 2: EARN (DAILY CODE) -->
        <div id="tab-earn" class="tab-content">
            <h2 style="font-family: var(--font-head); margin: 20px 0;">DAILY MISSIONS</h2>
            
            <div class="input-code-box">
                <i class="fas fa-qrcode" style="font-size: 30px; color: var(--primary); margin-bottom: 15px;"></i>
                <h3 style="margin: 0 0 10px 0;">ENTER SECRET CODE</h3>
                <p style="font-size: 12px; color: #888; margin-bottom: 20px;">Find the daily code in our channel to earn points.</p>
                
                <input type="text" class="code-input" id="daily-code-input" placeholder="INPUT CODE HERE">
                <button class="btn-base btn-primary" onclick="submitDailyCode()">CLAIM REWARD</button>
            </div>

            <div style="padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px;">
                <div style="font-size: 12px; color: #888; margin-bottom: 10px;">MORE TASKS</div>
                <div class="hist-item" style="background: transparent; border: 1px solid rgba(255,255,255,0.05);">
                    <div class="hist-left">
                        <i class="fab fa-telegram" style="color: #2AABEE; font-size: 24px;"></i>
                        <div>Join Channel</div>
                    </div>
                    <div class="hist-amount plus">+500</div>
                </div>
            </div>
        </div>

        <!-- TAB 3: HISTORY -->
        <div id="tab-history" class="tab-content">
            <h2 style="font-family: var(--font-head); margin: 20px 0;">TRANSACTION LOG</h2>
            <div id="history-list" class="history-list">
                <!-- Items will be injected here via JS -->
                <div style="text-align: center; color: #666; margin-top: 30px; font-size: 12px;">Loading history...</div>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAVIGATION -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <i class="fas fa-home"></i> <span>HOME</span>
        </div>
        <div class="nav-item" onclick="switchTab('earn')">
            <i class="fas fa-bolt"></i> <span>EARN</span>
        </div>
        <div class="nav-item" onclick="switchTab('history')">
            <i class="fas fa-history"></i> <span>HISTORY</span>
        </div>
    </div>

    <!-- ADMIN OVERLAY -->
    <div id="admin-panel" class="admin-modal">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: var(--danger);">ADMIN CONSOLE</h2>
            <button onclick="closeAdmin()" style="background: none; border: none; color: #fff; font-size: 24px;"><i class="fas fa-times"></i></button>
        </div>
        
        <div style="background: #111; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <div style="font-size: 10px; color: #888;">TARGET USER ID</div>
            <input type="text" id="adm-uid" class="code-input" style="margin: 5px 0; font-size: 16px;" placeholder="Telegram ID">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-base" style="background: #222; font-size: 12px;" onclick="admAction('CHECK')">CHECK INFO</button>
                <button class="btn-base btn-primary" style="font-size: 12px;" onclick="admAction('ADD_1000')">+1000 PTS</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <button class="btn-base" style="background: rgba(255,45,85,0.2); color: var(--danger); font-size: 12px;" onclick="admAction('BAN')">BAN</button>
                <button class="btn-base" style="background: rgba(50,215,75,0.2); color: var(--success); font-size: 12px;" onclick="admAction('UNBAN')">UNBAN</button>
            </div>
        </div>

        <div id="adm-log" style="font-family: var(--font-code); font-size: 10px; color: #aaa; height: 100px; overflow-y: auto; background: #000; padding: 10px;">
            Waiting for input...
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        /* --- CONFIGURATION --- */
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        
        const ADMIN_ID = 5387725104;
        const ADMIN_WALLET = "0:eef2fc994996c062f45143f8d6e3fd048811a26c01aaef6c126636164663401a";
        const DAILY_CODE_SECRET = "ELITE2024"; // Simple Client Check for Demo (In prod, check DB)

        /* --- INIT SERVICES --- */
        let db;
        try { const app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e){console.error(e);}

        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#050505');
        
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn',
            uiPreferences: { theme: 'DARK', borderRadius: 'm' }
        });

        /* --- STATE --- */
        let currentUser = tg.initDataUnsafe.user;
        // MOCK USER FOR BROWSER TESTING
        if(!currentUser) {
            // currentUser = { id: 5387725104, first_name: "Admin", username: "admin_god", is_premium: true, language_code: "vi" }; 
        }

        let userScore = 0;
        let isAdmin = false;

        /* --- UTILS --- */
        function haptic(type = 'light') {
            if(!tg.HapticFeedback) return;
            if(type === 'success') tg.HapticFeedback.notificationOccurred('success');
            else if(type === 'error') tg.HapticFeedback.notificationOccurred('error');
            else tg.HapticFeedback.impactOccurred(type);
        }

        function formatNum(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        /* --- CORE LOGIC --- */
        async function initApp() {
            if(!currentUser) {
                document.body.innerHTML = "<div class='screen flex-center' style='color:#fff'>Please open in Telegram</div>";
                return;
            }

            // Bind UI
            document.getElementById('disp-name').innerText = currentUser.first_name + (currentUser.last_name ? " " + currentUser.last_name : "");
            document.getElementById('disp-id').innerText = currentUser.id;
            if(currentUser.is_premium) document.getElementById('badge-premium').classList.remove('hidden');

            // Admin Check
            checkAdmin();
            tonConnectUI.onStatusChange(() => checkAdmin());

            // Load Data
            await loadUserData();
        }

        function checkAdmin() {
            let authorized = false;
            if(currentUser.id === ADMIN_ID) authorized = true;
            if(tonConnectUI.wallet && tonConnectUI.wallet.account.address === ADMIN_WALLET) authorized = true;
            
            if(authorized) {
                isAdmin = true;
                document.getElementById('admin-float-btn').classList.remove('hidden');
            }
        }

        /* --- SCORING SYSTEM --- */
        function calculateBaseScore(user) {
            let score = 0;
            const id = user.id;

            // 1. Account Age (Based on ID range estimation)
            // Telegram IDs grow over time. Lower ID = Older account.
            let creationYear = 2024;
            if (id < 6000000000) creationYear = 2023;
            if (id < 5000000000) creationYear = 2022;
            if (id < 2000000000) creationYear = 2020;
            if (id < 1000000000) creationYear = 2018;
            if (id < 500000000) creationYear = 2016;

            const ageYears = 2025 - creationYear;
            document.getElementById('stat-age').innerText = ageYears;
            
            score += ageYears * 500; // 500 points per year

            // 2. Premium
            if(user.is_premium) score += 2000;

            // 3. Profile Completeness
            if(user.username) score += 500;
            if(user.last_name) score += 200;
            
            // 4. Language Bonus (e.g., Target market VN)
            if(user.language_code === 'vi') score += 300;

            return score;
        }

        async function loadUserData() {
            if(!db) return; // Fallback
            
            try {
                const userRef = doc(db, "users", currentUser.id.toString());
                const snap = await getDoc(userRef);
                
                if(snap.exists()) {
                    const data = snap.data();
                    if(data.isBanned) {
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('banned-screen').classList.remove('hidden');
                        return;
                    }
                    userScore = data.score;
                } else {
                    // New User: Calculate Initial Score & Save
                    userScore = calculateBaseScore(currentUser);
                    await setDoc(userRef, {
                        id: currentUser.id,
                        first_name: currentUser.first_name,
                        username: currentUser.username || "",
                        score: userScore,
                        joinedAt: serverTimestamp(),
                        deviceId: "init"
                    });
                    
                    // Log Initial History
                    await logHistory("Account Analysis", userScore, "plus");
                }

                // Update UI
                updateUI();
                
                // Show App
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                // Load History List
                loadHistoryList();

            } catch(e) {
                console.error(e);
                // Fallback UI if DB fails
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
            }
        }

        function updateUI() {
            // Animate Score
            const el = document.getElementById('main-balance');
            gsap.to(el, { innerText: userScore, duration: 1.5, snap: { innerText: 1 }, onUpdate: function() {
                el.innerText = formatNum(Math.ceil(this.targets()[0].innerText));
            }});

            // Rank Logic
            let rank = "ROOKIE";
            if(userScore > 5000) rank = "ELITE";
            if(userScore > 10000) rank = "MASTER";
            if(userScore > 20000) rank = "LEGEND";
            document.getElementById('stat-rank').innerText = rank;
            if(rank === "LEGEND") document.getElementById('stat-rank').style.color = "#FFD700";
        }

        /* --- FEATURES --- */
        
        // 1. TABS
        window.switchTab = (tabName) => {
            haptic('light');
            
            // Nav Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Find click target's parent if icon clicked, or self
            const clicked = event.currentTarget;
            clicked.classList.add('active');

            // Content Visibility
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // 2. DAILY CODE
        window.submitDailyCode = async () => {
            haptic('medium');
            const input = document.getElementById('daily-code-input');
            const code = input.value.trim().toUpperCase();

            if(!code) return;

            // In real app, check against a DB collection 'daily_codes'
            if(code === DAILY_CODE_SECRET) {
                // Check if already claimed today (LocalStorage for simple demo, DB preferred)
                const today = new Date().toDateString();
                const lastClaim = localStorage.getItem('last_claim_' + currentUser.id);

                if(lastClaim === today) {
                    tg.showAlert("You already claimed the daily reward today!");
                    haptic('error');
                    return;
                }

                // Reward
                const reward = 1000;
                await updateScore(reward, "Daily Code: " + code);
                
                localStorage.setItem('last_claim_' + currentUser.id, today);
                input.value = "";
                tg.showAlert(`Success! +${reward} Points`);
                haptic('success');
            } else {
                tg.showAlert("Invalid Code");
                haptic('error');
                input.classList.add('shake'); // CSS animation could be added here
            }
        }

        async function updateScore(amount, reason) {
            userScore += amount;
            updateUI(); // Immediate UI update
            
            if(db) {
                const ref = doc(db, "users", currentUser.id.toString());
                await updateDoc(ref, { score: userScore });
                await logHistory(reason, amount, amount > 0 ? "plus" : "minus");
            }
        }

        // 3. HISTORY
        async function logHistory(title, amount, type) {
            if(!db) return;
            const histRef = collection(db, "users", currentUser.id.toString(), "history");
            await addDoc(histRef, {
                title: title,
                amount: amount,
                type: type,
                createdAt: serverTimestamp()
            });
            loadHistoryList(); // Refresh list
        }

        async function loadHistoryList() {
            if(!db) return;
            const listEl = document.getElementById('history-list');
            
            const histRef = collection(db, "users", currentUser.id.toString(), "history");
            const q = query(histRef, orderBy("createdAt", "desc"), limit(20));
            const snaps = await getDocs(q);

            if(snaps.empty) {
                listEl.innerHTML = "<div style='text-align:center; color:#444; margin-top:20px;'>No transactions yet</div>";
                return;
            }

            let html = "";
            snaps.forEach(doc => {
                const d = doc.data();
                const icon = d.type === 'plus' ? 'arrow-down' : 'arrow-up';
                const colorClass = d.type === 'plus' ? 'plus' : 'minus';
                const sign = d.type === 'plus' ? '+' : '';
                
                html += `
                <div class="hist-item">
                    <div class="hist-left">
                        <div class="hist-icon"><i class="fas fa-${icon}" style="color: ${d.type === 'plus' ? 'var(--success)' : 'var(--danger)'}"></i></div>
                        <div>
                            <div style="font-weight:600; font-size:13px;">${d.title}</div>
                            <div style="font-size:10px; color:#666;">${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleDateString() : 'Just now'}</div>
                        </div>
                    </div>
                    <div class="hist-amount ${colorClass}">${sign}${formatNum(d.amount)}</div>
                </div>
                `;
            });
            listEl.innerHTML = html;
        }

        window.showWithdrawLock = () => {
            haptic('warning');
            tg.showPopup({
                title: "Locked",
                message: "Withdrawals will open after the TGE event. Keep earning points!",
                buttons: [{type: "ok"}]
            });
        }

        /* --- ADMIN PANEL LOGIC --- */
        window.openAdmin = () => document.getElementById('admin-panel').classList.add('open');
        window.closeAdmin = () => document.getElementById('admin-panel').classList.remove('open');

        window.admAction = async (action) => {
            const uid = document.getElementById('adm-uid').value.trim();
            const log = document.getElementById('adm-log');
            if(!uid) { log.innerText = "Please enter UID"; return; }

            const targetRef = doc(db, "users", uid);

            try {
                if(action === 'CHECK') {
                    const snap = await getDoc(targetRef);
                    if(snap.exists()) log.innerText = JSON.stringify(snap.data(), null, 2);
                    else log.innerText = "User not found";
                }
                else if(action === 'ADD_1000') {
                    const snap = await getDoc(targetRef);
                    if(snap.exists()) {
                        const newScore = (snap.data().score || 0) + 1000;
                        await updateDoc(targetRef, { score: newScore });
                        // Log for user
                        await addDoc(collection(db, "users", uid, "history"), {
                            title: "Admin Grant", amount: 1000, type: "plus", createdAt: serverTimestamp()
                        });
                        log.innerText = `Added 1000 to ${uid}`;
                    }
                }
                else if(action === 'BAN') {
                    await updateDoc(targetRef, { isBanned: true });
                    log.innerText = `Banned ${uid}`;
                }
                else if(action === 'UNBAN') {
                    await updateDoc(targetRef, { isBanned: false });
                    log.innerText = `Unbanned ${uid}`;
                }
            } catch(e) {
                log.innerText = "Error: " + e.message;
            }
        }

        // Start
        initApp();

    </script>
</body>
</html>
