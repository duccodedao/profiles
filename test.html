<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexth - Premium Crypto Portfolio</title>
    <!-- External Assets -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --glass-bg: rgba(17, 24, 39, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #020617);
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
        }
        .glass-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
            border: 1px solid var(--glass-border);
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .glass-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        .animate-pulse-slow {
            animation: pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .crypto-gradient-text {
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.1);
            border-right: 3px solid var(--accent-primary);
            color: var(--accent-primary);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950 px-4">
        <div class="glass p-8 max-w-md w-full text-center space-y-6 border-slate-800 shadow-2xl">
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i data-lucide="shield-check" class="w-10 h-10 text-white"></i>
                </div>
            </div>
            <h1 class="text-3xl font-bold tracking-tight">Nexth <span class="crypto-gradient-text">Pro</span></h1>
            <p class="text-slate-400">The ultimate institutional-grade crypto asset management dashboard.</p>
            <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white text-slate-900 py-3.5 px-4 rounded-xl font-semibold hover:bg-slate-100 transition-all active:scale-[0.98]">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81.63z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Continue with Google
            </button>
            <div id="login-loader" class="hidden flex justify-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="app-shell" class="hidden min-h-screen flex">
        <!-- Sidebar -->
        <aside class="w-64 border-r border-slate-800 bg-slate-950/50 backdrop-blur-xl hidden lg:flex flex-col fixed inset-y-0 z-50">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="layers" class="w-5 h-5 text-white"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight">Nexth</span>
                </div>
                
                <nav class="space-y-1">
                    <button data-nav="dashboard" class="sidebar-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
                    </button>
                    <button data-nav="watchlist" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="star" class="w-4 h-4"></i> Watchlist
                    </button>
                    <button data-nav="alerts" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="bell" class="w-4 h-4"></i> Alerts
                    </button>
                    <button data-nav="transactions" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="arrow-left-right" class="w-4 h-4"></i> Transactions
                    </button>
                    <div id="admin-nav-link" class="hidden pt-4 mt-4 border-t border-slate-800">
                        <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Internal</p>
                        <button data-nav="admin" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-purple-400">
                            <i data-lucide="shield" class="w-4 h-4"></i> Admin Panel
                        </button>
                    </div>
                </nav>
            </div>

            <div class="mt-auto p-4 border-t border-slate-800">
                <div class="flex items-center gap-3 p-2 bg-slate-900/50 rounded-xl">
                    <img id="user-avatar" src="" alt="" class="w-10 h-10 rounded-full border border-slate-700 bg-slate-800">
                    <div class="flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-medium truncate"></p>
                        <p id="user-role" class="text-xs text-slate-500 capitalize"></p>
                    </div>
                    <button id="logout-btn" class="p-2 text-slate-400 hover:text-red-400 transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-64 relative flex flex-col">
            <!-- Navbar -->
            <header class="h-16 border-b border-slate-800 bg-slate-950/20 backdrop-blur-md sticky top-0 z-40 flex items-center justify-between px-6">
                <div class="flex items-center gap-4">
                    <h2 id="view-title" class="text-lg font-semibold capitalize">Dashboard</h2>
                    <div id="price-ticker" class="hidden md:flex items-center gap-4 text-xs font-medium border-l border-slate-800 pl-4">
                        <div class="flex items-center gap-1.5">
                            <span class="text-slate-500">BTC</span>
                            <span id="ticker-btc" class="text-slate-200">$0.00</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <span class="text-slate-500">ETH</span>
                            <span id="ticker-eth" class="text-slate-200">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button id="connect-wallet-btn" class="flex items-center gap-2 bg-blue-600/10 text-blue-400 border border-blue-500/20 px-4 py-2 rounded-xl text-sm font-semibold hover:bg-blue-600/20 transition-all">
                        <i data-lucide="wallet" class="w-4 h-4"></i>
                        <span id="wallet-text">Connect Wallet</span>
                    </button>
                </div>
            </header>

            <!-- Dynamic View Container -->
            <div id="view-content" class="p-6">
                
                <!-- Dashboard View -->
                <div id="view-dashboard" class="space-y-6">
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
                            <div class="relative z-10">
                                <p class="text-sm font-medium text-slate-400 mb-1">Total Net Worth</p>
                                <h3 id="portfolio-value" class="text-3xl font-bold tracking-tight text-white">$0.00</h3>
                                <div class="flex items-center gap-2 mt-3">
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-400 font-bold">+0.00%</span>
                                    <span class="text-xs text-slate-500">vs yesterday</span>
                                </div>
                            </div>
                            <div class="absolute -right-4 -bottom-4 opacity-5 group-hover:scale-110 transition-transform duration-500">
                                <i data-lucide="banknote" class="w-32 h-32"></i>
                            </div>
                        </div>

                        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
                            <div class="relative z-10">
                                <p class="text-sm font-medium text-slate-400 mb-1">Native Balance</p>
                                <h3 id="native-balance" class="text-3xl font-bold tracking-tight text-white">0.00 ETH</h3>
                                <p id="native-chain" class="text-xs text-slate-500 mt-3 font-medium uppercase tracking-widest">Mainnet</p>
                            </div>
                            <div class="absolute -right-4 -bottom-4 opacity-5 group-hover:scale-110 transition-transform duration-500">
                                <i data-lucide="coins" class="w-32 h-32"></i>
                            </div>
                        </div>

                        <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
                            <div class="relative z-10">
                                <p class="text-sm font-medium text-slate-400 mb-1">Active Alerts</p>
                                <h3 id="alert-count" class="text-3xl font-bold tracking-tight text-white">0</h3>
                                <p class="text-xs text-slate-500 mt-3 font-medium">Monitoring 24/7</p>
                            </div>
                            <div class="absolute -right-4 -bottom-4 opacity-5 group-hover:scale-110 transition-transform duration-500">
                                <i data-lucide="activity" class="w-32 h-32"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Market Overview -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        <div class="glass p-6 border-slate-800">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-bold flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-blue-400"></i> Market Leaders</h3>
                                <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Real-time update</span>
                            </div>
                            <div id="market-list" class="space-y-4">
                                <!-- JS Injected Content -->
                                <div class="shimmer h-12 rounded-lg"></div>
                                <div class="shimmer h-12 rounded-lg"></div>
                                <div class="shimmer h-12 rounded-lg"></div>
                            </div>
                        </div>

                        <div class="glass p-6 border-slate-800">
                            <h3 class="font-bold mb-6 flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4 text-purple-400"></i> Portfolio Distribution</h3>
                            <div class="h-64 flex items-center justify-center">
                                <canvas id="portfolioChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Watchlist View -->
                <div id="view-watchlist" class="hidden space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-2xl font-bold">Watchlist</h3>
                        <button id="add-token-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Add Token
                        </button>
                    </div>
                    <div class="glass overflow-hidden border-slate-800">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900/50 border-b border-slate-800">
                                <tr>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Asset</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Price</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase text-right">24h Change</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="watchlist-table-body" class="divide-y divide-slate-800/50">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Alerts View -->
                <div id="view-alerts" class="hidden space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-2xl font-bold">Price Alerts</h3>
                        <button onclick="ui.modals.open('alert')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-2">
                            <i data-lucide="bell-plus" class="w-4 h-4"></i> Create Alert
                        </button>
                    </div>
                    <div id="alerts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- JS Injected -->
                    </div>
                </div>

                <!-- Admin View -->
                <div id="view-admin" class="hidden space-y-6">
                    <h3 class="text-2xl font-bold crypto-gradient-text">Admin Command Center</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="glass p-4">
                            <p class="text-xs text-slate-500 uppercase font-bold">Total Users</p>
                            <p id="admin-stat-users" class="text-2xl font-bold">0</p>
                        </div>
                        <div class="glass p-4">
                            <p class="text-xs text-slate-500 uppercase font-bold">Platform TVL</p>
                            <p id="admin-stat-tvl" class="text-2xl font-bold">$0</p>
                        </div>
                        <div class="glass p-4">
                            <p class="text-xs text-slate-500 uppercase font-bold">System Status</p>
                            <p class="text-2xl font-bold text-emerald-400 flex items-center gap-2"><span class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></span> Online</p>
                        </div>
                    </div>
                    <div class="glass p-6 border-slate-800">
                        <h4 class="font-bold mb-4">Registered Wallets</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="border-b border-slate-800 text-slate-500">
                                    <tr>
                                        <th class="py-3">User</th>
                                        <th class="py-3">Wallet</th>
                                        <th class="py-3">Role</th>
                                        <th class="py-3 text-right">Balance</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-users-table" class="divide-y divide-slate-800">
                                    <!-- JS Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Transactions View -->
                <div id="view-transactions" class="hidden space-y-6">
                    <h3 class="text-2xl font-bold">Wallet Activity</h3>
                    <div id="tx-empty-state" class="glass p-12 text-center">
                        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="history" class="w-8 h-8 text-slate-500"></i>
                        </div>
                        <p class="text-slate-400">Connect your wallet to see recent transactions.</p>
                    </div>
                    <div id="tx-container" class="hidden glass divide-y divide-slate-800 border-slate-800 overflow-hidden">
                        <!-- JS Injected -->
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" onclick="ui.modals.close()"></div>
        <!-- Alert Modal -->
        <div id="modal-alert" class="hidden glass max-w-md w-full p-6 relative z-10 border-slate-700">
            <h3 class="text-xl font-bold mb-4">Create Price Alert</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1.5">Asset</label>
                    <select id="alert-coin-select" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm focus:border-blue-500 outline-none">
                        <option value="bitcoin">Bitcoin (BTC)</option>
                        <option value="ethereum">Ethereum (ETH)</option>
                        <option value="solana">Solana (SOL)</option>
                        <option value="binancecoin">BNB</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1.5">Condition</label>
                        <select id="alert-condition" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm focus:border-blue-500 outline-none">
                            <option value="above">Price Above</option>
                            <option value="below">Price Below</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1.5">Target USD</label>
                        <input id="alert-target" type="number" placeholder="0.00" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm focus:border-blue-500 outline-none">
                    </div>
                </div>
                <button onclick="app.alerts.create()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition-all mt-4">Create Alert</button>
            </div>
        </div>
        <!-- Add Token Modal -->
        <div id="modal-add-token" class="hidden glass max-w-md w-full p-6 relative z-10 border-slate-700">
            <h3 class="text-xl font-bold mb-4">Watch New Asset</h3>
            <div class="space-y-4">
                <input id="token-search" type="text" placeholder="Search token ID (e.g., cardano, chainlink)..." class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm focus:border-blue-500 outline-none">
                <p class="text-[10px] text-slate-500">Using CoinGecko ID system. Examples: polkadot, matic-network, link.</p>
                <button onclick="app.watchlist.add()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition-all">Add to Watchlist</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-[110] space-y-3"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, where, addDoc, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110"
        };

        // GLOBAL STATE
        const state = {
            user: null,
            profile: null,
            wallet: {
                address: null,
                balance: '0',
                chainId: null,
                connected: false
            },
            prices: {},
            watchlist: [],
            alerts: [],
            allUsers: [], // Admin only
            activeView: 'dashboard'
        };

        // APP INITIALIZATION
        const app_fire = initializeApp(firebaseConfig);
        const auth = getAuth(app_fire);
        const db = getFirestore(app_fire);
        const provider = new GoogleAuthProvider();

        // UTILS
        const formatUSD = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
        const truncateAddress = (addr) => addr ? `${addr.slice(0,6)}...${addr.slice(-4)}` : '';

        // CORE LOGIC
        window.app = {
            auth: {
                async login() {
                    const loader = document.getElementById('login-loader');
                    loader.classList.remove('hidden');
                    try {
                        const result = await signInWithPopup(auth, provider);
                        await this.initUserProfile(result.user);
                    } catch (e) {
                        ui.toast('Login failed', 'error');
                        console.error(e);
                    } finally {
                        loader.classList.add('hidden');
                    }
                },
                async initUserProfile(user) {
                    const userRef = doc(db, 'users', user.uid);
                    const snap = await getDoc(userRef);
                    
                    if (!snap.exists()) {
                        const profile = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            photoURL: user.photoURL,
                            role: 'user', // Default role
                            walletAddress: null,
                            watchlist: ['bitcoin', 'ethereum', 'solana'],
                            createdAt: new Date().toISOString()
                        };
                        await setDoc(userRef, profile);
                        state.profile = profile;
                    } else {
                        state.profile = snap.data();
                    }
                    ui.syncProfile();
                },
                async logout() {
                    await signOut(auth);
                    window.location.reload();
                }
            },

            wallet: {
                async connect() {
                    if (typeof window.ethereum === 'undefined') {
                        return ui.toast('MetaMask not detected', 'error');
                    }
                    try {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const accounts = await provider.send("eth_requestAccounts", []);
                        const network = await provider.getNetwork();
                        
                        state.wallet.address = accounts[0];
                        state.wallet.chainId = network.chainId.toString();
                        state.wallet.connected = true;

                        // Sync to Firestore
                        if (state.user) {
                            await updateDoc(doc(db, 'users', state.user.uid), {
                                walletAddress: accounts[0]
                            });
                        }

                        await this.refreshBalance();
                        ui.syncWalletUI();
                        app.transactions.load();
                        ui.toast('Wallet Connected');
                    } catch (e) {
                        console.error(e);
                        ui.toast('Connection failed', 'error');
                    }
                },
                async refreshBalance() {
                    if (!state.wallet.address) return;
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const balance = await provider.getBalance(state.wallet.address);
                    state.wallet.balance = ethers.formatEther(balance);
                    ui.syncPortfolioValue();
                }
            },

            prices: {
                async fetch() {
                    try {
                        const ids = ['bitcoin', 'ethereum', 'solana', 'binancecoin', 'cardano', 'polkadot', ...state.profile?.watchlist || []];
                        const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${[...new Set(ids)].join(',')}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true&include_24hr_vol=true`);
                        const data = await res.json();
                        state.prices = data;
                        ui.renderMarketList();
                        ui.syncPortfolioValue();
                        this.checkAlerts();
                    } catch (e) {
                        console.warn("Pricing API Error (Rate limit likely)", e);
                    }
                },
                checkAlerts() {
                    state.alerts.forEach(async (alert) => {
                        const currentPrice = state.prices[alert.coinId]?.usd;
                        if (!currentPrice) return;

                        let triggered = false;
                        if (alert.condition === 'above' && currentPrice >= alert.target) triggered = true;
                        if (alert.condition === 'below' && currentPrice <= alert.target) triggered = true;

                        if (triggered && !alert.triggered) {
                            ui.toast(`ALERT: ${alert.coinId.toUpperCase()} is ${alert.condition} ${alert.target}`, 'warning');
                            await updateDoc(doc(db, 'alerts', alert.id), { triggered: true });
                        }
                    });
                }
            },

            watchlist: {
                async add() {
                    const coinId = document.getElementById('token-search').value.toLowerCase().trim();
                    if (!coinId) return;
                    try {
                        const newWatchlist = [...(state.profile.watchlist || []), coinId];
                        await updateDoc(doc(db, 'users', state.user.uid), { watchlist: [...new Set(newWatchlist)] });
                        ui.modals.close();
                        ui.toast(`${coinId} added`);
                        document.getElementById('token-search').value = '';
                    } catch (e) {
                        ui.toast('Error adding token', 'error');
                    }
                },
                async remove(coinId) {
                    const newWatchlist = state.profile.watchlist.filter(id => id !== coinId);
                    await updateDoc(doc(db, 'users', state.user.uid), { watchlist: newWatchlist });
                    ui.toast(`${coinId} removed`);
                }
            },

            alerts: {
                async create() {
                    const coinId = document.getElementById('alert-coin-select').value;
                    const condition = document.getElementById('alert-condition').value;
                    const target = parseFloat(document.getElementById('alert-target').value);

                    if (!target) return ui.toast('Enter target price', 'error');

                    await addDoc(collection(db, 'alerts'), {
                        userId: state.user.uid,
                        coinId,
                        condition,
                        target,
                        triggered: false,
                        createdAt: new Date().toISOString()
                    });

                    ui.modals.close();
                    ui.toast('Alert created');
                },
                async delete(id) {
                    await deleteDoc(doc(db, 'alerts', id));
                    ui.toast('Alert deleted');
                }
            },

            transactions: {
                async load() {
                    if (!state.wallet.address) return;
                    const container = document.getElementById('tx-container');
                    const empty = document.getElementById('tx-empty-state');
                    
                    try {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const blockNumber = await provider.getBlockNumber();
                        const block = await provider.getBlock(blockNumber, true);
                        
                        // Filter recent txs for current address in the last few blocks
                        // This is a simplified "real logic" as deep history requires APIs
                        const txs = block.transactions.filter(tx => 
                            (tx.from?.toLowerCase() === state.wallet.address.toLowerCase() || 
                             tx.to?.toLowerCase() === state.wallet.address.toLowerCase())
                        );

                        if (txs.length > 0) {
                            empty.classList.add('hidden');
                            container.classList.remove('hidden');
                            container.innerHTML = txs.map(tx => `
                                <div class="flex items-center justify-between p-4 hover:bg-slate-900/50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 rounded-lg bg-blue-500/10 text-blue-400">
                                            <i data-lucide="arrow-up-right" class="w-4 h-4"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium">Outgoing Transfer</p>
                                            <p class="text-xs text-slate-500">Hash: ${truncateAddress(tx.hash)}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-bold">${ethers.formatEther(tx.value || 0)} ETH</p>
                                        <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" class="text-[10px] text-blue-400 hover:underline">View Explorer</a>
                                    </div>
                                </div>
                            `).join('');
                            lucide.createIcons();
                        }
                    } catch (e) {
                        console.error("TX Load Error", e);
                    }
                }
            }
        };

        // UI RENDERING
        window.ui = {
            syncProfile() {
                document.getElementById('user-avatar').src = state.profile.photoURL;
                document.getElementById('user-name').innerText = state.profile.displayName;
                document.getElementById('user-role').innerText = state.profile.role;
                if (state.profile.role === 'admin') document.getElementById('admin-nav-link').classList.remove('hidden');
                
                // Set Up Real-time Listeners
                onSnapshot(query(collection(db, 'alerts'), where('userId', '==', state.user.uid)), (snap) => {
                    state.alerts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.renderAlerts();
                });

                onSnapshot(doc(db, 'users', state.user.uid), (snap) => {
                    state.profile = snap.data();
                    this.renderWatchlist();
                });
            },

            syncWalletUI() {
                const btn = document.getElementById('connect-wallet-btn');
                const text = document.getElementById('wallet-text');
                if (state.wallet.connected) {
                    text.innerText = truncateAddress(state.wallet.address);
                    btn.classList.add('bg-emerald-500/10', 'text-emerald-400', 'border-emerald-500/20');
                    btn.classList.remove('bg-blue-600/10', 'text-blue-400', 'border-blue-500/20');
                }
            },

            syncPortfolioValue() {
                const ethPrice = state.prices['ethereum']?.usd || 0;
                const totalUSD = parseFloat(state.wallet.balance) * ethPrice;
                document.getElementById('portfolio-value').innerText = formatUSD(totalUSD);
                document.getElementById('native-balance').innerText = `${parseFloat(state.wallet.balance).toFixed(4)} ETH`;
                
                document.getElementById('ticker-btc').innerText = formatUSD(state.prices['bitcoin']?.usd || 0);
                document.getElementById('ticker-eth').innerText = formatUSD(ethPrice);
                document.getElementById('price-ticker').classList.remove('hidden');

                this.renderCharts(totalUSD);
            },

            renderMarketList() {
                const list = document.getElementById('market-list');
                const coins = ['bitcoin', 'ethereum', 'solana', 'binancecoin'];
                list.innerHTML = coins.map(id => {
                    const data = state.prices[id];
                    if (!data) return '';
                    const isUp = data.usd_24h_change >= 0;
                    return `
                        <div class="flex items-center justify-between p-3 rounded-xl bg-slate-900/40 border border-slate-800/50">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center font-bold text-[10px] uppercase">
                                    ${id.slice(0, 2)}
                                </div>
                                <div>
                                    <p class="text-sm font-bold capitalize">${id}</p>
                                    <p class="text-[10px] text-slate-500">Vol: ${formatUSD(data.usd_24h_vol).slice(0,-3)}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold">${formatUSD(data.usd)}</p>
                                <p class="text-[10px] ${isUp ? 'text-emerald-400' : 'text-red-400'} font-bold">
                                    ${isUp ? '▲' : '▼'} ${Math.abs(data.usd_24h_change).toFixed(2)}%
                                </p>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderWatchlist() {
                const body = document.getElementById('watchlist-table-body');
                if (!state.profile.watchlist.length) {
                    body.innerHTML = `<tr><td colspan="4" class="py-8 text-center text-slate-500 text-sm">No assets in watchlist</td></tr>`;
                    return;
                }
                body.innerHTML = state.profile.watchlist.map(id => {
                    const data = state.prices[id];
                    return `
                        <tr class="hover:bg-slate-900/30">
                            <td class="px-6 py-4">
                                <span class="font-bold capitalize">${id}</span>
                            </td>
                            <td class="px-6 py-4 font-medium">
                                ${data ? formatUSD(data.usd) : '---'}
                            </td>
                            <td class="px-6 py-4 text-right ${data?.usd_24h_change >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                                ${data ? data.usd_24h_change.toFixed(2) + '%' : '---'}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button onclick="app.watchlist.remove('${id}')" class="text-slate-500 hover:text-red-400 p-1">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            },

            renderAlerts() {
                const grid = document.getElementById('alerts-grid');
                document.getElementById('alert-count').innerText = state.alerts.length;
                if (!state.alerts.length) {
                    grid.innerHTML = `<div class="col-span-full py-12 text-center text-slate-500">No active alerts set</div>`;
                    return;
                }
                grid.innerHTML = state.alerts.map(a => `
                    <div class="glass p-4 border-slate-800 flex flex-col justify-between">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-bold uppercase text-blue-400">${a.coinId}</span>
                                <span class="text-[10px] px-2 py-0.5 rounded bg-slate-800 text-slate-400">${a.triggered ? 'TRIGGERED' : 'PENDING'}</span>
                            </div>
                            <p class="text-lg font-bold">Price ${a.condition} ${formatUSD(a.target)}</p>
                        </div>
                        <button onclick="app.alerts.delete('${a.id}')" class="mt-4 text-xs text-red-400 hover:underline text-left">Remove Alert</button>
                    </div>
                `).join('');
            },

            renderAdmin() {
                if (state.profile.role !== 'admin') return;
                onSnapshot(collection(db, 'users'), (snap) => {
                    const users = snap.docs.map(d => d.data());
                    document.getElementById('admin-stat-users').innerText = users.length;
                    
                    const table = document.getElementById('admin-users-table');
                    table.innerHTML = users.map(u => `
                        <tr>
                            <td class="py-3 flex items-center gap-2">
                                <img src="${u.photoURL}" class="w-6 h-6 rounded-full">
                                <span>${u.displayName}</span>
                            </td>
                            <td class="py-3 font-mono text-xs text-slate-500">${truncateAddress(u.walletAddress) || 'Not Linked'}</td>
                            <td class="py-3">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded ${u.role === 'admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-slate-800 text-slate-400'}">${u.role}</span>
                            </td>
                            <td class="py-3 text-right">
                                <button class="text-blue-400 hover:underline">Manage</button>
                            </td>
                        </tr>
                    `).join('');
                });
            },

            renderCharts(value) {
                const ctx = document.getElementById('portfolioChart');
                if (window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Wallet', 'Staked', 'Exchanges'],
                        datasets: [{
                            data: [value || 1, 0, 0],
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#1e293b'],
                            borderWidth: 0,
                            cutout: '80%'
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        maintainAspectRatio: false
                    }
                });
            },

            modals: {
                open(type) {
                    document.getElementById('modal-container').classList.remove('hidden');
                    document.querySelectorAll('#modal-container > div:not(.absolute)').forEach(el => el.classList.add('hidden'));
                    document.getElementById(`modal-${type === 'alert' ? 'alert' : 'add-token'}`).classList.remove('hidden');
                },
                close() {
                    document.getElementById('modal-container').classList.add('hidden');
                }
            },

            toast(msg, type = 'success') {
                const id = Math.random().toString(36).slice(2);
                const colors = {
                    success: 'bg-emerald-500',
                    error: 'bg-red-500',
                    warning: 'bg-amber-500'
                };
                const toast = document.createElement('div');
                toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 transition-all transform translate-y-0 opacity-100`;
                toast.innerHTML = `<i data-lucide="info" class="w-4 h-4"></i> <span class="text-sm font-bold">${msg}</span>`;
                document.getElementById('toast-container').appendChild(toast);
                lucide.createIcons();
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            switchView(viewId) {
                // Nav UI
                document.querySelectorAll('.sidebar-item').forEach(btn => {
                    btn.classList.remove('active');
                    if(btn.dataset.nav === viewId) btn.classList.add('active');
                });
                // View Content UI
                document.querySelectorAll('#view-content > div').forEach(div => div.classList.add('hidden'));
                const target = document.getElementById(`view-${viewId}`);
                if(target) target.classList.remove('hidden');
                
                document.getElementById('view-title').innerText = viewId;
                state.activeView = viewId;

                if (viewId === 'admin') this.renderAdmin();
                if (viewId === 'watchlist') this.renderWatchlist();
            }
        };

        // EVENT LISTENERS
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = user;
                await app.auth.initUserProfile(user);
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
                
                // Start background tasks
                app.prices.fetch();
                setInterval(() => app.prices.fetch(), 30000);
                
                // Auto-reconnect wallet if saved
                if (state.profile.walletAddress) {
                    app.wallet.connect();
                }
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
                document.getElementById('app-shell').classList.add('hidden');
            }
        });

        document.getElementById('google-login-btn').onclick = () => app.auth.login();
        document.getElementById('logout-btn').onclick = () => app.auth.logout();
        document.getElementById('connect-wallet-btn').onclick = () => app.wallet.connect();
        document.getElementById('add-token-btn').onclick = () => ui.modals.open('token');

        document.querySelectorAll('[data-nav]').forEach(btn => {
            btn.onclick = () => ui.switchView(btn.dataset.nav);
        });

        // Initialize Icons
        lucide.createIcons();
    </script>
</body>
</html>
