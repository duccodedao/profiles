<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng B√°n BHYT & Xu·∫•t H√≥a ƒê∆°n</title>
    <!-- Th∆∞ vi·ªán ƒë·ªÉ ch·ª•p ·∫£nh h√≥a ƒë∆°n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #0056b3;
            --border: #ddd;
            --bg: #f4f6f9;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            padding: 20px;
            color: #333;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* KHUNG NH·∫¨P LI·ªÜU */
        .input-panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            height: fit-content;
        }
        .input-panel h2 { margin-top: 0; color: var(--primary); text-align: center; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: 0.3s;
        }
        .btn-create { background-color: #28a745; }
        .btn-create:hover { background-color: #218838; }
        
        .btn-download { background-color: #17a2b8; }
        .btn-download:hover { background-color: #138496; }

        .btn-print { background-color: #6c757d; }
        .btn-print:hover { background-color: #5a6268; }

        /* KHUNG H√ìA ƒê∆†N (PREVIEW) */
        .invoice-container {
            background: white;
            width: 100%;
            max-width: 450px; /* Kh·ªï gi·∫•y in nhi·ªát th√¥ng d·ª•ng th∆∞·ªùng nh·ªè h∆°n, nh∆∞ng ƒë·ªÉ 450px cho d·ªÖ nh√¨n */
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
        }

        /* Thi·∫øt k·∫ø h√≥a ƒë∆°n gi·ªëng gi·∫•y in nhi·ªát */
        #invoice {
            border: 1px dashed #333;
            padding: 20px;
            background: #fff;
        }
        
        .inv-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
        .inv-header h1 { margin: 0; font-size: 22px; text-transform: uppercase; }
        .inv-header p { margin: 5px 0; font-size: 12px; }

        .inv-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .inv-label { font-weight: bold; }
        .inv-total { border-top: 1px solid #000; padding-top: 10px; margin-top: 10px; font-size: 18px; font-weight: bold; text-align: right; }

        .cccd-preview {
            margin-top: 20px;
            text-align: center;
            border-top: 1px dotted #ccc;
            padding-top: 10px;
        }
        .cccd-preview img {
            max-width: 100%;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .footer-note {
            margin-top: 20px;
            text-align: center;
            font-style: italic;
            font-size: 12px;
        }

        /* ·∫®n input file m·∫∑c ƒë·ªãnh, l√†m ƒë·∫πp n√∫t upload */
        .file-upload {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 5px;
            background: #fafafa;
        }
        .file-upload:hover { background: #eee; border-color: var(--primary); }

        /* MEDIA PRINT: Ch·ªâ in ph·∫ßn h√≥a ƒë∆°n */
        @media print {
            body * { visibility: hidden; }
            .invoice-container, .invoice-container * { visibility: visible; }
            .invoice-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                box-shadow: none;
                border: none;
            }
            /* ·∫®n c√°c n√∫t khi in */
            .no-print { display: none; }
        }
    </style>
</head>
<body>

    <!-- PANEL NH·∫¨P LI·ªÜU -->
    <div class="input-panel no-print">
        <h2>L·∫≠p H√≥a ƒê∆°n BHYT</h2>
        
        <div class="form-group">
            <label>Ng∆∞·ªùi b√°n (ƒê·∫°i l√Ω)</label>
            <select id="seller">
                <option value="L√¢m Minh Ngo√£n">L√¢m Minh Ngo√£n</option>
                <option value="S∆°n L√Ω H·ªìng ƒê·ª©c">S∆°n L√Ω H·ªìng ƒê·ª©c</option>
            </select>
        </div>

        <div class="form-group">
            <label>H·ªç t√™n ng∆∞·ªùi mua</label>
            <input type="text" id="buyerName" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
        </div>

        <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="number" id="buyerPhone" placeholder="09xxxxxxx">
        </div>

        <div class="form-group">
            <label>G√≥i b·∫£o hi·ªÉm</label>
            <select id="duration" onchange="updatePrice()">
                <!-- Gi√° t·∫°m t√≠nh theo l∆∞∆°ng c∆° s·ªü 2.340.000 (4.5%) -->
                <option value="3">3 Th√°ng (315.900 ƒë)</option>
                <option value="6">6 Th√°ng (631.800 ƒë)</option>
                <option value="9">9 Th√°ng (947.700 ƒë)</option>
                <option value="12" selected>12 Th√°ng (1.263.600 ƒë)</option>
            </select>
        </div>

        <div class="form-group">
            <label>Ng√†y mua (M·∫∑c ƒë·ªãnh hi·ªán t·∫°i)</label>
            <input type="text" id="buyDate" readonly style="background: #eee;">
        </div>

        <div class="form-group">
            <label>·∫¢nh CCCD / Th·∫ª BHYT c≈©</label>
            <div class="file-upload" onclick="document.getElementById('cccdFile').click()">
                <span id="fileName">B·∫•m ƒë·ªÉ ch·ªçn ·∫£nh...</span>
                <input type="file" id="cccdFile" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-create" onclick="renderInvoice()">C·∫≠p nh·∫≠t H√≥a ƒê∆°n</button>
        </div>
        
        <div class="btn-group">
            <button class="btn-print" onclick="window.print()">üñ®Ô∏è In H√≥a ƒê∆°n</button>
            <button class="btn-download" onclick="downloadImage()">üíæ T·∫£i ·∫¢nh H√≥a ƒê∆°n</button>
        </div>
    </div>

    <!-- KHUNG HI·ªÇN TH·ªä H√ìA ƒê∆†N -->
    <div class="invoice-container">
        <div id="invoice">
            <div class="inv-header">
                <h1>BI√äN LAI THU TI·ªÄN</h1>
                <p>D·ªäCH V·ª§ B·∫¢O HI·ªÇM Y T·∫æ TO√ÄN D√ÇN</p>
                <p>----------------------------------</p>
            </div>

            <div class="inv-content">
                <div class="inv-row">
                    <span class="inv-label">M√£ h√≥a ƒë∆°n:</span>
                    <span id="invId">#HD0000</span>
                </div>
                <div class="inv-row">
                    <span class="inv-label">Ng√†y l·∫≠p:</span>
                    <span id="outDate">...</span>
                </div>
                <div class="inv-row">
                    <span class="inv-label">Ng∆∞·ªùi thu:</span>
                    <span id="outSeller" style="text-transform: uppercase;">...</span>
                </div>
                <hr style="border: 0.5px dashed #ccc; margin: 10px 0;">
                
                <div class="inv-row">
                    <span class="inv-label">Kh√°ch h√†ng:</span>
                    <span id="outBuyer" style="font-weight: bold;">...</span>
                </div>
                <div class="inv-row">
                    <span class="inv-label">SƒêT:</span>
                    <span id="outPhone">...</span>
                </div>
                <div class="inv-row">
                    <span class="inv-label">N·ªôi dung:</span>
                    <span>Gia h·∫°n/Mua m·ªõi BHYT</span>
                </div>
                <div class="inv-row">
                    <span class="inv-label">Th·ªùi h·∫°n:</span>
                    <span id="outDuration">12 Th√°ng</span>
                </div>
                
                <div class="inv-total">
                    T·ªîNG TI·ªÄN: <span id="outTotal" style="color: red;">1.263.600 ƒë</span>
                </div>

                <div class="footer-note">
                    C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•!<br>
                    Vui l√≤ng gi·ªØ l·∫°i h√≥a ƒë∆°n ƒë·ªÉ ƒë·ªëi chi·∫øu.
                </div>
            </div>

            <!-- Khu v·ª±c hi·ªÉn th·ªã ·∫£nh CCCD -->
            <div class="cccd-preview" id="cccdArea" style="display: none;">
                <p style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">H·ªí S∆† ƒê√çNH K√àM (CCCD/CMND)</p>
                <img id="outImage" src="" alt="Anh CCCD">
            </div>
        </div>
    </div>

    <script>
        // B·∫£ng gi√° (D·ª±a tr√™n l∆∞∆°ng c∆° s·ªü 2.340.000 t·ª´ 1/7/2024 - 4.5%)
        // 1 th√°ng = 105.300ƒë
        const PRICE_LIST = {
            "3": 315900,
            "6": 631800,
            "9": 947700,
            "12": 1263600
        };

        let currentImageBase64 = null;

        // Kh·ªüi t·∫°o ng√†y gi·ªù m·∫∑c ƒë·ªãnh khi t·∫£i trang
        window.onload = function() {
            updateRealTime();
            setInterval(updateRealTime, 60000); // C·∫≠p nh·∫≠t m·ªói ph√∫t
            renderInvoice(); // Render l·∫ßn ƒë·∫ßu
        };

        function updateRealTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('vi-VN');
            const timeStr = now.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('buyDate').value = `${dateStr} ${timeStr}`;
        }

        // X·ª≠ l√Ω khi ch·ªçn ·∫£nh
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                document.getElementById('fileName').innerText = input.files[0].name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageBase64 = e.target.result;
                    renderInvoice(); // C·∫≠p nh·∫≠t l·∫°i h√≥a ƒë∆°n ngay
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // C·∫≠p nh·∫≠t gi√° khi ƒë·ªïi select
        function updatePrice() {
            // Ch·ªâ c·∫ßn g·ªçi renderInvoice, gi√° s·∫Ω t·ª± t√≠nh
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        // H√†m ch√≠nh: ƒê·ªï d·ªØ li·ªáu t·ª´ Form sang H√≥a ƒë∆°n
        function renderInvoice() {
            // L·∫•y d·ªØ li·ªáu
            const seller = document.getElementById('seller').value;
            const buyer = document.getElementById('buyerName').value || "Kh√°ch l·∫ª";
            const phone = document.getElementById('buyerPhone').value || "---";
            const duration = document.getElementById('duration').value;
            const dateVal = document.getElementById('buyDate').value;
            const price = PRICE_LIST[duration];

            // G√°n d·ªØ li·ªáu v√†o h√≥a ƒë∆°n
            // T·∫°o m√£ h√≥a ƒë∆°n ng·∫´u nhi√™n d·ª±a tr√™n th·ªùi gian
            const randomId = Math.floor(Math.random() * 10000);
            // document.getElementById('invId').innerText = `#HD${randomId}`; // N·∫øu mu·ªën m√£ ƒë·ªïi li√™n t·ª•c
            
            document.getElementById('outDate').innerText = dateVal;
            document.getElementById('outSeller').innerText = seller;
            document.getElementById('outBuyer').innerText = buyer.toUpperCase();
            document.getElementById('outPhone').innerText = phone;
            document.getElementById('outDuration').innerText = `${duration} Th√°ng`;
            document.getElementById('outTotal').innerText = formatCurrency(price);

            // X·ª≠ l√Ω ·∫£nh CCCD
            const cccdArea = document.getElementById('cccdArea');
            const outImg = document.getElementById('outImage');
            
            if (currentImageBase64) {
                cccdArea.style.display = 'block';
                outImg.src = currentImageBase64;
            } else {
                cccdArea.style.display = 'none';
            }
        }

        // Ch·ª©c nƒÉng t·∫£i ·∫£nh h√≥a ƒë∆°n
        function downloadImage() {
            const invoiceElement = document.getElementById('invoice');
            
            // D√πng html2canvas ch·ª•p l·∫°i div #invoice
            html2canvas(invoiceElement, {
                scale: 2, // TƒÉng ƒë·ªô ph√¢n gi·∫£i ·∫£nh l√™n 2 l·∫ßn cho n√©t
                useCORS: true, // H·ªó tr·ª£ load ·∫£nh
                backgroundColor: "#ffffff"
            }).then(canvas => {
                // T·∫°o link t·∫£i v·ªÅ
                const link = document.createElement('a');
                link.download = `HoaDon_BHYT_${document.getElementById('buyerName').value}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            }).catch(err => {
                alert("L·ªói khi t·∫°o ·∫£nh: " + err);
            });
        }
    </script>
</body>
</html>
