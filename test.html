<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω C√¥ng T√°c & T·ªìn ƒê·ªçng - Hi·ªáp Th√†nh 2025</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1e3a8a; --secondary: #0284c7; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; --radius: 16px;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; color: #1e293b; }

        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%);
            color: white; padding: 40px 20px; text-align: center;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        }

        .container { max-width: 1200px; margin: -30px auto 100px; padding: 0 15px; }

        .card {
            background: white; padding: 25px; border-radius: var(--radius);
            margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .card-title { font-size: 1.2rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        .table-scroll { overflow-x: auto; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f1f5f9; padding: 12px; font-size: 11px; text-transform: uppercase; color: #475569; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }

        .form-control {
            width: 100%; padding: 10px; border: 1.5px solid #e2e8f0; border-radius: 8px;
            font-size: 14px; outline: none; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--secondary); background: #f0f9ff; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; display: inline-block; }
        .bg-warning { background: #fef3c7; color: #92400e; }
        .bg-danger { background: #fee2e2; color: #b91c1c; animation: blink 1s infinite; }
        .bg-success { background: #dcfce7; color: #15803d; }

        .btn-cal { 
            background: #4f46e5; color: white; border: none; padding: 6px 10px; 
            border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 700;
        }

        .action-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; width: 90%; max-width: 500px; z-index: 1000;
        }
        .btn-main {
            flex: 1; padding: 15px; border-radius: 50px; border: none;
            color: white; font-weight: 800; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        @keyframes blink { 50% { opacity: 0.6; } }
        .day-label { font-size: 11px; font-weight: 800; color: var(--secondary); display: block; margin-top: 4px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">K·∫æ HO·∫†CH C√îNG T√ÅC & T·ªíN ƒê·ªòNG</h2>
    <p style="opacity:0.8">H·ªá Th·ªëng Y T·∫ø Hi·ªáp Th√†nh 2025</p>
</div>

<div class="container">
    <!-- C·∫§U H√åNH CHUNG -->
    <div class="card" style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
        <div style="flex:1; min-width:200px">
            <label style="font-size:11px; font-weight:800">TH√ÅNG B√ÅO C√ÅO</label>
            <input type="month" id="reportMonth" class="form-control" onchange="loadData()">
        </div>
        <div style="flex:1; min-width:200px">
            <label style="font-size:11px; font-weight:800">ƒê∆†N V·ªä</label>
            <select id="userUnit" class="form-control" onchange="loadData()">
                <option value="NM">Ph∆∞·ªùng Nh√† M√°t</option>
                <option value="HT">X√£ Hi·ªáp Th√†nh</option>
                <option value="VTD">X√£ Vƒ©nh Tr·∫°ch ƒê√¥ng</option>
                <option value="PHT">Ph∆∞·ªùng Hi·ªáp Th√†nh (Admin)</option>
            </select>
        </div>
    </div>

    <!-- M·ª§C 1: L·ªäCH ƒêI C√îNG T√ÅC -->
    <div class="card">
        <div class="card-title">üìÖ K·∫ø Ho·∫°ch ƒêi C√¥ng T√°c Ti·∫øp Theo</div>
        <div class="table-scroll">
            <table id="tableTrip">
                <thead>
                    <tr>
                        <th width="180">Ng√†y gi·ªù ƒëi</th>
                        <th>ƒê·ªãa ƒëi·ªÉm</th>
                        <th>N·ªôi dung c√¥ng t√°c</th>
                        <th width="100">Th·ªùi h·∫°n</th>
                        <th width="140">Tr·∫°ng th√°i</th>
                        <th width="120">L·ªãch m√°y</th>
                        <th width="40"></th>
                    </tr>
                </thead>
                <tbody id="bodyTrip"></tbody>
            </table>
        </div>
        <button onclick="addRowTrip()" style="margin-top:15px; border:none; background:var(--primary); color:white; padding:10px 20px; border-radius:10px; font-weight:700; cursor:pointer">+ Th√™m l·ªãch c√¥ng t√°c</button>
    </div>

    <!-- M·ª§C 2: C√ÅC M·ª§C T·ªíN ƒê·ªòNG -->
    <div class="card" style="border-top: 5px solid var(--danger);">
        <div class="card-title">‚ö†Ô∏è C√°c M·ª•c C√≤n T·ªìn ƒê·ªçng / Ch∆∞a Xong</div>
        <div class="table-scroll">
            <table id="tablePending">
                <thead>
                    <tr>
                        <th>N·ªôi dung t·ªìn ƒë·ªçng</th>
                        <th width="150">Ng∆∞·ªùi ph·ª• tr√°ch</th>
                        <th width="150">H·∫°n ch√≥t</th>
                        <th width="150">C·∫£nh b√°o</th>
                        <th width="40"></th>
                    </tr>
                </thead>
                <tbody id="bodyPending"></tbody>
            </table>
        </div>
        <button onclick="addRowPending()" style="margin-top:15px; border:none; background:var(--danger); color:white; padding:10px 20px; border-radius:10px; font-weight:700; cursor:pointer">+ Th√™m m·ª•c t·ªìn ƒë·ªçng</button>
    </div>
</div>

<div class="action-bar">
    <button class="btn-main" style="background:#1d6f42" onclick="exportToExcel()">XU·∫§T EXCEL</button>
    <button class="btn-main" style="background:var(--success)" onclick="saveData()">L∆ØU D·ªÆ LI·ªÜU</button>
</div>

<script type="module">
    // Firebase Config (Gi·ªØ nguy√™n t·ª´ file c≈© c·ªßa b·∫°n)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // X·ª≠ l√Ω hi·ªÉn th·ªã Th·ª© v√† Ng√†y
    window.getDayOfWeek = (dateStr) => {
        if(!dateStr) return "";
        const days = ["Ch·ªß Nh·∫≠t", "Th·ª© Hai", "Th·ª© Ba", "Th·ª© T∆∞", "Th·ª© NƒÉm", "Th·ª© S√°u", "Th·ª© B·∫£y"];
        return days[new Date(dateStr).getDay()];
    };

    // Th√™m d√≤ng C√¥ng t√°c
    window.addRowTrip = (d = null) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <input type="datetime-local" class="form-control t-date" value="${d?.date||''}" oninput="updateRowStatus(this)">
                <span class="day-label">${getDayOfWeek(d?.date)}</span>
            </td>
            <td><input type="text" class="form-control t-loc" value="${d?.loc||''}" placeholder="ƒê·ªãa ƒëi·ªÉm..."></td>
            <td><input type="text" class="form-control t-content" value="${d?.content||''}" placeholder="N·ªôi dung..."></td>
            <td><input type="number" class="form-control t-duration" value="${d?.duration||''}" placeholder="Ng√†y"></td>
            <td class="t-status-box"></td>
            <td><button class="btn-cal" onclick="addToCalendar(this)">‚ûï Th√™m L·ªãch</button></td>
            <td><button onclick="this.closest('tr').remove()" style="color:red; border:none; background:none; font-size:20px; cursor:pointer">&times;</button></td>
        `;
        document.getElementById('bodyTrip').appendChild(tr);
        if(d) updateRowStatus(tr.querySelector('.t-date'));
    };

    // Th√™m d√≤ng T·ªìn ƒë·ªçng
    window.addRowPending = (d = null) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="form-control p-issue" value="${d?.issue||''}"></td>
            <td><input type="text" class="form-control p-per" value="${d?.per||''}"></td>
            <td><input type="date" class="form-control p-deadline" value="${d?.deadline||''}" oninput="updatePendingStatus(this)"></td>
            <td class="p-status-box"></td>
            <td><button onclick="this.closest('tr').remove()" style="color:red; border:none; background:none; font-size:20px; cursor:pointer">&times;</button></td>
        `;
        document.getElementById('bodyPending').appendChild(tr);
        if(d) updatePendingStatus(tr.querySelector('.p-deadline'));
    };

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng t√°c
    window.updateRowStatus = (el) => {
        const row = el.closest('tr');
        const dateVal = el.value;
        const label = row.querySelector('.day-label');
        const statusBox = row.querySelector('.t-status-box');
        
        if(!dateVal) return;
        label.innerText = getDayOfWeek(dateVal);

        const now = new Date();
        const tripDate = new Date(dateVal);
        const diffDays = Math.ceil((tripDate - now) / (1000 * 60 * 60 * 24));

        if(diffDays < 0) statusBox.innerHTML = `<span class="badge bg-success">ƒê√É DI·ªÑN RA</span>`;
        else if(diffDays <= 2) statusBox.innerHTML = `<span class="badge bg-danger">S·∫ÆP ƒê·∫æN (${diffDays} ng√†y)</span>`;
        else statusBox.innerHTML = `<span class="badge bg-warning">K·∫æ HO·∫†CH</span>`;
    };

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i t·ªìn ƒë·ªçng
    window.updatePendingStatus = (el) => {
        const row = el.closest('tr');
        const deadline = el.value;
        const box = row.querySelector('.p-status-box');
        if(!deadline) return;

        const diff = Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
        if(diff < 0) box.innerHTML = `<span class="badge bg-danger">QU√Å H·∫†N ${Math.abs(diff)} NG√ÄY</span>`;
        else if(diff <= 3) box.innerHTML = `<span class="badge bg-warning">C·∫¨N H·∫†N (${diff} ng√†y)</span>`;
        else box.innerHTML = `<span class="badge bg-success">ƒêANG TH·ª∞C HI·ªÜN</span>`;
    };

    // Th√™m v√†o l·ªãch ƒëi·ªán tho·∫°i (T·∫°o file .ics)
    window.addToCalendar = (btn) => {
        const row = btn.closest('tr');
        const date = row.querySelector('.t-date').value;
        const loc = row.querySelector('.t-loc').value;
        const content = row.querySelector('.t-content').value;

        if(!date || !content) {
            Swal.fire("L·ªói", "Vui l√≤ng nh·∫≠p ng√†y v√† n·ªôi dung", "error");
            return;
        }

        const start = date.replace(/[-:]/g, "") + "00";
        const icsMsg = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${start}\nSUMMARY:${content}\nLOCATION:${loc}\nDESCRIPTION:C√¥ng t√°c t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng Hi·ªáp Th√†nh\nEND:VEVENT\nEND:VCALENDAR`;
        
        const blob = new Blob([icsMsg], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', 'cong-tac.ics');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // L∆∞u v√† T·∫£i d·ªØ li·ªáu Firebase
    window.saveData = async () => {
        const month = document.getElementById('reportMonth').value;
        const unit = document.getElementById('userUnit').value;
        if(!month) return Swal.fire("L·ªói", "Ch·ªçn th√°ng b√°o c√°o", "error");

        Swal.fire({title: 'ƒêang l∆∞u...', didOpen: () => Swal.showLoading()});
        
        const trips = [];
        document.querySelectorAll('#bodyTrip tr').forEach(tr => {
            trips.push({
                date: tr.querySelector('.t-date').value,
                loc: tr.querySelector('.t-loc').value,
                content: tr.querySelector('.t-content').value,
                duration: tr.querySelector('.t-duration').value
            });
        });

        const pendings = [];
        document.querySelectorAll('#bodyPending tr').forEach(tr => {
            pendings.push({
                issue: tr.querySelector('.p-issue').value,
                per: tr.querySelector('.p-per').value,
                deadline: tr.querySelector('.p-deadline').value
            });
        });

        await setDoc(doc(db, "CongTacV8", `${month}_${unit}`), { trips, pendings });
        Swal.fire("Th√†nh c√¥ng", "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô", "success");
    };

    window.loadData = async () => {
        const month = document.getElementById('reportMonth').value;
        const unit = document.getElementById('userUnit').value;
        if(!month) return;

        const s = await getDoc(doc(db, "CongTacV8", `${month}_${unit}`));
        document.getElementById('bodyTrip').innerHTML = "";
        document.getElementById('bodyPending').innerHTML = "";

        if(s.exists()){
            const d = s.data();
            d.trips?.forEach(t => addRowTrip(t));
            d.pendings?.forEach(p => addRowPending(p));
        } else {
            addRowTrip(); addRowPending();
        }
    };

    // Xu·∫•t Excel
    window.exportToExcel = () => {
        const wb = XLSX.utils.book_new();
        const tripData = [];
        document.querySelectorAll('#bodyTrip tr').forEach(tr => {
            tripData.push({
                "Ng√†y gi·ªù": tr.querySelector('.t-date').value,
                "Th·ª©": getDayOfWeek(tr.querySelector('.t-date').value),
                "ƒê·ªãa ƒëi·ªÉm": tr.querySelector('.t-loc').value,
                "N·ªôi dung": tr.querySelector('.t-content').value,
                "S·ªë ng√†y": tr.querySelector('.t-duration').value
            });
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tripData), "CongTac");
        XLSX.writeFile(wb, `KeHoach_CongTac_${document.getElementById('reportMonth').value}.xlsx`);
    };

    // Kh·ªüi t·∫°o m·∫∑c ƒë·ªãnh th√°ng hi·ªán t·∫°i
    const now = new Date();
    document.getElementById('reportMonth').value = now.toISOString().substring(0, 7);
    loadData();

</script>
</body>
</html>
