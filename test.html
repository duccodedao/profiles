<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Journey</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <!-- FingerprintJS cho định danh thiết bị -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&family=Cinzel:wght@600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #050505;
            --primary: #0098EA;
            --accent: #FFD700;
            --danger: #FF3B30;
            --glass: rgba(255, 255, 255, 0.05);
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --font-main: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: var(--font-main);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- ANIMATIONS --- */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        /* --- SCREENS --- */
        .screen {
            position: fixed; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg-color); z-index: 100;
            text-align: center;
        }
        .hidden { display: none !important; }

        /* BANNED SCREEN */
        #banned-screen { z-index: 99999; background: #1a0000; }
        .banned-icon { font-size: 60px; color: var(--danger); margin-bottom: 20px; animation: glitch 0.5s infinite; }
        .banned-text { color: var(--danger); font-family: var(--font-code); font-weight: bold; letter-spacing: 2px; }

        /* STORY SLIDES */
        .slide {
            position: absolute; inset: 0; padding: 30px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .slide.active { opacity: 1; pointer-events: auto; }
        
        .slide-content { animation: slideIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        
        h1 { font-family: 'Cinzel', serif; font-size: 28px; margin-bottom: 10px; color: var(--primary); }
        .big-stat { font-size: 48px; font-weight: 900; margin: 15px 0; text-shadow: 0 0 20px rgba(0, 152, 234, 0.5); }
        
        /* CODE INPUT UI */
        .security-box {
            background: rgba(16, 20, 24, 0.8); border: 1px solid var(--primary);
            border-radius: 16px; padding: 25px; width: 100%; max-width: 320px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(0, 152, 234, 0.1);
        }
        .security-code {
            font-family: var(--font-code); font-size: 28px; letter-spacing: 5px;
            color: var(--primary); margin: 20px 0; padding: 10px;
            background: rgba(0, 152, 234, 0.1); border-radius: 8px;
            position: relative; overflow: hidden;
        }
        .security-code::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%); animation: shine 2s infinite;
        }
        @keyframes shine { 100% { transform: translateX(100%); } }
        
        .input-field {
            background: #000; border: 1px solid #333; color: white;
            width: 100%; padding: 15px; border-radius: 8px;
            text-align: center; font-size: 18px; letter-spacing: 2px;
            outline: none; margin-bottom: 15px; text-transform: uppercase;
        }
        .input-field:focus { border-color: var(--primary); }

        /* TOKEN DASHBOARD */
        .dashboard-header { margin-top: 60px; width: 100%; padding: 0 20px; }
        .token-card {
            background: linear-gradient(135deg, #1a1f25 0%, #0a0c10 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 25px;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .token-card::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px; background: var(--primary);
            filter: blur(80px); opacity: 0.2;
        }
        .balance-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .balance-val { font-size: 42px; font-weight: bold; margin: 10px 0; font-family: var(--font-code); }
        .token-tag { background: rgba(0, 152, 234, 0.2); color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }

        /* WITHDRAW BUTTON */
        .withdraw-area {
            margin-top: 20px; width: 100%; display: flex; gap: 10px;
        }
        .btn-withdraw {
            flex: 1; padding: 15px; border-radius: 12px; border: none;
            background: #1a1a1a; color: #666; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: not-allowed; position: relative; overflow: hidden;
        }
        .btn-withdraw.locked::after {
            content: 'LOCKED UNTIL 31/12/2025';
            position: absolute; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: var(--danger); font-weight: bold;
            opacity: 0; transition: 0.3s;
        }
        .btn-withdraw.locked:active::after { opacity: 1; }

        /* COMMON BUTTONS */
        .btn-primary {
            background: white; color: black; border: none; width: 100%;
            padding: 16px; border-radius: 12px; font-weight: 800; font-size: 16px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255,255,255,0.1);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.96); }

        .footer { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; padding: 0 20px; }
    </style>
</head>
<body>

    <!-- SCREEN: LOADER -->
    <div id="loader" class="screen">
        <div style="width: 40px; height: 40px; border: 3px solid #333; border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite;"></div>
        <div style="margin-top: 15px; font-size: 10px; letter-spacing: 2px;">SECURITY CHECK...</div>
    </div>

    <!-- SCREEN: BANNED -->
    <div id="banned-screen" class="screen hidden">
        <i class="fas fa-ban banned-icon"></i>
        <h2 style="color: white; margin: 0;">ACCESS DENIED</h2>
        <p class="banned-text">MULTI-ACCOUNT DETECTED</p>
        <p style="font-size: 12px; color: #888; max-width: 280px; margin-top: 10px;">
            System detected multiple accounts on this device (ID: <span id="device-id-display">---</span>).
            <br>This account has been permanently locked.
        </p>
    </div>

    <!-- SCREEN: MAIN APP -->
    <div id="app-container" class="hidden">
        
        <!-- SLIDE 1: INTRO -->
        <div class="slide active" id="slide-1">
            <div class="slide-content" style="text-align: center;">
                <i class="fab fa-telegram fa-5x" style="color: white; margin-bottom: 20px; animation: float 3s ease-in-out infinite;"></i>
                <h1>TG LEGACY</h1>
                <p style="color: #888;">Analyzing your digital footprint...</p>
            </div>
        </div>

        <!-- SLIDE 2: AGE -->
        <div class="slide" id="slide-2">
            <div class="slide-content" style="text-align: center;">
                <div style="font-size: 12px; letter-spacing: 2px; color: var(--primary);">STATISTIC I</div>
                <h1>TIMELINE</h1>
                <div class="big-stat" id="val-year">...</div>
                <div style="background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; display: inline-block;">
                    <span id="score-age">0</span> PTS
                </div>
            </div>
        </div>

        <!-- SLIDE 3: PREMIUM -->
        <div class="slide" id="slide-3">
            <div class="slide-content" style="text-align: center;">
                <div style="font-size: 12px; letter-spacing: 2px; color: var(--accent);">STATISTIC II</div>
                <h1>STATUS</h1>
                <i class="fas fa-star" style="font-size: 60px; color: #333; margin: 20px 0;" id="icon-premium"></i>
                <div>
                    <span id="score-premium">0</span> PTS
                </div>
            </div>
        </div>

        <!-- SLIDE 4: SECURITY CHECK (CAPTCHA) -->
        <div class="slide" id="slide-4">
            <div class="slide-content security-box">
                <h2 style="margin: 0 0 15px 0; font-size: 18px;">HUMAN VERIFICATION</h2>
                <p style="font-size: 12px; color: #888;">Enter the secure code below to claim your allocation.</p>
                
                <div class="security-code" id="captcha-display">LOADING</div>
                <input type="text" class="input-field" id="captcha-input" placeholder="INPUT CODE" maxlength="6">
                
                <button class="btn-primary" onclick="verifyCode()" style="background: var(--primary); color: white;">
                    VERIFY IDENTITY
                </button>
            </div>
        </div>

        <!-- SLIDE 5: DASHBOARD (FINAL) -->
        <div class="slide" id="dashboard-view" style="justify-content: flex-start;">
            <div class="dashboard-header slide-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-weight: bold; font-size: 18px;">MY ASSETS</div>
                    <div style="font-size: 12px; color: var(--primary);">VERIFIED <i class="fas fa-check-circle"></i></div>
                </div>

                <div class="token-card">
                    <div style="display: flex; justify-content: space-between;">
                        <span class="balance-label">Total Balance</span>
                        <span class="token-tag">TON CHAIN</span>
                    </div>
                    <div class="balance-val" id="final-balance">0</div>
                    <div style="font-size: 14px; font-weight: bold;">$TG TOKEN</div>
                </div>

                <div class="withdraw-area">
                    <button class="btn-withdraw locked" onclick="triggerLocked()">
                        <i class="fas fa-arrow-down"></i> Withdraw
                    </button>
                    <button class="btn-withdraw locked" onclick="triggerLocked()">
                        <i class="fas fa-exchange-alt"></i> Swap
                    </button>
                </div>
                
                <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                     <div style="font-size: 12px; margin-bottom: 10px;">WALLET CONNECTION</div>
                     <div id="ton-connect-btn"></div>
                </div>

                <div style="margin-top: 20px; font-size: 10px; color: #444; text-align: center;">
                    UserID: <span id="uid-display"></span>
                </div>
            </div>
        </div>

        <!-- FOOTER NAV (Only for Story) -->
        <div class="footer" id="nav-footer">
            <button class="btn-primary" id="btn-next" onclick="nextSlide()">START ANALYSIS</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        // TON CONNECT
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        // STATE
        let currentUser = null;
        let deviceId = null;
        let currentSlide = 1;
        let scores = { total: 0 };
        let generatedCode = "";

        // UTILS: HAPTIC
        function haptic() {
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }
        function hapticError() {
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
        }
        function hapticSuccess() {
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        async function init() {
            tg.expand();
            tg.setHeaderColor('#050505');
            
            // 1. Get User
            currentUser = tg.initDataUnsafe.user;
            // Testing only: if(!currentUser) currentUser = { id: 11111, first_name: "Test", username: "user" }; 
            
            if(!currentUser) {
                document.body.innerHTML = "Access via Telegram Only";
                return;
            }
            document.getElementById('uid-display').innerText = currentUser.id;

            // 2. Get Device Fingerprint
            const fpPromise = FingerprintJS.load();
            const fp = await fpPromise;
            const result = await fp.get();
            deviceId = result.visitorId;
            document.getElementById('device-id-display').innerText = deviceId;

            // 3. Security Check (Anti-Cheat)
            await checkSecurity();
        }

        async function checkSecurity() {
            try {
                // Check if this user is explicitly banned
                const userRef = doc(db, "users", currentUser.id.toString());
                const userSnap = await getDoc(userRef);

                if (userSnap.exists() && userSnap.data().isBanned) {
                    showBanned();
                    return;
                }

                // Check if device is used by another ID
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("deviceId", "==", deviceId));
                const querySnapshot = await getDocs(q);

                let isDeviceUsedByOther = false;
                
                querySnapshot.forEach((doc) => {
                    // Found a record with this device ID
                    if (doc.id !== currentUser.id.toString()) {
                        isDeviceUsedByOther = true;
                    }
                });

                if (isDeviceUsedByOther) {
                    // BAN CURRENT USER
                    await setDoc(userRef, {
                        id: currentUser.id,
                        isBanned: true,
                        banReason: "Multi-Account Device",
                        deviceId: deviceId,
                        bannedAt: serverTimestamp()
                    }, { merge: true });
                    showBanned();
                } else {
                    // SAVE DEVICE ID (If first time) & PROCEED
                    if (!userSnap.exists() || !userSnap.data().deviceId) {
                        await setDoc(userRef, { deviceId: deviceId }, { merge: true });
                    }
                    
                    // Proceed to App Logic
                    calculateData(currentUser);
                    
                    if (userSnap.exists() && userSnap.data().isAnalyzed) {
                        // Old user -> Skip Story
                        scores.total = userSnap.data().score;
                        showDashboard();
                    } else {
                        // New user -> Show Story
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        generateCaptcha();
                    }
                }

            } catch (e) {
                console.error("Security Error:", e);
                // In case of error, default allow to prevent blocking legit users due to network
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                calculateData(currentUser);
                generateCaptcha();
            }
        }

        function showBanned() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('banned-screen').classList.remove('hidden');
            hapticError();
        }

        function calculateData(user) {
            let year = 2024;
            let agePts = Math.floor((7000000000 - user.id) / 500000);
            if(agePts < 100) agePts = 100;
            if(user.id < 1000000000) year = 2020;
            if(user.id < 500000000) year = 2017;

            let premPts = user.is_premium ? 5000 : 0;
            let idPts = (user.username ? 500 : 0) + (user.photo_url ? 300 : 0);
            
            scores.total = agePts + premPts + idPts;

            // UI
            document.getElementById('val-year').innerText = year;
            document.getElementById('score-age').innerText = agePts;
            document.getElementById('score-premium').innerText = premPts;
            if(user.is_premium) document.getElementById('icon-premium').style.color = "#FFD700";
        }

        // --- STORY NAVIGATION ---
        window.nextSlide = () => {
            haptic();
            if(currentSlide === 1) {
                document.getElementById('btn-next').innerText = "NEXT";
            }
            
            document.getElementById(`slide-${currentSlide}`).classList.remove('active');
            currentSlide++;
            
            if(currentSlide > 4) return; // Should not happen via button

            document.getElementById(`slide-${currentSlide}`).classList.add('active');

            if(currentSlide === 4) {
                // Captcha Slide
                document.getElementById('nav-footer').style.display = 'none';
            }
        }

        // --- CAPTCHA ---
        function generateCaptcha() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let result = "";
            for(let i=0; i<6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            generatedCode = result;
            document.getElementById('captcha-display').innerText = result.split('').join(' ');
        }

        window.verifyCode = async () => {
            haptic();
            const input = document.getElementById('captcha-input').value.toUpperCase().trim();
            if(input === generatedCode) {
                hapticSuccess();
                // Save to DB
                const ref = doc(db, "users", currentUser.id.toString());
                await setDoc(ref, {
                    id: currentUser.id,
                    username: currentUser.username || "",
                    firstName: currentUser.first_name,
                    score: scores.total,
                    isAnalyzed: true,
                    deviceId: deviceId, // Reinforce device ID
                    lastSeen: serverTimestamp()
                }, { merge: true });
                
                showDashboard();
            } else {
                hapticError();
                tg.showAlert("Incorrect Code");
                document.getElementById('captcha-input').value = "";
                generateCaptcha();
            }
        }

        function showDashboard() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Hide all slides
            for(let i=1; i<=4; i++) {
                document.getElementById(`slide-${i}`).classList.remove('active');
            }
            document.getElementById('nav-footer').style.display = 'none';

            // Show Dashboard
            const dash = document.getElementById('dashboard-view');
            dash.classList.add('active');
            
            // Animate Balance
            animateValue('final-balance', 0, scores.total, 1500);
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        window.triggerLocked = () => {
            hapticError();
        }

        // Run
        init();

    </script>
</body>
</html>
