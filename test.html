<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TG Journey Fix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --bg-color: #050505; --ton-blue: #0098EA; --text-main: #ffffff; --glass: rgba(255, 255, 255, 0.05); --error: #ff3b30; --mono: 'JetBrains Mono', monospace; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* DEBUG CONSOLE */
        #debug-console { position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: lime; font-family: var(--mono); font-size: 10px; padding: 5px; z-index: 20000; pointer-events: none; max-height: 100px; overflow: hidden; display: none; }
        
        /* ANIMATIONS */
        .slide { position: absolute; inset: 0; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transform: scale(1.1); transition: opacity 0.5s ease, transform 0.5s ease; text-align: center; }
        .slide.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .slide.exit { opacity: 0; transform: scale(0.9); }
        .fade-up { animation: fadeInUp 0.8s ease forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        #loader { position: fixed; inset: 0; z-index: 9000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--ton-blue); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* BAN SCREEN */
        #ban-screen { position: fixed; inset: 0; z-index: 10000; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }

        /* DASHBOARD */
        .big-number { font-size: 42px; font-weight: 800; color: var(--ton-blue); margin: 15px 0; font-family: var(--mono); }
        .security-box { background: rgba(0, 152, 234, 0.05); border: 1px solid var(--ton-blue); border-radius: 16px; padding: 25px; width: 100%; max-width: 320px; position: relative; overflow: hidden; }
        .sec-code-display { font-family: var(--mono); font-size: 28px; letter-spacing: 5px; color: var(--ton-blue); margin: 15px 0; font-weight: bold; }
        .sec-input { background: #111; border: 1px solid #333; color: white; padding: 15px; border-radius: 8px; width: 100%; text-align: center; font-size: 18px; font-family: var(--mono); outline: none; }
        
        .btn-next { background: white; color: black; border: none; padding: 16px 40px; border-radius: 30px; font-weight: 800; width: 80%; max-width: 300px; cursor: pointer; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .bottom-action { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 50; }

        .distribution-card { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; width: 100%; max-width: 340px; margin-top: 20px; }
        .dist-bar { height: 10px; width: 100%; background: #222; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .dist-fill { height: 100%; background: var(--ton-blue); width: 75%; }
        
        .btn-withdraw { width: 100%; max-width: 340px; background: rgba(255,255,255,0.05); color: #555; border: 1px dashed #444; padding: 16px; border-radius: 12px; margin-top: 15px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 10px; cursor: not-allowed; }
    </style>
</head>
<body>

    <!-- DEBUG CONSOLE -->
    <div id="debug-console"></div>

    <!-- BAN SCREEN -->
    <div id="ban-screen">
        <i class="fas fa-ban" style="font-size: 60px; color: var(--error); margin-bottom: 20px;"></i>
        <h2 style="color:var(--error); margin:0;">DEVICE LOCKED</h2>
        <p style="color:#888; font-size:13px; margin-top:10px;">Multiple accounts detected.</p>
    </div>

    <!-- LOADER -->
    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top: 10px; font-size: 10px; color: #666">LOADING SYSTEM...</div>
    </div>

    <!-- STORY -->
    <div id="story-container">
        <!-- Slide 1 -->
        <div class="slide" id="slide-1">
            <i class="fab fa-telegram fa-4x fade-up" style="color: white; margin-bottom: 30px;"></i>
            <h1 class="fade-up">The Archives</h1>
            <p class="fade-up" style="color:#888">Analyzing footprint...</p>
        </div>
        <!-- Slide 2 -->
        <div class="slide" id="slide-2">
            <div style="font-size:10px; letter-spacing:4px; color:#666; margin-bottom:10px;">TIMELINE</div>
            <h1 class="fade-up">The Origin</h1>
            <div class="big-number fade-up" id="val-year">...</div>
        </div>
        <!-- Slide 3 -->
        <div class="slide" id="slide-3">
            <div style="font-size:10px; letter-spacing:4px; color:#666; margin-bottom:10px;">STATUS</div>
            <h1 class="fade-up">The Elite</h1>
            <div style="font-size: 60px; margin: 20px 0;"><i class="fas fa-star" style="color:#333" id="icon-premium"></i></div>
            <p id="txt-premium" style="color:#888; font-size:12px">Standard User</p>
        </div>
        <!-- Slide 4: Verify -->
        <div class="slide" id="slide-4">
            <div style="font-size:10px; letter-spacing:4px; color:#666; margin-bottom:10px;">SECURITY</div>
            <h1 class="fade-up">Verification</h1>
            <div class="security-box fade-up">
                <div style="font-size:10px; color:#888;">SYSTEM CODE</div>
                <div class="sec-code-display" id="sec-code">...</div>
                <input type="text" class="sec-input" id="sec-input" placeholder="ENTER CODE" maxlength="6">
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="slide" id="view-wallet" style="display:none; justify-content:flex-start; padding-top:60px; background: radial-gradient(circle at top, #111, #000);">
        <div style="font-size:10px; letter-spacing:4px; color:#666; margin-bottom:10px;">ASSETS</div>
        <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:20px; padding:30px; width:100%; max-width:340px; text-align:center;">
            <div style="font-size:12px; color:#888;">BALANCE</div>
            <div class="big-number" style="margin:10px 0; font-size:48px;" id="wallet-balance">0</div>
            <div style="font-weight:bold; color:var(--ton-blue)">$TG TOKEN</div>
        </div>

        <div class="distribution-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px; font-weight:bold;">Token Distribution</span>
                <span style="font-size:10px; color:#666;">75% Community</span>
            </div>
            <div class="dist-bar"><div class="dist-fill"></div></div>
        </div>

        <div style="margin-top:20px; width:100%; max-width:340px; display:flex; justify-content:center;">
             <div id="ton-connect-btn"></div>
        </div>

        <button class="btn-withdraw">
            <i class="fas fa-lock"></i> WITHDRAW (Opens 31/12)
        </button>
    </div>

    <div class="bottom-action" id="nav-footer">
        <button class="btn-next" id="btn-action">START</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // DEBUG LOGGER
        function log(msg) {
            const el = document.getElementById('debug-console');
            el.style.display = 'block';
            el.innerHTML += `> ${msg}<br>`;
            console.log(msg);
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        let app, db, tg;
        let currentUser = null;
        let currentSlide = 1;
        let scores = { total: 0 };
        let systemCode = "";
        let currentIP = "unknown";

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-react-ui/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        async function init() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                tg = window.Telegram.WebApp;
                tg.expand();
                tg.setHeaderColor('#000000');

                // 1. Lấy User (Tự tạo mock nếu lỗi)
                currentUser = tg.initDataUnsafe.user;
                if (!currentUser) {
                    log("User not found. Running in Test Mode.");
                    currentUser = { id: 888888, first_name: "TestUser", username: "tester", is_premium: true }; 
                }
                log(`User ID: ${currentUser.id}`);

                // 2. Lấy IP (Try/Catch để không bị treo)
                try {
                    const res = await fetch('https://api.ipify.org?format=json');
                    const json = await res.json();
                    currentIP = json.ip;
                    log(`IP: ${currentIP}`);
                } catch (e) {
                    log("IP Fetch Failed. Continuing...");
                }

                // 3. Security Check
                const banned = await checkSecurity();
                if (banned) return;

                // 4. Setup Data
                setupCode();
                calculateScore(currentUser);

                // 5. Check DB for existing user
                await checkUserDB();

                // 6. Bind Events
                document.getElementById('btn-action').onclick = nextSlide;

            } catch (err) {
                log(`CRITICAL ERROR: ${err.message}`);
                // Tắt loader nếu lỗi để user thấy thông báo
                document.getElementById('loader').style.display = 'none';
                alert("Lỗi hệ thống. Vui lòng kiểm tra Debug Console trên cùng.");
            }
        }

        async function checkSecurity() {
            try {
                // A. Check LocalStorage
                const storedOwner = localStorage.getItem('tg_app_owner');
                if (!storedOwner) {
                    localStorage.setItem('tg_app_owner', currentUser.id);
                } else if (storedOwner != currentUser.id) {
                    await banUser("Device Conflict");
                    return true;
                }

                // B. Check IP in DB
                if (currentIP !== "unknown") {
                    try {
                        const q = query(collection(db, "users"), where("ip", "==", currentIP));
                        const snap = await getDocs(q);
                        let conflict = false;
                        snap.forEach(doc => {
                            if (doc.id != currentUser.id.toString()) conflict = true;
                        });
                        if (conflict) {
                            await banUser("IP Conflict");
                            return true;
                        }
                    } catch (e) {
                        log("Firestore Index missing for IP. Skipping IP check.");
                    }
                }

                // C. Check Banned Status
                const ref = doc(db, "users", currentUser.id.toString());
                const snap = await getDoc(ref);
                if (snap.exists() && snap.data().isBanned) {
                    showBanScreen();
                    return true;
                }
            } catch (e) {
                log(`Security Check Error: ${e.message}`);
            }
            return false;
        }

        async function banUser(reason) {
            log(`BANNING USER: ${reason}`);
            const ref = doc(db, "users", currentUser.id.toString());
            await setDoc(ref, { id: currentUser.id, isBanned: true, reason: reason }, { merge: true });
            showBanScreen();
        }

        function showBanScreen() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('story-container').style.display = 'none';
            document.getElementById('ban-screen').style.display = 'flex';
        }

        async function checkUserDB() {
            const ref = doc(db, "users", currentUser.id.toString());
            const snap = await getDoc(ref);
            
            // Tắt Loader
            document.getElementById('loader').style.display = 'none';

            if (snap.exists() && snap.data().isAnalyzed) {
                log("Returning User. Showing Dashboard.");
                scores.total = snap.data().score;
                showDashboard();
            } else {
                log("New User. Starting Story.");
                document.getElementById('slide-1').classList.add('active');
            }
        }

        function calculateScore(user) {
            let year = 2024;
            const id = user.id;
            if(id < 500000000) year = 2017;
            else if(id < 1500000000) year = 2020;
            
            let pts = Math.max(100, Math.floor((7000000000 - id)/500000));
            let prem = user.is_premium ? 5000 : 0;
            scores.total = pts + prem + 500;
            
            document.getElementById('val-year').innerText = year;
            if(user.is_premium) {
                document.getElementById('icon-premium').style.color = "#FFD700";
                document.getElementById('txt-premium').innerText = "Premium Verified";
            }
        }

        function setupCode() {
            systemCode = Math.random().toString(36).substring(2,8).toUpperCase();
            document.getElementById('sec-code').innerText = systemCode;
        }

        window.nextSlide = async () => {
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');

            if(currentSlide === 4) {
                const input = document.getElementById('sec-input').value.toUpperCase();
                if(input !== systemCode) {
                    if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                    tg.showAlert("Incorrect Code");
                    return;
                }
                
                // SAVE DB
                const ref = doc(db, "users", currentUser.id.toString());
                await setDoc(ref, {
                    id: currentUser.id,
                    score: scores.total,
                    isAnalyzed: true,
                    ip: currentIP,
                    lastSeen: serverTimestamp()
                }, { merge: true });
                
                showDashboard();
                return;
            }

            const curr = document.getElementById(`slide-${currentSlide}`);
            curr.classList.remove('active');
            curr.classList.add('exit');
            currentSlide++;
            const next = document.getElementById(`slide-${currentSlide}`);
            next.classList.remove('exit');
            next.classList.add('active');

            if(currentSlide === 4) document.getElementById('btn-action').innerText = "VERIFY";
        }

        function showDashboard() {
            document.getElementById('story-container').style.display = 'none';
            document.getElementById('nav-footer').style.display = 'none';
            document.getElementById('view-wallet').style.display = 'flex';
            document.getElementById('wallet-balance').innerText = Math.floor(scores.total / 10).toLocaleString();
        }

        init();
    </script>
</body>
</html>
