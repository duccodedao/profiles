<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>HD Ecosystem Pro | Admin Dashboard</title>
    
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --gold: linear-gradient(135deg, #FFD700, #B8860B);
            --dark: #0f172a;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; scroll-behavior: smooth; overflow-x: hidden; }
        
        .gold-text { background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .bento-card { border: 1px solid rgba(0,0,0,0.05); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: white; }
        .bento-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); border-color: #fbbf24; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .btn-primary { 
            background: var(--dark); color: white; transition: all 0.3s; position: relative; overflow: hidden;
        }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Admin Tabs */
        .admin-tab-btn.active { background-color: #fef08a; color: #854d0e; font-weight: 800; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body class="relative">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-bold text-gray-400 tracking-widest text-xs uppercase">Loading System...</p>
        </div>
    </div>

    <!-- DYNAMIC SIDEBAR (Controlled by Admin) -->
    <div id="dynamic-sidebar" class="fixed left-4 top-1/2 -translate-y-1/2 z-40 hidden md:flex flex-col gap-4">
        <!-- Javascript will inject sidebar items here -->
    </div>

    <!-- NAVIGATION -->
    <nav class="fixed top-0 left-0 right-0 w-full flex justify-center pt-4 px-4 z-50">
        <div class="glass-nav w-full max-w-7xl px-6 py-4 rounded-3xl flex items-center justify-between shadow-lg shadow-black/5">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-black rounded-xl flex items-center justify-center">
                    <i data-lucide="layers" class="text-yellow-500 w-6 h-6"></i>
                </div>
                <div class="flex flex-col">
                    <span class="font-extrabold text-lg leading-none">HD PLATFORM</span>
                    <span class="text-[10px] text-gray-400 font-bold uppercase">Pro Ver 2.0</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="auth-section">
                    <button id="login-btn" class="btn-primary px-6 py-2.5 rounded-2xl text-xs font-bold uppercase tracking-wider">K·∫øt n·ªëi v√≠ / Google</button>
                    
                    <div id="user-info" class="hidden flex items-center gap-3 bg-white p-1.5 pr-4 rounded-2xl border border-gray-200 shadow-sm">
                        <img id="user-photo" class="w-9 h-9 rounded-xl border border-gray-100">
                        <div class="flex flex-col">
                            <span id="user-name" class="text-xs font-bold leading-none">User</span>
                            <span id="user-balance-nav" class="text-[10px] font-bold text-yellow-600">0 $HD</span>
                        </div>
                        <button id="admin-trigger" class="hidden ml-3 p-2 bg-yellow-50 text-yellow-700 rounded-lg hover:bg-yellow-100 transition" title="Admin Panel">
                            <i data-lucide="shield-check" class="w-4 h-4"></i>
                        </button>
                        <button id="logout-btn" class="ml-1 p-2 hover:bg-red-50 hover:text-red-500 rounded-lg transition">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENT WRAPPER -->
    <main class="pt-28 pb-20">
        
        <!-- HERO -->
        <header class="text-center px-6 max-w-4xl mx-auto mb-20">
            <div class="inline-block px-4 py-1.5 rounded-full bg-yellow-50 border border-yellow-100 text-[10px] font-bold text-yellow-700 uppercase tracking-widest mb-6 animate-pulse">
                üöÄ H·ªá sinh th√°i c√¥ng ngh·ªá 2026
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tight mb-6 leading-tight" id="hero-title">
                Loading...
            </h1>
            <p class="text-lg text-gray-500 max-w-2xl mx-auto mb-8" id="hero-subtitle">
                ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß...
            </p>
            <div class="flex justify-center gap-4">
                <a href="#missions" class="btn-primary px-8 py-4 rounded-2xl font-bold flex items-center gap-2 shadow-xl shadow-blue-900/10">
                    SƒÉn $HD Ngay <i data-lucide="arrow-down" class="w-4 h-4"></i>
                </a>
            </div>
        </header>

        <!-- DASHBOARD (Only for Users) -->
        <section id="user-dashboard" class="px-6 mb-20 hidden">
            <div class="max-w-5xl mx-auto bg-gradient-to-br from-gray-900 to-black text-white p-8 md:p-12 rounded-[40px] shadow-2xl relative overflow-hidden">
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-8">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2">S·ªë d∆∞ kh·∫£ d·ª•ng</p>
                        <h2 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600">
                            <span id="user-balance-main">0</span> <span class="text-2xl text-white opacity-40">$HD</span>
                        </h2>
                    </div>
                    <div class="text-right">
                        <button onclick="copyReferralLink()" class="mb-4 bg-white/10 hover:bg-white/20 px-6 py-2 rounded-xl text-sm font-bold backdrop-blur-md transition flex items-center gap-2">
                            <i data-lucide="copy" class="w-4 h-4"></i> Copy Link M·ªùi B·∫°n (+<span id="ref-reward-display">...</span> $HD)
                        </button>
                        <p class="text-xs text-gray-500">M·ªùi b·∫°n b√® ƒë·ªÉ nh·∫≠n th∆∞·ªüng kh√¥ng gi·ªõi h·∫°n.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- MISSIONS GRID -->
        <section id="missions" class="px-6 max-w-6xl mx-auto">
            <div class="flex items-center justify-between mb-10">
                <h2 class="text-3xl font-bold tracking-tight">Danh s√°ch nhi·ªám v·ª•</h2>
                <span class="text-sm font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-lg">C·∫≠p nh·∫≠t 1s tr∆∞·ªõc</span>
            </div>
            
            <div id="missions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Missions will be injected here via JS -->
            </div>
        </section>

    </main>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-gray-100 py-12 px-6">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="font-bold text-lg">HD Ecosystem</div>
            <div id="social-links" class="flex gap-6">
                <!-- Social links injected via JS -->
            </div>
            <p class="text-sm text-gray-400">¬© 2026 All rights reserved.</p>
        </div>
    </footer>

    <!-- ==================================================================================== -->
    <!-- ADMIN PANEL OVERLAY -->
    <!-- ==================================================================================== -->
    <div id="admin-panel" class="fixed inset-0 bg-[#f8fafc] z-[100] hidden overflow-y-auto">
        <div class="min-h-screen flex flex-col">
            <!-- Admin Header -->
            <div class="bg-white px-6 py-4 border-b border-gray-200 sticky top-0 z-10 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-yellow-500 text-white p-2 rounded-lg"><i data-lucide="layout-dashboard"></i></div>
                    <h2 class="text-xl font-black">Admin <span class="text-yellow-600">Control Center</span></h2>
                </div>
                <button id="close-admin" class="p-2 bg-gray-100 rounded-lg hover:bg-red-50 hover:text-red-500 transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex flex-1 flex-col lg:flex-row max-w-[1600px] mx-auto w-full p-6 gap-6">
                <!-- Admin Sidebar Tabs -->
                <div class="w-full lg:w-64 flex flex-col gap-2 shrink-0">
                    <button onclick="switchTab('tab-general')" class="admin-tab-btn active text-left px-4 py-3 rounded-xl hover:bg-gray-100 transition flex items-center gap-3">
                        <i data-lucide="settings" class="w-5 h-5"></i> C·∫•u h√¨nh chung
                    </button>
                    <button onclick="switchTab('tab-missions')" class="admin-tab-btn text-left px-4 py-3 rounded-xl hover:bg-gray-100 transition flex items-center gap-3">
                        <i data-lucide="target" class="w-5 h-5"></i> Nhi·ªám v·ª• (Tasks)
                    </button>
                    <button onclick="switchTab('tab-sidebar')" class="admin-tab-btn text-left px-4 py-3 rounded-xl hover:bg-gray-100 transition flex items-center gap-3">
                        <i data-lucide="menu" class="w-5 h-5"></i> Menu & Sidebar
                    </button>
                    <button onclick="switchTab('tab-users')" class="admin-tab-btn text-left px-4 py-3 rounded-xl hover:bg-gray-100 transition flex items-center gap-3">
                        <i data-lucide="users" class="w-5 h-5"></i> Qu·∫£n l√Ω Users
                    </button>
                </div>

                <!-- Admin Content Area -->
                <div class="flex-1 bg-white rounded-[32px] shadow-sm border border-gray-100 p-8">
                    
                    <!-- TAB 1: C·∫§U H√åNH CHUNG -->
                    <div id="tab-general" class="admin-content block space-y-6">
                        <h3 class="text-2xl font-bold mb-6">C·∫•u h√¨nh Website</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold uppercase text-gray-400 mb-2">Ti√™u ƒë·ªÅ ch√≠nh (Hero Title)</label>
                                <input id="adm-hero-title" type="text" class="w-full p-4 bg-gray-50 rounded-xl border-none focus:ring-2 ring-yellow-500">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-bold uppercase text-gray-400 mb-2">M√¥ t·∫£ ng·∫Øn (Subtitle)</label>
                                <textarea id="adm-hero-sub" class="w-full p-4 bg-gray-50 rounded-xl border-none focus:ring-2 ring-yellow-500 h-24"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-400 mb-2">ƒêi·ªÉm th∆∞·ªüng gi·ªõi thi·ªáu (Ref Reward)</label>
                                <input id="adm-ref-reward" type="number" class="w-full p-4 bg-gray-50 rounded-xl border-none focus:ring-2 ring-yellow-500">
                            </div>
                            <div class="col-span-2 border-t pt-6 mt-2">
                                <h4 class="font-bold mb-4">Link Social Footer</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    <input id="adm-social-fb" placeholder="Facebook URL" class="p-3 bg-gray-50 rounded-lg text-sm">
                                    <input id="adm-social-tele" placeholder="Telegram URL" class="p-3 bg-gray-50 rounded-lg text-sm">
                                    <input id="adm-social-x" placeholder="X (Twitter) URL" class="p-3 bg-gray-50 rounded-lg text-sm">
                                </div>
                            </div>
                        </div>
                        <button onclick="saveGeneralSettings()" class="mt-4 bg-black text-white px-8 py-3 rounded-xl font-bold hover:bg-yellow-600 transition">L∆∞u c·∫•u h√¨nh</button>
                    </div>

                    <!-- TAB 2: NHI·ªÜM V·ª§ -->
                    <div id="tab-missions" class="admin-content hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold">Danh s√°ch Nhi·ªám v·ª•</h3>
                            <button onclick="openAddMissionModal()" class="bg-yellow-500 text-white px-4 py-2 rounded-xl font-bold text-sm hover:bg-yellow-600">
                                + Th√™m Nhi·ªám v·ª•
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50 text-gray-500 uppercase font-bold text-xs">
                                    <tr>
                                        <th class="p-4 rounded-l-xl">T√™n nhi·ªám v·ª•</th>
                                        <th class="p-4">ƒêi·ªÉm ($HD)</th>
                                        <th class="p-4">Lo·∫°i</th>
                                        <th class="p-4 rounded-r-xl text-right">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="adm-mission-list">
                                    <!-- List rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- TAB 3: SIDEBAR / MENU -->
                    <div id="tab-sidebar" class="admin-content hidden space-y-6">
                        <h3 class="text-2xl font-bold">Qu·∫£n l√Ω Sidetab & Menu</h3>
                        <p class="text-gray-500 text-sm">B·∫≠t t·∫Øt hi·ªÉn th·ªã c√°c m·ª•c tr√™n thanh Sidebar b√™n tr√°i (Desktop).</p>
                        
                        <div id="adm-sidebar-list" class="space-y-4 max-w-md">
                            <!-- Sidebar items with toggles rendered by JS -->
                        </div>
                        <button onclick="saveSidebarConfig()" class="mt-4 bg-black text-white px-6 py-3 rounded-xl font-bold hover:bg-yellow-600 transition">L∆∞u Sidebar</button>
                    </div>

                    <!-- TAB 4: USERS -->
                    <div id="tab-users" class="admin-content hidden space-y-6">
                        <h3 class="text-2xl font-bold">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h3>
                        <div class="flex gap-4 mb-4">
                            <input type="text" id="user-search" placeholder="T√¨m theo t√™n..." class="flex-1 p-3 bg-gray-50 rounded-xl border border-gray-200">
                            <button onclick="loadUsers()" class="bg-gray-200 px-4 rounded-xl font-bold hover:bg-gray-300">Refresh</button>
                        </div>
                        <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50 text-gray-500 uppercase font-bold text-xs sticky top-0">
                                    <tr>
                                        <th class="p-4">User</th>
                                        <th class="p-4">Email</th>
                                        <th class="p-4">S·ªë d∆∞ ($HD)</th>
                                        <th class="p-4 text-right">Ch·ªânh s·ª≠a</th>
                                    </tr>
                                </thead>
                                <tbody id="adm-user-list">
                                    <!-- User list rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, addDoc, query, orderBy, limit, deleteDoc, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // ADMIN UID (Thay b·∫±ng UID th·∫≠t c·ªßa b·∫°n sau khi ƒëƒÉng nh·∫≠p l·∫ßn ƒë·∫ßu v√† check console)
        const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1"; 

        // 2. INIT & UTILS
        lucide.createIcons();
        window.switchTab = (tabId) => {
            document.querySelectorAll('.admin-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        // 3. AUTHENTICATION
        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loader').style.display = 'none';
            
            if (user) {
                // UI Changes
                document.getElementById('login-btn').parentElement.classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-info').parentElement.classList.remove('hidden');
                document.getElementById('user-dashboard').classList.remove('hidden');

                document.getElementById('user-photo').src = user.photoURL;
                document.getElementById('user-name').innerText = user.displayName.split(' ').pop();

                // Check Admin
                if (user.uid === ADMIN_UID) {
                    document.getElementById('admin-trigger').classList.remove('hidden');
                    initAdminPanel();
                }

                // Sync User Data
                const userRef = doc(db, "users", user.uid);
                onSnapshot(userRef, (snap) => {
                    if (snap.exists()) {
                        const bal = snap.data().balance || 0;
                        document.querySelectorAll('#user-balance-nav, #user-balance-main').forEach(el => {
                            el.innerText = bal.toLocaleString();
                        });
                    } else {
                        setDoc(userRef, { 
                            name: user.displayName, 
                            email: user.email, 
                            balance: 0, 
                            role: 'user',
                            createdAt: new Date()
                        });
                    }
                });
            } else {
                // Logout UI
                document.getElementById('login-btn').parentElement.classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('user-dashboard').classList.add('hidden');
                document.getElementById('admin-trigger').classList.add('hidden');
            }
        });

        // Event Listeners for Auth
        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        
        // Admin Panel Toggle
        document.getElementById('admin-trigger').onclick = () => document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('close-admin').onclick = () => document.getElementById('admin-panel').style.display = 'none';

        // 4. FRONTEND DATA RENDERING (REALTIME)

        // A. Load Settings (Title, Social, Reward)
        onSnapshot(doc(db, "settings", "general"), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('hero-title').innerText = data.heroTitle || 'HD Ecosystem';
                document.getElementById('hero-subtitle').innerText = data.heroSubtitle || 'N·ªÅn t·∫£ng c√¥ng ngh·ªá t∆∞∆°ng lai';
                document.getElementById('ref-reward-display').innerText = data.refReward || 100;
                
                // Footer Socials
                const socialContainer = document.getElementById('social-links');
                socialContainer.innerHTML = '';
                if(data.socialFb) socialContainer.innerHTML += `<a href="${data.socialFb}" target="_blank" class="hover:text-blue-600"><i data-lucide="facebook"></i></a>`;
                if(data.socialTele) socialContainer.innerHTML += `<a href="${data.socialTele}" target="_blank" class="hover:text-blue-400"><i data-lucide="send"></i></a>`;
                
                // Sync Admin Inputs
                if (auth.currentUser?.uid === ADMIN_UID) {
                    document.getElementById('adm-hero-title').value = data.heroTitle || '';
                    document.getElementById('adm-hero-sub').value = data.heroSubtitle || '';
                    document.getElementById('adm-ref-reward').value = data.refReward || 100;
                    document.getElementById('adm-social-fb').value = data.socialFb || '';
                    document.getElementById('adm-social-tele').value = data.socialTele || '';
                    document.getElementById('adm-social-x').value = data.socialX || '';
                }
                lucide.createIcons();
            }
        });

        // B. Load Missions
        onSnapshot(collection(db, "missions"), (snap) => {
            const grid = document.getElementById('missions-grid');
            grid.innerHTML = '';
            
            snap.forEach(docSnap => {
                const m = docSnap.data();
                const mid = docSnap.id;
                
                const card = `
                <div class="bento-card p-6 rounded-3xl flex flex-col justify-between h-full group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i data-lucide="${m.icon || 'star'}" class="w-24 h-24 text-yellow-500"></i>
                    </div>
                    <div>
                        <div class="w-12 h-12 bg-yellow-50 rounded-xl flex items-center justify-center text-yellow-600 mb-4">
                            <i data-lucide="${m.icon || 'target'}" class="w-6 h-6"></i>
                        </div>
                        <h4 class="font-bold text-lg mb-1">${m.title}</h4>
                        <p class="text-sm text-gray-400 mb-4">${m.desc || 'Ho√†n th√†nh ƒë·ªÉ nh·∫≠n th∆∞·ªüng'}</p>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <span class="font-black text-xl text-yellow-600">+${m.points} $HD</span>
                        <button onclick="doMission('${mid}', '${m.link}', ${m.points})" class="px-4 py-2 bg-black text-white text-xs font-bold rounded-lg hover:bg-gray-800 transition">
                            Th·ª±c hi·ªán
                        </button>
                    </div>
                </div>`;
                grid.innerHTML += card;
            });
            lucide.createIcons();
        });

        // C. Load Sidebar (Dynamic)
        onSnapshot(doc(db, "settings", "sidebar"), (snap) => {
            const container = document.getElementById('dynamic-sidebar');
            container.innerHTML = '';
            const data = snap.data();
            
            if (data && data.items) {
                data.items.forEach(item => {
                    if (item.visible) {
                        container.innerHTML += `
                        <a href="${item.link}" class="w-10 h-10 bg-white shadow-md rounded-xl flex items-center justify-center hover:bg-yellow-500 hover:text-white transition group relative" title="${item.name}">
                            <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                            <span class="absolute left-12 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">${item.name}</span>
                        </a>`;
                    }
                });
                lucide.createIcons();
            }
        });

        // 5. USER ACTIONS
        window.doMission = async (id, link, points) => {
            if (!auth.currentUser) return Swal.fire("L·ªói", "Vui l√≤ng ƒëƒÉng nh·∫≠p!", "error");
            
            // Open Link
            if (link && link !== '#') window.open(link, '_blank');
            
            // Mock Reward Logic (In real app, verify action)
            const result = await Swal.fire({
                title: 'X√°c nh·∫≠n',
                text: "B·∫°n ƒë√£ ho√†n th√†nh nhi·ªám v·ª• ch∆∞a?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ƒê√£ xong!'
            });

            if (result.isConfirmed) {
                const userRef = doc(db, "users", auth.currentUser.uid);
                // Check if already done (logic simplified for demo)
                await updateDoc(userRef, { balance: increment(parseInt(points)) });
                Swal.fire("Tuy·ªát v·ªùi!", `B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ${points} $HD`, "success");
            }
        };

        window.copyReferralLink = () => {
            if (!auth.currentUser) return;
            const link = window.location.origin + "?ref=" + auth.currentUser.uid;
            navigator.clipboard.writeText(link);
            Swal.fire("ƒê√£ copy!", "G·ª≠i link n√†y cho b·∫°n b√® ƒë·ªÉ nh·∫≠n th∆∞·ªüng.", "success");
        };

        // 6. ADMIN FUNCTIONS

        function initAdminPanel() {
            loadAdminMissions();
            loadUsers();
            loadAdminSidebar();
        }

        // --- ADMIN: GENERAL ---
        window.saveGeneralSettings = async () => {
            try {
                await setDoc(doc(db, "settings", "general"), {
                    heroTitle: document.getElementById('adm-hero-title').value,
                    heroSubtitle: document.getElementById('adm-hero-sub').value,
                    refReward: parseInt(document.getElementById('adm-ref-reward').value),
                    socialFb: document.getElementById('adm-social-fb').value,
                    socialTele: document.getElementById('adm-social-tele').value,
                    socialX: document.getElementById('adm-social-x').value
                }, { merge: true });
                Swal.fire("Th√†nh c√¥ng", "ƒê√£ l∆∞u c·∫•u h√¨nh chung", "success");
            } catch (e) { console.error(e); }
        };

        // --- ADMIN: MISSIONS ---
        function loadAdminMissions() {
            onSnapshot(collection(db, "missions"), (snap) => {
                const list = document.getElementById('adm-mission-list');
                list.innerHTML = '';
                snap.forEach(docSnap => {
                    const m = docSnap.data();
                    list.innerHTML += `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="p-4 font-bold">${m.title}</td>
                        <td class="p-4 text-yellow-600 font-bold">${m.points}</td>
                        <td class="p-4 text-xs text-gray-500">${m.icon}</td>
                        <td class="p-4 text-right">
                            <button onclick="deleteMission('${docSnap.id}')" class="text-red-500 hover:text-red-700 text-xs font-bold">X√≥a</button>
                        </td>
                    </tr>`;
                });
            });
        }

        window.openAddMissionModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'Th√™m Nhi·ªám v·ª• M·ªõi',
                html:
                    '<input id="swal-title" class="swal2-input" placeholder="T√™n nhi·ªám v·ª•">' +
                    '<input id="swal-desc" class="swal2-input" placeholder="M√¥ t·∫£ ng·∫Øn">' +
                    '<input id="swal-points" type="number" class="swal2-input" placeholder="S·ªë ƒëi·ªÉm ($HD)">' +
                    '<input id="swal-link" class="swal2-input" placeholder="Link th·ª±c hi·ªán">',
                focusConfirm: false,
                showCancelButton: true,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-title').value,
                        document.getElementById('swal-desc').value,
                        document.getElementById('swal-points').value,
                        document.getElementById('swal-link').value
                    ]
                }
            });

            if (formValues) {
                await addDoc(collection(db, "missions"), {
                    title: formValues[0],
                    desc: formValues[1],
                    points: parseInt(formValues[2]),
                    link: formValues[3],
                    icon: 'check-circle-2',
                    createdAt: new Date()
                });
                Swal.fire("ƒê√£ th√™m!", "Nhi·ªám v·ª• ƒë√£ xu·∫•t hi·ªán tr√™n trang ch·ªß.", "success");
            }
        };

        window.deleteMission = async (id) => {
            if(confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) await deleteDoc(doc(db, "missions", id));
        };

        // --- ADMIN: SIDEBAR ---
        function loadAdminSidebar() {
            onSnapshot(doc(db, "settings", "sidebar"), (snap) => {
                const list = document.getElementById('adm-sidebar-list');
                list.innerHTML = '';
                const data = snap.data();
                
                // Default structure if empty
                const items = data?.items || [
                    { id: 'home', name: 'Trang ch·ªß', icon: 'home', visible: true, link: '#' },
                    { id: 'earn', name: 'Ki·∫øm $HD', icon: 'coins', visible: true, link: '#missions' },
                    { id: 'wallet', name: 'V√≠', icon: 'wallet', visible: false, link: '#' },
                    { id: 'docs', name: 'T√†i li·ªáu', icon: 'book', visible: true, link: '#' }
                ];

                items.forEach((item, index) => {
                    list.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i data-lucide="${item.icon}" class="w-4 h-4 text-gray-500"></i>
                            <span class="font-medium text-sm">${item.name}</span>
                        </div>
                        <label class="inline-flex items-center cursor-pointer relative">
                            <input type="checkbox" class="sr-only peer sb-toggle" data-index="${index}" ${item.visible ? 'checked' : ''}>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>`;
                });
                
                // Store current state for saving
                window.currentSidebarItems = items;
                lucide.createIcons();
            });
        }

        window.saveSidebarConfig = async () => {
            const toggles = document.querySelectorAll('.sb-toggle');
            toggles.forEach(t => {
                const idx = t.getAttribute('data-index');
                window.currentSidebarItems[idx].visible = t.checked;
            });
            await setDoc(doc(db, "settings", "sidebar"), { items: window.currentSidebarItems });
            Swal.fire("ƒê√£ l∆∞u", "Sidebar ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.", "success");
        };

        // --- ADMIN: USERS ---
        window.loadUsers = async () => {
            const list = document.getElementById('adm-user-list');
            list.innerHTML = '<tr><td colspan="4" class="p-4 text-center">ƒêang t·∫£i...</td></tr>';
            
            const q = query(collection(db, "users"), orderBy("balance", "desc"), limit(20));
            const snap = await getDocs(q);
            
            list.innerHTML = '';
            snap.forEach(docSnap => {
                const u = docSnap.data();
                list.innerHTML += `
                <tr class="border-b border-gray-100">
                    <td class="p-4 font-bold flex items-center gap-2">
                         <div class="w-6 h-6 bg-yellow-200 rounded-full flex items-center justify-center text-[10px]">${u.name?.charAt(0)}</div>
                         ${u.name}
                    </td>
                    <td class="p-4 text-gray-500">${u.email}</td>
                    <td class="p-4 font-bold text-yellow-600">${u.balance} $HD</td>
                    <td class="p-4 text-right">
                        <button onclick="editBalance('${docSnap.id}', ${u.balance})" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-xs font-bold">
                            Ch·ªânh ƒëi·ªÉm
                        </button>
                    </td>
                </tr>`;
            });
        };

        window.editBalance = async (uid, currentBal) => {
            const { value: amount } = await Swal.fire({
                title: 'ƒêi·ªÅu ch·ªânh s·ªë d∆∞',
                input: 'number',
                inputLabel: 'Nh·∫≠p s·ªë l∆∞·ª£ng $HD mu·ªën c·ªông th√™m (d√πng s·ªë √¢m ƒë·ªÉ tr·ª´)',
                inputPlaceholder: 'V√≠ d·ª•: 100 ho·∫∑c -50',
                showCancelButton: true
            });

            if (amount) {
                const newAmount = parseInt(amount);
                await updateDoc(doc(db, "users", uid), {
                    balance: increment(newAmount)
                });
                loadUsers(); // Refresh table
                Swal.fire("Th√†nh c√¥ng", `ƒê√£ c·∫≠p nh·∫≠t s·ªë d∆∞ user.`, "success");
            }
        };

    </script>
</body>
</html>
