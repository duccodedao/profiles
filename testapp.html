<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Profile & Admin Panel</title>
    
    <!-- CSS: Tailwind & FontAwesome for fast development -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; background-color: #f8fafc; }
        .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .admin-only { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .skeleton { background: #e2e8f0; border-radius: 4px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: .5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<!-- NAVIGATION -->
<nav class="fixed w-full z-50 glass border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <a href="#" class="text-2xl font-bold text-indigo-600">MyPortfolio</a>
        <div class="space-x-6 hidden md:flex items-center">
            <a href="#about" class="hover:text-indigo-600 font-medium">Giới thiệu</a>
            <a href="#projects" class="hover:text-indigo-600 font-medium">Dự án</a>
            <a href="#blog" class="hover:text-indigo-600 font-medium">Blog</a>
            <button id="loginBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm">Admin</button>
            <button id="logoutBtn" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg text-sm">Thoát</button>
        </div>
    </div>
</nav>

<!-- HERO SECTION -->
<section id="about" class="pt-32 pb-20 px-4">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center gap-12">
        <div class="w-48 h-48 md:w-64 md:h-64 rounded-full overflow-hidden shadow-2xl border-4 border-white" id="profile-img-container">
            <img id="display-avatar" src="https://via.placeholder.com/300" class="w-full h-full object-cover">
        </div>
        <div class="flex-1 text-center md:text-left">
            <h1 id="display-name" class="text-4xl md:text-6xl font-extrabold text-gray-900 mb-4 text-indigo-600">Đang tải...</h1>
            <p id="display-role" class="text-xl text-gray-600 mb-6 italic">Loading role...</p>
            <p id="display-bio" class="text-gray-600 max-w-2xl leading-relaxed">Vui lòng chờ dữ liệu từ Firebase...</p>
        </div>
    </div>
</section>

<!-- SKILLS SECTION -->
<section class="bg-white py-20 px-4">
    <div class="max-w-7xl mx-auto text-center">
        <h2 class="text-3xl font-bold mb-12">Kỹ năng</h2>
        <div id="skills-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Skills rendered here -->
        </div>
    </div>
</section>

<!-- PROJECTS SECTION -->
<section id="projects" class="py-20 px-4 bg-gray-50">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-4">
            <div>
                <h2 class="text-3xl font-bold">Dự án cá nhân</h2>
                <p class="text-gray-500 mt-2">Lọc và sắp xếp theo nhu cầu</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <select id="filterCategory" class="border p-2 rounded-md">
                    <option value="all">Tất cả danh mục</option>
                    <option value="Web Development">Phát triển web</option>
                    <option value="Mobile App">Ứng dụng di động</option>
                    <option value="UI/UX Design">Thiết kế UI/UX</option>
                </select>
                <select id="sortProjects" class="border p-2 rounded-md">
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                    <option value="alpha">A -> Z</option>
                </select>
            </div>
        </div>
        <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Projects rendered here -->
        </div>
    </div>
</section>

<!-- BLOG SECTION -->
<section id="blog" class="py-20 px-4 bg-white">
    <div class="max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold mb-12 text-center">Bài viết gần đây</h2>
        <div id="blog-list" class="space-y-12">
            <!-- Blog items with comments here -->
        </div>
    </div>
</section>

<!-- ADMIN PANEL MODAL -->
<div id="adminPanel" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden overflow-y-auto">
    <div class="min-h-screen p-4 md:p-10 flex justify-center">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row">
            <!-- Sidebar -->
            <div class="w-full md:w-64 bg-gray-900 text-white p-6">
                <h3 class="text-xl font-bold mb-8 flex items-center gap-2">
                    <i class="fas fa-user-shield"></i> Admin Panel
                </h3>
                <nav class="space-y-2">
                    <button onclick="showTab('profile')" class="w-full text-left p-3 rounded hover:bg-gray-800 transition">Thông tin chung</button>
                    <button onclick="showTab('skills')" class="w-full text-left p-3 rounded hover:bg-gray-800 transition">Kỹ năng</button>
                    <button onclick="showTab('projects')" class="w-full text-left p-3 rounded hover:bg-gray-800 transition">Dự án</button>
                    <button onclick="showTab('blogs')" class="w-full text-left p-3 rounded hover:bg-gray-800 transition">Bài viết</button>
                    <button onclick="showTab('comments')" class="w-full text-left p-3 rounded hover:bg-gray-800 transition">Quản lý bình luận</button>
                </nav>
                <button id="closeAdmin" class="mt-8 text-gray-400 hover:text-white underline text-sm">Đóng Panel</button>
            </div>
            
            <!-- Content -->
            <div class="flex-1 p-6 md:p-10 bg-gray-50 overflow-y-auto max-h-[90vh]">
                <!-- Profile Tab -->
                <div id="tab-profile" class="tab-content">
                    <h2 class="text-2xl font-bold mb-6">Cập nhật thông tin</h2>
                    <div class="space-y-4 bg-white p-6 rounded-lg shadow-sm">
                        <div>
                            <label class="block text-sm font-medium">Họ và tên</label>
                            <input type="text" id="edit-name" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Nghề nghiệp</label>
                            <input type="text" id="edit-role" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Tiểu sử ngắn</label>
                            <textarea id="edit-bio" class="w-full border p-2 rounded h-32"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ảnh đại diện (File)</label>
                            <input type="file" id="upload-avatar" class="w-full border p-2 rounded">
                        </div>
                        <button onclick="saveProfile()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">Lưu thay đổi</button>
                    </div>
                </div>

                <!-- Projects Tab -->
                <div id="tab-projects" class="tab-content">
                    <h2 class="text-2xl font-bold mb-6">Quản lý Dự án</h2>
                    <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
                        <h3 class="font-bold mb-4">Thêm dự án mới</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="pj-title" placeholder="Tên dự án" class="border p-2 rounded">
                            <select id="pj-category" class="border p-2 rounded">
                                <option value="Web Development">Phát triển web</option>
                                <option value="Mobile App">Ứng dụng di động</option>
                                <option value="UI/UX Design">Thiết kế UI/UX</option>
                            </select>
                            <input type="date" id="pj-date" class="border p-2 rounded">
                            <input type="file" id="pj-image" class="border p-2 rounded">
                            <textarea id="pj-desc" placeholder="Mô tả" class="border p-2 rounded md:col-span-2"></textarea>
                        </div>
                        <button onclick="addProject()" class="mt-4 bg-green-600 text-white px-6 py-2 rounded">Thêm dự án</button>
                    </div>
                    <div id="admin-projects-list" class="space-y-2"></div>
                </div>

                <!-- Comments Tab -->
                <div id="tab-comments" class="tab-content">
                    <h2 class="text-2xl font-bold mb-6">Duyệt bình luận</h2>
                    <div id="admin-comments-list" class="space-y-4"></div>
                </div>
                
                <!-- (Các tab khác tương tự: Skills, Blogs...) -->
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script type="module">
    // --- FIREBASE IMPORT ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, deleteDoc, query, orderBy, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };
    const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // --- BIẾN TOÀN CỤC ---
    let currentUser = null;
    let projectsData = [];

    // --- AUTHENTICATION ---
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminPanel = document.getElementById('adminPanel');

    loginBtn.onclick = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            if(result.user.uid !== ADMIN_UID) {
                alert("Bạn không có quyền truy cập Admin!");
                await signOut(auth);
            }
        } catch (error) { console.error(error); }
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user && user.uid === ADMIN_UID) {
            currentUser = user;
            loginBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            adminPanel.classList.remove('hidden'); // Hiện panel khi đăng nhập thành công
            showTab('profile');
            loadAdminData();
        } else {
            currentUser = null;
            loginBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            adminPanel.classList.add('hidden');
        }
    });

    document.getElementById('closeAdmin').onclick = () => adminPanel.classList.add('hidden');

    // --- UI TABS ---
    window.showTab = (tabName) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
    };

    // --- PROFILE MANAGEMENT ---
    window.saveProfile = async () => {
        const name = document.getElementById('edit-name').value;
        const role = document.getElementById('edit-role').value;
        const bio = document.getElementById('edit-bio').value;
        const file = document.getElementById('upload-avatar').files[0];
        
        let imageUrl = document.getElementById('display-avatar').src;

        if (file) {
            const storageRef = ref(storage, `avatar/admin_avatar`);
            const snapshot = await uploadBytes(storageRef, file);
            imageUrl = await getDownloadURL(snapshot.ref);
        }

        await setDoc(doc(db, "configs", "profile"), {
            name, role, bio, imageUrl, updatedAt: new Date()
        });
        alert("Cập nhật thành công!");
        loadPublicData();
    };

    // --- PROJECTS MANAGEMENT (CRUD + Filter/Sort) ---
    window.addProject = async () => {
        const title = document.getElementById('pj-title').value;
        const category = document.getElementById('pj-category').value;
        const date = document.getElementById('pj-date').value;
        const desc = document.getElementById('pj-desc').value;
        const file = document.getElementById('pj-image').files[0];

        let imgUrl = "https://via.placeholder.com/400x300";
        if (file) {
            const storageRef = ref(storage, `projects/${Date.now()}_${file.name}`);
            const snapshot = await uploadBytes(storageRef, file);
            imgUrl = await getDownloadURL(snapshot.ref);
        }

        await addDoc(collection(db, "projects"), {
            title, category, date, desc, imgUrl, createdAt: new Date()
        });
        alert("Đã thêm dự án!");
        renderProjects();
    };

    const renderProjects = async () => {
        const querySnapshot = await getDocs(collection(db, "projects"));
        projectsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        applyFilters(); // Render ra ngoài public và admin
    };

    const applyFilters = () => {
        const cat = document.getElementById('filterCategory').value;
        const sort = document.getElementById('sortProjects').value;

        let filtered = projectsData;
        if (cat !== 'all') filtered = filtered.filter(p => p.category === cat);

        if (sort === 'newest') filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
        else if (sort === 'oldest') filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
        else if (sort === 'alpha') filtered.sort((a, b) => a.title.localeCompare(b.title));

        const grid = document.getElementById('projects-grid');
        grid.innerHTML = filtered.map(p => `
            <div class="bg-white rounded-xl overflow-hidden shadow-lg group hover:-translate-y-2 transition duration-300">
                <img src="${p.imgUrl}" class="w-full h-48 object-cover">
                <div class="p-6">
                    <span class="text-xs font-bold text-indigo-500 uppercase">${p.category}</span>
                    <h3 class="text-xl font-bold mt-2">${p.title}</h3>
                    <p class="text-gray-600 text-sm mt-2 line-clamp-3">${p.desc}</p>
                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-gray-400 text-xs">${p.date}</span>
                    </div>
                </div>
            </div>
        `).join('');

        // Admin list
        const adminList = document.getElementById('admin-projects-list');
        if(adminList) {
            adminList.innerHTML = projectsData.map(p => `
                <div class="flex justify-between items-center bg-white p-3 rounded border">
                    <span>${p.title}</span>
                    <button onclick="deleteProject('${p.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }
    };

    window.deleteProject = async (id) => {
        if(confirm("Xóa dự án này?")) {
            await deleteDoc(doc(db, "projects", id));
            renderProjects();
        }
    };

    // --- COMMENT SYSTEM ---
    window.submitComment = async (blogId) => {
        const nameInput = document.getElementById(`name-${blogId}`);
        const textInput = document.getElementById(`text-${blogId}`);
        
        if(!nameInput.value || !textInput.value) return alert("Vui lòng nhập đủ thông tin");

        await addDoc(collection(db, "comments"), {
            blogId,
            userName: nameInput.value,
            text: textInput.value,
            createdAt: new Date(),
            approved: false // Admin cần duyệt hoặc xóa sau
        });

        alert("Bình luận đã gửi!");
        nameInput.value = ''; textInput.value = '';
    };

    const loadComments = (blogId) => {
        const q = query(collection(db, "comments"), where("blogId", "==", blogId), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById(`comments-list-${blogId}`);
            if(!container) return;
            container.innerHTML = snapshot.docs.map(d => {
                const data = d.data();
                return `<div class="bg-gray-50 p-3 rounded mb-2 text-sm">
                    <span class="font-bold">${data.userName}:</span> ${data.text}
                </div>`;
            }).join('');
        });
    };

    // --- BLOG RENDER ---
    const renderBlogs = async () => {
        const q = query(collection(db, "blogs"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        const container = document.getElementById('blog-list');
        
        container.innerHTML = snapshot.docs.map(doc => {
            const b = doc.data();
            const id = doc.id;
            return `
                <div class="border-b pb-10">
                    <h3 class="text-2xl font-bold mb-4">${b.title}</h3>
                    <div class="text-gray-700 mb-6 leading-relaxed">${b.content}</div>
                    
                    <div class="bg-gray-100 p-6 rounded-xl">
                        <h4 class="font-bold mb-4">Bình luận</h4>
                        <div id="comments-list-${id}" class="mb-4"></div>
                        <div class="flex flex-col gap-2">
                            <input type="text" id="name-${id}" placeholder="Tên của bạn" class="p-2 rounded border text-sm">
                            <textarea id="text-${id}" placeholder="Viết bình luận..." class="p-2 rounded border text-sm"></textarea>
                            <button onclick="submitComment('${id}')" class="bg-indigo-600 text-white px-4 py-2 rounded self-start text-sm">Gửi</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        snapshot.docs.forEach(doc => loadComments(doc.id));
    };

    // --- DATA INITIALIZATION ---
    async function loadPublicData() {
        // Load Profile
        const prof = await getDoc(doc(db, "configs", "profile"));
        if(prof.exists()) {
            const d = prof.data();
            document.getElementById('display-name').innerText = d.name;
            document.getElementById('display-role').innerText = d.role;
            document.getElementById('display-bio').innerText = d.bio;
            document.getElementById('display-avatar').src = d.imageUrl;
            
            // Fill admin form
            document.getElementById('edit-name').value = d.name;
            document.getElementById('edit-role').value = d.role;
            document.getElementById('edit-bio').value = d.bio;
        }
        
        renderProjects();
        renderBlogs();
    }

    async function loadAdminData() {
        // Load comments for moderation
        const q = query(collection(db, "comments"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('admin-comments-list');
            list.innerHTML = snapshot.docs.map(d => `
                <div class="flex justify-between items-center bg-white p-4 rounded shadow-sm border-l-4 border-indigo-500">
                    <div>
                        <p class="text-xs text-gray-400">${d.data().blogId}</p>
                        <p class="font-bold">${d.data().userName}: <span class="font-normal text-gray-700">${d.data().text}</span></p>
                    </div>
                    <button onclick="deleteComment('${d.id}')" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        });
    }

    window.deleteComment = async (id) => {
        if(confirm("Xóa bình luận này?")) await deleteDoc(doc(db, "comments", id));
    }

    // Gắn sự kiện filter
    document.getElementById('filterCategory').onchange = applyFilters;
    document.getElementById('sortProjects').onchange = applyFilters;

    // Chạy khi trang load
    loadPublicData();

</script>
</body>
</html>
