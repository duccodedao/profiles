<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Telegram Mini App</title>
    
    <!-- CSS Library -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-main: #ffffff;
            --accent: #00d2ff;
        }

        body {
            background: #0f0c29;
            background: linear-gradient(to bottom, #24243e, #302b63, #0f0c29);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* Glassmorphism Components */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .glass-card:active { transform: scale(0.98); }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 12, 41, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-top: 1px solid var(--glass-border);
            z-index: 1000;
        }

        .nav-item {
            color: #888;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            transition: 0.3s;
        }

        .nav-item.active { color: var(--accent); }
        .nav-item i { margin-bottom: 4px; }

        /* Progress Bar */
        .progress {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .progress-bar { background: var(--accent); border-radius: 10px; }

        /* Sections */
        .app-section { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .app-section.active { display: block; }

        /* Avatar */
        .avatar-lg {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            object-fit: cover;
        }

        /* Task Item */
        .task-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-claim {
            background: var(--accent);
            border: none; color: #000;
            font-weight: bold; border-radius: 12px;
            padding: 5px 15px;
        }

        /* Spin Wheel */
        #wheel-container {
            position: relative;
            width: 250px; height: 250px;
            margin: 20px auto;
        }
        #wheel { width: 100%; height: 100%; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); }

        /* Admin UI */
        .admin-badge {
            background: #ff4b2b;
            font-size: 10px; padding: 2px 8px; border-radius: 10px;
        }

        /* Notification Toast */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: none;
        }
    </style>
</head>
<body>

    <!-- Header Stats -->
    <div class="p-3 d-flex justify-content-between align-items-center">
        <div>
            <span class="d-block small text-secondary">Balance</span>
            <h4 class="mb-0 fw-bold" id="header-points">0 <small style="font-size: 12px; color: var(--accent);">PTS</small></h4>
        </div>
        <div id="admin-tag" style="display: none;">
            <span class="admin-badge">ADMIN PANEL</span>
        </div>
        <div class="text-end">
            <span class="d-block small text-secondary" id="user-rank">Rank: Bronze</span>
            <div class="progress mt-1" style="width: 80px;">
                <div id="level-progress" class="progress-bar" style="width: 20%;"></div>
            </div>
        </div>
    </div>

    <!-- MAIN SECTIONS -->

    <!-- Home: Dashboard & Mini Games -->
    <section id="home" class="app-section active">
        <div class="glass-card text-center animate__animated animate__fadeIn">
            <h5 class="mb-3">Daily Rewards</h5>
            <button class="btn btn-outline-info w-100 mb-2" onclick="dailyCheckIn()">üìÖ Check-in H√¥m Nay</button>
        </div>

        <div class="glass-card text-center">
            <h5>Lucky Spin</h5>
            <div id="wheel-container">
                <img id="wheel" src="https://cdn-icons-png.flaticon.com/512/610/610106.png" alt="wheel">
            </div>
            <button class="btn btn-claim w-100" onclick="spinWheel()">SPIN NOW (50 PTS)</button>
        </div>

        <div class="glass-card">
            <h6>H·ªá th·ªëng Referral</h6>
            <div class="d-flex gap-2">
                <input type="text" id="ref-link" class="form-control bg-dark text-white border-0" readonly value="https://t.me/bot?start=123">
                <button class="btn btn-primary" onclick="copyRef()">Copy</button>
            </div>
            <p class="small mt-2 text-secondary">+500 PTS cho m·ªói ng∆∞·ªùi b·∫°n m·ªùi.</p>
        </div>
    </section>

    <!-- Tasks Section -->
    <section id="tasks" class="app-section">
        <h5 class="mb-3">Nhi·ªám V·ª• Ki·∫øm Point</h5>
        <div id="task-list">
            <!-- Rendered by JS -->
        </div>
    </section>

    <!-- Leaderboard Section -->
    <section id="leaderboard" class="app-section">
        <h5 class="mb-3">B·∫£ng X·∫øp H·∫°ng Top 50</h5>
        <div class="glass-card p-0 overflow-hidden">
            <table class="table table-dark table-borderless mb-0">
                <thead>
                    <tr class="text-secondary small">
                        <th class="ps-3">#</th>
                        <th>User</th>
                        <th class="text-end pe-3">Points</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Rendered by JS -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Airdrop Section -->
    <section id="airdrop" class="app-section">
        <div class="glass-card text-center">
            <i data-lucide="package-open" size="48" class="mb-3 text-info"></i>
            <h4>Airdrop Token</h4>
            <p class="text-secondary">Chuy·ªÉn ƒë·ªïi Point c·ªßa b·∫°n sang Token d·ª± √°n.</p>
            <hr class="bg-secondary">
            <div class="d-flex justify-content-between mb-2">
                <span>T·ª∑ l·ªá:</span>
                <span id="airdrop-rate">1000 PTS = 1 TOKEN</span>
            </div>
            <button class="btn btn-claim w-100 py-3" onclick="swapPoints()">SWAP POINTS TO TOKEN</button>
        </div>
        <div class="glass-card">
            <h6>L·ªãch s·ª≠ giao d·ªãch</h6>
            <div id="history-list" class="small"></div>
        </div>
    </section>

    <!-- Profile Section -->
    <section id="profile" class="app-section">
        <div class="text-center mb-4">
            <img id="u-avatar" src="https://via.placeholder.com/100" class="avatar-lg mb-2">
            <h4 id="u-name">User Name</h4>
            <p class="text-secondary small" id="u-username">@username</p>
        </div>
        
        <div class="row g-2">
            <div class="col-6">
                <div class="glass-card text-center p-2">
                    <small class="text-secondary">UID</small>
                    <div id="u-id" class="fw-bold">0</div>
                </div>
            </div>
            <div class="col-6">
                <div class="glass-card text-center p-2">
                    <small class="text-secondary">Level</small>
                    <div id="u-level" class="fw-bold">1</div>
                </div>
            </div>
        </div>

        <div class="glass-card">
            <div class="d-flex justify-content-between mb-2">
                <span>Status</span>
                <span class="badge bg-success" id="u-status">Active</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Completed Tasks</span>
                <span id="u-tasks">0</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Tokens Earned</span>
                <span id="u-tokens" class="text-info">0</span>
            </div>
        </div>
        
        <button class="btn btn-outline-danger w-100" onclick="logout()">ƒêƒÉng xu·∫•t (Demo)</button>
    </section>

    <!-- Admin Panel Section -->
    <section id="admin" class="app-section">
        <h5 class="mb-3">Qu·∫£n Tr·ªã Vi√™n</h5>
        <div class="glass-card">
            <h6>Qu·∫£n l√Ω Task</h6>
            <div class="mb-3">
                <input type="text" id="adm-task-name" class="form-control mb-1 bg-dark text-white" placeholder="T√™n Task">
                <input type="text" id="adm-task-link" class="form-control mb-1 bg-dark text-white" placeholder="Link">
                <input type="number" id="adm-task-point" class="form-control mb-2 bg-dark text-white" placeholder="Points">
                <button class="btn btn-primary btn-sm w-100" onclick="adminAddTask()">Th√™m Task</button>
            </div>
        </div>
        
        <div class="glass-card">
            <h6>Danh s√°ch User</h6>
            <div id="adm-user-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="glass-card">
            <h6>C·∫•u h√¨nh Airdrop</h6>
            <input type="number" id="adm-rate" class="form-control bg-dark text-white mb-2" placeholder="1 Token = ? Point">
            <button class="btn btn-warning btn-sm w-100" onclick="adminUpdateRate()">C·∫≠p nh·∫≠t t·ª∑ l·ªá</button>
        </div>
    </section>

    <!-- Nav Bottom -->
    <nav class="bottom-nav">
        <a href="javascript:void(0)" class="nav-item active" onclick="showSection('home', this)">
            <i data-lucide="home"></i><span>Home</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="showSection('tasks', this)">
            <i data-lucide="check-square"></i><span>Tasks</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="showSection('leaderboard', this)">
            <i data-lucide="award"></i><span>Top</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="showSection('airdrop', this)">
            <i data-lucide="zap"></i><span>Airdrop</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" onclick="showSection('profile', this)">
            <i data-lucide="user"></i><span>Profile</span>
        </a>
        <a href="javascript:void(0)" id="nav-admin" class="nav-item d-none" onclick="showSection('admin', this)">
            <i data-lucide="shield-check"></i><span>Admin</span>
        </a>
    </nav>

    <!-- Firebase & Logic Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // 1. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. Constants & State
        const ADMIN_ID = "5387725104";
        let currentUser = null;
        let userData = {};
        const tg = window.Telegram.WebApp;

        // 3. Init App
        async function init() {
            tg.expand();
            lucide.createIcons();

            // L·∫•y data t·ª´ Telegram
            const user = tg.initDataUnsafe?.user || {
                id: 12345678,
                first_name: "Demo",
                last_name: "User",
                username: "demouser",
                photo_url: "https://api.dicebear.com/7.x/avataaars/svg?seed=Demo"
            };

            currentUser = user;
            await syncUser(user);
            checkAdmin(user.id);
            listenToUpdates();
            loadTasks();
            loadLeaderboard();
        }

        // 4. Firebase Sync User
        async function syncUser(user) {
            const userRef = db.collection("users").doc(user.id.toString());
            const doc = await userRef.get();

            if (!doc.exists) {
                const newUser = {
                    uid: user.id,
                    name: user.first_name + " " + (user.last_name || ""),
                    username: user.username || "n/a",
                    avatar: user.photo_url || "https://api.dicebear.com/7.x/avataaars/svg?seed=" + user.id,
                    points: 1000,
                    tokens: 0,
                    level: 1,
                    rank: "Bronze",
                    status: "active",
                    tasksCompleted: [],
                    lastCheckIn: null,
                    referredBy: ""
                };
                await userRef.set(newUser);
                userData = newUser;
            } else {
                userData = doc.data();
            }
            updateUI();
        }

        // 5. UI Updates
        function updateUI() {
            document.getElementById('header-points').innerText = userData.points.toLocaleString();
            document.getElementById('user-rank').innerText = "Rank: " + userData.rank;
            document.getElementById('u-name').innerText = userData.name;
            document.getElementById('u-username').innerText = "@" + userData.username;
            document.getElementById('u-id').innerText = userData.uid;
            document.getElementById('u-level').innerText = userData.level;
            document.getElementById('u-tasks').innerText = userData.tasksCompleted.length;
            document.getElementById('u-tokens').innerText = (userData.tokens || 0).toFixed(2);
            document.getElementById('u-avatar').src = userData.avatar;
            document.getElementById('level-progress').style.width = (userData.points % 1000) / 10 + "%";
        }

        function showSection(id, el) {
            document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        function checkAdmin(uid) {
            if (uid.toString() === ADMIN_ID) {
                document.getElementById('nav-admin').classList.remove('d-none');
                document.getElementById('admin-tag').style.display = 'block';
            }
        }

        // 6. Logic Nghi·ªáp V·ª•
        async function dailyCheckIn() {
            const now = new Date().toDateString();
            if (userData.lastCheckIn === now) {
                alert("H√¥m nay b·∫°n ƒë√£ nh·∫≠n qu√† r·ªìi!");
                return;
            }
            await db.collection("users").doc(currentUser.id.toString()).update({
                points: firebase.firestore.FieldValue.increment(100),
                lastCheckIn: now
            });
            alert("Ch√∫c m·ª´ng! B·∫°n nh·∫≠n ƒë∆∞·ª£c 100 PTS");
        }

        async function spinWheel() {
            if (userData.points < 50) {
                alert("Kh√¥ng ƒë·ªß Point!"); return;
            }
            const wheel = document.getElementById('wheel');
            const randDeg = Math.floor(Math.random() * 360) + 1440; // √≠t nh·∫•t 4 v√≤ng
            wheel.style.transform = `rotate(${randDeg}deg)`;

            // Tr·ª´ point
            await db.collection("users").doc(currentUser.id.toString()).update({
                points: firebase.firestore.FieldValue.increment(-50)
            });

            setTimeout(async () => {
                const win = [50, 100, 200, 0, 500, 10][Math.floor(Math.random() * 6)];
                await db.collection("users").doc(currentUser.id.toString()).update({
                    points: firebase.firestore.FieldValue.increment(win)
                });
                alert(`V√≤ng quay d·ª´ng l·∫°i! B·∫°n nh·∫≠n ƒë∆∞·ª£c ${win} PTS`);
            }, 4000);
        }

        // 7. Tasks System
        async function loadTasks() {
            db.collection("tasks").onSnapshot(snapshot => {
                const taskContainer = document.getElementById('task-list');
                taskContainer.innerHTML = "";
                snapshot.forEach(doc => {
                    const task = doc.data();
                    const isDone = userData.tasksCompleted.includes(doc.id);
                    taskContainer.innerHTML += `
                        <div class="glass-card task-card animate__animated animate__fadeInUp">
                            <div>
                                <h6 class="mb-0">${task.name}</h6>
                                <small class="text-info">+${task.points} PTS</small>
                            </div>
                            ${isDone ? '<span class="text-success small">‚úì Completed</span>' : 
                            `<button class="btn btn-claim" onclick="doTask('${doc.id}', '${task.link}', ${task.points})">L√†m</button>`}
                        </div>
                    `;
                });
            });
        }

        async function doTask(taskId, link, points) {
            window.open(link, '_blank');
            // Gi·∫£ l·∫≠p ch·ªù claim
            setTimeout(async () => {
                if(confirm("B·∫°n ƒë√£ ho√†n th√†nh nhi·ªám v·ª•?")) {
                    await db.collection("users").doc(currentUser.id.toString()).update({
                        points: firebase.firestore.FieldValue.increment(points),
                        tasksCompleted: firebase.firestore.FieldValue.arrayUnion(taskId)
                    });
                }
            }, 2000);
        }

        // 8. Leaderboard Realtime
        function loadLeaderboard() {
            db.collection("users").orderBy("points", "desc").limit(50).onSnapshot(snapshot => {
                const body = document.getElementById('leaderboard-body');
                body.innerHTML = "";
                let i = 1;
                snapshot.forEach(doc => {
                    const u = doc.data();
                    body.innerHTML += `
                        <tr class="${u.uid == currentUser.id ? 'table-active' : ''}">
                            <td class="ps-3 text-secondary">${i++}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <img src="${u.avatar}" style="width:24px; height:24px; border-radius:50%; margin-right:8px;">
                                    <span class="small">${u.name.substring(0,12)}</span>
                                </div>
                            </td>
                            <td class="text-end pe-3 fw-bold text-info">${u.points.toLocaleString()}</td>
                        </tr>
                    `;
                });
            });
        }

        // 9. Admin Functions
        async function adminAddTask() {
            const name = document.getElementById('adm-task-name').value;
            const link = document.getElementById('adm-task-link').value;
            const pts = parseInt(document.getElementById('adm-task-point').value);
            if (!name || !link || !pts) return alert("Nh·∫≠p ƒë·ªß data");
            await db.collection("tasks").add({ name, link, points: pts });
            alert("ƒê√£ th√™m task!");
        }

        // 10. Helpers
        function listenToUpdates() {
            db.collection("users").doc(currentUser.id.toString()).onSnapshot(doc => {
                if (doc.exists) {
                    userData = doc.data();
                    updateUI();
                }
            });
        }

        function copyRef() {
            const el = document.getElementById('ref-link');
            el.select();
            document.execCommand('copy');
            tg.showScanQrPopup({ text: "Ref Link Copied!" });
        }

        async function swapPoints() {
            if (userData.points < 1000) return alert("C·∫ßn t·ªëi thi·ªÉu 1000 PTS ƒë·ªÉ ƒë·ªïi");
            const tokens = userData.points / 1000;
            await db.collection("users").doc(currentUser.id.toString()).update({
                tokens: firebase.firestore.FieldValue.increment(tokens),
                points: 0
            });
            alert(`ƒê√£ ƒë·ªïi th√†nh c√¥ng ${tokens.toFixed(2)} Token!`);
        }

        // Kh·ªüi ch·∫°y
        init();

    </script>
</body>
</html>
