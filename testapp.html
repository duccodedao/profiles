<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- SEO cơ bản -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="seo-title">Portfolio — Developer</title>
  <meta name="description" id="seo-desc" content="Hồ sơ cá nhân chuyên nghiệp: kỹ năng, dự án, blog, testimonials, liên hệ." />
  <meta name="theme-color" content="#0f1218" />
  <link rel="canonical" href="https://your-domain.com/" />

  <!-- Open Graph -->
  <meta property="og:title" content="Portfolio — Developer" />
  <meta property="og:description" content="Hồ sơ cá nhân chuyên nghiệp: kỹ năng, dự án, blog, testimonials, liên hệ." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://your-domain.com/og-image.jpg" />

  <!-- JSON-LD schema (động sẽ cập nhật bằng JS) -->
  <script type="application/ld+json" id="jsonld">
  {
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "Developer",
    "url": "https://your-domain.com/",
    "image": "https://your-domain.com/avatar.jpg",
    "jobTitle": "Software Engineer",
    "sameAs": []
  }
  </script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <!-- AOS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css"/>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Styles: Glassmorphism + Gradient + Blur + Parallax -->
  <style>
    :root{
      --bg: #0b0f16;
      --bg-soft: #0f1218;
      --text: #e6e9ef;
      --muted: #a8b0c0;
      --primary: #6ee7ff;
      --accent: #8b5cf6;
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --glass-blur: 18px;
    }
    [data-theme="light"]{
      --bg: #f6f8fb;
      --bg-soft: #ffffff;
      --text: #0f1218;
      --muted: #5b6473;
      --primary: #0ea5e9;
      --accent: #7c3aed;
      --card: rgba(255,255,255,0.7);
      --border: rgba(0,0,0,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    html,body{
      background: radial-gradient(1200px 600px at 10% 10%, #0f172a 0%, var(--bg) 40%, #0b0f16 100%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      scroll-behavior: smooth;
    }
    .gradient-text{
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .glass{
      background: var(--card);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .btn-soft{
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
    }
    .btn-soft:hover{
      background: rgba(255,255,255,0.12);
      color: var(--text);
    }
    .container-narrow{max-width: 1080px;}
    .shadow-soft{box-shadow: var(--shadow);}
    .section{padding: 80px 0;}
    .section-title{
      font-family: "Space Grotesk", Inter, sans-serif;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    /* Sidebar */
    .sidebar{
      position: fixed; top:0; left:0; height:100vh; width:320px;
      transform: translateX(-100%);
      transition: transform .35s ease;
      z-index: 1000;
      background: linear-gradient(180deg, rgba(20,24,32,.9), rgba(20,24,32,.7));
      backdrop-filter: blur(16px);
      border-right: 1px solid var(--border);
    }
    .sidebar.open{transform: translateX(0);}
    .sidebar-header{padding: 24px; border-bottom: 1px solid var(--border);}
    .sidebar-body{padding: 16px 24px; overflow-y: auto; height: calc(100vh - 160px);}
    .sidebar-footer{padding: 16px 24px; border-top: 1px solid var(--border);}
    .avatar{
      width:72px; height:72px; border-radius: 16px; object-fit: cover;
      box-shadow: var(--shadow);
    }
    .menu-item{
      display:flex; align-items:center; gap:12px; padding:10px 12px; border-radius:12px;
      color: var(--text); text-decoration:none;
    }
    .menu-item:hover{background: rgba(255,255,255,0.06);}
    .sidebar-toggle{
      position: fixed; left:16px; top:16px; z-index:1100;
    }
    /* Topbar */
    .topbar{
      position: sticky; top:0; z-index: 900;
      background: linear-gradient(180deg, rgba(15,18,24,.85), rgba(15,18,24,.6));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    /* Hero */
    .hero{
      min-height: 70vh;
      display:flex; align-items:center;
      background: radial-gradient(800px 400px at 80% 20%, rgba(110,231,255,.15), transparent 60%),
                  radial-gradient(800px 400px at 20% 80%, rgba(139,92,246,.12), transparent 60%);
    }
    .hero-card{
      padding: 28px; display:flex; gap:24px; align-items:center;
    }
    .hero-avatar{
      width:120px; height:120px; border-radius: 24px; object-fit: cover;
      box-shadow: var(--shadow);
      transition: transform .25s ease, box-shadow .25s ease;
    }
    .hero-avatar:focus, .hero-avatar:active{
      transform: scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,.45);
      outline: none;
    }
    /* Cards */
    .card-clean{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
    }
    /* Skills */
    .skill-item{margin-bottom: 16px;}
    .progress{
      height: 10px; background: rgba(255,255,255,0.08);
    }
    .progress-bar{
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }
    /* Timeline */
    .timeline{
      position: relative; padding-left: 28px;
    }
    .timeline::before{
      content:""; position:absolute; left:10px; top:0; bottom:0; width:2px; background: rgba(255,255,255,0.12);
    }
    .timeline-item{position:relative; margin-bottom: 24px;}
    .timeline-item::before{
      content:""; position:absolute; left:-2px; top:4px; width:10px; height:10px; border-radius:50%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      box-shadow: 0 0 0 4px rgba(255,255,255,0.06);
    }
    /* Gallery */
    .gallery img{
      width:100%; border-radius: 14px; object-fit: cover;
      transition: transform .25s ease, box-shadow .25s ease;
      box-shadow: var(--shadow);
    }
    .gallery img:focus, .gallery img:active{
      transform: scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,.45);
      outline: none;
    }
    /* Testimonials slider (simple) */
    .slider{
      display:flex; gap:16px; overflow-x:auto; scroll-snap-type: x mandatory; padding-bottom: 8px;
    }
    .slide{
      min-width: 320px; scroll-snap-align: start;
    }
    /* Contact */
    .form-control, .form-select{
      background: rgba(255,255,255,0.06); border:1px solid var(--border); color: var(--text);
    }
    .form-control:focus{border-color: var(--primary); box-shadow: none;}
    /* Footer */
    footer{padding: 40px 0; color: var(--muted);}
    /* Loader */
    .loader{
      position: fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(10,12,18,.6); backdrop-filter: blur(8px); z-index: 1200;
      transition: opacity .25s ease, visibility .25s ease;
    }
    .loader.hidden{opacity:0; visibility:hidden;}
    .pulse{
      width: 14px; height:14px; border-radius:50%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      box-shadow: 0 0 0 0 rgba(110,231,255,.7);
      animation: pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{box-shadow: 0 0 0 0 rgba(110,231,255,.6);}
      70%{box-shadow: 0 0 0 18px rgba(110,231,255,0);}
      100%{box-shadow: 0 0 0 0 rgba(110,231,255,0);}
    }
    /* Responsive */
    @media (max-width: 992px){
      .hero-card{flex-direction: column; text-align:center;}
      .sidebar{width: 88vw;}
    }
  </style>
</head>
<body data-theme="dark">
  <!-- Loader -->
  <div class="loader" id="loader">
    <div class="glass p-3 d-flex align-items-center gap-3">
      <div class="pulse"></div>
      <div class="text-muted">Đang tải nội dung…</div>
    </div>
  </div>

  <!-- Sidebar toggle -->
  <button class="btn btn-soft sidebar-toggle" id="sidebarToggle"><i class="fa-solid fa-bars"></i></button>

  <!-- Sidebar -->
  <aside class="sidebar glass" id="sidebar">
    <div class="sidebar-header d-flex align-items-center gap-3">
      <img id="sb-avatar" class="avatar" src="https://via.placeholder.com/160x160.png?text=Avatar" alt="Avatar">
      <div class="flex-grow-1">
        <div class="fw-bold" id="sb-name">Developer Name</div>
        <div class="text-muted small" id="sb-nick">@nickname</div>
      </div>
      <button class="btn btn-soft" id="closeSidebar"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="sidebar-body">
      <nav id="dynamicCategories" class="d-grid gap-1">
        <!-- Danh mục động từ Firebase -->
      </nav>
      <hr class="my-3">
      <div class="d-flex align-items-center justify-content-between">
        <button class="btn btn-soft" id="loginBtn"><i class="fa-solid fa-right-to-bracket me-2"></i><span id="loginText">Login</span></button>
        <button class="btn btn-soft" id="themeBtn"><i class="fa-solid fa-moon me-2"></i><span id="themeText">Dark</span></button>
      </div>
      <div class="mt-3 d-none" id="adminPanelBtnWrap">
        <button class="btn btn-soft w-100" id="adminPanelBtn"><i class="fa-solid fa-shield-halved me-2"></i>Admin Panel</button>
      </div>
    </div>
    <div class="sidebar-footer">
      <div class="small text-muted">© <span id="year"></span> Portfolio</div>
    </div>
  </aside>

  <!-- Topbar -->
  <div class="topbar">
    <div class="container container-narrow py-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <a href="#" class="text-decoration-none text-light fw-semibold">Portfolio</a>
        <span class="badge rounded-pill text-bg-dark">Developer</span>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a id="cvLink" class="btn btn-soft" target="_blank"><i class="fa-solid fa-file-pdf me-2"></i>CV</a>
        <div id="socialLinks" class="d-flex align-items-center gap-2"></div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main class="container container-narrow">
    <!-- Hero / Profile card -->
    <section class="section hero" id="profile" data-aos="fade-up">
      <div class="glass hero-card w-100">
        <img id="hero-avatar" class="hero-avatar" src="https://via.placeholder.com/240x240.png?text=Avatar" alt="Avatar" tabindex="0">
        <div class="flex-grow-1">
          <h1 class="section-title mb-2 gradient-text" id="displayName">Developer Name</h1>
          <div class="text-muted mb-3" id="shortBio">Giới thiệu ngắn gọn, súc tích, chuyên nghiệp.</div>
          <div class="d-flex flex-wrap gap-2">
            <a href="#skills" class="btn btn-soft"><i class="fa-solid fa-code me-2"></i>Kỹ năng</a>
            <a href="#projects" class="btn btn-soft"><i class="fa-solid fa-diagram-project me-2"></i>Dự án</a>
            <a href="#blog" class="btn btn-soft"><i class="fa-solid fa-blog me-2"></i>Blog</a>
            <a href="#contact" class="btn btn-soft"><i class="fa-solid fa-envelope me-2"></i>Liên hệ</a>
          </div>
        </div>
      </div>
    </section>

    <!-- About -->
    <section class="section" id="about" data-aos="fade-up">
      <div class="row g-4">
        <div class="col-lg-7">
          <div class="glass p-4">
            <h2 class="section-title mb-3">Giới thiệu</h2>
            <div id="longBio" class="text-muted">Giới thiệu dài — triết lý làm việc, giá trị, định hướng kỹ thuật.</div>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="glass p-4">
            <h2 class="section-title mb-3">Thành tựu</h2>
            <ul id="achievements" class="list-unstyled d-grid gap-2">
              <!-- achievements -->
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Skills -->
    <section class="section" id="skills" data-aos="fade-up">
      <div class="glass p-4">
        <h2 class="section-title mb-3">Kỹ năng</h2>
        <div id="skillsList">
          <!-- skill progress -->
        </div>
      </div>
    </section>

    <!-- Timeline -->
    <section class="section" id="timeline" data-aos="fade-up">
      <div class="glass p-4">
        <h2 class="section-title mb-3">Kinh nghiệm</h2>
        <div id="timelineList" class="timeline">
          <!-- timeline items -->
        </div>
      </div>
    </section>

    <!-- Projects -->
    <section class="section" id="projects" data-aos="fade-up">
      <div class="glass p-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h2 class="section-title">Dự án</h2>
          <div class="text-muted small">Gallery</div>
        </div>
        <div id="projectGallery" class="row g-3 gallery">
          <!-- project cards -->
        </div>
      </div>
    </section>

    <!-- Blog -->
    <section class="section" id="blog" data-aos="fade-up">
      <div class="glass p-4">
        <h2 class="section-title mb-3">Blog</h2>
        <div id="blogList" class="row g-3">
          <!-- blog items -->
        </div>
      </div>
    </section>

    <!-- Testimonials -->
    <section class="section" id="testimonials" data-aos="fade-up">
      <div class="glass p-4">
        <h2 class="section-title mb-3">Testimonials</h2>
        <div id="testimonialsSlider" class="slider">
          <!-- slides -->
        </div>
      </div>
    </section>

    <!-- Contact -->
    <section class="section" id="contact" data-aos="fade-up">
      <div class="glass p-4">
        <h2 class="section-title mb-3">Liên hệ</h2>
        <form id="contactForm" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Họ tên</label>
            <input type="text" class="form-control" id="cName" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="cEmail" required>
          </div>
          <div class="col-12">
            <label class="form-label">Nội dung</label>
            <textarea class="form-control" id="cMessage" rows="4" required></textarea>
          </div>
          <div class="col-12 d-flex align-items-center gap-2">
            <button class="btn btn-soft" type="submit"><i class="fa-solid fa-paper-plane me-2"></i>Gửi</button>
            <div class="small text-muted">Phản hồi sẽ lưu vào Firestore (read-only với user, write chỉ admin).</div>
          </div>
        </form>
      </div>
    </section>

    <!-- QR CV -->
    <section class="section" id="qrcv" data-aos="fade-up">
      <div class="glass p-4 text-center">
        <h2 class="section-title mb-3">QR CV</h2>
        <canvas id="qrCanvas" width="220" height="220" class="shadow-soft" style="border-radius:12px;"></canvas>
        <div class="text-muted small mt-2">Quét để mở CV PDF</div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="container container-narrow">
    <div class="d-flex align-items-center justify-content-between">
      <div>© <span id="year2"></span> — Crafted with care.</div>
      <div class="small">Made for speed — 60fps UI.</div>
    </div>
  </footer>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1300">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Thông báo</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- AOS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <!-- App JS -->
  <script>
    // ====== Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
      authDomain: "profile-d1214.firebaseapp.com",
      projectId: "profile-d1214",
      storageBucket: "profile-d1214.firebasestorage.app",
      messagingSenderId: "914980131889",
      appId: "1:914980131889:web:72f8da15c42dbee671b110",
      measurementId: "G-C587M69LZW"
    };
    const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1"; // đổi theo hướng dẫn bên dưới

    // ====== Firebase init ======
    firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics();
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ====== UI helpers ======
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const toastEl = $('#toast');
    const toast = new bootstrap.Toast(toastEl);

    function showToast(msg){
      $('#toastBody').textContent = msg;
      toast.show();
    }
    function setLoading(show){
      const loader = $('#loader');
      if(show){ loader.classList.remove('hidden'); }
      else { loader.classList.add('hidden'); }
    }
    function setTheme(theme){
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      $('#themeText').textContent = theme === 'dark' ? 'Dark' : 'Light';
      $('#themeBtn').innerHTML = theme === 'dark'
        ? '<i class="fa-solid fa-moon me-2"></i>Dark'
        : '<i class="fa-solid fa-sun me-2"></i>Light';
    }
    function toggleSidebar(open){
      const sb = $('#sidebar');
      if(open === undefined) sb.classList.toggle('open');
      else sb.classList.toggle('open', open);
    }

    // ====== AOS init ======
    AOS.init({ duration: 700, once: true, easing: 'ease-out-cubic' });

    // ====== Theme init ======
    (function(){
      const saved = localStorage.getItem('theme') || 'dark';
      setTheme(saved);
      $('#year').textContent = new Date().getFullYear();
      $('#year2').textContent = new Date().getFullYear();
    })();

    // ====== Sidebar controls ======
    $('#sidebarToggle').addEventListener('click', () => toggleSidebar());
    $('#closeSidebar').addEventListener('click', () => toggleSidebar(false));
    $('#themeBtn').addEventListener('click', () => {
      const cur = document.body.getAttribute('data-theme');
      setTheme(cur === 'dark' ? 'light' : 'dark');
    });

    // ====== Auth (Google) ======
    let currentUser = null;
    async function signIn(){
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    }
    async function signOut(){
      await auth.signOut();
    }
    $('#loginBtn').addEventListener('click', async () => {
      try{
        if(currentUser){ await signOut(); showToast('Đã đăng xuất'); }
        else { await signIn(); showToast('Đăng nhập thành công'); }
      }catch(e){ console.error(e); showToast('Đăng nhập thất bại'); }
    });

    auth.onAuthStateChanged(user => {
      currentUser = user || null;
      $('#loginText').textContent = currentUser ? 'Logout' : 'Login';
      const isAdmin = !!currentUser && currentUser.uid === ADMIN_UID;
      $('#adminPanelBtnWrap').classList.toggle('d-none', !isAdmin);
    });

    // ====== Firestore refs ======
    const refs = {
      profile: db.collection('profile').doc('main'),
      skills: db.collection('skills'),
      achievements: db.collection('achievements'),
      timeline: db.collection('timeline'),
      projects: db.collection('projects'),
      blog: db.collection('blog'),
      testimonials: db.collection('testimonials'),
      categories: db.collection('categories'),
      contact: db.collection('contact') // submissions
    };

    // ====== Renderers ======
    function renderProfile(p){
      if(!p) return;
      $('#sb-avatar').src = p.avatar || $('#sb-avatar').src;
      $('#hero-avatar').src = p.avatar || $('#hero-avatar').src;
      $('#sb-name').textContent = p.displayName || 'Developer Name';
      $('#displayName').textContent = p.displayName || 'Developer Name';
      $('#sb-nick').textContent = p.nickname ? '@'+p.nickname : '@nickname';
      $('#shortBio').textContent = p.shortBio || 'Giới thiệu ngắn gọn, súc tích, chuyên nghiệp.';
      $('#longBio').textContent = p.longBio || 'Giới thiệu dài — triết lý làm việc, giá trị, định hướng kỹ thuật.';
      if(p.cvUrl){ $('#cvLink').href = p.cvUrl; }
      // Social
      const socialWrap = $('#socialLinks'); socialWrap.innerHTML = '';
      (p.social || []).forEach(s => {
        const a = document.createElement('a');
        a.href = s.url; a.target = '_blank'; a.className = 'btn btn-soft';
        a.innerHTML = `<i class="${s.icon || 'fa-brands fa-link'}"></i>`;
        socialWrap.appendChild(a);
      });
      // SEO dynamic
      $('#seo-title').textContent = p.displayName ? `${p.displayName} — Portfolio` : 'Portfolio — Developer';
      $('#seo-desc').setAttribute('content', p.shortBio || 'Hồ sơ cá nhân chuyên nghiệp.');
      const jsonld = {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": p.displayName || "Developer",
        "url": location.origin + location.pathname,
        "image": p.avatar || "",
        "jobTitle": p.title || "Software Engineer",
        "sameAs": (p.social || []).map(s => s.url)
      };
      $('#jsonld').textContent = JSON.stringify(jsonld);
      // QR CV
      if(p.cvUrl) drawQR(p.cvUrl);
    }

    function renderAchievements(list){
      const ul = $('#achievements'); ul.innerHTML = '';
      list.forEach(a => {
        const li = document.createElement('li');
        li.className = 'd-flex align-items-start gap-2';
        li.innerHTML = `<i class="fa-solid fa-award text-warning mt-1"></i>
                        <div><div class="fw-semibold">${a.title}</div>
                        <div class="text-muted small">${a.desc || ''}</div></div>`;
        ul.appendChild(li);
      });
    }

    function renderSkills(list){
      const wrap = $('#skillsList'); wrap.innerHTML = '';
      list.forEach(s => {
        const div = document.createElement('div');
        div.className = 'skill-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between mb-1">
            <div class="fw-semibold">${s.name}</div>
            <div class="text-muted small">${s.level || 0}%</div>
          </div>
          <div class="progress"><div class="progress-bar" role="progressbar" style="width:${s.level || 0}%"></div></div>
        `;
        wrap.appendChild(div);
      });
    }

    function renderTimeline(list){
      const wrap = $('#timelineList'); wrap.innerHTML = '';
      list.forEach(t => {
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.innerHTML = `<div class="fw-semibold">${t.role} — ${t.company}</div>
                         <div class="text-muted small">${t.period}</div>
                         <div class="mt-1">${t.desc || ''}</div>`;
        wrap.appendChild(div);
      });
    }

    function renderProjects(list){
      const row = $('#projectGallery'); row.innerHTML = '';
      list.forEach(p => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        col.innerHTML = `
          <div class="card-clean p-2">
            <img src="${p.image || 'https://via.placeholder.com/800x600.png?text=Project'}" alt="${p.title}" tabindex="0">
            <div class="p-2">
              <div class="fw-semibold">${p.title}</div>
              <div class="text-muted small">${p.tags ? p.tags.join(', ') : ''}</div>
              <div class="mt-1">${p.desc || ''}</div>
              ${p.link ? `<a class="btn btn-soft mt-2" target="_blank" href="${p.link}"><i class="fa-solid fa-link me-2"></i>Chi tiết</a>` : ''}
            </div>
          </div>`;
        row.appendChild(col);
      });
    }

    function renderBlog(list){
      const row = $('#blogList'); row.innerHTML = '';
      list.forEach(b => {
        const col = document.createElement('div');
        col.className = 'col-md-6';
        col.innerHTML = `
          <div class="card-clean p-3">
            <div class="fw-semibold">${b.title}</div>
            <div class="text-muted small">${b.date || ''}</div>
            <div class="mt-2">${b.excerpt || ''}</div>
            ${b.url ? `<a class="btn btn-soft mt-2" target="_blank" href="${b.url}"><i class="fa-solid fa-book-open me-2"></i>Đọc</a>` : ''}
          </div>`;
        row.appendChild(col);
      });
    }

    function renderTestimonials(list){
      const slider = $('#testimonialsSlider'); slider.innerHTML = '';
      list.forEach(t => {
        const slide = document.createElement('div');
        slide.className = 'slide card-clean p-3';
        slide.innerHTML = `
          <div class="d-flex align-items-center gap-2 mb-2">
            <img src="${t.avatar || 'https://via.placeholder.com/80x80.png?text=User'}" class="avatar" style="width:48px;height:48px;border-radius:12px;">
            <div>
              <div class="fw-semibold">${t.name}</div>
              <div class="text-muted small">${t.role || ''}</div>
            </div>
          </div>
          <div class="fst-italic">“${t.quote}”</div>`;
        slider.appendChild(slide);
      });
    }

    function renderCategories(list){
      const nav = $('#dynamicCategories'); nav.innerHTML = '';
      list.forEach(c => {
        const a = document.createElement('a');
        a.href = c.href || '#';
        a.className = 'menu-item';
        a.innerHTML = `<i class="${c.icon || 'fa-solid fa-circle'}"></i><span>${c.title}</span>`;
        a.addEventListener('click', () => toggleSidebar(false));
        nav.appendChild(a);
      });
    }

    // ====== QR (simple) ======
    // Minimal QR-like placeholder (for demo). In production, use a QR lib.
    function drawQR(text){
      const canvas = document.getElementById('qrCanvas');
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      // Encode simple hash to pattern
      let hash = 0;
      for(let i=0;i<text.length;i++){ hash = (hash*31 + text.charCodeAt(i)) & 0xffffffff; }
      const size = 10;
      for(let y=0;y<22;y++){
        for(let x=0;x<22;x++){
          const bit = ((hash >> ((x+y)%32)) & 1) ^ ((x*y)%3===0 ? 1:0);
          ctx.fillStyle = bit ? '#111' : '#eee';
          ctx.fillRect(x*size, y*size, size-1, size-1);
        }
      }
    }

    // ====== Data loading (Realtime listeners) ======
    async function initData(){
      setLoading(true);
      // Profile
      refs.profile.onSnapshot(snap => { renderProfile(snap.data() || {}); setLoading(false); });
      // Collections
      refs.skills.orderBy('order','asc').onSnapshot(s => renderSkills(s.docs.map(d=>({id:d.id, ...d.data()}))));
      refs.achievements.orderBy('order','asc').onSnapshot(s => renderAchievements(s.docs.map(d=>d.data())));
      refs.timeline.orderBy('order','asc').onSnapshot(s => renderTimeline(s.docs.map(d=>d.data())));
      refs.projects.orderBy('order','asc').onSnapshot(s => renderProjects(s.docs.map(d=>d.data())));
      refs.blog.orderBy('date','desc').onSnapshot(s => renderBlog(s.docs.map(d=>d.data())));
      refs.testimonials.orderBy('order','asc').onSnapshot(s => renderTestimonials(s.docs.map(d=>d.data())));
      refs.categories.orderBy('order','asc').onSnapshot(s => renderCategories(s.docs.map(d=>d.data())));
    }
    initData();

    // ====== Contact form (write: admin only) ======
    $('#contactForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        name: $('#cName').value.trim(),
        email: $('#cEmail').value.trim(),
        message: $('#cMessage').value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try{
        // User thường không có quyền ghi — sẽ fail nếu không phải admin
        await refs.contact.add(payload);
        showToast('Đã gửi liên hệ');
        e.target.reset();
      }catch(err){
        console.warn('Contact write blocked:', err);
        showToast('Chỉ admin mới có thể ghi dữ liệu');
      }
    });

    // ====== Admin Panel (CRUD) ======
    // SPA style: hiển thị modal CRUD khi là admin
    const adminState = { currentColl: 'skills' };

    $('#adminPanelBtn').addEventListener('click', () => {
      if(!currentUser || currentUser.uid !== ADMIN_UID){
        showToast('Bạn không có quyền truy cập Admin Panel');
        return;
      }
      openAdminPanel();
    });

    function openAdminPanel(){
      const modalHtml = `
      <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content glass">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fa-solid fa-shield-halved me-2"></i>Admin Panel</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-lg-3">
                  <div class="list-group">
                    ${['profile','skills','achievements','timeline','projects','blog','testimonials','categories'].map(c =>
                      `<button class="list-group-item list-group-item-action" data-coll="${c}">${c}</button>`).join('')}
                  </div>
                </div>
                <div class="col-lg-9">
                  <div id="adminContent" class="d-grid gap-3"></div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-soft" data-bs-dismiss="modal">Đóng</button>
            </div>
          </div>
        </div>
      </div>`;
      const wrap = document.createElement('div');
      wrap.innerHTML = modalHtml;
      document.body.appendChild(wrap);
      const modal = new bootstrap.Modal(wrap.querySelector('#adminModal'));
      modal.show();

      // Bind menu
      wrap.querySelectorAll('[data-coll]').forEach(btn=>{
        btn.addEventListener('click', ()=> loadAdminCollection(btn.getAttribute('data-coll'), wrap));
      });
      loadAdminCollection('profile', wrap);
    }

    async function loadAdminCollection(coll, root){
      const content = root.querySelector('#adminContent');
      content.innerHTML = '';
      adminState.currentColl = coll;

      if(coll === 'profile'){
        const snap = await refs.profile.get();
        const p = snap.data() || {};
        content.innerHTML = `
          <div class="card-clean p-3">
            <div class="fw-semibold mb-2">Profile</div>
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label">Avatar URL</label><input class="form-control" id="p_avatar" value="${p.avatar||''}"></div>
              <div class="col-md-6"><label class="form-label">Tên hiển thị</label><input class="form-control" id="p_displayName" value="${p.displayName||''}"></div>
              <div class="col-md-6"><label class="form-label">Biệt danh</label><input class="form-control" id="p_nickname" value="${p.nickname||''}"></div>
              <div class="col-12"><label class="form-label">Giới thiệu ngắn</label><input class="form-control" id="p_shortBio" value="${p.shortBio||''}"></div>
              <div class="col-12"><label class="form-label">Giới thiệu dài</label><textarea class="form-control" id="p_longBio" rows="4">${p.longBio||''}</textarea></div>
              <div class="col-md-6"><label class="form-label">CV PDF URL</label><input class="form-control" id="p_cvUrl" value="${p.cvUrl||''}"></div>
              <div class="col-md-6"><label class="form-label">Chức danh</label><input class="form-control" id="p_title" value="${p.title||''}"></div>
              <div class="col-12"><label class="form-label">Social (JSON)</label><textarea class="form-control" id="p_social" rows="3">${JSON.stringify(p.social||[],null,2)}</textarea></div>
              <div class="col-12 d-flex gap-2">
                <button class="btn btn-soft" id="p_save"><i class="fa-solid fa-floppy-disk me-2"></i>Lưu</button>
              </div>
            </div>
          </div>`;
        content.querySelector('#p_save').addEventListener('click', async ()=>{
          if(!currentUser || currentUser.uid !== ADMIN_UID){ return showToast('Chỉ admin mới ghi dữ liệu'); }
          try{
            const payload = {
              avatar: content.querySelector('#p_avatar').value.trim(),
              displayName: content.querySelector('#p_displayName').value.trim(),
              nickname: content.querySelector('#p_nickname').value.trim(),
              shortBio: content.querySelector('#p_shortBio').value.trim(),
              longBio: content.querySelector('#p_longBio').value.trim(),
              cvUrl: content.querySelector('#p_cvUrl').value.trim(),
              title: content.querySelector('#p_title').value.trim(),
              social: JSON.parse(content.querySelector('#p_social').value || '[]')
            };
            await refs.profile.set(payload, { merge: true });
            showToast('Đã lưu Profile');
          }catch(e){ console.error(e); showToast('Lỗi lưu Profile'); }
        });
        return;
      }

      // Generic list CRUD
      const collRef = refs[coll];
      const snap = await collRef.orderBy('order','asc').get();
      const items = snap.docs.map(d=>({id:d.id, ...d.data()}));

      const listHtml = `
        <div class="card-clean p-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold text-capitalize">${coll}</div>
            <button class="btn btn-soft" id="addItem"><i class="fa-solid fa-plus me-2"></i>Thêm</button>
          </div>
          <div class="d-grid gap-2" id="itemsWrap"></div>
        </div>`;
      content.innerHTML = listHtml;
      const wrap = content.querySelector('#itemsWrap');

      function renderItem(it){
        const row = document.createElement('div');
        row.className = 'card-clean p-2';
        row.innerHTML = `
          <div class="row g-2 align-items-center">
            <div class="col-md-1"><input class="form-control form-control-sm" value="${it.order||0}" data-k="order"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" value="${it.title||it.name||''}" data-k="title"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" value="${it.desc||it.excerpt||''}" data-k="desc"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" value="${it.image||it.url||''}" data-k="image"></div>
            <div class="col-md-2 d-flex gap-2">
              <button class="btn btn-soft btn-sm" data-act="save"><i class="fa-solid fa-floppy-disk"></i></button>
              <button class="btn btn-soft btn-sm" data-act="del"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>`;
        // Bind
        row.querySelector('[data-act="save"]').addEventListener('click', async ()=>{
          if(!currentUser || currentUser.uid !== ADMIN_UID){ return showToast('Chỉ admin mới ghi dữ liệu'); }
          const payload = {
            order: parseInt(row.querySelector('[data-k="order"]').value || 0, 10),
            title: row.querySelector('[data-k="title"]').value,
            desc: row.querySelector('[data-k="desc"]').value,
          };
          const img = row.querySelector('[data-k="image"]').value;
          if(coll==='skills'){ payload.name = payload.title; payload.level = parseInt(payload.desc||0,10); delete payload.desc; }
          if(coll==='blog'){ payload.excerpt = payload.desc; payload.url = img; delete payload.desc; }
          if(coll==='projects'){ payload.image = img; }
          if(coll==='testimonials'){ payload.avatar = img; }
          if(coll==='categories'){ payload.href = img; payload.icon = 'fa-solid fa-circle'; }
          try{
            await collRef.doc(it.id).set(payload, { merge: true });
            showToast('Đã lưu mục');
          }catch(e){ console.error(e); showToast('Lỗi lưu'); }
        });
        row.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
          if(!currentUser || currentUser.uid !== ADMIN_UID){ return showToast('Chỉ admin mới ghi dữ liệu'); }
          try{ await collRef.doc(it.id).delete(); showToast('Đã xóa'); row.remove(); }catch(e){ console.error(e); showToast('Lỗi xóa'); }
        });
        wrap.appendChild(row);
      }

      items.forEach(renderItem);

      content.querySelector('#addItem').addEventListener('click', async ()=>{
        if(!currentUser || currentUser.uid !== ADMIN_UID){ return showToast('Chỉ admin mới ghi dữ liệu'); }
        const payload = { order: items.length + 1, title: 'New Item' };
        try{
          const doc = await collRef.add(payload);
          renderItem({ id: doc.id, ...payload });
          showToast('Đã thêm mục');
        }catch(e){ console.error(e); showToast('Lỗi thêm'); }
      });
    }

    // ====== Storage upload (Admin only) ======
    // Simple upload modal to get URL
    function openUploadModal(cb){
      const html = `
      <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content glass">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fa-solid fa-upload me-2"></i>Upload ảnh</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="file" class="form-control" id="fileInput" accept="image/*">
              <div class="small text-muted mt-2">Sau khi upload sẽ trả về URL public.</div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-soft" id="doUpload"><i class="fa-solid fa-cloud-arrow-up me-2"></i>Upload</button>
            </div>
          </div>
        </div>
      </div>`;
      const wrap = document.createElement('div'); wrap.innerHTML = html; document.body.appendChild(wrap);
      const modal = new bootstrap.Modal(wrap.querySelector('#uploadModal')); modal.show();
      wrap.querySelector('#doUpload').addEventListener('click', async ()=>{
        if(!currentUser || currentUser.uid !== ADMIN_UID){ return showToast('Chỉ admin mới ghi dữ liệu'); }
        const file = wrap.querySelector('#fileInput').files[0];
        if(!file) return showToast('Chọn file trước');
        try{
          const ref = storage.ref().child('uploads/'+Date.now()+'_'+file.name);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          showToast('Upload thành công');
          modal.hide();
          cb && cb(url);
        }catch(e){ console.error(e); showToast('Upload thất bại'); }
      });
    }

    // Shortcut: Alt+U mở upload modal (admin)
    document.addEventListener('keydown', (e)=>{
      if(e.altKey && e.key.toLowerCase()==='u'){
        if(!currentUser || currentUser.uid !== ADMIN_UID){ return showToast('Chỉ admin mới ghi dữ liệu'); }
        openUploadModal(url => {
          navigator.clipboard.writeText(url);
          showToast('Đã copy URL ảnh vào clipboard');
        });
      }
    });

    // ====== Smooth performance tips ======
    // Avoid heavy reflows, keep animations CSS-based, limit DOM writes.

  </script>
</body>
</html>
