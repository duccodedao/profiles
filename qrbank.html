
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BmassHD - Tạo Mã QR Chuyển Khoản</title>
    
    <!-- Thư viện CSS & Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://duccodedao.github.io/Images/avt.png">
    
    <style>
        /* --- CẤU HÌNH GIAO DIỆN CHUNG --- */
        :root { --primary-color: #4e73df; --secondary-color: #858796; --success-color: #1cc88a; --danger-color: #e74a3b; --warning-color: #f6c23e; --bg-color: #f3f4f6; --card-bg: #ffffff; --text-color: #2d3748; --border-radius: 12px; --shadow: 0 10px 25px rgba(0,0,0,0.05); --transition: all 0.3s ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); padding: 20px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        
        .container { width: 100%; max-width: 1200px; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-wrap: wrap; margin-bottom: 30px; }
        
        /* HEADER */
        .header { width: 100%; padding: 20px; background: linear-gradient(135deg, var(--primary-color), #224abe); color: white; text-align: center; position: relative; }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        
        /* LAYOUT 2 CỘT */
        .col-left, .col-right { padding: 30px; }
        .col-left { flex: 1; min-width: 350px; border-right: 1px solid #eee; }
        .col-right { flex: 1; min-width: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #f8f9fc; }
        
        /* GRID DANH SÁCH NGÂN HÀNG */
        .bank-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .bank-item { 
            border: 2px solid transparent; 
            border-radius: 10px; 
            padding: 10px; 
            cursor: pointer; 
            transition: var(--transition); 
            background: #fff; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            text-align: center; 
            position: relative; 
            height: 80px; /* Tăng chiều cao một chút để chứa logo */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: visible;
        }
        .bank-item img { max-width: 100%; max-height: 100%; object-fit: contain; filter: grayscale(100%); transition: var(--transition); }
        .bank-item:hover { transform: translateY(-3px); }
        
        .bank-item.active { border-color: var(--primary-color); background: #f0f4ff; }
        .bank-item.active img { filter: grayscale(0%); }
        
        /* --- STYLE TRẠNG THÁI NGÂN HÀNG --- */
        .bank-status {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 5;
        }
        .status-on { background-color: var(--success-color); }
        .status-off { background-color: var(--danger-color); }

        /* Style cho ngân hàng bị vô hiệu hóa/bảo trì */
        .bank-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #eee;
            border-color: #ddd;
        }
        .bank-item.disabled:hover { transform: none; }
        /* ---------------------------------- */

        .bank-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 5px 10px; font-size: 0.75rem; border-radius: 4px; white-space: nowrap; opacity: 0; visibility: hidden; transition: var(--transition); z-index: 10; }
        .bank-item:hover .bank-tooltip { opacity: 1; visibility: visible; bottom: 115%; }
        
        /* FORM INPUTS */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #555; }
        .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; transition: var(--transition); outline: none; }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1); }
        .input-group { display: flex; gap: 10px; }
        
        /* NÚT BẤM & TAGS */
        .btn-copy { background: var(--secondary-color); color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; transition: var(--transition); }
        .suggestions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .tag { background: #eef2ff; color: var(--primary-color); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; transition: var(--transition); }
        .tag:hover { border-color: var(--primary-color); background: #fff; }
        
        /* MẪU QR OPTIONS */
        .template-options { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .template-opt { flex: 1; border: 2px solid #ddd; border-radius: 10px; overflow: hidden; cursor: pointer; opacity: 0.6; transition: var(--transition); }
        .template-opt img { width: 100%; display: block; }
        .template-opt.active { border-color: var(--primary-color); opacity: 1; transform: scale(1.05); }
        
        /* --- KHUNG QR & HIỆU ỨNG LOADING SKELETON --- */
        .qr-frame { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            text-align: center; 
            min-height: 380px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            overflow: hidden;
            border: 1px solid #eee;
            width: 100%;
        }

        .qr-frame img { 
            max-width: 100%; 
            height: auto; 
            border-radius: 10px; 
            opacity: 0; 
            transform: scale(0.95);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .qr-frame img.loaded { opacity: 1; transform: scale(1); }

        .loading-skeleton {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f6f7f8;
            background-image: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
            background-repeat: no-repeat;
            background-size: 1000px 100%; 
            animation: shimmer 1.5s infinite linear forwards;
            z-index: 5;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }

        .loading-logo { font-size: 3rem; color: var(--primary-color); animation: pulse 1s infinite alternate; opacity: 0.5; }
        @keyframes pulse { from { transform: scale(1); opacity: 0.5; } to { transform: scale(1.1); opacity: 0.8; } }

        .placeholder-content { color: #aaa; display: flex; flex-direction: column; align-items: center; }
        .placeholder-content i { font-size: 4rem; margin-bottom: 15px; color: #ddd; }

        .btn-action { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: var(--transition); width: 100%; margin-bottom: 10px; }
        .btn-action:hover { background: #2e59d9; transform: translateY(-2px); }
        
        /* --- ADMIN PANEL STYLES --- */
        .admin-login-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        #adminPanel { width: 100%; max-width: 1200px; background: #fff; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid var(--primary-color); display: none; }
        #adminPanel h2 { color: var(--primary-color); margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .admin-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .admin-form-grid select { grid-column: span 2; }
        
        .btn-group-admin { display: flex; gap: 10px; }
        
        /* Nút trong bảng Admin */
        .btn-delete { background-color: var(--danger-color); color: white; padding: 6px 10px; border-radius: 5px; border: none; cursor: pointer; transition: 0.2s; }
        .btn-delete:hover { background-color: #c0392b; }
        
        .btn-edit { background-color: var(--warning-color); color: white; padding: 6px 10px; border-radius: 5px; border: none; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .btn-edit:hover { background-color: #d4a726; }

        .btn-cancel { background-color: var(--secondary-color); color: white; border: none; }
        .btn-cancel:hover { background-color: #6c757d; }

        #bankListAdmin table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        #bankListAdmin th, #bankListAdmin td { padding: 10px; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
        
        /* INITIAL LOADING OVERLAY */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .col-left { border-right: none; border-bottom: 1px solid #eee; }
            .admin-form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- Màn hình chờ ban đầu -->
<div id="initialLoading" class="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 15px; color: #555;">Đang tải dữ liệu...</p>
</div>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-qrcode"></i> BmassHD QR Generator</h1>
        <p>Tạo mã QR chuyển khoản nhanh chóng & chính xác</p>
        <!-- Nút Login Admin -->
        <button id="btnLogin" class="admin-login-btn" onclick="handleLogin()"><i class="fas fa-user-shield"></i> Admin</button>
        <button id="btnLogout" class="admin-login-btn" onclick="handleLogout()" style="display: none;"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <!-- CỘT TRÁI: NHẬP LIỆU -->
    <div class="col-left">
        <div class="form-group">
            <label class="form-label">1. Chọn Ngân Hàng</label>
            <div class="bank-grid" id="bankGrid">
                <!-- Data Render từ Firebase -->
            </div>
            <div style="font-size: 0.9rem; margin-top: 5px;">
                Đang chọn: <strong id="selectedBankName" style="color: var(--primary-color);">...</strong>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">2. Thông tin nhận tiền</label>
            <div class="input-group">
                <input type="text" id="accountNumber" class="form-control" readonly style="background: #f8f9fc; font-weight: bold;" placeholder="Số tài khoản">
                <button class="btn-copy" onclick="copyToClipboard('accountNumber')"><i class="fas fa-copy"></i></button>
            </div>
            <input type="text" id="fullName" class="form-control" readonly style="margin-top: 10px; background: #f8f9fc; color: #555;" placeholder="Tên chủ tài khoản">
        </div>

        <div class="form-group">
            <label class="form-label">3. Số tiền & Nội dung <span style="color: red;">*</span></label>
            <input type="text" id="amount" class="form-control" placeholder="Nhập số tiền (VD: 50,000)" oninput="formatCurrency(this)">
            <div class="suggestions">
                <span class="tag" onclick="setAmount(10000)">10,000</span>
                <span class="tag" onclick="setAmount(50000)">50,000</span>
                <span class="tag" onclick="setAmount(100000)">100,000</span>
                <span class="tag" onclick="setAmount(500000)">500,000</span>
            </div>
            <textarea id="transferContent" class="form-control" style="margin-top: 15px;" rows="2" placeholder="Nội dung chuyển khoản">Chuyen khoan</textarea>
        </div>

        <div class="form-group">
            <label class="form-label">4. Giao diện QR</label>
            <div class="template-options">
                <div class="template-opt active" onclick="selectTemplate('compact2', this)"><img src="https://img.vietqr.io/image/VCB-0891000650891-compact2.jpg"></div>
                <div class="template-opt" onclick="selectTemplate('compact', this)"><img src="https://img.vietqr.io/image/VCB-0891000650891-compact.jpg"></div>
            </div>
        </div>

        <button class="btn-action" onclick="generateQR()"><i class="fas fa-magic"></i> TẠO MÃ QR</button>
    </div>

    <!-- CỘT PHẢI: KẾT QUẢ -->
    <div class="col-right">
        <label class="form-label">MÃ QR CỦA BẠN</label>
        
        <div class="qr-frame" id="qrContainer">
            <!-- Skeleton Loading -->
            <div id="qrLoader" class="loading-skeleton" style="display: none;">
                <i class="fas fa-qrcode loading-logo"></i>
                <p style="margin-top: 15px; color: #666; font-weight: 500;">Đang tạo mã QR...</p>
            </div>

            <!-- Ảnh QR thật -->
            <img id="qrImage" src="" alt="QR Code" style="display: none;">

            <!-- Placeholder -->
            <div id="placeholderText" class="placeholder-content">
                <i class="fas fa-qrcode"></i>
                <span>Nhập số tiền để tạo mã</span>
            </div>
        </div>
        
        <div id="resultActions" style="width: 100%; display: none;">
            <button class="btn-action" onclick="downloadQR()"><i class="fas fa-download"></i> Tải ảnh về</button>
        </div>
    </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
    <h2><i class="fas fa-cogs"></i> Quản Trị Viên</h2>
    <p style="margin-bottom: 15px;">Thêm hoặc sửa thông tin ngân hàng. Dữ liệu lấy từ VietQR API.</p>
    
    <div class="admin-form-group">
        <div class="admin-form-grid">
            <select id="admBankSelect" class="form-control">
                <option value="">-- Đang tải danh sách ngân hàng... --</option>
            </select>
            
            <input type="text" id="admAccNum" class="form-control" placeholder="Nhập Số tài khoản">
            <input type="text" id="admFullName" class="form-control" placeholder="Nhập Tên Chủ tài khoản (Viết hoa không dấu)">
            
            <select id="admStatus" class="form-control">
                <option value="active">Hiển thị (Active)</option>
                <option value="maintenance">Ẩn / Bảo trì</option>
            </select>
        </div>
        
        <div class="btn-group-admin">
            <button class="btn-action" id="btnSaveBank" onclick="saveBankToFirebase()">
                <i class="fas fa-plus-circle"></i> Thêm Mới
            </button>
            <button class="btn-action btn-cancel" id="btnCancelEdit" onclick="cancelEditBank()" style="display: none;">
                <i class="fas fa-times"></i> Hủy Sửa
            </button>
        </div>
    </div>

    <div id="bankListAdmin">
        <h3>Danh sách đang hiển thị</h3>
        <table>
            <thead><tr><th>Logo</th><th>Ngân hàng</th><th>Số TK</th><th>Chủ TK</th><th>Thao tác</th></tr></thead>
            <tbody id="adminTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Thư viện JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
    // 1. CẤU HÌNH FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
        authDomain: "profile-d1214.firebaseapp.com",
        projectId: "profile-d1214",
        storageBucket: "profile-d1214.firebasestorage.app",
        messagingSenderId: "914980131889",
        appId: "1:914980131889:web:72f8da15c42dbee671b110",
        measurementId: "G-C587M69LZW"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const ADMIN_UID = "VYIs9XHLR9RMStwtcdwMrOIo33w1";

    let USER_BANKS = [];
    let API_BANKS_LIST = [];
    let currentBank = null;
    let currentTemplate = 'compact2';
    
    // Biến theo dõi trạng thái Edit
    let editingBankId = null;

    // 2. KHỞI TẠO APP
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchVietQRBanks(); 
        listenFirebaseBanks();    
    });

    // --- LOGIC API VIETQR ---
    async function fetchVietQRBanks() {
        try {
            const response = await fetch('https://api.vietqr.io/v2/banks');
            const data = await response.json();
            if(data.code === "00") {
                API_BANKS_LIST = data.data;
                populateAdminDropdown();
            }
        } catch (error) {
            console.error("Lỗi VietQR API:", error);
        }
    }

    function populateAdminDropdown() {
        const select = document.getElementById('admBankSelect');
        select.innerHTML = '<option value="">-- Chọn Ngân hàng --</option>';
        API_BANKS_LIST.sort((a, b) => a.shortName.localeCompare(b.shortName));
        
        API_BANKS_LIST.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.id;
            option.text = `${bank.shortName} - ${bank.name}`;
            select.appendChild(option);
        });
    }

    // --- LOGIC AUTH & ADMIN ---
    auth.onAuthStateChanged((user) => {
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const adminPanel = document.getElementById('adminPanel');

        if (user && user.uid === ADMIN_UID) {
            btnLogin.style.display = 'none';
            btnLogout.style.display = 'inline-block';
            adminPanel.style.display = 'block';
            loadBanksForAdminTable();
        } else {
            btnLogin.style.display = 'inline-block';
            btnLogout.style.display = 'none';
            adminPanel.style.display = 'none';
            if(user) auth.signOut();
        }
    });

    function handleLogin() {
        auth.signInWithPopup(provider).catch(e => Swal.fire("Lỗi", e.message, "error"));
    }

    function handleLogout() {
        auth.signOut();
    }

    // --- LOGIC LƯU VÀ SỬA NGÂN HÀNG ---
    
    function saveBankToFirebase() {
        const bankId = document.getElementById('admBankSelect').value;
        const accNum = document.getElementById('admAccNum').value;
        const fullName = document.getElementById('admFullName').value;
        const status = document.getElementById('admStatus').value;

        if (!bankId || !accNum || !fullName) {
            Swal.fire("Thiếu thông tin", "Vui lòng chọn Ngân hàng và điền đủ thông tin", "warning");
            return;
        }

        const selectedBankObj = API_BANKS_LIST.find(b => b.id == bankId);
        if(!selectedBankObj) return;

        const bankData = {
            code: selectedBankObj.code,
            bin: selectedBankObj.bin,
            shortName: selectedBankObj.shortName,
            name: selectedBankObj.name,
            logo: selectedBankObj.logo,
            acc: accNum,
            fullName: fullName.toUpperCase(),
            status: status,
            ...(editingBankId ? {} : { createdAt: firebase.firestore.FieldValue.serverTimestamp() })
        };

        if (editingBankId) {
            db.collection("banks").doc(editingBankId).update(bankData)
            .then(() => {
                Swal.fire("Thành công", "Đã cập nhật thông tin!", "success");
                cancelEditBank();
            })
            .catch(e => Swal.fire("Lỗi Update", e.message, "error"));
        } else {
            db.collection("banks").add(bankData)
            .then(() => {
                Swal.fire("Thành công", "Đã thêm tài khoản mới!", "success");
                cancelEditBank();
            })
            .catch(e => Swal.fire("Lỗi Add", e.message, "error"));
        }
    }

    function startEditBank(id) {
        const bank = USER_BANKS.find(b => b.id === id);
        if(!bank) return;

        editingBankId = id;

        const apiBank = API_BANKS_LIST.find(b => b.bin === bank.bin || b.code === bank.code);
        if (apiBank) {
            document.getElementById('admBankSelect').value = apiBank.id;
        }

        document.getElementById('admAccNum').value = bank.acc;
        document.getElementById('admFullName').value = bank.fullName;
        document.getElementById('admStatus').value = bank.status;

        const btnSave = document.getElementById('btnSaveBank');
        btnSave.innerHTML = '<i class="fas fa-save"></i> Cập Nhật';
        btnSave.style.background = '#f6c23e';
        
        document.getElementById('btnCancelEdit').style.display = 'inline-flex';
        document.getElementById('adminPanel').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEditBank() {
        editingBankId = null;
        document.getElementById('admBankSelect').value = "";
        document.getElementById('admAccNum').value = "";
        document.getElementById('admFullName').value = "";
        document.getElementById('admStatus').value = "active";

        const btnSave = document.getElementById('btnSaveBank');
        btnSave.innerHTML = '<i class="fas fa-plus-circle"></i> Thêm Mới';
        btnSave.style.background = 'var(--primary-color)';

        document.getElementById('btnCancelEdit').style.display = 'none';
    }

    // --- LOGIC HIỂN THỊ NGƯỜI DÙNG (MODIFIED) ---
    function listenFirebaseBanks() {
        db.collection("banks").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
            USER_BANKS = [];
            snapshot.forEach((doc) => {
                USER_BANKS.push({ id: doc.id, ...doc.data() });
            });
            
            document.getElementById('initialLoading').style.display = 'none';
            renderBankGrid();
            loadBanksForAdminTable();
            
            // Tự động chọn ngân hàng đầu tiên nếu chưa chọn và ngân hàng đó Active
            if (!currentBank && USER_BANKS.length > 0) {
                const firstActive = USER_BANKS.find(b => b.status === 'active');
                if(firstActive) {
                    const idx = USER_BANKS.findIndex(b => b.id === firstActive.id);
                    selectBank(idx);
                }
            }
        });
    }

    function renderBankGrid() {
        const grid = document.getElementById('bankGrid');
        grid.innerHTML = '';
        
        if(USER_BANKS.length === 0) {
            grid.innerHTML = '<p style="text-align:center; width:100%; color:#888;">Chưa có tài khoản nào.</p>';
            return;
        }

        // Sắp xếp: Active lên đầu, Maintenance xuống dưới
        const sortedBanks = [...USER_BANKS].sort((a, b) => {
            if (a.status === 'active' && b.status !== 'active') return -1;
            if (a.status !== 'active' && b.status === 'active') return 1;
            return 0;
        });

        sortedBanks.forEach((bank) => {
            const originalIndex = USER_BANKS.findIndex(b => b.id === bank.id);
            const div = document.createElement('div');
            
            const isActive = currentBank && currentBank.id === bank.id;
            const isMaintenance = bank.status === 'maintenance';
            
            // Xử lý class hiển thị
            let className = 'bank-item';
            if (isActive) className += ' active';
            if (isMaintenance) className += ' disabled';
            
            div.className = className;
            
            // Nếu bảo trì thì không cho click
            if (!isMaintenance) {
                div.onclick = () => selectBank(originalIndex);
            }

            // Tạo nhãn trạng thái
            const statusLabel = isMaintenance ? 'Bảo trì' : 'Hoạt động';
            const statusClass = isMaintenance ? 'status-off' : 'status-on';

            div.innerHTML = `
                <div class="bank-status ${statusClass}">${statusLabel}</div>
                <img src="${bank.logo}" alt="${bank.code}">
                <div class="bank-tooltip">${bank.shortName}</div>
            `;
            grid.appendChild(div);
        });
    }

    function selectBank(index) {
        if (!USER_BANKS[index]) return;
        
        // Chặn thêm 1 lần nữa ở logic
        if (USER_BANKS[index].status === 'maintenance') return;

        currentBank = USER_BANKS[index];
        renderBankGrid();
        
        document.getElementById('selectedBankName').innerText = currentBank.shortName + " - " + currentBank.name;
        document.getElementById('accountNumber').value = currentBank.acc;
        document.getElementById('fullName').value = currentBank.fullName;

        if(document.getElementById('amount').value) generateQR();
    }

    function generateQR() {
        if (!currentBank) return;
        
        const rawAmount = document.getElementById('amount').value.replace(/,/g, '');
        const amount = parseInt(rawAmount);
        const content = document.getElementById('transferContent').value;
        
        const qrImg = document.getElementById('qrImage');
        const loader = document.getElementById('qrLoader');
        const placeholder = document.getElementById('placeholderText');
        const actions = document.getElementById('resultActions');

        if (!amount || amount < 1000) {
            Swal.fire({ toast: true, position: 'top', icon: 'warning', title: 'Số tiền tối thiểu 1,000đ', timer: 2000, showConfirmButton: false });
            return;
        }

        qrImg.style.display = 'none';
        qrImg.classList.remove('loaded'); 
        actions.style.display = 'none';
        placeholder.style.display = 'none';
        loader.style.display = 'flex'; 

        const apiLink = `https://img.vietqr.io/image/${currentBank.code}-${currentBank.acc}-${currentTemplate}.jpg?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(currentBank.fullName)}`;

        const downloadingImage = new Image();
        downloadingImage.onload = function(){
            qrImg.src = this.src;
            qrImg.style.display = 'block';
            
            setTimeout(() => {
                loader.style.display = 'none';
                setTimeout(() => qrImg.classList.add('loaded'), 50);
                actions.style.display = 'flex';
            }, 300);
        };

        downloadingImage.onerror = function(){
            loader.style.display = 'none';
            placeholder.style.display = 'flex';
            placeholder.innerHTML = '<span style="color:red">Lỗi tải QR. Vui lòng thử lại!</span>';
        };

        downloadingImage.src = apiLink;
    }

    // --- TIỆN ÍCH KHÁC ---
    function loadBanksForAdminTable() {
        const tbody = document.getElementById('adminTableBody');
        tbody.innerHTML = '';
        USER_BANKS.forEach(bank => {
            const statusLabel = bank.status === 'active' 
                ? '<span style="color:green;font-weight:bold">Hoạt động</span>' 
                : '<span style="color:red;font-weight:bold">Bảo trì</span>';

            tbody.innerHTML += `
                <tr>
                    <td><img src="${bank.logo}" height="30"></td>
                    <td>${bank.shortName}<br><small>${statusLabel}</small></td>
                    <td>${bank.acc}</td>
                    <td>${bank.fullName}</td>
                    <td>
                        <button class="btn-edit" onclick="startEditBank('${bank.id}')" title="Sửa"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" onclick="deleteBank('${bank.id}')" title="Xóa"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    function deleteBank(id) {
        if(confirm("Bạn chắc chắn muốn xóa tài khoản này?")) {
            db.collection("banks").doc(id).delete();
        }
    }

    function formatCurrency(input) {
        let val = input.value.replace(/\D/g, '');
        input.value = val ? parseInt(val).toLocaleString('en-US') : '';
    }

    function setAmount(val) {
        document.getElementById('amount').value = val.toLocaleString('en-US');
        generateQR();
    }

    function copyToClipboard(id) {
        navigator.clipboard.writeText(document.getElementById(id).value);
        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Đã sao chép', timer: 1000, showConfirmButton: false });
    }

    function downloadQR() {
        const src = document.getElementById('qrImage').src;
        if(src) window.open(src, '_blank');
    }

    function selectTemplate(tpl, el) {
        currentTemplate = tpl;
        document.querySelectorAll('.template-opt').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        if(document.getElementById('amount').value) generateQR();
    }
</script>
</body>
</html>
