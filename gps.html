<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia S·∫ª To·∫° ƒê·ªô</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }
        h2 { margin-bottom: 20px; color: #333; }
        
        #shareBtn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            font-weight: bold;
        }
        #shareBtn:active { transform: scale(0.98); }
        #shareBtn:disabled { background-color: #ccc; cursor: not-allowed; }

        #status { margin-top: 15px; color: #666; font-size: 14px; min-height: 20px;}
        
        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
        }
        .coords-text {
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            word-break: break-all;
        }
        .copy-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>üìç V·ªã Tr√≠ C·ªßa T√¥i</h2>
        
        <button id="shareBtn">CHIA S·∫∫ TO·∫† ƒê·ªò NGAY</button>
        <div id="status"></div>

        <div id="result" class="result-box">
            <div id="coordsDisplay" class="coords-text">...</div>
            <button class="copy-btn" onclick="copyToClipboard()">üìã Sao ch√©p ƒë·ªÉ d√°n Map</button>
            <br><br>
            <a id="googleMapLink" href="#" target="_blank" style="color:#007bff; text-decoration:none; font-size:14px;">M·ªü tr·ª±c ti·∫øp Google Maps ‚Üó</a>
        </div>
    </div>

    <!-- Firebase SDKs (Compat version for simple usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // 1. C·∫•u h√¨nh Firebase c·ªßa b·∫°n
        const firebaseConfig = {
            apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
            authDomain: "profile-d1214.firebaseapp.com",
            projectId: "profile-d1214",
            storageBucket: "profile-d1214.firebasestorage.app",
            messagingSenderId: "914980131889",
            appId: "1:914980131889:web:72f8da15c42dbee671b110",
            measurementId: "G-C587M69LZW"
        };

        // 2. Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const shareBtn = document.getElementById('shareBtn');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const coordsDisplay = document.getElementById('coordsDisplay');
        const googleMapLink = document.getElementById('googleMapLink');
        let currentCoords = "";

        // 3. X·ª≠ l√Ω s·ª± ki·ªán click n√∫t
        shareBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                statusDiv.innerText = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.";
                return;
            }

            statusDiv.innerText = "ƒêang l·∫•y v·ªã tr√≠ ch√≠nh x√°c nh·∫•t...";
            shareBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(successPosition, errorPosition, {
                enableHighAccuracy: true, // Y√™u c·∫ßu ƒë·ªô ch√≠nh x√°c cao nh·∫•t (GPS)
                timeout: 10000,
                maximumAge: 0
            });
        });

        // 4. Khi l·∫•y to·∫° ƒë·ªô th√†nh c√¥ng
        function successPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy; // ƒê·ªô l·ªách (m√©t)

            // ƒê·ªãnh d·∫°ng chu·ªói ƒë·ªÉ d√°n v√†o Google Maps: "Lat, Long"
            currentCoords = `${lat}, ${lng}`;

            statusDiv.innerText = `ƒê√£ t√¨m th·∫•y! (ƒê·ªô l·ªách: ${Math.round(accuracy)}m). ƒêang l∆∞u...`;

            // L∆∞u v√†o Firebase Firestore
            db.collection("locations").add({
                latitude: lat,
                longitude: lng,
                accuracy: accuracy,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userAgent: navigator.userAgent // L∆∞u th√™m info thi·∫øt b·ªã ƒë·ªÉ bi·∫øt ai g·ª≠i
            })
            .then((docRef) => {
                statusDiv.innerText = "‚úÖ ƒê√£ l∆∞u v√†o h·ªá th·ªëng th√†nh c√¥ng!";
                showResult(lat, lng);
            })
            .catch((error) => {
                console.error("L·ªói l∆∞u firebase: ", error);
                statusDiv.innerText = "‚ö†Ô∏è C√≥ l·ªói khi l∆∞u d·ªØ li·ªáu (Ki·ªÉm tra Rules).";
                // V·∫´n hi·ªán k·∫øt qu·∫£ cho ng∆∞·ªùi d√πng d√π l·ªói database
                showResult(lat, lng); 
            })
            .finally(() => {
                shareBtn.disabled = false;
            });
        }

        // 5. Hi·ªÉn th·ªã k·∫øt qu·∫£
        function showResult(lat, lng) {
            resultDiv.style.display = "block";
            coordsDisplay.innerText = `${lat}, ${lng}`;
            // T·∫°o link m·ªü nhanh
            googleMapLink.href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        }

        // 6. X·ª≠ l√Ω l·ªói khi kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠
        function errorPosition(err) {
            shareBtn.disabled = false;
            console.warn(`ERROR(${err.code}): ${err.message}`);
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    statusDiv.innerText = "‚ùå B·∫°n ƒë√£ t·ª´ ch·ªëi c·∫•p quy·ªÅn v·ªã tr√≠.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    statusDiv.innerText = "‚ùå Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ hi·ªán t·∫°i.";
                    break;
                case err.TIMEOUT:
                    statusDiv.innerText = "‚ùå H·∫øt th·ªùi gian ch·ªù l·∫•y v·ªã tr√≠.";
                    break;
                default:
                    statusDiv.innerText = "‚ùå L·ªói kh√¥ng x√°c ƒë·ªãnh.";
            }
        }

        // 7. Ch·ª©c nƒÉng copy
        function copyToClipboard() {
            navigator.clipboard.writeText(currentCoords).then(() => {
                alert("ƒê√£ copy to·∫° ƒë·ªô: " + currentCoords);
            }, (err) => {
                console.error('L·ªói copy: ', err);
            });
        }
    </script>
</body>
</html>
